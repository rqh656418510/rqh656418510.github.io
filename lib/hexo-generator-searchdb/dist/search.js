"use strict";var _slicedToArray=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var r=[],n=!0,a=!1,o=void 0;try{for(var i,l=t[Symbol.iterator]();!(n=(i=l.next()).done)&&(r.push(i.value),!e||r.length!==e);n=!0);}catch(t){a=!0,o=t}finally{try{!n&&l.return&&l.return()}finally{if(a)throw o}}return r}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_createClass=function(){function n(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),t}}();function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,r=Array(t.length);e<t.length;e++)r[e]=t[e];return r}return Array.from(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var LocalSearch=function(){function n(t){var e=t.path,r=void 0===e?"":e,e=t.unescape,e=void 0!==e&&e,t=t.top_n_per_article,t=void 0===t?1:t;_classCallCheck(this,n),this.path=r,this.unescape=e,this.top_n_per_article=t,this.isfetched=!1,this.datas=null}return _createClass(n,[{key:"getIndexByWord",value:function(t,o){var i=this,l=2<arguments.length&&void 0!==arguments[2]&&arguments[2],s=[],h=new Set;return l||(o=o.toLowerCase()),t.forEach(function(t){var e;i.unescape&&((e=document.createElement("div")).innerText=t,t=e.innerHTML);var r=t.length;if(0!==r){var n,a=0;for(l||(t=t.toLowerCase());-1<(n=o.indexOf(t,a));)s.push({position:n,word:t}),h.add(t),a=n+r}}),s.sort(function(t,e){return t.position!==e.position?t.position-e.position:e.word.length-t.word.length}),[s,h]}},{key:"mergeIntoSlice",value:function(t,e,r){for(var n=r[0],a=n.position,o=n.word,i=[],l=new Set;a+o.length<=e&&0!==r.length;){l.add(o),i.push({position:a,length:o.length});var s=a+o.length;for(r.shift();0!==r.length&&(a=(n=r[0]).position,o=n.word,a<s);)r.shift()}return{hits:i,start:t,end:e,count:l.size}}},{key:"highlightKeyword",value:function(t,e){var r="",n=e.start,a=!0,o=!1,i=void 0;try{for(var l,s=e.hits[Symbol.iterator]();!(a=(l=s.next()).done);a=!0){var h=l.value,c=h.position,u=h.length;r+=t.substring(n,c),n=c+u,r+='<mark class="search-keyword">'+t.substr(c,u)+"</mark>"}}catch(t){o=!0,i=t}finally{try{!a&&s.return&&s.return()}finally{if(o)throw i}}return r+=t.substring(n,e.end)}},{key:"getResultItems",value:function(d){var f=this,g=[];return this.datas.forEach(function(t){var e=t.title,r=t.content,n=t.url,a=f.getIndexByWord(d,e),o=_slicedToArray(a,2),i=o[0],t=o[1],a=f.getIndexByWord(d,r),o=_slicedToArray(a,2),l=o[0],a=o[1],o=new Set([].concat(_toConsumableArray(t),_toConsumableArray(a))).size,t=i.length+l.length;if(0!==t){a=[];0!==i.length&&a.push(f.mergeIntoSlice(0,e.length,i));for(var s=[];0!==l.length;){var h=l[0].position,c=Math.max(0,h-20),h=Math.min(r.length,h+80);s.push(f.mergeIntoSlice(c,h,l))}s.sort(function(t,e){return t.count!==e.count?e.count-t.count:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});i=parseInt(f.top_n_per_article,10);0<=i&&(s=s.slice(0,i));var u="";(n=new URL(n,location.origin)).searchParams.append("highlight",d.join(" ")),0!==a.length?u+='<li><a href="'+n.href+'" class="search-result-title">'+f.highlightKeyword(e,a[0])+"</a>":u+='<li><a href="'+n.href+'" class="search-result-title">'+e+"</a>",s.forEach(function(t){u+='<a href="'+n.href+'"><p class="search-result">'+f.highlightKeyword(r,t)+"...</p></a>"}),u+="</li>",g.push({item:u,id:g.length,hitCount:t,includedCount:o})}}),g}},{key:"fetchData",value:function(){var e=this,r=!this.path.endsWith("json");fetch(this.path).then(function(t){return t.text()}).then(function(t){e.isfetched=!0,e.datas=r?[].concat(_toConsumableArray((new DOMParser).parseFromString(t,"text/xml").querySelectorAll("entry"))).map(function(t){return{title:t.querySelector("title").textContent,content:t.querySelector("content").textContent,url:t.querySelector("url").textContent}}):JSON.parse(t),e.datas=e.datas.filter(function(t){return t.title}).map(function(t){return t.title=t.title.trim(),t.content=t.content?t.content.trim().replace(/<[^>]+>/g,""):"",t.url=decodeURIComponent(t.url).replace(/\/{2,}/g,"/"),t}),window.dispatchEvent(new Event("search:loaded"))})}},{key:"highlightText",value:function(e,t,r){var n=e.nodeValue,a=t.start,o=[],i=!0,l=!1,s=void 0;try{for(var h,c=t.hits[Symbol.iterator]();!(i=(h=c.next()).done);i=!0){var u=h.value,d=u.position,f=u.length,g=document.createTextNode(n.substring(a,d)),a=d+f,p=document.createElement("mark");p.className=r,p.appendChild(document.createTextNode(n.substr(d,f))),o.push(g,p)}}catch(t){l=!0,s=t}finally{try{!i&&c.return&&c.return()}finally{if(l)throw s}}e.nodeValue=n.substring(a,t.end),o.forEach(function(t){e.parentNode.insertBefore(t,e)})}},{key:"highlightSearchWords",value:function(t){var r=this,e=new URL(location.href).searchParams.get("highlight"),n=e?e.split(" "):[];if(n.length&&t){for(var a=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null),o=[];a.nextNode();)a.currentNode.parentNode.matches("button, select, textarea, .mermaid")||o.push(a.currentNode);o.forEach(function(t){var e=r.getIndexByWord(n,t.nodeValue),e=_slicedToArray(e,1)[0];e.length&&(e=r.mergeIntoSlice(0,t.nodeValue.length,e),r.highlightText(t,e,"search-keyword"))})}}}]),n}();