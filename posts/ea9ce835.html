<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍 Dubbo 的入门教程。"><meta property="og:type" content="article"><meta property="og:title" content="Dubbo2 巩固教程之三"><meta property="og:url" content="https://www.techgrow.cn/posts/ea9ce835.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍 Dubbo 的入门教程。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/09/dubbo-protocol-struct.png"><meta property="article:published_time" content="2019-09-18T15:42:35.000Z"><meta property="article:modified_time" content="2019-09-18T15:42:35.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="微服务"><meta property="article:tag" content="分布式"><meta property="article:tag" content="RPC"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2025/09/dubbo-protocol-struct.png"><link rel="canonical" href="https://www.techgrow.cn/posts/ea9ce835.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/ea9ce835.html","path":"posts/ea9ce835.html","title":"Dubbo2 巩固教程之三"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Dubbo2 巩固教程之三 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%BA%90"><span class="nav-text">学习资源</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dubbo-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-text">Dubbo 性能优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E5%8C%96-connections-%E5%8F%82%E6%95%B0"><span class="nav-text">优化 connections 参数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dubbo-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86"><span class="nav-text">Dubbo 底层原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Dubbo-%E5%8D%8F%E8%AE%AE%E7%9A%84%E6%8A%A5%E6%96%87%E6%A0%BC%E5%BC%8F"><span class="nav-text">Dubbo 协议的报文格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dubbo-%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E6%9C%BA%E5%88%B6"><span class="nav-text">Dubbo 协议的多路复用机制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dubbo-%E5%8E%9F%E7%90%86%E5%AE%9E%E8%B7%B5"><span class="nav-text">Dubbo 原理实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E-TCP-%E6%89%8B%E5%86%99-Dubbo-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text">基于 TCP 手写 Dubbo 客户端</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">741</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">53</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/ea9ce835.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Dubbo2 巩固教程之三 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍 Dubbo 的入门教程。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Dubbo2 巩固教程之三</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-09-18 23:42:35" itemprop="dateCreated datePublished" datetime="2019-09-18T23:42:35+08:00">2019-09-18</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/ea9ce835.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/ea9ce835.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>5k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>5 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/d484ffa3.html">Dubbo 2 入门教程之一</a>、<a href="/posts/ad584707.html">Dubbo 2 入门教程之二</a>、<a href="/posts/fab9c84c.html">Dubbo 2 入门教程之三</a>、<a href="/posts/b66ba452.html">Dubbo 2 入门教程之四</a></li><li><a href="/posts/ef04d10a.html">Dubbo 2 巩固教程之一</a>、<a href="/posts/b6d5fbb8.html">Dubbo 2 巩固教程之二</a>、<a href="/posts/ea9ce835.html">Dubbo 2 巩固教程之三</a></li></ul><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="学习资源"><a href="#学习资源" class="headerlink" title="学习资源"></a>学习资源</h3><ul><li><a target="_blank" rel="external nofollow" href="https://github.com/apache/incubator-dubbo/">Dubbo 官方项目</a></li><li><a target="_blank" rel="external nofollow" href="https://dubbo.apache.org/zh-cn/">Dubbo 官方文档</a></li><li><a target="_blank" rel="external nofollow" href="https://github.com/apache/dubbo-samples">Dubbo 官方案例</a></li></ul><span id="more"></span><h2 id="Dubbo-性能优化"><a href="#Dubbo-性能优化" class="headerlink" title="Dubbo 性能优化"></a>Dubbo 性能优化</h2><h3 id="优化-connections-参数"><a href="#优化-connections-参数" class="headerlink" title="优化 connections 参数"></a>优化 connections 参数</h3><p><code>@DubboReference</code> 注解中的 <code>connections</code> 参数用于限制服务消费者对同一个服务提供者实例建立的长连接（TCP）数量，主要解决高并发场景下连接复用与网络资源占用的平衡问题。值得一提的是，<code>connections</code> 参数的默认值是 <code>0</code>，通常不需要更改，表示对于同一个 Provider 实例，Consumer 只会建立一个 TCP 长连接。</p><ul><li><p><strong><code>connections</code> 参数的作用</strong></p><ul><li>在 Dubbo 中，服务消费者（Consumer）和服务提供者（Provider）之间使用长连接（TCP）进行通信。</li><li>默认情况下：<ul><li>对于消费者来说，同一个 Provider 实例只会建立一个 TCP 长连接，所有请求都复用这条连接，资源占用小，适用于业务流量不大的场景。</li><li>如果 <code>connections &gt; 0</code>，表示消费者会和每个 Provider 实例建立多个 TCP 长连接，并在请求时通过轮询或其他负载均衡算法选择具体的连接，适用于高并发或单连接成为性能瓶颈的场景。</li></ul></li><li>配置方式一（单独配置）：<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DubboReference(connections = 3)</span></span><br><span class="line"><span class="keyword">private</span> DemoService demoService;</span><br></pre></td></tr></tbody></table></figure></li><li>配置方式二（全局配置）：<figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dubbo:</span></span><br><span class="line">  <span class="attr">consumer:</span></span><br><span class="line">    <span class="attr">connections:</span> <span class="number">3</span></span><br></pre></td></tr></tbody></table></figure></li></ul></li><li><p><strong><code>connections</code> 参数的使用场景</strong></p><ul><li>单连接足够的场景，不需要配置 <code>connections</code> 参数<ul><li>普通的业务接口调用，每次请求数据量不大，QPS 不高。</li><li>复用同一条 TCP 长连接，可以减少系统资源开销：<ul><li>文件描述符（FD）数量低</li><li>内核 TCP 连接管理压力小</li><li>减少 TCP 连接的心跳、握手等开销</li></ul></li><li>例子：<ul><li>每秒只有几百个请求，QPS 不高，单连接带宽也够用，就不需要配置 <code>connections</code> 参数。</li></ul></li></ul></li><li>多连接的场景，以下几种情况建议配置 <code>connections &gt; 1</code><ul><li>(1) 单连接带宽瓶颈<ul><li>如果请求数据量非常大，例如每次响应数据都在 1 MB 以上，那么单条连接可能会填满 TCP 窗口，阻塞后续请求。</li><li>表现症状：<ul><li>Dubbo 的 RPC 调用延迟突然增大</li><li>网络监控到单条 TCP 连接的带宽被打满，但 CPU 却空闲</li></ul></li><li>通过配置 <code>connections = 2 ~ 4</code>，可以分散流量，避免单连接成为性能瓶颈。</li></ul></li><li>(2) 串行化阻塞的问题<ul><li> Dubbo 的网络层默认基于 Netty 的 NIO，同一条连接上的请求是无序并发的，但如果：<ul><li>Provider 端是单线程处理请求，或者 Consumer 端串行发送请求；</li><li>可能出现请求阻塞队头（Head-of-line Blocking）。</li></ul></li><li>通过多个连接让请求分散处理，可以提升并发度。</li></ul></li><li>(3) Provider 实例数量少，但请求量大<ul><li>假设只有 2 个 Provider 实例，但 Consumer 的 QPS 很高，单个 TCP 连接无法支撑。</li><li>例子：<ul><li>Consumer 的总请求量达到 1 万 QPS；</li><li>如果每个 Provider 实例只有 2 个连接，实际单连接需要支持 5000 QPS，这很容易成为性能瓶颈。</li></ul></li></ul></li></ul></li></ul></li><li><p><strong><code>connections</code> 参数的调优建议</strong></p><ul><li>不随便更改配置<ul><li><code>connections</code> 参数的默认值是 <code>0</code>，表示对于同一个 Provider 实例，Consumer 只会建立一个 TCP 长连接。</li><li>不随便更改 <code>connections</code> 参数的值，先进行性能压测。</li></ul></li><li>如果发现：<ul><li>单连接的 RTT（往返时间）过高</li><li> TCP 窗口打满</li><li>请求阻塞</li><li> Provider 实例数量少且流量大<br>→ 可以逐步调高 <code>connections</code> 参数的值。</li></ul></li><li>监控 <code>ESTABLISHED</code> 状态的 TCP 连接数和文件描述符（FD）使用率，避免触发操作系统的 <code>ulimit</code> 限制。</li></ul></li><li><p><strong><code>connections</code> 参数的使用总结</strong></p></li></ul><table><thead><tr><th>项目</th><th>说明</th></tr></thead><tbody><tr><td>默认行为</td><td>对于 Consumer，同一个 Provider 实例只建立 1 条 TCP 长连接</td></tr><tr><td>设置 <code>connections &gt; 0</code></td><td>对于 Consumer，同一个 Provider 实例建立 N 条 TCP 长连接，缓解单连接的性能瓶颈</td></tr><tr><td>主要解决的问题</td><td>单连接带宽不足、请求阻塞、并发度不足的问题</td></tr><tr><td>底层网络实现</td><td>底层基于 Netty，多条 TCP 连接对应多个 <code>Channel</code>，通过 <code>ChannelPool</code> 轮询选择 TCP 连接</td></tr><tr><td>建议配置值</td><td><code>connections</code> 参数的值一般设置 2 ~ 4 已经够用，因此不要盲目设置太大，否则会浪费资源</td></tr><tr><td>连接建立的时机</td><td> Provider 的 TCP 连接是在 Consumer 启动、从注册中心获取到服务列表之后就会立即建立，不是在第一次发起 RPC 调用时才建立连接，这属于 “预热连接” 机制</td></tr></tbody></table><h2 id="Dubbo-底层原理"><a href="#Dubbo-底层原理" class="headerlink" title="Dubbo 底层原理"></a>Dubbo 底层原理</h2><h3 id="Dubbo-协议的报文格式"><a href="#Dubbo-协议的报文格式" class="headerlink" title="Dubbo 协议的报文格式"></a>Dubbo 协议的报文格式</h3><p><img data-src="../../../asset/2025/09/dubbo-protocol-struct.png"></p><ul><li><strong>Dubbo 协议的消息头（固定 16 个字节）</strong></li></ul><table><thead><tr><th>字段</th><th>长度</th><th>作用</th></tr></thead><tbody><tr><td> Magic Number</td><td>2 字节</td><td>魔数（通信协议标识），Dubbo 协议是固定值 <code>0xdabb</code></td></tr><tr><td>Flag</td><td>1 字节</td><td>请求 / 响应标识</td></tr><tr><td> Status</td><td>1 字节</td><td>响应状态</td></tr><tr><td> Request ID</td><td>8 字节</td><td>请求的唯一标识</td></tr><tr><td> Body Length</td><td>4 字节</td><td>请求体的长度</td></tr></tbody></table><ul><li> <strong>Dubbo 协议的消息体（具体的业务操作内容）</strong></li></ul><table><thead><tr><th>字段名</th><th>说明</th></tr></thead><tbody><tr><td> RPC 版本</td><td> Dubbo RPC 协议的版本号（比如 <code>2.0.2</code>）</td></tr><tr><td>服务接口路径</td><td>服务接口的全限定名（比如 <code>com.example.UserService</code>）</td></tr><tr><td>服务版本号</td><td>服务的版本信息（比如 <code>1.0.0</code>）</td></tr><tr><td>服务方法名</td><td>调用的具体方法名称（比如 <code>getUserById</code>）</td></tr><tr><td>参数描述符</td><td>方法参数类型描述字符串（比如 <code>Ljava/lang/String;</code> 表示 String 类型参数）</td></tr><tr><td>参数值序列化</td><td>参数值的序列化内容（根据序列化协议如 Hessian2、JSON 等序列化后的字节流）</td></tr><tr><td>Dubbo 内置参数</td><td> Dubbo 扩展的键值对参数（比如 <code>path</code>、<code>timeout</code>、<code>group</code>、<code>loadbalance</code> 等）</td></tr></tbody></table><div class="admonition note"><p class="admonition-title">扩展阅读</p><ul><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/Kiven_ch/article/details/118033998">Dubbo 源码学习 - 网络通信原理</a></li></ul></div><h3 id="Dubbo-协议的多路复用机制"><a href="#Dubbo-协议的多路复用机制" class="headerlink" title="Dubbo 协议的多路复用机制"></a>Dubbo 协议的多路复用机制</h3><p>Dubbo 协议（官方默认协议）支持单连接并发请求，因为它在 TCP 协议之上通过 Netty 和自定义通信协议实现了同一条 TCP 连接上的多路复用机制。每个请求都有唯一的 Request ID，响应则根据 Request ID 匹配到对应的调用线程，从而突破了 TCP 串行阻塞的限制。这就是 Dubbo 协议的多路复用机制，也是其高性能的主要原因。虽然 TCP 本质上是有序字节流，但 Dubbo 协议允许多个 RPC 请求在同一连接上交错传输，不必等待 “一个请求发送完、响应回来后才处理下一个请求”，实现了真正的并发请求。如果单连接仍存在性能瓶颈，可以通过调高 <code>connections</code> 参数，让 Consumer 为每个 Provider 建立多条物理 TCP 连接来分担流量。</p><div class="admonition warning"><p class="admonition-title">特别注意</p><ul><li>Dubbo 协议的的多路复用机制，本质上复用的是 TCP 连接，也就是在同一条物理 TCP 连接上同时承载多个 RPC 请求和响应，从而减少连接建立的开销，并显著提升吞吐量。</li><li>这跟常说的 I/O 多路复用机制（比如 <code>poll</code>、<code>epoll</code>）完全不同，因为 <code>epoll</code> 等 I/O 多路复用机制本质上是在操作系统层面复用线程，两者概念完全不同。</li></ul></div><ul><li><p><strong>基础认知：TCP 是有序字节流</strong></p><ul><li>TCP 连接本身提供的只是可靠的、有序的字节流，并不关心应用层消息的边界。</li><li>如果应用层不做任何设计，那么它只能按顺序处理请求：<ul><li>(1) 客户端发出请求 A</li><li>(2) 客户端等待服务端响应 A</li><li>(3) 客户端才能发送请求 B</li></ul></li><li> 这就像一条 “管道”，只能一个一个地走，非常低效。</li><li>典型例子：HTTP/1.0 早期，每次请求必须等上一次响应返回后才能发起下一次，这就是队头阻塞（Head-of-Line Blocking）。</li></ul></li><li><p><strong>Dubbo 协议的报文结构</strong></p><ul><li>Dubbo 协议的消息头固定 16 字节，包含关键信息：</li></ul><table><thead><tr><th>字段</th><th>长度</th><th>作用</th></tr></thead><tbody><tr><td> Magic Number</td><td>2 字节</td><td>魔数（通信协议标识），Dubbo 协议是固定值 <code>0xdabb</code></td></tr><tr><td>Flag</td><td>1 字节</td><td>请求 / 响应标识</td></tr><tr><td> Status</td><td>1 字节</td><td>响应状态</td></tr><tr><td> Request ID</td><td>8 字节</td><td>请求的唯一标识</td></tr><tr><td> Body Length</td><td>4 字节</td><td>请求体的长度</td></tr></tbody></table><ul><li> Dubbo 协议的报文格式：<ul><li><code>| Header(16 bytes) | Body(variable) |</code></li></ul></li><li>Dubbo 处理报文的流程：<ul><li>Consumer 发起 RPC 调用时，生成一个全局唯一的 Request ID</li><li>Provider 处理完请求后，响应中带回相同的 Request ID</li><li>Consumer 根据 Request ID 将响应结果分发到正确的调用线程</li></ul></li></ul></li><li><p> <strong>Dubbo 协议的多路复用机制</strong></p><ul><li><p>假设 Consumer 同时发起 3 个 RPC 请求（A、B、C），请求体会被打包，如下：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Consumer 的 TCP 发送缓冲区：|Header(ID=1)|BodyA|Header(ID=2)|BodyB|Header(ID=3)|BodyC|</span><br></pre></td></tr></tbody></table></figure></li><li><p>Provider 可以并发处理这 3 个请求，并按处理完成的先后顺序返回结果，如下：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Consumer 的 TCP 接收缓冲区：|Header(ID=2)|RespB|Header(ID=1)|RespA|Header(ID=3)|RespC|</span><br></pre></td></tr></tbody></table></figure></li><li><p>Consumer 接收到响应结果后：</p><ul><li>解析消息头，取出 Request ID</li><li> 将 RespB 分发给发起 B 请求的线程</li><li>将 RespA 分发给 A 请求线程</li><li>将 RespC 分发给 C 请求线程</li></ul></li><li><p>这并行和串行的区别：</p><ul><li><p>在 Dubbo 中，即使只有一条 TCP 连接，也能同时跑成百上千的并发请求。</p><table><thead><tr><th>特性</th><th>串行请求（无 Request ID）</th><th>Dubbo 并发请求（带 Request ID）</th></tr></thead><tbody><tr><td>TCP 数据组织</td><td>每次只能传一条完整消息</td><td>多条消息交错在同一流里</td></tr><tr><td>发送端</td><td>必须等待上一个响应回来才能发送下一个请求</td><td>可以连续发送多个请求</td></tr><tr><td>响应顺序</td><td>响应必须严格按请求顺序返回</td><td>响应顺序与请求顺序无关</td></tr><tr><td>并发性能</td><td>低，队头阻塞严重</td><td>高，类似 HTTP/2 多路复用</td></tr></tbody></table></li></ul></li></ul></li><li><p> <strong>Dubbo 协议多路复用机制的工作流程</strong></p><ul><li>(1) 客户端发起调用<ul><li> Consumer 应用线程调用代理对象</li><li> Dubbo 在客户端生成一个唯一的 Request ID 并将调用参数序列化</li></ul></li><li> (2) 写入 Netty Channel<ul><li> 所有调用请求都会被写入同一条 Netty Channel</li><li> 发送数据时不会阻塞，只要 TCP 发送缓冲区有空间，就可以写入</li></ul></li><li> (3) 服务端并发处理<ul><li> Provider 使用线程池同时处理多个请求</li><li>不要求按请求顺序处理，哪个先处理完就先返回</li></ul></li><li> (4) 返回结果匹配<ul><li> Consumer 维护一个 <code>ConcurrentHashMap&lt;Long, Future&gt;</code></li><li><code>Key = Request ID</code>，<code>Value = 该请求对应的 Future</code></li><li>Consumer 收到响应时，根据响应里的 Request ID 找到对应 Future，并唤醒等待线程（调用线程）</li></ul></li></ul></li><li><p><strong>Dubbo 协议为什么还会出现 “单连接阻塞” 问题</strong></p><ul><li>虽然 Dubbo 协议支持单连接并发请求，但底层 TCP 仍然是单通道，存在物理限制，主要体现在：<ul><li>TCP 层的队头阻塞（Head-of-Line Blocking）<ul><li>TCP 是有序字节流，一旦某个包丢失，后续所有数据都必须等待该包重传。</li><li>如果网络丢包率高，即使 Dubbo 应用层并行，仍会被 TCP 阻塞。</li></ul></li><li>Provider 中的线程池已满<ul><li>如果 Provider 的处理线程不足，Consumer 的请求虽然发出去了，但在服务端被排队。</li></ul></li><li>单连接带宽不足<ul><li>多个请求争夺同一条 TCP 通道的带宽时，整体性能受限。</li></ul></li></ul></li></ul></li><li><p><strong>Dubbo 多路复用机制的类比理解</strong></p><ul><li>可以将 Dubbo 多路复用机制类比为高速公路：</li></ul><table><thead><tr><th>场景</th><th>类比</th></tr></thead><tbody><tr><td>串行模式</td><td>高速公路只有 1 条车道，车必须按顺序行驶，前车没到终点，后车不能走</td></tr><tr><td> Dubbo 多路复用</td><td>高速公路有多条虚拟车道（Request ID），虽然实际物理只有 1 条道路，但每辆车都有自己的标记，不会互相等待</td></tr></tbody></table></li><li><p> <strong>Dubbo 不同通信协议对单连接并发请求的支持情况</strong></p></li></ul><table><thead><tr><th>通信协议类型</th><th>是否支持单连接并发请求（多路复用机制）</th><th>说明</th></tr></thead><tbody><tr><td> Dubbo 协议（默认）</td><td>✅ 支持</td><td>通过自定义协议头 + Request ID 实现多路复用，这是 Dubbo 高性能的核心。</td></tr><tr><td>Triple 协议（gRPC）</td><td>✅ 支持</td><td>基于 HTTP/2，本身支持多路复用，天然具备并行能力。</td></tr><tr><td>RMI、Hessian、WebService 等传统协议</td><td>❌ 不支持</td><td>基于同步调用或无多路复用设计，一个请求未返回响应前，后续请求无法在同一连接并行发送。</td></tr></tbody></table><h2 id="Dubbo-原理实践"><a href="#Dubbo-原理实践" class="headerlink" title="Dubbo 原理实践"></a>Dubbo 原理实践</h2><h3 id="基于-TCP-手写-Dubbo-客户端"><a href="#基于-TCP-手写-Dubbo-客户端" class="headerlink" title="基于 TCP 手写 Dubbo 客户端"></a>基于 TCP 手写 Dubbo 客户端</h3><div class="admonition note"><p class="admonition-title">学习目标与代码下载</p><ul><li>这里将基于 <a href="/posts/b6d5fbb8.html#Dubbo-%E5%8D%8F%E8%AE%AE%E7%9A%84%E6%8A%A5%E6%96%87%E6%A0%BC%E5%BC%8F">Dubbo 协议的报文格式</a> + TCP 手写一个 Dubbo 客户端，目的是熟悉 Dubbo 协议的报文格式。</li><li>为了方便演示，服务提供者（Provider）使用的通信协议为 Dubbo 协议，而<strong>序列化协议为 FastJSON</strong>，注册中心使用 ZooKeeper。</li><li>由于篇幅有限，下面只给出服务消费者（Consumer）的核心代码，而服务提供者（Provider）的代码不再累述，完整的案例代码可以直接从 <a target="_blank" rel="external nofollow" href="https://github.com/rqh656418510/spring-cloud-share/tree/main/rpc-framework/dubbo-study/dubbo2.x-study">GitHub</a> 下载对应章节 <code>dubbo-lesson-09</code>。</li></ul></div><blockquote><p>案例代码</p></blockquote><ul><li>ZooKeeper 中的数据存储结构</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/dubbo</span><br><span class="line">└── com.clay.dubbo.service.DemoService</span><br><span class="line">    ├── providers</span><br><span class="line">    │   └── dubbo%3A%2F%2F192.168.233.1%3A20880%2Fcom.clay.dubbo.service.DemoService%3Fanyhost%3Dtrue%26application%3Ddubbo-provider-application%26deprecated%3Dfalse%26dubbo%3D2.0.2%26dynamic%3Dtrue%26generic%3Dfalse%26interface%3Dcom.clay.dubbo.service.DemoService%26metadata-type%3Dremote%26methods%3DsayHello%26pid%3D47362%26release%3D2.7.23%26serialization%3Dfastjson%26service.name%3DServiceBean%3A%2Fcom.clay.dubbo.service.DemoService%26side%3Dprovider%26timestamp%3D1758794536318</span><br><span class="line">    │</span><br><span class="line">    ├── consumers</span><br><span class="line">    │   └── empty</span><br><span class="line">    │</span><br><span class="line">    ├── configurators</span><br><span class="line">    │   └── empty</span><br><span class="line">    │</span><br><span class="line">    └── routers</span><br><span class="line">        └── empty</span><br></pre></td></tr></tbody></table></figure><ul><li>核心依赖（服务消费者端）</li></ul><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.23<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.clay.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-lesson-09-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><ul><li>核心代码（服务消费者端）</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.clay.dubbo.service.DemoService;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.URL;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.io.Bytes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.URLDecoder;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ZooKeeper 连接地址（多个集群节点使用逗号分割）</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ADDRESS = <span class="string">"192.168.2.235:2181"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ZooKeeper 会话超时时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_TIMEOUT = <span class="number">2000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根节点的路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROOT_PATH = <span class="string">"/dubbo"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 服务节点的路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVICE_PATH = ROOT_PATH + <span class="string">"/"</span> + DemoService.class.getName() + <span class="string">"/providers"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取 ZK 客户端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CuratorFramework <span class="title">getCuratorFramework</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// 重试策略</span></span><br><span class="line">        ExponentialBackoffRetry backoffRetry = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">3000</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建 ZK 客户端</span></span><br><span class="line">        CuratorFramework client = CuratorFrameworkFactory.builder()</span><br><span class="line">            .connectString(ADDRESS)</span><br><span class="line">            .connectionTimeoutMs(SESSION_TIMEOUT)</span><br><span class="line">            .retryPolicy(backoffRetry)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动 ZK 客户端</span></span><br><span class="line">        client.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">// 获取服务地址列表</span></span><br><span class="line">        CuratorFramework zkClient = getCuratorFramework();</span><br><span class="line">        List&lt;String&gt; providerUrls = zkClient.getChildren().forPath(SERVICE_PATH);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (providerUrls.size() == <span class="number">0</span>) {</span><br><span class="line">            System.out.println(<span class="string">"服务地址列表为空，客户端退出"</span>);</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 随机选取一个服务地址</span></span><br><span class="line">        <span class="keyword">int</span> index = <span class="keyword">new</span> Random().nextInt(providerUrls.size());</span><br><span class="line">        String providerUrl = providerUrls.get(index);</span><br><span class="line">        System.out.println(<span class="string">"未解码的 URL: "</span> + providerUrl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对 Provider URL 进行解码</span></span><br><span class="line">        String decodeUrl = URLDecoder.decode(providerUrl, StandardCharsets.UTF_8.name());</span><br><span class="line">        System.out.println(<span class="string">"解码后的 URL: "</span> + decodeUrl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取 Provider 的信息</span></span><br><span class="line">        URL url = URL.valueOf(decodeUrl);</span><br><span class="line">        String protocol = url.getProtocol(); <span class="comment">// dubbo</span></span><br><span class="line">        String host = url.getHost(); <span class="comment">// 192.168.233.1</span></span><br><span class="line">        <span class="keyword">int</span> port = url.getPort(); <span class="comment">// 20880</span></span><br><span class="line">        String path = url.getPath(); <span class="comment">// com.clay.dubbo.service.DemoService</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建 TCP 客户端</span></span><br><span class="line">        SocketChannel dubboClient = SocketChannel.open();</span><br><span class="line">        dubboClient.connect(<span class="keyword">new</span> InetSocketAddress(host, port));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送的数据（消息体），基于 FastJSON 序列化协议，以下内容必须按顺序组织</span></span><br><span class="line">        StringBuffer bodyString = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        <span class="comment">// Dubbo 协议的版本</span></span><br><span class="line">        bodyString.append(JSON.toJSONString(<span class="string">"2.0.2"</span>)).append(<span class="string">"\r\n"</span>);</span><br><span class="line">        <span class="comment">// 接口名称</span></span><br><span class="line">        bodyString.append(JSON.toJSONString(path)).append(<span class="string">"\r\n"</span>);</span><br><span class="line">        <span class="comment">// 接口版本</span></span><br><span class="line">        bodyString.append(JSON.toJSONString(<span class="string">"0.0.0"</span>)).append(<span class="string">"\r\n"</span>);</span><br><span class="line">        <span class="comment">// 方法名称</span></span><br><span class="line">        bodyString.append(JSON.toJSONString(<span class="string">"sayHello"</span>)).append(<span class="string">"\r\n"</span>);</span><br><span class="line">        <span class="comment">// 参数描述</span></span><br><span class="line">        bodyString.append(JSON.toJSONString(<span class="string">"Ljava/lang/String;"</span>)).append(<span class="string">"\r\n"</span>);</span><br><span class="line">        <span class="comment">// 参数值（经过序列化）</span></span><br><span class="line">        bodyString.append(JSON.toJSONString(<span class="string">"Jim"</span>)).append(<span class="string">"\r\n"</span>);</span><br><span class="line">        <span class="comment">// 附加参数（用于扩展 Dubbo 功能）</span></span><br><span class="line">        bodyString.append(<span class="string">"{}"</span>).append(<span class="string">"\r\n"</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] body = bodyString.toString().getBytes();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送的数据（消息头），固定 16 个字节</span></span><br><span class="line">        <span class="keyword">byte</span>[] header = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">16</span>];</span><br><span class="line">        <span class="comment">// 魔数，协议标识（2 个字节）</span></span><br><span class="line">        <span class="keyword">byte</span>[] magicArray = Bytes.short2bytes((<span class="keyword">short</span>) <span class="number">0xdabb</span>);</span><br><span class="line">        System.arraycopy(magicArray, <span class="number">0</span>, header, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="comment">// 请求 / 响应标识（1 个字节）</span></span><br><span class="line">        header[<span class="number">2</span>] = (<span class="keyword">byte</span>) <span class="number">0xc6</span>;</span><br><span class="line">        <span class="comment">// 响应状态（1 个字节）</span></span><br><span class="line">        header[<span class="number">3</span>] = <span class="number">0x00</span>;</span><br><span class="line">        <span class="comment">// 请求 ID（8 个字节）</span></span><br><span class="line">        <span class="keyword">byte</span>[] requestId = Bytes.long2bytes(<span class="number">1</span>);</span><br><span class="line">        System.arraycopy(requestId, <span class="number">0</span>, header, <span class="number">4</span>, <span class="number">8</span>);</span><br><span class="line">        <span class="comment">// 消息体的长度（4 个字节）</span></span><br><span class="line">        <span class="keyword">byte</span>[] bodyLength = Bytes.int2bytes(body.length);</span><br><span class="line">        System.arraycopy(bodyLength, <span class="number">0</span>, header, <span class="number">12</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 封装请求报文</span></span><br><span class="line">        <span class="keyword">byte</span>[] request = <span class="keyword">new</span> <span class="keyword">byte</span>[header.length + body.length];</span><br><span class="line">        System.arraycopy(header, <span class="number">0</span>, request, <span class="number">0</span>, header.length);</span><br><span class="line">        System.arraycopy(body, <span class="number">0</span>, request, header.length, body.length);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送 RPC 请求</span></span><br><span class="line">        dubboClient.write(ByteBuffer.wrap(request));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取响应结果</span></span><br><span class="line">        ByteBuffer response = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        dubboClient.read(response);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 准备读取响应结果</span></span><br><span class="line">        response.flip();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印响应结果</span></span><br><span class="line">        <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[response.remaining()];</span><br><span class="line">        response.get(data);</span><br><span class="line">        System.out.println(<span class="string">"RPC 调用结果："</span> + <span class="keyword">new</span> String(data));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        ConsumerApplication application = <span class="keyword">new</span> ConsumerApplication();</span><br><span class="line">        application.run();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>测试结果（服务消费者端），打印 RPC 调用结果时可能会出现部分内容乱码，但不影响整体的测试效果</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">未解码的 URL: dubbo%3A%2F%2F192.168.233.1%3A20880%2Fcom.clay.dubbo.service.DemoService%3Fanyhost%3Dtrue%26application%3Ddubbo-provider-application%26deprecated%3Dfalse%26dubbo%3D2.0.2%26dynamic%3Dtrue%26generic%3Dfalse%26interface%3Dcom.clay.dubbo.service.DemoService%26metadata-type%3Dremote%26methods%3DsayHello%26pid%3D47362%26release%3D2.7.23%26serialization%3Dfastjson%26service.name%3DServiceBean%3A%2Fcom.clay.dubbo.service.DemoService%26side%3Dprovider%26timestamp%3D1758794536318</span><br><span class="line"></span><br><span class="line">解码后的 URL: dubbo://192.168.233.1:20880/com.clay.dubbo.service.DemoService?anyhost=true&amp;application=dubbo-provider-application&amp;deprecated=false&amp;dubbo=2.0.2&amp;dynamic=true&amp;generic=false&amp;interface=com.clay.dubbo.service.DemoService&amp;metadata-type=remote&amp;methods=sayHello&amp;pid=47362&amp;release=2.7.23&amp;serialization=fastjson&amp;service.name=ServiceBean:/com.clay.dubbo.service.DemoService&amp;side=provider&amp;timestamp=1758794536318</span><br><span class="line"></span><br><span class="line">RPC 调用结果：ڻ           4</span><br><span class="line">"Hello Jim"</span><br><span class="line">{"dubbo":"2.0.2"}</span><br></pre></td></tr></tbody></table></figure><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/ea9ce835.html" title="Dubbo2 巩固教程之三">https://www.techgrow.cn/posts/ea9ce835.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="fa fa-tag"></i> 微服务</a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag"><i class="fa fa-tag"></i> 分布式</a><a href="/tags/RPC/" rel="tag"><i class="fa fa-tag"></i> RPC</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/4688dc15.html" rel="prev" title="Centos7 管理 YUM 源与 EPEL 源"><i class="fa fa-angle-left"></i> Centos7 管理 YUM 源与 EPEL 源</a></div><div class="post-nav-item"> <a href="/posts/f83b3bd2.html" rel="next" title="Centos7 安装 Zsh 与 Guake">Centos7 安装 Zsh 与 Guake<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">2.1m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">31:07</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/ea9ce835.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>