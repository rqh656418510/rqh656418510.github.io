<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍分布式事务解决方案，包括 TCC、XA、Seata 等内容。"><meta property="og:type" content="article"><meta property="og:title" content="分布式事务解决方案介绍"><meta property="og:url" content="https://www.techgrow.cn/posts/726e9aff.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍分布式事务解决方案，包括 TCC、XA、Seata 等内容。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/distributed-transaction-scene-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/distributed-transaction-scene-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/distributed-transaction-scene-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/distributed-transaction-dtp-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/distributed-transaction-dtp-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/tcc-transaction.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/best-effort-notice.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/reliable-message-service.png"><meta property="article:published_time" content="2020-12-23T13:12:19.000Z"><meta property="article:modified_time" content="2020-12-23T13:12:19.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="微服务"><meta property="article:tag" content="数据库"><meta property="article:tag" content="分布式"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2020/12/distributed-transaction-scene-1.png"><link rel="canonical" href="https://www.techgrow.cn/posts/726e9aff.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/726e9aff.html","path":"posts/726e9aff.html","title":"分布式事务解决方案介绍"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>分布式事务解决方案介绍 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%93%E4%B8%9A%E6%9C%AF%E8%AF%AD"><span class="nav-text">专业术语</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%90%86%E8%AE%BA"><span class="nav-text">分布式理论</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%9F%BA%E7%A1%80"><span class="nav-text">分布式事务基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E4%BA%8B%E5%8A%A1"><span class="nav-text">什么是事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1"><span class="nav-text">什么是本地事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="nav-text">什么是分布式事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">分布式事务的适用场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-text">分布式事务解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E4%BA%8B%E5%8A%A1%EF%BC%88DTP%EF%BC%89"><span class="nav-text">全局事务（DTP）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%EF%BC%882PC%EF%BC%89"><span class="nav-text">两阶段提交（2PC）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%EF%BC%883PC%EF%BC%89"><span class="nav-text">三阶段提交（3PC）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCC%EF%BC%88%E4%B8%A4%E9%98%B6%E6%AE%B5%E5%9E%8B%E3%80%81%E8%A1%A5%E5%81%BF%E5%9E%8B%EF%BC%89"><span class="nav-text">TCC（两阶段型、补偿型）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%80%E5%A4%A7%E5%8A%AA%E5%8A%9B%E9%80%9A%E7%9F%A5%EF%BC%88%E5%AE%9A%E6%9C%9F%E6%A0%A1%E5%AF%B9%EF%BC%89"><span class="nav-text">最大努力通知（定期校对）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%AF%E9%9D%A0%E6%B6%88%E6%81%AF%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-text">可靠消息最终一致性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Seata-%E6%94%AF%E6%8C%81%E7%9A%84%E5%9B%9B%E7%A7%8D%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%BC%8F"><span class="nav-text">Seata 支持的四种事务模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AT%EF%BC%88Automatic-Transaction-%E8%87%AA%E5%8A%A8%E6%8F%90%E4%BA%A4%EF%BC%89"><span class="nav-text">AT（Automatic Transaction - 自动提交）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XA%EF%BC%88Two-Phase-Commit-%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%EF%BC%89"><span class="nav-text">XA（Two-Phase Commit - 两阶段提交）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCC%EF%BC%88Try-Confirm-Cancel%EF%BC%89"><span class="nav-text">TCC（Try-Confirm-Cancel）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SAGA%EF%BC%88%E8%A1%A5%E5%81%BF%E4%BA%8B%E5%8A%A1%EF%BC%89"><span class="nav-text">SAGA（补偿事务）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E9%97%AE%E9%A2%98"><span class="nav-text">分布式事务问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%81%BF%E5%85%8D%E6%BB%A5%E7%94%A8%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="nav-text">避免滥用分布式事务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">732</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">53</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/726e9aff.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="分布式事务解决方案介绍 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍分布式事务解决方案，包括 TCC、XA、Seata 等内容。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 分布式事务解决方案介绍</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-12-23 21:12:19" itemprop="dateCreated datePublished" datetime="2020-12-23T21:12:19+08:00">2020-12-23</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/726e9aff.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/726e9aff.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>8.7k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>8 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="专业术语"><a href="#专业术语" class="headerlink" title="专业术语"></a>专业术语</h3><ul><li><p><code>TX 协议</code>：</p><ul><li>应用或者应用服务器与事务管理器的接口</li></ul></li><li><p><code>XA 协议</code>：</p><ul><li>全局事务管理器与资源管理器的接口。</li><li>XA 是由 X/Open 组织提出的分布式事务规范，该规范主要定义了全局事务管理器和局部资源管理器之间的接口，主流的数据库产品都实现了 XA 接口。XA 接口是一个双向的系统接口，在事务管理器以及多个资源管理器之间作为通信桥梁。</li><li>之所以需要 XA 是因为在分布式系统中从理论上讲两台机器是无法达到一致性状态的，因此引入一个单点进行协调。由全局事务管理器管理和协调的事务可以跨越多个资源和进程。全局事务管理器一般使用 XA 二阶段协议与数据库进行交互。</li></ul></li></ul><span id="more"></span><h3 id="分布式理论"><a href="#分布式理论" class="headerlink" title="分布式理论"></a>分布式理论</h3><blockquote><p>CAP 理论</p></blockquote><p>CAP 定理是由加州大学伯克利分校 Eric Brewer 教授提出来的，他指出 WEB 服务无法同时满足一下三个属性：</p><ul><li>一致性 (Consistency)：客户端知道一系列的操作都会同时发生 (生效)</li><li> 可用性 (Availability)：每个操作都必须以可预期的响应结束</li><li>分区容错性 (Partition tolerance)：即使出现单个组件无法可用，操作依然可以完成</li></ul><p>具体地讲在分布式系统中，任何数据库设计或者 Web 应用至多只能同时支持上面的两个属性。显然，任何横向扩展策略都要依赖于数据分区。因此，设计人员<strong>必须在一致性与可用性之间做出选择</strong>。</p><blockquote><p>BASE 理论</p></blockquote><p>在分布式系统中，往往追求的是可用性，它的重要程序比一致性要高，那么如何实现高可用性呢？前人已经给我们提出来了另外一个理论，就是 BASE 理论，它是用来对 CAP 定理进行进一步扩充的。BASE 理论指的是：</p><ul><li>Basically Available（基本可用）</li><li>Soft state（软状态）</li><li>Eventually consistent（最终一致性）</li></ul><p>BASE 理论是对 CAP 中的一致性和可用性进行一个权衡的结果，理论的核心思想就是：<strong>无法做到强一致，但每个应用都可以根据自身的业务特点，采用适当的方式来使系统达到最终一致性（Eventual consistency）</strong>。</p><blockquote><p>酸碱平衡</p></blockquote><p>ACID 能够保证事务的强一致性，即数据是实时一致的，这在本地事务中是没有问题的。在分布式事务中，强一致性会极大影响分布式系统的性能，因此分布式系统中遵循 BASE 理论即可。但分布式系统的不同业务场景对一致性的要求也不同。如交易场景下，就要求强一致性，此时就需要遵循 ACID 理论，而在注册成功后发送短信验证码等场景下，并不需要实时一致，因此遵循 BASE 理论即可。因此要根据具体业务场景，在 ACID 和 BASE 之间寻求平衡。</p><h2 id="分布式事务基础"><a href="#分布式事务基础" class="headerlink" title="分布式事务基础"></a>分布式事务基础</h2><h3 id="什么是事务"><a href="#什么是事务" class="headerlink" title="什么是事务"></a>什么是事务</h3><p>事务指的就是一个操作单元，在这个操作单元中的所有操作最终要保持一致的行为，要么所有操都成功，要么所有的操作都被撤销。简单地说，事务提供一种” 要么什么都不做，要么做全套 “机制。</p><h3 id="什么是本地事务"><a href="#什么是本地事务" class="headerlink" title="什么是本地事务"></a>什么是本地事务</h3><p>本地事务其实可以认为是数据库提供的事务机制。说到数据库事务就不得不说，数据库事务中的四大特性（ACID）：</p><ul><li>A：原子性（Atomicity），一个事务中的所有操作，要么全部完成，要么全部不完成</li><li> C：一致性（Consistency），在一个事务执行之前和执行之后数据库都必须处于一致性状态</li><li> I：隔离性（Isolation），在并发环境中，当不同的事务同时操作相同的数据时，事务之间互不影响</li><li> D：持久性（Durability），指的是只要事务成功结束，它对数据库所做的更新就必须永久的保存下来</li></ul><p>数据库事务在实现时会将一次事务涉及的所有操作全部纳入到一个不可分割的执行单元，该执行单元中的所有操作要么都成功，要么都失败，只要其中任一操作执行失败，都将导致整个事务的回滚。</p><h3 id="什么是分布式事务"><a href="#什么是分布式事务" class="headerlink" title="什么是分布式事务"></a>什么是分布式事务</h3><p>分布式事务指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上。简而言之，就是一次大的操作由不同的小操作组成，这些小的操作分布在不同的服务器上，且属于不同的应用，分布式事务需要保证这些小操作要么全部成功，要么全部失败。本质上来说，分布式事务就是为了保证不同数据库的数据一致性。一句话概括就是，<strong>一次业务操作需要跨多个数据源或者需要跨多个系统进行远程调用，就会产生分布式事务问题。</strong></p><h3 id="分布式事务的适用场景"><a href="#分布式事务的适用场景" class="headerlink" title="分布式事务的适用场景"></a>分布式事务的适用场景</h3><ul><li>单体系统访问多个数据库：一个服务需要调用多个数据库实例完成数据的增删改操作</li></ul><p><img data-src="../../../asset/2020/12/distributed-transaction-scene-1.png" alt="distributed-transaction-scene-1"></p><ul><li>多个微服务访问同一个数据库：多个服务需要调用一个数据库实例完成数据的增删改操作</li></ul><p><img data-src="../../../asset/2020/12/distributed-transaction-scene-2.png" alt="distributed-transaction-scene-2"></p><ul><li>多个微服务访问多个数据库：多个服务需要调用多个数据库实例完成数据的增删改操作</li></ul><p><img data-src="../../../asset/2020/12/distributed-transaction-scene-3.png" alt="distributed-transaction-scene-3"></p><h2 id="分布式事务解决方案"><a href="#分布式事务解决方案" class="headerlink" title="分布式事务解决方案"></a>分布式事务解决方案</h2><h3 id="全局事务（DTP）"><a href="#全局事务（DTP）" class="headerlink" title="全局事务（DTP）"></a>全局事务（DTP）</h3><p>全局事务是基于 DTP 模型实现的，DTP 是由 X/Open 组织提出的一种分布式事务模型 — X/Open Distributed Transaction Processing Reference Model。它规定了要实现分布式事务，需要三种角色：</p><ul><li><code>AP</code>：Application 应用系统（微服务）</li><li><code>RM</code>：Resource Manager 资源管理器（数据库）</li><li><code>TM</code>：Transaction Manager 事务管理器（全局事务管理）</li></ul><p><strong>整个事务分成两个阶段：</strong></p><ul><li>阶段一：表决阶段（投票阶段），所有参与者都将本事务执行预提交，并将能否成功的信息反馈发给协调者</li><li>阶段二：执行阶段（提交阶段），协调者根据所有参与者的反馈，通知所有参与者，步调一致地执行提交或者回滚</li></ul><p><img data-src="../../../asset/2020/12/distributed-transaction-dtp-1.png" alt="distributed-transaction-dtp-1"></p><hr><p><img data-src="../../../asset/2020/12/distributed-transaction-dtp-2.png" alt="distributed-transaction-dtp-2"></p><p><strong>优点：</strong></p><ul><li>提高了数据一致性的概率，实现成本较低</li></ul><p><strong>缺点：</strong></p><ul><li>单点问题：事务协调者宕机</li><li>同步阻塞：延迟了提交时间，加长了资源阻塞时间</li><li>数据不一致：在提交的第二阶段，依然存在 Commit 结果未知的情况，有可能导致数据不一致（即两阶段提交无法解决的问题）</li></ul><h3 id="两阶段提交（2PC）"><a href="#两阶段提交（2PC）" class="headerlink" title="两阶段提交（2PC）"></a>两阶段提交（2PC）</h3><p>分布式系统的一个难点是如何保证架构下多个节点在进行事务性操作的时候保持一致性。为实现这个目的，两阶段提交算法的成立基于以下假设：</p><ul><li>该分布式系统中，存在一个节点作为协调者（Coordinator），其他节点作为参与者（Cohorts），且节点之间可以进行网络通信</li><li>所有节点都采用预写式日志，且日志被写入后即被保持在可靠的存储设备上，即使节点损坏不会导致日志数据的消失</li><li>所有节点不会永久性损坏，即使损坏后仍然可以恢复</li></ul><p><strong>第一阶段（投票阶段）:</strong></p><ul><li>协调者节点向所有参与者节点询问是否可以执行提交操作（vote），并开始等待各参与者节点的响应</li><li>参与者节点执行询问发起为止的所有事务操作，并将 Undo 信息和 Redo 信息写入日志（注意：如果成功，这里其实每个参与者已经执行了事务操作）</li><li>各参与者节点响应协调者节点发起的询问，如果参与者节点的事务操作实际执行成功，则它返回一个” 同意” 消息；如果参与者节点的事务操作实际执行失败，则它返回一个” 中止” 消息</li></ul><p><strong>第二阶段（提交阶段）：</strong></p><p>当协调者节点从所有参与者节点获得的相应消息都为” 同意” 时：</p><ul><li>协调者节点向所有参与者节点发出” 正式提交（Commit）” 的请求</li><li>参与者节点正式完成操作，并释放在整个事务期间内占用的资源</li><li>参与者节点向协调者节点发送” 完成” 消息</li><li>协调者节点受到所有参与者节点反馈的” 完成” 消息后，完成事务</li></ul><p><strong>中断事务的发生：</strong></p><p>如果任一参与者节点在第一阶段返回的响应消息为” 中止”，或者协调者节点在第一阶段的询问超时之前无法获取所有参与者节点的响应消息时：</p><ul><li>协调者节点向所有参与者节点发出” 回滚操作（Rollback）” 的请求</li><li>参与者节点利用之前写入的 Undo 信息执行回滚，并释放在整个事务期间内占用的资源</li><li>参与者节点向协调者节点发送” 回滚完成” 消息</li><li>协调者节点受到所有参与者节点反馈的” 回滚完成” 消息后，取消事务</li><li><strong>特别注意：不管最后结果如何，第二阶段都会结束当前事务</strong></li></ul><p><strong>两阶段提交的缺点：</strong></p><ul><li>资源阻塞：执行过程中，所有参与节点都是事务阻塞型的。当参与者占有公共资源时，其他第三方节点访问公共资源不得不处于阻塞状态</li><li>参与者发生故障：协调者需要给每个参与者额外指定超时机制，超时后整个事务失败（没有多少容错机制）</li><li>协调者发生故障：参与者会一直阻塞下去，需要额外的备机进行容错（这个可以依赖 Paxos 协议实现 HA）</li><li><strong>两阶段提交无法解决的问题：</strong>协调者在发出 Commit 消息之后宕机，而唯一接收到这条消息的参与者同时也宕机了。那么即使协调者通过选举协议产生了新的协调者，这条事务的状态也是不确定的，没人知道事务是否已经被提交成功，这就有可能导致数据不一致</li></ul><div class="admonition note"><p class="admonition-title">两阶段提交（2PC）方案与 XA 方案的关系</p><ul><li>(1) 两阶段提交（2PC）方案和 XA 方案在实际意义上指的是同一个分布式事务解决方案。两阶段提交（2PC）是概念和算法名称，XA 是 2PC 的一个具体实现标准，由 X/Open 定义，用于协调多个数据库或资源管理器的事务。所以在技术文档中，会看到 2PC 和 XA，大多数情况下可以认为指的是同一类分布式事务方案，只是 XA 更强调标准化实现。</li><li>(2) <strong>在现代微服务架构中，每个服务通常只能操作自己独立的数据库，不允许跨服务直接访问其他服务的数据库，否则会破坏服务边界，导致系统治理困难、数据混乱且难以维护。如果需要获取其他服务的数据，必须通过调用其 API 接口，而不是跨数据库访问。由于 XA 的典型使用场景是单体应用或者单个服务需要同时操作多个数据库，这也是 XA 方案在微服务场景中几乎不被采用的主要原因</strong>。不过，只要数据库支持 XA（如 MySQL、Oracle），结合 Spring + JTA 就可以实现 2PC/XA 分布式事务解决方案。</li></ul></div><h3 id="三阶段提交（3PC）"><a href="#三阶段提交（3PC）" class="headerlink" title="三阶段提交（3PC）"></a>三阶段提交（3PC）</h3><p>与两阶段提交不同的是，三阶段提交有两个改动点：</p><ul><li>引入超时机制。同时在协调者和参与者中都引入超时机制</li><li>在第一阶段和第二阶段中插入一个准备阶段，保证了在最后提交阶段之前各参与节点的状态是一致的</li></ul><blockquote><p>也就是说，除了引入超时机制之外，3PC 把 2PC 的投票阶段再次一分为二，这样三阶段提交就有 CanCommit、PreCommit、DoCommit 三个阶段。</p></blockquote><p><strong>CanCommit 阶段：</strong></p><p>3PC 的 CanCommit 阶段其实和 2PC 的投票阶段很像，协调者向参与者发送 Commit 请求，参与者如果可以提交就返回 Yes 响应，否则返回 No 响应：</p><ul><li>事务询问：协调者向参与者发送 CanCommit 请求，询问是否可以执行事务提交操作，然后开始等待参与者的响应</li><li>响应反馈：参与者接到 CanCommit 请求之后，正常情况下，如果其自身认为可以顺利执行事务，则返回 Yes 响应，并进入预备状态，否则返回 No 响应</li></ul><p><strong>PreCommit 阶段：</strong></p><p>协调者根据参与者的响应情况来决定是否可以执行事务的 PreCommit 操作。根据响应情况，有以下两种可能：</p><ul><li><p>假如协调者从所有的参与者获得的反馈都是 Yes 响应，那么就会执行事务的预执行</p><ul><li>发送预提交请求：协调者向参与者发送 PreCommit 请求后，并进入 Prepared 阶段</li><li>事务预提交：参与者接收到 PreCommit 请求后，会执行事务操作，并将 Undo 和 Redo 信息记录到事务日志中</li><li>响应反馈：如果参与者成功的执行了事务操作，则返回 ACK 响应，同时开始等待最终指令</li></ul></li><li><p>假如有任何一个参与者向协调者发送了 No 响应，或者等待超时之后，协调者都没有接到参与者的响应，那么就执行事务的中断</p><ul><li>发送中断请求：协调者向所有参与者发送 Abort 请求</li><li>中断事务：参与者收到来自协调者的 Abort 请求之后（或超时之后，仍未收到协调者的请求），执行事务的中断</li></ul></li></ul><div class="admonition note"><p class="admonition-title">Undo 和 Redo 日志</p><ul><li>(1) Undo 和 Redo 日志是用于事务回滚和数据恢复的重要机制。</li><li>(2) Undo 日志：记录在事务操作前的数据状态，以便在需要回滚事务时，可以撤销已执行的操作，恢复到事务开始前的状态。举例来说，如果事务在某个步骤中修改了数据库表中的数据，Undo 日志就会在执行修改之前记录原始数据值。这样如果事务最终没有提交成功，系统可以通过这些日志信息将数据还原到修改前的状态。</li><li>(3) Redo 日志：记录事务操作后的数据状态，以便在事务失败需要恢复时重新应用这些操作。当事务最终准备提交时，Redo 日志会确保所有的更改都能被重复应用，以达到一致的提交效果。举例来说，如果事务已经提交，但系统在写入数据到持久性存储时发生了崩溃，那么通过 Redo 日志，就可以在系统恢复后重新执行已提交的操作，确保数据一致性。值得一提的是，Redo 是单词 <code>do again</code> 的含义，表示 <code>重做</code> 或者 <code>再次执行</code> 的意思。</li></ul></div><p><strong>DoCommit 阶段</strong></p><p>该阶段进行真正的事务提交，也可以分为以下两种情况：</p><ul><li><p>执行提交：</p><ul><li>发送提交请求：协调接收到参与者发送的 ACK 响应，那么它将从预提交状态进入到提交状态，并向所有参与者发送 DoCommit 请求</li><li>事务提交：参与者接收到 DoCommit 请求之后，执行正式的事务提交，并在完成事务提交之后释放所有事务资源</li><li>响应反馈：事务提交完之后，向协调者发送 ACK 响应</li><li>完成事务：协调者接收到所有参与者的 ACK 响应之后，完成事务</li></ul></li><li><p>中断事务</p><ul><li>发送中断请求：协调者向所有参与者发送 Abort 请求</li><li>事务回滚：参与者接收到 Abort 请求之后，利用其在阶段二记录的 Undo 信息来执行事务的回滚操作，并在完成回滚之后释放所有的事务资源</li><li>反馈结果：参与者完成事务回滚之后，向协调者发送 ACK 消息</li><li>中断事务：协调者接收到参与者反馈的 ACK 消息之后，执行事务的中断</li></ul></li></ul><p>这里协调者如果没有接收到参与者发送的 ACK 响应（可能是接受者发送的不是 ACK 响应，也可能响应超时），那么就会执行中断事务。</p><h3 id="TCC（两阶段型、补偿型）"><a href="#TCC（两阶段型、补偿型）" class="headerlink" title="TCC（两阶段型、补偿型）"></a>TCC（两阶段型、补偿型）</h3><p>TCC（Try Confirm Cancel）属于补偿型分布式事务（又被称为补偿事务），类似 2PC 的柔性分布式解决方案，属于 2PC 的改良版。TCC 实现分布式事务一共有三个步骤：</p><ul><li><p>Try（尝试待执行的业务）：这个过程并未执行业务，只是完成所有业务的一致性检查，并预留好执行所需的全部资源</p></li><li><p>Confirm（确认执行业务）：确认执行业务操作，不做任何业务检查，只使用 Try 阶段预留的业务资源。通常情况下，采用 TCC 则认为 Confirm 阶段是不会出错的。即只要 Try 成功，Confirm 就一定成功。若 Confirm 阶段真的出错了，需引入重试机制或人工处理</p></li><li><p>Cancel（取消待执行的业务）：取消 Try 阶段预留的业务资源。通常情况下，采用 TCC 则认为 Cancel 阶段也是一定成功的。若 Cancel 阶段真的出错了，需引入重试机制或人工处理</p></li></ul><p><img data-src="../../../asset/2020/12/tcc-transaction.png" alt="tcc-transaction"></p><p><strong>TCC 两阶段提交与 XA 两阶段提交的区别：</strong></p><ul><li>XA 是资源层面的分布式事务，强一致性，在两阶段提交的整个过程中，会一直持有资源的锁</li><li> TCC 是业务层面的分布式事务，最终一致性，不会一直持有资源的锁</li></ul><p><strong>TCC 事务的优缺点：</strong></p><ul><li>优点：把数据库层的两阶段提交上提到了应用层来实现，规避了数据库层的 2PC 性能低下的问题</li><li>缺点：TCC 的 Try、Confirm 和 Cancel 操作功能需业务提供，开发成本高</li></ul><h3 id="最大努力通知（定期校对）"><a href="#最大努力通知（定期校对）" class="headerlink" title="最大努力通知（定期校对）"></a>最大努力通知（定期校对）</h3><p>最大努力通知也被称为定期校对，其实是对第二种解决方案的进一步优化。它引入了本地消息表来记录错误消息，然后加入失败消息的定期校对功能，来进一步保证消息会被下游系统消费。</p><p><img data-src="../../../asset/2020/12/best-effort-notice.png" alt="best-effort-notice"></p><p><strong>第一步：消息由系统 A 投递到消息中间件</strong></p><ul><li>1）处理业务的同一事务中，向本地消息表中写入一条记录</li><li> 2）准备专门的消息发送者不断地发送本地消息表中的消息到消息中间件，如果发送失败则重试</li></ul><p><strong>第二步：消息由中间件投递到系统 B</strong></p><ul><li>1）消息中间件收到消息后负责将该消息同步投递给相应的下游系统，并触发下游系统的任务执行</li><li> 2）当下游系统处理成功后，向消息中间件反馈确认应答，消息中间件便可以将该条消息删除，从而该事务完成</li><li> 3）对于投递失败的消息，利用重试机制进行重试，对于重试失败的，写入错误消息表</li><li> 4）消息中间件需要提供失败消息的查询接口，下游系统会定期查询失败消息，并将其消费</li></ul><p><strong>优缺点：</strong></p><ul><li>优点： 一种非常经典的实现，实现了最终一致性</li><li>缺点： 消息表会耦合到业务系统中，如果没有封装好的解决方案，会有很多杂活需要处理，并且在业界并没有成熟的方案来解决</li></ul><h3 id="可靠消息最终一致性"><a href="#可靠消息最终一致性" class="headerlink" title="可靠消息最终一致性"></a>可靠消息最终一致性</h3><p>基于可靠消息实现最终一致性的方案是通过消息中间件（如 Kafka、RocketMQ）保证上、下游应用数据操作的最终一致性。假设有 A 和 B 两个系统，分别可以处理任务 A 和任务 B。此时存在一个业务流程，需要将任务 A 和任务 B 在同一个事务中处理，此时就可以使用消息中间件来实现这种分布式事务。</p><p><img data-src="../../../asset/2020/12/reliable-message-service.png" alt="reliable-message-service"></p><p><strong>第一步：消息由系统 A 投递到消息中间件</strong></p><ul><li>1）在系统 A 处理任务 A 前，首先向消息中间件发送一条消息</li><li> 2）消息中间件收到后将该条消息持久化，但并不投递。持久化成功后，向 A 回复一个确认应答</li><li> 3）系统 A 收到确认应答后，则可以开始处理任务 A</li><li>4）任务 A 处理完成后，向消息中间件发送 Commit 或者 Rollback 请求。该请求发送完成后，对系统 A 而言，该事务的处理过程就结束了</li><li> 5）如果消息中间件收到 Commit，则向 B 系统投递消息；如果收到 Rollback，则直接丢弃消息。但是如果消息中间件收不到 Commit 和 Rollback 指令，那么就要依靠” 超时询问机制”</li></ul><blockquote><p>超时询问机制</p></blockquote><p>系统 A 除了实现正常的业务流程外，还需提供一个事务询问的接口，供消息中间件调用。当消息中间件收到发布消息便开始计时，如果到了超时没收到确认指令，就会主动调用系统 A 提供的事务询问接口询问该系统目前的状态。该接口会返回三种结果，中间件根据三种结果做出不同反应：</p><ul><li>提交：将该消息投递给系统 B</li><li> 回滚：直接将消息丢弃</li><li>处理中：继续等待</li></ul><p><strong>第二步：消息由中间件投递到系统 B</strong></p><p>消息中间件向下游系统投递完消息后便进入阻塞等待状态，下游系统便立即进行任务的处理，任务处理完成后便向消息中间件返回应答。</p><ul><li>如果消息中间件收到确认应答后便认为该事务处理完毕</li><li>如果消息中间件在等待确认应答超时之后就会重新投递，直到下游消费者返回消费成功响应为止。一般消息中间件可以设置消息重试的次数和时间间隔，如果最终还是不能成功投递，则需要手工干预。这里之所以使用人工干预，而不是使用让 A 系统回滚，主要是考虑到整个系统设计的复杂度问题</li></ul><p>基于可靠消息服务的分布式事务，前半部分使用异步，注重性能；后半部分使用同步，注重开发成本。</p><h2 id="Seata-支持的四种事务模式"><a href="#Seata-支持的四种事务模式" class="headerlink" title="Seata 支持的四种事务模式"></a>Seata 支持的四种事务模式</h2><p>阿里巴巴的 Seata 支持四种事务模式：AT（自动提交）、XA（两阶段提交）、TCC（Try-Confirm-Cancel）、SAGA（补偿事务）。</p><div class="admonition note"><p class="admonition-title">扩展阅读</p><ul><li><a href="/posts/84d3f3e6.html#Seata-%E7%9A%84%E5%9B%9B%E5%A4%A7%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%BC%8F">Seata 的四大事务模式</a></li></ul></div><h3 id="AT（Automatic-Transaction-自动提交）"><a href="#AT（Automatic-Transaction-自动提交）" class="headerlink" title="AT（Automatic Transaction - 自动提交）"></a>AT（Automatic Transaction - 自动提交）</h3><ul><li>概述：<ul><li> 基于数据库的 Undo/Redo 日志机制实现分布式事务，应用层无需修改业务逻辑。</li><li> 在全局事务中，Seata 自动拦截 SQL，通过 Undo/Redo 回滚事务。</li></ul></li><li>优点：<ul><li> 无需改造业务代码，使用简单；</li><li> 性能相对较高，适合大部分分布式事务场景；</li><li> 自动处理事务回滚。</li></ul></li><li>缺点：<ul><li> 依赖数据库，跨库或复杂 SQL 场景可能受限；</li><li> 对 SQL 语句支持有限，不支持存储过程等复杂逻辑。</li></ul></li><li>适用场景：<ul><li> 微服务架构下的常规分布式事务；</li><li> 以数据库操作为主，SQL 简单，要求性能和一致性兼顾的业务。</li></ul></li></ul><h3 id="XA（Two-Phase-Commit-两阶段提交）"><a href="#XA（Two-Phase-Commit-两阶段提交）" class="headerlink" title="XA（Two-Phase Commit - 两阶段提交）"></a>XA（Two-Phase Commit - 两阶段提交）</h3><ul><li>概述：<ul><li> 通过事务管理器协调多个数据库，先询问各数据库是否准备好提交（Prepare 阶段），全部准备好则提交，否则回滚。</li><li> 严格保证全局一致性。</li></ul></li><li>优点：<ul><li> 强一致性保证；</li><li> 模型清晰，数据库支持良好。</li></ul></li><li>缺点：<ul><li> 性能低，锁资源时间长，容易阻塞；</li><li> 扩展性差，高并发场景不适用。</li></ul></li><li>适用场景：<ul><li> 单体应用或低并发分布式事务；</li><li> 强一致性要求高、性能要求低的后台管理系统或内部工具。</li></ul></li></ul><h3 id="TCC（Try-Confirm-Cancel）"><a href="#TCC（Try-Confirm-Cancel）" class="headerlink" title="TCC（Try-Confirm-Cancel）"></a>TCC（Try-Confirm-Cancel）</h3><ul><li>概述：<ul><li> 通过三个阶段实现事务一致性：Try（预留资源）→ Confirm（提交操作）→ Cancel（失败回滚）；</li><li> 业务层需实现补偿逻辑。</li></ul></li><li>优点：<ul><li> 可严格保证强一致性；</li><li> 适合资金类或核心业务场景。</li></ul></li><li>缺点：<ul><li> 业务代码复杂，需要手动编写补偿逻辑；</li><li> 开发和维护成本高。</li></ul></li><li>适用场景：<ul><li> 核心业务、资金交易、支付、订单扣减库存等对一致性要求极高的场景；</li><li> 各步骤执行时间短的场景。</li></ul></li></ul><h3 id="SAGA（补偿事务）"><a href="#SAGA（补偿事务）" class="headerlink" title="SAGA（补偿事务）"></a>SAGA（补偿事务）</h3><ul><li>概述：<ul><li> 将全局事务拆分成一系列局部事务，每个局部事务成功则继续，失败则执行补偿事务回滚前面已完成的事务。</li><li> 典型实现是通过异步消息或事件驱动完成。</li></ul></li><li>优点：<ul><li> 性能高，不锁资源；</li><li> 易扩展，适合高并发微服务系统。</li></ul></li><li>缺点：<ul><li> 一致性为最终一致性，不保证实时强一致性；</li><li> 需要实现补偿逻辑，增加开发复杂度。</li></ul></li><li>适用场景：<ul><li> 高并发、跨多个服务的微服务场景；</li><li> 可容忍短暂不一致，要求最终一致性的业务，如订单、物流、库存等。</li></ul></li></ul><h2 id="分布式事务问题"><a href="#分布式事务问题" class="headerlink" title="分布式事务问题"></a>分布式事务问题</h2><h3 id="避免滥用分布式事务"><a href="#避免滥用分布式事务" class="headerlink" title="避免滥用分布式事务"></a>避免滥用分布式事务</h3><blockquote><p>在微服务架构下，系统通常由几十甚至上百个服务组成。理论上，如果每个跨服务调用都要保证强一致性，就需要在系统中大量使用分布式事务。但实际经验表明，这种做法的成本极高。</p></blockquote><p>首先，任何一种分布式事务方案（比如 XA、TCC、可靠消息最终一致性等），都会显著增加系统复杂度：</p><ul><li>代码量与逻辑复杂度至少增加数倍甚至十倍；</li><li>开发周期明显延长；</li><li>系统性能与吞吐量显著下降；</li><li>架构更加脆弱，反而可能引入新的 Bug。</li></ul><p>在大型系统中，真正需要分布式事务的场景往往非常少。以团队实践为例，一个拥有几百个服务的大型系统中，分布式事务的使用场景可能只有寥寥几个。绝大多数跨服务调用，如果出现异常，通常只需做到：</p><ul><li>完整的异常日志记录；</li><li>实时告警与监控（邮件、短信等）；</li><li>事后快速排查与修复。</li></ul><p>从实际运行情况看，大多数问题是功能性或体验性缺陷，真正涉及数据不一致的 Bug，每月也就几例。对于这类问题，通常通过人工修复（编写临时脚本补偿数据、修复字段值等）即可，成本远低于大规模使用分布式事务。因此，在分布式事务的使用上，需要权衡：</p><ul><li>必须保证数据绝对正确的关键业务（约占 0.01% ～ 1% 的场景，如资金、交易、订单），才应该使用分布式事务方案来确保一致性。</li><li>对于非关键业务（如会员积分、优惠券、商品信息等），通常只需依赖监控与人工修复机制，而无需强制引入分布式事务。</li></ul><p>总结来说：分布式事务是保证强一致性的利器，但它的代价高昂，应该谨慎使用，只在最核心的业务场景落地。</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a target="_blank" rel="external nofollow" href="https://seata.apache.org/zh-cn/docs/user/mode/at">Seata 官方文档 - 各种事务模式</a></li></ul><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/726e9aff.html" title="分布式事务解决方案介绍">https://www.techgrow.cn/posts/726e9aff.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="fa fa-tag"></i> 微服务</a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag"><i class="fa fa-tag"></i> 数据库</a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag"><i class="fa fa-tag"></i> 分布式</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/63e3926c.html" rel="prev" title="Sentinel 入门教程 - 整合篇（2020 年）"><i class="fa fa-angle-left"></i> Sentinel 入门教程 - 整合篇（2020 年）</a></div><div class="post-nav-item"> <a href="/posts/e8b71fbe.html" rel="next" title="Seata 入门教程 - 基础篇（2020 年）">Seata 入门教程 - 基础篇（2020 年）<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">2m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">30:29</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/726e9aff.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>