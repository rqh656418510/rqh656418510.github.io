<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍在 Debian 11 搭建 Redis 高可用集群。"><meta property="og:type" content="article"><meta property="og:title" content="Debian 11 搭建 Redis 高可用集群"><meta property="og:url" content="https://www.techgrow.cn/posts/28d6b98a.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍在 Debian 11 搭建 Redis 高可用集群。"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2022-03-14T14:17:38.000Z"><meta property="article:modified_time" content="2022-03-14T14:17:38.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="Debian"><meta property="article:tag" content="缓存"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.techgrow.cn/posts/28d6b98a.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/28d6b98a.html","path":"posts/28d6b98a.html","title":"Debian 11 搭建 Redis 高可用集群"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Debian 11 搭建 Redis 高可用集群 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/app/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E8%AF%B4%E6%98%8E"><span class="nav-text">环境说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E8%A7%84%E5%88%92"><span class="nav-text">集群节点规划</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-%E9%9B%86%E7%BE%A4%E7%89%B9%E6%80%A7"><span class="nav-text">Redis 集群特性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-%E9%9B%86%E7%BE%A4%E7%9A%84%E4%BC%98%E7%82%B9"><span class="nav-text">Redis 集群的优点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-%E9%9B%86%E7%BE%A4%E7%9A%84%E7%BC%BA%E7%82%B9"><span class="nav-text">Redis 集群的缺点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="nav-text">Redis 集群搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">系统初始化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-Redis-%E7%94%A8%E6%88%B7"><span class="nav-text">创建 Redis 用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"><span class="nav-text">Redis 编译安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-%E6%90%AD%E5%BB%BA%E9%9B%86%E7%BE%A4"><span class="nav-text">Redis 搭建集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-%E9%9B%86%E7%BE%A4%E8%AE%BE%E7%BD%AE%E5%AF%86%E7%A0%81"><span class="nav-text">Redis 集群设置密码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-%E9%9B%86%E7%BE%A4%E6%9E%84%E5%BB%BA%E5%90%AF%E5%8A%A8"><span class="nav-text">Redis 集群构建启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95-Redis-%E9%9B%86%E7%BE%A4"><span class="nav-text">测试 Redis 集群</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-%E9%9B%86%E7%BE%A4%E9%87%8D%E5%BB%BA%EF%BC%88%E5%88%9D%E5%A7%8B%E5%8C%96%EF%BC%89"><span class="nav-text">Redis 集群重建（初始化）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E5%8D%9A%E5%AE%A2"><span class="nav-text">参考博客</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">615</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">52</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/28d6b98a.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Debian 11 搭建 Redis 高可用集群 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍在 Debian 11 搭建 Redis 高可用集群。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Debian 11 搭建 Redis 高可用集群</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-03-14 22:17:38" itemprop="dateCreated datePublished" datetime="2022-03-14T22:17:38+08:00">2022-03-14</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/28d6b98a.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/28d6b98a.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>2.5k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>2 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h3><table><thead><tr><th>软件</th><th>版本</th></tr></thead><tbody><tr><td> Debian</td><td>11</td></tr><tr><td>Redis</td><td>6.0.6</td></tr></tbody></table><span id="more"></span><h3 id="集群节点规划"><a href="#集群节点规划" class="headerlink" title="集群节点规划"></a>集群节点规划</h3><p>Redis 集群至少一共需要 6 个节点，包括 3 个 Master 节点和 3 个 Slave 节点，且每个 Master 节点对应 1 个 Slave 节点，对应的关系如下：</p><ul><li>1 Master –&gt; 1 Slave，Redis 集群需要 6 个节点，<a href="../../../asset/2021/03/redis-cluster-2.png">如图所示</a></li><li> 1 Master –&gt; 2 Slave，Redis 集群需要 9 个节点，以此类推，<a href="../../../asset/2021/03/redis-cluster-1.png">如图所示</a></li></ul><table><thead><tr><th>名称</th><th> IP</th><th> 端口</th></tr></thead><tbody><tr><td> Master</td><td>192.168.109</td><td>7001</td></tr><tr><td>Master</td><td>192.168.109</td><td>7002</td></tr><tr><td>Master</td><td>192.168.109</td><td>7003</td></tr><tr><td>Slave</td><td>192.168.109</td><td>7004</td></tr><tr><td>Slave</td><td>192.168.109</td><td>7005</td></tr><tr><td>Slave</td><td>192.168.109</td><td>7006</td></tr></tbody></table><h2 id="Redis-集群特性"><a href="#Redis-集群特性" class="headerlink" title="Redis 集群特性"></a>Redis 集群特性</h2><h3 id="Redis-集群的优点"><a href="#Redis-集群的优点" class="headerlink" title="Redis 集群的优点"></a>Redis 集群的优点</h3><p>无中心架构，分布式提供服务。数据按照 <code>slot</code> 存储分布在多个 Redis 实例上。增加 Slave 做 Standby 数据副本，用于 Failover，使集群快速恢复。实现故障 Auto Failover，节点之间通过 <code>gossip</code> 协议交换状态信息；投票机制完成 Slave 到 Master 角色的提升。支持在线增加或减少节点，降低硬件成本和运维成本，提高系统的扩展性和可用性。</p><h3 id="Redis-集群的缺点"><a href="#Redis-集群的缺点" class="headerlink" title="Redis 集群的缺点"></a>Redis 集群的缺点</h3><p>客户端实现复杂，驱动要求实现 Smart Client，缓存 Slots Mapping 信息并及时更新。目前仅 JedisCluster 相对成熟，异常处理部分还不完善。客户端的不成熟，影响应用的稳定性，提高开发难度。节点会因为某些原因发生阻塞（阻塞时间大于 clutser-node-timeout），被判断为下线。这种 Failover 是没有必要的，Sentinel 模式也存在这种切换场景。</p><h2 id="Redis-集群搭建"><a href="#Redis-集群搭建" class="headerlink" title="Redis 集群搭建"></a>Redis 集群搭建</h2><h3 id="系统初始化"><a href="#系统初始化" class="headerlink" title="系统初始化"></a>系统初始化</h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加配置一</span></span><br><span class="line"><span class="keyword"># echo</span> <span class="string">"net.core.somaxconn = 1024"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="keyword"># echo</span> <span class="string">"vm.overcommit_memory = 1"</span>  &gt;&gt; /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加配置二</span></span><br><span class="line"><span class="keyword"># echo</span> <span class="string">"echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled"</span> &gt;&gt; /etc/rc.<span class="built_in">local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启系统</span></span><br><span class="line"><span class="keyword"># reboot</span></span><br></pre></td></tr></tbody></table></figure><h3 id="创建-Redis-用户"><a href="#创建-Redis-用户" class="headerlink" title="创建 Redis 用户"></a>创建 Redis 用户</h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建redis用户组</span></span><br><span class="line"><span class="keyword"># groupadd</span> redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建redis用户（不允许远程登录）</span></span><br><span class="line"><span class="keyword"># useradd</span><span class="params"> -g</span> redis redis<span class="params"> -s</span> /bin/<span class="literal">false</span></span><br></pre></td></tr></tbody></table></figure><h3 id="Redis-编译安装"><a href="#Redis-编译安装" class="headerlink" title="Redis 编译安装"></a>Redis 编译安装</h3><p>Redis 各版本可以从<a target="_blank" rel="external nofollow" href="https://redis.io/download/">官网</a>下载，这里使用的版本是 <code>6.0.6</code>。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line"><span class="keyword"># apt</span>-get install<span class="params"> -y</span> build-essential tcl pkg-config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载文件</span></span><br><span class="line"><span class="keyword"># wget</span> http://download.redis.io/releases/redis-6.0.6.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压文件</span></span><br><span class="line"><span class="keyword"># tar</span><span class="params"> -xvf</span> redis-6.0.6.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入解压目录</span></span><br><span class="line"><span class="keyword"># cd</span> redis-6.0.6</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line"><span class="keyword"># make</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line"><span class="keyword"># make</span> install PREFIX=/usr/<span class="built_in">local</span>/redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建软连接（可选）</span></span><br><span class="line"><span class="keyword"># ln</span><span class="params"> -s</span> /usr/<span class="built_in">local</span>/redis/bin/redis-benchmark /usr/<span class="built_in">local</span>/bin/redis-benchmark</span><br><span class="line"><span class="keyword"># ln</span><span class="params"> -s</span> /usr/<span class="built_in">local</span>/redis/bin/redis-check-aof /usr/<span class="built_in">local</span>/bin/redis-check-aof</span><br><span class="line"><span class="keyword"># ln</span><span class="params"> -s</span> /usr/<span class="built_in">local</span>/redis/bin/redis-check-rdb /usr/<span class="built_in">local</span>/bin/redis-check-rdb</span><br><span class="line"><span class="keyword"># ln</span><span class="params"> -s</span> /usr/<span class="built_in">local</span>/redis/bin/redis-sentinel /usr/<span class="built_in">local</span>/bin/redis-sentinel</span><br><span class="line"><span class="keyword"># ln</span><span class="params"> -s</span> /usr/<span class="built_in">local</span>/redis/bin/redis-server /usr/<span class="built_in">local</span>/bin/redis-server</span><br><span class="line"><span class="keyword"># ln</span><span class="params"> -s</span> /usr/<span class="built_in">local</span>/redis/bin/redis-cli /usr/<span class="built_in">local</span>/bin/redis-cli</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝配置文件</span></span><br><span class="line"><span class="keyword"># cp</span> redis.conf /usr/<span class="built_in">local</span>/redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建日志目录</span></span><br><span class="line"><span class="keyword"># mkdir</span><span class="params"> -p</span> /var/<span class="built_in">log</span>/redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件授权</span></span><br><span class="line"><span class="keyword"># chown</span><span class="params"> -R</span> redis:redis /var/<span class="built_in">log</span>/redis</span><br><span class="line"><span class="keyword"># chown</span><span class="params"> -R</span> redis:redis /usr/<span class="built_in">local</span>/redis</span><br></pre></td></tr></tbody></table></figure><p>更改 Redis 的基础配置内容，其中有些配置文件的文件名都包含了端口号，这是为了后面方便使用不同的端口号来区分各个节点</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更改基础配置</span></span><br><span class="line"><span class="keyword"># vim</span> /usr/<span class="built_in">local</span>/redis/redis.conf</span><br><span class="line"></span><br><span class="line">io-threads 2</span><br><span class="line">daemonize yes</span><br><span class="line"><span class="keyword"># bind</span> 127.0.0.1</span><br><span class="line">protected-mode no</span><br><span class="line">masterauth 123456</span><br><span class="line">requirepass 123456</span><br><span class="line">dbfilename dump_6379.rdb</span><br><span class="line">pidfile /var/run/redis_6379.pid</span><br><span class="line">cluster-config-file nodes_6379.conf</span><br><span class="line">appendfilename <span class="string">"appendonly_6379.aof"</span></span><br><span class="line">logfile <span class="string">"/var/log/redis/redis_6379.log"</span></span><br></pre></td></tr></tbody></table></figure><p>验证 Redis 是否安装成功</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换Redis用户</span></span><br><span class="line"><span class="keyword"># su</span> redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入安装目录</span></span><br><span class="line"><span class="keyword">$ cd</span> /usr/<span class="built_in">local</span>/redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Redis</span></span><br><span class="line">$ ./bin/redis-server redis.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Redis的运行状态</span></span><br><span class="line"><span class="keyword">$ ps</span><span class="params"> -aux</span>|grep redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Redis的启动日志</span></span><br><span class="line"><span class="keyword">$ more</span> /var/<span class="built_in">log</span>/redis/redis_6379.<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭Redis</span></span><br><span class="line">$ ./bin/redis-cli</span><br><span class="line">127.0.0.1:6379&gt; auth 123456</span><br><span class="line">127.0.0.1:6379&gt; shutdown</span><br></pre></td></tr></tbody></table></figure><h3 id="Redis-搭建集群"><a href="#Redis-搭建集群" class="headerlink" title="Redis 搭建集群"></a>Redis 搭建集群</h3><p>创建 Redis 集群各节点的安装文件，并更改与端口相关的所有配置内容（例如：port、pidfile、dbfilename、logfile、cluster-config-file），同时开启对集群的支持</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建集群目录</span></span><br><span class="line"><span class="keyword"># mkdir</span><span class="params"> -p</span> /usr/<span class="built_in">local</span>/redis-cluster</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝各节点的安装文件</span></span><br><span class="line"><span class="keyword"># cp</span><span class="params"> -r</span> /usr/<span class="built_in">local</span>/redis /usr/<span class="built_in">local</span>/redis-cluster/redis-7001</span><br><span class="line"><span class="keyword"># cp</span><span class="params"> -r</span> /usr/<span class="built_in">local</span>/redis /usr/<span class="built_in">local</span>/redis-cluster/redis-7002</span><br><span class="line"><span class="keyword"># cp</span><span class="params"> -r</span> /usr/<span class="built_in">local</span>/redis /usr/<span class="built_in">local</span>/redis-cluster/redis-7003</span><br><span class="line"><span class="keyword"># cp</span><span class="params"> -r</span> /usr/<span class="built_in">local</span>/redis /usr/<span class="built_in">local</span>/redis-cluster/redis-7004</span><br><span class="line"><span class="keyword"># cp</span><span class="params"> -r</span> /usr/<span class="built_in">local</span>/redis /usr/<span class="built_in">local</span>/redis-cluster/redis-7005</span><br><span class="line"><span class="keyword"># cp</span><span class="params"> -r</span> /usr/<span class="built_in">local</span>/redis /usr/<span class="built_in">local</span>/redis-cluster/redis-7006</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更改各节点里与端口相关的所有配置项</span></span><br><span class="line"><span class="keyword"># sed</span><span class="params"> -i</span> <span class="string">"s/6379/7001/g"</span> /usr/<span class="built_in">local</span>/redis-cluster/redis-7001/redis.conf</span><br><span class="line"><span class="keyword"># sed</span><span class="params"> -i</span> <span class="string">"s/6379/7002/g"</span> /usr/<span class="built_in">local</span>/redis-cluster/redis-7002/redis.conf</span><br><span class="line"><span class="keyword"># sed</span><span class="params"> -i</span> <span class="string">"s/6379/7003/g"</span> /usr/<span class="built_in">local</span>/redis-cluster/redis-7003/redis.conf</span><br><span class="line"><span class="keyword"># sed</span><span class="params"> -i</span> <span class="string">"s/6379/7004/g"</span> /usr/<span class="built_in">local</span>/redis-cluster/redis-7004/redis.conf</span><br><span class="line"><span class="keyword"># sed</span><span class="params"> -i</span> <span class="string">"s/6379/7005/g"</span> /usr/<span class="built_in">local</span>/redis-cluster/redis-7005/redis.conf</span><br><span class="line"><span class="keyword"># sed</span><span class="params"> -i</span> <span class="string">"s/6379/7006/g"</span> /usr/<span class="built_in">local</span>/redis-cluster/redis-7006/redis.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启各节点对集群的支持</span></span><br><span class="line"><span class="keyword"># sed</span><span class="params"> -i</span> <span class="string">"s/# cluster-enabled/cluster-enabled/g"</span> `find /usr/<span class="built_in">local</span>/redis-cluster<span class="params"> -type</span> f<span class="params"> -name</span> <span class="string">"redis.conf"</span>`</span><br><span class="line"><span class="keyword"># sed</span><span class="params"> -i</span> <span class="string">"s/# cluster-config-file/cluster-config-file/g"</span> `find /usr/<span class="built_in">local</span>/redis-cluster<span class="params"> -type</span> f<span class="params"> -name</span> <span class="string">"redis.conf"</span>`</span><br><span class="line"><span class="keyword"># sed</span><span class="params"> -i</span> <span class="string">"s/# cluster-node-timeout/cluster-node-timeout/g"</span> `find /usr/<span class="built_in">local</span>/redis-cluster<span class="params"> -type</span> f<span class="params"> -name</span> <span class="string">"redis.conf"</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件授权</span></span><br><span class="line"><span class="keyword"># chown</span><span class="params"> -R</span> redis:redis /usr/<span class="built_in">local</span>/redis-cluster</span><br></pre></td></tr></tbody></table></figure><p>拷贝 Redis 的集群管理工具</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入Redis的解压目录</span></span><br><span class="line"><span class="keyword"># cd</span> redis-6.0.6</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝集群管理工具</span></span><br><span class="line"><span class="keyword"># cp</span> src/redis-trib.rb /usr/<span class="built_in">local</span>/redis-cluster</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件授权</span></span><br><span class="line"><span class="keyword"># chown</span><span class="params"> -R</span> redis:redis /usr/<span class="built_in">local</span>/redis-cluster/redis-trib.rb</span><br></pre></td></tr></tbody></table></figure><p>创建 Shell 脚本批量启动 Redis 集群的各个节点</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword"># vim</span> /usr/<span class="built_in">local</span>/redis-cluster/start-cluster.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">REDIS_CLUSTER_HOME=/usr/<span class="built_in">local</span>/redis-cluster</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$REDIS_CLUSTER_HOME</span></span><br><span class="line"><span class="built_in">cd</span> redis-7001</span><br><span class="line">./bin/redis-server redis.conf</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"><span class="built_in">cd</span> redis-7002</span><br><span class="line">./bin/redis-server redis.conf</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"><span class="built_in">cd</span> redis-7003</span><br><span class="line">./bin/redis-server redis.conf</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"><span class="built_in">cd</span> redis-7004</span><br><span class="line">./bin/redis-server redis.conf</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"><span class="built_in">cd</span> redis-7005</span><br><span class="line">./bin/redis-server redis.conf</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"><span class="built_in">cd</span> redis-7006</span><br><span class="line">./bin/redis-server redis.conf</span><br></pre></td></tr></tbody></table></figure><p>Shell 脚本授权执行</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 文件授权</span></span><br><span class="line"><span class="keyword"># chmod</span> +x /usr/<span class="built_in">local</span>/redis-cluster/start-cluster.sh</span><br><span class="line"><span class="keyword"># chown</span><span class="params"> -R</span> redis:redis /usr/<span class="built_in">local</span>/redis-cluster/start-cluster.sh</span><br></pre></td></tr></tbody></table></figure><h3 id="Redis-集群设置密码"><a href="#Redis-集群设置密码" class="headerlink" title="Redis 集群设置密码"></a>Redis 集群设置密码</h3><p>若需要对集群各节点设置密码，那么 <code>requirepass</code> 和 <code>masterauth</code> 都需要同时设置，且两者的密码必须一致，否则发生主从切换时，就会遇到授权问题。值得一提的是，在使用 <code>redis-trib.rb</code> 或者 <code>redis-cli</code> 构建集群的时候，两者设置密码的方式是不一样的，具体如下：</p><ul><li><code>redis-trib.rb</code>：如果是使用 <code>redis-trib.rb</code> 工具构建集群，集群构建完成前不要配置密码，集群构建完毕需要执行以下命令逐个节点机器设置密码，不需要重启节点</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$ redis</span>-cli<span class="params"> -c</span><span class="params"> -p</span> 7001</span><br><span class="line">config <span class="built_in">set</span> masterauth 123456</span><br><span class="line">config <span class="built_in">set</span> requirepass 123456</span><br><span class="line">config rewrite</span><br></pre></td></tr></tbody></table></figure><ul><li><code>redis-cli</code>：如果是使用 <code>redis-cli</code> 构建集群，首先需要在集群各节点的 <code>redis.conf</code> 中配置密码，包括 <code>requirepass</code> 和 <code>masterauth</code>，然后在构建集群的命令行里加入 <code>-a password</code> 参数，其中的 <code>password</code> 就是集群各节点的密码</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">masterauth 123456</span><br><span class="line">requirepass 123456</span><br></pre></td></tr></tbody></table></figure><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$ redis</span>-cli<span class="params"> -a</span> 123456<span class="params"> --cluster</span> create \</span><br><span class="line">192.168.109:7001 \</span><br><span class="line">192.168.109:7002 \</span><br><span class="line">192.168.109:7003 \</span><br><span class="line">192.168.109:7004 \</span><br><span class="line">192.168.109:7005 \</span><br><span class="line">192.168.109:7006 \<span class="params"></span></span><br><span class="line"><span class="params">--cluster</span>-replicas 1</span><br></pre></td></tr></tbody></table></figure><h3 id="Redis-集群构建启动"><a href="#Redis-集群构建启动" class="headerlink" title="Redis 集群构建启动"></a>Redis 集群构建启动</h3><p>首先执行 Shell 脚本批量启动所有 Redis 节点，切记不能以 Root 用户的身份启动 Redis，否则会造成系统重大安全隐患</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换到Redis用户</span></span><br><span class="line"><span class="keyword"># su</span> redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动集群节点</span></span><br><span class="line">$ ./usr/<span class="built_in">local</span>/redis-cluster/start-cluster.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看各节点的运行状态</span></span><br><span class="line"><span class="keyword">$ ps</span><span class="params"> -aux</span>|grep redis</span><br><span class="line">redis    32641  0.0  0.0 181880  7688 ?        Ssl  21:33   0:00 ./bin/redis-server *:7001 [cluster]</span><br><span class="line">redis    32649  0.0  0.0 181880  7688 ?        Ssl  21:33   0:00 ./bin/redis-server *:7002 [cluster]</span><br><span class="line">redis    32657  0.0  0.0 181880  7688 ?        Ssl  21:33   0:00 ./bin/redis-server *:7003 [cluster]</span><br><span class="line">redis    20814  0.0  0.0 181880  7688 ?        Ssl  21:33   0:00 ./bin/redis-server *:7004 [cluster]</span><br><span class="line">redis    20822  0.0  0.0 181880  7688 ?        Ssl  21:33   0:00 ./bin/redis-server *:7005 [cluster]</span><br><span class="line">redis    20830  0.0  0.0 181880  7688 ?        Ssl  21:33   0:00 ./bin/redis-server *:7006 [cluster]</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>使用 <code>redis-trib.rb</code> 工具构建集群时，在 6.0.6 里面会给打印提示，让你使用 <code>redis-cli</code> 命令来构建集群，并提供给你需要使用的命令，使其和 <code>redis-trib.rb</code> 达到一致的效果（这样就可以不用再单独的安装 Ruby），原本使用 <code>redis-trib.rb</code> 的语句如下</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ./redis-trib.rb create<span class="params"> --replicas</span> 1 \</span><br><span class="line">192.168.109:7001 \</span><br><span class="line">192.168.109:7002 \</span><br><span class="line">192.168.109:7003 \</span><br><span class="line">192.168.109:7004 \</span><br><span class="line">192.168.109:7005 \</span><br><span class="line">192.168.109:7006</span><br></pre></td></tr></tbody></table></figure><p>提供使用的 <code>redis-cli</code> 的语句如下，建议使用 <code>redis-cli</code> 命令来构建 Redis 集群，因为这样就不需要额外安装 Ruby</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$ redis</span>-cli<span class="params"> -a</span> 123456<span class="params"> --cluster</span> create \</span><br><span class="line">192.168.109:7001 \</span><br><span class="line">192.168.109:7002 \</span><br><span class="line">192.168.109:7003 \</span><br><span class="line">192.168.109:7004 \</span><br><span class="line">192.168.109:7005 \</span><br><span class="line">192.168.109:7006 \<span class="params"></span></span><br><span class="line"><span class="params">--cluster</span>-replicas 1</span><br></pre></td></tr></tbody></table></figure><p>可以看出两个语句都差不多，而且语句意思也差不多，<code>--cluster-replicas 1</code> 表示主备的比例关系为 1，即一个主节点对应一个备节点，前三个 <code>ip:port</code> 默认表示主节点，后面的依次为前三个主节点的备节点。在生产环境使用多台服务器搭建 Redis 集群时，为了保证高可用（在任意一台服务器挂了的情况下都不影响 Redis 集群的使用），主备节点不可以部署在同一台服务器上，因为主备节点在同一台服务器上，则备节点也没有太大的意义了，所以要错开对应。当主节点宕机后，备节点可以充当主节点继续工作，使 Redis 集群正常运行。</p><hr><p>执行完构建集群的命令后（只需执行一次），Redis 默认罗列出集群的对应关系来让你确定，输入 <code>yes</code> 完成集群创建即可</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Performing hash slots allocation on 6 nodes...</span><br><span class="line">Master[0] -&gt; Slots 0 - 5460</span><br><span class="line">Master[1] -&gt; Slots 5461 - 10922</span><br><span class="line">Master[2] -&gt; Slots 10923 - 16383</span><br><span class="line">Adding replica 192.168.1.109:7006 to 192.168.1.109:7001</span><br><span class="line">Adding replica 192.168.1.109:7003 to 192.168.1.109:7004</span><br><span class="line">Adding replica 192.168.1.109:7005 to 192.168.1.109:7002</span><br><span class="line">M: 225e37e5bb340467fb58b6f9d14cfb1893bf92d5 192.168.1.109:7001</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">M: 283abb498445ffd6206f24c451ac0b9fb7129383 192.168.1.109:7002</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">M: 7a1229732ada6ae8d8eb51ae7b7cac6242a6f8d4 192.168.1.109:7004</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">S: cde86683e2d314fd52cf8708f78935c6648ea3c6 192.168.1.109:7003</span><br><span class="line">   replicates 7a1229732ada6ae8d8eb51ae7b7cac6242a6f8d4</span><br><span class="line">S: 1f3f441d619ceeac55ae91015a3f46ede37352bb 192.168.1.109:7005</span><br><span class="line">   replicates 283abb498445ffd6206f24c451ac0b9fb7129383</span><br><span class="line">S: f8a5d94e9928ed615514f23ddaabd259134af709 192.168.1.109:7006</span><br><span class="line">   replicates 225e37e5bb340467fb58b6f9d14cfb1893bf92d5</span><br><span class="line">Can I set the above configuration? (type 'yes' to accept):</span><br><span class="line">&gt;&gt;&gt; Nodes configuration updated</span><br><span class="line">&gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span><br><span class="line">Waiting for the cluster to join</span><br><span class="line">.</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 192.168.1.109:7001)</span><br><span class="line">M: 225e37e5bb340467fb58b6f9d14cfb1893bf92d5 192.168.1.109:7001</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 7a1229732ada6ae8d8eb51ae7b7cac6242a6f8d4 192.168.1.109:7004</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: f8a5d94e9928ed615514f23ddaabd259134af709 192.168.1.109:7006</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 225e37e5bb340467fb58b6f9d14cfb1893bf92d5</span><br><span class="line">S: 1f3f441d619ceeac55ae91015a3f46ede37352bb 192.168.1.109:7005</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 283abb498445ffd6206f24c451ac0b9fb7129383</span><br><span class="line">M: 283abb498445ffd6206f24c451ac0b9fb7129383 192.168.1.109:7002</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: cde86683e2d314fd52cf8708f78935c6648ea3c6 192.168.1.109:7003</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 7a1229732ada6ae8d8eb51ae7b7cac6242a6f8d4</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></tbody></table></figure><h3 id="测试-Redis-集群"><a href="#测试-Redis-集群" class="headerlink" title="测试 Redis 集群"></a>测试 Redis 集群</h3><p>Redis 客户端登录进某个集群节点，登录时需要指定密码，下面可以看到数据放入的哈希槽为 <code>[12182]</code>，属于 <code>192.168.1.109:7002</code> 所管控的节点，所以就直接跳转到 <code>192.168.1.109:7002</code> 节点来获取刚才放入的数据</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$ redis</span>-cli<span class="params"> -c</span><span class="params"> -p</span> 7001<span class="params"> -a</span> 123456</span><br><span class="line"></span><br><span class="line">127.0.0.1:7001&gt; <span class="built_in">set</span> foo hello</span><br><span class="line"><span class="keyword">-&gt; Redirected</span> to slot [12182] located at 192.168.1.109:7002</span><br><span class="line">OK</span><br><span class="line">192.168.1.109:7002&gt; get foo</span><br><span class="line"><span class="string">"hello"</span></span><br><span class="line">192.168.1.109:7002&gt;</span><br></pre></td></tr></tbody></table></figure><p>查看 Redis 当前集群的信息</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$ redis</span>-cli<span class="params"> -c</span><span class="params"> -p</span> 7001<span class="params"> -a</span> 123456</span><br><span class="line"></span><br><span class="line">127.0.0.1:7001&gt; cluster info</span><br><span class="line">cluster_state:ok</span><br><span class="line">cluster_slots_assigned:16384</span><br><span class="line">cluster_slots_ok:16384</span><br><span class="line">cluster_slots_pfail:0</span><br><span class="line">cluster_slots_fail:0</span><br><span class="line">cluster_known_nodes:6</span><br><span class="line">cluster_size:3</span><br><span class="line">cluster_current_epoch:7</span><br><span class="line">cluster_my_epoch:1</span><br><span class="line">cluster_stats_messages_ping_sent:3154</span><br><span class="line">cluster_stats_messages_pong_sent:3377</span><br><span class="line">cluster_stats_messages_fail_sent:4</span><br><span class="line">cluster_stats_messages_auth-ack_sent:1</span><br><span class="line">cluster_stats_messages_sent:6536</span><br><span class="line">cluster_stats_messages_ping_received:3372</span><br><span class="line">cluster_stats_messages_pong_received:3154</span><br><span class="line">cluster_stats_messages_meet_received:5</span><br><span class="line">cluster_stats_messages_auth-req_received:1</span><br><span class="line">cluster_stats_messages_received:6532</span><br></pre></td></tr></tbody></table></figure><p>查看 Redis 特定节点的状态</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$ redis</span>-cli<span class="params"> --cluster</span> check 192.168.1.109:7003<span class="params"> -a</span> 123456</span><br><span class="line"></span><br><span class="line">Warning: Using a password with <span class="string">'-a'</span> or <span class="string">'-u'</span> option on the <span class="built_in">command</span> line interface may not be safe.</span><br><span class="line">192.168.1.109:7003 (cde86683...) -&gt; 0 keys | 5462 slots | 1 slaves.</span><br><span class="line">192.168.1.109:7002 (283abb49...) -&gt; 1 keys | 5461 slots | 1 slaves.</span><br><span class="line">192.168.1.109:7001 (225e37e5...) -&gt; 0 keys | 5461 slots | 1 slaves.</span><br><span class="line">[OK] 1 keys <span class="keyword">in</span> 3 masters.</span><br><span class="line">0.00 keys per slot on average.</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 192.168.1.109:7003)</span><br><span class="line">M: cde86683e2d314fd52cf8708f78935c6648ea3c6 192.168.1.109:7003</span><br><span class="line">  slots:[5461-10922] (5462 slots) master</span><br><span class="line">  1 additional replica(s)</span><br><span class="line">S: 1f3f441d619ceeac55ae91015a3f46ede37352bb 192.168.1.109:7005</span><br><span class="line">  slots: (0 slots) slave</span><br><span class="line">  replicates 283abb498445ffd6206f24c451ac0b9fb7129383</span><br><span class="line">S: 7a1229732ada6ae8d8eb51ae7b7cac6242a6f8d4 192.168.1.109:7004</span><br><span class="line">  slots: (0 slots) slave</span><br><span class="line">  replicates cde86683e2d314fd52cf8708f78935c6648ea3c6</span><br><span class="line">M: 283abb498445ffd6206f24c451ac0b9fb7129383 192.168.1.109:7002</span><br><span class="line">  slots:[10923-16383] (5461 slots) master</span><br><span class="line">  1 additional replica(s)</span><br><span class="line">S: f8a5d94e9928ed615514f23ddaabd259134af709 192.168.1.109:7006</span><br><span class="line">  slots: (0 slots) slave</span><br><span class="line">  replicates 225e37e5bb340467fb58b6f9d14cfb1893bf92d5</span><br><span class="line">M: 225e37e5bb340467fb58b6f9d14cfb1893bf92d5 192.168.1.109:7001</span><br><span class="line">  slots:[0-5460] (5461 slots) master</span><br><span class="line">  1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></tbody></table></figure><p>查看 Redis 所有集群节点的信息</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$ redis</span>-cli<span class="params"> -c</span><span class="params"> -p</span> 7001<span class="params"> -a</span> 123456</span><br><span class="line"></span><br><span class="line">127.0.0.1:7001&gt; cluster nodes</span><br><span class="line">7a1229732ada6ae8d8eb51ae7b7cac6242a6f8d4 192.168.1.109:7004@17004 master - 0 1616460018217 3 connected 5461-10922</span><br><span class="line">225e37e5bb340467fb58b6f9d14cfb1893bf92d5 192.168.1.109:7001@17001 myself,master - 0 1616460015000 1 connected 0-5460</span><br><span class="line">f8a5d94e9928ed615514f23ddaabd259134af709 192.168.1.109:7006@17006 slave 225e37e5bb340467fb58b6f9d14cfb1893bf92d5 0 1616460018000 1 connected</span><br><span class="line">1f3f441d619ceeac55ae91015a3f46ede37352bb 192.168.1.109:7005@17005 slave 283abb498445ffd6206f24c451ac0b9fb7129383 0 1616460016000 2 connected</span><br><span class="line">283abb498445ffd6206f24c451ac0b9fb7129383 192.168.1.109:7002@17002 master - 0 1616460016000 2 connected 10923-16383</span><br><span class="line">cde86683e2d314fd52cf8708f78935c6648ea3c6 192.168.1.109:7003@17003 slave 7a1229732ada6ae8d8eb51ae7b7cac6242a6f8d4 0 1616460017000 3 connected</span><br></pre></td></tr></tbody></table></figure><p>验证主从切换，从上面的集群信息可以观察到 <code>192.168.1.109:7003</code> 节点是 <code>192.168.1.109:7004</code> 的 Slave 节点，因此可以 Kill 掉 <code>192.168.1.109:7004</code> Master 节点的进程，然后观察 <code>192.168.1.109:7003</code> 节点会不会选举为新的 Master 节点，若可以则说明主从切换成功，此时 <code>192.168.1.109:7003</code> 节点的日志信息如下：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">11970:S 21 Jul 2020 22:48:40.080 * Connecting to MASTER 192.168.1.109:7004</span><br><span class="line">11970:S 21 Jul 2020 22:48:40.080 * MASTER &lt;-&gt; REPLICA sync started</span><br><span class="line">11970:S 21 Jul 2020 22:48:40.081 # Error condition on socket for SYNC: Operation now in progress</span><br><span class="line">11970:S 21 Jul 2020 22:48:40.982 # Starting a failover election for epoch 7.</span><br><span class="line">11970:S 21 Jul 2020 22:48:40.985 # Failover election won: I'm the new master.</span><br><span class="line">11970:S 21 Jul 2020 22:48:40.985 # configEpoch set to 7 after successful failover</span><br><span class="line">11970:M 21 Jul 2020 22:48:40.985 * Discarding previously cached master state.</span><br><span class="line">11970:M 21 Jul 2020 22:48:40.985 # Setting secondary replication ID to 00c7b21f3980b471d3373792d9d61bedf7e424e6, valid up to offset: 2059. New replication ID is c9f299ab0a8124a56d76e0e8a458135893b45336</span><br><span class="line">11970:M 21 Jul 2020 22:48:40.985 # Cluster state changed: ok</span><br></pre></td></tr></tbody></table></figure><p>最后重新启动 <code>192.168.1.109:7004</code> 节点，可以发现它会变为 <code>192.168.1.109:7003</code> 节点的 Slave 节点</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">7a1229732ada6ae8d8eb51ae7b7cac6242a6f8d4 192.168.1.109:7004@17004 slave cde86683e2d314fd52cf8708f78935c6648ea3c6 0 1616461490000 7 connected</span><br><span class="line">225e37e5bb340467fb58b6f9d14cfb1893bf92d5 192.168.1.109:7001@17001 myself,master - 0 1616461492000 1 connected 0-5460</span><br><span class="line">f8a5d94e9928ed615514f23ddaabd259134af709 192.168.1.109:7006@17006 slave 225e37e5bb340467fb58b6f9d14cfb1893bf92d5 0 1616461492000 1 connected</span><br><span class="line">1f3f441d619ceeac55ae91015a3f46ede37352bb 192.168.1.109:7005@17005 slave 283abb498445ffd6206f24c451ac0b9fb7129383 0 1616461492010 2 connected</span><br><span class="line">283abb498445ffd6206f24c451ac0b9fb7129383 192.168.1.109:7002@17002 master - 0 1616461491000 2 connected 10923-16383</span><br><span class="line">cde86683e2d314fd52cf8708f78935c6648ea3c6 192.168.1.109:7003@17003 master - 0 1616461493010 7 connected 5461-10922</span><br></pre></td></tr></tbody></table></figure><h2 id="Redis-集群重建（初始化）"><a href="#Redis-集群重建（初始化）" class="headerlink" title="Redis 集群重建（初始化）"></a>Redis 集群重建（初始化）</h2><p>若 Redis 集群出现无法正常使用的问题，可以尝试执行以下操作来重建 Redis 集群来解决，<strong>下述操作会删除 Redis 的所有 RDB 快照数据，切记先备份好数据再进行操作。</strong></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭所有节点服务器上的Redis</span></span><br><span class="line"><span class="keyword">$ pkill</span><span class="params"> -9</span> redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在所有节点服务器上执行以下命令（切记先备份好Redis的快照数据）</span></span><br><span class="line"><span class="keyword">$ find</span> /usr/<span class="built_in">local</span>/redis-cluster<span class="params"> -type</span> f<span class="params"> -iname</span> <span class="string">"dump*.rdb"</span> | xargs rm<span class="params"> -rf</span></span><br><span class="line"><span class="keyword">$ find</span> /usr/<span class="built_in">local</span>/redis-cluster<span class="params"> -type</span> f<span class="params"> -iname</span> <span class="string">"nodes_*.conf"</span> | xargs rm<span class="params"> -rf</span></span><br><span class="line"><span class="keyword">$ rm</span><span class="params"> -rf</span> /var/<span class="built_in">log</span>/redis/*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动所有节点服务器上的Redis</span></span><br><span class="line">$ ./usr/<span class="built_in">local</span>/redis-cluster/start-cluster.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行集群构建操作</span></span><br><span class="line"><span class="keyword">$ redis</span>-cli<span class="params"> -a</span> 123456<span class="params"> --cluster</span> create \</span><br><span class="line">192.168.109:7001 \</span><br><span class="line">192.168.109:7002 \</span><br><span class="line">192.168.109:7003 \</span><br><span class="line">192.168.109:7004 \</span><br><span class="line">192.168.109:7005 \</span><br><span class="line">192.168.109:7006 \<span class="params"></span></span><br><span class="line"><span class="params">--cluster</span>-replicas 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询集群信息和状态</span></span><br><span class="line"><span class="keyword">$ redis</span>-cli<span class="params"> -c</span><span class="params"> -p</span> 7001<span class="params"> -a</span> 123456</span><br><span class="line">127.0.0.1:7001&gt; cluster info</span><br><span class="line">127.0.0.1:7001&gt; cluster nodes</span><br></pre></td></tr></tbody></table></figure><h2 id="参考博客"><a href="#参考博客" class="headerlink" title="参考博客"></a>参考博客</h2><ul><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/qq_35937724/article/details/106906244">Redis 6 高可用集群搭建</a></li><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/liuzhang6966/article/details/91557986">Redis 两台服务器组集群</a></li></ul><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/28d6b98a.html" title="Debian 11 搭建 Redis 高可用集群">https://www.techgrow.cn/posts/28d6b98a.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/Debian/" rel="tag"><i class="fa fa-tag"></i> Debian</a><a href="/tags/%E7%BC%93%E5%AD%98/" rel="tag"><i class="fa fa-tag"></i> 缓存</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/3a3d508.html" rel="prev" title="Spring 与 SpringBoot 配置跨域的几种方式"><i class="fa fa-angle-left"></i> Spring 与 SpringBoot 配置跨域的几种方式</a></div><div class="post-nav-item"> <a href="/posts/6c257231.html" rel="next" title="IDEA 开发随笔">IDEA 开发随笔<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">1.5m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">22:58</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤 ICP 备 19024664 号</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035 号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"/lib/mermaid/dist/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/app/api/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/app/api/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/28d6b98a.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>