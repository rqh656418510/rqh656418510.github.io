<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍如何基于 C++ 开发集群聊天服务器，使用了 Muduo、Json、MySQL、Redis、Linux 等技术。"><meta property="og:type" content="article"><meta property="og:title" content="基于 C++ 开发集群聊天服务器"><meta property="og:url" content="https://www.techgrow.cn/posts/e635f0aa.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍如何基于 C++ 开发集群聊天服务器，使用了 Muduo、Json、MySQL、Redis、Linux 等技术。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/06/cluster-chat-loadbalance-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/05/cxx-cluster-chat-server-1.png"><meta property="article:published_time" content="2025-05-29T13:55:33.000Z"><meta property="article:modified_time" content="2025-06-04T13:55:33.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="Linux系统编程"><meta property="article:tag" content="C++"><meta property="article:tag" content="网络编程"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2025/06/cluster-chat-loadbalance-1.png"><link rel="canonical" href="https://www.techgrow.cn/posts/e635f0aa.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/e635f0aa.html","path":"posts/e635f0aa.html","title":"基于 C++ 开发集群聊天服务器"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>基于 C++ 开发集群聊天服务器 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"><span class="nav-text">开发环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%8F%91%E4%BE%9D%E8%B5%96"><span class="nav-text">开发依赖</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-text">准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-GCC"><span class="nav-text">安装 GCC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-CMake"><span class="nav-text">安装 CMake</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-Redis"><span class="nav-text">安装 Redis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-Nginx"><span class="nav-text">安装 Nginx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-MySQL"><span class="nav-text">安装 MySQL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-Boost-%E5%BA%93"><span class="nav-text">安装 Boost 库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-Muduo-%E5%BA%93"><span class="nav-text">安装 Muduo 库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-Hiredis-%E5%BA%93"><span class="nav-text">安装 Hiredis 库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D"><span class="nav-text">项目介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84"><span class="nav-text">项目架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E6%8A%80%E6%9C%AF%E6%A0%88"><span class="nav-text">项目技术栈</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E9%9C%80%E6%B1%82%E4%B8%8E%E7%9B%AE%E6%A0%87"><span class="nav-text">项目需求与目标</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91"><span class="nav-text">项目开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%85%8D%E7%BD%AE"><span class="nav-text">Nginx 负载均衡配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-%E5%8F%91%E5%B8%83-%E8%AE%A2%E9%98%85%E4%BD%BF%E7%94%A8"><span class="nav-text">Redis 发布 - 订阅使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">MySQL 数据库初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1"><span class="nav-text">数据库设计</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">数据库初始化</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91"><span class="nav-text">集群聊天服务器开发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-text">项目结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E4%BB%A3%E7%A0%81"><span class="nav-text">项目代码</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%AC%E5%85%B1%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81"><span class="nav-text">公共核心代码</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81"><span class="nav-text">服务端核心代码</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Redis-%E6%93%8D%E4%BD%9C%E4%BB%A3%E7%A0%81"><span class="nav-text">Redis 操作代码</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#MySQL-%E6%93%8D%E4%BD%9C%E4%BB%A3%E7%A0%81"><span class="nav-text">MySQL 操作代码</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="nav-text">聊天服务端代码</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81"><span class="nav-text">客户端核心代码</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%81%8A%E5%A4%A9%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="nav-text">聊天客户端代码</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E6%B5%8B%E8%AF%95"><span class="nav-text">项目测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E8%BE%93%E5%87%BA"><span class="nav-text">项目输出</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BE%93%E5%87%BA%E6%B1%82%E8%81%8C%E7%AE%80%E5%8E%86"><span class="nav-text">输出求职简历</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="nav-text">常见的面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8-Redis"><span class="nav-text">为什么要使用 Redis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Redis-%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%8A%9F%E8%83%BD%E4%B8%8D%E7%A8%B3%E5%AE%9A"><span class="nav-text">Redis 实现的功能不稳定</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E9%9D%A0%E4%BC%A0%E8%BE%93"><span class="nav-text">如何保证消息的可靠传输</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7"><span class="nav-text">如何保证数据传输的安全性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B6%88%E6%81%AF%E5%A6%82%E4%BD%95%E6%8C%89%E9%A1%BA%E5%BA%8F%E6%98%BE%E7%A4%BA"><span class="nav-text">客户端消息如何按顺序显示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%86%E5%8F%B2%E8%81%8A%E5%A4%A9%E6%B6%88%E6%81%AF%E5%BA%94%E8%AF%A5%E5%A6%82%E4%BD%95%E5%AD%98%E5%82%A8"><span class="nav-text">历史聊天消息应该如何存储</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E6%84%9F%E7%9F%A5%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%9C%A8%E7%BA%BF%E8%BF%98%E6%98%AF%E6%8E%89%E7%BA%BF"><span class="nav-text">如何感知客户端在线还是掉线</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">775</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">54</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/e635f0aa.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="基于 C++ 开发集群聊天服务器 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍如何基于 C++ 开发集群聊天服务器，使用了 Muduo、Json、MySQL、Redis、Linux 等技术。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 基于 C++ 开发集群聊天服务器</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2025-05-29 21:55:33" itemprop="dateCreated datePublished" datetime="2025-05-29T21:55:33+08:00">2025-05-29</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2025-06-04 21:55:33" itemprop="dateModified" datetime="2025-06-04T21:55:33+08:00">2025-06-04</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/e635f0aa.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/e635f0aa.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>7.6k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>7 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/def1afc3.html">C++ 网络编程 Muduo 库使用</a></li><li><a href="/posts/e635f0aa.html">基于 C++ 开发集群聊天服务器</a></li><li><a href="/posts/5e6aa28a.html">C++ 实现 RPC 分布式网络通信框架</a></li><li><a href="/posts/dbb10768.html">基于 C++ 手写 Muduo 高性能网络库</a></li></ul><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文将基于 C++ 11 实现集群聊天服务器，使用了 Json 库和 Muduo 网络库，并引入了 Redis、MySQL、Nginx 中间件。</p><span id="more"></span><h3 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h3><p>使用 C++ 开发 Linux 应用程序时，常见的开发环境有以下几种：</p><ul><li>(1) <a target="_blank" rel="external nofollow" href="https://blog.csdn.net/icacxygh001/article/details/120981354">Linux 环境下直接使用 VSCode、Clion 等跨平台 IDE 进行本地 C/C++ 开发</a></li><li> (2) <a target="_blank" rel="external nofollow" href="https://developer.aliyun.com/article/1477755">Windows + VSCode + MinGW 搭建本地 C/C++ 开发环境</a></li><li> (3) <a target="_blank" rel="external nofollow" href="https://blog.csdn.net/QIANGWEIYUAN/article/details/89469717">Windows + Visual Studio 搭建远程 Linux 开发环境</a></li><li> (4) <a href="/posts/630b5e44.html">Windows + VSCode 搭建远程 Linux 开发环境</a></li></ul><div class="admonition note"><p class="admonition-title">提示</p><p>上面介绍的三种开发环境，任意选择一种自己熟悉的就可以；如果日常使用的是 Windows 系统，建议选择第四种开发环境（VSCode 远程开发 C/C++）；如果习惯使用 Linux 系统，强烈建议选择第一种开发环境（Linux 本地开发 C/C++）。</p></div><h3 id="开发依赖"><a href="#开发依赖" class="headerlink" title="开发依赖"></a>开发依赖</h3><table><thead><tr><th>软件</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td> C++ 标准</td><td><code>11</code></td><td></td></tr><tr><td>Boost</td><td><code>1.74.0.3</code></td><td>Muduo 库依赖 Boost 库</td></tr><tr><td> Muduo</td><td><code>2.0.3</code></td><td><a target="_blank" rel="external nofollow" href="https://github.com/chenshuo/muduo">Muduo 库</a>，基于 C++ 开发，用于网络编程</td></tr><tr><td> hiredis</td><td><code>1.3.0</code></td><td><a target="_blank" rel="external nofollow" href="https://github.com/redis/hiredis">Reids 库</a> ，基于 C 语言开发，用于操作 Redis</td></tr><tr><td>nlohmann/json</td><td><code>3.12.0</code></td><td><a target="_blank" rel="external nofollow" href="https://github.com/nlohmann/json">Json 库</a>，基于 C++ 开发，用于 Json 序列化和反序列化</td></tr><tr><td> MySQL C API（Connector/C）</td><td><code>8.4.5</code></td><td>用于读写 MySQL 数据库，基于 C 语言开发</td></tr><tr><td> Redis</td><td><code>7.0.15</code></td><td>Redis 服务器</td></tr><tr><td> MySQL</td><td><code>8.4.5</code></td><td>MySQL 服务器</td></tr><tr><td> Nginx</td><td><code>1.28.0</code></td><td>Nginx 服务器</td></tr><tr><td> G++（GCC）</td><td><code>12.2.0</code></td><td>建议使用 <code>5.5</code>、<code>7.5</code> 版本的 G++（GCC） 编译器</td></tr><tr><td> CMake</td><td><code>3.25.1</code></td><td>C/C++ 项目构建工具</td></tr><tr><td> Linux</td><td><code>Debian 12</code></td><td>Muduo 库不支持 Windows 平台</td></tr><tr><td> Visual Studio Code</td><td><code>1.100.2</code></td><td>使用 VSCode 远程开发特性</td></tr></tbody></table><div class="admonition warning"><p class="admonition-title">平台兼容性说明</p><p>由于使用了 Muduo 库，且 Muduo 库仅支持 Linux 平台；因此本文提供的所有 C++ 集群聊天服务器代码支持在 Linux 平台运行，不支持 Windows 平台，默认是基于 Debian 12 进行远程开发。</p></div><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ul><li>安装常用的工具</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装开发工具</span></span><br><span class="line">sudo apt-get install -y vim git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装网络工具</span></span><br><span class="line">sudo apt-get install -y wget curl telnet netcat-openbsd socat tcpdump hping3</span><br></pre></td></tr></tbody></table></figure><h3 id="安装-GCC"><a href="#安装-GCC" class="headerlink" title="安装 GCC"></a>安装 GCC</h3><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 GCC、G++、GDB</span></span><br><span class="line">sudo apt-get install -y build-essential gdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 GCC 版本</span></span><br><span class="line">gcc --version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 G++ 版本</span></span><br><span class="line">g++ --version</span><br></pre></td></tr></tbody></table></figure><h3 id="安装-CMake"><a href="#安装-CMake" class="headerlink" title="安装 CMake"></a>安装 CMake</h3><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 CMake</span></span><br><span class="line">sudo apt-get -y install cmake</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 CMake 版本</span></span><br><span class="line">cmake -version</span><br></pre></td></tr></tbody></table></figure><h3 id="安装-Redis"><a href="#安装-Redis" class="headerlink" title="安装 Redis"></a>安装 Redis</h3><ul><li>安装 Redis</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 Redis</span></span><br><span class="line">sudo apt-get install -y redis-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机自启动 Redis</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> redis-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Redis 的运行状态</span></span><br><span class="line">sudo systemctl status redis-server</span><br></pre></td></tr></tbody></table></figure><ul><li>验证安装</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 Redis 版本</span></span><br><span class="line">redis-server --version</span><br><span class="line"></span><br><span class="line"><span class="comment"># Redis 客户端执行 Ping 操作</span></span><br><span class="line">redis-cli ping</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当 Redis 服务器响应以下内容，则说明 Redis 服务器正常运行</span></span><br><span class="line">PONG</span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">Redis 默认配置文件的路径</p><p>通过 APT 安装 Redis 服务器后，其主配置文件的路径为 <code>/etc/redis/redis.conf</code>。</p></div><h3 id="安装-Nginx"><a href="#安装-Nginx" class="headerlink" title="安装 Nginx"></a>安装 Nginx</h3><ul><li>安装依赖包</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装依赖软件（比如 pcre、zlib、ssl）</span></span><br><span class="line">sudo apt install -y build-essential libpcre3 libpcre3-dev zlib1g zlib1g-dev libssl-dev</span><br></pre></td></tr></tbody></table></figure><ul><li>编译安装 Nginx</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载源码</span></span><br><span class="line">wget https://nginx.org/download/nginx-1.28.0.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压源码</span></span><br><span class="line">tar -xvf nginx-1.28.0.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入源码目录</span></span><br><span class="line"><span class="built_in">cd</span> nginx-1.28.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成构建文件</span></span><br><span class="line">./configure --with-stream --with-http_ssl_module</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译源码</span></span><br><span class="line">make -j$(nproc)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行安装</span></span><br><span class="line">sudo make install</span><br></pre></td></tr></tbody></table></figure><ul><li>Nginx 安装说明</li></ul><table><thead><tr><th>安装说明</th><th>路径</th></tr></thead><tbody><tr><td> Nginx 默认安装路径</td><td><code>/usr/local/nginx</code></td></tr><tr><td>Nginx 主配置文件路径</td><td><code>/usr/local/nginx/conf/nginx.conf</code></td></tr><tr><td>Nginx 二进制可执行文件路径</td><td><code>/usr/local/nginx/sbin/nginx</code></td></tr></tbody></table><ul><li>Nginx 管理命令</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动 Nginx</span></span><br><span class="line">sudo /usr/<span class="built_in">local</span>/nginx/sbin/nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 优雅关闭 Nginx</span></span><br><span class="line">sudo /usr/<span class="built_in">local</span>/nginx/sbin/nginx -s quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 立刻关闭 Nginx</span></span><br><span class="line">sudo /usr/<span class="built_in">local</span>/nginx/sbin/nginx -s stop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 Nginx 配置文件</span></span><br><span class="line">sudo /usr/<span class="built_in">local</span>/nginx/sbin/nginx -t</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重载 Nginx 配置文件</span></span><br><span class="line">sudo /usr/<span class="built_in">local</span>/nginx/sbin/nginx -s reload</span><br></pre></td></tr></tbody></table></figure><ul><li>添加 Systemd 服务（实现 Nginx 服务自启动）</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 Systemd 服务配置文件，添加以下配置内容</span></span><br><span class="line">sudo vi /etc/systemd/system/nginx.service</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=The NGINX HTTP and reverse proxy server</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/nginx/sbin/nginx</span><br><span class="line">ExecReload=/usr/<span class="built_in">local</span>/nginx/sbin/nginx -s reload</span><br><span class="line">ExecStop=/usr/<span class="built_in">local</span>/nginx/sbin/nginx -s quit</span><br><span class="line">PIDFile=/usr/<span class="built_in">local</span>/nginx/logs/nginx.pid</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重载系统配置文件</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机自启动 Nginx 服务</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> nginx</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动 Nginx 服务</span></span><br><span class="line">sudo systemctl start nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Nginx 服务的运行状态</span></span><br><span class="line">sudo systemctl status nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 优雅关闭 Nginx 服务</span></span><br><span class="line">sudo systemctl stop nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重载 Nginx 服务的配置文件</span></span><br><span class="line">sudo systemctl reload nginx</span><br></pre></td></tr></tbody></table></figure><div class="admonition warning"><p class="admonition-title">特别注意</p><p>在 Nginx <code>1.9.0</code> 版本之前，Nginx 仅支持基于 HTTP 协议 的 Web 服务器负载均衡，无法处理 TCP 层的流量转发。自 Nginx <code>1.9.0</code> 版本开始，官方引入了名为 <code>stream</code> 的新模块，使 Nginx 能够支持基于 TCP 和 UDP 的四层负载均衡，从而扩展了其在数据库代理、邮件服务、消息中间件等非 HTTP 场景中的应用能力。值得一提的是，尽管 <code>stream</code> 模块在 <code>1.9.0</code> 版本中开始被引入，但在官方源码中该模块默认并未启用。因此，在编译 Nginx 源码时，如果希望使用 <code>stream</code> 模块的功能，则必须显式添加 <code>--with-stream</code> 编译参数，这样才能将其集成进最终构建的二进制可执行文件中。</p></div><h3 id="安装-MySQL"><a href="#安装-MySQL" class="headerlink" title="安装 MySQL"></a>安装 MySQL</h3><ul><li>添加 MySQL 官方 APT 源</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载 APT 配置包（访问 https://dev.mysql.com/downloads/repo/apt/ 可以获取最新版本）</span></span><br><span class="line">wget https://dev.mysql.com/get/mysql-apt-config_0.8.34-1_all.deb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 APT 配置包</span></span><br><span class="line"><span class="comment"># 在安装过程中会弹出配置界面，通常默认选择的是 MySQL 8.4 版本，如果需要安装其他版本（如 8.0），可以按回车键进入子菜单选择其他版本</span></span><br><span class="line"><span class="comment"># 由于集群聊天服务器需要使用到 MySQL 客户端，因此还需要安装 MySQL Connectors（不需要改动选择，因为默认已经选择安装）</span></span><br><span class="line">sudo dpkg -i mysql-apt-config_0.8.34-1_all.deb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新 APT 索引</span></span><br><span class="line">sudo apt-get update</span><br></pre></td></tr></tbody></table></figure><ul><li>安装 MySQL</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 MySQL（安装过程中会提示输入 MySQL 的 root 用户的密码）</span></span><br><span class="line">sudo apt-get install -y mysql-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机自启动 MySQL</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 MySQL 的运行状态</span></span><br><span class="line">sudo systemctl status mysql</span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">MySQL 默认配置文件的路径</p><p>通过 APT 安装 MySQL 服务器后，其主配置文件的路径为 <code>/etc/mysql/my.cnf</code>。</p></div><ul><li>安装 MySQL C API 库</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 MySQL 客户端开发包（包含了 MySQL C API 的头文件和动态库文件）</span></span><br><span class="line">sudo apt-get install -y libmysqlclient-dev</span><br></pre></td></tr></tbody></table></figure><ul><li>验证 MySQL 安装</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录 MySQL</span></span><br><span class="line">mysql -u root -p</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看 MySQL 版本</span></span><br><span class="line"><span class="keyword">select</span> version();</span><br></pre></td></tr></tbody></table></figure><ul><li>验证 MySQL C API 库的安装</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo find /usr -iname libmysqlclient*</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib/x86_64-linux-gnu/libmysqlclient.so</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libmysqlclient.a</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libmysqlclient.so.24</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libmysqlclient.so.24.0.5</span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">MySQL C API 库</p><p>本文使用 <code>libmysqlclient.so</code> 库来操作 MySQL 数据库，该库称为 MySQL C API（也叫 Connector/C），它是基于 C 语言实现的。C++ 项目也可以使用这个库，只要用 <code>extern "C"</code> 来链接（或者直接使用 MySQL 提供的头文件中已经加好的处理）。</p></div><h3 id="安装-Boost-库"><a href="#安装-Boost-库" class="headerlink" title="安装 Boost 库"></a>安装 Boost 库</h3><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 Boost 的所有组件和头文件</span></span><br><span class="line">sudo apt-get install -y libboost-all-dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Bootst 版本</span></span><br><span class="line">sudo dpkg -s libboost-all-dev | grep Version</span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">提示</p><p>由于 Muduo 使用了 Boost 库（如 <code>boost::any</code>），因此需要安装 Boost 库。</p></div><h3 id="安装-Muduo-库"><a href="#安装-Muduo-库" class="headerlink" title="安装 Muduo 库"></a>安装 Muduo 库</h3><ul><li>编译安装 Muduo 库</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Git 克隆代码</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/chenshuo/muduo.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入代码目录</span></span><br><span class="line"><span class="built_in">cd</span> muduo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建构建目录</span></span><br><span class="line">mkdir -p build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入构建目录</span></span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成构建文件</span></span><br><span class="line">cmake ..</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译源码</span></span><br><span class="line">make -j$(nproc)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行安装</span></span><br><span class="line">sudo make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新系统的共享库缓存</span></span><br><span class="line">sudo ldconfig /usr/<span class="built_in">local</span>/lib/</span><br></pre></td></tr></tbody></table></figure><ul><li>验证安装</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 Muduo 库的头文件</span></span><br><span class="line">ls -al /usr/<span class="built_in">local</span>/include/muduo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Muduo 库的静态库</span></span><br><span class="line">ls -al /usr/<span class="built_in">local</span>/lib | grep muduo</span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">提示</p><ul><li>Muduo 的编译依赖 CMake 和 Boost 库，默认编译生成的是静态库（<code>.a</code>），如果需要编译生成共享库（<code>.so</code>），可以自行修改 <code>CMakeLists.txt</code> 中的配置。</li><li>Muduo 支持 C++ 11，仅支持 Linux 平台，不支持 Windows 平台，建议使用 <code>7.x</code> 及以后版本的 <code>g++</code> 编译器。</li></ul></div><h3 id="安装-Hiredis-库"><a href="#安装-Hiredis-库" class="headerlink" title="安装 Hiredis 库"></a>安装 Hiredis 库</h3><ul><li>编译安装 Hiredis 库</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Git 克隆代码</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/redis/hiredis.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入源码目录</span></span><br><span class="line"><span class="built_in">cd</span> hiredis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译源码</span></span><br><span class="line">make -j$(nproc)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行安装</span></span><br><span class="line">sudo make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新系统的共享库缓存</span></span><br><span class="line">sudo ldconfig /usr/<span class="built_in">local</span>/lib/</span><br></pre></td></tr></tbody></table></figure><ul><li>验证安装</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 Hiredis 库的头文件</span></span><br><span class="line">ls -al /usr/<span class="built_in">local</span>/include/hiredis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Hiredis 库的静态库和动态库</span></span><br><span class="line">ls -al /usr/<span class="built_in">local</span>/lib | grep hiredis</span><br></pre></td></tr></tbody></table></figure><h2 id="项目介绍"><a href="#项目介绍" class="headerlink" title="项目介绍"></a>项目介绍</h2><h3 id="项目架构"><a href="#项目架构" class="headerlink" title="项目架构"></a>项目架构</h3><p>在集群聊天服务器项目中，使用 Nginx 作为 TCP 负载均衡器，同时使用 Redis 的发布 - 订阅特性来解决客户端跨服务器通信问题。整体工作流程如下图所示：</p><p><img data-src="../../../asset/2025/06/cluster-chat-loadbalance-1.png"></p><div class="admonition note"><p class="admonition-title">提示</p><p>Nginx 单机作为负载均衡器时，经过合理的系统参数优化和配置（如 <code>ulimit</code>、内核参数调整等），通常可以稳定支撑 5 万～6 万个并发 TCP 连接。但是，由于 Nginx 本质上是属于应用层的四层代理，其性能仍受限于单机的 CPU、内存、网络带宽和文件描述符等资源限制。若需支持 超过 10 万甚至上百万的并发 TCP 连接，可采用 LVS + Keepalived + Nginx 的分层架构实现更高性能、更高可用性、更强伸缩性的负载均衡方案，该方案的部署拓扑结构 <a href="../../../asset/2025/06/cluster-chat-loadbalance-2.png">如图</a> 所示。</p></div><h3 id="项目技术栈"><a href="#项目技术栈" class="headerlink" title="项目技术栈"></a>项目技术栈</h3><ul><li>单例设计模式</li><li> Muduo 网络库</li><li> MySQL 数据库编程</li><li> CMake 构建编译环境</li><li> Json 序列化和反序列化</li><li> Nginx 的 TCP 负载均衡器使用</li><li> Redis 的发布 - 订阅编程实践</li></ul><h3 id="项目需求与目标"><a href="#项目需求与目标" class="headerlink" title="项目需求与目标"></a>项目需求与目标</h3><ul><li><p>项目需求</p><ul><li>客户端新用户注册</li><li>客户端用户登录</li><li>添加好友和添加群组</li><li>好友聊天</li><li>群组聊天</li><li>离线消息</li><li> Nginx 配置 TCP 负载均衡</li><li>集群聊天系统支持客户端跨服务器通信</li></ul></li><li><p>项目目标</p><ul><li>掌握 Json 的编程应用</li><li>掌握 CMake 构建自动化编译环境</li><li>掌握 Muduo 网络库的编程以及实现原理</li><li>掌握 Nginx 配置部署 TCP 负载均衡器的应用以及原理</li><li>掌握聊天服务器的网络 I/O 模块、业务模块、数据模块分层的设计思想</li><li>掌握 Redis 发布 - 订阅的编程实践以及应用原理</li></ul></li></ul><h2 id="项目开发"><a href="#项目开发" class="headerlink" title="项目开发"></a>项目开发</h2><h3 id="Nginx-负载均衡配置"><a href="#Nginx-负载均衡配置" class="headerlink" title="Nginx 负载均衡配置"></a>Nginx 负载均衡配置</h3><p>在集群聊天服务器项目中，由于使用了 Nginx 作为 TCP 负载均衡器，因此需要在 Nginx 的配置文件中（<code>nginx.conf</code>）添加 <code>stream</code> 模块的配置内容，如下所示：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">events {</span><br><span class="line">  ........</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"># nginx tcp loadbalance config</span><br><span class="line">stream {</span><br><span class="line">    # 集群聊天的服务器列表</span><br><span class="line">    upstream chat_server {</span><br><span class="line">        server 127.0.0.1:6000 weight=1 max_fails=3 fail_timeout=30s;</span><br><span class="line">        server 127.0.0.1:6002 weight=1 max_fails=3 fail_timeout=30s;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    # TCP 负载均衡器（负责转发流量）</span><br><span class="line">    server {</span><br><span class="line">        listen 8000;</span><br><span class="line">        proxy_pass chat_server;</span><br><span class="line">        proxy_connect_timeout 1s;</span><br><span class="line">        tcp_nodelay on;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">http {</span><br><span class="line">  ......</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="Redis-发布-订阅使用"><a href="#Redis-发布-订阅使用" class="headerlink" title="Redis 发布 - 订阅使用"></a>Redis 发布 - 订阅使用</h3><p>在集群聊天服务器项目中，使用 Redis 的发布 - 订阅特性来解决客户端跨服务器通信问题。Reids 的发布 - 订阅功能，主要使用以下几个 Redis 命令来实现：</p><ul><li>订阅指定的 Channel</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subscribe news</span><br></pre></td></tr></tbody></table></figure><ul><li>发布消息到指定的 Channel</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">publish news <span class="string">"hello"</span></span><br></pre></td></tr></tbody></table></figure><ul><li>取消订阅指定的 Channel</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unsubscribe news</span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">提示</p><p>在集群聊天服务器项目中，为了方便操作 Redis，会使用到 <a target="_blank" rel="external nofollow" href="https://github.com/redis/hiredis">Hiredis</a> 库。</p></div><h3 id="MySQL-数据库初始化"><a href="#MySQL-数据库初始化" class="headerlink" title="MySQL 数据库初始化"></a>MySQL 数据库初始化</h3><h4 id="数据库设计"><a href="#数据库设计" class="headerlink" title="数据库设计"></a>数据库设计</h4><p>C++ 集群聊天服务器项目的数据库表设计如下：</p><p><img data-src="../../../asset/2025/05/cxx-cluster-chat-server-1.png"></p><h4 id="数据库初始化"><a href="#数据库初始化" class="headerlink" title="数据库初始化"></a>数据库初始化</h4><ul><li>创建数据库</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE `chat` <span class="keyword">DEFAULT</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci;</span><br></pre></td></tr></tbody></table></figure><ul><li>切换数据库</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">USE `chat`;</span><br></pre></td></tr></tbody></table></figure><ul><li>创建用户表</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">user</span>` (</span><br><span class="line">  `id` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `password` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `state` enum(<span class="string">'online'</span>,<span class="string">'offline'</span>) <span class="keyword">DEFAULT</span> <span class="string">'offline'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `name` (`name`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">22</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></tbody></table></figure><ul><li>创建好友表</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `friend` (</span><br><span class="line">  `userid` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `friendid` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `userid` (`userid`,`friendid`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></tbody></table></figure><ul><li>创建用户组表</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `allgroup` (</span><br><span class="line">  `id` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `groupname` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `groupdesc` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `groupname` (`groupname`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">2</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></tbody></table></figure><ul><li>创建用户与用户组关联表</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `groupuser` (</span><br><span class="line">  `groupid` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `userid` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `grouprole` enum(<span class="string">'creator'</span>,<span class="string">'normal'</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `groupid` (`groupid`,`userid`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></tbody></table></figure><ul><li>创建离线消息表</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `offlinemessage` (</span><br><span class="line">  `userid` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `message` <span class="type">varchar</span>(<span class="number">500</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `createtime` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></tbody></table></figure><h3 id="集群聊天服务器开发"><a href="#集群聊天服务器开发" class="headerlink" title="集群聊天服务器开发"></a>集群聊天服务器开发</h3><h4 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">├── CMakeLists.txt</span><br><span class="line">├── README.md</span><br><span class="line">├── autobuild.sh</span><br><span class="line">├── sql</span><br><span class="line">│&nbsp;&nbsp; └── db.sql</span><br><span class="line">├── include</span><br><span class="line">│   ├── public</span><br><span class="line">│   │   ├── config.hpp</span><br><span class="line">│   │   ├── public.hpp</span><br><span class="line">│   │   └── times.hpp</span><br><span class="line">│   └── server</span><br><span class="line">│       ├── chatserver.hpp</span><br><span class="line">│       ├── chatservice.hpp</span><br><span class="line">│       ├── dao</span><br><span class="line">│       │   ├── friendmodel.hpp</span><br><span class="line">│       │   ├── groupmodel.hpp</span><br><span class="line">│       │   ├── groupusermodel.hpp</span><br><span class="line">│       │   ├── offlinemessagemodel.hpp</span><br><span class="line">│       │   └── usermodel.hpp</span><br><span class="line">│       ├── db</span><br><span class="line">│       │   └── db.hpp</span><br><span class="line">│       ├── domain</span><br><span class="line">│       │   ├── friend.hpp</span><br><span class="line">│       │   ├── group.hpp</span><br><span class="line">│       │   ├── groupuser.hpp</span><br><span class="line">│       │   ├── offlinemessage.hpp</span><br><span class="line">│       │   └── user.hpp</span><br><span class="line">│       └── redis</span><br><span class="line">│           └── redis.hpp</span><br><span class="line">├── src</span><br><span class="line">│   ├── CMakeLists.txt</span><br><span class="line">│   ├── client</span><br><span class="line">│   │   ├── CMakeLists.txt</span><br><span class="line">│   │   └── main.cpp</span><br><span class="line">│   └── server</span><br><span class="line">│       ├── CMakeLists.txt</span><br><span class="line">│       ├── chatserver.cpp</span><br><span class="line">│       ├── chatservice.cpp</span><br><span class="line">│       ├── dao</span><br><span class="line">│       │   ├── friendmodel.cpp</span><br><span class="line">│       │   ├── groupmodel.cpp</span><br><span class="line">│       │   ├── groupusermodel.cpp</span><br><span class="line">│       │   ├── offlinemessagemodel.cpp</span><br><span class="line">│       │   └── usermodel.cpp</span><br><span class="line">│       ├── db</span><br><span class="line">│       │   └── db.cpp</span><br><span class="line">│       ├── main.cpp</span><br><span class="line">│       └── redis</span><br><span class="line">│           └── redis.cpp</span><br><span class="line">└── thirdparty</span><br><span class="line">    └── json.hpp</span><br></pre></td></tr></tbody></table></figure><h4 id="项目代码"><a href="#项目代码" class="headerlink" title="项目代码"></a>项目代码</h4><div class="admonition note"><p class="admonition-title">下载完整的项目代码</p><p>由于篇幅有限，下面只给出集群聊天服务端和客户端的部分核心代码，完整的项目代码可以在 <a target="_blank" rel="external nofollow" href="https://github.com/rqh656418510/c-cplusplus-study/tree/main/c%2B%2B-projects/c%2B%2B-project-cluster-chat-server">这里</a> 下载得到。</p></div><h5 id="公共核心代码"><a href="#公共核心代码" class="headerlink" title="公共核心代码"></a>公共核心代码</h5><ul><li><code>include/public/config.hpp</code> 头文件</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_H</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全局配置信息的头文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MySQL 连接信息</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> string DB_IP = <span class="string">"127.0.0.1"</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> DB_PORT = <span class="number">3306</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> string DB_USER = <span class="string">"root"</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> string DB_PASSWORD = <span class="string">"Cxx_Chat_12345"</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> string DB_NAME = <span class="string">"chat"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Redis 连接信息</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> string REDIS_IP = <span class="string">"127.0.0.1"</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> REDIS_PORT = <span class="number">6379</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// CONFIG_H</span></span></span><br></pre></td></tr></tbody></table></figure><ul><li><code>include/public/public.hpp</code> 头文件</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PUBLIC_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PUBLIC_H</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误编码</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">ErrorCode</span> {</span></span><br><span class="line">    SUCCESS = <span class="number">0</span>,           <span class="comment">// 请求处理成功</span></span><br><span class="line">    REGISTER_FAIL,         <span class="comment">// 注册失败</span></span><br><span class="line">    REPEAT_REGISTER,       <span class="comment">// 用户名已被注册</span></span><br><span class="line">    LOGIN_AUTH_FAIL,       <span class="comment">// 用户名或密码不正确</span></span><br><span class="line">    REPEAT_LOGIN,          <span class="comment">// 账号在其他设备已登录</span></span><br><span class="line">    ADD_FRIEND_FAIL,       <span class="comment">// 添加好友失败</span></span><br><span class="line">    JOIN_GROUP_FAIL,       <span class="comment">// 加入群组失败</span></span><br><span class="line">    SINGLE_CHAT_FAIL,      <span class="comment">// 一对一聊天失败</span></span><br><span class="line">    GROUP_CHAT_FAIL,       <span class="comment">// 群组聊天失败</span></span><br><span class="line">    INVALID_MESSAGE_TYPE,  <span class="comment">// 消息类型无效</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消息类型</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">MsgType</span> {</span></span><br><span class="line">    LOGIN_MSG = <span class="number">1</span>,         <span class="comment">// 登录消息</span></span><br><span class="line">    LOGIN_MSG_ACK,         <span class="comment">// 登录响应消息</span></span><br><span class="line">    REGISTER_MSG,          <span class="comment">// 注册消息</span></span><br><span class="line">    REGISTER_MSG_ACK,      <span class="comment">// 注册响应消息</span></span><br><span class="line">    SINGLE_CHAT_MSG,       <span class="comment">// 一对一聊天消息</span></span><br><span class="line">    SINGLE_CHAT_MSG_ACK,   <span class="comment">// 一对一聊天响应消息</span></span><br><span class="line">    ADD_FRIEND_MSG,        <span class="comment">// 添加好友消息</span></span><br><span class="line">    ADD_FRIEND_MSG_ACK,    <span class="comment">// 添加好友响应消息</span></span><br><span class="line">    CREATE_GROUP_MSG,      <span class="comment">// 创建群组消息</span></span><br><span class="line">    CREATE_GROUP_MSG_ACK,  <span class="comment">// 创建群组响应消息</span></span><br><span class="line">    JOIN_GROUP_MSG,        <span class="comment">// 加入群组消息</span></span><br><span class="line">    JOIN_GROUP_MSG_ACK,    <span class="comment">// 加入群组响应消息</span></span><br><span class="line">    GROUP_CHAT_MSG,        <span class="comment">// 群聊天消息</span></span><br><span class="line">    GROUP_CHAT_MSG_ACK,    <span class="comment">// 群聊天响应消息</span></span><br><span class="line">    LOGIN_OUT_MSG,         <span class="comment">// 退出登录消息</span></span><br><span class="line">    LOGIN_OUT_MSG_ACK,     <span class="comment">// 退出登录响应消息</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// PUBLIC_H</span></span></span><br></pre></td></tr></tbody></table></figure><ul><li><code>include/public/times.hpp</code> 头文件</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> TIMES_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TIMES_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;boost/date_time/c_local_time_adjustor.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;boost/date_time/posix_time/posix_time.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取当前时间戳（单位：毫秒）</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">long</span> <span class="title">getTimestampMs</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取当前系统的时间点</span></span><br><span class="line">    chrono::system_clock::time_point now = chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="comment">// 转换为时间戳</span></span><br><span class="line">    <span class="keyword">return</span> chrono::duration_cast&lt;chrono::milliseconds&gt;(now.<span class="built_in">time_since_epoch</span>()).<span class="built_in">count</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将时间戳（单位：毫秒）格式化为系统本地时间的字符串</span></span><br><span class="line"><span class="comment">// timestampMs: Unix 时间戳（自 1970-01-01 00:00:00 UTC 起的毫秒数）</span></span><br><span class="line"><span class="comment">// formatStr: 格式化字符串，例如 "%Y-%m-%d %H:%M:%S"</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> std::string <span class="title">formatTimestampLocal</span><span class="params">(<span class="keyword">long</span> timestampMs, <span class="keyword">const</span> std::string&amp; formatStr)</span> </span>{</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> boost::posix_time;</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> boost::gregorian;</span><br><span class="line">    <span class="keyword">using</span> boost::date_time::c_local_adjustor;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造 UTC 时间：从 epoch 加上毫秒数</span></span><br><span class="line">    <span class="function">ptime <span class="title">epoch</span><span class="params">(date(<span class="number">1970</span>, <span class="number">1</span>, <span class="number">1</span>))</span></span>;</span><br><span class="line">    time_duration duration = <span class="built_in">milliseconds</span>(timestampMs);</span><br><span class="line">    ptime utc_time = epoch + duration;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转换为系统本地时间</span></span><br><span class="line">    <span class="keyword">typedef</span> c_local_adjustor&lt;ptime&gt; local_adj;</span><br><span class="line">    ptime local_time = local_adj::<span class="built_in">utc_to_local</span>(utc_time);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 格式化输出</span></span><br><span class="line">    std::ostringstream oss;</span><br><span class="line">    time_facet* facet = <span class="keyword">new</span> <span class="built_in">time_facet</span>(formatStr.<span class="built_in">c_str</span>());</span><br><span class="line">    oss.<span class="built_in">imbue</span>(std::<span class="built_in">locale</span>(std::locale::<span class="built_in">classic</span>(), facet));</span><br><span class="line">    oss &lt;&lt; local_time;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> oss.<span class="built_in">str</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// TIMES_H</span></span></span><br></pre></td></tr></tbody></table></figure><h5 id="服务端核心代码"><a href="#服务端核心代码" class="headerlink" title="服务端核心代码"></a>服务端核心代码</h5><div class="admonition note"><p class="admonition-title">提示</p><p>在集群聊天服务端中，使用了 Json 库和 Muduo 网络库，并引入了 MySQL、Redis。</p></div><h6 id="Redis-操作代码"><a href="#Redis-操作代码" class="headerlink" title="Redis 操作代码"></a>Redis 操作代码</h6><div class="admonition warning"><p class="admonition-title">特别注意</p><p>Redis 安装完成后，切记不要设置密码，否则下面的 C++ 代码将无法正常连接 Redis 服务器，这是因为下面的 C++ 代码并没有实现 Redis 的身份认证功能。</p></div><ul><li><code>include/server/redis/redis.hpp</code> 头文件</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> REDIS_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hiredis/hiredis.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Redis 操作类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Redis</span> {</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 构造函数</span></span><br><span class="line">    <span class="built_in">Redis</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 析构函数</span></span><br><span class="line">    ~<span class="built_in">Redis</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接redis服务器</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">connect</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向redis指定的通道subscribe消息</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">subscribe</span><span class="params">(<span class="keyword">int</span> channel)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向redis指定的通道unsubscribe消息</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">unsubscribe</span><span class="params">(<span class="keyword">int</span> channel)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在独立线程中异步接收订阅通道中的消息</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">observer_channel_message</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向redis指定的通道publish消息</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">publish</span><span class="params">(<span class="keyword">int</span> channel, string message)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化向业务层上报通道消息的回调对象</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init_notify_handler</span><span class="params">(function&lt;<span class="keyword">void</span>(<span class="keyword">int</span>, string)&gt; fn)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// hiredis同步上下文对象（即redis客户端），负责publish消息</span></span><br><span class="line">    redisContext *_publish_context;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// hiredis同步上下文对象（即redis客户端），负责subscribe消息</span></span><br><span class="line">    redisContext *_subcribe_context;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 回调操作，收到订阅的消息，给service层上报</span></span><br><span class="line">    function&lt;<span class="built_in"><span class="keyword">void</span></span>(<span class="keyword">int</span>, string)&gt; _notify_message_handler;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></tbody></table></figure><ul><li><code>src/server/redis/redis.cpp</code> 源文件</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"redis.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"config.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造函数</span></span><br><span class="line">Redis::<span class="built_in">Redis</span>() : _publish_context(<span class="literal">nullptr</span>), _subcribe_context(<span class="literal">nullptr</span>) {</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 析构函数</span></span><br><span class="line">Redis::~<span class="built_in">Redis</span>() {</span><br><span class="line">    <span class="keyword">if</span> (_publish_context != <span class="literal">nullptr</span>) {</span><br><span class="line">        <span class="built_in">redisFree</span>(_publish_context);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_subcribe_context != <span class="literal">nullptr</span>) {</span><br><span class="line">        <span class="built_in">redisFree</span>(_subcribe_context);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接redis服务器</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Redis::connect</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// 负责publish发布消息的上下文对象（即redis客户端）</span></span><br><span class="line">    _publish_context = <span class="built_in">redisConnect</span>(REDIS_IP.<span class="built_in">c_str</span>(), REDIS_PORT);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">nullptr</span> == _publish_context || _publish_context-&gt;err) {</span><br><span class="line">        cerr &lt;&lt; <span class="string">"connect redis failed!"</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">if</span> (_publish_context) {</span><br><span class="line">            cerr &lt;&lt; <span class="string">"connect redis error: "</span> &lt;&lt; _publish_context-&gt;errstr &lt;&lt; endl;</span><br><span class="line">            <span class="built_in">redisFree</span>(_publish_context);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 负责subscribe订阅消息的上下文对象（即redis客户端）</span></span><br><span class="line">    _subcribe_context = <span class="built_in">redisConnect</span>(REDIS_IP.<span class="built_in">c_str</span>(), REDIS_PORT);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">nullptr</span> == _subcribe_context || _subcribe_context-&gt;err) {</span><br><span class="line">        cerr &lt;&lt; <span class="string">"connect redis failed!"</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">if</span> (_subcribe_context) {</span><br><span class="line">            cerr &lt;&lt; <span class="string">"connect redis error: "</span> &lt;&lt; _subcribe_context-&gt;errstr &lt;&lt; endl;</span><br><span class="line">            <span class="built_in">redisFree</span>(_subcribe_context);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在单独的线程中，监听通道上的事件，有消息就给业务层进行上报</span></span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">([&amp;]() { observer_channel_message(); })</span></span>;</span><br><span class="line">    t.<span class="built_in">detach</span>();</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">"connect redis success!"</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向redis指定的通道subscribe消息</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Redis::subscribe</span><span class="params">(<span class="keyword">int</span> channel)</span> </span>{</span><br><span class="line">    <span class="comment">// SUBSCRIBE命令本身会造成线程阻塞等待通道里面发生消息，这里只做订阅通道，不接收通道消息</span></span><br><span class="line">    <span class="comment">// 通道消息的接收专门在observer_channel_message()函数中的独立线程中进行</span></span><br><span class="line">    <span class="comment">// 这里只负责发送订阅命令，不阻塞接收Redis服务器的响应消息，否则会和notifyMsg线程抢占响应资源</span></span><br><span class="line">    <span class="keyword">if</span> (REDIS_ERR == <span class="built_in">redisAppendCommand</span>(<span class="keyword">this</span>-&gt;_subcribe_context, <span class="string">"SUBSCRIBE %d"</span>, channel)) {</span><br><span class="line">        cerr &lt;&lt; <span class="string">"subscribe command execute failed!"</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// redisBufferWrite()函数可以循环发送缓冲区中的数据，直到缓冲区数据发送完毕（done被置为1）</span></span><br><span class="line">    <span class="keyword">int</span> done = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (!done) {</span><br><span class="line">        <span class="keyword">if</span> (REDIS_ERR == <span class="built_in">redisBufferWrite</span>(<span class="keyword">this</span>-&gt;_subcribe_context, &amp;done)) {</span><br><span class="line">            cerr &lt;&lt; <span class="string">"subscribe command execute failed!"</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向redis指定的通道unsubscribe消息</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Redis::unsubscribe</span><span class="params">(<span class="keyword">int</span> channel)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (REDIS_ERR == <span class="built_in">redisAppendCommand</span>(<span class="keyword">this</span>-&gt;_subcribe_context, <span class="string">"UNSUBSCRIBE %d"</span>, channel)) {</span><br><span class="line">        cerr &lt;&lt; <span class="string">"unsubscribe command execute failed!"</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// redisBufferWrite()函数可以循环发送缓冲区中的数据，直到缓冲区数据发送完毕（done被置为1）</span></span><br><span class="line">    <span class="keyword">int</span> done = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (!done) {</span><br><span class="line">        <span class="keyword">if</span> (REDIS_ERR == <span class="built_in">redisBufferWrite</span>(<span class="keyword">this</span>-&gt;_subcribe_context, &amp;done)) {</span><br><span class="line">            cerr &lt;&lt; <span class="string">"unsubscribe command execute failed!"</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在独立线程中异步接收订阅通道中的消息</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Redis::observer_channel_message</span><span class="params">()</span> </span>{</span><br><span class="line">    redisReply *reply = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">while</span> (REDIS_OK == <span class="built_in">redisGetReply</span>(<span class="keyword">this</span>-&gt;_subcribe_context, (<span class="keyword">void</span> **)&amp;reply)) {</span><br><span class="line">        <span class="comment">// 订阅收到的消息是一个带三个元素的数组</span></span><br><span class="line">        <span class="keyword">if</span> (reply != <span class="literal">nullptr</span> &amp;&amp; reply-&gt;element[<span class="number">2</span>] != <span class="literal">nullptr</span> &amp;&amp; reply-&gt;element[<span class="number">2</span>]-&gt;str != <span class="literal">nullptr</span>) {</span><br><span class="line">            <span class="comment">// 给业务层上报通道上发生的消息</span></span><br><span class="line">            _notify_message_handler(<span class="built_in">atoi</span>(reply-&gt;element[<span class="number">1</span>]-&gt;str), reply-&gt;element[<span class="number">2</span>]-&gt;str);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 释放资源</span></span><br><span class="line">        <span class="built_in">freeReplyObject</span>(reply);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    cerr &lt;&lt; <span class="string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; observer_channel_message quit &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;"</span> &lt;&lt; endl;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向redis指定的通道publish消息</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Redis::publish</span><span class="params">(<span class="keyword">int</span> channel, string message)</span> </span>{</span><br><span class="line">    <span class="comment">// 发布消息</span></span><br><span class="line">    redisReply *reply = (redisReply *)<span class="built_in">redisCommand</span>(_publish_context, <span class="string">"PUBLISH %d %s"</span>, channel, message.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">nullptr</span> == reply) {</span><br><span class="line">        cerr &lt;&lt; <span class="string">"publish command execute failed!"</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放资源</span></span><br><span class="line">    <span class="built_in">freeReplyObject</span>(reply);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化向业务层上报通道消息的回调对象</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Redis::init_notify_handler</span><span class="params">(function&lt;<span class="keyword">void</span>(<span class="keyword">int</span>, string)&gt; fn)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>-&gt;_notify_message_handler = fn;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h6 id="MySQL-操作代码"><a href="#MySQL-操作代码" class="headerlink" title="MySQL 操作代码"></a>MySQL 操作代码</h6><div class="admonition note"><p class="admonition-title">提示</p><p>这里使用 MySQL C API（Connector/C）库来读写 MySQL 数据库，该库基于 C 语言开发。</p></div><ul><li><code>include/server/db/db.hpp</code> 源文件</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> DB_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DB_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mysql/mysql.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数据库操作类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySQL</span> {</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 初始化数据库连接</span></span><br><span class="line">    <span class="built_in">MySQL</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放数据库连接</span></span><br><span class="line">    ~<span class="built_in">MySQL</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接数据库</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">connect</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新操作</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">update</span><span class="params">(string sql)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询操作</span></span><br><span class="line">    <span class="function">MYSQL_RES *<span class="title">query</span><span class="params">(string sql)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取数据库连接</span></span><br><span class="line">    <span class="function">MYSQL *<span class="title">getConnection</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    MYSQL *_conn;  <span class="comment">// 数据库连接</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// DB_H</span></span></span><br></pre></td></tr></tbody></table></figure><ul><li><code>src/server/db/db.cpp</code> 源文件</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"db.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;muduo/base/Logging.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"config.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化数据库连接</span></span><br><span class="line">MySQL::<span class="built_in">MySQL</span>() {</span><br><span class="line">    _conn = <span class="built_in">mysql_init</span>(<span class="literal">nullptr</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放数据库连接</span></span><br><span class="line">MySQL::~<span class="built_in">MySQL</span>() {</span><br><span class="line">    <span class="keyword">if</span> (_conn != <span class="literal">nullptr</span>) {</span><br><span class="line">        <span class="built_in">mysql_close</span>(_conn);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接数据库</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">MySQL::connect</span><span class="params">()</span> </span>{</span><br><span class="line">    MYSQL *p = <span class="built_in">mysql_real_connect</span>(_conn, DB_IP.<span class="built_in">c_str</span>(), DB_USER.<span class="built_in">c_str</span>(), DB_PASSWORD.<span class="built_in">c_str</span>(), DB_NAME.<span class="built_in">c_str</span>(), DB_PORT,</span><br><span class="line">                                  <span class="literal">nullptr</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="literal">nullptr</span>) {</span><br><span class="line">        <span class="comment">// C和C++代码默认的编码字符是ASCII，如果不设置，从MySQL查询到的中文内容可能会显示？乱码</span></span><br><span class="line">        <span class="built_in">mysql_query</span>(_conn, <span class="string">"set names utf8mb4"</span>);</span><br><span class="line">        LOG_INFO &lt;&lt; <span class="string">"connect mysql success!"</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        LOG_ERROR &lt;&lt; <span class="string">"connect mysql failed!"</span>;</span><br><span class="line">        LOG_ERROR &lt;&lt; <span class="built_in">mysql_error</span>(_conn);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新操作</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">MySQL::update</span><span class="params">(string sql)</span> </span>{</span><br><span class="line">    LOG_DEBUG &lt;&lt; sql;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">mysql_query</span>(_conn, sql.<span class="built_in">c_str</span>())) {</span><br><span class="line">        LOG_ERROR &lt;&lt; __FILE__ &lt;&lt; <span class="string">":"</span> &lt;&lt; __LINE__ &lt;&lt; <span class="string">" "</span> &lt;&lt; sql &lt;&lt; <span class="string">" execute failed!"</span>;</span><br><span class="line">        LOG_ERROR &lt;&lt; <span class="built_in">mysql_error</span>(_conn);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询操作</span></span><br><span class="line"><span class="function">MYSQL_RES *<span class="title">MySQL::query</span><span class="params">(string sql)</span> </span>{</span><br><span class="line">    LOG_DEBUG &lt;&lt; sql;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">mysql_query</span>(_conn, sql.<span class="built_in">c_str</span>())) {</span><br><span class="line">        LOG_ERROR &lt;&lt; __FILE__ &lt;&lt; <span class="string">":"</span> &lt;&lt; __LINE__ &lt;&lt; <span class="string">" "</span> &lt;&lt; sql &lt;&lt; <span class="string">" execute failed!"</span>;</span><br><span class="line">        LOG_ERROR &lt;&lt; <span class="built_in">mysql_error</span>(_conn);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">mysql_store_result</span>(_conn);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取数据库连接</span></span><br><span class="line"><span class="function">MYSQL *<span class="title">MySQL::getConnection</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> _conn;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h6 id="聊天服务端代码"><a href="#聊天服务端代码" class="headerlink" title="聊天服务端代码"></a>聊天服务端代码</h6><blockquote><p>聊天服务器的代码</p></blockquote><ul><li><code>include/server/chatserver.hpp</code> 头文件</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CHATSERVER_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CHATSERVER_H</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 聊天服务器的头文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;muduo/net/EventLoop.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;muduo/net/TcpServer.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo::net;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 聊天服务器类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChatServer</span> {</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 构造函数</span></span><br><span class="line">    <span class="built_in">ChatServer</span>(EventLoop* loop, <span class="keyword">const</span> InetAddress&amp; listenAddr, <span class="keyword">const</span> string&amp; nameArg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 析构函数</span></span><br><span class="line">    ~<span class="built_in">ChatServer</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动服务器</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// 处理用户的连接创建和断开</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onConnection</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr&amp; conn)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理用户读写事件（比如接收客户端发送的数据）</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr&amp; conn, Buffer* buf, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    TcpServer _server;  <span class="comment">// TCP 服务器对象</span></span><br><span class="line">    EventLoop* _loop;   <span class="comment">// 指向事件回环的指针</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// CHATSERVER_H</span></span></span><br></pre></td></tr></tbody></table></figure><ul><li><code>src/server/chatserver.cpp</code> 源文件</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 聊天服务器的实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"chatserver.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;muduo/base/Logging.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"chatservice.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"json.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"public.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类型重定义</span></span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造函数</span></span><br><span class="line">ChatServer::<span class="built_in">ChatServer</span>(EventLoop* loop, <span class="keyword">const</span> InetAddress&amp; listenAddr, <span class="keyword">const</span> string&amp; nameArg)</span><br><span class="line">    : _server(loop, listenAddr, nameArg), _loop(loop) {</span><br><span class="line">    <span class="comment">// 设置服务端注册用户连接的创建和断开回调</span></span><br><span class="line">    _server.<span class="built_in">setConnectionCallback</span>(<span class="built_in">bind</span>(&amp;ChatServer::onConnection, <span class="keyword">this</span>, placeholders::_1));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置服务端注册用户读写事件的回调</span></span><br><span class="line">    _server.<span class="built_in">setMessageCallback</span>(</span><br><span class="line">        <span class="built_in">bind</span>(&amp;ChatServer::onMessage, <span class="keyword">this</span>, placeholders::_1, placeholders::_2, placeholders::_3));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置EventLoop的线程数量（比如：1个I/O线程，3个Worker线程）</span></span><br><span class="line">    _server.<span class="built_in">setThreadNum</span>(<span class="number">4</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 析构函数</span></span><br><span class="line">ChatServer::~<span class="built_in">ChatServer</span>() {</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动服务器</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ChatServer::start</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// 开启事件循环处理</span></span><br><span class="line">    _server.<span class="built_in">start</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理用户的连接创建和断开</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ChatServer::onConnection</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr&amp; conn)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (!conn-&gt;<span class="built_in">connected</span>()) {</span><br><span class="line">        <span class="comment">// 处理用户连接关闭的情况</span></span><br><span class="line">        ChatService::<span class="built_in">instance</span>()-&gt;<span class="built_in">clientConnClose</span>(conn);</span><br><span class="line">        <span class="comment">// 断开连接（释放资源）</span></span><br><span class="line">        conn-&gt;<span class="built_in">shutdown</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理用户读写事件（比如接收客户端发送的数据）</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ChatServer::onMessage</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr&amp; conn, Buffer* buf, Timestamp time)</span> </span>{</span><br><span class="line">    <span class="comment">// 获取客户端发送的数据</span></span><br><span class="line">    string message = buf-&gt;<span class="built_in">retrieveAllAsString</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印日志信息</span></span><br><span class="line">    LOG_DEBUG &lt;&lt; <span class="string">"server received message : "</span> &lt;&lt; message;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// JSON 字符串反序列化</span></span><br><span class="line">    json jsonObj = json::<span class="built_in">parse</span>(message);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 非法消息直接忽略处理</span></span><br><span class="line">    <span class="keyword">if</span> (!jsonObj.<span class="built_in">contains</span>(<span class="string">"msgType"</span>)) {</span><br><span class="line">        <span class="comment">// 返回数据给客户端</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">"errNum"</span>] = ErrorCode::INVALID_MESSAGE_TYPE;</span><br><span class="line">        response[<span class="string">"errMsg"</span>] = <span class="string">"消息类型无效"</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消息类型</span></span><br><span class="line">    <span class="keyword">int</span> msgType = jsonObj[<span class="string">"msgType"</span>].get&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取消息处理器</span></span><br><span class="line">    <span class="keyword">auto</span> msgHandler = ChatService::<span class="built_in">instance</span>()-&gt;<span class="built_in">getMsgHandler</span>(msgType);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用消息处理器，执行相应的业务处理</span></span><br><span class="line">    <span class="built_in">msgHandler</span>(conn, make_shared&lt;json&gt;(jsonObj), time);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><blockquote><p>聊天核心业务的代码</p></blockquote><ul><li><code>include/server/chatservice.hpp</code> 头文件</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CHATSERVICE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CHATSERVICE_H</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 聊天核心业务的头文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;muduo/net/TcpConnection.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unordered_map&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"friendmodel.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"groupmodel.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"groupusermodel.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"json.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"offlinemessagemodel.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"redis.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"usermodel.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo::net;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类型重定义</span></span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理消息的回调类型（使用智能指针是为了兼容低版本的G++编译器）</span></span><br><span class="line"><span class="keyword">using</span> MsgHandler = function&lt;<span class="built_in"><span class="keyword">void</span></span>(<span class="keyword">const</span> TcpConnectionPtr&amp; conn, <span class="keyword">const</span> shared_ptr&lt;json&gt;&amp; data, Timestamp time)&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 聊天服务器的业务类（单例对象）</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChatService</span> {</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 获取单例对象</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> ChatService* <span class="title">instance</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理登录业务</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">login</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr&amp; conn, <span class="keyword">const</span> shared_ptr&lt;json&gt;&amp; data, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理注册业务</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reg</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr&amp; conn, <span class="keyword">const</span> shared_ptr&lt;json&gt;&amp; data, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理一对一聊天消息</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">singleChat</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr&amp; conn, <span class="keyword">const</span> shared_ptr&lt;json&gt;&amp; data, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理添加好友消息</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addFriend</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr&amp; conn, <span class="keyword">const</span> shared_ptr&lt;json&gt;&amp; data, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理创建群组消息</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">createGroup</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr&amp; conn, <span class="keyword">const</span> shared_ptr&lt;json&gt;&amp; data, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理加入群组消息</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">joinGroup</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr&amp; conn, <span class="keyword">const</span> shared_ptr&lt;json&gt;&amp; data, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理群聊天消息</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">groupChat</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr&amp; conn, <span class="keyword">const</span> shared_ptr&lt;json&gt;&amp; data, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理退出登录消息</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">loginOut</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr&amp; conn, <span class="keyword">const</span> shared_ptr&lt;json&gt;&amp; data, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取消息对应的处理器</span></span><br><span class="line">    <span class="function">MsgHandler <span class="title">getMsgHandler</span><span class="params">(<span class="keyword">int</span> msgType)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理Redis订阅通道中发生的消息</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handleRedisSubScribeMessage</span><span class="params">(<span class="keyword">int</span> userid, string msg)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理用户连接关闭的情况</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clientConnClose</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr&amp; conn)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理服务器退出（Ctrl+C）后的业务重置</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// 私有构造函数</span></span><br><span class="line">    <span class="built_in">ChatService</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除拷贝构造函数</span></span><br><span class="line">    <span class="built_in">ChatService</span>(<span class="keyword">const</span> ChatService&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除赋值运算符</span></span><br><span class="line">    ChatService&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> ChatService&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关联消息ID和消息处理器（用于解耦业务代码）</span></span><br><span class="line">    unordered_map&lt;<span class="keyword">int</span>, MsgHandler&gt; _msgHandlerMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存储在线用户的通信连接（操作时必须自行保证线程安全）</span></span><br><span class="line">    unordered_map&lt;<span class="keyword">int</span>, TcpConnectionPtr&gt; _userConnMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 互斥锁，保证 _userConnMap 的线程安全</span></span><br><span class="line">    mutex _connMapmutex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// User 表的数据操作对象</span></span><br><span class="line">    UserModel _userModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// OfflineMessage 表的数据操作对象</span></span><br><span class="line">    OfflineMessageModel _offflineMessageModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Friend 表的数据操作对象</span></span><br><span class="line">    FriendModel _friendModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Group 表的数据操作对象</span></span><br><span class="line">    GroupModel _groupModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// GroupUser 表的数据操作对象</span></span><br><span class="line">    GroupUserModel _groupUserModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Redis 操作对象</span></span><br><span class="line">    Redis _redis;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// CHATSERVICE_H</span></span></span><br></pre></td></tr></tbody></table></figure><ul><li><code>src/server/chatservice.cpp</code> 源文件</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 聊天服务器的业务实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"chatservice.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;muduo/base/Logging.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"friendmodel.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"offlinemessagemodel.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"public.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"times.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"usermodel.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造函数</span></span><br><span class="line">ChatService::<span class="built_in">ChatService</span>() {</span><br><span class="line">    <span class="comment">// 连接Redis服务器</span></span><br><span class="line">    <span class="keyword">if</span> (_redis.<span class="built_in">connect</span>()) {</span><br><span class="line">        <span class="comment">// 设置Redis订阅通道的回调对象（负责处理Redis订阅消息）</span></span><br><span class="line">        _redis.<span class="built_in">init_notify_handler</span>(</span><br><span class="line">            <span class="built_in">bind</span>(&amp;ChatService::handleRedisSubScribeMessage, <span class="keyword">this</span>, placeholders::_1, placeholders::_2));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关联登录业务</span></span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(</span><br><span class="line">        {MsgType::LOGIN_MSG, <span class="built_in">bind</span>(&amp;ChatService::login, <span class="keyword">this</span>, placeholders::_1, placeholders::_2, placeholders::_3)});</span><br><span class="line">    <span class="comment">// 关联注册业务</span></span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(</span><br><span class="line">        {MsgType::REGISTER_MSG, <span class="built_in">bind</span>(&amp;ChatService::reg, <span class="keyword">this</span>, placeholders::_1, placeholders::_2, placeholders::_3)});</span><br><span class="line">    <span class="comment">// 关联一对一聊天业务</span></span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>({MsgType::SINGLE_CHAT_MSG,</span><br><span class="line">                           <span class="built_in">bind</span>(&amp;ChatService::singleChat, <span class="keyword">this</span>, placeholders::_1, placeholders::_2, placeholders::_3)});</span><br><span class="line">    <span class="comment">// 关联添加好友业务</span></span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>({MsgType::ADD_FRIEND_MSG,</span><br><span class="line">                           <span class="built_in">bind</span>(&amp;ChatService::addFriend, <span class="keyword">this</span>, placeholders::_1, placeholders::_2, placeholders::_3)});</span><br><span class="line">    <span class="comment">// 关联添加群组业务</span></span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>({MsgType::CREATE_GROUP_MSG, <span class="built_in">bind</span>(&amp;ChatService::createGroup, <span class="keyword">this</span>, placeholders::_1,</span><br><span class="line">                                                           placeholders::_2, placeholders::_3)});</span><br><span class="line">    <span class="comment">// 关联加入群组业务</span></span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>({MsgType::JOIN_GROUP_MSG,</span><br><span class="line">                           <span class="built_in">bind</span>(&amp;ChatService::joinGroup, <span class="keyword">this</span>, placeholders::_1, placeholders::_2, placeholders::_3)});</span><br><span class="line">    <span class="comment">// 关联群聊天业务</span></span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>({MsgType::GROUP_CHAT_MSG,</span><br><span class="line">                           <span class="built_in">bind</span>(&amp;ChatService::groupChat, <span class="keyword">this</span>, placeholders::_1, placeholders::_2, placeholders::_3)});</span><br><span class="line">    <span class="comment">// 关联退出登录业务</span></span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>({MsgType::LOGIN_OUT_MSG,</span><br><span class="line">                           <span class="built_in">bind</span>(&amp;ChatService::loginOut, <span class="keyword">this</span>, placeholders::_1, placeholders::_2, placeholders::_3)});</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取单例对象</span></span><br><span class="line"><span class="function">ChatService* <span class="title">ChatService::instance</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// 局部静态变量（线程安全）</span></span><br><span class="line">    <span class="keyword">static</span> ChatService instance;</span><br><span class="line">    <span class="keyword">return</span> &amp;instance;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取消息对应的处理器</span></span><br><span class="line"><span class="function">MsgHandler <span class="title">ChatService::getMsgHandler</span><span class="params">(<span class="keyword">int</span> msgType)</span> </span>{</span><br><span class="line">    <span class="comment">// 查找消息处理器</span></span><br><span class="line">    <span class="keyword">auto</span> it = _msgHandlerMap.<span class="built_in">find</span>(msgType);</span><br><span class="line">    <span class="comment">// 如果消息处理器不存在</span></span><br><span class="line">    <span class="keyword">if</span> (it == _msgHandlerMap.<span class="built_in">end</span>()) {</span><br><span class="line">        <span class="comment">// 返回一个默认的消息处理器（空操作）</span></span><br><span class="line">        <span class="keyword">return</span> [=](<span class="keyword">const</span> TcpConnectionPtr&amp; conn, <span class="keyword">const</span> shared_ptr&lt;json&gt;&amp; data, Timestamp time) {</span><br><span class="line">            <span class="comment">// 打印日志信息</span></span><br><span class="line">            LOG_ERROR &lt;&lt; <span class="string">"not found message handler by message type "</span> &lt;&lt; msgType;</span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> _msgHandlerMap[msgType];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理Redis订阅通道中发生的消息</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ChatService::handleRedisSubScribeMessage</span><span class="params">(<span class="keyword">int</span> userid, string msg)</span> </span>{</span><br><span class="line">    <span class="comment">// JSON 反序列化</span></span><br><span class="line">    json js = json::<span class="built_in">parse</span>(msg.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消息发送的时间</span></span><br><span class="line">    <span class="keyword">long</span> timestamp = js[<span class="string">"fromTimestamp"</span>].get&lt;<span class="keyword">long</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取互斥锁</span></span><br><span class="line">    <span class="function">unique_lock&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMapmutex)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取消息接收者的连接信息</span></span><br><span class="line">    <span class="keyword">auto</span> it = _userConnMap.<span class="built_in">find</span>(userid);</span><br><span class="line">    <span class="keyword">if</span> (it != _userConnMap.<span class="built_in">end</span>()) {</span><br><span class="line">        <span class="comment">// 消息接收者在线（指在当前聊天服务器中），直接转发消息</span></span><br><span class="line">        it-&gt;second-&gt;<span class="built_in">send</span>(js.<span class="built_in">dump</span>());</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// 当接收到Redis订阅消息时，如果消息接收者刚好下线，则存储离线消息</span></span><br><span class="line">        OfflineMessage <span class="built_in">msg</span>(userid, js.<span class="built_in">dump</span>(), timestamp);</span><br><span class="line">        _offflineMessageModel.<span class="built_in">insert</span>(msg);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理登录业务</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ChatService::login</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr&amp; conn, <span class="keyword">const</span> shared_ptr&lt;json&gt;&amp; data, Timestamp time)</span> </span>{</span><br><span class="line">    string name = (*data)[<span class="string">"name"</span>].get&lt;string&gt;();</span><br><span class="line">    string password = (*data)[<span class="string">"password"</span>].get&lt;string&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询用户信息</span></span><br><span class="line">    User user = _userModel.<span class="built_in">selectByName</span>(name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 登录成功</span></span><br><span class="line">    <span class="keyword">if</span> (user.<span class="built_in">getId</span>() != <span class="number">-1</span> &amp;&amp; user.<span class="built_in">getPassword</span>() == password) {</span><br><span class="line">        <span class="comment">// 重复登录</span></span><br><span class="line">        <span class="keyword">if</span> (user.<span class="built_in">getState</span>() == <span class="string">"online"</span>) {</span><br><span class="line">            <span class="comment">// 返回数据给客户端</span></span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">"errNum"</span>] = ErrorCode::REPEAT_LOGIN;</span><br><span class="line">            response[<span class="string">"errMsg"</span>] = <span class="string">"该账号在其他设备已登录"</span>;</span><br><span class="line">            response[<span class="string">"msgType"</span>] = MsgType::LOGIN_MSG_ACK;</span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>());</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 登录成功</span></span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 获取互斥锁</span></span><br><span class="line">            unique_lock&lt;mutex&gt; <span class="built_in">lock</span>(_connMapmutex);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 存储在线用户的通信连接</span></span><br><span class="line">            _userConnMap.<span class="built_in">insert</span>({user.<span class="built_in">getId</span>(), conn});</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 释放互斥锁</span></span><br><span class="line">            lock.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 向Redis订阅Channel</span></span><br><span class="line">            _redis.<span class="built_in">subscribe</span>(user.<span class="built_in">getId</span>());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 更新用户登录状态</span></span><br><span class="line">            user.<span class="built_in">setState</span>(<span class="string">"online"</span>);</span><br><span class="line">            _userModel.<span class="built_in">updateState</span>(user);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回给客户端的数据</span></span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">"errNum"</span>] = ErrorCode::SUCCESS;</span><br><span class="line">            response[<span class="string">"userId"</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">            response[<span class="string">"userName"</span>] = user.<span class="built_in">getName</span>();</span><br><span class="line">            response[<span class="string">"msgType"</span>] = MsgType::LOGIN_MSG_ACK;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 查询该用户是否有离线消息</span></span><br><span class="line">            vector&lt;OfflineMessage&gt; messages = _offflineMessageModel.<span class="built_in">select</span>(user.<span class="built_in">getId</span>());</span><br><span class="line">            <span class="keyword">if</span> (!messages.<span class="built_in">empty</span>()) {</span><br><span class="line">                <span class="comment">// 返回该用户的所有离线消息</span></span><br><span class="line">                response[<span class="string">"offlinemsg"</span>] = messages;</span><br><span class="line">                <span class="comment">// 读取该用户的离线消息后，将该用户的离线消息全部删除掉</span></span><br><span class="line">                _offflineMessageModel.<span class="built_in">remove</span>(user.<span class="built_in">getId</span>());</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 查询该用户的好友列表</span></span><br><span class="line">            vector&lt;User&gt; friends = _friendModel.<span class="built_in">select</span>(user.<span class="built_in">getId</span>());</span><br><span class="line">            <span class="keyword">if</span> (!friends.<span class="built_in">empty</span>()) {</span><br><span class="line">                <span class="comment">// 返回该用户的好友列表</span></span><br><span class="line">                response[<span class="string">"friends"</span>] = friends;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 查询该用户的群组列表</span></span><br><span class="line">            vector&lt;Group&gt; groups = _groupUserModel.<span class="built_in">select</span>(user.<span class="built_in">getId</span>());</span><br><span class="line">            <span class="keyword">if</span> (!groups.<span class="built_in">empty</span>()) {</span><br><span class="line">                response[<span class="string">"groups"</span>] = groups;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回数据给客户端</span></span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 登录失败</span></span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// 返回数据给客户端</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">"errNum"</span>] = ErrorCode::LOGIN_AUTH_FAIL;</span><br><span class="line">        response[<span class="string">"errMsg"</span>] = <span class="string">"用户名或密码不正确"</span>;</span><br><span class="line">        response[<span class="string">"msgType"</span>] = MsgType::LOGIN_MSG_ACK;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>());</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理注册业务</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ChatService::reg</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr&amp; conn, <span class="keyword">const</span> shared_ptr&lt;json&gt;&amp; data, Timestamp time)</span> </span>{</span><br><span class="line">    <span class="comment">// 创建用户对象</span></span><br><span class="line">    string name = (*data)[<span class="string">"name"</span>].get&lt;string&gt;();</span><br><span class="line">    string password = (*data)[<span class="string">"password"</span>].get&lt;string&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询用户名是否已被注册</span></span><br><span class="line">    User oldUser = _userModel.<span class="built_in">selectByName</span>(name);</span><br><span class="line">    <span class="keyword">if</span> (oldUser.<span class="built_in">getId</span>() != <span class="number">-1</span>) {</span><br><span class="line">        <span class="comment">// 返回数据给客户端</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">"errNum"</span>] = ErrorCode::REPEAT_REGISTER;</span><br><span class="line">        response[<span class="string">"errMsg"</span>] = <span class="string">"用户名已被注册"</span>;</span><br><span class="line">        response[<span class="string">"msgType"</span>] = MsgType::REGISTER_MSG_ACK;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入用户记录</span></span><br><span class="line">    <span class="function">User <span class="title">newUser</span><span class="params">(name, password)</span></span>;</span><br><span class="line">    <span class="keyword">bool</span> result = _userModel.<span class="built_in">insert</span>(newUser);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入用户记录成功</span></span><br><span class="line">    <span class="keyword">if</span> (result) {</span><br><span class="line">        <span class="comment">// 返回数据给客户端</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">"errNum"</span>] = ErrorCode::SUCCESS;</span><br><span class="line">        response[<span class="string">"userId"</span>] = newUser.<span class="built_in">getId</span>();</span><br><span class="line">        response[<span class="string">"userName"</span>] = newUser.<span class="built_in">getName</span>();</span><br><span class="line">        response[<span class="string">"msgType"</span>] = MsgType::REGISTER_MSG_ACK;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>());</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 插入用户记录失败</span></span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// 返回数据给客户端</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">"errNum"</span>] = ErrorCode::REGISTER_FAIL;</span><br><span class="line">        response[<span class="string">"errMsg"</span>] = <span class="string">"用户注册失败"</span>;</span><br><span class="line">        response[<span class="string">"msgType"</span>] = MsgType::REGISTER_MSG_ACK;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>());</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理一对一聊天消息</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ChatService::singleChat</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr&amp; conn, <span class="keyword">const</span> shared_ptr&lt;json&gt;&amp; data, Timestamp time)</span> </span>{</span><br><span class="line">    <span class="comment">// 消息发送者的用户ID</span></span><br><span class="line">    <span class="keyword">int</span> fromId = (*data)[<span class="string">"fromId"</span>].get&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消息发送者的用户名称</span></span><br><span class="line">    string fromName = (*data)[<span class="string">"fromName"</span>].get&lt;string&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消息发送者的消息内容</span></span><br><span class="line">    string fromMsg = (*data)[<span class="string">"fromMsg"</span>].get&lt;string&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消息发送的时间戳</span></span><br><span class="line">    <span class="keyword">long</span> fromTimestamp = (*data)[<span class="string">"fromTimestamp"</span>].get&lt;<span class="keyword">long</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消息接收者的用户ID</span></span><br><span class="line">    <span class="keyword">int</span> toId = (*data)[<span class="string">"toId"</span>].get&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消息接收者是否在当前聊天服务器中</span></span><br><span class="line">    <span class="keyword">bool</span> toExisted = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断是否已经添加消息接收者为好友</span></span><br><span class="line">    Friend friendRel = _friendModel.<span class="built_in">select</span>(fromId, toId);</span><br><span class="line">    <span class="keyword">if</span> (friendRel.<span class="built_in">getUserId</span>() == <span class="number">-1</span> || friendRel.<span class="built_in">getFriendId</span>() == <span class="number">-1</span>) {</span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">"errNum"</span>] = ErrorCode::SINGLE_CHAT_FAIL;</span><br><span class="line">        response[<span class="string">"errMsg"</span>] = <span class="string">"未添加对方好友, 无法进行一对一聊天"</span>;</span><br><span class="line">        response[<span class="string">"msgType"</span>] = MsgType::SINGLE_CHAT_MSG_ACK;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取互斥锁</span></span><br><span class="line">    <span class="function">unique_lock&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMapmutex)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取消息接收者的连接信息</span></span><br><span class="line">    <span class="keyword">auto</span> it = _userConnMap.<span class="built_in">find</span>(toId);</span><br><span class="line">    <span class="keyword">if</span> (it != _userConnMap.<span class="built_in">end</span>()) {</span><br><span class="line">        <span class="comment">// 记录消息接收者在线（指在当前聊天服务器中）</span></span><br><span class="line">        toExisted = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// 消息接收者在线（指在当前聊天服务器中），直接转发消息</span></span><br><span class="line">        it-&gt;second-&gt;<span class="built_in">send</span>((*data).<span class="built_in">dump</span>());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放互斥锁</span></span><br><span class="line">    lock.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消息接收者不在当前聊天服务器中</span></span><br><span class="line">    <span class="keyword">if</span> (!toExisted) {</span><br><span class="line">        User toUser = _userModel.<span class="built_in">select</span>(toId);</span><br><span class="line">        <span class="comment">// 判断消息接收者是否在线（指在其他聊天服务器中）</span></span><br><span class="line">        <span class="keyword">if</span> (toUser.<span class="built_in">getState</span>() == <span class="string">"online"</span>) {</span><br><span class="line">            <span class="comment">// 消息接收者在线，通过Redis发布消息</span></span><br><span class="line">            _redis.<span class="built_in">publish</span>(toId, (*data).<span class="built_in">dump</span>());</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 消息接收者不在线，存储离线消息</span></span><br><span class="line">            OfflineMessage <span class="built_in">msg</span>(toId, (*data).<span class="built_in">dump</span>(), fromTimestamp);</span><br><span class="line">            _offflineMessageModel.<span class="built_in">insert</span>(msg);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回数据给客户端</span></span><br><span class="line">    json response;</span><br><span class="line">    response[<span class="string">"errNum"</span>] = ErrorCode::SUCCESS;</span><br><span class="line">    response[<span class="string">"msgType"</span>] = MsgType::SINGLE_CHAT_MSG_ACK;</span><br><span class="line">    conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理添加好友消息</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ChatService::addFriend</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr&amp; conn, <span class="keyword">const</span> shared_ptr&lt;json&gt;&amp; data, Timestamp time)</span> </span>{</span><br><span class="line">    <span class="comment">// 当前用户的ID</span></span><br><span class="line">    <span class="keyword">int</span> userId = (*data)[<span class="string">"userId"</span>].get&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 好友的用户ID</span></span><br><span class="line">    <span class="keyword">int</span> friendId = (*data)[<span class="string">"friendId"</span>].get&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 控制不允许添加自己为好友</span></span><br><span class="line">    <span class="keyword">if</span> (userId == friendId) {</span><br><span class="line">        <span class="comment">// 返回数据给客户端</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">"errNum"</span>] = ErrorCode::ADD_FRIEND_FAIL;</span><br><span class="line">        response[<span class="string">"errMsg"</span>] = <span class="string">"不允许添加自己为好友"</span>;</span><br><span class="line">        response[<span class="string">"msgType"</span>] = MsgType::ADD_FRIEND_MSG_ACK;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断好友是否真实存在</span></span><br><span class="line">    User friendUser = _userModel.<span class="built_in">select</span>(friendId);</span><br><span class="line">    <span class="keyword">if</span> (friendUser.<span class="built_in">getId</span>() == <span class="number">-1</span>) {</span><br><span class="line">        <span class="comment">// 返回数据给客户端</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">"errNum"</span>] = ErrorCode::ADD_FRIEND_FAIL;</span><br><span class="line">        response[<span class="string">"errMsg"</span>] = <span class="string">"好友ID不存在"</span>;</span><br><span class="line">        response[<span class="string">"msgType"</span>] = MsgType::ADD_FRIEND_MSG_ACK;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新增好友关系</span></span><br><span class="line">    _friendModel.<span class="built_in">insert</span>(userId, friendId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回数据给客户端</span></span><br><span class="line">    json response;</span><br><span class="line">    response[<span class="string">"errNum"</span>] = ErrorCode::SUCCESS;</span><br><span class="line">    response[<span class="string">"msgType"</span>] = MsgType::ADD_FRIEND_MSG_ACK;</span><br><span class="line">    conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理创建群组消息</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ChatService::createGroup</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr&amp; conn, <span class="keyword">const</span> shared_ptr&lt;json&gt;&amp; data, Timestamp time)</span> </span>{</span><br><span class="line">    <span class="comment">// 当前用户的ID</span></span><br><span class="line">    <span class="keyword">int</span> userId = (*data)[<span class="string">"userId"</span>].get&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 群组名称</span></span><br><span class="line">    string groupName = (*data)[<span class="string">"groupName"</span>].get&lt;string&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 群组描述</span></span><br><span class="line">    string groupDesc = (*data)[<span class="string">"groupDesc"</span>].get&lt;string&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新增群组</span></span><br><span class="line">    <span class="function">Group <span class="title">group</span><span class="params">(groupName, groupDesc)</span></span>;</span><br><span class="line">    <span class="keyword">bool</span> result = _groupModel.<span class="built_in">insert</span>(group);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加群组的创建人信息</span></span><br><span class="line">    <span class="keyword">if</span> (result &amp;&amp; group.<span class="built_in">getId</span>() != <span class="number">-1</span>) {</span><br><span class="line">        GroupUser groupUser;</span><br><span class="line">        groupUser.<span class="built_in">setGroupId</span>(group.<span class="built_in">getId</span>());</span><br><span class="line">        groupUser.<span class="built_in">setUserId</span>(userId);</span><br><span class="line">        groupUser.<span class="built_in">setGroupRole</span>(<span class="string">"creator"</span>);</span><br><span class="line">        <span class="comment">// 新增群组和用户的关联信息</span></span><br><span class="line">        _groupUserModel.<span class="built_in">insert</span>(groupUser);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回数据给客户端</span></span><br><span class="line">    json response;</span><br><span class="line">    response[<span class="string">"errNum"</span>] = ErrorCode::SUCCESS;</span><br><span class="line">    response[<span class="string">"groupId"</span>] = group.<span class="built_in">getId</span>();</span><br><span class="line">    response[<span class="string">"msgType"</span>] = MsgType::CREATE_GROUP_MSG_ACK;</span><br><span class="line">    conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理加入群组消息</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ChatService::joinGroup</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr&amp; conn, <span class="keyword">const</span> shared_ptr&lt;json&gt;&amp; data, Timestamp time)</span> </span>{</span><br><span class="line">    <span class="comment">// 当前用户的ID</span></span><br><span class="line">    <span class="keyword">int</span> userId = (*data)[<span class="string">"userId"</span>].get&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 群组ID</span></span><br><span class="line">    <span class="keyword">int</span> groupId = (*data)[<span class="string">"groupId"</span>].get&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断群组是否真实存在</span></span><br><span class="line">    Group group = _groupModel.<span class="built_in">select</span>(groupId);</span><br><span class="line">    <span class="keyword">if</span> (group.<span class="built_in">getId</span>() == <span class="number">-1</span>) {</span><br><span class="line">        <span class="comment">// 返回数据给客户端</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">"errNum"</span>] = ErrorCode::JOIN_GROUP_FAIL;</span><br><span class="line">        response[<span class="string">"errMsg"</span>] = <span class="string">"群组ID不存在"</span>;</span><br><span class="line">        response[<span class="string">"msgType"</span>] = MsgType::JOIN_GROUP_MSG_ACK;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新增群组和用户的关联信息</span></span><br><span class="line">    <span class="function">GroupUser <span class="title">groupUser</span><span class="params">(groupId, userId, <span class="string">"normal"</span>)</span></span>;</span><br><span class="line">    _groupUserModel.<span class="built_in">insert</span>(groupUser);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回数据给客户端</span></span><br><span class="line">    json response;</span><br><span class="line">    response[<span class="string">"errNum"</span>] = ErrorCode::SUCCESS;</span><br><span class="line">    response[<span class="string">"msgType"</span>] = MsgType::JOIN_GROUP_MSG_ACK;</span><br><span class="line">    conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理群聊天消息</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ChatService::groupChat</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr&amp; conn, <span class="keyword">const</span> shared_ptr&lt;json&gt;&amp; data, Timestamp time)</span> </span>{</span><br><span class="line">    <span class="comment">// 消息发送者的用户ID</span></span><br><span class="line">    <span class="keyword">int</span> fromId = (*data)[<span class="string">"fromId"</span>].get&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消息发送者的用户名称</span></span><br><span class="line">    string fromName = (*data)[<span class="string">"fromName"</span>].get&lt;string&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消息发送的时间戳</span></span><br><span class="line">    <span class="keyword">long</span> fromTimestamp = (*data)[<span class="string">"fromTimestamp"</span>].get&lt;<span class="keyword">long</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 群组的ID</span></span><br><span class="line">    <span class="keyword">int</span> groupId = (*data)[<span class="string">"groupId"</span>].get&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 群组消息的内容</span></span><br><span class="line">    string groupMsg = (*data)[<span class="string">"groupMsg"</span>].get&lt;string&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断用户是否已经加入群组</span></span><br><span class="line">    GroupUser groupUser = _groupUserModel.<span class="built_in">select</span>(groupId, fromId);</span><br><span class="line">    <span class="keyword">if</span> (groupUser.<span class="built_in">getGroupId</span>() == <span class="number">-1</span> || groupUser.<span class="built_in">getUserId</span>() == <span class="number">-1</span>) {</span><br><span class="line">        <span class="comment">// 返回数据给客户端</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">"errNum"</span>] = ErrorCode::JOIN_GROUP_FAIL;</span><br><span class="line">        response[<span class="string">"errMsg"</span>] = <span class="string">"未加入该群组, 无法进行群聊"</span>;</span><br><span class="line">        response[<span class="string">"msgType"</span>] = MsgType::JOIN_GROUP_MSG_ACK;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询群组内的用户（除了发送群组消息的用户）</span></span><br><span class="line">    vector&lt;User&gt; users = _groupUserModel.<span class="built_in">selectGroupUsers</span>(groupId, fromId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理群聊消息</span></span><br><span class="line">    <span class="keyword">if</span> (!users.<span class="built_in">empty</span>()) {</span><br><span class="line">        <span class="comment">// 获取互斥锁</span></span><br><span class="line">        unique_lock&lt;mutex&gt; lock;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历群组内的用户</span></span><br><span class="line">        <span class="keyword">for</span> (User&amp; user : users) {</span><br><span class="line">            <span class="comment">// 获取用户的连接信息</span></span><br><span class="line">            <span class="keyword">auto</span> it = _userConnMap.<span class="built_in">find</span>(user.<span class="built_in">getId</span>());</span><br><span class="line">            <span class="keyword">if</span> (it != _userConnMap.<span class="built_in">end</span>()) {</span><br><span class="line">                <span class="comment">// 用户在线（指在当前聊天服务器中），直接转发群聊消息</span></span><br><span class="line">                it-&gt;second-&gt;<span class="built_in">send</span>((*data).<span class="built_in">dump</span>());</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                User toUser = _userModel.<span class="built_in">select</span>(user.<span class="built_in">getId</span>());</span><br><span class="line">                <span class="comment">// 判断用户是否在线（指在其他聊天服务器中）</span></span><br><span class="line">                <span class="keyword">if</span> (toUser.<span class="built_in">getState</span>() == <span class="string">"online"</span>) {</span><br><span class="line">                    <span class="comment">// 用户在线，通过Redis发布群聊消息</span></span><br><span class="line">                    _redis.<span class="built_in">publish</span>(user.<span class="built_in">getId</span>(), (*data).<span class="built_in">dump</span>());</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="comment">// 用户不在线，存储离线群聊消息</span></span><br><span class="line">                    OfflineMessage message;</span><br><span class="line">                    message.<span class="built_in">setUserId</span>(user.<span class="built_in">getId</span>());</span><br><span class="line">                    message.<span class="built_in">setCreateTime</span>(fromTimestamp);</span><br><span class="line">                    message.<span class="built_in">setMessage</span>((*data).<span class="built_in">dump</span>());</span><br><span class="line">                    _offflineMessageModel.<span class="built_in">insert</span>(message);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回数据给客户端</span></span><br><span class="line">    json response;</span><br><span class="line">    response[<span class="string">"errNum"</span>] = ErrorCode::SUCCESS;</span><br><span class="line">    response[<span class="string">"msgType"</span>] = MsgType::GROUP_CHAT_MSG_ACK;</span><br><span class="line">    conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理退出登录消息</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ChatService::loginOut</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr&amp; conn, <span class="keyword">const</span> shared_ptr&lt;json&gt;&amp; data, Timestamp time)</span> </span>{</span><br><span class="line">    <span class="comment">// 当前用户的ID</span></span><br><span class="line">    <span class="keyword">int</span> userId = (*data)[<span class="string">"userId"</span>].get&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取互斥锁</span></span><br><span class="line">    <span class="function">unique_lock&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMapmutex)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 移除连接信息</span></span><br><span class="line">    <span class="keyword">auto</span> it = _userConnMap.<span class="built_in">find</span>(userId);</span><br><span class="line">    <span class="keyword">if</span> (it != _userConnMap.<span class="built_in">end</span>()) {</span><br><span class="line">        _userConnMap.<span class="built_in">erase</span>(it-&gt;first);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放互斥锁</span></span><br><span class="line">    lock.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 往Redis取消订阅Channel</span></span><br><span class="line">    _redis.<span class="built_in">unsubscribe</span>(userId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新用户的登录状态</span></span><br><span class="line">    User user;</span><br><span class="line">    user.<span class="built_in">setId</span>(userId);</span><br><span class="line">    user.<span class="built_in">setState</span>(<span class="string">"offline"</span>);</span><br><span class="line">    _userModel.<span class="built_in">updateState</span>(user);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回数据给客户端</span></span><br><span class="line">    json response;</span><br><span class="line">    response[<span class="string">"errNum"</span>] = ErrorCode::SUCCESS;</span><br><span class="line">    response[<span class="string">"msgType"</span>] = MsgType::LOGIN_OUT_MSG_ACK;</span><br><span class="line">    conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理用户连接关闭的情况</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ChatService::clientConnClose</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr&amp; conn)</span> </span>{</span><br><span class="line">    <span class="comment">// 用户信息</span></span><br><span class="line">    User user;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取互斥锁</span></span><br><span class="line">    <span class="function">unique_lock&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMapmutex)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从Map表中删除用户对应的连接信息</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> it = _userConnMap.<span class="built_in">begin</span>(); it != _userConnMap.<span class="built_in">end</span>(); ++it) {</span><br><span class="line">        <span class="keyword">if</span> (it-&gt;second == conn) {</span><br><span class="line">            <span class="comment">// 记录用户ID</span></span><br><span class="line">            user.<span class="built_in">setId</span>(it-&gt;first);</span><br><span class="line">            <span class="comment">// 移除连接信息</span></span><br><span class="line">            _userConnMap.<span class="built_in">erase</span>(it-&gt;first);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放互斥锁</span></span><br><span class="line">    lock.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (user.<span class="built_in">getId</span>() != <span class="number">-1</span>) {</span><br><span class="line">        <span class="comment">// 往Redis取消订阅Channel</span></span><br><span class="line">        _redis.<span class="built_in">unsubscribe</span>(user.<span class="built_in">getId</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新用户的登录状态</span></span><br><span class="line">        user.<span class="built_in">setState</span>(<span class="string">"offline"</span>);</span><br><span class="line">        _userModel.<span class="built_in">updateState</span>(user);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理服务器退出（Ctrl+C）后的业务重置</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ChatService::reset</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// 重置所有用户的登录状态</span></span><br><span class="line">    _userModel.<span class="built_in">resetState</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><blockquote><p>数据库业务操作的代码</p></blockquote><ul><li><code>include/server/dao/friendmodel.hpp</code> 头文件</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> FRIENDMODEL_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FRIENDMODEL_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"friend.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"user.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Friend 表的数据操作类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FriendModel</span> {</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 添加好友关系</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> userid, <span class="keyword">int</span> friendid)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查找好友列表</span></span><br><span class="line">    <span class="function">vector&lt;User&gt; <span class="title">select</span><span class="params">(<span class="keyword">int</span> userid)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查找好友关系</span></span><br><span class="line">    <span class="function">Friend <span class="title">select</span><span class="params">(<span class="keyword">int</span> userid, <span class="keyword">int</span> friendid)</span></span>;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// FRIENDMODEL_H</span></span></span><br></pre></td></tr></tbody></table></figure><ul><li><code>src/server/dao/friendmodel.cpp</code> 源文件</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;friendmodel.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"db.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加好友关系</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FriendModel::insert</span><span class="params">(<span class="keyword">int</span> userid, <span class="keyword">int</span> friendid)</span> </span>{</span><br><span class="line">    <span class="keyword">char</span> sql[<span class="number">1024</span>] = {<span class="number">0</span>};</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拼接 SQL 语句</span></span><br><span class="line">    <span class="built_in">sprintf</span>(sql, <span class="string">"insert into friend(userid, friendid) values(%d, %d)"</span>, userid, friendid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行 SQL 语句</span></span><br><span class="line">    MySQL mysql;</span><br><span class="line">    <span class="keyword">if</span> (mysql.<span class="built_in">connect</span>() &amp;&amp; mysql.<span class="built_in">update</span>(sql)) {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查找好友列表</span></span><br><span class="line"><span class="function">vector&lt;User&gt; <span class="title">FriendModel::select</span><span class="params">(<span class="keyword">int</span> userid)</span> </span>{</span><br><span class="line">    <span class="keyword">char</span> sql[<span class="number">1024</span>] = {<span class="number">0</span>};</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询结果</span></span><br><span class="line">    vector&lt;User&gt; result;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拼接 SQL 语句</span></span><br><span class="line">    <span class="built_in">sprintf</span>(sql,</span><br><span class="line">            <span class="string">"select u.id, u.name, u.state from friend f inner join user u on f.friendid = u.id where f.userid = %d"</span>,</span><br><span class="line">            userid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行 SQL 语句</span></span><br><span class="line">    MySQL mysql;</span><br><span class="line">    <span class="keyword">if</span> (mysql.<span class="built_in">connect</span>()) {</span><br><span class="line">        MYSQL_RES* res = mysql.<span class="built_in">query</span>(sql);</span><br><span class="line">        <span class="keyword">if</span> (res != <span class="literal">nullptr</span> &amp;&amp; <span class="built_in">mysql_num_rows</span>(res) &gt; <span class="number">0</span>) {</span><br><span class="line">            <span class="comment">// 获取所有查询结果</span></span><br><span class="line">            MYSQL_ROW row;</span><br><span class="line">            <span class="keyword">while</span> ((row = <span class="built_in">mysql_fetch_row</span>(res)) != <span class="literal">nullptr</span>) {</span><br><span class="line">                <span class="keyword">int</span> id = <span class="built_in">atoi</span>(row[<span class="number">0</span>]);</span><br><span class="line">                string name = row[<span class="number">1</span>];</span><br><span class="line">                string state = row[<span class="number">2</span>];</span><br><span class="line">                result.<span class="built_in">emplace_back</span>(id, name, state);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 释放资源</span></span><br><span class="line">        <span class="built_in">mysql_free_result</span>(res);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回查询结果</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查找好友关系</span></span><br><span class="line"><span class="function">Friend <span class="title">FriendModel::select</span><span class="params">(<span class="keyword">int</span> userid, <span class="keyword">int</span> friendid)</span> </span>{</span><br><span class="line">    <span class="keyword">char</span> sql[<span class="number">1024</span>] = {<span class="number">0</span>};</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询结果</span></span><br><span class="line">    Friend result;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拼接 SQL 语句</span></span><br><span class="line">    <span class="built_in">sprintf</span>(sql, <span class="string">"select userid, friendid from friend where userid = %d and friendid = %d"</span>, userid, friendid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行 SQL 语句</span></span><br><span class="line">    MySQL mysql;</span><br><span class="line">    <span class="keyword">if</span> (mysql.<span class="built_in">connect</span>()) {</span><br><span class="line">        MYSQL_RES* res = mysql.<span class="built_in">query</span>(sql);</span><br><span class="line">        <span class="keyword">if</span> (res != <span class="literal">nullptr</span> &amp;&amp; <span class="built_in">mysql_num_rows</span>(res) &gt; <span class="number">0</span>) {</span><br><span class="line">            <span class="comment">// 获取所有查询结果</span></span><br><span class="line">            MYSQL_ROW row = <span class="built_in">mysql_fetch_row</span>(res);</span><br><span class="line">            result.<span class="built_in">setUserId</span>(<span class="built_in">atoi</span>(row[<span class="number">0</span>]));</span><br><span class="line">            result.<span class="built_in">setFriendId</span>(<span class="built_in">atoi</span>(row[<span class="number">1</span>]));</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 释放资源</span></span><br><span class="line">        <span class="built_in">mysql_free_result</span>(res);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回查询结果</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><blockquote><p>通信数据格式定义（基于 Json 序列化和反序列化）</p></blockquote><ul><li>用户注册</li></ul><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">{<span class="attr">"msgType"</span>: <span class="number">3</span>, <span class="attr">"name"</span>: <span class="string">"jim"</span>, <span class="attr">"password"</span>: <span class="string">"12345"</span>}</span><br><span class="line"></span><br><span class="line">{<span class="attr">"msgType"</span>: <span class="number">3</span>, <span class="attr">"name"</span>: <span class="string">"tom"</span>, <span class="attr">"password"</span>: <span class="string">"12345"</span>}</span><br></pre></td></tr></tbody></table></figure><ul><li>用户登录</li></ul><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">{<span class="attr">"msgType"</span>: <span class="number">1</span>, <span class="attr">"name"</span>: <span class="string">"jim"</span>, <span class="attr">"password"</span>: <span class="string">"12345"</span>}</span><br><span class="line"></span><br><span class="line">{<span class="attr">"msgType"</span>: <span class="number">1</span>, <span class="attr">"name"</span>: <span class="string">"tom"</span>, <span class="attr">"password"</span>: <span class="string">"12345"</span>}</span><br></pre></td></tr></tbody></table></figure><ul><li>添加好友</li></ul><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">{<span class="attr">"msgType"</span>: <span class="number">7</span>, <span class="attr">"userId"</span>: <span class="number">22</span>, <span class="attr">"friendId"</span>: <span class="number">23</span>}</span><br><span class="line"></span><br><span class="line">{<span class="attr">"msgType"</span>: <span class="number">7</span>, <span class="attr">"userId"</span>: <span class="number">23</span>, <span class="attr">"friendId"</span>: <span class="number">22</span>}</span><br></pre></td></tr></tbody></table></figure><ul><li>发送一对一聊天消息</li></ul><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">{<span class="attr">"msgType"</span>: <span class="number">5</span>, <span class="attr">"fromId"</span>: <span class="number">22</span>, <span class="attr">"fromName"</span>: <span class="string">"jim"</span>, <span class="attr">"fromMsg"</span>: <span class="string">"hello"</span>, <span class="attr">"fromTimestamp"</span>: <span class="number">1748926809683</span>, <span class="attr">"toId"</span>: <span class="number">23</span>}</span><br><span class="line"></span><br><span class="line">{<span class="attr">"msgType"</span>: <span class="number">5</span>, <span class="attr">"fromId"</span>: <span class="number">23</span>, <span class="attr">"fromName"</span>: <span class="string">"tom"</span>, <span class="attr">"fromMsg"</span>: <span class="string">"hello"</span>, <span class="attr">"fromTimestamp"</span>: <span class="number">1748926809785</span>, <span class="attr">"toId"</span>: <span class="number">22</span>}</span><br></pre></td></tr></tbody></table></figure><ul><li>创建群组</li></ul><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="attr">"msgType"</span>: <span class="number">9</span>, <span class="attr">"userId"</span>: <span class="number">22</span>, <span class="attr">"groupName"</span>: <span class="string">"c++"</span>, <span class="attr">"groupDesc"</span>: <span class="string">"c++ study"</span>}</span><br></pre></td></tr></tbody></table></figure><ul><li>加入群组</li></ul><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="attr">"msgType"</span>: <span class="number">11</span>, <span class="attr">"userId"</span>: <span class="number">23</span>, <span class="attr">"groupId"</span>: <span class="number">1</span>}</span><br></pre></td></tr></tbody></table></figure><ul><li>发送群聊消息</li></ul><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">{<span class="attr">"msgType"</span>: <span class="number">13</span>, <span class="attr">"fromId"</span>: <span class="number">22</span>, <span class="attr">"fromName"</span>: <span class="string">"jim"</span>, <span class="attr">"fromTimestamp"</span>: <span class="number">1748926803682</span>, <span class="attr">"groupId"</span>: <span class="number">1</span>, <span class="attr">"groupMsg"</span>: <span class="string">"go to study c++"</span>}</span><br><span class="line"></span><br><span class="line">{<span class="attr">"msgType"</span>: <span class="number">13</span>, <span class="attr">"fromId"</span>: <span class="number">23</span>, <span class="attr">"fromName"</span>: <span class="string">"tom"</span>, <span class="attr">"fromTimestamp"</span>: <span class="number">1748926805372</span>, <span class="attr">"groupId"</span>: <span class="number">1</span>, <span class="attr">"groupMsg"</span>: <span class="string">"go to study rust"</span>}</span><br></pre></td></tr></tbody></table></figure><h5 id="客户端核心代码"><a href="#客户端核心代码" class="headerlink" title="客户端核心代码"></a>客户端核心代码</h5><h6 id="聊天客户端代码"><a href="#聊天客户端代码" class="headerlink" title="聊天客户端代码"></a>聊天客户端代码</h6><div class="admonition note"><p class="admonition-title">提示</p><p>在集群聊天客户端中，使用了 Linux 的 <code>socket</code> 和 <code>semaphore</code>，并没有引入 Muduo 网络库。</p></div><ul><li><code>src/client/main.cpp</code> 源文件</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"group.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"groupmodel.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"json.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"offlinemessage.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"offlinemessagemodel.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"public.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"times.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"user.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"usermodel.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类型重定义</span></span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录当前登录用户的基本信息</span></span><br><span class="line">User g_currentUser;</span><br><span class="line"><span class="comment">// 记录当前登录用户的好友列表信息</span></span><br><span class="line">vector&lt;User&gt; g_currentUserFriendList;</span><br><span class="line"><span class="comment">// 记录当前登录用户的群组列表信息</span></span><br><span class="line">vector&lt;Group&gt; g_currentUserGroupList;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于读/写线程之间的通信</span></span><br><span class="line"><span class="keyword">sem_t</span> rwsem;</span><br><span class="line"><span class="comment">// 控制主菜单程序运行</span></span><br><span class="line"><span class="keyword">bool</span> isMainMenuRunning = <span class="literal">false</span>;</span><br><span class="line"><span class="comment">// 记录用户的登录状态</span></span><br><span class="line"><span class="keyword">atomic_bool</span> g_isLoginSuccess{<span class="literal">false</span>};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主菜单程序</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mainMenu</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="comment">// 子线程接收到消息后的处理逻辑</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readTaskHandler</span><span class="params">(<span class="keyword">int</span> clientfd)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示当前登录用户的基本信息</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">showCurrentUserData</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/////////////////////////////////////////////////////首页功能/////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 聊天客户端程序实现, 主线程用作消息发送线程, 子线程用作消息接收线程</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">3</span>) {</span><br><span class="line">        cerr &lt;&lt; <span class="string">"command invalid, example: ./chat_client 127.0.0.1 8000"</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析通过命令行参数传递的IP和端口号</span></span><br><span class="line">    <span class="keyword">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">uint16_t</span> port = <span class="built_in">atoi</span>(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建client端的socket</span></span><br><span class="line">    <span class="keyword">int</span> clientfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == clientfd) {</span><br><span class="line">        cerr &lt;&lt; <span class="string">"socket create failed"</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 填写client需要连接的服务器信息（IP和端口号）</span></span><br><span class="line">    sockaddr_in server;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;server, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(sockaddr_in));</span><br><span class="line"></span><br><span class="line">    server.sin_family = AF_INET;</span><br><span class="line">    server.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    server.sin_addr.s_addr = <span class="built_in">inet_addr</span>(ip);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// client和server进行连接</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == <span class="built_in">connect</span>(clientfd, (sockaddr *)&amp;server, <span class="built_in"><span class="keyword">sizeof</span></span>(sockaddr_in))) {</span><br><span class="line">        cerr &lt;&lt; <span class="string">"connect server failed"</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">close</span>(clientfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化读写线程通信用的信号量</span></span><br><span class="line">    <span class="built_in">sem_init</span>(&amp;rwsem, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接服务器成功, 启动一个接收消息的子线程</span></span><br><span class="line">    <span class="function">thread <span class="title">readTask</span><span class="params">(readTaskHandler, clientfd)</span></span>;</span><br><span class="line">    readTask.<span class="built_in">detach</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主线程用于接收用户输入, 负责发送数据</span></span><br><span class="line">    <span class="keyword">for</span> (;;) {</span><br><span class="line">        <span class="comment">// 显示首页面菜单: 登录、注册、退出程序</span></span><br><span class="line">        cout &lt;&lt; <span class="string">"========================"</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">"1. login"</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">"2. register"</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">"3. quit"</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">"========================"</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> choice = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 用户输入验证循环</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">            cout &lt;&lt; <span class="string">"choice: "</span>;</span><br><span class="line">            cin &gt;&gt; choice;</span><br><span class="line">            <span class="comment">// 判断输入是否合法</span></span><br><span class="line">            <span class="keyword">if</span> (cin.<span class="built_in">fail</span>()) {</span><br><span class="line">                <span class="comment">// 输入不是整数，清除错误标志</span></span><br><span class="line">                cin.<span class="built_in">clear</span>();</span><br><span class="line">                <span class="comment">// 清空输入缓冲区</span></span><br><span class="line">                cin.<span class="built_in">ignore</span>(<span class="number">10000</span>, <span class="string">'\n'</span>);</span><br><span class="line">                cerr &lt;&lt; <span class="string">"invalid choice!"</span> &lt;&lt; endl;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// 清除残留的换行符</span></span><br><span class="line">                cin.<span class="built_in">ignore</span>(<span class="number">10000</span>, <span class="string">'\n'</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据用户输入执行操作</span></span><br><span class="line">        <span class="built_in"><span class="keyword">switch</span></span> (choice) {</span><br><span class="line">            <span class="comment">// 登录业务</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>: {</span><br><span class="line">                <span class="keyword">char</span> name[<span class="number">50</span>] = {<span class="number">0</span>};</span><br><span class="line">                <span class="keyword">char</span> password[<span class="number">50</span>] = {<span class="number">0</span>};</span><br><span class="line">                cout &lt;&lt; <span class="string">"user name: "</span>;</span><br><span class="line">                cin.<span class="built_in">getline</span>(name, <span class="number">50</span>);</span><br><span class="line">                cout &lt;&lt; <span class="string">"user password: "</span>;</span><br><span class="line">                cin.<span class="built_in">getline</span>(password, <span class="number">50</span>);</span><br><span class="line"></span><br><span class="line">                json js;</span><br><span class="line">                js[<span class="string">"msgType"</span>] = LOGIN_MSG;</span><br><span class="line">                js[<span class="string">"name"</span>] = name;</span><br><span class="line">                js[<span class="string">"password"</span>] = password;</span><br><span class="line">                string request = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">                g_isLoginSuccess = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> len = <span class="built_in">send</span>(clientfd, request.<span class="built_in">c_str</span>(), <span class="built_in">strlen</span>(request.<span class="built_in">c_str</span>()) + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (len == <span class="number">-1</span>) {</span><br><span class="line">                    cerr &lt;&lt; <span class="string">"send login msg error: "</span> &lt;&lt; request &lt;&lt; endl;</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 等待信号量, 由子线程处理完登录的响应消息后, 通知主线程继续执行</span></span><br><span class="line">                <span class="built_in">sem_wait</span>(&amp;rwsem);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 用户登录成功</span></span><br><span class="line">                <span class="keyword">if</span> (g_isLoginSuccess) {</span><br><span class="line">                    <span class="comment">// 进入聊天主菜单</span></span><br><span class="line">                    isMainMenuRunning = <span class="literal">true</span>;</span><br><span class="line">                    <span class="built_in">mainMenu</span>(clientfd);</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 注册业务</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>: {</span><br><span class="line">                <span class="keyword">char</span> name[<span class="number">50</span>] = {<span class="number">0</span>};</span><br><span class="line">                <span class="keyword">char</span> pwd[<span class="number">50</span>] = {<span class="number">0</span>};</span><br><span class="line">                cout &lt;&lt; <span class="string">"user name: "</span>;</span><br><span class="line">                cin.<span class="built_in">getline</span>(name, <span class="number">50</span>);</span><br><span class="line">                cout &lt;&lt; <span class="string">"user password: "</span>;</span><br><span class="line">                cin.<span class="built_in">getline</span>(pwd, <span class="number">50</span>);</span><br><span class="line"></span><br><span class="line">                json js;</span><br><span class="line">                js[<span class="string">"msgType"</span>] = REGISTER_MSG;</span><br><span class="line">                js[<span class="string">"name"</span>] = name;</span><br><span class="line">                js[<span class="string">"password"</span>] = pwd;</span><br><span class="line">                string request = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> len = <span class="built_in">send</span>(clientfd, request.<span class="built_in">c_str</span>(), <span class="built_in">strlen</span>(request.<span class="built_in">c_str</span>()) + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (len == <span class="number">-1</span>) {</span><br><span class="line">                    cerr &lt;&lt; <span class="string">"send reg msg error: "</span> &lt;&lt; request &lt;&lt; endl;</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 等待信号量, 由子线程处理完注册的响应消息后, 通知主线程继续执行</span></span><br><span class="line">                <span class="built_in">sem_wait</span>(&amp;rwsem);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 退出程序业务</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="built_in">close</span>(clientfd);</span><br><span class="line">                <span class="built_in">sem_destroy</span>(&amp;rwsem);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                cerr &lt;&lt; <span class="string">"invalid choice!"</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理注册的响应逻辑</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doRegResponse</span><span class="params">(json &amp;responsejs)</span> </span>{</span><br><span class="line">    <span class="comment">// 注册失败</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != responsejs[<span class="string">"errNum"</span>].get&lt;<span class="keyword">int</span>&gt;()) {</span><br><span class="line">        cerr &lt;&lt; <span class="string">"注册失败: "</span> &lt;&lt; responsejs[<span class="string">"errMsg"</span>].get&lt;string&gt;() &lt;&lt; endl;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 注册成功</span></span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        cout &lt;&lt; <span class="string">"注册成功, 用户ID: "</span> &lt;&lt; responsejs[<span class="string">"userId"</span>] &lt;&lt; <span class="string">" , 用户名称: "</span> &lt;&lt; responsejs[<span class="string">"userName"</span>].get&lt;string&gt;()</span><br><span class="line">             &lt;&lt; endl;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理登录的响应逻辑</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doLoginResponse</span><span class="params">(json &amp;responsejs)</span> </span>{</span><br><span class="line">    <span class="comment">// 登录失败</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != responsejs[<span class="string">"errNum"</span>].get&lt;<span class="keyword">int</span>&gt;()) {</span><br><span class="line">        cerr &lt;&lt; <span class="string">"登录失败: "</span> &lt;&lt; responsejs[<span class="string">"errMsg"</span>].get&lt;string&gt;() &lt;&lt; endl;</span><br><span class="line">        g_isLoginSuccess = <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 登录成功</span></span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// 记录当前登录用户的基本信息</span></span><br><span class="line">        g_currentUser.<span class="built_in">setId</span>(responsejs[<span class="string">"userId"</span>].get&lt;<span class="keyword">int</span>&gt;());</span><br><span class="line">        g_currentUser.<span class="built_in">setName</span>(responsejs[<span class="string">"userName"</span>].get&lt;string&gt;());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 记录当前用户的好友列表信息</span></span><br><span class="line">        <span class="keyword">if</span> (responsejs.<span class="built_in">contains</span>(<span class="string">"friends"</span>)) {</span><br><span class="line">            <span class="comment">// 初始化好友列表</span></span><br><span class="line">            g_currentUserFriendList.<span class="built_in">clear</span>();</span><br><span class="line"></span><br><span class="line">            vector&lt;User&gt; vec = responsejs[<span class="string">"friends"</span>];</span><br><span class="line">            <span class="keyword">for</span> (User &amp;user : vec) {</span><br><span class="line">                g_currentUserFriendList.<span class="built_in">push_back</span>(user);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 记录当前用户的群组列表信息</span></span><br><span class="line">        <span class="keyword">if</span> (responsejs.<span class="built_in">contains</span>(<span class="string">"groups"</span>)) {</span><br><span class="line">            <span class="comment">// 初始化群组列表</span></span><br><span class="line">            g_currentUserGroupList.<span class="built_in">clear</span>();</span><br><span class="line"></span><br><span class="line">            vector&lt;Group&gt; vec = responsejs[<span class="string">"groups"</span>];</span><br><span class="line">            <span class="keyword">for</span> (Group &amp;group : vec) {</span><br><span class="line">                g_currentUserGroupList.<span class="built_in">push_back</span>(group);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 显示登录用户的基本信息</span></span><br><span class="line">        <span class="built_in">showCurrentUserData</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 显示当前用户的离线消息（个人聊天信息或者群组消息）</span></span><br><span class="line">        <span class="keyword">if</span> (responsejs.<span class="built_in">contains</span>(<span class="string">"offlinemsg"</span>)) {</span><br><span class="line">            vector&lt;OfflineMessage&gt; vec = responsejs[<span class="string">"offlinemsg"</span>];</span><br><span class="line">            <span class="keyword">for</span> (OfflineMessage &amp;message : vec) {</span><br><span class="line">                <span class="comment">// 离线消息的内容（JSON字符串）</span></span><br><span class="line">                json content = json::<span class="built_in">parse</span>(message.<span class="built_in">getMessage</span>());</span><br><span class="line">                <span class="comment">// 离线消息的发送时间</span></span><br><span class="line">                string datetime = formatTimestampLocal(message.<span class="built_in">getCreateTime</span>(), <span class="string">"%Y-%m-%d %H:%M:%S"</span>);</span><br><span class="line">                <span class="comment">// 打印一对一聊天消息</span></span><br><span class="line">                <span class="keyword">if</span> (SINGLE_CHAT_MSG == content[<span class="string">"msgType"</span>].get&lt;<span class="keyword">int</span>&gt;()) {</span><br><span class="line">                    cout &lt;&lt; <span class="string">"好友消息["</span> &lt;&lt; content[<span class="string">"fromId"</span>] &lt;&lt; <span class="string">"] "</span> &lt;&lt; datetime &lt;&lt; <span class="string">" "</span></span><br><span class="line">                         &lt;&lt; content[<span class="string">"fromName"</span>].get&lt;string&gt;() &lt;&lt; <span class="string">" said: "</span> &lt;&lt; content[<span class="string">"fromMsg"</span>].get&lt;string&gt;() &lt;&lt; endl;</span><br><span class="line">                }</span><br><span class="line">                <span class="comment">// 打印群组聊天消息</span></span><br><span class="line">                <span class="keyword">else</span> {</span><br><span class="line">                    cout &lt;&lt; <span class="string">"群聊消息["</span> &lt;&lt; content[<span class="string">"groupId"</span>] &lt;&lt; <span class="string">"] "</span> &lt;&lt; datetime &lt;&lt; <span class="string">" ["</span> &lt;&lt; content[<span class="string">"fromId"</span>] &lt;&lt; <span class="string">"] "</span></span><br><span class="line">                         &lt;&lt; content[<span class="string">"fromName"</span>].get&lt;string&gt;() &lt;&lt; <span class="string">" said: "</span> &lt;&lt; content[<span class="string">"groupMsg"</span>].get&lt;string&gt;() &lt;&lt; endl;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        g_isLoginSuccess = <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子线程（接收消息的线程）执行的业务逻辑</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readTaskHandler</span><span class="params">(<span class="keyword">int</span> clientfd)</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (;;) {</span><br><span class="line">        <span class="keyword">char</span> buffer[<span class="number">1024</span>] = {<span class="number">0</span>};</span><br><span class="line">        <span class="keyword">int</span> len = <span class="built_in">recv</span>(clientfd, buffer, <span class="number">1024</span>, <span class="number">0</span>);  <span class="comment">// 阻塞等待消息</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">-1</span> == len || <span class="number">0</span> == len) {</span><br><span class="line">            <span class="built_in">close</span>(clientfd);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 接收ChatServer转发的数据, 反序列化生成JSON数据对象</span></span><br><span class="line">        json js = json::<span class="built_in">parse</span>(buffer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 消息类型</span></span><br><span class="line">        <span class="keyword">int</span> msgType = js[<span class="string">"msgType"</span>].get&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 错误编码</span></span><br><span class="line">        <span class="keyword">int</span> errNum = js.<span class="built_in">contains</span>(<span class="string">"errNum"</span>) ? js[<span class="string">"errNum"</span>].get&lt;<span class="keyword">int</span>&gt;() : <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理接收到的一对一聊天消息</span></span><br><span class="line">        <span class="keyword">if</span> (SINGLE_CHAT_MSG == msgType) {</span><br><span class="line">            string datetime = formatTimestampLocal(js[<span class="string">"fromTimestamp"</span>].get&lt;<span class="keyword">long</span>&gt;(), <span class="string">"%Y-%m-%d %H:%M:%S"</span>);</span><br><span class="line">            cout &lt;&lt; <span class="string">"好友消息["</span> &lt;&lt; js[<span class="string">"fromId"</span>] &lt;&lt; <span class="string">"] "</span> &lt;&lt; datetime &lt;&lt; <span class="string">" "</span> &lt;&lt; js[<span class="string">"fromName"</span>].get&lt;string&gt;()</span><br><span class="line">                 &lt;&lt; <span class="string">" said: "</span> &lt;&lt; js[<span class="string">"fromMsg"</span>].get&lt;string&gt;() &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理接收到的群组聊天消息</span></span><br><span class="line">        <span class="keyword">if</span> (GROUP_CHAT_MSG == msgType) {</span><br><span class="line">            string datetime = formatTimestampLocal(js[<span class="string">"fromTimestamp"</span>].get&lt;<span class="keyword">long</span>&gt;(), <span class="string">"%Y-%m-%d %H:%M:%S"</span>);</span><br><span class="line">            cout &lt;&lt; <span class="string">"群聊消息["</span> &lt;&lt; js[<span class="string">"groupId"</span>] &lt;&lt; <span class="string">"] "</span> &lt;&lt; datetime &lt;&lt; <span class="string">" ["</span> &lt;&lt; js[<span class="string">"fromId"</span>] &lt;&lt; <span class="string">"] "</span></span><br><span class="line">                 &lt;&lt; js[<span class="string">"fromName"</span>].get&lt;string&gt;() &lt;&lt; <span class="string">" said: "</span> &lt;&lt; js[<span class="string">"groupMsg"</span>].get&lt;string&gt;() &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理登录响应的业务逻辑</span></span><br><span class="line">        <span class="keyword">if</span> (LOGIN_MSG_ACK == msgType) {</span><br><span class="line">            <span class="built_in">doLoginResponse</span>(js);</span><br><span class="line">            <span class="built_in">sem_post</span>(&amp;rwsem);  <span class="comment">// 通知主线程, 登录结果处理完成</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理注册响应的业务逻辑</span></span><br><span class="line">        <span class="keyword">if</span> (REGISTER_MSG_ACK == msgType) {</span><br><span class="line">            <span class="built_in">doRegResponse</span>(js);</span><br><span class="line">            <span class="built_in">sem_post</span>(&amp;rwsem);  <span class="comment">// 通知主线程, 注册结果处理完成</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理成功创建群组响应的业务逻辑</span></span><br><span class="line">        <span class="keyword">if</span> (CREATE_GROUP_MSG_ACK == msgType &amp;&amp; SUCCESS == errNum) {</span><br><span class="line">            cout &lt;&lt; <span class="string">"群组创建成功, 群组ID: "</span> &lt;&lt; js[<span class="string">"groupId"</span>].get&lt;<span class="keyword">int</span>&gt;() &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理成功加入群组响应的业务逻辑</span></span><br><span class="line">        <span class="keyword">if</span> (JOIN_GROUP_MSG_ACK == msgType &amp;&amp; SUCCESS == errNum) {</span><br><span class="line">            cout &lt;&lt; <span class="string">"加入群组成功"</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理成功添加好友响应的业务逻辑</span></span><br><span class="line">        <span class="keyword">if</span> (ADD_FRIEND_MSG_ACK == msgType &amp;&amp; SUCCESS == errNum) {</span><br><span class="line">            cout &lt;&lt; <span class="string">"好友添加成功"</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理其他业务的错误响应</span></span><br><span class="line">        <span class="keyword">if</span> (SUCCESS != errNum &amp;&amp; js.<span class="built_in">contains</span>(<span class="string">"errMsg"</span>)) {</span><br><span class="line">            cerr &lt;&lt; <span class="string">"操作失败: "</span> &lt;&lt; js[<span class="string">"errMsg"</span>].get&lt;string&gt;() &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示当前登录成功用户的基本信息</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">showCurrentUserData</span><span class="params">()</span> </span>{</span><br><span class="line">    cout &lt;&lt; <span class="string">"======================login user======================"</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">"current login user =&gt; id:"</span> &lt;&lt; g_currentUser.<span class="built_in">getId</span>() &lt;&lt; <span class="string">" name:"</span> &lt;&lt; g_currentUser.<span class="built_in">getName</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">"----------------------friend list---------------------"</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">if</span> (!g_currentUserFriendList.<span class="built_in">empty</span>()) {</span><br><span class="line">        <span class="keyword">for</span> (User &amp;user : g_currentUserFriendList) {</span><br><span class="line">            cout &lt;&lt; user.<span class="built_in">getId</span>() &lt;&lt; <span class="string">" "</span> &lt;&lt; user.<span class="built_in">getName</span>() &lt;&lt; <span class="string">" "</span> &lt;&lt; user.<span class="built_in">getState</span>() &lt;&lt; endl;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    cout &lt;&lt; <span class="string">"----------------------group list----------------------"</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">if</span> (!g_currentUserGroupList.<span class="built_in">empty</span>()) {</span><br><span class="line">        <span class="keyword">for</span> (Group &amp;group : g_currentUserGroupList) {</span><br><span class="line">            cout &lt;&lt; group.<span class="built_in">getId</span>() &lt;&lt; <span class="string">" "</span> &lt;&lt; group.<span class="built_in">getGroupName</span>() &lt;&lt; <span class="string">" "</span> &lt;&lt; group.<span class="built_in">getGroupDesc</span>() &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">for</span> (User &amp;user : group.<span class="built_in">getUsers</span>()) {</span><br><span class="line">                cout &lt;&lt; user.<span class="built_in">getId</span>() &lt;&lt; <span class="string">" "</span> &lt;&lt; user.<span class="built_in">getName</span>() &lt;&lt; <span class="string">" "</span> &lt;&lt; user.<span class="built_in">getState</span>() &lt;&lt; endl;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    cout &lt;&lt; <span class="string">"======================================================"</span> &lt;&lt; endl;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/////////////////////////////////////////////////////主菜单功能/////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// "help" command handler</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">help</span><span class="params">(<span class="keyword">int</span> fd = <span class="number">0</span>, string str = <span class="string">""</span>)</span></span>;</span><br><span class="line"><span class="comment">// "singlechat" command handler</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">singlechat</span><span class="params">(<span class="keyword">int</span>, string)</span></span>;</span><br><span class="line"><span class="comment">// "addfriend" command handler</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addfriend</span><span class="params">(<span class="keyword">int</span>, string)</span></span>;</span><br><span class="line"><span class="comment">// "creategroup" command handler</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">creategroup</span><span class="params">(<span class="keyword">int</span>, string)</span></span>;</span><br><span class="line"><span class="comment">// "joingroup" command handler</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">joingroup</span><span class="params">(<span class="keyword">int</span>, string)</span></span>;</span><br><span class="line"><span class="comment">// "groupchat" command handler</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">groupchat</span><span class="params">(<span class="keyword">int</span>, string)</span></span>;</span><br><span class="line"><span class="comment">// "loginout" command handler</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loginout</span><span class="params">(<span class="keyword">int</span>, string)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 系统支持的客户端命令列表</span></span><br><span class="line">unordered_map&lt;string, string&gt; commandMap = {{<span class="string">"help"</span>, <span class="string">"显示所有支持的命令, 格式 help"</span>},</span><br><span class="line">                                            {<span class="string">"singlechat"</span>, <span class="string">"一对一聊天, 格式 singlechat:friendid:message"</span>},</span><br><span class="line">                                            {<span class="string">"addfriend"</span>, <span class="string">"添加好友, 格式 addfriend:friendid"</span>},</span><br><span class="line">                                            {<span class="string">"creategroup"</span>, <span class="string">"创建群组, 格式 creategroup:groupname:groupdesc"</span>},</span><br><span class="line">                                            {<span class="string">"joingroup"</span>, <span class="string">"加入群组, 格式 joingroup:groupid"</span>},</span><br><span class="line">                                            {<span class="string">"groupchat"</span>, <span class="string">"群组聊天, 格式 groupchat:groupid:message"</span>},</span><br><span class="line">                                            {<span class="string">"loginout"</span>, <span class="string">"退出登录, 格式 loginout"</span>}};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册系统支持的客户端命令处理</span></span><br><span class="line">unordered_map&lt;string, function&lt;<span class="keyword">void</span>(<span class="keyword">int</span>, string)&gt;&gt; commandHandlerMap = {</span><br><span class="line">    {<span class="string">"help"</span>, help},           {<span class="string">"singlechat"</span>, singlechat}, {<span class="string">"addfriend"</span>, addfriend}, {<span class="string">"creategroup"</span>, creategroup},</span><br><span class="line">    {<span class="string">"joingroup"</span>, joingroup}, {<span class="string">"groupchat"</span>, groupchat},   {<span class="string">"loginout"</span>, loginout}};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主菜单程序</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mainMenu</span><span class="params">(<span class="keyword">int</span> clientfd)</span> </span>{</span><br><span class="line">    <span class="built_in">help</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">1024</span>] = {<span class="number">0</span>};</span><br><span class="line">    <span class="keyword">while</span> (isMainMenuRunning) {</span><br><span class="line">        <span class="comment">// 存储用户选择执行的命令</span></span><br><span class="line">        string command;</span><br><span class="line">        cin.<span class="built_in">getline</span>(buffer, <span class="number">1024</span>);</span><br><span class="line">        <span class="function">string <span class="title">commandbuf</span><span class="params">(buffer)</span></span>;</span><br><span class="line">        <span class="keyword">int</span> idx = commandbuf.<span class="built_in">find</span>(<span class="string">":"</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">-1</span> == idx) {</span><br><span class="line">            command = commandbuf;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            command = commandbuf.<span class="built_in">substr</span>(<span class="number">0</span>, idx);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查找相应命令的事件处理器</span></span><br><span class="line">        <span class="keyword">auto</span> it = commandHandlerMap.<span class="built_in">find</span>(command);</span><br><span class="line">        <span class="keyword">if</span> (it == commandHandlerMap.<span class="built_in">end</span>()) {</span><br><span class="line">            cerr &lt;&lt; <span class="string">"invalid input command!"</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用相应命令的事件处理回调函数</span></span><br><span class="line">        it-&gt;<span class="built_in">second</span>(clientfd, commandbuf.<span class="built_in">substr</span>(idx + <span class="number">1</span>, commandbuf.<span class="built_in">size</span>() - idx));</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// "help" command handler</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">help</span><span class="params">(<span class="keyword">int</span>, string)</span> </span>{</span><br><span class="line">    cout &lt;&lt; <span class="string">"&gt;&gt;&gt; show command list &gt;&gt;&gt; "</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;p : commandMap) {</span><br><span class="line">        cout &lt;&lt; p.first &lt;&lt; <span class="string">" : "</span> &lt;&lt; p.second &lt;&lt; endl;</span><br><span class="line">    }</span><br><span class="line">    cout &lt;&lt; endl;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// "addfriend" command handler</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addfriend</span><span class="params">(<span class="keyword">int</span> clientfd, string str)</span> </span>{</span><br><span class="line">    <span class="comment">// 数据格式: friendid</span></span><br><span class="line">    <span class="keyword">int</span> friendId = <span class="built_in">atoi</span>(str.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span> (friendId &lt;= <span class="number">0</span>) {</span><br><span class="line">        cerr &lt;&lt; <span class="string">"add friend command invalid!"</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求参数</span></span><br><span class="line">    json request;</span><br><span class="line">    request[<span class="string">"msgType"</span>] = ADD_FRIEND_MSG;</span><br><span class="line">    request[<span class="string">"userId"</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    request[<span class="string">"friendId"</span>] = friendId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送数据</span></span><br><span class="line">    string buffer = request.<span class="built_in">dump</span>();</span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">send</span>(clientfd, buffer.<span class="built_in">c_str</span>(), <span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>()) + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == len) {</span><br><span class="line">        cerr &lt;&lt; <span class="string">"send add friend msg error -&gt; "</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// "singlechat" command handler</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">singlechat</span><span class="params">(<span class="keyword">int</span> clientfd, string str)</span> </span>{</span><br><span class="line">    <span class="comment">// 数据格式: friendid:message</span></span><br><span class="line">    <span class="keyword">int</span> idx = str.<span class="built_in">find</span>(<span class="string">":"</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == idx) {</span><br><span class="line">        cerr &lt;&lt; <span class="string">"single chat command invalid!"</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> friendId = <span class="built_in">atoi</span>(str.<span class="built_in">substr</span>(<span class="number">0</span>, idx).<span class="built_in">c_str</span>());</span><br><span class="line">    string message = str.<span class="built_in">substr</span>(idx + <span class="number">1</span>, str.<span class="built_in">size</span>() - idx);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求参数</span></span><br><span class="line">    json request;</span><br><span class="line">    request[<span class="string">"msgType"</span>] = SINGLE_CHAT_MSG;</span><br><span class="line">    request[<span class="string">"fromId"</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    request[<span class="string">"fromName"</span>] = g_currentUser.<span class="built_in">getName</span>();</span><br><span class="line">    request[<span class="string">"fromMsg"</span>] = message;</span><br><span class="line">    request[<span class="string">"fromTimestamp"</span>] = <span class="built_in">getTimestampMs</span>();</span><br><span class="line">    request[<span class="string">"toId"</span>] = friendId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送数据</span></span><br><span class="line">    string buffer = request.<span class="built_in">dump</span>();</span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">send</span>(clientfd, buffer.<span class="built_in">c_str</span>(), <span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>()) + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == len) {</span><br><span class="line">        cerr &lt;&lt; <span class="string">"send single chat msg error -&gt; "</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// "creategroup" command handler</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">creategroup</span><span class="params">(<span class="keyword">int</span> clientfd, string str)</span> </span>{</span><br><span class="line">    <span class="comment">// 数据格式: groupname:groupdesc</span></span><br><span class="line">    <span class="keyword">int</span> idx = str.<span class="built_in">find</span>(<span class="string">":"</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == idx) {</span><br><span class="line">        cerr &lt;&lt; <span class="string">"create group command invalid!"</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    string groupName = str.<span class="built_in">substr</span>(<span class="number">0</span>, idx);</span><br><span class="line">    string groupDesc = str.<span class="built_in">substr</span>(idx + <span class="number">1</span>, str.<span class="built_in">size</span>() - idx);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求参数</span></span><br><span class="line">    json request;</span><br><span class="line">    request[<span class="string">"msgType"</span>] = CREATE_GROUP_MSG;</span><br><span class="line">    request[<span class="string">"userId"</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    request[<span class="string">"groupName"</span>] = groupName;</span><br><span class="line">    request[<span class="string">"groupDesc"</span>] = groupDesc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送数据</span></span><br><span class="line">    string buffer = request.<span class="built_in">dump</span>();</span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">send</span>(clientfd, buffer.<span class="built_in">c_str</span>(), <span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>()) + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == len) {</span><br><span class="line">        cerr &lt;&lt; <span class="string">"send create group msg error -&gt; "</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// "joingroup" command handler</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">joingroup</span><span class="params">(<span class="keyword">int</span> clientfd, string str)</span> </span>{</span><br><span class="line">    <span class="comment">// 数据格式：groupid</span></span><br><span class="line">    <span class="keyword">int</span> groupId = <span class="built_in">atoi</span>(str.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span> (groupId &lt;= <span class="number">0</span>) {</span><br><span class="line">        cerr &lt;&lt; <span class="string">"join group command invalid!"</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求参数</span></span><br><span class="line">    json request;</span><br><span class="line">    request[<span class="string">"msgType"</span>] = JOIN_GROUP_MSG;</span><br><span class="line">    request[<span class="string">"userId"</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    request[<span class="string">"groupId"</span>] = groupId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送数据</span></span><br><span class="line">    string buffer = request.<span class="built_in">dump</span>();</span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">send</span>(clientfd, buffer.<span class="built_in">c_str</span>(), <span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>()) + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == len) {</span><br><span class="line">        cerr &lt;&lt; <span class="string">"send join group msg error -&gt; "</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// "groupchat" command handler</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">groupchat</span><span class="params">(<span class="keyword">int</span> clientfd, string str)</span> </span>{</span><br><span class="line">    <span class="comment">// 数据格式：groupid:message</span></span><br><span class="line">    <span class="keyword">int</span> idx = str.<span class="built_in">find</span>(<span class="string">":"</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == idx) {</span><br><span class="line">        cerr &lt;&lt; <span class="string">"group chat command invalid!"</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> groupId = <span class="built_in">atoi</span>(str.<span class="built_in">substr</span>(<span class="number">0</span>, idx).<span class="built_in">c_str</span>());</span><br><span class="line">    string groupMsg = str.<span class="built_in">substr</span>(idx + <span class="number">1</span>, str.<span class="built_in">size</span>() - idx);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求参数</span></span><br><span class="line">    json request;</span><br><span class="line">    request[<span class="string">"msgType"</span>] = GROUP_CHAT_MSG;</span><br><span class="line">    request[<span class="string">"fromId"</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    request[<span class="string">"fromName"</span>] = g_currentUser.<span class="built_in">getName</span>();</span><br><span class="line">    request[<span class="string">"fromTimestamp"</span>] = <span class="built_in">getTimestampMs</span>();</span><br><span class="line">    request[<span class="string">"groupId"</span>] = groupId;</span><br><span class="line">    request[<span class="string">"groupMsg"</span>] = groupMsg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送数据</span></span><br><span class="line">    string buffer = request.<span class="built_in">dump</span>();</span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">send</span>(clientfd, buffer.<span class="built_in">c_str</span>(), <span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>()) + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == len) {</span><br><span class="line">        cerr &lt;&lt; <span class="string">"send group chat msg error -&gt; "</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// "loginout" command handler</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loginout</span><span class="params">(<span class="keyword">int</span> clientfd, string)</span> </span>{</span><br><span class="line">    <span class="comment">// 请求参数</span></span><br><span class="line">    json request;</span><br><span class="line">    request[<span class="string">"msgType"</span>] = LOGIN_OUT_MSG;</span><br><span class="line">    request[<span class="string">"userId"</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送数据</span></span><br><span class="line">    string buffer = request.<span class="built_in">dump</span>();</span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">send</span>(clientfd, buffer.<span class="built_in">c_str</span>(), <span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>()) + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == len) {</span><br><span class="line">        cerr &lt;&lt; <span class="string">"send login out msg error -&gt; "</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        isMainMenuRunning = <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="项目测试"><a href="#项目测试" class="headerlink" title="项目测试"></a>项目测试</h4><ul><li><p>(1) 启动 Nginx、Redis、MySQL 服务，并配置 Nginx 的 TCP 负载均衡器</p></li><li><p>(2) 启动多个集群聊天服务端程序</p><ul><li>启动第一个聊天服务端程序：<code>./bin/chat_server 127.0.0.1 6000</code></li><li>启动第二个聊天服务端程序：<code>./bin/chat_server 127.0.0.1 6002</code></li></ul></li><li><p>(3) 启动多个集群聊天客户端程序</p><ul><li>启动第一个聊天客户端程序：<code>./bin/chat_client 127.0.0.1 8000</code>，连接的是 Nginx 的 TCP 负载均衡器</li><li>启动第二个聊天客户端程序：<code>./bin/chat_client 127.0.0.1 8000</code>，连接的是 Nginx 的 TCP 负载均衡器</li></ul></li></ul><h2 id="项目输出"><a href="#项目输出" class="headerlink" title="项目输出"></a>项目输出</h2><h3 id="输出求职简历"><a href="#输出求职简历" class="headerlink" title="输出求职简历"></a>输出求职简历</h3><ul><li><p>项目名称</p><ul><li>集群聊天服务器</li><li>基于 Muduo 网络库实现的集群聊天服务器</li></ul></li><li><p>开发工具</p><ul><li>VSCode 远程 Linux 开发</li><li> CMake 构建 C/C++ 项目</li><li> Linux Shell 编写项目自动编译脚本</li></ul></li><li><p>项目内容</p><ul><li>使用 Muduo 网络库实现项目的网络核心模块，提供高并发网络 I/O 服务，解耦网络和业务模块的代码</li><li>使用 Json 序列化和反序列化消息作为私有通信协议</li><li>配置 Nginx 基于 TCP 的负载均衡，实现聊天服务器的集群功能，提高后端服务的并发能力</li><li>基于 Redis 的发布 - 订阅功能，实现客户端跨服务器通信</li><li>使用 MySQL 关系型数据库作为项目数据的落地存储</li><li>使用数据库连接池提高数据库的访问性能</li></ul></li><li><p>项目收获</p><ul><li>熟悉了基于 Muduo 网络库进行服务端程序开发</li><li>掌握了 Nginx 的 TCP 负载均衡配置</li><li>掌握了 MySQL 和服务端中间件 Redis 的应用</li></ul></li><li><p>项目问题</p><ul><li>问题描述<ul><li>通过代码脚本或者专业的压测工具（比如 JMeter）测试聊天服务器的并发性能</li></ul></li><li>问题解决<ul><li>设置进程可使用文件描述符（<code>fd</code>）资源的上限数量，提高聊天服务器的并发性能</li></ul></li></ul></li></ul><div class="admonition warning"><p class="admonition-title">特别注意</p><p>在面试流程中描述项目内容时，切忌详细罗列项目中的业务，重点是介绍项目用到什么技术，突出技术点 。</p></div><h3 id="常见的面试题"><a href="#常见的面试题" class="headerlink" title="常见的面试题"></a>常见的面试题</h3><h4 id="为什么要使用-Redis"><a href="#为什么要使用-Redis" class="headerlink" title="为什么要使用 Redis"></a>为什么要使用 Redis</h4><ul><li><p>问题描述</p><ul><li>为什么要使用 Redis 来实现客户端跨服务器通信？各个聊天服务器之间能不能直接进行通信呢？</li></ul></li><li><p>问题解答</p><ul><li><a href="../../../asset/2025/06/cxx-chatserver-qa-1.png">这里的设计</a>，会在各个 ChatServer 服务器互相之间直接建立 TCP 连接进行通信，相当于在服务器网络之间进行广播。这样的设计使得各个服务器之间耦合度太高，不利于系统扩展，并且会占用系统大量的 Socket 资源，各服务器之间的带宽压力很大，不能够节省资源给更多的客户端提供服务，因此绝对不是一个好的设计。</li><li>集群部署的服务器之间进行通信，最好的方式就是引入消息队列中间件，解耦各个服务器，使整个系统松耦合，提高服务器的响应能力，节省服务器的带宽资源，整体的设计应该 <a href="../../../asset/2025/06/cxx-chatserver-qa-2.png">如此</a>。</li><li>在集群环境中，经常使用的消息队列中间件有 ActiveMQ、RabbitMQ、Kafka、RocketMQ 等，它们都是应用场景广泛并且性能很好的消息队列，供集群服务器、分布式服务之间进行消息通信。限于集群聊天服务器项目的业务并不是非常复杂，并且对并发性能也没有太高的要求，因此消息队列选型的是 - Redis 发布 - 订阅。</li></ul></li></ul><h4 id="Redis-实现的功能不稳定"><a href="#Redis-实现的功能不稳定" class="headerlink" title="Redis 实现的功能不稳定"></a>Redis 实现的功能不稳定</h4><ul><li><p>问题描述</p><ul><li>当消息的生产速度大于消息的消费速度时，随着时间的推移，会造成 Redis 积压消息；如果消息积压的数量太大，会导致内存占用激增，Redis 最终可能会宕机。</li></ul></li><li><p>问题解答</p><ul><li>使用消息队列中间件替代 Redis 的发布 - 订阅功能，比如 Kafka、RabbitMQ、RocketMQ 等。</li></ul></li></ul><div class="admonition warning"><p class="admonition-title">特别注意</p><p>Redis 的主要功能有：缓存数据库（支持持久化）、分布式锁、发布 - 订阅，其中发布 - 订阅功能只适用于非核心业务、流量不是很大的业务。</p></div><h4 id="如何保证消息的可靠传输"><a href="#如何保证消息的可靠传输" class="headerlink" title="如何保证消息的可靠传输"></a>如何保证消息的可靠传输</h4><ul><li><p>问题描述</p><ul><li>如何保证客户端发送出去的消息，一定能够被服务端接收到，从而保证消息不丢失呢？</li></ul></li><li><p>问题解答</p><ul><li>在业务层中，可以通过消息序号 + ACK 应答机制实现消息的可靠传输，实现步骤如下：</li><li>(1) 客户端发送的每条消息都附加一个递增的 <code>seq</code> 序号（比如 1、2、3）。</li><li>(2) 客户端将未被确认的消息保存在本地的缓存队列中，用于后续重发和确认处理。</li><li>(3) 服务端收到消息后，返回 ACK 应答给客户端，标明确认的消息序号（比如 <code>seq:1</code>）。</li><li>(4) 客户端处理 ACK 响应：客户端接收到 ACK 响应后，从本地缓存队列中移除对应 <code>seq</code> 的消息，表示消息已被成功确认。</li><li>(5) 消息重发机制：客户端启动一个定时器线程，定时扫描缓存队列中未被确认的消息（比如每 3 秒扫描一次）。如果某条消息在一定时间内（比如 5 秒）未收到 ACK 确认，则自动重发该消息，直到收到服务端的 ACK 确认或者超过最大重试次数。</li></ul></li></ul><h4 id="如何保证数据传输的安全性"><a href="#如何保证数据传输的安全性" class="headerlink" title="如何保证数据传输的安全性"></a>如何保证数据传输的安全性</h4><ul><li><p>问题描述</p><ul><li>由于数据（比如聊天消息）是明文传输的，存在一定的数据安全问题，如何解决？</li></ul></li><li><p>问题解答</p><ul><li>使用对称加密算法（如 AES）和非对称加密算法（如 RSA）来保证数据传输的安全性，实现步骤如下：</li><li>(1) 客户端登录时，使用服务端的 RSA 公钥加密数据，其中的数据包含一个随机生成的 AES 密钥和登录信息，然后将加密后的数据发送给服务端。</li><li>(2) 服务端收到数据后，使用自己的 RSA 私钥解密数据，获得客户端的 AES 密钥和登录信息，并完成身份验证。</li><li>(3) 后续通信阶段，客户端与服务端使用同一个 AES 密钥对数据进行对称加密和解密，从而实现高效且安全的数据传输。</li><li>(4) AES 密钥应为一次性生成的会话密钥（Session Key）。RSA 加解密只用于密钥交换和登录信息保护，后续通信使用高性能的 AES 加解密。</li></ul></li></ul><div class="admonition note"><p class="admonition-title">加密算法介绍</p><ul><li>在大型的 IM 软件（比如 QQ）中，会同时使用到对称加密算法和非对称加密算法，兼顾考虑数据安全性和加解密效率。</li><li><code>对称加密算法</code>：使用同一个密钥进行加密和解密，速度快，但需要考虑安全地共享密钥。常见的对称加密算法包括 DES、AES、3DES 等。</li><li><code>非对称加密算法</code>：使用一对公钥和私钥，公钥负责加密、私钥负责解密，安全性高，速度慢，适用于密钥交换与身份验证。常见的非对称加密算法包括 DSA、RSA、ECC 等。</li></ul></div><h4 id="客户端消息如何按顺序显示"><a href="#客户端消息如何按顺序显示" class="headerlink" title="客户端消息如何按顺序显示"></a>客户端消息如何按顺序显示</h4><ul><li><p>问题描述</p><ul><li>客户端接收到服务端发送的消息，如何按顺序显示？</li></ul></li><li><p>问题解答</p><ul><li>(1) 服务端消息加序号：服务端发送的每条消息都附加一个递增的 <code>seq</code> 序号，每个用户或会话维护独立的 <code>seq</code> 序号。</li><li>(2) 客户端缓存乱序消息：客户端接收到消息后，放入本地的有序缓存中，并使用 <code>expected_seq</code> 表示下一条应该显示的消息的序号。</li><li>(3) 按序显示 + 缓存清理：若客户端接收到消息序号等于 <code>expected_seq</code>，则立即显示，并从缓存中继续查找后续的连续消息，依次显示。</li><li>(4) 处理乱序和丢包：如果客户端接收到的是 <code>seq &gt; expected_seq</code>，则先缓存消息，暂时不显示。若某条消息长时间未到达，可发起消息重传请求或跳过处理。</li></ul></li></ul><h4 id="历史聊天消息应该如何存储"><a href="#历史聊天消息应该如何存储" class="headerlink" title="历史聊天消息应该如何存储"></a>历史聊天消息应该如何存储</h4><ul><li><p>问题描述</p><ul><li>历史聊天消息，有哪些存储方案？</li></ul></li><li><p>问题解答</p><ul><li>本地消息存储<ul><li>使用 SQLite 等嵌入式数据库：轻量、便于查询，适合单设备离线存储。</li><li>使用本地文件系统：以用户或群组为单位创建文件夹，按日期或大小分多个文件保存，适合大批量存储，读取简单但查询不方便。</li></ul></li><li>云端消息存储<ul><li>使用关系型数据库（如 MySQL）：结构化存储，支持高效查询和分页加载，适合结构清晰的聊天记录。</li><li>使用文件存储系统（如对象存储或分布式文件系统）：适合存储大批量的聊天原始记录或备份数据，读取顺序性强，但查询性能较弱。</li></ul></li></ul></li></ul><div class="admonition note"><p class="admonition-title">大规模系统中的历史聊天消息存储</p><ul><li>(1) 消息队列 + 消息落库架构，提升写入性能。</li><li>(2) Elasticsearch 作为全文索引系统，用于历史聊天记录搜索。</li><li>(3) 冷热数据分离：近期消息存储在数据库，历史消息转存在文件存储系统（如对象存储或分布式文件系统）。</li></ul></div><h4 id="如何感知客户端在线还是掉线"><a href="#如何感知客户端在线还是掉线" class="headerlink" title="如何感知客户端在线还是掉线"></a>如何感知客户端在线还是掉线</h4><ul><li><p>问题描述</p><ul><li>如果网络拥堵严重，ChatServer（聊天服务端）如何感知 ChatClient（聊天客户端）在线还是掉线呢？</li></ul></li><li><p>问题解答</p><ul><li>在 ChatServer（聊天服务端）和 ChatClient（聊天客户端）之间实现心跳保持机制，实现步骤如下：<ul><li>(1) 客户端定期发送心跳包（比如：每秒发一次 <code>MSG_TYPE: heartbeat</code>）</li><li>(2) 服务端为每个客户端维护一个心跳计数器，每秒自动加一</li><li> (3) 服务端每收到一次客户端发送的心跳包，就将该客户端的心跳计数器归零</li><li> (4) 若客户端的心跳计数器超过 5（即 5 秒内未收到心跳），则判断客户端已掉线</li><li> (5) 客户端掉线后，服务端开始清理该客户端的连接和资源</li></ul></li></ul></li></ul><div class="admonition warning"><p class="admonition-title">特别注意</p><ul><li>TCP 传输层有 Keepalive 机制，可以通过 Linux 内核参数来调整（如下表所示）。但是，ChatServer 不能依赖该机制来实现心跳保持机制，因为 ChatServer 检测到 ChatClient 掉线后，需要主动清理相应的连接和资源。</li></ul></div><table><thead><tr><th>参数名</th><th>作用</th><th>默认值（一般情况）</th></tr></thead><tbody><tr><td><code>net.ipv4.tcp_keepalive_time</code></td><td>TCP 连接空闲多久后开始发送 Keepalive 探测包（单位：秒）</td><td>7200 秒（2 小时）</td></tr><tr><td><code>net.ipv4.tcp_keepalive_intvl</code></td><td>发送 Keepalive 探测包之间的时间间隔（单位：秒）</td><td>75 秒</td></tr><tr><td><code>net.ipv4.tcp_keepalive_probes</code></td><td>Keepalive 最大探测次数，超过则认定连接失效（断开）</td><td>9 次</td></tr></tbody></table><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/m0_74795952/article/details/145707561">C++ 实现集群聊天服务器</a></li><li><a href="/posts/c9e38d0.html">C++ 使用 MySQL C API 连接 MySQL</a></li><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/QIANGWEIYUAN/article/details/97895611">C++ 使用 Redis 发布 - 订阅功能遇到的问题</a></li></ul><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/e635f0aa.html" title="基于 C++ 开发集群聊天服务器">https://www.techgrow.cn/posts/e635f0aa.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/" rel="tag"><i class="fa fa-tag"></i> Linux系统编程</a><a href="/tags/C/" rel="tag"><i class="fa fa-tag"></i> C++</a><a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" rel="tag"><i class="fa fa-tag"></i> 网络编程</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/effcb0d2.html" rel="prev" title="CMake 快速入门指南"><i class="fa fa-angle-left"></i> CMake 快速入门指南</a></div><div class="post-nav-item"> <a href="/posts/5e6aa28a.html" rel="next" title="C++ 实现 RPC 分布式网络通信框架">C++ 实现 RPC 分布式网络通信框架<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">2.3m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">34:22</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/e635f0aa.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>