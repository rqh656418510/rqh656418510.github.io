<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍 Dubbo 的巩固教程。"><meta property="og:type" content="article"><meta property="og:title" content="Dubbo 2 巩固教程之一"><meta property="og:url" content="https://www.techgrow.cn/posts/ef04d10a.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍 Dubbo 的巩固教程。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/12/dubbo-13.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/09/dubbo-serialize-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/09/dubbo-protocol-struct.png"><meta property="article:published_time" content="2019-09-11T15:42:35.000Z"><meta property="article:modified_time" content="2025-09-11T15:42:35.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="微服务"><meta property="article:tag" content="分布式"><meta property="article:tag" content="RPC"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2024/12/dubbo-13.png"><link rel="canonical" href="https://www.techgrow.cn/posts/ef04d10a.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/ef04d10a.html","path":"posts/ef04d10a.html","title":"Dubbo 2 巩固教程之一"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Dubbo 2 巩固教程之一 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%BA%90"><span class="nav-text">学习资源</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dubbo-%E6%A0%B8%E5%BF%83%E7%89%B9%E6%80%A7"><span class="nav-text">Dubbo 核心特性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE"><span class="nav-text">通信协议</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E5%8D%8F%E8%AE%AE"><span class="nav-text">序列化协议</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5"><span class="nav-text">负载均衡策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E5%AE%B9%E9%94%99%E7%AD%96%E7%95%A5"><span class="nav-text">集群容错策略</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dubbo-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3"><span class="nav-text">Dubbo 深入理解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RMI-%E5%8D%8F%E8%AE%AE"><span class="nav-text">RMI 协议</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RMI-%E5%8D%8F%E8%AE%AE%E7%9A%84%E4%BB%8B%E7%BB%8D"><span class="nav-text">RMI 协议的介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RMI-%E5%8D%8F%E8%AE%AE%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">RMI 协议的使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTP-%E5%8D%8F%E8%AE%AE"><span class="nav-text">HTTP 协议</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#HTTP-%E5%8D%8F%E8%AE%AE%E7%9A%84%E4%BB%8B%E7%BB%8D"><span class="nav-text">HTTP 协议的介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HTTP-%E5%8D%8F%E8%AE%AE%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">HTTP 协议的使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Thrift-%E5%8D%8F%E8%AE%AE"><span class="nav-text">Thrift 协议</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Thrift-%E5%8D%8F%E8%AE%AE%E7%9A%84%E4%BB%8B%E7%BB%8D"><span class="nav-text">Thrift 协议的介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Thrift-%E5%8D%8F%E8%AE%AE%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">Thrift 协议的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Thrift-%E7%9A%84%E5%AE%89%E8%A3%85"><span class="nav-text">Thrift 的安装</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Thrift-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">Thrift 的使用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dubbo-%E5%8D%8F%E8%AE%AE"><span class="nav-text">Dubbo 协议</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%8F%E8%AE%AE%E7%9A%84%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D"><span class="nav-text">协议的简单介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%8F%E8%AE%AE%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-text">协议的注意事项</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%8F%E8%AE%AE%E7%9A%84%E8%AF%A6%E7%BB%86%E9%85%8D%E7%BD%AE"><span class="nav-text">协议的详细配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%8F%E8%AE%AE%E7%9A%84%E6%8A%A5%E6%96%87%E6%A0%BC%E5%BC%8F"><span class="nav-text">协议的报文格式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E6%9C%BA%E5%88%B6"><span class="nav-text">协议的多路复用机制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E-TCP-%E6%89%8B%E5%86%99-Dubbo-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text">基于 TCP 手写 Dubbo 客户端</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">743</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">53</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/ef04d10a.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Dubbo 2 巩固教程之一 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍 Dubbo 的巩固教程。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Dubbo 2 巩固教程之一</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-09-11 23:42:35" itemprop="dateCreated datePublished" datetime="2019-09-11T23:42:35+08:00">2019-09-11</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2025-09-11 23:42:35" itemprop="dateModified" datetime="2025-09-11T23:42:35+08:00">2025-09-11</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/ef04d10a.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/ef04d10a.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>15k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>13 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/d484ffa3.html">Dubbo 2 入门教程之一</a>、<a href="/posts/ad584707.html">Dubbo 2 入门教程之二</a>、<a href="/posts/fab9c84c.html">Dubbo 2 入门教程之三</a>、<a href="/posts/b66ba452.html">Dubbo 2 入门教程之四</a>、<a href="/posts/ab89c617.html">Dubbo 2 入门教程之五</a></li><li><a href="/posts/ef04d10a.html">Dubbo 2 巩固教程之一</a>、<a href="/posts/b6d5fbb8.html">Dubbo 2 巩固教程之二</a>、<a href="/posts/ea9ce835.html">Dubbo 2 巩固教程之三</a></li></ul><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="学习资源"><a href="#学习资源" class="headerlink" title="学习资源"></a>学习资源</h3><ul><li><a target="_blank" rel="external nofollow" href="https://github.com/apache/incubator-dubbo/">Dubbo 官方项目</a></li><li><a target="_blank" rel="external nofollow" href="https://dubbo.apache.org/zh-cn/">Dubbo 官方文档</a></li><li><a target="_blank" rel="external nofollow" href="https://github.com/apache/dubbo-samples">Dubbo 官方案例</a></li></ul><span id="more"></span><h2 id="Dubbo-核心特性"><a href="#Dubbo-核心特性" class="headerlink" title="Dubbo 核心特性"></a>Dubbo 核心特性</h2><h3 id="通信协议"><a href="#通信协议" class="headerlink" title="通信协议"></a>通信协议</h3><div class="admonition warning"><p class="admonition-title">特别注意</p><ul><li>Dubbo 支持多种通信协议，在 <code>3.0</code> 版本之前支持 Dubbo、gRPC、Hessian2、REST 等核心通信协议。</li><li>从 Dubbo <code>3.0</code> 开始，Dubbo 官方新引入了自研的 Triple 通信协议，不过也保留了 Dubbo 和 REST 通信协议的支持。</li><li>从 Dubbo <code>3.2</code> 开始，Dubbo 官方已经废弃原有的 gRPC 通信协议，使用 Triple 通信协议进行替代，Triple 通信协议完全兼容 gRPC 通信协议。</li><li>从 Dubbo <code>3.3</code> 开始，Dubbo 官方直接移除了 REST 通信协议的直接支持，使用 Triple 通信协议间接支持 REST 通信协议。</li></ul></div><ul><li>Dubbo 3 支持的通信协议</li></ul><table><thead><tr><th>通信协议</th><th>通信协议名 / 标识</th><th>传输层</th><th>核心特性</th><th>适用场景</th><th>是否为默认通信协议</th></tr></thead><tbody><tr><td> Dubbo 通信协议</td><td><code>dubbo</code></td><td>TCP</td><td> 单一长连接、NIO 异步通信、高性能</td><td>高并发小数据量场景（消费者数 &gt;&gt; 提供者）</td><td>是</td></tr><tr><td> Triple 通信协议</td><td><code>tri</code></td><td>HTTP/2</td><td> 兼容 gRPC 生态、支持流式通信、跨语言能力增强</td><td>多语言交互、流式数据传输</td><td>否</td></tr><tr><td> REST 通信协议</td><td><code>rest</code></td><td>HTTP</td><td> 严格遵循 RESTful 规范、支持 JSON/XML 格式</td><td>浏览器调用、跨平台集成</td><td>否</td></tr><tr><td> gRPC 通信协议</td><td><code>grpc</code></td><td>HTTP/2</td><td>Google 开源 RPC 框架、高性能跨语言通信</td><td>跨语言高性能服务调用</td><td>否</td></tr><tr><td> Thrift 通信协议</td><td><code>thrift</code></td><td>TCP</td><td>Apache 开源 RPC 框架、强类型接口定义</td><td>多语言服务交互</td><td>否</td></tr><tr><td> Hessian 通信协议</td><td><code>hessian</code></td><td>HTTP</td><td> 表单序列化、短连接、传输效率优于 WebService</td><td> 文件 / 视频等大数据传输</td><td>否</td></tr><tr><td> HTTP 通信协议</td><td><code>http</code></td><td>HTTP</td><td> 通用同步传输、支持表单序列化</td><td>混合数据大小场景</td><td>否</td></tr><tr><td> Redis 通信协议</td><td><code>redis</code></td><td>文本通信协议</td><td>基于 Redis 的轻量级通信</td><td>缓存操作、简单消息队列</td><td>否</td></tr><tr><td> MQTT 通信协议</td><td><code>mqtt</code></td><td>TCP</td><td> 发布 / 订阅模式、低带宽占用</td><td>物联网设备通信</td><td>否</td></tr><tr><td> WebService</td><td><code>webservice</code></td><td>HTTP</td><td> 基于 SOAP 通信协议、XML 序列化</td><td>传统企业系统集成</td><td>否</td></tr></tbody></table><ul><li>通信协议的选择对比</li></ul><table><thead><tr><th>维度</th><th> Triple</th><th>Dubbo</th><th>REST</th><th>gRPC</th></tr></thead><tbody><tr><td> 性能</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐</td><td>⭐⭐⭐⭐</td></tr><tr><td>跨语言</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>流式通信</td><td>支持</td><td>不支持</td><td>不支持</td><td>支持</td></tr><tr><td>浏览器兼容</td><td>支持</td><td>不支持</td><td>直接支持</td><td>需要依赖 Gateway（网关）</td></tr><tr><td>配置复杂度</td><td>低</td><td>低</td><td>中</td><td>高</td></tr></tbody></table><div class="admonition note"><p class="admonition-title">Dubbo 通信协议的使用</p><p>更多关于 Dubbo 通信协议的介绍和使用案例可以看 <a href="/posts/fab9c84c.html#%E5%A4%9A%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE%E5%8F%91%E5%B8%83">这里</a>。</p></div><h3 id="序列化协议"><a href="#序列化协议" class="headerlink" title="序列化协议"></a>序列化协议</h3><ul><li>Dubbo 支持的序列化协议</li></ul><table><thead><tr><th>序列化协议</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td> Hessian2（默认协议）</td><td>- 跨语言支持好<br>- 二进制序列化，协议紧凑<br>- 使用简单，Dubbo 原生支持</td><td> - 性能中等，不是最高<br>- 不支持对象引用共享</td><td>默认通用场景，适合大多数 RPC 调用</td></tr><tr><td> FastJson（JSON 格式）</td><td>- 可读性强，易于调试<br>- 跨语言方便，尤其适合前端交互</td><td> - 文本冗余，体积大<br>- 性能低于二进制序列化协议（如 Hessian、Protobuf）</td><td>需要与前端或非 Java 系统交互，或调试、日志记录场景</td></tr><tr><td> GSON（JSON 格式）</td><td>- 可读性强，易于调试<br>- 跨语言方便，尤其适合前端交互</td><td> - 文本冗余，体积大<br>- 性能低于二进制序列化协议（如 Hessian、Protobuf）</td><td>需要与前端或非 Java 系统交互，或调试、日志记录场景</td></tr><tr><td> Kryo</td><td>- 高性能，二进制序列化速度快<br>- 体积小<br>- 支持对象图</td><td> - 不支持跨语言<br>- 需要手动注册类才能获得最佳性能</td><td>内部 Java 服务之间的高性能 RPC 调用，大数据领域用得较多</td></tr><tr><td> FST（Fast-Serialization）</td><td>- 二进制序列化速度快，性能接近 Kryo<br>- 使用更简单</td><td> - 不支持跨语言<br>- 对类版本变化敏感</td><td>内部 Java 服务之间的高性能 RPC 调用</td></tr><tr><td> Protobuf（Google Protocol Buffers）</td><td>- 高性能，二进制序列化速度快<br>- 体积小<br>- 强类型定义<br>- 跨语言支持好</td><td> - 需要 <code>.proto</code> 文件定义<br>- 学习成本高</td><td>跨语言、高性能 RPC 或需要协议稳定性的场景</td></tr><tr><td> Protostuff（基于 Protobuf）</td><td>- 高性能二进制序列化，速度快、体积小<br>- 无需 <code>.proto</code> 文件定义，直接支持 Java POJO<br>- 序列化 / 反序列化效率显著高于 Hessian2</td><td>- 仅适用于 Java 环境（不支持跨语言）<br>- 对象类结构变化后兼容性较差（需保持字段一致）</td><td>对性能要求高的 Java 内部服务调用，如高并发、高吞吐的微服务场景</td></tr><tr><td> Avro</td><td>- Hadoop 的子项目<br>- 支持动态 Schema<br>- 跨语言支持好<br>- 二进制序列化</td><td> - 性能不如 Protobuf<br>- 使用复杂</td><td>大数据场景，如 Kafka、Hadoop，需要动态 Schema</td></tr><tr><td>Java 原生序列化</td><td> - Java 原生支持，无需额外依赖<br>- 保留完整对象结构<br>- 二进制序列化</td><td> - 体积大，性能低<br>- 安全性差（反序列化漏洞风险高）<br>- 不支持跨语言</td><td>仅用于内部 Java 服务调试或原型验证，不建议生产使用</td></tr></tbody></table><ul><li> Dubbo 序列化协议的选择建议</li></ul><table><thead><tr><th>场景</th><th>推荐的序列化协议</th><th>说明</th></tr></thead><tbody><tr><td>默认场景（通用 RPC 调用）</td><td>Hessian2</td><td>Dubbo 默认的序列化协议，跨语言支持好、易用，性能中等，适合大多数场景</td></tr><tr><td> Java 内部高性能 RPC 调用</td><td> Protostuff、Kryo、FST</td><td> 二进制序列化速度快、体积小，适合 Java 内部服务之间的高性能调用</td></tr><tr><td>跨语言且追求极致性能</td><td> Protobuf</td><td> 高性能、体积小、跨语言支持好，但需要 <code>.proto</code> 文件定义，学习成本较高</td></tr><tr><td>调试或日志场景</td><td> FastJson</td><td> 可读性强，易于调试，适合调试、日志记录或与前端交互，但性能较低</td></tr><tr><td>不建议使用</td><td> Java 原生序列化</td><td>性能低、体积大、安全性差（反序列化漏洞风险高），仅适合内部调试或原型验证</td></tr></tbody></table><div class="admonition note"><p class="admonition-title">提示</p><ul><li>各种 Java 的序列化库的性能测试比较结果可以看 <a target="_blank" rel="external nofollow" href="https://www.51cto.com/article/480273.html">这里</a> 或者 <a target="_blank" rel="external nofollow" href="https://github.com/eishay/jvm-serializers/wiki">GitHub Wiki</a>。</li><li>更多关于 Dubbo 序列化协议的介绍和使用案例可以看 <a href="/posts/fab9c84c.html#%E5%BA%8F%E5%88%97%E5%8C%96%E5%8D%8F%E8%AE%AE">这里</a>。</li></ul></div><h3 id="负载均衡策略"><a href="#负载均衡策略" class="headerlink" title="负载均衡策略"></a>负载均衡策略</h3><ul><li>Dubbo 提供了五种负载均衡策略，如下所示：</li></ul><table><thead><tr><th>负载均衡策略</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td> RandomLoadBalance</td><td> 随机（默认策略），支持按权重设置随机概率</td><td>适用于请求量分散、服务性能相近的场景，能保证简单有效的负载均衡效果</td></tr><tr><td> RoundRobinLoadBalance</td><td> 轮询，支持按公约后的权重设置轮询比率</td><td>适用于服务节点性能相近、需要保证调用次数均匀的场景</td></tr><tr><td> LeastActiveLoadBalance</td><td> 最少活跃调用数，支持相同活跃数的权重随机</td><td>适用于服务性能差异较大或请求响应时间差异较大的场景，能提高请求分配效率</td></tr><tr><td> ConsistentHashLoadBalance</td><td> 一致性哈希，相同参数的请求总是发送到同一个服务提供者</td><td>适用于需要保证请求一致性的场景，例如：缓存服务或用户会话粘性</td></tr><tr><td> ShortestResponseLoadBalance</td><td> 最短响应时间优先，选择响应时间最短的服务提供者</td><td>适用于请求响应时间差异较大，且希望优先使用低延迟服务节点的场景</td></tr></tbody></table><p><img data-src="../../../asset/2024/12/dubbo-13.png"></p><div class="admonition note"><p class="admonition-title">Dubbo 负载均衡策略的使用</p><ul><li><a href="/posts/ad584707.html#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">Dubbo 负载均衡策略的使用案例</a></li></ul></div><h3 id="集群容错策略"><a href="#集群容错策略" class="headerlink" title="集群容错策略"></a>集群容错策略</h3><ul><li>Dubbo 提供了八种集群容错策略，如下所示：</li></ul><table><thead><tr><th>集群容错策略</th><th>策略名称</th><th>策略说明</th><th>适用场景</th></tr></thead><tbody><tr><td> Failover</td><td> 故障转移</td><td>默认策略，当出现服务调用失败，重试调用其它服务器，默认重试 2 次，使用 <code>retries</code> 属性配置重试次数</td><td>通常用于读操作（幂等操作），如查询数据时可以容忍偶尔失败并重试的场景</td></tr><tr><td> Failfast</td><td> 快速失败</td><td>消费者只发起一次调用，若失败则立即抛出异常，类似于 Failover 集群容错策略中重试次数设置为 0 的情况</td><td>通常用于写操作（非幂等操作），如数据插入操作，失败时不应该重试</td></tr><tr><td> Failsafe</td><td> 失败安全</td><td>当消费者调用提供者出现异常时，只会打印异常，而不会抛出异常，即直接忽略本次消费操作，返回一个空结果</td><td>适用于不重要的操作，如日志记录或监控信息上报，出现失败不影响整体业务逻辑</td></tr><tr><td> Failback</td><td> 失败自动恢复</td><td>在消费者调用失败后，返回一个空结果。Dubbo 会在内存中记录下（非持久化）该失败请求，并通过定时任务对失败的调用进行重试，且重试间隔默认是 5 秒（不可配置）</td><td>通常用于消息通知操作，如异步通知，失败后可自动补偿</td></tr><tr><td> Forking</td><td> 并行调用</td><td>消费者对于同一服务会并行调用多个提供者服务器，只要有一个成功就调用结束，并返回结果</td><td>通常用于实时性要求较高的读操作，但需要浪费更多的服务资源，可通过 <code>forks = "2"</code> 来设置最大并行数</td></tr><tr><td> Broadcast</td><td> 广播调用</td><td>通过广播调用所有提供者，逐个调用，任意一个提供者报错则报错</td><td>适用于更新配置或通知所有服务提供者的场景，如缓存更新或者服务健康检查</td></tr><tr><td> ZoneAware</td><td> 区域感知集群</td><td>当部署了多个机房或区域（Zone）时，优先调用同一机房的服务提供者，以降低跨区调用延迟和网络风险</td><td>适用于多区域部署场景，优先减少跨区域网络延迟的情况下实现高效负载均衡</td></tr><tr><td> Mergeable</td><td> 结果合并集群</td><td>调用多个服务提供者，并将多个服务提供者的调用结果进行合并，最终返回合并后的结果</td><td>适用于需要聚合结果的场景，例如分布式查询、汇总统计等操作</td></tr></tbody></table><div class="admonition note"><p class="admonition-title">Dubbo 集群容错策略的使用</p><ul><li><a href="/posts/ad584707.html#%E9%9B%86%E7%BE%A4%E5%AE%B9%E9%94%99">Dubbo 集群容错策略的使用案例</a></li></ul></div><ul><li><code>FailbackCluster</code>（失败自动恢复）的使用问题<ul><li>问题描述：<ul><li>调用失败的记录只存储在内存中，应用重启或进程崩溃后，重试记录将会丢失，导致重试机制失效。</li><li>这种重试机制不适用于核心业务，比如支付交易、订单创建、库存扣减、用户积分更新等。</li></ul></li><li>问题解决：<ul><li>第一种方案：<ul><li>Dubbo 调用改为消息驱动，使用 MQ 做调用的缓冲与重试。<ul><li>(1) 生产者不直接调用 Dubbo 服务，而是先将消息写入 MQ 中；</li><li>(2) 由一个消息消费服务订阅 MQ 消息，然后执行 Dubbo RPC 调用（基于 Dubbo 原生 API 实现泛化调用）；</li><li>(3) 如果 Dubbo RPC 调用失败，可以将消息写入到延迟队列中，直到 RPC 调用成功；</li><li>(4) 如果重试调用次数达到最大重试次数，则将消息写入死信队列。</li><li>(5) 为了避免重复调用，需要实现幂等性，比如使用数据库唯一约束（如 <code>requestId</code> 字段）、Redis 缓存（如 <code>SETNX</code>）等。</li></ul></li></ul></li><li>第二种解决方案：<ul><li>(1) 自定义扩展 <code>FailbackCluster</code> 的实现；</li><li>(2) 将失败记录写入外部存储（如 Redis、DB）；</li><li>(3) 创建后台线程，每隔固定时间扫描一次外部存储，尝试重新调用 Dubbo 服务（基于 Dubbo 原生 API 实现泛化调用）；</li><li>(4) 当重试调用成功返回时，将对应的失败记录从外部存储中删除，避免重复调用和数据堆积；</li><li>(5) 应用重启后重新加载未完成的失败记录，并继续由后台线程执行重试逻辑；</li><li>(6) 为了避免重复调用，需要实现幂等性，比如使用数据库唯一约束（如 <code>requestId</code> 字段）、Redis 缓存（如 <code>SETNX</code>）等。</li></ul></li></ul></li><li>方案对比：<table><thead><tr><th>对比维度</th><th> MQ（Kafka / RabbitMQ / RocketMQ）</th><th>Redis / MySQL</th></tr></thead><tbody><tr><td> 数据持久化</td><td>内置持久化到 Broker</td><td> 持久化到外部存储，需要自己实现</td></tr><tr><td>应用重启恢复</td><td>重启后仍可消费未完成消息</td><td>重启后可读取失败记录，依赖自定义逻辑</td></tr><tr><td>重试保障</td><td>原生支持延迟重试和死信队列</td><td>需定时任务扫描和手动实现延迟 / 死信机制</td></tr><tr><td>吞吐能力</td><td>高，支持大规模并发</td><td>中等，定时扫描会成为性能瓶颈</td></tr><tr><td>延迟控制</td><td>原生支持延迟队列</td><td>延迟不可控，依赖扫描频率</td></tr><tr><td>实现复杂度</td><td>中等，需要部署 MQ，但重试逻辑成熟</td><td>低 - 中，不依赖额外中间件，但需自己实现重试和死信机制</td></tr><tr><td>适用场景</td><td>核心业务，如订单、支付、交易</td><td>弱异步业务，如日志、通知、监控埋点等，可容忍一定延迟或失败</td></tr><tr><td>维护成本</td><td>低，MQ 自带可靠机制</td><td>高，定时任务、重试逻辑和死信处理需自行维护</td></tr></tbody></table></li></ul></li></ul><div class="admonition warning"><p class="admonition-title">Dubbo 的泛化调用是什么</p><p>普通的 Dubbo 调用依赖接口类，会进行编译期类型检查，适合直接业务调用。而泛化调用则不依赖接口类，只通过接口名称和方法信息在运行时进行调用，参数类型通过字符串描述，适合消息化、动态调用、异步或重试场景。</p></div><h2 id="Dubbo-深入理解"><a href="#Dubbo-深入理解" class="headerlink" title="Dubbo 深入理解"></a>Dubbo 深入理解</h2><h3 id="RMI-协议"><a href="#RMI-协议" class="headerlink" title="RMI 协议"></a>RMI 协议</h3><p>Dubbo 支持使用 RMI 协议作为通信协议，但 RMI 的性能相对较低，不推荐用于高并发场景，更适合系统内部或旧系统集成场景。若需要高性能的通信，建议使用 Dubbo、Hessian、Thrift、gRPC 等通信协议。</p><h4 id="RMI-协议的介绍"><a href="#RMI-协议的介绍" class="headerlink" title="RMI 协议的介绍"></a>RMI 协议的介绍</h4><ul><li><p>RMI 协议的简介</p><ul><li>Dubbo 的 RMI 协议是基于 Java 原生 RMI 实现的，要求服务消费者与服务提供者均为 Java 应用</li><li> Dubbo 的 RMI 协议采用 JDK 标准的 <code>java.rmi</code> 实现，并采用阻塞式短连接和 JDK 序列化（二进制格式）</li><li>如果 Dubbo 使用 RMI 协议提供服务给外部访问，且应用里依赖了旧版本的 <code>common-collections</code> 包的情况下，则可能会存在反序列化安全风险</li></ul></li><li><p> RMI 协议的特性</p><ul><li>连接个数：多连接</li><li>连接方式：短连接</li><li>传输协议：TCP 协议</li><li>传输方式：同步通信</li><li>跨语言支持：不支持跨语言</li><li>序列化协议：JDK 序列化（二进制格式）</li><li>注意事项：<ul><li>RMI 协议的性能相对较低，不推荐用于高并发场景</li></ul></li><li>适用场景：<ul><li>适用于针对 Java 的常规远程过程调用（RPC）</li><li>适用于与原生 Java RMI 服务互通，便于系统间集成与迁移</li><li>适用于系统内部或旧系统集成场景</li></ul></li><li>适用范围：<ul><li>适用于传入、传出参数数据量中等、消费者与提供者数量差不多的场景</li><li>适用于 Java 对象和文件等可序列化数据的传输</li></ul></li></ul></li><li><p> RMI 协议的注意事项</p><ul><li>方法参数及返回值需要实现 <code>Serializable</code> 接口</li><li> Dubbo 配置中的超时时间（<code>timeout</code>）对 RMI 协议无效，需要使用 JVM 启动参数设置 RMI 协议的超时时间（单位毫秒）：<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-Dsun.rmi.transport.connectionTimeout=3000      # 建立连接的超时时间</span><br><span class="line">-Dsun.rmi.transport.tcp.responseTimeout=3000    # 响应超时时间（重点）</span><br><span class="line">-Dsun.rmi.transport.proxy.connectTimeout=3000   # 代理连接的超时时间</span><br></pre></td></tr></tbody></table></figure></li></ul></li></ul><h4 id="RMI-协议的使用"><a href="#RMI-协议的使用" class="headerlink" title="RMI 协议的使用"></a>RMI 协议的使用</h4><ul><li><p>RMI 服务接口的定义</p><ul><li>如果服务接口继承了 <code>java.rmi.Remote</code> 接口，可以和 Java 原生 RMI 服务相互操作<ul><li>服务提供者使用 Dubbo 的 RMI 协议暴露服务，服务消费者直接使用标准 RMI 接口调用服务；</li><li>或者，服务提供者使用标准 RMI 接口暴露服务，服务消费者使用 Dubbo 的 RMI 协议调用服务。</li></ul></li><li>如果服务接口没有继承 <code>java.rmi.Remote</code> 接口<ul><li> Dubbo 默认会自动生成一个 <code>com.xxx.XxxServiceRemote</code> 接口，并继承 <code>java.rmi.Remote</code> 接口，并以该接口暴露服务；</li><li>但是，如果设置了 <code>&lt;dubbo:protocol name="rmi" codec="spring"/&gt;</code>，Dubbo 将不会自动生成 <code>Remote</code> 接口，而是使用 Spring 提供的 <code>RmiInvocationHandler</code> 接口来暴露服务，可以和 Spring 兼容。</li></ul></li><li><strong>由于 Dubbo 的 RMI 协议是基于 Java 原生 RMI 实现的，并且使用 JDK 序列化（二进制格式）机制，因此 Dubbo 应用（基于 Java 开发）无需引入第三方包就可以直接使用 RMI 协议</strong>。</li></ul></li><li><p>RMI 协议的的配置示例</p><ul><li>服务提供者的配置<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 应用信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"rmi-provider"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 注册中心 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">"zookeeper://127.0.0.1:2181"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 使用 RMI 协议 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">"rmi"</span> <span class="attr">port</span>=<span class="string">"1099"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 服务暴露 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">"com.example.api.HelloService"</span> <span class="attr">ref</span>=<span class="string">"helloServiceImpl"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 服务实现 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"helloServiceImpl"</span> <span class="attr">class</span>=<span class="string">"com.example.provider.HelloServiceImpl"</span>/&gt;</span></span><br></pre></td></tr></tbody></table></figure></li><li>服务消费者的配置<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 应用信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"rmi-consumer"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 注册中心 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">"zookeeper://127.0.0.1:2181"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 服务引用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">"helloService"</span> <span class="attr">interface</span>=<span class="string">"com.example.api.HelloService"</span> <span class="attr">url</span>=<span class="string">"rmi://127.0.0.1:1099"</span>/&gt;</span></span><br></pre></td></tr></tbody></table></figure></li></ul></li></ul><div class="admonition note"><p class="admonition-title">RMI 协议的使用案例</p><ul><li>Dubbo 使用 RMI 协议的完整案例代码可以直接从 <a target="_blank" rel="external nofollow" href="https://github.com/rqh656418510/spring-cloud-share/tree/main/rpc-framework/dubbo-study/dubbo2.x-study">GitHub</a> 下载对应章节 dubbo-lesson-13。</li></ul></div><h3 id="HTTP-协议"><a href="#HTTP-协议" class="headerlink" title="HTTP 协议"></a>HTTP 协议</h3><div class="admonition note"><p class="admonition-title">参考博客</p><ul><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/qq454549798/article/details/121635640">Jsonrpc4j 的异常抛出处理</a></li><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/gitblog_00161/article/details/141844932">JSON-RPC for Java 使用教程</a></li><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/muyun2800/article/details/150549402">利用 Jsonrpc4j 构建 JSON-RPC 服务</a></li></ul></div><h4 id="HTTP-协议的介绍"><a href="#HTTP-协议的介绍" class="headerlink" title="HTTP 协议的介绍"></a>HTTP 协议的介绍</h4><ul><li><p>HTTP 协议的简介</p><ul><li>基于 HTTP 的远程过程调用协议，采用 Spring 的 <code>HttpIvoker</code> 实现。</li><li>使用 HTTP 协议可以让服务通过 HTTP 端口暴露，便于浏览器或者非 Dubbo 客户端调用。</li><li>Dubbo 通过 Protocol SPI 扩展支持 HTTP 协议，但功能有限。如果需要支持浏览器 JSON/HTTP 调用，通常需要配合 <code>Jsonrpc4j</code> 等一起使用。</li></ul></li><li><p>HTTP 协议的特性</p><ul><li>连接个数：多连接</li><li>连接方式：短连接</li><li>传输协议：HTTP 协议</li><li>传输方式：同步通信</li><li>序列化：JSON 序列化</li><li>跨语言支持：支持跨语言</li><li>适用范围：<ul><li>服务提供者数量通常多于服务消费者数量</li><li>可通过浏览器直接访问和调试服务</li><li>参数可以通过 URL 或表单方式传递</li><li>暂不适合传输大文件</li></ul></li><li>适用场景：<ul><li>适合需要同时被应用程序和浏览器端 JavaScript 调用的服务</li></ul></li></ul></li><li><p> HTTP 协议的注意事项</p><ul><li><strong>Dubbo 的 HTTP 协议并不是标准 REST/HTTP，而是基于 JSON-RPC 的 RPC 调用，强烈建议 Dubbo 使用 <a href="/posts/f0051416.html">REST 协议</a>来替代 HTTP 协议。</strong></li><li>Dubbo 的 HTTP 协议要求：<ul><li>必须是 POST 请求</li><li> HTTP 请求体必须严格符合的 JSON-RPC 格式</li></ul></li><li> Dubbo 使用 HTTP 协议后，可以通过 <code>curl</code> 等网络工具直接调用 Provider 对外提供的 JSON-RPC 服务，URL 格式：<code>http://ip:port/&lt;接口全限定名&gt;</code>，比如：<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword"># curl</span> 调用命令</span><br><span class="line">curl<span class="params"> -X</span> POST http://127.0.0.1:8030/com.clay.dubbo.service.DemoService \<span class="params"></span></span><br><span class="line"><span class="params">-H</span> <span class="string">"Content-Type: application/json"</span> \<span class="params"></span></span><br><span class="line"><span class="params">-d</span> <span class="string">'{"jsonrpc":"2.0", "method":"sayHello","params":["Jim"],"id":1}'</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 返回结果</span></span><br><span class="line">{<span class="string">"jsonrpc"</span>:<span class="string">"2.0"</span>,<span class="string">"id"</span>:1,<span class="string">"result"</span>:<span class="string">"Hello Jim"</span>}</span><br></pre></td></tr></tbody></table></figure></li></ul></li></ul><div class="admonition note"><p class="admonition-title">HTTP 协议的使用案例</p><ul><li>Dubbo 使用 HTTP 协议的完整案例代码可以直接从 <a target="_blank" rel="external nofollow" href="https://github.com/rqh656418510/spring-cloud-share/tree/main/rpc-framework/dubbo-study/dubbo2.x-study">GitHub</a> 下载对应章节 dubbo-lesson-15。</li></ul></div><h4 id="HTTP-协议的使用"><a href="#HTTP-协议的使用" class="headerlink" title="HTTP 协议的使用"></a>HTTP 协议的使用</h4><ul><li><p>HTTP 协议支持的 Server</p><ul><li>目前在 Dubbo 2 中，HTTP 协议可以跑在以下几种不同的 Server 上，分别是：<ul><li><code>Jetty</code>：基于嵌入式 Jetty 的 HTTP Server，通过 <code>&lt;dubbo:protocol name="rest" port="8080" server="jetty"/&gt;</code> 来配置。</li><li><code>Tomcat</code>：基于嵌入式 Tomcat 的 HTTP Server，通过 <code>&lt;dubbo:protocol name="rest" port="8080" server="tomcat"/&gt;</code> 来配置。</li><li><code>Servlet</code>：采用外部应用服务器的 Servlet 容器（如外部 Tomcat）来做 HTTP Server，通过 <code>&lt;dubbo:protocol name="rest" server="servlet"/&gt;</code> 来配置，<strong>这里不需要配置端口</strong>，另外还需要在 <code>web.xml</code> 中做额外的其他配置。</li></ul></li></ul></li><li><p>HTTP 协议的配置示例</p><ul><li>服务提供者中的配置：<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Dubbo 核心包 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.23<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-rpc-http<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.23<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 应用信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"rmi-provider"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 注册中心 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">"zookeeper://127.0.0.1:2181"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 使用 HTTP 协议 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">"http"</span> <span class="attr">port</span>=<span class="string">"8030"</span> <span class="attr">server</span>=<span class="string">"tomcat"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 服务暴露 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">"com.example.api.HelloService"</span> <span class="attr">ref</span>=<span class="string">"helloServiceImpl"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 服务实现 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"helloServiceImpl"</span> <span class="attr">class</span>=<span class="string">"com.example.provider.HelloServiceImpl"</span>/&gt;</span></span><br></pre></td></tr></tbody></table></figure></li><li>服务消费者中的配置：<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Dubbo 核心包 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.23<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-rpc-http<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.23<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 应用信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"rmi-consumer"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 注册中心 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">"zookeeper://127.0.0.1:2181"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 服务引用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">"helloService"</span> <span class="attr">interface</span>=<span class="string">"com.example.api.HelloService"</span> <span class="attr">url</span>=<span class="string">"rmi://127.0.0.1:1099"</span>/&gt;</span></span><br></pre></td></tr></tbody></table></figure></li><li>当 Dubbo 成功使用 HTTP 协议作为通信协议后，可以通过 <code>curl</code> 等网络工具直接调用 Provider 对外提供的 JSON-RPC 服务，这样服务就可以同时被应用程序和浏览器端 JavaScript 直接调用<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword"># curl</span> 调用命令</span><br><span class="line">curl<span class="params"> -X</span> POST http://127.0.0.1:8030/com.clay.dubbo.service.DemoService \<span class="params"></span></span><br><span class="line"><span class="params">-H</span> <span class="string">"Content-Type: application/json"</span> \<span class="params"></span></span><br><span class="line"><span class="params">-d</span> <span class="string">'{"jsonrpc":"2.0", "method":"sayHello","params":["Jim"],"id":1}'</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 返回结果</span></span><br><span class="line">{<span class="string">"jsonrpc"</span>:<span class="string">"2.0"</span>,<span class="string">"id"</span>:1,<span class="string">"result"</span>:<span class="string">"Hello Jim"</span>}</span><br></pre></td></tr></tbody></table></figure></li></ul></li></ul><h3 id="Thrift-协议"><a href="#Thrift-协议" class="headerlink" title="Thrift 协议"></a>Thrift 协议</h3><div class="admonition note"><p class="admonition-title">参考博客</p><ul><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/shumeizwb/article/details/140430907">生产环境慎用 Thrift 协议</a></li><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/qq_44036439/article/details/135585283">Thrift &amp; Thrift 和 Dubbo 的区别</a></li></ul></div><h4 id="Thrift-协议的介绍"><a href="#Thrift-协议的介绍" class="headerlink" title="Thrift 协议的介绍"></a>Thrift 协议的介绍</h4><ul><li><p>Thrift 协议的简介</p><ul><li>Apache Thrift 协议最初是由 Facebook 开源的高性能、跨语言的远程过程调用（RPC）协议，它通过接口定义语言（IDL）定义服务，并使用二进制编码格式进行高效的数据序列化和通信。</li><li>当前 Dubbo 的 Thrift 协议是对 Apache Thrift 原生协议的扩展，即在 Apache Thrift 原生协议的基础上添加了一些额外的头信息，比如 <code>service name</code>，<code>magic number</code> 等。</li><li>使用 Dubbo 的 Thrift 协议时，需要先使用 Apache Thrift 的 IDL 编译器根据 <code>.thrift</code> 文件编译生成相应的 Java 接口代码（使用流程类似 gRPC），后续版本中会在这方面做一些增强。</li><li>Dubbo 的 Thrift 协议与 Apache Thrift 原生协议不兼容，因此无法直接实现跨语言互相调用，仅用在 Dubbo 内部服务之间的通信。</li></ul></li><li><p>Thrift 协议的特性</p><ul><li>连接个数：多连接（基于 TCP，支持并发连接）</li><li>连接方式：长连接（保持会话连接，减少 TCP 握手开销）</li><li>传输协议：TCP 协议</li><li>传输方式：同步通信</li><li>跨语言支持：不支持跨语言</li><li>序列化：Apache Thrift 原生协议自带的二进制序列化</li><li>适用范围：<ul><li>服务接口通过 <code>.thrift</code> 文件定义，需提前生成服务接口的代码</li><li>适合高性能、低延迟的 RPC 场景</li></ul></li><li>适用场景：<ul><li>适合后端微服务间高频通信（如金融、游戏、即时通讯等领域）</li><li>适合对性能要求较高、接口定义稳定的 Dubbo 内部服务</li></ul></li></ul></li><li><p> Thrift 协议的使用步骤</p><ul><li>(1) 从 <a target="_blank" rel="external nofollow" href="http://thrift.apache.org/download">Thrift 官网</a> 下载 Thrift<ul><li>Windows 平台：可以直接下载 Thrift 的二进制可执行文件，然后配置 Thrift 的环境变量</li><li> Linux 平台：可以下载 Thrift 的源码包，然后手动编译安装 Thrift</li></ul></li><li>(2) 定义 <code>.thrift</code> 文件（IDL）</li><li>(3) 根据 <code>.thrift</code> 文件，通过 <code>thrift</code> 命令自动生成 Java 接口文件<ul><li>比如：<code>thrift -r -gen java HelloThrift.thrift</code></li></ul></li><li>(4) 根据自动生成的 Java 接口文件，实现相应的 Java 接口</li><li><strong>特别注意</strong>，<code>thrift</code> 命令生成的 <code>Iface</code> 类是一个 Java 内部类，在 XML 中通过 Spring Bean 定义引用时，不可以用 <code>.</code> 符号连接，而是需要用 <code>$</code> 符号连接，比如：<ul><li>错误写法：<code>&lt;dubbo:service interface="com.clay.dubbo.thrift.HelloThrift.Iface" ref="helloThrift" /&gt;</code></li><li>正确写法：<code>&lt;dubbo:service interface="com.clay.dubbo.thrift.HelloThrift$Iface" ref="helloThrift" /&gt;</code></li></ul></li></ul></li><li><p>Thrift 协议的注意事项</p><ul><li>Thrift 协议不支持 <code>null</code> 值，也就是不能在 Thrift 协议中传递 <code>null</code> 值数据。</li><li><strong>Dubbo 的 Thrift 协议与 Apache Thrift 原生协议不兼容，因此无法直接实现跨语言互相调用，仅用在 Dubbo 内部服务之间的通信。</strong><ul><li>Dubbo 的 Thrift 协议是基于 Apache Thrift 原生协议实现的扩展版本，用于 Dubbo 框架内部的 Thrift 序列化和网络传输支持，而非与 Apache Thrift 原生服务端或客户端直接交互；</li><li>如果需要通过 Dubbo 实现跨语言的 RPC 调用，建议使用 Dubbo Triple 协议（与 gRPC 完全兼容）。</li></ul></li><li>Dubbo 并未直接使用 Apache Thrift 原生协议的标准服务端（<code>TServer</code> / <code>TProcessor</code>）实现，而是在其协议层之上做了二次封装。<ul><li>Dubbo 的 Thrift 协议虽然使用了 Apache Thrift 原生协议的序列化与网络传输机制，但仍保留了 Dubbo 自身的：<ul><li>服务导出机制</li><li>请求头与协议帧格式</li><li> Service Name 识别方式</li><li> Dubbo 的线程池模型与 Invoker 调用机制</li></ul></li><li>由于这些封装，Dubbo 的 Thrift 协议在底层 Wire Protocol（报文格式 / 字节流格式） 上与 Apache Thrift 原生协议不同，即使接口定义一致，也无法互通。</li></ul></li><li><strong>Thrift 协议在 Dubbo 里的地位相当于 gRPC 协议 —— 它同时定义通信格式和数据序列化格式。</strong><ul><li>Thrift 协议在 Dubbo 中是属于通信协议，但它内部包含了 Apache Thrift 原生协议自带的序列化机制；</li><li>在 Dubbo 的 Thrift 协议中，它并不使用 Dubbo 自己的序列化机制，而是直接使用 Apache Thrift 原生协议内置的编码 / 解码机制；</li><li>在 Dubbo 的 Thrift 协议中，通信格式由 Apache Thrift 原生协议定义，因此它是一个带自有序列化机制的 Dubbo 通信协议。</li></ul></li></ul></li></ul><h4 id="Thrift-协议的使用"><a href="#Thrift-协议的使用" class="headerlink" title="Thrift 协议的使用"></a>Thrift 协议的使用</h4><h5 id="Thrift-的安装"><a href="#Thrift-的安装" class="headerlink" title="Thrift 的安装"></a>Thrift 的安装</h5><ul><li>Thrift 编译安装</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载源码压缩包</span></span><br><span class="line">wget http://archive.apache.org/dist/thrift/0.12.0/thrift-0.12.0.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压源码压缩包</span></span><br><span class="line">tar<span class="params"> -xvf</span> thrift-0.12.0.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入解压目录</span></span><br><span class="line"><span class="built_in">cd</span> thrift-0.12.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成构建系统</span></span><br><span class="line">./bootstrap.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成构建文件（Makefile），建议禁用所有语言库，只生成 Thrift 编译器，避免不必要的依赖和编译</span></span><br><span class="line">./configure<span class="params"> --without</span>-cpp \<span class="params"></span></span><br><span class="line"><span class="params">            --without</span>-c_glib \<span class="params"></span></span><br><span class="line"><span class="params">            --without</span>-python \<span class="params"></span></span><br><span class="line"><span class="params">            --without</span>-py3 \<span class="params"></span></span><br><span class="line"><span class="params">            --without</span>-php \<span class="params"></span></span><br><span class="line"><span class="params">            --without</span>-ruby \<span class="params"></span></span><br><span class="line"><span class="params">            --without</span>-nodejs \<span class="params"></span></span><br><span class="line"><span class="params">            --without</span>-perl \<span class="params"></span></span><br><span class="line"><span class="params">            --without</span>-go \<span class="params"></span></span><br><span class="line"><span class="params">            --without</span>-lua \<span class="params"></span></span><br><span class="line"><span class="params">            --without</span>-haxe \<span class="params"></span></span><br><span class="line"><span class="params">            --without</span>-dart \<span class="params"></span></span><br><span class="line"><span class="params">            --without</span>-erlang \<span class="params"></span></span><br><span class="line"><span class="params">            --without</span>-rust \<span class="params"></span></span><br><span class="line"><span class="params">            --without</span>-swift \<span class="params"></span></span><br><span class="line"><span class="params">            --without</span>-csharp \<span class="params"></span></span><br><span class="line"><span class="params">            --without</span>-kotlin \<span class="params"></span></span><br><span class="line"><span class="params">            --without</span>-d \<span class="params"></span></span><br><span class="line"><span class="params">            --without</span>-java-script \<span class="params"></span></span><br><span class="line"><span class="params">            --without</span>-java</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译源代码</span></span><br><span class="line">make<span class="params"> -j4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装到系统路径（包括可执行文件、头文件和库）</span></span><br><span class="line">sudo make install</span><br></pre></td></tr></tbody></table></figure><ul><li>Thrift 验证安装</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 Thrift 的版本</span></span><br><span class="line">thrift<span class="params"> --version</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 Thrift 文件</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'namespace java com.clay.dubbo.thrift service HelloThrift { string sayHello(1:string name) }'</span> &gt; HelloThrift.thrift</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译 Thrift 文件，生成 Java 接口文件</span></span><br><span class="line">thrift<span class="params"> -r</span><span class="params"> -gen</span> java HelloThrift.thrift</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看生成的 Java 接口文件内容</span></span><br><span class="line">cat gen-java/com/dubbo/study/thrift/HelloThrift.java</span><br></pre></td></tr></tbody></table></figure><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Autogenerated by Thrift Compiler (0.12.0)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * DO NOT EDIT UNLESS YOU ARE SURE THAT YOU KNOW WHAT YOU ARE DOING</span></span><br><span class="line"><span class="comment"> *  <span class="doctag">@generated</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">package</span> com.clay.dubbo.thrift;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings({"cast", "rawtypes", "serial", "unchecked", "unused"})</span></span><br><span class="line"><span class="meta">@javax</span>.annotation.Generated(value = <span class="string">"Autogenerated by Thrift Compiler (0.12.0)"</span>, date = <span class="string">"2019-09-11"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoThrift</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Iface</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> java.lang.<span class="function">String <span class="title">sayHello</span><span class="params">(java.lang.String name)</span> <span class="keyword">throws</span> org.apache.thrift.TException</span>;</span><br><span class="line"></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AsyncIface</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">(java.lang.String name, org.apache.thrift.async.AsyncMethodCallback&lt;java.lang.String&gt; resultHandler)</span> <span class="keyword">throws</span> org.apache.thrift.TException</span>;</span><br><span class="line"></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">    ......（省略）</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>若希望卸载 Thrift（比如想安装其他版本），可以执行以下命令</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 卸载可执行文件</span></span><br><span class="line">sudo rm<span class="params"> -f</span> /usr/<span class="built_in">local</span>/bin/thrift* </span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载库文件</span></span><br><span class="line">sudo rm<span class="params"> -f</span> /usr/<span class="built_in">local</span>/lib/libthrift*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载头文件</span></span><br><span class="line">sudo rm<span class="params"> -rf</span> /usr/<span class="built_in">local</span>/include/thrift</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载文档资源</span></span><br><span class="line">sudo rm<span class="params"> -rf</span> /usr/<span class="built_in">local</span>/share/doc/thrift</span><br></pre></td></tr></tbody></table></figure><h5 id="Thrift-的使用"><a href="#Thrift-的使用" class="headerlink" title="Thrift 的使用"></a>Thrift 的使用</h5><div class="admonition note"><p class="admonition-title">代码下载</p><p>本节将演示 Dubbo 如何使用 Thrift 作为通信协议，完整的案例代码可以直接从 <a target="_blank" rel="external nofollow" href="https://github.com/rqh656418510/spring-cloud-share/tree/main/rpc-framework/dubbo-study/dubbo2.x-study">GitHub</a> 下载对应章节 dubbo-lesson-14。</p></div><blockquote><p>API 模块的代码与配置</p></blockquote><ul><li>(1) 在 API 模块中，创建 Thrift 的 IDL 文件（比如 <code>DemoThrift.thrift</code>）</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">namespace java com.clay.dubbo.thrift</span><br><span class="line"></span><br><span class="line">service DemoThrift {</span><br><span class="line">    string sayHello(1:string name)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>(2) 在 API 模块中，通过 <code>thrift</code> 命令生成 Java 接口文件，并拷贝到 <code>src/main/java</code> 目录下</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编译 Thrift 文件，生成 Java 接口文件</span></span><br><span class="line">thrift<span class="params"> -r</span><span class="params"> -gen</span> java DemoThrift.thrift</span><br></pre></td></tr></tbody></table></figure><ul><li>(3) 在 API 模块中，引入 Dubbo 的 Thrift 依赖</li></ul><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-rpc-thrift<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.23<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><div class="admonition warning"><p class="admonition-title">特别注意</p><ul><li>这个 <code>dubbo-rpc-thrift</code> 模块实现了 Dubbo Protocol SPI 扩展，支持 Thrift RPC 调用；内部依赖了 Apache Thrift 库（<code>libthrift</code>），但大多数 Maven 坐标会自动拉取。</li><li>Thrift 安装的版本（即 <code>thrift</code> 命令的版本），强烈建议跟 Apache Thrift 库（<code>libthrift</code>）的版本保证一致，否则通过 <code>thrift</code> 命令生成的 Java 代码可能无法正常编译。</li></ul></div><blockquote><p>Privoder 模块的代码与配置</p></blockquote><ul><li>(1) 在 Provider 模块中，实现 Thrift 生成的 Java 接口，并暴露 Dubbo 服务</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.clay.dubbo.thrift.DemoThrift;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.annotation.DubboService;</span><br><span class="line"><span class="keyword">import</span> org.apache.thrift.TException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 暴露服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@DubboService</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoServiceImpl</span> <span class="keyword">implements</span> <span class="title">DemoThrift</span>.<span class="title">Iface</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String name)</span> <span class="keyword">throws</span> TException </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>(2) 在 Provider 模块中，添加对应的 Dubbo 配置内容</li></ul><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dubbo-provider-application</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dubbo:</span></span><br><span class="line">  <span class="comment"># 服务信息</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">${spring.application.name}</span></span><br><span class="line">  <span class="comment"># 注册中心地址</span></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="attr">address:</span> <span class="string">zookeeper://192.168.2.235:2181</span></span><br><span class="line">  <span class="comment"># 服务提供者的协议</span></span><br><span class="line">  <span class="attr">protocol:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">thrift</span>    <span class="comment"># 指定使用 Thrift 协议</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">3030</span></span><br><span class="line">  <span class="comment"># 扫描 Dubbo 相关的注解</span></span><br><span class="line">  <span class="attr">scan:</span></span><br><span class="line">    <span class="attr">base-packages:</span> <span class="string">com.clay.dubbo.provider</span></span><br></pre></td></tr></tbody></table></figure><blockquote><p>Consumer 模块的代码与配置</p></blockquote><ul><li>(1) 在 Consumer 模块中，通过 Thrift 生成的 Java 接口引用 Dubbo 服务</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.annotation.DubboReference;</span><br><span class="line"><span class="keyword">import</span> com.clay.dubbo.thrift.DemoThrift;</span><br><span class="line"><span class="keyword">import</span> org.apache.thrift.TException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 引用 Dubbo 服务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@DubboReference</span></span><br><span class="line">    <span class="keyword">private</span> DemoThrift.Iface demoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/sayHello/{name}")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(<span class="meta">@PathVariable("name")</span> String name)</span> <span class="keyword">throws</span> TException </span>{</span><br><span class="line">        String result = demoService.sayHello(name);</span><br><span class="line">        log.info(<span class="string">"===&gt; "</span> + result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>(2) 在 Consumer 模块中，添加对应的 Dubbo 配置内容</li></ul><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9091</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dubbo-consumer-application</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dubbo:</span></span><br><span class="line">  <span class="comment"># 服务信息</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">${spring.application.name}</span></span><br><span class="line">  <span class="comment"># 注册中心地址</span></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="attr">address:</span> <span class="string">zookeeper://192.168.2.235:2181</span></span><br><span class="line">  <span class="comment"># 扫描 Dubbo 相关的注解</span></span><br><span class="line">  <span class="attr">scan:</span></span><br><span class="line">    <span class="attr">base-packages:</span> <span class="string">com.clay.dubbo.consumer</span></span><br><span class="line">  <span class="comment"># 消费行为配置</span></span><br><span class="line">  <span class="attr">consumer:</span></span><br><span class="line">    <span class="comment"># 关闭了启动检查，这样消费者启动时，不会到注册中心里面检查服务提供者是否存在</span></span><br><span class="line">    <span class="attr">check:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 建议统一配置为不重试请求，对于查询等幂等操作来说可以在代码中单独配置重试次数</span></span><br><span class="line">    <span class="attr">retries:</span> <span class="number">0</span></span><br><span class="line">    <span class="comment"># 默认情况下限制请求必须在 1000 毫秒内完成，对于具体服务可以在代码中单独配置</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">1000</span></span><br></pre></td></tr></tbody></table></figure><div class="admonition warning"><p class="admonition-title">Consumer 调用 RPC 服务失败</p><ul><li>Dubbo 配置使用 Thrift 作为通信协议后，如果在 Consumer 调用 Provider 提供的服务时，出现超时现象，则可能是缺少 <code>slf4j-log4j12</code> 包导致，详细说明请看 <a target="_blank" rel="external nofollow" href="https://blog.csdn.net/sunzhemin/article/details/51699671">这里</a>。</li></ul></div><h3 id="Dubbo-协议"><a href="#Dubbo-协议" class="headerlink" title="Dubbo 协议"></a>Dubbo 协议</h3><h4 id="协议的简单介绍"><a href="#协议的简单介绍" class="headerlink" title="协议的简单介绍"></a>协议的简单介绍</h4><p>Dubbo 协议是官方默认协议，其构成、特性、约束如下：</p><ul><li><p>Dubbo 协议的构成</p><ul><li>网络传输框架：Mina、Netty、Grizzy</li><li> 序列化机制：Hessian2、FastJson、GSON、Protobuf、Kryo、FST、Avro、Java 等</li><li>线程分发策略：<code>all</code>、<code>direct</code>、<code>message</code>、<code>execution</code>、<code>connection</code></li><li>线程池类型：<code>fixed</code>、<code>cached</code>、<code>limited</code>、<code>eager</code></li></ul></li><li><p>Dubbo 协议的特性</p><ul><li>连接个数：单连接（基于 TCP，支持多路复用）</li><li>连接方式：长连接（保持会话连接，减少 TCP 握手开销）</li><li>传输协议：TCP 协议</li><li>传输方式：NIO 异步通信</li><li>跨语言支持：不支持跨语言</li><li>序列化协议：Hessian2 二进制序列化</li><li>适用场景：<ul><li>常规的远程过程调用（RPC）</li></ul></li><li>适用范围：<ul><li>服务消费者比服务提供者个数多</li><li>单一服务消费者无法压满服务提供者</li><li>传输的数据包较小（建议小于 100K）</li><li>尽量不要用 Dubbo 协议传输大文件（如音频、视频）或超大字符串</li></ul></li></ul></li><li><p> Dubbo 协议的注意事项</p><ul><li>方法参数及返回值需要实现 <code>Serializable</code> 接口</li><li>方法参数及返回值不能自定义实现 <code>List</code>、<code>Map</code>、<code>Number</code>、<code>Date</code>、<code>Calendar</code> 等接口，只能用 JDK 自带的实现（如 <code>HashMap</code>），因为 Hessian2 序列化会做特殊处理，自定义实现类中的属性值都会丢失</li><li>对于 Hessian2 序列化，只会传成员属性值和值的类型，不会传方法或者静态变量，兼容情况如下表所示：<br><img data-src="../../../asset/2025/09/dubbo-serialize-1.png"></li></ul></li></ul><h4 id="协议的注意事项"><a href="#协议的注意事项" class="headerlink" title="协议的注意事项"></a>协议的注意事项</h4><ul><li><p>为什么 Dubbo 协议不适合传输大数据、大文件的场景？</p><ul><li>核心原因：<ul><li>因为 Dubbo 协议基于长连接和内存缓冲的 RPC 框架，它会将请求数据整体序列化、加载到内存再发送；</li><li>传输大文件会占用大量内存、阻塞网络 I/O 线程、导致 TCP 连接阻塞或超时；</li><li>大文件（如音频、视频）传输这类场景，更适合使用 HTTP、FTP、OSS 等流式传输协议。</li></ul></li><li>举个例子：<ul><li>前提条件：单一长连接、网络为千兆网卡（<code>1024Mbit = 128MByte</code>）；</li><li>假设每个请求的数据包大小为 <code>500KByte</code>；</li><li>假设每条连接最大只能压满 <code>7MByte</code>（不同环境可能不一样，仅供参考）；</li><li>单个服务提供者的最大 TPS：<code>128MByte / 500KByte = 262</code>；</li><li>单个服务消费者调用单个服务提供者的最大 TPS：<code>7MByte / 500KByte = 14</code>；</li><li>如果能接受相应的 TPS，可以考虑使用 Dubbo 协议，否则网络将成为性能瓶颈。</li></ul></li></ul></li><li><p>为什么 Dubbo 协议适合消费者比提供者个数多的场景？</p><ul><li>核心原因：<ul><li>Dubbo 协议基于长连接和 NIO 异步通信，服务消费者与服务提供者之间会建立少量长连接，多个请求会复用这些长连接；</li><li>当服务消费者的数量远多于服务提供者时，连接可复用、资源占用低、性能更高；</li><li>反之，若服务提供者更多，会造成连接过多、内存和句柄开销大，效率反而下降。</li></ul></li><li>举个例子：<ul><li>前提条件：单一长连接、网络为千兆网卡（<code>1024Mbit = 128MByte</code>）；</li><li>根据测试经验数据，每条连接最多只能压满 <code>7MByte</code>（不同环境可能不一样，仅供参考）；</li><li>理论上 1 个服务提供者需要 18（<code>128MByte / 7MByte = 18</code>）个服务消费者才能压满网卡。</li></ul></li></ul></li><li><p>为什么 Dubbo 协议采用单一长连接和 NIO 异步通信？</p><ul><li>核心原因：<ul><li>因为在大多数场景下，服务提供者数量远少于服务消费者，例如某个核心服务只有几台提供者机器，却有成百上千个消费者同时调用；</li><li>如果使用传统的短连接（如 Hessian 服务），频繁地建立与销毁连接会导致服务端资源耗尽、性能下降；</li><li>Dubbo 通过单一长连接维持服务消费者与服务提供者的通信，可以避免过多连接压垮服务端；</li><li>同时采用 NIO 异步通信和线程池复用，提升并发处理能力，有效避免 C10K 问题。</li></ul></li></ul></li></ul><h4 id="协议的详细配置"><a href="#协议的详细配置" class="headerlink" title="协议的详细配置"></a>协议的详细配置</h4><p>Dubbo 协议的配置示例如下：</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dubbo:</span></span><br><span class="line">  <span class="attr">protocol:</span></span><br><span class="line">    <span class="comment"># 协议名称与端口号</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dubbo</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">20880</span></span><br><span class="line">    <span class="comment"># 服务端、客户端的底层通讯实现</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">netty</span></span><br><span class="line">    <span class="attr">client:</span> <span class="string">netty</span></span><br><span class="line">    <span class="comment"># 编解码、序列化</span></span><br><span class="line">    <span class="attr">codec:</span> <span class="string">dubbo</span></span><br><span class="line">    <span class="attr">serialization:</span> <span class="string">hessian2</span></span><br><span class="line">    <span class="attr">charset:</span> <span class="string">UTF-8</span></span><br><span class="line">    <span class="comment"># 线程、队列配置</span></span><br><span class="line">    <span class="attr">dispatcher:</span> <span class="string">all</span></span><br><span class="line">    <span class="attr">threadpool:</span> <span class="string">fixed</span></span><br><span class="line">    <span class="attr">threads:</span> <span class="number">100</span></span><br><span class="line">    <span class="attr">queues:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">lothreads:</span> <span class="number">9</span></span><br><span class="line">    <span class="comment"># 缓存区大小、接受的最大连接数、请求与响应的数据包大小</span></span><br><span class="line">    <span class="attr">buffer:</span> <span class="number">8192</span></span><br><span class="line">    <span class="attr">accepts:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">payload:</span> <span class="number">8388608</span></span><br></pre></td></tr></tbody></table></figure><h4 id="协议的报文格式"><a href="#协议的报文格式" class="headerlink" title="协议的报文格式"></a>协议的报文格式</h4><ul><li><strong>Dubbo 协议的报文结构图</strong></li></ul><p><img data-src="../../../asset/2025/09/dubbo-protocol-struct.png"></p><ul><li> <strong>Dubbo 协议的消息头（固定 16 个字节）</strong></li></ul><table><thead><tr><th>字段</th><th>长度</th><th>作用</th></tr></thead><tbody><tr><td> Magic Number</td><td>2 字节</td><td>魔数（通信协议标识），Dubbo 协议是固定值 <code>0xdabb</code></td></tr><tr><td>Flag</td><td>1 字节</td><td>请求 / 响应标识</td></tr><tr><td> Status</td><td>1 字节</td><td>响应状态</td></tr><tr><td> Request ID</td><td>8 字节</td><td>请求的唯一标识</td></tr><tr><td> Body Length</td><td>4 字节</td><td>请求体的长度</td></tr></tbody></table><ul><li> <strong>Dubbo 协议的消息体（具体的业务操作内容）</strong></li></ul><table><thead><tr><th>字段名</th><th>说明</th></tr></thead><tbody><tr><td> RPC 版本</td><td> Dubbo RPC 协议的版本号（比如 <code>2.0.2</code>）</td></tr><tr><td>服务接口路径</td><td>服务接口的全限定名（比如 <code>com.example.UserService</code>）</td></tr><tr><td>服务版本号</td><td>服务的版本信息（比如 <code>1.0.0</code>）</td></tr><tr><td>服务方法名</td><td>调用的具体方法名称（比如 <code>getUserById</code>）</td></tr><tr><td>参数描述符</td><td>方法参数类型描述字符串（比如 <code>Ljava/lang/String;</code> 表示 String 类型参数）</td></tr><tr><td>参数值序列化</td><td>参数值的序列化内容（根据序列化协议如 Hessian2、JSON 等序列化后的字节流）</td></tr><tr><td>Dubbo 内置参数</td><td> Dubbo 扩展的键值对参数（比如 <code>path</code>、<code>timeout</code>、<code>group</code>、<code>loadbalance</code> 等）</td></tr></tbody></table><div class="admonition note"><p class="admonition-title">扩展阅读</p><ul><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/Kiven_ch/article/details/118033998">Dubbo 源码学习 - 网络通信原理</a></li></ul></div><h4 id="协议的多路复用机制"><a href="#协议的多路复用机制" class="headerlink" title="协议的多路复用机制"></a>协议的多路复用机制</h4><p>Dubbo 协议（官方默认协议）支持单连接并发请求，因为它在 TCP 协议之上通过 Netty 和自定义通信协议实现了同一条 TCP 连接上的多路复用机制。每个请求都有唯一的 Request ID，响应则根据 Request ID 匹配到对应的调用线程，从而突破了 TCP 串行阻塞的限制。这就是 Dubbo 协议的多路复用机制，也是其高性能的主要原因。虽然 TCP 本质上是有序字节流，但 Dubbo 协议允许多个 RPC 请求在同一连接上交错传输，不必等待 “一个请求发送完、响应回来后才处理下一个请求”，实现了真正的并发请求。如果单连接仍存在性能瓶颈，可以通过调高 <code>connections</code> 参数，让 Consumer 为每个 Provider 建立多条物理 TCP 连接来分担流量。</p><div class="admonition warning"><p class="admonition-title">特别注意</p><ul><li>Dubbo 协议的的多路复用机制，本质上复用的是 TCP 连接，也就是在同一条物理 TCP 连接上同时承载多个 RPC 请求和响应，从而减少连接建立的开销，并显著提升吞吐量。</li><li>这跟常说的 I/O 多路复用机制（比如 <code>poll</code>、<code>epoll</code>）完全不同，因为 <code>epoll</code> 等 I/O 多路复用机制本质上是在操作系统层面复用线程，两者概念完全不同。</li></ul></div><ul><li><p><strong>基础认知：TCP 是有序字节流</strong></p><ul><li>TCP 连接本身提供的只是可靠的、有序的字节流，并不关心应用层消息的边界。</li><li>如果应用层不做任何设计，那么它只能按顺序处理请求：<ul><li>(1) 客户端发出请求 A</li><li>(2) 客户端等待服务端响应 A</li><li>(3) 客户端才能发送请求 B</li></ul></li><li> 这就像一条 “管道”，只能一个一个地走，非常低效。</li><li>典型例子：HTTP/1.0 早期，每次请求必须等上一次响应返回后才能发起下一次，这就是队头阻塞（Head-of-Line Blocking）。</li></ul></li><li><p><strong>Dubbo 协议的报文结构</strong></p><ul><li>Dubbo 协议的消息头固定 16 字节，包含关键信息：</li></ul><table><thead><tr><th>字段</th><th>长度</th><th>作用</th></tr></thead><tbody><tr><td> Magic Number</td><td>2 字节</td><td>魔数（通信协议标识），Dubbo 协议是固定值 <code>0xdabb</code></td></tr><tr><td>Flag</td><td>1 字节</td><td>请求 / 响应标识</td></tr><tr><td> Status</td><td>1 字节</td><td>响应状态</td></tr><tr><td> Request ID</td><td>8 字节</td><td>请求的唯一标识</td></tr><tr><td> Body Length</td><td>4 字节</td><td>请求体的长度</td></tr></tbody></table><ul><li> Dubbo 协议的报文格式：<ul><li><code>| Header(16 bytes) | Body(variable) |</code></li></ul></li><li>Dubbo 处理报文的流程：<ul><li>Consumer 发起 RPC 调用时，生成一个全局唯一的 Request ID</li><li>Provider 处理完请求后，响应中带回相同的 Request ID</li><li>Consumer 根据 Request ID 将响应结果分发到正确的调用线程</li></ul></li></ul></li><li><p> <strong>Dubbo 协议的多路复用机制</strong></p><ul><li><p>假设 Consumer 同时发起 3 个 RPC 请求（A、B、C），请求体会被打包，如下：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Consumer 的 TCP 发送缓冲区：|Header(ID=1)|BodyA|Header(ID=2)|BodyB|Header(ID=3)|BodyC|</span><br></pre></td></tr></tbody></table></figure></li><li><p>Provider 可以并发处理这 3 个请求，并按处理完成的先后顺序返回结果，如下：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Consumer 的 TCP 接收缓冲区：|Header(ID=2)|RespB|Header(ID=1)|RespA|Header(ID=3)|RespC|</span><br></pre></td></tr></tbody></table></figure></li><li><p>Consumer 接收到响应结果后：</p><ul><li>解析消息头，取出 Request ID</li><li> 将 RespB 分发给发起 B 请求的线程</li><li>将 RespA 分发给 A 请求线程</li><li>将 RespC 分发给 C 请求线程</li></ul></li><li><p>这并行和串行的区别：</p><ul><li><p>在 Dubbo 中，即使只有一条 TCP 连接，也能同时跑成百上千的并发请求。</p><table><thead><tr><th>特性</th><th>串行请求（无 Request ID）</th><th>Dubbo 并发请求（带 Request ID）</th></tr></thead><tbody><tr><td>TCP 数据组织</td><td>每次只能传一条完整消息</td><td>多条消息交错在同一流里</td></tr><tr><td>发送端</td><td>必须等待上一个响应回来才能发送下一个请求</td><td>可以连续发送多个请求</td></tr><tr><td>响应顺序</td><td>响应必须严格按请求顺序返回</td><td>响应顺序与请求顺序无关</td></tr><tr><td>并发性能</td><td>低，队头阻塞严重</td><td>高，类似 HTTP/2 多路复用</td></tr></tbody></table></li></ul></li></ul></li><li><p> <strong>Dubbo 协议多路复用机制的工作流程</strong></p><ul><li>(1) 客户端发起调用<ul><li> Consumer 应用线程调用代理对象</li><li> Dubbo 在客户端生成一个唯一的 Request ID 并将调用参数序列化</li></ul></li><li> (2) 写入 Netty Channel<ul><li> 所有调用请求都会被写入同一条 Netty Channel</li><li> 发送数据时不会阻塞，只要 TCP 发送缓冲区有空间，就可以写入</li></ul></li><li> (3) 服务端并发处理<ul><li> Provider 使用线程池同时处理多个请求</li><li>不要求按请求顺序处理，哪个先处理完就先返回</li></ul></li><li> (4) 返回结果匹配<ul><li> Consumer 维护一个 <code>ConcurrentHashMap&lt;Long, Future&gt;</code></li><li><code>Key = Request ID</code>，<code>Value = 该请求对应的 Future</code></li><li>Consumer 收到响应时，根据响应里的 Request ID 找到对应 Future，并唤醒等待线程（调用线程）</li></ul></li></ul></li><li><p><strong>Dubbo 协议为什么还会出现 “单连接阻塞” 问题</strong></p><ul><li>虽然 Dubbo 协议支持单连接并发请求，但底层 TCP 仍然是单通道，存在物理限制，主要体现在：<ul><li>TCP 层的队头阻塞（Head-of-Line Blocking）<ul><li>TCP 是有序字节流，一旦某个包丢失，后续所有数据都必须等待该包重传。</li><li>如果网络丢包率高，即使 Dubbo 应用层并行，仍会被 TCP 阻塞。</li></ul></li><li>Provider 中的线程池已满<ul><li>如果 Provider 的处理线程不足，Consumer 的请求虽然发出去了，但在服务端被排队。</li></ul></li><li>单连接带宽不足<ul><li>多个请求争夺同一条 TCP 通道的带宽时，整体性能受限。</li></ul></li></ul></li></ul></li><li><p><strong>Dubbo 多路复用机制的类比理解</strong></p><ul><li>可以将 Dubbo 多路复用机制类比为高速公路：</li></ul><table><thead><tr><th>场景</th><th>类比</th></tr></thead><tbody><tr><td>串行模式</td><td>高速公路只有 1 条车道，车必须按顺序行驶，前车没到终点，后车不能走</td></tr><tr><td> Dubbo 多路复用</td><td>高速公路有多条虚拟车道（Request ID），虽然实际物理只有 1 条道路，但每辆车都有自己的标记，不会互相等待</td></tr></tbody></table></li><li><p> <strong>Dubbo 不同通信协议对单连接并发请求的支持情况</strong></p></li></ul><table><thead><tr><th>通信协议类型</th><th>是否支持单连接并发请求（多路复用机制）</th><th>说明</th></tr></thead><tbody><tr><td> Dubbo 协议（默认）</td><td>✅ 支持</td><td>通过自定义协议头 + Request ID 实现多路复用，这是 Dubbo 高性能的核心。</td></tr><tr><td>Triple 协议（gRPC）</td><td>✅ 支持</td><td>基于 HTTP/2，本身支持多路复用，天然具备并行能力。</td></tr><tr><td>RMI、Hessian、WebService 等传统协议</td><td>❌ 不支持</td><td>基于同步调用或无多路复用设计，一个请求未返回响应前，后续请求无法在同一连接并行发送。</td></tr></tbody></table><h4 id="基于-TCP-手写-Dubbo-客户端"><a href="#基于-TCP-手写-Dubbo-客户端" class="headerlink" title="基于 TCP 手写 Dubbo 客户端"></a>基于 TCP 手写 Dubbo 客户端</h4><div class="admonition note"><p class="admonition-title">学习目标与代码下载</p><ul><li>这里将基于 <a href="/posts/ef04d10a.html#%E6%8A%A5%E6%96%87%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F">Dubbo 协议的报文格式</a> + TCP 手写一个 Dubbo 客户端，目的是熟悉 Dubbo 协议的报文格式。</li><li>为了方便演示，服务提供者（Provider）使用的<strong>序列化协议为 FastJSON</strong>，而通信协议为 Dubbo 协议，注册中心使用 ZooKeeper。</li><li>由于篇幅有限，下面只给出服务消费者（Consumer）的核心代码，而服务提供者（Provider）的代码不再累述，完整的案例代码可以直接从 <a target="_blank" rel="external nofollow" href="https://github.com/rqh656418510/spring-cloud-share/tree/main/rpc-framework/dubbo-study/dubbo2.x-study">GitHub</a> 下载对应章节 <code>dubbo-lesson-09</code>。</li></ul></div><blockquote><p>案例代码</p></blockquote><ul><li>ZooKeeper 中的数据存储结构</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/dubbo</span><br><span class="line">└── com.clay.dubbo.service.DemoService</span><br><span class="line">    ├── providers</span><br><span class="line">    │   └── dubbo%3A%2F%2F192.168.233.1%3A20880%2Fcom.clay.dubbo.service.DemoService%3Fanyhost%3Dtrue%26application%3Ddubbo-provider-application%26deprecated%3Dfalse%26dubbo%3D2.0.2%26dynamic%3Dtrue%26generic%3Dfalse%26interface%3Dcom.clay.dubbo.service.DemoService%26metadata-type%3Dremote%26methods%3DsayHello%26pid%3D47362%26release%3D2.7.23%26serialization%3Dfastjson%26service.name%3DServiceBean%3A%2Fcom.clay.dubbo.service.DemoService%26side%3Dprovider%26timestamp%3D1758794536318</span><br><span class="line">    │</span><br><span class="line">    ├── consumers</span><br><span class="line">    │   └── empty</span><br><span class="line">    │</span><br><span class="line">    ├── configurators</span><br><span class="line">    │   └── empty</span><br><span class="line">    │</span><br><span class="line">    └── routers</span><br><span class="line">        └── empty</span><br></pre></td></tr></tbody></table></figure><ul><li>核心依赖（服务消费者端）</li></ul><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.23<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.clay.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-lesson-09-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><ul><li>核心代码（服务消费者端）</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.clay.dubbo.service.DemoService;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.URL;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.io.Bytes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.URLDecoder;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ZooKeeper 连接地址（多个集群节点使用逗号分割）</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ADDRESS = <span class="string">"127.0.0.1:2181"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ZooKeeper 会话超时时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_TIMEOUT = <span class="number">2000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根节点的路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROOT_PATH = <span class="string">"/dubbo"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 服务节点的路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVICE_PATH = ROOT_PATH + <span class="string">"/"</span> + DemoService.class.getName() + <span class="string">"/providers"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取 ZK 客户端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CuratorFramework <span class="title">getCuratorFramework</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// 重试策略</span></span><br><span class="line">        ExponentialBackoffRetry backoffRetry = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">3000</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建 ZK 客户端</span></span><br><span class="line">        CuratorFramework client = CuratorFrameworkFactory.builder()</span><br><span class="line">            .connectString(ADDRESS)</span><br><span class="line">            .connectionTimeoutMs(SESSION_TIMEOUT)</span><br><span class="line">            .retryPolicy(backoffRetry)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动 ZK 客户端</span></span><br><span class="line">        client.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">// 获取服务地址列表</span></span><br><span class="line">        CuratorFramework zkClient = getCuratorFramework();</span><br><span class="line">        List&lt;String&gt; providerUrls = zkClient.getChildren().forPath(SERVICE_PATH);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (providerUrls.size() == <span class="number">0</span>) {</span><br><span class="line">            System.out.println(<span class="string">"服务地址列表为空，客户端退出"</span>);</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 随机选取一个服务地址</span></span><br><span class="line">        <span class="keyword">int</span> index = <span class="keyword">new</span> Random().nextInt(providerUrls.size());</span><br><span class="line">        String providerUrl = providerUrls.get(index);</span><br><span class="line">        System.out.println(<span class="string">"未解码的 URL: "</span> + providerUrl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对 Provider URL 进行解码</span></span><br><span class="line">        String decodeUrl = URLDecoder.decode(providerUrl, StandardCharsets.UTF_8.name());</span><br><span class="line">        System.out.println(<span class="string">"解码后的 URL: "</span> + decodeUrl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取 Provider 的信息</span></span><br><span class="line">        URL url = URL.valueOf(decodeUrl);</span><br><span class="line">        String protocol = url.getProtocol(); <span class="comment">// dubbo</span></span><br><span class="line">        String host = url.getHost(); <span class="comment">// 192.168.233.1</span></span><br><span class="line">        <span class="keyword">int</span> port = url.getPort(); <span class="comment">// 20880</span></span><br><span class="line">        String path = url.getPath(); <span class="comment">// com.clay.dubbo.service.DemoService</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建 TCP 客户端</span></span><br><span class="line">        SocketChannel dubboClient = SocketChannel.open();</span><br><span class="line">        dubboClient.connect(<span class="keyword">new</span> InetSocketAddress(host, port));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送的数据（消息体），基于 FastJSON 序列化协议，以下内容必须按顺序组织</span></span><br><span class="line">        StringBuffer bodyString = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        <span class="comment">// Dubbo 协议的版本</span></span><br><span class="line">        bodyString.append(JSON.toJSONString(<span class="string">"2.0.2"</span>)).append(<span class="string">"\r\n"</span>);</span><br><span class="line">        <span class="comment">// 接口名称</span></span><br><span class="line">        bodyString.append(JSON.toJSONString(path)).append(<span class="string">"\r\n"</span>);</span><br><span class="line">        <span class="comment">// 接口版本</span></span><br><span class="line">        bodyString.append(JSON.toJSONString(<span class="string">"0.0.0"</span>)).append(<span class="string">"\r\n"</span>);</span><br><span class="line">        <span class="comment">// 方法名称</span></span><br><span class="line">        bodyString.append(JSON.toJSONString(<span class="string">"sayHello"</span>)).append(<span class="string">"\r\n"</span>);</span><br><span class="line">        <span class="comment">// 参数描述</span></span><br><span class="line">        bodyString.append(JSON.toJSONString(<span class="string">"Ljava/lang/String;"</span>)).append(<span class="string">"\r\n"</span>);</span><br><span class="line">        <span class="comment">// 参数值（经过序列化）</span></span><br><span class="line">        bodyString.append(JSON.toJSONString(<span class="string">"Jim"</span>)).append(<span class="string">"\r\n"</span>);</span><br><span class="line">        <span class="comment">// 附加参数（用于扩展 Dubbo 功能）</span></span><br><span class="line">        bodyString.append(<span class="string">"{}"</span>).append(<span class="string">"\r\n"</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] body = bodyString.toString().getBytes();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送的数据（消息头），固定 16 个字节</span></span><br><span class="line">        <span class="keyword">byte</span>[] header = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">16</span>];</span><br><span class="line">        <span class="comment">// 魔数，协议标识（2 个字节）</span></span><br><span class="line">        <span class="keyword">byte</span>[] magicArray = Bytes.short2bytes((<span class="keyword">short</span>) <span class="number">0xdabb</span>);</span><br><span class="line">        System.arraycopy(magicArray, <span class="number">0</span>, header, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="comment">// 请求 / 响应标识（1 个字节）</span></span><br><span class="line">        header[<span class="number">2</span>] = (<span class="keyword">byte</span>) <span class="number">0xc6</span>;</span><br><span class="line">        <span class="comment">// 响应状态（1 个字节）</span></span><br><span class="line">        header[<span class="number">3</span>] = <span class="number">0x00</span>;</span><br><span class="line">        <span class="comment">// 请求 ID（8 个字节）</span></span><br><span class="line">        <span class="keyword">byte</span>[] requestId = Bytes.long2bytes(<span class="number">1</span>);</span><br><span class="line">        System.arraycopy(requestId, <span class="number">0</span>, header, <span class="number">4</span>, <span class="number">8</span>);</span><br><span class="line">        <span class="comment">// 消息体的长度（4 个字节）</span></span><br><span class="line">        <span class="keyword">byte</span>[] bodyLength = Bytes.int2bytes(body.length);</span><br><span class="line">        System.arraycopy(bodyLength, <span class="number">0</span>, header, <span class="number">12</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 封装请求报文</span></span><br><span class="line">        <span class="keyword">byte</span>[] request = <span class="keyword">new</span> <span class="keyword">byte</span>[header.length + body.length];</span><br><span class="line">        System.arraycopy(header, <span class="number">0</span>, request, <span class="number">0</span>, header.length);</span><br><span class="line">        System.arraycopy(body, <span class="number">0</span>, request, header.length, body.length);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送 RPC 请求</span></span><br><span class="line">        dubboClient.write(ByteBuffer.wrap(request));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取响应结果</span></span><br><span class="line">        ByteBuffer response = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        dubboClient.read(response);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 准备读取响应结果</span></span><br><span class="line">        response.flip();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印响应结果</span></span><br><span class="line">        <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[response.remaining()];</span><br><span class="line">        response.get(data);</span><br><span class="line">        System.out.println(<span class="string">"RPC 调用结果："</span> + <span class="keyword">new</span> String(data));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        ConsumerApplication application = <span class="keyword">new</span> ConsumerApplication();</span><br><span class="line">        application.run();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>测试结果（服务消费者端），打印 RPC 调用结果时可能会出现部分内容乱码，但不影响整体的测试效果</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">未解码的 URL: dubbo%3A%2F%2F192.168.233.1%3A20880%2Fcom.clay.dubbo.service.DemoService%3Fanyhost%3Dtrue%26application%3Ddubbo-provider-application%26deprecated%3Dfalse%26dubbo%3D2.0.2%26dynamic%3Dtrue%26generic%3Dfalse%26interface%3Dcom.clay.dubbo.service.DemoService%26metadata-type%3Dremote%26methods%3DsayHello%26pid%3D47362%26release%3D2.7.23%26serialization%3Dfastjson%26service.name%3DServiceBean%3A%2Fcom.clay.dubbo.service.DemoService%26side%3Dprovider%26timestamp%3D1758794536318</span><br><span class="line"></span><br><span class="line">解码后的 URL: dubbo://192.168.233.1:20880/com.clay.dubbo.service.DemoService?anyhost=true&amp;application=dubbo-provider-application&amp;deprecated=false&amp;dubbo=2.0.2&amp;dynamic=true&amp;generic=false&amp;interface=com.clay.dubbo.service.DemoService&amp;metadata-type=remote&amp;methods=sayHello&amp;pid=47362&amp;release=2.7.23&amp;serialization=fastjson&amp;service.name=ServiceBean:/com.clay.dubbo.service.DemoService&amp;side=provider&amp;timestamp=1758794536318</span><br><span class="line"></span><br><span class="line">RPC 调用结果：ڻ           4</span><br><span class="line">"Hello Jim"</span><br><span class="line">{"dubbo":"2.0.2"}</span><br></pre></td></tr></tbody></table></figure><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="/posts/ad584707.html">Dubbo 2 入门教程之二</a></li><li><a href="/posts/fab9c84c.html">Dubbo 2 入门教程之三</a></li></ul><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/ef04d10a.html" title="Dubbo 2 巩固教程之一">https://www.techgrow.cn/posts/ef04d10a.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="fa fa-tag"></i> 微服务</a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag"><i class="fa fa-tag"></i> 分布式</a><a href="/tags/RPC/" rel="tag"><i class="fa fa-tag"></i> RPC</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/1302ed9d.html" rel="prev" title="Linux 安装 RedisDesktopManager"><i class="fa fa-angle-left"></i> Linux 安装 RedisDesktopManager</a></div><div class="post-nav-item"> <a href="/posts/89d0a2f4.html" rel="next" title="GitHub 排行榜与资源整理">GitHub 排行榜与资源整理<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">2.1m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">31:30</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/ef04d10a.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>