<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍如何基于日志点实现 MySQL 的主从复制。"><meta property="og:type" content="article"><meta property="og:title" content="MySQL 基于日志点实现主从复制"><meta property="og:url" content="https://www.techgrow.cn/posts/7de9021f.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍如何基于日志点实现 MySQL 的主从复制。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/12/mysql-replication-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/12/mysql-replication-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/12/mysql-replication-7.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/12/mysql-replication-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/12/mysql-replication-4.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/12/mysql-replication-5.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/12/mysql-replication-6.png"><meta property="article:published_time" content="2019-05-27T12:13:32.000Z"><meta property="article:modified_time" content="2019-05-27T12:13:32.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="数据库"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2025/12/mysql-replication-1.png"><link rel="canonical" href="https://www.techgrow.cn/posts/7de9021f.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/7de9021f.html","path":"posts/7de9021f.html","title":"MySQL 基于日志点实现主从复制"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>MySQL 基于日志点实现主从复制 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL-%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E5%8E%9F%E7%90%86"><span class="nav-text">MySQL 主从同步原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL-%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E9%85%8D%E7%BD%AE"><span class="nav-text">MySQL 主从同步配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="nav-text">版本说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-text">准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1"><span class="nav-text">配置网络服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-Docker-%E6%9C%8D%E5%8A%A1"><span class="nav-text">安装 Docker 服务</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A7%84%E5%88%92"><span class="nav-text">服务器规划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E4%B8%BB%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-text">部署主服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-text">部署从服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%80"><span class="nav-text">从服务器一</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BA%8C"><span class="nav-text">从服务器二</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5"><span class="nav-text">启动主从同步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5"><span class="nav-text">验证主从同步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%81%9C%E6%AD%A2%E5%92%8C%E9%87%8D%E7%BD%AE%E5%90%8C%E6%AD%A5"><span class="nav-text">停止和重置同步</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL-%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E9%97%AE%E9%A2%98"><span class="nav-text">MySQL 主从同步问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%80"><span class="nav-text">常见问题一</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%BA%8C"><span class="nav-text">常见问题二</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">763</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">54</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/7de9021f.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="MySQL 基于日志点实现主从复制 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍如何基于日志点实现 MySQL 的主从复制。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> MySQL 基于日志点实现主从复制</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-05-27 20:13:32" itemprop="dateCreated datePublished" datetime="2019-05-27T20:13:32+08:00">2019-05-27</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/7de9021f.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/7de9021f.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>3.1k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>3 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/7de9021f.html">MySQL 基于日志点实现主从复制</a></li><li><a href="/posts/16617d7.html">MySQL 基于 GTID 实现主从复制</a></li></ul><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文将介绍 MySQL 如何通过 binlog 日志点的方式实现主从复制。为了方便演示，使用 Docker 部署 MySQL；但在生产环境中，强烈建议在裸机或虚拟机上直接安装 MySQL，以获得更高、更稳定的性能。</p><span id="more"></span><h2 id="MySQL-主从同步原理"><a href="#MySQL-主从同步原理" class="headerlink" title="MySQL 主从同步原理"></a>MySQL 主从同步原理</h2><p><strong>主从同步的基本原理：</strong></p><ul><li>slave 会从 master 读取 binlog 来进行数据同步</li></ul><p> <img data-src="../../../asset/2025/12/mysql-replication-1.png"></p><p><strong>主从同步的具体步骤：</strong></p><ul><li><code>step1：</code> master 将所有数据变更记录到 <code>二进制日志（binlog）</code> 中。</li><li><code>step2：</code> 当 slave 执行 <code>start slave</code> 命令后，会创建一个 <code>I/O 线程</code>，用于连接 master 并请求其 binlog。</li><li><code>step3：</code> slave 连接到 master 后，master 会创建一个 <code>log dump 线程</code>，负责将 binlog 内容发送给 slave。在读取 binlog 时会对其加锁，读取完成并发送给 slave 后再解锁。</li><li><code>step4：</code> slave 的 I/O 线程接收来自 master 的 binlog 更新，并将其写入 <code>中继日志（relay log）</code>。</li><li><code>step5：</code> slave 的 <code>SQL 线程</code> 读取 <code>中继日志（relay log）</code>，将其中的事件解析并执行，以实现主从操作一致，最终确保数据一致性。</li></ul><h2 id="MySQL-主从同步配置"><a href="#MySQL-主从同步配置" class="headerlink" title="MySQL 主从同步配置"></a>MySQL 主从同步配置</h2><h3 id="版本说明"><a href="#版本说明" class="headerlink" title="版本说明"></a>版本说明</h3><table><thead><tr><th>软件</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td> CentOS</td><td><code>7.9</code></td><td>可使用其他 Linux 发行版，比如 Debian、Ubuntu 等</td></tr><tr><td> Docker</td><td>26.1.4</td><td></td></tr><tr><td>MySQL</td><td>8.0.29</td><td></td></tr></tbody></table><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><h4 id="配置网络服务"><a href="#配置网络服务" class="headerlink" title="配置网络服务"></a>配置网络服务</h4><ul><li>配置 Linux 的网络服务，否则在外部远程连接 Docker 中的 MySQL 时，可能会出现连接失败的问题</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在宿主机中，修改系统配置文件，在文件末尾追加以下一行内容</span></span><br><span class="line">vim /usr/lib/sysctl.d/00-system.conf</span><br><span class="line">net.ipv4.ip_forward=1</span><br></pre></td></tr></tbody></table></figure><ul><li>重启网络服务（以 CentOS 为例）</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重启网络服务</span></span><br><span class="line">systemctl restart network</span><br></pre></td></tr></tbody></table></figure><h4 id="安装-Docker-服务"><a href="#安装-Docker-服务" class="headerlink" title="安装 Docker 服务"></a>安装 Docker 服务</h4><p>由于本文是基于 Docker 方式来安装 MySQL，因此需要提前安装并启动 Docker 服务，详细教程如下所示：</p><ul><li><a href="/posts/efd9e9f2.html">CentOS 7 安装 Docker 与 Docker-Compose</a></li><li><a href="/posts/a4847c57.html">Debian 11 安装 Docker 与 Docker-Compose</a></li><li><a href="/posts/a19ep68d.html">Debian 12 安装 Docker 与 Docker-Compose</a></li></ul><h3 id="服务器规划"><a href="#服务器规划" class="headerlink" title="服务器规划"></a>服务器规划</h3><ul><li>使用 Docker 方式部署 MySQL，<code>主从服务器的 IP 一致，端口号不一致</code></li></ul><p><img data-src="../../../asset/2025/12/mysql-replication-2.png"></p><table><thead><tr><th>服务器</th><th>主从角色</th><th>容器名称</th><th>端口</th></tr></thead><tbody><tr><td>主服务器</td><td>主库</td><td> mysql-master</td><td>3306</td></tr><tr><td> 从服务器 1</td><td> 从库</td><td> mysql-slave1</td><td>3307</td></tr><tr><td> 从服务器 2</td><td> 从库</td><td> mysql-slave2</td><td>3308</td></tr></tbody></table><h3 id="部署主服务器"><a href="#部署主服务器" class="headerlink" title="部署主服务器"></a>部署主服务器</h3><blockquote><p><strong>step1：在 Docker 中创建并启动 MySQL 主服务器，端口是 3306</strong></p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建并启动 MySQL 容器（Docker 会自动在宿主机上创建不存在的目录）</span></span><br><span class="line">docker run<span class="params"> -d</span> \<span class="params"></span></span><br><span class="line"><span class="params">  -p</span> 3306:3306 \<span class="params"></span></span><br><span class="line"><span class="params">  -v</span> /data/mysql/master/conf:/etc/mysql/conf.d \<span class="params"></span></span><br><span class="line"><span class="params">  -v</span> /data/mysql/master/data:/var/lib/mysql \<span class="params"></span></span><br><span class="line"><span class="params">  -e</span> MYSQL_ROOT_PASSWORD=123456 \<span class="params"></span></span><br><span class="line"><span class="params">  --name</span> mysql-master \</span><br><span class="line">  mysql:8.0.29</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 MySQL 容器的运行状态</span></span><br><span class="line">docker ps<span class="params"> -a</span></span><br></pre></td></tr></tbody></table></figure><blockquote><p><strong>step2：创建 MySQL 主服务器的配置文件</strong></p></blockquote><ul><li>默认情况下 MySQL 的 binlog 日志是自动开启的，可以通过如下配置定义一些可选配置项：</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建并编辑 MySQL 配置文件，添加以下配置内容</span></span><br><span class="line">vim /data/mysql/master/conf/my.cnf</span><br></pre></td></tr></tbody></table></figure><ul><li>配置如下内容：</li></ul><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="comment"># 服务器唯一 ID，默认值是 1</span></span><br><span class="line"><span class="meta">server-id</span>=<span class="string">1</span></span><br><span class="line"><span class="comment"># 设置日志格式，默认值是 ROW</span></span><br><span class="line"><span class="attr">binlog_format</span>=<span class="string">STATEMENT</span></span><br><span class="line"><span class="comment"># 二进制日志名，默认值是 binlog</span></span><br><span class="line"><span class="comment"># log-bin=binlog</span></span><br><span class="line"><span class="comment"># 设置需要复制的数据库，默认复制全部数据库</span></span><br><span class="line"><span class="comment">#binlog-do-db=mytestdb</span></span><br><span class="line"><span class="comment"># 设置不需要复制的数据库</span></span><br><span class="line"><span class="comment">#binlog-ignore-db=mysql</span></span><br><span class="line"><span class="comment">#binlog-ignore-db=infomation_schema</span></span><br></pre></td></tr></tbody></table></figure><ul><li>重启 MySQL 容器：</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart mysql-master</span><br></pre></td></tr></tbody></table></figure><ul><li><p>binlog 格式说明：</p><ul><li><code>binlog_format=STATEMENT</code>：记录的是主服务器执行的 <code>写操作语句</code>，性能较高；但由于依赖执行环境，诸如 <code>NOW()</code>、<code>USER()</code>、<code>@@hostname</code> 等与环境相关的函数或获取系统变量等操作可能会导致主从数据不一致的问题。</li><li><code>binlog_format=ROW（默认）</code>：记录的是主服务器 <code>执行写入后的实际数据行</code>。在批量操作下性能略差，但能避免 <code>NOW()</code>、<code>USER()</code>、<code>@@hostname</code> 等与环境相关的函数或获取系统变量等操作导致的主从数据不一致问题。</li><li><code>binlog_format=MIXED</code>：结合以上两种 binglog 格式。包含函数或与环境相关的操作时使用 <code>ROW</code>，其他情况使用 <code>STATEMENT</code>；但对系统变量的变化识别仍存在局限。</li></ul></li><li><p>配置项优先级说明：</p><ul><li>在 MySQL <code>5.7</code> 及之后版本‌中，<code>binlog-ignore-db</code> 的优先级高于 <code>binlog-do-db</code>，即如果一个数据库同时出现在这两个配置中，它将被忽略。</li><li>在 MySQL <code>5.6</code> 及之前版本‌中，优先级相反，<code>binlog-do-db</code> 的优先级高于 <code>binlog-ignore-db</code>，即 <code>binlog-do-db</code> 的配置会覆盖 <code>binlog-ignore-db</code>，如下图所示。<br><img data-src="../../../asset/2025/12/mysql-replication-7.png"></li></ul></li></ul><blockquote><p><strong>step3：使用命令行登录 MySQL 主服务器</strong></p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入容器内，其中环境变量 "env LANG=C.UTF-8" 用于避免容器内显示中文乱码的问题</span></span><br><span class="line">docker <span class="built_in">exec</span><span class="params"> -it</span> mysql-master env LANG=C.UTF-8 /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在容器内执行 MySQL 命令行</span></span><br><span class="line">mysql<span class="params"> -uroot</span><span class="params"> -p</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 MySQL 超级管理员用户的默认密码校验方式</span></span><br><span class="line">ALTER USER <span class="string">'root'</span>@<span class="string">'%'</span> IDENTIFIED WITH mysql_native_password BY <span class="string">'123456'</span>;</span><br></pre></td></tr></tbody></table></figure><blockquote><p><strong>step4：主服务器中创建 slave 用户</strong></p></blockquote><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建 slave 用户</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">'sync_slave'</span>@<span class="string">'%'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置 slave 用户的密码</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="string">'sync_slave'</span>@<span class="string">'%'</span> IDENTIFIED <span class="keyword">WITH</span> mysql_native_password <span class="keyword">BY</span> <span class="string">'123456'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 授予复制权限给 slave 用户</span></span><br><span class="line"><span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">'sync_slave'</span>@<span class="string">'%'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 刷新权限</span></span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></tbody></table></figure><blockquote><p><strong>step5：主服务器中查询 master 状态</strong></p></blockquote><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> MASTER STATUS;</span><br></pre></td></tr></tbody></table></figure><ul><li>记录下 <code>File</code> 和 <code>Position</code> 的值，执行完此步骤后 <code>不要再操作主服务器上的 MYSQL</code>，防止主服务器的状态值发生变化</li></ul><p><img data-src="../../../asset/2025/12/mysql-replication-3.png"></p><h3 id="部署从服务器"><a href="#部署从服务器" class="headerlink" title="部署从服务器"></a>部署从服务器</h3><div class="admonition warning"><p class="admonition-title">特别注意</p><p>这里可以部署多台从服务器，如 <code>slave1、slave2 ...</code>，但从服务器数量并非越多越好，过多的从服务器会增加主服务器的负载。多台从服务器的部署流程基本相同，但<strong>需要注意修改 Docker 容器的端口映射以及 MySQL 服务器的 ID（<code>server-id</code>），以避免冲突</strong>。</p></div><h4 id="从服务器一"><a href="#从服务器一" class="headerlink" title="从服务器一"></a>从服务器一</h4><blockquote><p><strong>step1：在 Docker 中创建并启动 MySQL 从服务器，端口是 3307</strong></p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建并启动 MySQL 容器（Docker 会自动在宿主机上创建不存在的目录）</span></span><br><span class="line">docker run<span class="params"> -d</span> \<span class="params"></span></span><br><span class="line"><span class="params">  -p</span> 3307:3306 \<span class="params"></span></span><br><span class="line"><span class="params">  -v</span> /mysql/slave1/conf:/etc/mysql/conf.d \<span class="params"></span></span><br><span class="line"><span class="params">  -v</span> /mysql/slave1/data:/var/lib/mysql \<span class="params"></span></span><br><span class="line"><span class="params">  -e</span> MYSQL_ROOT_PASSWORD=123456 \<span class="params"></span></span><br><span class="line"><span class="params">  --name</span> mysql-slave1 \</span><br><span class="line">  mysql:8.0.29</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 MySQL 容器的运行状态</span></span><br><span class="line">docker ps<span class="params"> -a</span></span><br></pre></td></tr></tbody></table></figure><blockquote><p><strong>step2：创建 MySQL 从服务器的配置文件</strong></p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建并编辑 MySQL 配置文件，添加以下配置内容</span></span><br><span class="line">vim /mysql/slave1/conf/my.cnf</span><br></pre></td></tr></tbody></table></figure><ul><li>配置如下内容：</li></ul><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="comment"># 服务器唯一 ID，每台服务器的 ID 必须不同，如果存在多台从服务器，需要注意修改 ID</span></span><br><span class="line"><span class="meta">server-id</span>=<span class="string">2</span></span><br><span class="line"><span class="comment"># 中继日志名，默认是 xxxxxxxxxxxx-relay-bin</span></span><br><span class="line"><span class="comment">#relay-log=relay-bin</span></span><br></pre></td></tr></tbody></table></figure><ul><li>重启 MySQL 容器：</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart mysql-slave1</span><br></pre></td></tr></tbody></table></figure><blockquote><p><strong>step3：使用命令行登录 MySQL 从服务器</strong></p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入容器内，其中环境变量 "env LANG=C.UTF-8" 用于避免容器内显示中文乱码的问题</span></span><br><span class="line">docker <span class="built_in">exec</span><span class="params"> -it</span> mysql-slave1 env LANG=C.UTF-8 /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在容器内执行 MySQL 命令行</span></span><br><span class="line">mysql<span class="params"> -uroot</span><span class="params"> -p</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 MySQL 超级管理员用户的默认密码校验方式</span></span><br><span class="line">ALTER USER <span class="string">'root'</span>@<span class="string">'%'</span> IDENTIFIED WITH mysql_native_password BY <span class="string">'123456'</span>;</span><br></pre></td></tr></tbody></table></figure><blockquote><p><strong>step4：在从服务器上配置主从关系</strong></p></blockquote><ul><li>在<strong>从服务器</strong>上，执行以下 SQL 操作</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER <span class="keyword">TO</span></span><br><span class="line">    MASTER_HOST<span class="operator">=</span><span class="string">'192.168.2.191'</span>,</span><br><span class="line">    MASTER_PORT<span class="operator">=</span><span class="number">3306</span>,</span><br><span class="line">    MASTER_USER<span class="operator">=</span><span class="string">'sync_slave'</span>,</span><br><span class="line">    MASTER_PASSWORD<span class="operator">=</span><span class="string">'123456'</span>,</span><br><span class="line">    MASTER_LOG_FILE<span class="operator">=</span><span class="string">'binlog.000003'</span>,</span><br><span class="line">    MASTER_LOG_POS<span class="operator">=</span><span class="number">1357</span>;</span><br></pre></td></tr></tbody></table></figure><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>MASTER_HOST</code></td><td>主服务器的 IP 地址或主机名，<strong>这里使用宿主机的 IP 地址（比如 192.168.2.191）</strong></td></tr><tr><td><code>MASTER_PORT</code></td><td>主服务器监听的端口号（默认为 <code>3306</code>），<strong>这里使用 Docker 的映射端口（比如 3306）</strong></td></tr><tr><td><code>MASTER_USER</code></td><td>从服务器用于连接主服务器的用户名</td></tr><tr><td><code>MASTER_PASSWORD</code></td><td>从服务器用于连接主服务器的密码</td></tr><tr><td><code>MASTER_LOG_FILE</code></td><td>从哪个 binlog 文件开始复制</td></tr><tr><td><code>MASTER_LOG_POS</code></td><td>从 binlog 文件的哪个位置开始复制</td></tr></tbody></table><ul><li>在<strong>从服务器</strong>上，查看主从关系的配置</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show slave status \G;</span><br></pre></td></tr></tbody></table></figure><h4 id="从服务器二"><a href="#从服务器二" class="headerlink" title="从服务器二"></a>从服务器二</h4><blockquote><p><strong>step1：在 Docker 中创建并启动 MySQL 从服务器，端口是 3308</strong></p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建并启动 MySQL 容器（Docker 会自动在宿主机上创建不存在的目录）</span></span><br><span class="line">docker run<span class="params"> -d</span> \<span class="params"></span></span><br><span class="line"><span class="params">  -p</span> 3308:3306 \<span class="params"></span></span><br><span class="line"><span class="params">  -v</span> /mysql/slave2/conf:/etc/mysql/conf.d \<span class="params"></span></span><br><span class="line"><span class="params">  -v</span> /mysql/slave2/data:/var/lib/mysql \<span class="params"></span></span><br><span class="line"><span class="params">  -e</span> MYSQL_ROOT_PASSWORD=123456 \<span class="params"></span></span><br><span class="line"><span class="params">  --name</span> mysql-slave2 \</span><br><span class="line">  mysql:8.0.29</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 MySQL 容器的运行状态</span></span><br><span class="line">docker ps<span class="params"> -a</span></span><br></pre></td></tr></tbody></table></figure><blockquote><p><strong>step2：创建 MySQL 从服务器的配置文件</strong></p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建并编辑 MySQL 配置文件，添加以下配置内容</span></span><br><span class="line">vim /mysql/slave2/conf/my.cnf</span><br></pre></td></tr></tbody></table></figure><ul><li>配置如下内容：</li></ul><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="comment"># 服务器唯一 ID，每台服务器的 ID 必须不同，如果存在多台从服务器，需要注意修改 ID</span></span><br><span class="line"><span class="meta">server-id</span>=<span class="string">3</span></span><br><span class="line"><span class="comment"># 中继日志名，默认是 xxxxxxxxxxxx-relay-bin</span></span><br><span class="line"><span class="comment">#relay-log=relay-bin</span></span><br></pre></td></tr></tbody></table></figure><ul><li>重启 MySQL 容器：</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart mysql-slave2</span><br></pre></td></tr></tbody></table></figure><blockquote><p><strong>step3：使用命令行登录 MySQL 从服务器</strong></p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入容器内，其中环境变量 "env LANG=C.UTF-8" 用于避免容器内显示中文乱码的问题</span></span><br><span class="line">docker <span class="built_in">exec</span><span class="params"> -it</span> mysql-slave2 env LANG=C.UTF-8 /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在容器内执行 MySQL 命令行</span></span><br><span class="line">mysql<span class="params"> -uroot</span><span class="params"> -p</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 MySQL 超级管理员用户的默认密码校验方式</span></span><br><span class="line">ALTER USER <span class="string">'root'</span>@<span class="string">'%'</span> IDENTIFIED WITH mysql_native_password BY <span class="string">'123456'</span>;</span><br></pre></td></tr></tbody></table></figure><blockquote><p><strong>step4：在从服务器上配置主从关系</strong></p></blockquote><ul><li>在<strong>从服务器</strong>上，执行以下 SQL 操作</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER <span class="keyword">TO</span></span><br><span class="line">    MASTER_HOST<span class="operator">=</span><span class="string">'192.168.2.191'</span>,</span><br><span class="line">    MASTER_PORT<span class="operator">=</span><span class="number">3306</span>,</span><br><span class="line">    MASTER_USER<span class="operator">=</span><span class="string">'sync_slave'</span>,</span><br><span class="line">    MASTER_PASSWORD<span class="operator">=</span><span class="string">'123456'</span>,</span><br><span class="line">    MASTER_LOG_FILE<span class="operator">=</span><span class="string">'binlog.000003'</span>,</span><br><span class="line">    MASTER_LOG_POS<span class="operator">=</span><span class="number">1357</span>;</span><br></pre></td></tr></tbody></table></figure><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>MASTER_HOST</code></td><td>主服务器的 IP 地址或主机名，<strong>这里使用宿主机的 IP 地址（比如 192.168.2.191）</strong></td></tr><tr><td><code>MASTER_PORT</code></td><td>主服务器监听的端口号（默认为 <code>3306</code>），<strong>这里使用 Docker 的映射端口（比如 3306）</strong></td></tr><tr><td><code>MASTER_USER</code></td><td>从服务器用于连接主服务器的用户名</td></tr><tr><td><code>MASTER_PASSWORD</code></td><td>从服务器用于连接主服务器的密码</td></tr><tr><td><code>MASTER_LOG_FILE</code></td><td>从哪个 binlog 文件开始复制</td></tr><tr><td><code>MASTER_LOG_POS</code></td><td>从 binlog 文件的哪个位置开始复制</td></tr></tbody></table><ul><li>在<strong>从服务器</strong>上，查看主从关系的配置</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看从服务器的状态（不需要分号）</span></span><br><span class="line">show slave status \G</span><br></pre></td></tr></tbody></table></figure><h3 id="启动主从同步"><a href="#启动主从同步" class="headerlink" title="启动主从同步"></a>启动主从同步</h3><ul><li>在<strong>多台从服务器</strong>上，分别执行以下 MySQL 命令，启动从服务器的主从同步功能</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动主从同步</span></span><br><span class="line">START SLAVE;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看从服务器的同步状态（不需要分号）</span></span><br><span class="line">SHOW SLAVE STATUS\G</span><br></pre></td></tr></tbody></table></figure><ul><li>观察 MySQL 命令输出的内容，尤其是 <code>Slave_IO_Running</code> 与 <code>Slave_SQL_Running</code> 参数，如果这两个参数的值都是 <code>Yes</code>，则说明主从同步成功</li></ul><p><img data-src="../../../asset/2025/12/mysql-replication-4.png"></p><h3 id="验证主从同步"><a href="#验证主从同步" class="headerlink" title="验证主从同步"></a>验证主从同步</h3><ul><li>在<strong>主服务器</strong>中，执行以下 SQL 语句</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建数据库</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE db_user;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 切换数据库</span></span><br><span class="line">USE db_user;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_user (</span><br><span class="line"> id <span class="type">BIGINT</span> AUTO_INCREMENT,</span><br><span class="line"> uname <span class="type">VARCHAR</span>(<span class="number">30</span>),</span><br><span class="line"> <span class="keyword">PRIMARY</span> KEY (id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入表数据</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user(uname) <span class="keyword">VALUES</span>(<span class="string">'zhang3'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user(uname) <span class="keyword">VALUES</span>(@<span class="variable">@hostname</span>);</span><br></pre></td></tr></tbody></table></figure><ul><li>在<strong>两台从服务器</strong>中，分别查看数据库、表和数据是否已经被同步过来</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看所有数据库</span></span><br><span class="line"><span class="keyword">SHOW</span> DATABASES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 切换数据库</span></span><br><span class="line">USE db_user;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看所有表</span></span><br><span class="line"><span class="keyword">SHOW</span> TABLES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询表数据</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t_user;</span><br></pre></td></tr></tbody></table></figure><h3 id="停止和重置同步"><a href="#停止和重置同步" class="headerlink" title="停止和重置同步"></a>停止和重置同步</h3><ul><li>在需要的时候（比如，主从同步异常），可以执行以下 SQL 语句停止和重置主从同步：</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 在从服务器上执行，作用说明：停止 I/O 线程和 SQL 线程的运行</span></span><br><span class="line">STOP SLAVE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在从服务器上执行，作用说明：用于删除 Slave 数据库的中继日志（relay log）文件，并重新启用新的中继日志（relay log）文件</span></span><br><span class="line">RESET SLAVE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在主服务器上执行，作用说明：删除所有的 binglog 日志文件，并将日志索引文件清空，重新开始所有新的日志文件；通常用于第一次搭建主从同步时，进行主服务器的 binlog 初始化工作</span></span><br><span class="line">RESET MASTER;</span><br></pre></td></tr></tbody></table></figure><h2 id="MySQL-主从同步问题"><a href="#MySQL-主从同步问题" class="headerlink" title="MySQL 主从同步问题"></a>MySQL 主从同步问题</h2><h3 id="常见问题一"><a href="#常见问题一" class="headerlink" title="常见问题一"></a>常见问题一</h3><ul><li>启动主从同步后，常见错误是 <code>Slave_IO_Running: No</code> 或者 <code>Slave_IO_Running: Connecting</code> 的情况，此时查看下方的 <code>Last_IO_ERROR</code> 错误日志，根据日志中显示的错误信息在网上搜索解决方案即可</li></ul><p><img data-src="../../../asset/2025/12/mysql-replication-5.png"></p><ul><li>典型的错误信息，例如：</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Last_IO_Error: Got fatal error 1236 from master when reading data from binary log: 'Client requested master to start replication from position &gt; file size'</span><br></pre></td></tr></tbody></table></figure><ul><li>解决方案：</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 在从服务器中，停止主从同步</span></span><br><span class="line">STOP SLAVE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在主服务器中，查看 master 状态</span></span><br><span class="line"><span class="keyword">SHOW</span> MASTER STATUS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在主服务器中，刷新日志</span></span><br><span class="line">FLUSH LOGS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在主服务器中，再次查看 master 状态（会发现 File 和 Position 发生了变化）</span></span><br><span class="line"><span class="keyword">SHOW</span> MASTER STATUS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在从服务器中，修改从服务器连接主服务器的 SQL，并重新执行该 SQL</span></span><br><span class="line">CHANGE MASTER <span class="keyword">TO</span></span><br><span class="line">    MASTER_HOST<span class="operator">=</span><span class="string">'192.168.2.191'</span>,</span><br><span class="line">    MASTER_PORT<span class="operator">=</span><span class="number">3306</span>,</span><br><span class="line">    MASTER_USER<span class="operator">=</span><span class="string">'sync_slave'</span>,</span><br><span class="line">    MASTER_PASSWORD<span class="operator">=</span><span class="string">'123456'</span>,</span><br><span class="line">    MASTER_LOG_FILE<span class="operator">=</span><span class="string">'binlog.000004'</span>,</span><br><span class="line">    MASTER_LOG_POS<span class="operator">=</span><span class="number">1487</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在从服务器中，重新启动主从同步</span></span><br><span class="line"><span class="keyword">START</span> SLAVE;</span><br></pre></td></tr></tbody></table></figure><h3 id="常见问题二"><a href="#常见问题二" class="headerlink" title="常见问题二"></a>常见问题二</h3><ul><li>Docker 创建并启动 MySQL 容器后，出现警告信息：<code>WARNING: IPv4 forwarding is disabled. Networking will not work.</code></li></ul><p><img data-src="../../../asset/2025/12/mysql-replication-6.png"></p><ul><li>该错误虽然不影响 MySQL 主从同步的搭建，但如果需要通过远程客户端连接 Docker 中的 MySQL，则会导致无法连接</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在外部远程连接 Docker 中的 MySQL 会失败</span></span><br><span class="line">mysql<span class="params"> -h</span> 192.168.2.191<span class="params"> -P</span> 3306<span class="params"> -u</span> root<span class="params"> -p</span></span><br></pre></td></tr></tbody></table></figure><ul><li>解决方案（以 CentOS 为例）：</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭 Docker 服务</span></span><br><span class="line">systemctl stop docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 临时关闭防火墙</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 永久关闭防火墙</span></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 Docker 服务</span></span><br><span class="line">systemctl stop docker</span><br></pre></td></tr></tbody></table></figure><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/7de9021f.html" title="MySQL 基于日志点实现主从复制">https://www.techgrow.cn/posts/7de9021f.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag"><i class="fa fa-tag"></i> 数据库</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/7b5743c6.html" rel="prev" title="HashMap 底层原理浅析"><i class="fa fa-angle-left"></i> HashMap 底层原理浅析</a></div><div class="post-nav-item"> <a href="/posts/9e38efb3.html" rel="next" title="Java 大数据知识图谱 (最新)">Java 大数据知识图谱 (最新)<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">2.2m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">33:47</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/7de9021f.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>