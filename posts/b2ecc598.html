<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍 RabbitMQ 的使用教程。"><meta property="og:type" content="article"><meta property="og:title" content="RabbitMQ 入门教程之四"><meta property="og:url" content="https://www.techgrow.cn/posts/b2ecc598.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍 RabbitMQ 的使用教程。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/03/rabbitmq-20.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/03/rabbitmq-24.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/03/rabbitmq-24.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/03/rabbitmq-26.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/04/rabbitmq-25.png"><meta property="article:published_time" content="2021-06-10T14:13:45.000Z"><meta property="article:modified_time" content="2021-06-10T14:13:45.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="微服务"><meta property="article:tag" content="消息队列"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2025/03/rabbitmq-20.png"><link rel="canonical" href="https://www.techgrow.cn/posts/b2ecc598.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/b2ecc598.html","path":"posts/b2ecc598.html","title":"RabbitMQ 入门教程之四"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>RabbitMQ 入门教程之四 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%BA%90"><span class="nav-text">学习资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="nav-text">版本说明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RabbitMQ-%E6%B6%88%E6%81%AF%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-text">RabbitMQ 消息持久化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A6%82%E5%BF%B5%E4%BB%8B%E7%BB%8D"><span class="nav-text">概念介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-text">队列实现持久化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-text">消息实现持久化</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%E4%BB%A3%E7%A0%81"><span class="nav-text">案例代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E6%B5%8B%E8%AF%95"><span class="nav-text">代码测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RabbitMQ-%E5%8F%91%E5%B8%83%E7%A1%AE%E8%AE%A4"><span class="nav-text">RabbitMQ 发布确认</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%E7%A1%AE%E8%AE%A4%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="nav-text">发布确认的概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%E7%A1%AE%E8%AE%A4%E7%9A%84%E5%BC%80%E5%90%AF"><span class="nav-text">发布确认的开启</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%E7%A1%AE%E8%AE%A4%E7%9A%84%E7%AD%96%E7%95%A5"><span class="nav-text">发布确认的策略</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%95%E4%B8%AA%E7%A1%AE%E8%AE%A4%E5%8F%91%E5%B8%83"><span class="nav-text">单个确认发布</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E7%A1%AE%E8%AE%A4%E5%8F%91%E5%B8%83"><span class="nav-text">批量确认发布</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E7%A1%AE%E8%AE%A4%E5%8F%91%E5%B8%83"><span class="nav-text">异步确认发布</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E5%8E%8B%E6%B5%8B%E7%BB%93%E6%9E%9C"><span class="nav-text">性能压测结果</span></a></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">687</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">53</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/b2ecc598.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="RabbitMQ 入门教程之四 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍 RabbitMQ 的使用教程。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> RabbitMQ 入门教程之四</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-06-10 22:13:45" itemprop="dateCreated datePublished" datetime="2021-06-10T22:13:45+08:00">2021-06-10</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/b2ecc598.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/b2ecc598.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>4.5k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>4 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/ec623f8b.html">RabbitMQ 入门教程之一</a>、<a href="/posts/39a63bd3.html">RabbitMQ 入门教程之二</a>、<a href="/posts/ae3ea986.html">RabbitMQ 入门教程之三</a></li><li><a href="/posts/b2ecc598.html">RabbitMQ 入门教程之四</a>、<a href="/posts/ff0ea7dd.html">RabbitMQ 入门教程之五</a>、<a href="/posts/f9176fde.html">RabbitMQ 入门教程之六</a></li><li><a href="/posts/4eeb4098.html">RabbitMQ 入门教程之七</a>、<a href="/posts/1074caeb.html">RabbitMQ 入门教程之八</a>、<a href="/posts/adff4cba.html">RabbitMQ 入门教程之九</a></li><li><a href="/posts/3168935.html">RabbitMQ 入门教程之十</a>、<a href="/posts/ac3bb7d5.html">RabbitMQ 入门教程之十一</a></li></ul><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="学习资源"><a href="#学习资源" class="headerlink" title="学习资源"></a>学习资源</h3><ul><li><a target="_blank" rel="external nofollow" href="https://github.com/rabbitmq/rabbitmq-server">RabbitMQ GitHub 开源项目</a></li><li><a target="_blank" rel="external nofollow" href="https://www.rabbitmq.com/docs">RabbitMQ 官方文档（英文）</a></li><li><a target="_blank" rel="external nofollow" href="https://rabbitmq.cn/docs">RabbitMQ 官方文档（中文）</a></li></ul><span id="more"></span><h3 id="版本说明"><a href="#版本说明" class="headerlink" title="版本说明"></a>版本说明</h3><p>本文所有案例代码使用的各软件版本如下表所示：</p><table><thead><tr><th>组件</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td> RabbitMQ Server</td><td><code>3.8.26</code></td><td></td></tr><tr><td>RabbitMQ Client</td><td><code>5.10.0</code></td><td></td></tr><tr><td>Erlang</td><td><code>24.2</code></td><td></td></tr><tr><td>Java</td><td><code>11</code></td><td></td></tr></tbody></table><h2 id="RabbitMQ-消息持久化"><a href="#RabbitMQ-消息持久化" class="headerlink" title="RabbitMQ 消息持久化"></a>RabbitMQ 消息持久化</h2><h3 id="概念介绍"><a href="#概念介绍" class="headerlink" title="概念介绍"></a>概念介绍</h3><ul><li>RabbitMQ 的手动确认机制可以保证消费者在处理消息时不会出现丢失消息的情况，但是如何保障当 RabbitMQ 服务器宕机，之前消息生产者发送过来的消息不丢失呢？</li><li>默认情况下 RabbitMQ 退出或由于某种原因宕机时，它会忽视队列和消息，除非告知它不要这样做。</li><li><strong>RabbitMQ 确保消息不会丢失需要做两件事，分别是需要将队列和消息都标记为持久化，后者只需要由生产者来完成即可。</strong></li><li><strong>特别注意：即使同时将队列和消息都标记为持久化，RabbitMQ 仍然无法完全保证消息不丢失，需要配合其他机制才能实现（比如 RabbitMQ 提供的发布确认机制）。</strong></li></ul><h4 id="队列实现持久化"><a href="#队列实现持久化" class="headerlink" title="队列实现持久化"></a>队列实现持久化</h4><p>当创建的队列是非持久化的，如果 RabbitMQ 服务器重启，该队列就会被删除掉。如果要队列实现持久化，需要在生产者 / 消费者声明队列的时候把 <code>durable</code> 参数设置为 <code>true</code>。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 让队列持久化</span></span><br><span class="line"><span class="keyword">boolean</span> durable = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 声明队列</span></span><br><span class="line"><span class="comment">// 参数说明：</span></span><br><span class="line"><span class="comment">// queue – 队列的名称</span></span><br><span class="line"><span class="comment">// durable – 如果需要声明一个持久队列，则为 true（队列将在服务器重启后继续存在）</span></span><br><span class="line"><span class="comment">// exclusive – 如果需要声明一个独占队列（仅限于此连接使用，连接关闭后队列自动删除），则为 true。</span></span><br><span class="line"><span class="comment">// autoDelete – 如果需要声明 autoDelete 队列，则为 true（服务器将在最后一个消费者断开连接以后，自动删除该队列）</span></span><br><span class="line"><span class="comment">// arguments – 队列的其他属性（构造参数）</span></span><br><span class="line">channel.queueDeclare(QUEUE_NAME, durable, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br></pre></td></tr></tbody></table></figure><div class="admonition warning"><p class="admonition-title">特别注意</p><p>如果之前声明的队列不是持久化的，则必须将原来的队列先删除，或者创建一个新的持久化队列，不然 RabbitMQ 的客户端会出现错误，<a href="../../../asset/2025/03/rabbitmq-19.png">如图所示</a>。</p></div><p>下图是在 RabbitMQ 控制台中非持久化队列与持久化队列的 UI 显示区别，持久化队列的 <code>Feature</code> 属性为 <code>D</code>，这个时候即使重启 RabbitMQ 服务器，队列也依然存在。</p><p><img data-src="../../../asset/2025/03/rabbitmq-20.png"></p><h4 id="消息实现持久化"><a href="#消息实现持久化" class="headerlink" title="消息实现持久化"></a>消息实现持久化</h4><p>若希望让 RabbitMQ 消息实现持久化，除了需要声明持久化队列之外，还需要将消息标记为持久化，也就是需要在消息生产者发送消息时，添加 <code>MessageProperties.PERSISTENT_TEXT_PLAIN</code> 这个属性。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 让消息持久化</span></span><br><span class="line">AMQP.BasicProperties msgProperties = MessageProperties.PERSISTENT_TEXT_PLAIN;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送消息</span></span><br><span class="line"><span class="comment">// 参数说明：</span></span><br><span class="line"><span class="comment">// exchange – 要将消息发布到的交换机，空字符串表示默认交换机</span></span><br><span class="line"><span class="comment">// routingKey – 路由 Key</span></span><br><span class="line"><span class="comment">// props – 消息的其他属性，比如：使用 MessageProperties.PERSISTENT_TEXT_PLAIN 属性确保消息持久化，配合持久化队列可避免服务器重启导致消息丢失</span></span><br><span class="line"><span class="comment">// body – 消息内容</span></span><br><span class="line">channel.basicPublish(<span class="string">""</span>, QUEUE_NAME, msgProperties, <span class="string">"hello"</span>.getBytes(StandardCharsets.UTF_8));</span><br></pre></td></tr></tbody></table></figure><div class="admonition warning"><p class="admonition-title">特别注意</p><p>在使用 RabbitMQ 的时候，即使同时将队列和消息都标记为持久化，但这仍然无法完全避免由于缓存机制带来的数据丢失问题。因为从消息发送到真正写入磁盘并完成刷盘（Flush）之间存在一个短暂的时间窗口，在此期间如果节点宕机，消息依然可能丢失。例如，当消息刚进入缓存，尚未完全写入磁盘时，如果 RabbitMQ 服务器突然宕机，该消息可能无法恢复导致丢失。因此，RabbitMQ 的持久化机制并不能提供绝对可靠的保障，但对于一些简单的任务队列应用而言，已足够满足需求。在高可靠性要求的场景中，应该结合使用队列持久化、消息持久化、发布确认机制、镜像队列（或者 Quorum Queue）等机制，才能构建更稳健的消息投递保障体系。</p></div><h3 id="案例代码"><a href="#案例代码" class="headerlink" title="案例代码"></a>案例代码</h3><p>本节将演示如何将队列和消息标记为持久化，以此避免 RabbitMQ 服务器重启后导致消息丢失的问题。</p><div class="admonition note"><p class="admonition-title">代码下载</p><p>本节所需的完整案例代码，可以直接从 <a target="_blank" rel="external nofollow" href="https://github.com/rqh656418510/spring-cloud-share/tree/main/message-queue/rabbitmq-study">GitHub</a> 下载对应章节 <code>rabbitmq-lesson-06</code>。</p></div><ul><li>Maven 依赖</li></ul><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rabbitmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>amqp-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><ul><li>生产者的代码</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.AMQP;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.MessageProperties;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MQProducer</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 队列名称</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"test"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">// 创建连接工厂</span></span><br><span class="line">        ConnectionFactory factory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        factory.setHost(<span class="string">"192.168.2.127"</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        factory.setUsername(<span class="string">"admin"</span>);</span><br><span class="line">        factory.setPassword(<span class="string">"admin"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用 try-with-resources 自动关闭连接和通道，确保资源释放</span></span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">            <span class="comment">// 创建连接</span></span><br><span class="line">            Connection connection = factory.newConnection();</span><br><span class="line">            <span class="comment">// 创建信道</span></span><br><span class="line">            Channel channel = connection.createChannel()</span><br><span class="line">        ) {</span><br><span class="line">            <span class="comment">// 让队列持久化</span></span><br><span class="line">            <span class="keyword">boolean</span> durable = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 声明队列</span></span><br><span class="line">            <span class="comment">// 参数说明：</span></span><br><span class="line">            <span class="comment">// queue – 队列的名称</span></span><br><span class="line">            <span class="comment">// durable – 如果需要声明一个持久队列，则为 true（队列将在服务器重启后继续存在）</span></span><br><span class="line">            <span class="comment">// exclusive – 如果需要声明一个独占队列（仅限于此连接使用，连接关闭后队列自动删除），则为 true。</span></span><br><span class="line">            <span class="comment">// autoDelete – 如果需要声明 autoDelete 队列，则为 true（服务器将在最后一个消费者断开连接以后，自动删除该队列）</span></span><br><span class="line">            <span class="comment">// arguments – 队列的其他属性（构造参数）</span></span><br><span class="line">            channel.queueDeclare(QUEUE_NAME, durable, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 让消息持久化</span></span><br><span class="line">            AMQP.BasicProperties msgProperties = MessageProperties.PERSISTENT_TEXT_PLAIN;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 发送消息</span></span><br><span class="line">            <span class="comment">// 参数说明：</span></span><br><span class="line">            <span class="comment">// exchange – 要将消息发布到的交换机，空字符串表示默认交换机</span></span><br><span class="line">            <span class="comment">// routingKey – 路由 Key</span></span><br><span class="line">            <span class="comment">// props – 消息的其他属性，比如：使用 MessageProperties.PERSISTENT_TEXT_PLAIN 属性确保消息持久化，配合持久化队列可避免服务器重启导致消息丢失</span></span><br><span class="line">            <span class="comment">// body – 消息内容</span></span><br><span class="line">            channel.basicPublish(<span class="string">""</span>, QUEUE_NAME, msgProperties, <span class="string">"hello"</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>消费者的代码</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.CancelCallback;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DeliverCallback;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MQConsumer</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 队列名称</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"test"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">// 创建连接工厂</span></span><br><span class="line">        ConnectionFactory factory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        factory.setHost(<span class="string">"192.168.2.127"</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        factory.setUsername(<span class="string">"admin"</span>);</span><br><span class="line">        factory.setPassword(<span class="string">"admin"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建连接</span></span><br><span class="line">        Connection connection = factory.newConnection();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建信道</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 让队列持久化</span></span><br><span class="line">        <span class="keyword">boolean</span> durable = <span class="keyword">true</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 声明队列</span></span><br><span class="line">        <span class="comment">// 参数说明：</span></span><br><span class="line">        <span class="comment">// queue – 队列的名称</span></span><br><span class="line">        <span class="comment">// durable – 如果需要声明一个持久队列，则为 true（队列将在服务器重启后继续存在）</span></span><br><span class="line">        <span class="comment">// exclusive – 如果需要声明一个独占队列（仅限于此连接使用，连接关闭后队列自动删除），则为 true。</span></span><br><span class="line">        <span class="comment">// autoDelete – 如果需要声明 autoDelete 队列，则为 true（服务器将在最后一个消费者断开连接以后，自动删除该队列）</span></span><br><span class="line">        <span class="comment">// arguments – 队列的其他属性（构造参数）</span></span><br><span class="line">        <span class="comment">// 特别注意：如果确定队列已存在，消费者可以不声明队列。但是，强烈建议无论生产者还是消费者，都应该声明队列，确保参数可控</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, durable, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 消费消息时的回调</span></span><br><span class="line">        DeliverCallback deliverCallback = (consumerTag, message) -&gt; {</span><br><span class="line">            String msg = <span class="keyword">new</span> String(message.getBody(), StandardCharsets.UTF_8);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 模拟消息的耗时处理</span></span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                Thread.sleep(<span class="number">60000</span>);</span><br><span class="line">                System.out.println(<span class="string">"Successed to consume message : "</span> + msg);</span><br><span class="line">            } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 手动确认消息</span></span><br><span class="line">            <span class="comment">// 参数说明：</span></span><br><span class="line">            <span class="comment">// deliveryTag – 消息的标记</span></span><br><span class="line">            <span class="comment">// multiple – true 表示确认所有消息，包括提供的送达标签为止的所有消息；false 仅确认提供的投放标记</span></span><br><span class="line">            channel.basicAck(message.getEnvelope().getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 取消消费时的回调（比如，在消费的时候队列已被删除掉）</span></span><br><span class="line">        CancelCallback cancelCallback = (consumerTag) -&gt; {</span><br><span class="line">            System.out.println(<span class="string">"Failed to consume message : "</span> + consumerTag);</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭自动确认机制</span></span><br><span class="line">        <span class="keyword">boolean</span> autoAck = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 消费消息</span></span><br><span class="line">        <span class="comment">// 参数说明：</span></span><br><span class="line">        <span class="comment">// queue – 队列的名称</span></span><br><span class="line">        <span class="comment">// autoAck – 如果需要服务器在消息投递后自动确认消息，则为 true；如果需要客户端手动确认消息，则为 false</span></span><br><span class="line">        <span class="comment">// deliverCallback – 消费消息时的回调</span></span><br><span class="line">        <span class="comment">// cancelCallback – 取消消费时的回调</span></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, autoAck, deliverCallback, cancelCallback);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 让消费者持续运行</span></span><br><span class="line">        System.out.println(<span class="string">"按回车键退出程序："</span>);</span><br><span class="line">        <span class="keyword">new</span> Scanner(System.in).nextLine();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭信道</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="代码测试"><a href="#代码测试" class="headerlink" title="代码测试"></a>代码测试</h3><ul><li><p>(1) 分别启动生产者和消费者应用</p></li><li><p>(2) 在 RabbitMQ 的控制台，查看是否有未被消费（Ready）或者正在消费（Unacked）的消息，如下图所示：</p></li></ul><p><img data-src="../../../asset/2025/03/rabbitmq-24.png"></p><ul><li>(3) 重启 RabbitMQ 服务器，等重启完成后，如果在 RabbitMQ 的控制台，仍然可以看到有未被消费（Ready）或者正在消费（Unacked）的消息，则说明队列和消息的持久化都生效了，如下图所示：</li></ul><p><img data-src="../../../asset/2025/03/rabbitmq-24.png"></p><ul><li>(4) 最终消息会被消费者消费（注意：这里可能会出现重复消费的现象），消费者的控制台输出结果如下：</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">按回车键退出程序：</span><br><span class="line">Successed to consume message : hello</span><br></pre></td></tr></tbody></table></figure><h2 id="RabbitMQ-发布确认"><a href="#RabbitMQ-发布确认" class="headerlink" title="RabbitMQ 发布确认"></a>RabbitMQ 发布确认</h2><div class="admonition note"><p class="admonition-title">扩展阅读</p><p>基于 SpringBoot 使用 RabbitMQ 的发布确认机制、消息退回机制和备份交换机，可以参考<a href="/posts/1074caeb.html">这里</a>的教程。</p></div><h3 id="发布确认的概念"><a href="#发布确认的概念" class="headerlink" title="发布确认的概念"></a>发布确认的概念</h3><p><strong>当生产者将信道设置为 Confirm 模式后，在该信道上发布的每条消息都会被分配一个从 1 开始递增的唯一 ID。</strong>一旦消息成功投递到所有匹配的队列，Broker 便会发布确认消息给生产者，其中包含该消息的唯一 ID，从而让生产者确认消息已正确到达目标队列。<strong>如果消息和队列是持久化的，Broker 会在将消息写入磁盘后再执行发布确认（如下图所示）。</strong>确认消息的 <code>delivery-tag</code> 字段表示被确认的消息序列号。此外，Broker 还可以在 <code>basic.ack()</code> 中设置 <code>multiple</code> 标志，表示该序列号及其之前的所有消息均已确认（即批量确认）。Confirm 模式的最大优势在于其异步特性。生产者发布消息后，无需等待确认即可继续发送下一条消息，而信道会在消息最终被确认时，通过回调方法通知生产者应用进行处理。如果 RabbitMQ 由于内部错误导致消息丢失，它会发送一条 <code>nack</code>（否定确认）消息，生产者应用同样可以在回调方法中处理该 <code>nack</code>，以便采取相应措施（比如重新发布消息）。</p><p><img data-src="../../../asset/2025/03/rabbitmq-26.png"></p><div class="admonition warning"><p class="admonition-title">发布确认机制的缺陷</p><p><strong>发布确认机制是 RabbitMQ 提供的一种用于确认生产者是否将消息成功发送到交换机的机制</strong>。它允许生产者在发送消息后收到 Broker 的确认（ACK）或否认（NACK）反馈，从而确认消息是否真正被 RabbitMQ 接收和处理。<strong>特别注意，在仅启用 RabbitMQ 发布确认机制的情况下，交换机接收到消息后，会直接给生产者发送确认消息；如果交换机在投递消息时，发现无法将消息路由到任何队列（比如路由键写错、没有匹配的队列等），那么消息会被直接丢弃，此时生产者是不知道消息被丢弃这个事件的</strong>。为了解决这个问题，需要使用到 RabbitMQ 的<a href="/posts/1074caeb.html#RabbitMQ-%E6%B6%88%E6%81%AF%E9%80%80%E5%9B%9E">消息退回机制</a>或者<a href="/posts/1074caeb.html#RabbitMQ-%E5%A4%87%E4%BB%BD%E4%BA%A4%E6%8D%A2%E6%9C%BA">备份交换机</a>。</p></div><div class="admonition note"><p class="admonition-title">为什么需要发布确认机制</p><p>在使用 RabbitMQ 的时候，即使同时将队列和消息都标记为持久化，但这仍然无法完全避免由于缓存机制带来的数据丢失问题。因为从消息发送到真正写入磁盘并完成刷盘（Flush）之间存在一个短暂的时间窗口，在此期间如果节点宕机，消息依然可能丢失。例如，当消息刚进入缓存，尚未完全写入磁盘时，如果 RabbitMQ 服务器突然宕机，该消息可能无法恢复导致丢失。因此，RabbitMQ 的持久化机制并不能提供绝对可靠的保障，但对于一些简单的任务队列应用而言，已足够满足需求。在高可靠性要求的场景中，应该结合使用队列持久化、消息持久化、发布确认机制、镜像队列（或者 Quorum Queue）等机制，才能构建更稳健的消息投递保障体系。</p></div><h3 id="发布确认的开启"><a href="#发布确认的开启" class="headerlink" title="发布确认的开启"></a>发布确认的开启</h3><p>RabbitMQ 的发布确认机制默认是没有开启的，如果要开启需要调用方法 <code>channel.confirmSelect()</code>，每当要想使用发布确认机制，都需要在 Channel 上调用该方法。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建信道</span></span><br><span class="line">Channel channel = connection.createChannel()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启用发布确认</span></span><br><span class="line">channel.confirmSelect();</span><br></pre></td></tr></tbody></table></figure><p>在生产者发送消息后，可以使用以下 API 让生产者等待 Broker 的发布确认响应：</p><table><thead><tr><th>方法</th><th>返回值</th><th>超时时间</th><th>失败时行为</th><th>适用场景</th></tr></thead><tbody><tr><td><code>waitForConfirms()</code></td><td><code>boolean</code></td><td>无</td><td>有未确认消息时返回 <code>false</code>，不会关闭 Channel</td><td> 需要手动处理失败的情况</td></tr><tr><td><code>waitForConfirms(long timeout)</code></td><td><code>boolean</code></td><td>有</td><td>超时或有未确认消息时返回 <code>false</code>，不会关闭 Channel</td><td> 限制等待时间，避免长时间阻塞</td></tr><tr><td><code>waitForConfirmsOrDie()</code></td><td><code>void</code></td><td>无</td><td>有未确认消息时抛出 <code>IOException</code> 并关闭 Channel</td><td> 适用于希望在失败时终止 Channel 的情况</td></tr><tr><td><code>waitForConfirmsOrDie(long timeout)</code></td><td><code>void</code></td><td>有</td><td>超时或有未确认消息时抛出 <code>IOException</code> 并关闭 Channel</td><td> 需要严格保证消息成功且限制等待时间</td></tr></tbody></table><h3 id="发布确认的策略"><a href="#发布确认的策略" class="headerlink" title="发布确认的策略"></a>发布确认的策略</h3><p>RabbitMQ 提供了三种消息发布确认策略，如下：</p><ul><li><p>单个确认发布（同步单个确认）</p><ul><li>原理：发送一条消息后，阻塞等待服务器返回确认消息。</li><li>优点：<ul><li>实现简单。</li><li>消息可靠性高。</li></ul></li><li>缺点：<ul><li>吞吐量低，每次发送消息都需要等待确认。</li><li>延迟较高，不适用于高并发场景。</li></ul></li></ul></li><li><p>批量确认发布（同步批量确认）</p><ul><li>原理：一次性发送多条消息，然后等待服务器返回批量确认。</li><li>优点：<ul><li>比单个确认发布性能更高，减少了等待时间，提高了吞吐量。</li></ul></li><li>缺点：<ul><li>本质上还是同步确认操作，不适用于高并发场景。</li><li>如果出现问题，无法确定具体是哪条消息发布失败，可能导致部分消息丢失或重复发送。</li></ul></li></ul></li><li><p>异步确认发布（异步回调确认）</p><ul><li>原理：消息发送后不阻塞，RabbitMQ 通过回调机制（<code>ConfirmCallback</code>）异步通知哪些消息被确认或丢失。</li><li>优点：<ul><li>异常处理，拥有最高的性能，支持高并发和高吞吐量。</li><li>可以在回调中维护消息状态，准确跟踪失败消息。</li><li>资源占用更低。</li></ul></li><li>缺点：<ul><li>实现较复杂，需要自己管理未确认的消息队列（如使用 <code>ConcurrentSkipListMap</code>）。</li><li>代码逻辑相对较难调试。</li></ul></li></ul></li></ul><h4 id="单个确认发布"><a href="#单个确认发布" class="headerlink" title="单个确认发布"></a>单个确认发布</h4><p><strong>这种发布方式是一种同步确认机制，即每发布一条消息，必须等待其确认后才能继续发布下一条消息。</strong>方法 <code>waitForConfirmsOrDie(long)</code> 仅在消息被确认时才会返回，如果在指定时间内未收到确认，则会抛出异常。这种确认方式有一个最大的缺点就是：发布速度特别的慢。由于未确认的消息会阻塞后续消息的发布，其吞吐量通常仅能达到每秒数百条消息。尽管如此，对于某些应用场景而言，这样的性能可能已经足够。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.MessageProperties;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MQProducer1</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单个确认发布</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">publishMessageIndividually</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">// 创建连接工厂</span></span><br><span class="line">        ConnectionFactory factory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        factory.setHost(<span class="string">"192.168.2.127"</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        factory.setUsername(<span class="string">"admin"</span>);</span><br><span class="line">        factory.setPassword(<span class="string">"admin"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">            <span class="comment">// 创建连接</span></span><br><span class="line">            Connection connection = factory.newConnection();</span><br><span class="line">            <span class="comment">// 创建信道</span></span><br><span class="line">            Channel channel = connection.createChannel()</span><br><span class="line">        ) {</span><br><span class="line">            String queueName = UUID.randomUUID().toString();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 声明队列（支持持久化）</span></span><br><span class="line">            channel.queueDeclare(queueName, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 开启发布确认</span></span><br><span class="line">            channel.confirmSelect();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> total = <span class="number">1000</span>;</span><br><span class="line">            <span class="keyword">long</span> begin = System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; total; i++) {</span><br><span class="line">                <span class="comment">// 发布消息（支持持久化）</span></span><br><span class="line">                String message = <span class="string">"消息"</span> + i;</span><br><span class="line">                channel.basicPublish(<span class="string">""</span>, queueName, MessageProperties.PERSISTENT_TEXT_PLAIN, message.getBytes(StandardCharsets.UTF_8));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 单个确认发布，当服务端返回 false 或超时时间内未返回，生产者可以重发消息</span></span><br><span class="line">                <span class="keyword">boolean</span> flag = channel.waitForConfirms();</span><br><span class="line">                <span class="keyword">if</span> (flag) {</span><br><span class="line">                    System.out.println(<span class="string">"消息发送成功"</span>);</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    System.out.println(<span class="string">"消息发送失败"</span>);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">            System.out.println(<span class="string">"发布"</span> + total + <span class="string">"个单独确认消息，耗时"</span> + (end - begin) + <span class="string">"ms"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="批量确认发布"><a href="#批量确认发布" class="headerlink" title="批量确认发布"></a>批量确认发布</h4><p><strong>相较于逐条发送并确认消息的机制，批量发布消息后统一确认的方式能够显著提升系统吞吐量。</strong>然而这种批量处理策略存在两点主要限制：首先<strong>在消息发布异常的场景中，由于采用批量确认机制，系统无法快速定位具体故障消息，需要将整个消息批次持久化存储，以便后续故障诊断和批量重发；其次，虽然采用了批量处理技术，但消息发布过程本质上仍属于同步操作模式，发布线程在等待确认期间仍会处于阻塞状态。</strong>这种设计在提升吞吐量的同时，需要权衡额外的内存资源消耗和异常处理复杂度。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.MessageProperties;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MQProducer2</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量确认发布</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">publishMessageBatch</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">// 创建连接工厂</span></span><br><span class="line">        ConnectionFactory factory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        factory.setHost(<span class="string">"192.168.2.127"</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        factory.setUsername(<span class="string">"admin"</span>);</span><br><span class="line">        factory.setPassword(<span class="string">"admin"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">            <span class="comment">// 创建连接</span></span><br><span class="line">            Connection connection = factory.newConnection();</span><br><span class="line">            <span class="comment">// 创建信道</span></span><br><span class="line">            Channel channel = connection.createChannel()</span><br><span class="line">        ) {</span><br><span class="line">            String queueName = UUID.randomUUID().toString();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 声明队列（支持持久化）</span></span><br><span class="line">            channel.queueDeclare(queueName, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 开启发布确认</span></span><br><span class="line">            channel.confirmSelect();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 批量确认消息的数量</span></span><br><span class="line">            <span class="keyword">int</span> batchSize = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 未确认消息的数量</span></span><br><span class="line">            <span class="keyword">int</span> outstandingMessageCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> total = <span class="number">1000</span>;</span><br><span class="line">            <span class="keyword">long</span> begin = System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; total; i++) {</span><br><span class="line">                <span class="comment">// 发布消息（支持持久化）</span></span><br><span class="line">                String message = <span class="string">"消息"</span> + i;</span><br><span class="line">                channel.basicPublish(<span class="string">""</span>, queueName, MessageProperties.PERSISTENT_TEXT_PLAIN, message.getBytes(StandardCharsets.UTF_8));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 批量确认发布（比如每发送 100 条消息就批量确认一次）</span></span><br><span class="line">                outstandingMessageCount++;</span><br><span class="line">                <span class="keyword">if</span> (outstandingMessageCount == batchSize) {</span><br><span class="line">                    channel.waitForConfirms();</span><br><span class="line">                    outstandingMessageCount = <span class="number">0</span>;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 为了确保没有剩余的未确认消息，再次确认发布</span></span><br><span class="line">            <span class="keyword">if</span> (outstandingMessageCount &gt; <span class="number">0</span>) {</span><br><span class="line">                channel.waitForConfirms();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">            System.out.println(<span class="string">"发布"</span> + total + <span class="string">"个批量确认消息，耗时"</span> + (end - begin) + <span class="string">"ms"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="异步确认发布"><a href="#异步确认发布" class="headerlink" title="异步确认发布"></a>异步确认发布</h4><p>异步确认虽然在编程逻辑上比前两种方式更复杂，但在可靠性和效率方面表现最佳，性价比最高。它通过回调函数实现消息的可靠传递，而消息中间件也利用回调机制来确认消息是否成功投递。异步确认发布的实现方案如下图所示：</p><p><img data-src="../../../asset/2025/04/rabbitmq-25.png"></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConfirmCallback;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.MessageProperties;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentNavigableMap;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentSkipListMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MQProducer3</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异步确认发布</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">publishMessageAsync</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">// 创建连接工厂</span></span><br><span class="line">        ConnectionFactory factory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        factory.setHost(<span class="string">"192.168.2.127"</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        factory.setUsername(<span class="string">"admin"</span>);</span><br><span class="line">        factory.setPassword(<span class="string">"admin"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">            <span class="comment">// 创建连接</span></span><br><span class="line">            Connection connection = factory.newConnection();</span><br><span class="line">            <span class="comment">// 创建信道</span></span><br><span class="line">            Channel channel = connection.createChannel()</span><br><span class="line">        ) {</span><br><span class="line">            String queueName = UUID.randomUUID().toString();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 声明队列（支持持久化）</span></span><br><span class="line">            channel.queueDeclare(queueName, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 开启发布确认</span></span><br><span class="line">            channel.confirmSelect();</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 线程安全的一个有序哈希表，适用于高并发场景</span></span><br><span class="line"><span class="comment">             * 1. 轻松地将消息序列号与消息进行关联</span></span><br><span class="line"><span class="comment">             * 2. 轻松地批量删除条目，只要传入消息序列号</span></span><br><span class="line"><span class="comment">             * 3. 支持并发访问</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            ConcurrentSkipListMap&lt;Long, String&gt; outstandingConfirms = <span class="keyword">new</span> ConcurrentSkipListMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 收到确认消息的回调</span></span><br><span class="line"><span class="comment">             * 1. deliveryTag 表示消息序列号</span></span><br><span class="line"><span class="comment">             * 2. multiple = true，表示可以确认小于等于当前消息序列号的消息</span></span><br><span class="line"><span class="comment">             * 3. multiple = false，表示仅确认当前消息序列号的消息</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            ConfirmCallback ackCallback = (deliveryTag, multiple) -&gt; {</span><br><span class="line">                <span class="keyword">if</span> (multiple) {</span><br><span class="line">                    <span class="comment">// 返回的是小于等于当前消息序列号的未确认消息，是一个 Map</span></span><br><span class="line">                    ConcurrentNavigableMap&lt;Long, String&gt; confirmed = outstandingConfirms.headMap(deliveryTag, <span class="keyword">true</span>);</span><br><span class="line">                    <span class="comment">// 清除该部分未确认的消息</span></span><br><span class="line">                    confirmed.clear();</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="comment">// 只清除当前消息序列号的消息</span></span><br><span class="line">                    outstandingConfirms.remove(deliveryTag);</span><br><span class="line">                }</span><br><span class="line">            };</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 未收到确认消息的回调</span></span><br><span class="line"><span class="comment">             * 1. deliveryTag 表示消息序列号</span></span><br><span class="line"><span class="comment">             * 2. multiple = true，表示可以确认小于等于当前消息序列号的消息</span></span><br><span class="line"><span class="comment">             * 3. multiple = false，表示仅确认当前消息序列号的消息</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            ConfirmCallback nackCallback = (deliveryTag, multiple) -&gt; {</span><br><span class="line">                <span class="comment">// 异步处理未确认的消息，比如重新发送消息</span></span><br><span class="line">                String message = outstandingConfirms.get(deliveryTag);</span><br><span class="line">                System.out.println(<span class="string">"发布的消息"</span> + message + <span class="string">"未被确认，消息序列号"</span> + deliveryTag);</span><br><span class="line">            };</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 添加一个异步确认的监听器</span></span><br><span class="line"><span class="comment">             * 1. 监听哪些消息发送成功</span></span><br><span class="line"><span class="comment">             * 2. 监听哪些消息发送失败</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            channel.addConfirmListener(ackCallback, nackCallback);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> total = <span class="number">1000</span>;</span><br><span class="line">            <span class="keyword">long</span> begin = System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; total; i++) {</span><br><span class="line">                <span class="comment">// 发布消息（支持持久化）</span></span><br><span class="line">                String message = <span class="string">"消息"</span> + i;</span><br><span class="line">                <span class="comment">// channel.getNextPublishSeqNo() 获取下一个消息的消息序列号</span></span><br><span class="line">                <span class="comment">// 使用 Map 存储全部未确认的消息体，通过消息序列号与消息体进行关联</span></span><br><span class="line">                outstandingConfirms.put(channel.getNextPublishSeqNo(), message);</span><br><span class="line">                channel.basicPublish(<span class="string">""</span>, queueName, MessageProperties.PERSISTENT_TEXT_PLAIN, message.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">            System.out.println(<span class="string">"发布"</span> + total + <span class="string">"个异步确认消息，耗时"</span> + (end - begin) + <span class="string">"ms"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">如何处理异步未确认的消息</p><p>最好的解决方案就是把未确认的消息存储到一个基于内存的能被消息发布线程访问的队列，比如使用 <code>ConcurrentLinkedQueue</code> 队列，这个队列在 ConfirmCallback（负责专门处理 NACK 的情况）与消息发布线程之间进行消息的传递，以此实现未确认消息的重新发送。值得一提的是，重新发送消息后，为了避免消费者在消费消息时，可能出现重复消费的问题，消费者需要实现幂等消费。</p></div><h4 id="性能压测结果"><a href="#性能压测结果" class="headerlink" title="性能压测结果"></a>性能压测结果</h4><p>RabbitMQ 发布确认策略的压测结果如下表所示：</p><table><thead><tr><th>发布确认策略</th><th>消息发送数量</th><th>消息发送耗时</th></tr></thead><tbody><tr><td>单个确认发布</td><td> 1000</td><td>50278 ms</td></tr><tr><td> 批量确认发布</td><td> 1000</td><td>635 ms</td></tr><tr><td> 异步确认发布</td><td> 1000</td><td>92 ms</td></tr></tbody></table><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/b2ecc598.html" title="RabbitMQ 入门教程之四">https://www.techgrow.cn/posts/b2ecc598.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="fa fa-tag"></i> 微服务</a><a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" rel="tag"><i class="fa fa-tag"></i> 消息队列</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/ae3ea986.html" rel="prev" title="RabbitMQ 入门教程之三"><i class="fa fa-angle-left"></i> RabbitMQ 入门教程之三</a></div><div class="post-nav-item"> <a href="/posts/f7ed6378.html" rel="next" title="Debian 更换软件源">Debian 更换软件源<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">1.8m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">26:46</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"/lib/mermaid/dist/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/b2ecc598.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>