<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍 Java 如何通过 Hmily 实现 TCC 分布式事务。"><meta property="og:type" content="article"><meta property="og:title" content="基于 Hmily 实战 TCC 分布式事务之二"><meta property="og:url" content="https://www.techgrow.cn/posts/3e028f15.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍 Java 如何通过 Hmily 实现 TCC 分布式事务。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-21.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-22.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-39.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-23.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-20.png"><meta property="article:published_time" content="2021-03-08T13:12:19.000Z"><meta property="article:modified_time" content="2021-03-08T13:12:19.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="微服务"><meta property="article:tag" content="数据库"><meta property="article:tag" content="分布式"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-21.png"><link rel="canonical" href="https://www.techgrow.cn/posts/3e028f15.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/3e028f15.html","path":"posts/3e028f15.html","title":"基于 Hmily 实战 TCC 分布式事务之二"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>基于 Hmily 实战 TCC 分布式事务之二 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script>
  (function () {

  // 防止 Pjax 重复绑定事件
  if (window.__moonMenuCodeExpandBound) {
    return;
  }
  window.__moonMenuCodeExpandBound = true;

  const STORAGE_KEY = 'moon_menu_code_fold';

  /* ===============================
   * 1. 设置 moon-menu 按钮的 title
   * =============================== */
  (function bindMoonMenuTitles() {
    const items = [
      { selector: '#moon-menu-item-code',        title: '展开 / 折叠代码块' },
      { selector: '#moon-menu-item-back2top',    title: '回到页面顶部' },
      { selector: '#moon-menu-item-back2bottom', title: '回到页面底部' }
    ];

    let allReady = true;

    items.forEach(item => {
      const el = document.querySelector(item.selector);
      if (!el) {
        allReady = false;
        return;
      }
      el.setAttribute('title', item.title);
    });

    if (!allReady) {
      setTimeout(bindMoonMenuTitles, 100);
    }
  })();

  /* =================================
   * 2. 页面首次加载：代码块恢复展开或折叠状态
   * ================================= */
  function applyStoredCodeState() {
    const containers = document.querySelectorAll('.code-container');
    if (!containers.length) {
      return;
    }

    const state = localStorage.getItem(STORAGE_KEY);
    if (!state) {
      return;
    }

    containers.forEach(container => {
      if (state === 'expanded') {
        // 展开代码块
        container.classList.remove('highlight-fold');
      } else if (state === 'folded') {
        // 折叠代码块
        container.classList.add('highlight-fold');
      }
    });
  }

  // 等代码块出现后，再恢复展开或折叠状态
  function waitAndApplyState() {
    const containers = document.querySelectorAll('.code-container');

    if (!containers.length) {
      setTimeout(waitAndApplyState, 100);
      return;
    }

    applyStoredCodeState();
  }

  // 页面首次加载时恢复状态
  waitAndApplyState();
  
  // Pjax 切换页面后，必须重新恢复状态
  document.addEventListener('pjax:complete', function () {
    waitAndApplyState();
  });

  /* ===============================
   * 3. 点击按钮：切换状态并保存
   * =============================== */
  document.addEventListener('click', function (e) {
    const codeMenu = e.target.closest('#moon-menu-item-code');
    if (!codeMenu) {
      return;
    }

    toggleAllCodeBlocks();
  });

  // 展开或折叠代码块
  function toggleAllCodeBlocks() {
    const containers = document.querySelectorAll('.code-container');
    if (!containers.length) {
      return;
    }

    // 只要存在折叠的代码块，就认为当前是折叠状态
    const hasFolded = Array.from(containers).some(c => {
      return c.classList.contains('highlight-fold');
    });

    containers.forEach(container => {
      if (hasFolded) {
        // 展开代码块
        container.classList.remove('highlight-fold');
      } else {
        // 折叠代码块
        container.classList.add('highlight-fold');
      }
    });

    // 记录展开或折叠状态
    localStorage.setItem(
      STORAGE_KEY,
      hasFolded ? 'expanded' : 'folded'
    );
  }

})();
</script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F-TCC-%E4%BA%8B%E5%8A%A1%E5%AE%9E%E6%88%98%EF%BC%88%E7%BC%96%E7%A0%81%EF%BC%89"><span class="nav-text">账户系统 TCC 事务实战（编码）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="nav-text">账户系统的前置知识</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Hmily-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%A1%86%E6%9E%B6"><span class="nav-text">Hmily 分布式事务框架</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Hmily-%E7%9A%84%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3"><span class="nav-text">Hmily 的官方文档</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Hmily-%E7%9A%84%E5%AE%98%E6%96%B9%E6%A1%88%E4%BE%8B"><span class="nav-text">Hmily 的官方案例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Hmily-%E7%9A%84%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="nav-text">Hmily 的版本说明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Hmily-%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD"><span class="nav-text">Hmily 的核心功能</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Hmily-%E7%9A%84-TCC-%E6%A8%A1%E5%BC%8F"><span class="nav-text">Hmily 的 TCC 模式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Hmily-%E7%9A%84-TAC-%E6%A8%A1%E5%BC%8F"><span class="nav-text">Hmily 的 TAC 模式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Hmily-%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-text">Hmily 的工作原理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Hmily-%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-text">Hmily 的注意事项</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%A1%88%E4%BE%8B%E4%BB%A3%E7%A0%81"><span class="nav-text">账户系统的案例代码</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="nav-text">版本说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E8%AF%B4%E6%98%8E"><span class="nav-text">目录结构说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TCC-%E6%A8%A1%E5%9E%8B%E8%AF%B4%E6%98%8E"><span class="nav-text">TCC 模型说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E9%83%A8%E7%BD%B2%E6%9E%B6%E6%9E%84"><span class="nav-text">整体部署架构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">数据库初始化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81"><span class="nav-text">核心代码</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%88%B6-Pom-%E6%A8%A1%E5%9D%97"><span class="nav-text">父 Pom 模块</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%A8%A1%E5%9D%97"><span class="nav-text">注册中心模块</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%89%A3%E9%92%B1%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%9D%97"><span class="nav-text">扣钱服务模块</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE"><span class="nav-text">模块配置</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E4%BB%A3%E7%A0%81"><span class="nav-text">模块代码</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8A%A0%E9%92%B1%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%9D%97"><span class="nav-text">加钱服务模块</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE-1"><span class="nav-text">模块配置</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E4%BB%A3%E7%A0%81-1"><span class="nav-text">模块代码</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E6%B5%8B%E8%AF%95"><span class="nav-text">代码测试</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%AD%A3%E5%B8%B8%E8%B0%83%E7%94%A8%E6%B5%8B%E8%AF%95"><span class="nav-text">正常调用测试</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E8%B0%83%E7%94%A8%E6%B5%8B%E8%AF%95"><span class="nav-text">异常调用测试</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E4%B8%8B%E8%BD%BD"><span class="nav-text">代码下载</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99-1"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">796</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">56</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/3e028f15.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="基于 Hmily 实战 TCC 分布式事务之二 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍 Java 如何通过 Hmily 实现 TCC 分布式事务。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 基于 Hmily 实战 TCC 分布式事务之二</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-03-08 21:12:19" itemprop="dateCreated datePublished" datetime="2021-03-08T21:12:19+08:00">2021-03-08</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/3e028f15.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/3e028f15.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>5.2k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>5 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/1625c614.html">基于 Hmily 实战 TCC 分布式事务之一</a></li><li><a href="/posts/3e028f15.html">基于 Hmily 实战 TCC 分布式事务之二</a></li><li><a href="/posts/a02756f8.html">基于 Hmily 实战 TCC 分布式事务之三</a></li></ul><span id="more"></span><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="/posts/726e9aff.html">分布式事务解决方案介绍</a></li><li><a href="/posts/ebe034ff.html">分布式数据库技术选型介绍</a></li></ul><h2 id="账户系统-TCC-事务实战（编码）"><a href="#账户系统-TCC-事务实战（编码）" class="headerlink" title="账户系统 TCC 事务实战（编码）"></a>账户系统 TCC 事务实战（编码）</h2><h3 id="账户系统的前置知识"><a href="#账户系统的前置知识" class="headerlink" title="账户系统的前置知识"></a>账户系统的前置知识</h3><h4 id="Hmily-分布式事务框架"><a href="#Hmily-分布式事务框架" class="headerlink" title="Hmily 分布式事务框架"></a>Hmily 分布式事务框架</h4><p><a target="_blank" rel="external nofollow" href="https://github.com/dromara/hmily">Hmily</a> 是一个基于 Java 的金融级柔性分布式事务开源解决方案（<strong>已停止维护</strong>），<strong>主要用于微服务架构下的 TCC（Try-Confirm-Cancel）和 TAC（自动补偿）事务模式</strong>；支持通过零侵入式设计快速集成 Dubbo、SpringCloud 等框架，支持多种 RPC 框架和日志存储方式（如 MySQL、Redis、MongoDB、ZooKeeper 等），具备高可靠性、性能和可观测性，可在分布式环境中确保多个服务的一致性执行。它适合金融级场景处理复杂分布式事务。</p><h5 id="Hmily-的官方文档"><a href="#Hmily-的官方文档" class="headerlink" title="Hmily 的官方文档"></a>Hmily 的官方文档</h5><p>Hmily 的官方文档可以查阅 <a target="_blank" rel="external nofollow" href="https://github.com/dromara/hmily/wiki/Configuration">GitHub WiKi</a>，<strong>该文档已过时（最后更改时间是 2018 年），仅供参考，强烈建议直接阅读 Hmily 官方的案例代码</strong>。</p><h5 id="Hmily-的官方案例"><a href="#Hmily-的官方案例" class="headerlink" title="Hmily 的官方案例"></a>Hmily 的官方案例</h5><p>Hmily 的官方案例代码可以从 <a target="_blank" rel="external nofollow" href="https://github.com/dromara/hmily/tree/master/hmily-demo">GitHub 仓库</a> 获取，包括 TCC、TAC 事务模式使用的 Demo。</p><h5 id="Hmily-的版本说明"><a href="#Hmily-的版本说明" class="headerlink" title="Hmily 的版本说明"></a>Hmily 的版本说明</h5><ul><li>在 Maven 中央仓库中，Hmily 最新的版本是 <code>2.1.1</code>（2020 年 9 月发布），而在 GitHub 仓库 的 Tags 中，最新的版本是 <code>2.1.2</code>（2022 年 12 月发布）。</li><li>新项目建议从 <a target="_blank" rel="external nofollow" href="https://github.com/dromara/hmily/tags">GitHub Tags</a> 或者 <a target="_blank" rel="external nofollow" href="https://repo1.maven.org/maven2/org/dromara/hmily-spring-boot-starter-springcloud/">这里</a> 获取最新版本的 Hmily。</li><li>Hmily 的历史开发计划可以查看 - <a target="_blank" rel="external nofollow" href="https://dromara.org/zh/news/hmily-restart.html">Hmily 分布式事务重启月度报告</a>，<a href="../../../asset/2026/01/hmily-dev-plan.png">附报告截图</a>。</li></ul><h5 id="Hmily-的核心功能"><a href="#Hmily-的核心功能" class="headerlink" title="Hmily 的核心功能"></a>Hmily 的核心功能</h5><ul><li>高可靠性：支持分布式场景下的事务异常回滚、超时异常恢复、防止事务悬挂</li><li>易用性：提供零侵入性式的 <code>Spring-Boot</code>、<code>Spring-Namespace</code> 快速与业务系统集成</li><li>高性能：去中心化设计，与业务系统完全融合，天然支持集群部署</li><li>可观测性：支持 Metrics 多项指标性能监控，以及 Admin 管理后台 UI 展示</li><li>多种 RPC：支持 <code>Dubbo</code>、<code>SpringCloud</code>、<code>Motan</code>、<code>Sofa-rpc</code>、<code>brpc</code>、<code>tars</code> 等知名 RPC 框架</li><li>日志存储：支持 <code>mysql</code>、<code>oracle</code>、<code>mongodb</code>、<code>redis</code>、<code>zookeeper</code> 等日常存储方式</li><li>复杂场景：支持 RPC 嵌套调用事务</li></ul><div class="admonition warning"><p class="admonition-title">使用 Hmily 的必要前提</p><ul><li>必须使用 <code>JDK8+</code> 。</li><li>TCC 模式必须要使用一款 <code>RPC</code> 框架，比如 : <code>Dubbo</code>， <code>SpringCloud</code>，<code>Montan</code>。</li></ul></div><h5 id="Hmily-的-TCC-模式"><a href="#Hmily-的-TCC-模式" class="headerlink" title="Hmily 的 TCC 模式"></a>Hmily 的 TCC 模式</h5><p>当使用 Hmily 的 <code>TCC</code> 模式时，开发者需要根据自身业务需求提供 <code>try</code>、<code>confirm</code>、<code>cancel</code> 等三个方法，并且 <code>confirm</code>、<code>cancel</code> 方法由开发者自己完成实现，Hmily 只是负责调用方法来达到事务的一致性。</p><p><img data-src="../../../asset/2026/01/tcc-transaction-21.png"></p><h5 id="Hmily-的-TAC-模式"><a href="#Hmily-的-TAC-模式" class="headerlink" title="Hmily 的 TAC 模式"></a>Hmily 的 TAC 模式</h5><p>当使用 Hmily 的 <code>TAC</code> 模式时，开发者必须使用关系型数据库来进行业务操作，Hmily 会自动生成 <code>回滚 SQL</code>；当业务出现异常的时候，Hmily 会自动执行 <code>回滚 SQL</code> 来达到事务的一致性。</p><p><img data-src="../../../asset/2026/01/tcc-transaction-22.png"></p><h5 id="Hmily-的工作原理"><a href="#Hmily-的工作原理" class="headerlink" title="Hmily 的工作原理"></a>Hmily 的工作原理</h5><blockquote><p>Hmily 的工作原理</p></blockquote><ul><li>Hmily 是一种基于 TCC、TAC 模型的分布式事务解决方案，其核心思想是将分布式事务拆分为各个服务的本地事务来处理。</li><li>在事务执行过程中，每个参与者服务需要实现 <code>Try / Confirm / Cancel</code> 三个本地事务接口，用于完成资源预处理、提交和回滚。</li><li>当全局事务开始时，事务协调器会通过 RPC 调用各参与者的 <code>Try</code> 接口；如果所有参与者执行成功，则继续调用 <code>Confirm</code> 完成事务提交；一旦出现异常，则通过 <code>Cancel</code> 接口进行事务回滚。</li><li>Hmily 通过 RPC 在各服务之间传递事务上下文并协调执行流程，从而实现对分布式事务的统一控制。由于通信基于 RPC 协议，只要各语言能够实现对应的 TCC 接口规范，理论上即可支持跨语言的分布式事务场景。</li><li>Hmily 采用去中心化的事务协调方式，由事务发起方充当事务协调器，通过 RPC 调用各参与者的 <code>Try</code>、<code>Confirm</code>、<code>Cancel</code> 接口，并依赖事务日志和恢复机制，在没有独立中心节点的情况下完成分布式事务协调。</li></ul><p><img data-src="../../../asset/2026/01/tcc-transaction-39.png"></p><blockquote><p>Hmily 事务协调器的工作流程</p></blockquote><ul><li><p>1、全局事务创建（Root）</p><ul><li>当一个被 <code>@Hmily</code> 标注的方法执行时：<ul><li>当前服务创建一个全局事务</li><li>生成全局事务 ID（XID）</li><li>当前服务实例即成为事务协调者</li></ul></li></ul></li><li><p> 2、Try 阶段（第一阶段）</p><ul><li>事务协调者通过 RPC 调用各参与者服务的 <code>Try</code> 方法</li><li>每个参与者：<ul><li>执行本地 Try 逻辑</li><li>持久化事务参与记录（事务日志）</li></ul></li><li>所有 Try 执行成功 → 进入 Confirm</li><li> 任意一个 Try 执行失败 → 进入 Cancel</li><li> 事务协调并不是集中转发，而是通过 RPC 调用链路自然传播事务上下文</li></ul></li><li><p> 3、Confirm / Cancel 阶段（第二阶段）</p><ul><li>Confirm（提交）<ul><li>事务协调者调用各参与者服务的 <code>Confirm</code> 方法</li><li>完成最终提交（要求幂等）</li></ul></li><li>Cancel（回滚）<ul><li>事务协调者调用各参与者服务的 <code>Cancel</code> 方法</li><li>执行补偿逻辑（需处理空回滚、防悬挂等问题）</li></ul></li></ul></li><li><p>4、异常与恢复机制（无中心但可恢复）</p><ul><li>事务日志已持久化</li><li>如果事务协调者宕机或网络异常：<ul><li>任意一个服务实例都可以通过定时恢复任务</li><li>根据事务日志状态继续执行 Confirm 或 Cancel</li></ul></li><li> 协调能力依赖事务日志 + 重试机制，而不是中心节点存活</li></ul></li><li><p> 5、去中心化设计的优缺点</p><ul><li>优点：<ul><li>无单点故障</li><li>无需额外部署事务协调器服务</li><li>更符合微服务自治和水平扩展</li></ul></li><li>缺点：<ul><li>业务侵入性高（需要自行实现 TCC 的 <code>Try / Confirm / Cancel</code> 三个本地事务接口）</li><li>需要严格处理：<ul><li>幂等</li><li>空回滚</li><li>防悬挂</li><li>事务异常</li></ul></li><li>开发复杂度远高于 AT 模式（自动事务），AT 模式的概述：<ul><li>由框架自动完成事务的提交与回滚，业务代码几乎无侵入的一种分布式事务模式<ul><li>基于数据库本地事务</li><li>通过 SQL 解析 + Undo Log 实现自动回滚</li><li>业务侧无需编写 Try / Confirm / Cancel 逻辑</li></ul></li><li>常见框架：Seata AT 模式</li></ul></li></ul></li></ul></li></ul><div class="admonition note"><p class="admonition-title">总结</p><ul><li>Hmily 基于 TCC 模型，通过 RPC 协调各服务执行本地的 Try、Confirm、Cancel 事务，将分布式事务问题转化为多个可控的本地事务，从而实现分布式事务一致性。</li><li>在 Hmily 中，没有独立部署的中心事务协调器服务。事务发起方本身就是事务协调器，协调逻辑以内嵌组件的形式存在于各个业务服务中，事务状态通过共享的事务日志存储来维护。</li></ul></div><h5 id="Hmily-的注意事项"><a href="#Hmily-的注意事项" class="headerlink" title="Hmily 的注意事项"></a>Hmily 的注意事项</h5><ul><li><p>依赖冲突问题</p><ul><li>Hmily-TCC 依赖了一些通用基础库，在实际项目中可能与已有依赖产生版本冲突。</li><li>通常需要通过排查 Maven 的依赖树，统一版本号，或使用 <code>exclude</code> 排除冲突依赖来解决。</li></ul></li><li><p>数据一致性问题</p><ul><li>如果分布式事务在各个阶段发生异常且缺乏完善的处理机制，可能会导致业务数据不一致。</li><li>为避免该问题，需要在 TCC 接口的 <code>try</code>、<code>confirm</code>、<code>cancel</code> 阶段设计合理的异常处理和幂等控制，并根据业务场景选择回滚、重试或补偿等策略。</li></ul></li><li><p>分布式锁问题</p><ul><li>分布式事务通常涉及多个节点的协同执行，部分场景下需要借助分布式锁来保证数据操作的正确性。</li><li>在 Hmily-TCC 中，可结合 ZooKeeper、Redis 等组件实现分布式锁。</li><li>使用分布式锁时需重点关注锁的粒度、超时设置和释放机制，以避免死锁或性能下降。</li></ul></li><li><p>分布式事务性能问题</p><ul><li>Hmily-TCC 基于 AOP 对目标方法进行代理，在一定程度上会引入性能开销。</li><li>可通过合理设计 TCC 接口、减少事务粒度、结合缓存或异步处理等方式，对整体性能进行优化。</li></ul></li><li><p>分布式事务可见性问题</p><ul><li>Hmily-TCC 中事务数据的可见性主要依赖底层数据库事务机制，因此需要确保所使用的数据库具备良好的 ACID 支持，并尽量保持各参与方使用一致的数据库引擎。</li><li>同时，应合理选择数据库隔离级别，以避免脏读、不可重复读或幻读等事务并发问题。</li></ul></li></ul><h3 id="账户系统的案例代码"><a href="#账户系统的案例代码" class="headerlink" title="账户系统的案例代码"></a>账户系统的案例代码</h3><div class="admonition warning"><p class="admonition-title">特别注意</p><p>本节中的案例代码仅用于演示如何通过 SpringCloud + Hmily 实现 TCC 分布式事务，并未涵盖 TCC 在实际运行过程中可能出现的<a href="/posts/1625c614.html#%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E7%9A%84-TCC-%E4%BA%8B%E5%8A%A1%E5%BC%82%E5%B8%B8%E5%88%86%E6%9E%90-1">各种事务异常处理</a>场景（如空回滚、防悬挂、第二阶段重复提交等），<strong>而这些事务异常问题在生产环境中是必须重点考虑并妥善处理的</strong>。</p></div><h4 id="版本说明"><a href="#版本说明" class="headerlink" title="版本说明"></a>版本说明</h4><table><thead><tr><th>组件</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td> JDK</td><td><code>11</code></td><td></td></tr><tr><td>MySQL</td><td><code>5.7.44</code></td><td></td></tr><tr><td>Hmily</td><td><code>2.1.1</code></td><td></td></tr><tr><td>SpringBoot</td><td><code>2.3.7.RELEASE</code></td><td>Hmily 官方并不支持 SpringBoot <code>3.x</code></td></tr><tr><td>SpringCloud</td><td><code>Hoxton.SR9</code></td><td></td></tr></tbody></table><div class="admonition note"><p class="admonition-title">Hmily 版本说明</p><p>在 Maven 中央仓库中，Hmily 最新的版本是 <code>2.1.1</code>（2020 年 9 月发布），而在 GitHub 仓库 的 Tags 中，最新的版本是 <code>2.1.2</code>（2022 年 12 月发布），新项目建议从 <a target="_blank" rel="external nofollow" href="https://github.com/dromara/hmily/tags">GitHub Tags</a> 或者 <a target="_blank" rel="external nofollow" href="https://repo1.maven.org/maven2/org/dromara/hmily-spring-boot-starter-springcloud/">这里</a> 获取最新版本的 Hmily。</p></div><h4 id="目录结构说明"><a href="#目录结构说明" class="headerlink" title="目录结构说明"></a>目录结构说明</h4><ul><li>在本案例中，账户系统的核心模块如下所示：</li></ul><table><thead><tr><th>模块名称</th><th>端口</th><th>说明</th></tr></thead><tbody><tr><td><code>eureka-server</code></td><td><code>9091</code></td><td>Eureka 注册中心</td></tr><tr><td><code>fencai-hmily-money-from</code></td><td><code>9092</code></td><td>扣钱服务（出账）</td></tr><tr><td><code>fencai-hmily-money-to</code></td><td><code>9093</code></td><td>加钱服务（入账）</td></tr></tbody></table><ul><li>在本案例中，账户系统的整体目录结构如下所示：</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">├── distributed-transaction-01.iml</span><br><span class="line">├── eureka-server</span><br><span class="line">│&nbsp;&nbsp; ├── eureka-server.iml</span><br><span class="line">│&nbsp;&nbsp; ├── pom.xml</span><br><span class="line">│&nbsp;&nbsp; └── src</span><br><span class="line">│&nbsp;&nbsp;     └── main</span><br><span class="line">│&nbsp;&nbsp;         ├── java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp; └── com</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;     └── distributed</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;         └── transaction</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             └── EurekaServerApplication.java</span><br><span class="line">│&nbsp;&nbsp;         └── resources</span><br><span class="line">│&nbsp;&nbsp;             └── application.yml</span><br><span class="line">├── fencai-hmily-money-from</span><br><span class="line">│&nbsp;&nbsp; ├── fencai-hmily-money-from.iml</span><br><span class="line">│&nbsp;&nbsp; ├── pom.xml</span><br><span class="line">│&nbsp;&nbsp; └── src</span><br><span class="line">│&nbsp;&nbsp;     └── main</span><br><span class="line">│&nbsp;&nbsp;         ├── java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp; └── com</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;     └── distributed</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;         └── transaction</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             ├── client</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             │&nbsp;&nbsp; └── AccountClient.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             ├── controller</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             │&nbsp;&nbsp; └── AccountController.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             ├── entity</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             │&nbsp;&nbsp; └── Account.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             ├── mapper</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             │&nbsp;&nbsp; └── AccountMapper.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             ├── MoneyFromApplication.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             └── service</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                 ├── AccountService.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                 └── impl</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                     └── AccountServiceImpl.java</span><br><span class="line">│&nbsp;&nbsp;         └── resources</span><br><span class="line">│&nbsp;&nbsp;             ├── application.yml</span><br><span class="line">│&nbsp;&nbsp;             ├── hmily.yml</span><br><span class="line">│&nbsp;&nbsp;             └── mapper</span><br><span class="line">│&nbsp;&nbsp;                 └── AccountMapper.xml</span><br><span class="line">├── fencai-hmily-money-to</span><br><span class="line">│&nbsp;&nbsp; ├── fencai-hmily-money-to.iml</span><br><span class="line">│&nbsp;&nbsp; ├── pom.xml</span><br><span class="line">│&nbsp;&nbsp; └── src</span><br><span class="line">│&nbsp;&nbsp;     └── main</span><br><span class="line">│&nbsp;&nbsp;         ├── java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp; └── com</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;     └── distributed</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;         └── transaction</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             ├── controller</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             │&nbsp;&nbsp; └── AccountController.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             ├── entity</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             │&nbsp;&nbsp; └── Account.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             ├── mapper</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             │&nbsp;&nbsp; └── AccountMapper.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             ├── MoneyToApplication.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             └── service</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                 ├── AccountService.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                 └── impl</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                     └── AccountServiceImpl.java</span><br><span class="line">│&nbsp;&nbsp;         └── resources</span><br><span class="line">│&nbsp;&nbsp;             ├── application.yml</span><br><span class="line">│&nbsp;&nbsp;             ├── hmily.yml</span><br><span class="line">│&nbsp;&nbsp;             └── mapper</span><br><span class="line">│&nbsp;&nbsp;                 └── AccountMapper.xml</span><br><span class="line">└── pom.xml</span><br></pre></td></tr></tbody></table></figure><h4 id="TCC-模型说明"><a href="#TCC-模型说明" class="headerlink" title="TCC 模型说明"></a>TCC 模型说明</h4><p>在本案例中，账户系统使用的 TCC 模型如下图所示：</p><p><img data-src="../../../asset/2026/01/tcc-transaction-23.png"></p><div class="admonition note"><p class="admonition-title">提示</p><p>更多关于账户系统其他 TCC 模型的介绍可参考 <a href="/posts/1625c614.html#%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E7%9A%84-TCC-%E6%A8%A1%E5%9E%8B">这里</a>。</p></div><h4 id="整体部署架构"><a href="#整体部署架构" class="headerlink" title="整体部署架构"></a>整体部署架构</h4><p><img data-src="../../../asset/2026/01/tcc-transaction-20.png"></p><h4 id="数据库初始化"><a href="#数据库初始化" class="headerlink" title="数据库初始化"></a>数据库初始化</h4><ul><li>创建数据库</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建扣钱数据库</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE account_from <span class="keyword">DEFAULT</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建加钱数据库</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE account_to <span class="keyword">DEFAULT</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8;</span><br></pre></td></tr></tbody></table></figure><ul><li>创建数据库表（<code>account_from.t_account</code>）</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 切换数据库</span></span><br><span class="line">USE account_from;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建数据库表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t_account` (</span><br><span class="line">    `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">'物理主键'</span>,</span><br><span class="line">    `name` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> COMMENT <span class="string">'用户名称'</span>,</span><br><span class="line">    `balance` <span class="type">decimal</span>(<span class="number">20</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0.00'</span> COMMENT <span class="string">'账户余额'</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入数据</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> account_from.t_account(id, name, balance) <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">'张三'</span>, <span class="number">100</span>);</span><br></pre></td></tr></tbody></table></figure><ul><li>创建数据库表（<code>account_to.t_account</code>）</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 切换数据库</span></span><br><span class="line">USE account_to;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建数据库表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t_account` (</span><br><span class="line">    `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">'物理主键'</span>,</span><br><span class="line">    `name` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> COMMENT <span class="string">'用户名称'</span>,</span><br><span class="line">    `balance` <span class="type">decimal</span>(<span class="number">20</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0.00'</span> COMMENT <span class="string">'账户余额'</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入数据</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> account_to.t_account(id, name, balance) <span class="keyword">VALUES</span>(<span class="number">2</span>, <span class="string">'李四'</span>, <span class="number">100</span>);</span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">Hmily 数据库的初始化</p><p>当 Hmily 使用 MySQL 来存储事务日志时，只要项目引入 <code>hmily-spring-boot-starter-springcloud</code> 依赖，并且在 <code>hmily.yml</code> 中添加 MySQL 相关的配置，那么 Hmily 在微服务应用启动时，默认会自动创建相关的数据库（<code>hmily</code>）和数据库表，比如 MySQL 初始化的 SQL 脚本源文件可以查看 <a target="_blank" rel="external nofollow" href="https://github.com/dromara/hmily/blob/master/hmily-repository/hmily-repository-database/hmily-repository-database-mysql/src/main/resources/mysql/schema.sql">GitHub 仓库</a>。</p></div><h4 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h4><h5 id="父-Pom-模块"><a href="#父-Pom-模块" class="headerlink" title="父 Pom 模块"></a>父 Pom 模块</h5><div class="admonition note"><p class="admonition-title">提示</p><p>父 Pom 模块主要用于统一管理和定义项目中各类核心依赖的版本号，避免在各个子模块中重复声明版本，从而提升依赖管理的可维护性和一致性。</p></div><ul><li>Maven 的 XML 配置内容</li></ul><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- SpringBoot --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- SpringCloud --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>Greenwich.SR3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- MyBatis --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Hmily --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.dromara<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hmily-spring-boot-starter-springcloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 移除 MongoDB 驱动 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.dromara<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hmily-repository-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>eureka-server<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>fencai-hmily-money-to<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>fencai-hmily-money-from<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h5 id="注册中心模块"><a href="#注册中心模块" class="headerlink" title="注册中心模块"></a>注册中心模块</h5><ul><li>Maven 的 XML 配置内容</li></ul><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Eureka Server --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><ul><li>SpringBoot 的 YML 配置内容</li></ul><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span>               <span class="comment"># Eureka服务端的实例名称</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">enable-self-preservation:</span> <span class="literal">false</span>   <span class="comment"># 是否开启 Eureka Server 的自我保护机制</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span>       <span class="comment"># 是否将自己注册到 Eureka Server</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span>             <span class="comment"># 是否从 Eureka Server 拉取注册表信息</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://${eureka.instance.hostname}:${server.port}/eureka/</span>   <span class="comment"># Eureka Server 提供的注册地址</span></span><br></pre></td></tr></tbody></table></figure><ul><li>SpringBoot 的主启动类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaServerApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        SpringApplication.run(EurekaServerApplication.class);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h5 id="扣钱服务模块"><a href="#扣钱服务模块" class="headerlink" title="扣钱服务模块"></a>扣钱服务模块</h5><h6 id="模块配置"><a href="#模块配置" class="headerlink" title="模块配置"></a>模块配置</h6><ul><li>Maven 的 XML 配置内容</li></ul><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Web --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- MyBatis --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- MySQL --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Eureka Client --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- OpenFeign --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Hmily --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.dromara<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hmily-spring-boot-starter-springcloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><ul><li>MyBatis XML 映射文件的内容</li></ul><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.distributed.transaction.mapper.AccountMapper"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateBalance"</span>&gt;</span></span><br><span class="line">        update `t_account` set balance = balance + #{delta} where id = #{id} and balance + #{delta} &gt;= 0</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><ul><li>SpringBoot 的 YML 配置内容</li></ul><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9091</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">fencai-hmily-money-from</span></span><br><span class="line">  <span class="comment"># 数据源配置</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.56.112:3307/account_from?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">"123456"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># MyBatis 配置</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapper/*.xml</span>  <span class="comment"># 指定 Mapper XML 文件位置</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.distributed.transaction.entity</span>  <span class="comment"># 指定 Mapper 接口的包路径</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span>  <span class="comment"># 开启驼峰命名自动映射</span></span><br><span class="line">    <span class="attr">use-generated-keys:</span> <span class="literal">true</span>  <span class="comment"># 获取数据库自增主键值</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span>  <span class="comment"># 控制台打印SQL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Eureka 配置</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:9090/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">${spring.application.name}-${server.port}</span>    <span class="comment"># 自定义服务名称</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>                                   <span class="comment"># 将IP注册到Eureka Server上，若不配置默认使用机器的主机名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志打印</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">org.dromara.hmily:</span> <span class="string">DEBUG</span></span><br></pre></td></tr></tbody></table></figure><ul><li>Hmily 的 YML 配置内容（<strong>可以根据实际业务需求，适当调整 Hmily 的配置参数</strong>）</li></ul><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Hmily 服务端相关配置</span></span><br><span class="line"><span class="attr">hmily:</span></span><br><span class="line">  <span class="comment"># Hmily Server 配置</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="comment"># 配置模式：local 表示本地配置模式</span></span><br><span class="line">    <span class="attr">configMode:</span> <span class="string">local</span></span><br><span class="line">    <span class="comment"># 当前应用名称（Hmily Server 使用）</span></span><br><span class="line">    <span class="attr">appName:</span> <span class="string">fencai-hmily-money-from-sc</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 只有 server.configMode 为 local 时才会读取以下配置</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="comment"># 当前应用名称（业务侧使用）</span></span><br><span class="line">    <span class="attr">appName:</span> <span class="string">fencai-hmily-money-from-sc</span></span><br><span class="line">    <span class="comment"># 序列化方式，推荐使用 kryo；支持 hessian、protostuff、jdk；测试表现：kryo &gt; hessian &gt; protostuff &gt; jdk</span></span><br><span class="line">    <span class="attr">serializer:</span> <span class="string">kryo</span></span><br><span class="line">    <span class="comment"># 上下文传递模式（threadLocal / transmittableThreadLocal）</span></span><br><span class="line">    <span class="attr">contextTransmittalMode:</span> <span class="string">threadLocal</span></span><br><span class="line">    <span class="comment"># 定时任务线程池最大线程数，高并发场景下可适当调大</span></span><br><span class="line">    <span class="attr">scheduledThreadMax:</span> <span class="number">16</span></span><br><span class="line">    <span class="comment"># 恢复任务首次延迟时间（秒）</span></span><br><span class="line">    <span class="attr">scheduledRecoveryDelay:</span> <span class="number">60</span></span><br><span class="line">    <span class="comment"># 清理任务执行间隔（秒）</span></span><br><span class="line">    <span class="attr">scheduledCleanDelay:</span> <span class="number">60</span></span><br><span class="line">    <span class="comment"># 物理删除任务执行间隔（秒）</span></span><br><span class="line">    <span class="attr">scheduledPhyDeletedDelay:</span> <span class="number">600</span></span><br><span class="line">    <span class="comment"># 定时任务初始化延迟时间（秒）</span></span><br><span class="line">    <span class="attr">scheduledInitDelay:</span> <span class="number">30</span></span><br><span class="line">    <span class="comment"># 事务恢复延迟时间（秒），强烈建议大于 RPC 调用的超时时间，否则可能误触发补偿；比如设置为：≥ RPC 超时 + 网络抖动余量</span></span><br><span class="line">    <span class="attr">recoverDelayTime:</span> <span class="number">60</span></span><br><span class="line">    <span class="comment"># 清理延迟时间（秒）</span></span><br><span class="line">    <span class="attr">cleanDelayTime:</span> <span class="number">180</span></span><br><span class="line">    <span class="comment"># 单次处理事务的最大数量限制</span></span><br><span class="line">    <span class="attr">limit:</span> <span class="number">200</span></span><br><span class="line">    <span class="comment"># 最大重试次数，默认 10 次，业务服务宕机时定时任务在 retryMax 次内执行 cancel 或 confirm</span></span><br><span class="line">    <span class="attr">retryMax:</span> <span class="number">10</span></span><br><span class="line">    <span class="comment"># Disruptor 缓冲区大小，高并发时可调大，建议为 2 的幂次方</span></span><br><span class="line">    <span class="attr">bufferSize:</span> <span class="number">8192</span></span><br><span class="line">    <span class="comment"># 消费者线程数</span></span><br><span class="line">    <span class="attr">consumerThreads:</span> <span class="number">16</span></span><br><span class="line">    <span class="comment"># 是否启用异步事务日志存储</span></span><br><span class="line">    <span class="attr">asyncRepository:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 是否自动建表（仅关系型数据库有效）</span></span><br><span class="line">    <span class="attr">autoSql:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 是否启用物理删除</span></span><br><span class="line">    <span class="attr">phyDeleted:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 事务数据保留天数</span></span><br><span class="line">    <span class="attr">storeDays:</span> <span class="number">3</span></span><br><span class="line">    <span class="comment"># 事务日志存储类型（mysql / postgresql / mongodb / redis / zookeeper / file 等）</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">mysql</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Hmily 仓库相关配置</span></span><br><span class="line"><span class="attr">repository:</span></span><br><span class="line">  <span class="comment"># 数据库相关配置</span></span><br><span class="line">  <span class="attr">database:</span></span><br><span class="line">    <span class="comment"># JDBC 驱动类名</span></span><br><span class="line">    <span class="attr">driverClassName:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="comment"># 数据库连接 URL</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.56.112:3307/hmily?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">    <span class="comment"># 数据库用户名</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="comment"># 数据库密码</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">"123456"</span></span><br><span class="line">    <span class="comment"># 连接池最大连接数</span></span><br><span class="line">    <span class="attr">maxActive:</span> <span class="number">20</span></span><br><span class="line">    <span class="comment"># 连接池最小空闲连接数</span></span><br><span class="line">    <span class="attr">minIdle:</span> <span class="number">10</span></span><br><span class="line">    <span class="comment"># 获取连接超时时间（毫秒）</span></span><br><span class="line">    <span class="attr">connectionTimeout:</span> <span class="number">30000</span></span><br><span class="line">    <span class="comment"># 连接空闲超时时间（毫秒）</span></span><br><span class="line">    <span class="attr">idleTimeout:</span> <span class="number">600000</span></span><br><span class="line">    <span class="comment"># 连接最大生命周期（毫秒）</span></span><br><span class="line">    <span class="attr">maxLifetime:</span> <span class="number">1800000</span></span><br></pre></td></tr></tbody></table></figure><h6 id="模块代码"><a href="#模块代码" class="headerlink" title="模块代码"></a>模块代码</h6><ul><li>实体类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 账户信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Account</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 账户余额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal balance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">getBalance</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> balance;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBalance</span><span class="params">(BigDecimal balance)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.balance = balance;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Mapper 类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountMapper</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按增量更新账户余额，并发环境下可避免「丢失更新」问题</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id    账户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delta 余额变动值（正数：增加余额；负数：减少余额）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 影响行数（1：成功；0：账户不存在或更新条件不满足）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">updateBalance</span><span class="params">(<span class="meta">@Param("id")</span> Long id, <span class="meta">@Param("delta")</span> BigDecimal delta)</span></span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Feign 客户端</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.dromara.hmily.annotation.Hmily;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Feign 客户端（加钱服务）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FeignClient(value = "fencai-hmily-money-to")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountClient</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转账操作 &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 必须使用 <span class="doctag">@Hmily</span> 注解修饰方法 &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 远程调用加钱服务的 try 方法（TCC 的三大方法之一）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id         账户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transMoney 转账金额（正数）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 成功，false 失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Hmily</span></span><br><span class="line">    <span class="meta">@GetMapping("/account/{id}/{transMoney}")</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">transfer</span><span class="params">(<span class="meta">@PathVariable("id")</span> Long id, <span class="meta">@PathVariable("transMoney")</span> BigDecimal transMoney)</span></span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Service 接口</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 尝试更新账户余额</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fromId 扣钱的账户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delta  余额变动值（正数：增加余额；负数：减少余额）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> toId   加钱的账号ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">tryUpdateBalance</span><span class="params">(Long fromId, BigDecimal delta, Long toId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 确认更新账户余额</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fromId 扣钱的账户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delta  余额变动值（正数：增加余额；负数：减少余额）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> toId   加钱的账号ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">confirmUpdateBalance</span><span class="params">(Long fromId, BigDecimal delta, Long toId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取消更新账户余额</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fromId 扣钱的账户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delta  余额变动值（正数：增加余额；负数：减少余额）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> toId   加钱的账号ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">cancelUpdateBalance</span><span class="params">(Long fromId, BigDecimal delta, Long toId)</span></span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Service 实现类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.distributed.transaction.client.AccountClient;</span><br><span class="line"><span class="keyword">import</span> com.distributed.transaction.mapper.AccountMapper;</span><br><span class="line"><span class="keyword">import</span> com.distributed.transaction.service.AccountService;</span><br><span class="line"><span class="keyword">import</span> org.dromara.hmily.annotation.HmilyTCC;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title">AccountService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AccountMapper accountMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AccountClient accountClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加 <span class="doctag">@HmilyTCC</span> 注解 &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 注解 <span class="doctag">@HmilyTCC</span> 必须指定 confirmMethod 和 cancelMethod 参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@HmilyTCC(confirmMethod = "confirmUpdateBalance", cancelMethod = "cancelUpdateBalance")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryUpdateBalance</span><span class="params">(Long fromId, BigDecimal delta, Long toId)</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"出账 开始"</span>);</span><br><span class="line">        <span class="comment">// 扣钱</span></span><br><span class="line">        accountMapper.updateBalance(fromId, delta);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过 Feign 远程调用加钱服务的 try 方法（TCC 的三大方法之一）</span></span><br><span class="line">        accountClient.transfer(toId, delta.negate());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">confirmUpdateBalance</span><span class="params">(Long fromId, BigDecimal delta, Long toId)</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"出账 确认"</span>);</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancelUpdateBalance</span><span class="params">(Long fromId, BigDecimal delta, Long toId)</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"出账 取消"</span>);</span><br><span class="line">        <span class="comment">// 还钱（任意一个 try 方法执行失败时）</span></span><br><span class="line">        accountMapper.updateBalance(fromId, delta.negate());</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Controller 类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.distributed.transaction.service.AccountService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 账户控制器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AccountService accountService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转账操作</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fromId     扣钱的账户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transMoney 转账金额（正数）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> toId       加钱的账号ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping("/account/{fromId}/{transMoney}/{toId}")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">transfer</span><span class="params">(<span class="meta">@PathVariable("fromId")</span> Long fromId, <span class="meta">@PathVariable("transMoney")</span> BigDecimal transMoney, <span class="meta">@PathVariable("toId")</span> Long toId)</span> </span>{</span><br><span class="line">        <span class="comment">// 调用本地的 try 方法（TCC 的三大方法之一）</span></span><br><span class="line">        <span class="keyword">return</span> accountService.tryUpdateBalance(fromId, transMoney.negate(), toId);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>SpringBoot 主启动类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan("com.distributed.transaction.mapper")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MoneyFromApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        SpringApplication.run(MoneyFromApplication.class);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h5 id="加钱服务模块"><a href="#加钱服务模块" class="headerlink" title="加钱服务模块"></a>加钱服务模块</h5><h6 id="模块配置-1"><a href="#模块配置-1" class="headerlink" title="模块配置"></a>模块配置</h6><ul><li>Maven 的 XML 配置内容</li></ul><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Web --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- MyBatis --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- MySQL --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Eureka Client --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- OpenFeign --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Hmily --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.dromara<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hmily-spring-boot-starter-springcloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><ul><li>MyBatis XML 映射文件的内容</li></ul><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.distributed.transaction.mapper.AccountMapper"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateBalance"</span>&gt;</span></span><br><span class="line">        update `t_account` set balance = balance + #{delta} where id = #{id} and balance + #{delta} &gt;= 0</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><ul><li>SpringBoot 的 YML 配置内容</li></ul><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9092</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">fencai-hmily-money-to</span></span><br><span class="line">  <span class="comment"># 数据源配置</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.56.112:3307/account_to?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">"123456"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># MyBatis 配置</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapper/*.xml</span>  <span class="comment"># 指定 Mapper XML 文件位置</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.distributed.transaction.entity</span>  <span class="comment"># 指定 Mapper 接口的包路径</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span>  <span class="comment"># 开启驼峰命名自动映射</span></span><br><span class="line">    <span class="attr">use-generated-keys:</span> <span class="literal">true</span>  <span class="comment"># 获取数据库自增主键值</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span>  <span class="comment"># 控制台打印SQL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Eureka 配置</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:9090/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">${spring.application.name}-${server.port}</span>    <span class="comment"># 自定义服务名称</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>                                   <span class="comment"># 将IP注册到Eureka Server上，若不配置默认使用机器的主机名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志打印</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">org.dromara.hmily:</span> <span class="string">DEBUG</span></span><br></pre></td></tr></tbody></table></figure><ul><li>Hmily 的 YML 配置内容</li></ul><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Hmily 服务端相关配置</span></span><br><span class="line"><span class="attr">hmily:</span></span><br><span class="line">  <span class="comment"># Hmily Server 配置</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="comment"># 配置模式：local 表示本地配置模式</span></span><br><span class="line">    <span class="attr">configMode:</span> <span class="string">local</span></span><br><span class="line">    <span class="comment"># 当前应用名称（Hmily Server 使用）</span></span><br><span class="line">    <span class="attr">appName:</span> <span class="string">fencai-hmily-money-to-sc</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 只有 server.configMode 为 local 时才会读取以下配置</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="comment"># 当前应用名称（业务侧使用）</span></span><br><span class="line">    <span class="attr">appName:</span> <span class="string">fencai-hmily-money-to-sc</span></span><br><span class="line">    <span class="comment"># 序列化方式，推荐使用 kryo；支持 hessian、protostuff、jdk；测试表现：kryo &gt; hessian &gt; protostuff &gt; jdk</span></span><br><span class="line">    <span class="attr">serializer:</span> <span class="string">kryo</span></span><br><span class="line">    <span class="comment"># 上下文传递模式（threadLocal / transmittableThreadLocal）</span></span><br><span class="line">    <span class="attr">contextTransmittalMode:</span> <span class="string">threadLocal</span></span><br><span class="line">    <span class="comment"># 定时任务线程池最大线程数，高并发场景下可适当调大</span></span><br><span class="line">    <span class="attr">scheduledThreadMax:</span> <span class="number">16</span></span><br><span class="line">    <span class="comment"># 恢复任务首次延迟时间（秒）</span></span><br><span class="line">    <span class="attr">scheduledRecoveryDelay:</span> <span class="number">60</span></span><br><span class="line">    <span class="comment"># 清理任务执行间隔（秒）</span></span><br><span class="line">    <span class="attr">scheduledCleanDelay:</span> <span class="number">60</span></span><br><span class="line">    <span class="comment"># 物理删除任务执行间隔（秒）</span></span><br><span class="line">    <span class="attr">scheduledPhyDeletedDelay:</span> <span class="number">600</span></span><br><span class="line">    <span class="comment"># 定时任务初始化延迟时间（秒）</span></span><br><span class="line">    <span class="attr">scheduledInitDelay:</span> <span class="number">30</span></span><br><span class="line">    <span class="comment"># 事务恢复延迟时间（秒），强烈建议大于 RPC 调用的超时时间，否则可能误触发补偿；比如设置为：≥ RPC 超时 + 网络抖动余量</span></span><br><span class="line">    <span class="attr">recoverDelayTime:</span> <span class="number">60</span></span><br><span class="line">    <span class="comment"># 清理延迟时间（秒）</span></span><br><span class="line">    <span class="attr">cleanDelayTime:</span> <span class="number">180</span></span><br><span class="line">    <span class="comment"># 单次处理事务的最大数量限制</span></span><br><span class="line">    <span class="attr">limit:</span> <span class="number">200</span></span><br><span class="line">    <span class="comment"># 最大重试次数，默认 10 次，业务服务宕机时定时任务在 retryMax 次内执行 cancel 或 confirm</span></span><br><span class="line">    <span class="attr">retryMax:</span> <span class="number">10</span></span><br><span class="line">    <span class="comment"># Disruptor 缓冲区大小，高并发时可调大，建议为 2 的幂次方</span></span><br><span class="line">    <span class="attr">bufferSize:</span> <span class="number">8192</span></span><br><span class="line">    <span class="comment"># 消费者线程数</span></span><br><span class="line">    <span class="attr">consumerThreads:</span> <span class="number">16</span></span><br><span class="line">    <span class="comment"># 是否启用异步事务日志存储</span></span><br><span class="line">    <span class="attr">asyncRepository:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 是否自动建表（仅关系型数据库有效）</span></span><br><span class="line">    <span class="attr">autoSql:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 是否启用物理删除</span></span><br><span class="line">    <span class="attr">phyDeleted:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 事务数据保留天数</span></span><br><span class="line">    <span class="attr">storeDays:</span> <span class="number">3</span></span><br><span class="line">    <span class="comment"># 事务日志存储类型（mysql / postgresql / mongodb / redis / zookeeper / file 等）</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">mysql</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Hmily 仓库相关配置</span></span><br><span class="line"><span class="attr">repository:</span></span><br><span class="line">  <span class="comment"># 数据库相关配置</span></span><br><span class="line">  <span class="attr">database:</span></span><br><span class="line">    <span class="comment"># JDBC 驱动类名</span></span><br><span class="line">    <span class="attr">driverClassName:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="comment"># 数据库连接 URL</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.56.112:3307/hmily?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">    <span class="comment"># 数据库用户名</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="comment"># 数据库密码</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">"123456"</span></span><br><span class="line">    <span class="comment"># 连接池最大连接数</span></span><br><span class="line">    <span class="attr">maxActive:</span> <span class="number">20</span></span><br><span class="line">    <span class="comment"># 连接池最小空闲连接数</span></span><br><span class="line">    <span class="attr">minIdle:</span> <span class="number">10</span></span><br><span class="line">    <span class="comment"># 获取连接超时时间（毫秒）</span></span><br><span class="line">    <span class="attr">connectionTimeout:</span> <span class="number">30000</span></span><br><span class="line">    <span class="comment"># 连接空闲超时时间（毫秒）</span></span><br><span class="line">    <span class="attr">idleTimeout:</span> <span class="number">600000</span></span><br><span class="line">    <span class="comment"># 连接最大生命周期（毫秒）</span></span><br><span class="line">    <span class="attr">maxLifetime:</span> <span class="number">1800000</span></span><br></pre></td></tr></tbody></table></figure><h6 id="模块代码-1"><a href="#模块代码-1" class="headerlink" title="模块代码"></a>模块代码</h6><ul><li>实体类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 账户信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Account</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 账户余额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal balance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">getBalance</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> balance;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBalance</span><span class="params">(BigDecimal balance)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.balance = balance;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Mapper 类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountMapper</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按增量更新账户余额，并发环境下可避免「丢失更新」问题</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id    账户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delta 余额变动值（正数：增加余额；负数：减少余额）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 影响行数（1：成功；0：账户不存在或更新条件不满足）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">updateBalance</span><span class="params">(<span class="meta">@Param("id")</span> Long id, <span class="meta">@Param("delta")</span> BigDecimal delta)</span></span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Service 接口</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 尝试更新账户余额</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id    账户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delta 余额变动值（正数：增加余额；负数：减少余额）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">tryUpdateBalance</span><span class="params">(Long id, BigDecimal delta)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 确认更新账户余额</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id    账户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delta 余额变动值（正数：增加余额；负数：减少余额）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">confirmUpdateBalance</span><span class="params">(Long id, BigDecimal delta)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取消更新账户余额</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id    账户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delta 余额变动值（正数：增加余额；负数：减少余额）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">cancelUpdateBalance</span><span class="params">(Long id, BigDecimal delta)</span></span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Service 实现类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.distributed.transaction.mapper.AccountMapper;</span><br><span class="line"><span class="keyword">import</span> com.distributed.transaction.service.AccountService;</span><br><span class="line"><span class="keyword">import</span> org.dromara.hmily.annotation.HmilyTCC;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title">AccountService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AccountMapper accountMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加 <span class="doctag">@HmilyTCC</span> 注解 &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 注解 <span class="doctag">@HmilyTCC</span> 必须指定 confirmMethod 和 cancelMethod 参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@HmilyTCC(confirmMethod = "confirmUpdateBalance", cancelMethod = "cancelUpdateBalance")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryUpdateBalance</span><span class="params">(Long id, BigDecimal delta)</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"入账 开始"</span>);</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">confirmUpdateBalance</span><span class="params">(Long id, BigDecimal delta)</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"入账 确认"</span>);</span><br><span class="line">        accountMapper.updateBalance(id, delta);</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancelUpdateBalance</span><span class="params">(Long id, BigDecimal delta)</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"入账 取消"</span>);</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Controller 类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.distributed.transaction.service.AccountService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 账户控制器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AccountService accountService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转账操作</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id         账户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transMoney 转账金额（正数）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 成功，false 失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping("/account/{id}/{transMoney}")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">transfer</span><span class="params">(<span class="meta">@PathVariable("id")</span> Long id, <span class="meta">@PathVariable("transMoney")</span> BigDecimal transMoney)</span> </span>{</span><br><span class="line">        <span class="comment">// 调用本地的 try 方法（TCC 的三大方法之一）</span></span><br><span class="line">        <span class="keyword">return</span> accountService.tryUpdateBalance(id, transMoney);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>SpringBoot 主启动类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan("com.distributed.transaction.mapper")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MoneyToApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        SpringApplication.run(MoneyToApplication.class);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="代码测试"><a href="#代码测试" class="headerlink" title="代码测试"></a>代码测试</h4><h5 id="正常调用测试"><a href="#正常调用测试" class="headerlink" title="正常调用测试"></a>正常调用测试</h5><ul><li>(1) 依次启动 <code>eureka-server</code>、<code>fencai-hmily-money-from</code>、<code>fencai-hmily-money-to</code> 应用</li><li> (2) 通过浏览器调用扣钱接口：<code>http://127.0.0.1:9091/account/1/5/2</code></li><li>(3) 可以发现各个应用会打印以下日志信息：<ul><li><code>fencai-hmily-money-from</code> 应用<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">出账 开始</span><br><span class="line">出账 确认</span><br></pre></td></tr></tbody></table></figure></li><li><code>fencai-hmily-money-to</code> 应用<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">入账 开始</span><br><span class="line">入账 确认</span><br></pre></td></tr></tbody></table></figure></li></ul></li><li>(4) 最后观察数据库的数据是否有发生变化，如果数据有发生变化，则说明 Hmily 正常运行<ul><li> 数据库表 <code>account_from.t_account</code>：账户余额减少了 5 元</li><li> 数据库表 <code>account_to.t_account</code>：账户余额增加了 5 元</li></ul></li></ul><h5 id="异常调用测试"><a href="#异常调用测试" class="headerlink" title="异常调用测试"></a>异常调用测试</h5><ul><li>(1) 更改 <code>fencai-hmily-money-from</code> 模块中的 Try 方法，故意抛出运行时异常，验证 Cancel 方法是否会被执行（回滚操作）<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加 <span class="doctag">@HmilyTCC</span> 注解 &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 注解 <span class="doctag">@HmilyTCC</span> 必须指定 confirmMethod 和 cancelMethod 参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@HmilyTCC(confirmMethod = "confirmUpdateBalance", cancelMethod = "cancelUpdateBalance")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryUpdateBalance</span><span class="params">(Long fromId, BigDecimal delta, Long toId)</span> </span>{</span><br><span class="line">    System.out.println(<span class="string">"出账 开始"</span>);</span><br><span class="line">    <span class="comment">// 扣钱</span></span><br><span class="line">    accountMapper.updateBalance(fromId, delta);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过 Feign 远程调用加钱服务的 try 方法（TCC 的三大方法之一）</span></span><br><span class="line">    accountClient.transfer(toId, delta.negate());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 故意抛出运行时异常，验证 Cancel 方法是否会被执行（回滚操作）</span></span><br><span class="line">    <span class="keyword">int</span> num = <span class="number">10</span> / <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> Boolean.TRUE;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li><li>(2) 依次启动 <code>eureka-server</code>、<code>fencai-hmily-money-from</code>、<code>fencai-hmily-money-to</code> 应用</li><li> (3) 通过浏览器调用扣钱接口：<code>http://127.0.0.1:9091/account/1/5/2</code></li><li>(4) 可以发现各个应用会打印以下日志信息：<ul><li><code>fencai-hmily-money-from</code> 应用<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">出账 开始</span><br><span class="line">出账 取消</span><br></pre></td></tr></tbody></table></figure></li><li><code>fencai-hmily-money-to</code> 应用<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">入账 开始</span><br><span class="line">入账 取消</span><br></pre></td></tr></tbody></table></figure></li></ul></li><li>(5) 最后观察数据库的数据是否没有发生变化，如果数据没有发生变化，则说明 Hmily 正常运行<ul><li> 数据库表 <code>account_from.t_account</code>：账户余额保持不变</li><li> 数据库表 <code>account_to.t_account</code>：账户余额保持不变</li></ul></li></ul><h4 id="代码下载"><a href="#代码下载" class="headerlink" title="代码下载"></a>代码下载</h4><p>本节完整的案例代码可以直接从 <a target="_blank" rel="external nofollow" href="https://github.com/rqh656418510/spring-cloud-share/tree/main/distributed-database/distributed-transaction-study">GitHub</a> 下载对应章节 <code>distributed-transaction-01</code>。</p><h2 id="参考资料-1"><a href="#参考资料-1" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a target="_blank" rel="external nofollow" href="https://cloud.tencent.com/developer/article/2082639">分布式事务解决方案之 TCC（Hmily）</a></li><li><a target="_blank" rel="external nofollow" href="https://juejin.cn/post/7433042711203545126">SpringBoot 整合 Hmily 实现 TCC 分布式事务</a></li><li><a target="_blank" rel="external nofollow" href="https://cloud.tencent.com/developer/article/2089364">分布式事务 TCC 框架 - Hmily（Spring Cloud Feign）</a></li></ul><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/3e028f15.html" title="基于 Hmily 实战 TCC 分布式事务之二">https://www.techgrow.cn/posts/3e028f15.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="fa fa-tag"></i> 微服务</a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag"><i class="fa fa-tag"></i> 数据库</a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag"><i class="fa fa-tag"></i> 分布式</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/1625c614.html" rel="prev" title="基于 Hmily 实战 TCC 分布式事务之一"><i class="fa fa-angle-left"></i> 基于 Hmily 实战 TCC 分布式事务之一</a></div><div class="post-nav-item"> <a href="/posts/e2246230.html" rel="next" title="Knife4j 基础使用教程">Knife4j 基础使用教程<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2026</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">2.4m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">35:40</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"/lib/mathjax/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/js/third-party/math/mathjax.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/3e028f15.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div><div id="moon-menu-item-code" class="moon-menu-item"><i class="fa-solid fa-code"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>