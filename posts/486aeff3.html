<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.17.0","exturl":false,"sidebar":{"position":"left","width":300,"display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍如何在 Centos7 系统搭建 RabbitMQ 集群，内容超级详细。"><meta property="og:type" content="article"><meta property="og:title" content="Centos7 搭建 RabbitMQ 集群（超详细）"><meta property="og:url" content="https://www.techgrow.cn/posts/486aeff3.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍如何在 Centos7 系统搭建 RabbitMQ 集群，内容超级详细。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/03/rabbitmq-cluster-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/03/rabbitmq-cluster-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/03/rabbitmq-cluster-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/03/rabbitmq-cluster-4.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/03/rabbitmq-cluster-5.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/03/rabbitmq-cluster-6.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/03/rabbitmq-cluster-7.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/03/rabbitmq-cluster-8.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/03/rabbitmq-cluster-9.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/03/rabbitmq-cluster-10.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/03/rabbitmq-cluster-11.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/03/rabbitmq-cluster-12.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/03/rabbitmq-cluster-13.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/03/rabbitmq-cluster-14.png"><meta property="article:published_time" content="2019-06-16T14:34:42.000Z"><meta property="article:modified_time" content="2019-06-16T14:34:42.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="Centos"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2021/03/rabbitmq-cluster-1.png"><link rel="canonical" href="https://www.techgrow.cn/posts/486aeff3.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/486aeff3.html","path":"posts/486aeff3.html","title":"Centos7 搭建 RabbitMQ 集群（超详细）"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Centos7 搭建 RabbitMQ 集群（超详细） | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn:9360"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/app/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn:9360/ui/login?lng=zh-cn" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F"><span class="nav-text">集群模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-text">集群节点的区别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-text">准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92"><span class="nav-text">集群规划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">系统初始化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E5%92%8C%E7%94%A8%E6%88%B7%E7%BB%84"><span class="nav-text">创建用户和用户组</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RabbitMQ-%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85"><span class="nav-text">RabbitMQ 集群安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Erlang-%E5%AE%89%E8%A3%85"><span class="nav-text">Erlang 安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RabbitMQ-%E5%AE%89%E8%A3%85"><span class="nav-text">RabbitMQ 安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RabbitMQ-%E9%85%8D%E7%BD%AE"><span class="nav-text">RabbitMQ 配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RabbitMQ-%E6%99%AE%E9%80%9A%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="nav-text">RabbitMQ 普通集群搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E8%8A%82%E7%82%B9%E4%B8%BB%E6%9C%BA%E5%90%8D"><span class="nav-text">添加节点主机名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E8%8A%82%E7%82%B9%E7%9A%84%E5%90%8D%E7%A7%B0"><span class="nav-text">配置节点的名称</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8B%B7%E8%B4%9D-Erlang-Cookie"><span class="nav-text">拷贝 Erlang Cookie</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9"><span class="nav-text">构建集群节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9"><span class="nav-text">测试集群节点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RabbitMQ-%E9%95%9C%E5%83%8F%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="nav-text">RabbitMQ 镜像集群搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%AD%96%E7%95%A5"><span class="nav-text">创建策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E9%98%9F%E5%88%97"><span class="nav-text">创建队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%B6%88%E6%81%AF"><span class="nav-text">创建消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7"><span class="nav-text">验证高可用性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FAQ"><span class="nav-text">FAQ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#erlang-cookie-%E8%A7%A3%E6%83%91"><span class="nav-text">.erlang.cookie 解惑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E6%96%B0%E5%B0%86%E8%8A%82%E7%82%B9%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4"><span class="nav-text">重新将节点加入集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RabbitMQ-%E6%9B%B4%E6%94%B9%E9%BB%98%E8%AE%A4%E7%AB%AF%E5%8F%A3"><span class="nav-text">RabbitMQ 更改默认端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RabbitMQ-%E9%9B%86%E7%BE%A4%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF%E5%8A%A8-%E6%96%B9%E6%A1%88%E4%B8%80"><span class="nav-text">RabbitMQ 集群开机自启动 - 方案一</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RabbitMQ-%E9%9B%86%E7%BE%A4%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF%E5%8A%A8-%E6%96%B9%E6%A1%88%E4%BA%8C"><span class="nav-text">RabbitMQ 集群开机自启动-方案二</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RabbitMQ-%E6%97%A0%E6%B3%95%E6%93%8D%E4%BD%9C%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9"><span class="nav-text">RabbitMQ 无法操作集群节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RabbitMQ-%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%A6%82%E8%BF%B0"><span class="nav-text">RabbitMQ 集群配置文件概述</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E5%8D%9A%E5%AE%A2"><span class="nav-text">参考博客</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">443</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">44</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/486aeff3.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java、前端、移动端、微服务、分布式系统、数据库、系统架构、人工智能、大数据、云计算、物联网、虚拟化学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Centos7 搭建 RabbitMQ 集群（超详细） | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍如何在 Centos7 系统搭建 RabbitMQ 集群，内容超级详细。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Centos7 搭建 RabbitMQ 集群（超详细）</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-06-16 22:34:42" itemprop="dateCreated datePublished" datetime="2019-06-16T22:34:42+08:00">2019-06-16</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/486aeff3.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/486aeff3.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>6.2k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>6 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="集群模式"><a href="#集群模式" class="headerlink" title="集群模式"></a>集群模式</h3><p>RabbitMQ 是用 Erang 开发的，集群模式分为两种<code>普通模式</code> 和<code>镜像模式</code>，可以说<code>镜像模式</code>是<code>普通模式</code>的升级版，其中 RabbitMQ 默认使用的是 <code>普通模式</code>。</p><ul><li><p>普通模式：<br>以两个节点（rabbit01、rabbit02）为例来进行说明，rabbit01 和 rabbit02 两个节点仅有相同的元数据，即队列的结构，但消息实体只存在于其中一个节点 rabbit01（或者 rabbit02）中。当消息进入 rabbit01 节点的 Queue 后，consumer 从 rabbit02 节点消费时，RabbitMQ 会临时在 rabbit01、rabbit02 间进行消息传输，把 A 中的消息实体取出并经过 B 发送给 consumer。所以 consumer 应尽量连接每一个节点，从中取消息。即对于同一个逻辑队列，要在多个节点建立物理 Queue。否则无论 consumer 连 rabbit01 或 rabbit02，出口总在 rabbit01，会产生瓶颈。当 rabbit01 节点故障后，rabbit02 节点无法取到 rabbit01 节点中还未消费的消息实体。如果做了消息持久化，那么得等 rabbit01 节点恢复，然后才可被消费；如果没有持久化的话，就会产生消息丢失的现象。</p></li><li><p>镜像模式：<br>在普通模式的基础上，把需要的队列做成镜像队列，存在于多个节点，消息实体会主动在镜像节点间同步，而不是在客户端取数据时临时拉取，也就是说多少节点消息就会备份多少份。该模式带来的副作用也很明显，除了降低系统性能外，如果镜像队列数量过多，加之大量的消息进入，集群内部的网络带宽将会被这种同步通讯大大消耗掉，所以在对业务可靠性要求较高的场合中适用。由于镜像队列之间消息自动同步，且内部有选举 Master 机制，即使 Master 节点宕机也不会影响整个集群的使用，达到去中心化的目的，从而有效的防止消息丢失及服务不可用等问题</p></li></ul><h3 id="集群节点的区别"><a href="#集群节点的区别" class="headerlink" title="集群节点的区别"></a>集群节点的区别</h3><p>RabbitMQ 的集群节点分为磁盘节点、内存节点。RabbitMQ 支持消息的持久化，也就是数据写在磁盘上。在 RabbitMQ 集群中，必须至少有一个磁盘节点，否则队列元数据无法写入到集群中。当磁盘节点宕掉时，集群将无法写入新的队列元数据信息。如果 RabbitMQ 集群全部宕机，必须先启动磁盘节点，然后再启动内存节点。最合适的方案就是既有磁盘节点，又有内存节点，推荐 1 个 磁盘节点 + 2 个内存节点的集群搭建方式。</p><span id="more"></span><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="集群规划"><a href="#集群规划" class="headerlink" title="集群规划"></a>集群规划</h3><table><thead><tr><th>名称</th><th> IP</th><th> 端口</th><th>用途</th><th> RabbitMQ 节点名称</th></tr></thead><tbody><tr><td>节点一</td><td> 192.168.1.109</td><td>15672</td><td> 磁盘节点</td><td> rabbit@rabbitmq1</td></tr><tr><td> 节点二</td><td> 192.168.1.201</td><td>15672</td><td> 内存节点</td><td> rabbit@rabbitmq2</td></tr><tr><td> 节点三</td><td> 192.168.1.200</td><td>15672</td><td> 内存节点</td><td> rabbit@rabbitmq3</td></tr></tbody></table><p>注意，在生产环境搭建 RabbitMQ 集群时，所有集群节点要求都可以连接上互联网，另外 RabbitMQ 集群节点建议都在同一网段里，如果是跨广域网（外网），效果会变差。</p><h3 id="系统初始化"><a href="#系统初始化" class="headerlink" title="系统初始化"></a>系统初始化</h3><ul><li><a href="/posts/88a10b.html">更改系统的最大打开文件描述符数</a></li></ul><h3 id="创建用户和用户组"><a href="#创建用户和用户组" class="headerlink" title="创建用户和用户组"></a>创建用户和用户组</h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建rabbitmq用户组</span></span><br><span class="line"><span class="keyword"># groupadd</span> rabbitmq</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建rabbitmq用户（不允许远程登录）</span></span><br><span class="line"><span class="keyword"># useradd</span><span class="params"> -g</span> rabbitmq rabbitmq<span class="params"> -s</span> /bin/<span class="literal">false</span></span><br></pre></td></tr></tbody></table></figure><h2 id="RabbitMQ-集群安装"><a href="#RabbitMQ-集群安装" class="headerlink" title="RabbitMQ 集群安装"></a>RabbitMQ 集群安装</h2><h3 id="Erlang-安装"><a href="#Erlang-安装" class="headerlink" title="Erlang 安装"></a>Erlang 安装</h3><p>在每个集群节点上分别编译安装 Erlang，这里使用的版本是 <code>23.2</code>，其他版本的 Erlang 可以从 <a target="_blank" rel="external nofollow" href="https://www.erlang.org/downloads">Erlang 官网</a> 下载</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line"><span class="keyword"># yum</span> install<span class="params"> -y</span> make autoconf gcc gcc-c++ glibc-devel kernel-devel m4 ncurses-devel openssl-devel unixODBC unixODBC-devel libtool libtool-ltdl-devel unzip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建安装目录</span></span><br><span class="line"><span class="keyword"># mkdir</span><span class="params"> -p</span> /usr/<span class="built_in">local</span>/erlang-23.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载</span></span><br><span class="line"><span class="keyword"># wget</span> https://erlang.org/download/otp_src_23.2.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line"><span class="keyword"># tar</span><span class="params"> -xvf</span> otp_src_23.2.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入解压目录</span></span><br><span class="line"><span class="keyword"># cd</span> otp_src_23.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置</span></span><br><span class="line"><span class="comment"># ./otp_build autoconf</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/erlang-23.2 --without-javac</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译安装</span></span><br><span class="line"><span class="keyword"># make</span> &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建软链接</span></span><br><span class="line"><span class="keyword"># ln</span><span class="params"> -sf</span> /usr/<span class="built_in">local</span>/erlang-23.2/bin/erl /usr/bin/erl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置环境变量</span></span><br><span class="line"><span class="keyword"># vim</span> /etc/profile</span><br><span class="line"><span class="built_in">export</span> ERLANG_HOME=/usr/<span class="built_in">local</span>/erlang-23.2</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$ERLANG_HOME</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使环境变量生效</span></span><br><span class="line"><span class="keyword"># source</span> /etc/profile</span><br></pre></td></tr></tbody></table></figure><h3 id="RabbitMQ-安装"><a href="#RabbitMQ-安装" class="headerlink" title="RabbitMQ 安装"></a>RabbitMQ 安装</h3><p>在每个集群节点上分别使用二进制包的方式安装 RabbitMQ，使用的版本是 <code>3.8.6</code>，其他版本的 RabbitMQ 可以从 <a target="_blank" rel="external nofollow" href="https://github.com/rabbitmq/rabbitmq-server/releases">RabbitMQ Github</a> 下载</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line"><span class="keyword"># yum</span> install<span class="params"> -y</span> xmlto python-simplejson</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载</span></span><br><span class="line"><span class="keyword"># wget</span> https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.8.6/rabbitmq-server-generic-unix-3.8.6.tar.xz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line"><span class="keyword"># xz</span><span class="params"> -d</span> rabbitmq-server-generic-unix-3.8.6.tar.xz</span><br><span class="line"><span class="keyword"># tar</span><span class="params"> -xvf</span> rabbitmq-server-generic-unix-3.8.6.tar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝安装文件</span></span><br><span class="line"><span class="keyword"># cp</span><span class="params"> -r</span> rabbitmq_server-3.8.6 /usr/<span class="built_in">local</span>/rabbitmq</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件授权</span></span><br><span class="line"><span class="keyword"># chown</span><span class="params"> -R</span> rabbitmq:rabbitmq /usr/<span class="built_in">local</span>/rabbitmq</span><br></pre></td></tr></tbody></table></figure><h3 id="RabbitMQ-配置"><a href="#RabbitMQ-配置" class="headerlink" title="RabbitMQ 配置"></a>RabbitMQ 配置</h3><p>在每个集群节点上分别配置 RabbitMQ，包括创建默认的日志目录与数据目录、启用 Web 控制台管理插件</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建默认的日志目录与数据目录</span></span><br><span class="line"><span class="keyword"># mkdir</span><span class="params"> -p</span> /usr/<span class="built_in">local</span>/rabbitmq/var/<span class="built_in">log</span>/rabbitmq</span><br><span class="line"><span class="keyword"># mkdir</span><span class="params"> -p</span> /usr/<span class="built_in">local</span>/rabbitmq/var/lib/rabbitmq/mnesia</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建默认的配置文件</span></span><br><span class="line"><span class="keyword"># touch</span> /usr/<span class="built_in">local</span>/rabbitmq/etc/rabbitmq/rabbitmq.config</span><br><span class="line"><span class="keyword"># echo</span> <span class="string">"[]."</span> &gt; /usr/<span class="built_in">local</span>/rabbitmq/etc/rabbitmq/rabbitmq.config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建默认的环境变量文件</span></span><br><span class="line"><span class="keyword"># touch</span> /usr/<span class="built_in">local</span>/rabbitmq/etc/rabbitmq/rabbitmq-env.conf</span><br><span class="line"><span class="keyword"># echo</span> <span class="string">"CONF_ENV_FILE=/usr/local/rabbitmq/etc/rabbitmq/rabbitmq-env.conf"</span> &gt;&gt; /usr/<span class="built_in">local</span>/rabbitmq/sbin/rabbitmq-defaults</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用Web控制台管理插件</span></span><br><span class="line"><span class="keyword"># cd</span> /usr/<span class="built_in">local</span>/rabbitmq/sbin</span><br><span class="line"><span class="comment"># ./rabbitmq-plugins enable rabbitmq_management</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有插件的安装信息</span></span><br><span class="line"><span class="comment"># ./rabbitmq-plugins list</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件授权</span></span><br><span class="line"><span class="keyword"># chown</span><span class="params"> -R</span> rabbitmq:rabbitmq /usr/<span class="built_in">local</span>/rabbitmq</span><br></pre></td></tr></tbody></table></figure><p>在每个集群节点上分别配置 RabbitMQ，包括创建虚拟主机、超级管理员用户、设置角色权限。由于出于系统安全考虑，RabbitMQ 默认限制了 <code>guest</code> 用户只能通过 <code>localhost</code> 登录使用，因此需要手动创建管理员帐号，并更改 <code>guest</code> 用户默认的密码</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入安装目录</span></span><br><span class="line"><span class="keyword"># cd</span> /usr/<span class="built_in">local</span>/rabbitmq/sbin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 前台启动RabbitMQ服务（默认会打印出日志文件和配置文件的路径）</span></span><br><span class="line"><span class="comment"># ./rabbitmq-server</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者后台启动RabbitMQ服务</span></span><br><span class="line"><span class="comment"># ./rabbitmq-server -detached</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建虚拟主机（相当于MySQL的数据库概念）</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl add_vhost /</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更改guest用户默认的密码</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl change_password guest yourPassword</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建超级管理员用户</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl add_user admin yourPassword</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 赋予administrator角色给超级管理员用户</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl set_user_tags admin administrator</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 赋予超级管理员用户权限</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl set_permissions -p / admin '.*' '.*' '.*'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 彻底关闭后台启动的RabbitMQ服务</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl stop</span></span><br></pre></td></tr></tbody></table></figure><h2 id="RabbitMQ-普通集群搭建"><a href="#RabbitMQ-普通集群搭建" class="headerlink" title="RabbitMQ 普通集群搭建"></a>RabbitMQ 普通集群搭建</h2><h3 id="添加节点主机名"><a href="#添加节点主机名" class="headerlink" title="添加节点主机名"></a>添加节点主机名</h3><p>在每个集群节点上分别编辑 <code>/etc/hosts</code> 配置文件，指定各个节点的主机名</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword"># vim</span> /etc/hosts</span><br><span class="line">192.168.1.109 rabbitmq1</span><br><span class="line">192.168.1.201 rabbitmq2</span><br><span class="line">192.168.1.200 rabbitmq3</span><br></pre></td></tr></tbody></table></figure><h3 id="配置节点的名称"><a href="#配置节点的名称" class="headerlink" title="配置节点的名称"></a>配置节点的名称</h3><p>RabbitMQ 节点由节点名称（RABBITMQ_NODENAME）标识，节点名称由两部分组成，前缀（默认是 <code>rabbit</code>）和主机名，例如：<code>rabbit@rabbit1</code> 是一个包含前缀 <code>rabbit</code> 和主机名 <code>rabbit1</code> 的节点名称。可以在同一台主机上运行多个 RabbitMQ 节点，但集群中每个节点必须有一个唯一的 RABBITMQ_NODENAME。<strong>若在同一台主机上运行多个节点（开发和 QA 环境中通常是这种情况），每个节点还必须使用不同的前缀，例如：<code>rabbit1@hostname1</code> 和 <code>rabbit2@hostname2</code>。</strong>在集群中，节点使用节点名称标识和联系彼此，这意味着必须解析每个节点名的主机名部分。当节点启动时，它会检查是否已为其分配了节点名，这是通过配置文件 <code>rabbitmq-env.conf</code> 里的 <code>RABBITMQ_NODENAME</code> 环境变量指定，如果环境变量没有配置，则节点将解析其主机名并在其前面添加 <code>rabbit</code> 来计算其节点名。</p><hr><p>在每个集群节点上分别配置节点名称，只需将下面 <code>rabbit@xxx</code> 中的 <code>xxx</code> 替换为该节点的主机名即可，例如节点一的节点名称为： <code>rabbit@rabbitmq1</code></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置节点名称</span></span><br><span class="line"><span class="keyword"># echo</span> <span class="string">"NODENAME=rabbit@xxx"</span> &gt;&gt; /usr/<span class="built_in">local</span>/rabbitmq/etc/rabbitmq/rabbitmq-env.conf</span><br></pre></td></tr></tbody></table></figure><h3 id="拷贝-Erlang-Cookie"><a href="#拷贝-Erlang-Cookie" class="headerlink" title="拷贝 Erlang Cookie"></a>拷贝 Erlang Cookie</h3><p>RabbitMQ 的集群是依附于 Erlang 的集群来工作的，所以必须先构建起 Erlang 的集群。Erlang 的集群中各节点是经由过程一个 cookie 来实现的，当使用解压缩的方式来安装 RabbitMQ 时，那么这个 cookie 存放在 <code>${home}/.erlang.cookie</code> 中，文件是 400 的权限。必须保证集群各节点的 cookie 一致，不然节点之间就无法通信。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拷贝节点一的Cookie到其他节点</span></span><br><span class="line"><span class="keyword"># scp</span> /root/.erlang.cookie root@rabbitmq2:/root/</span><br><span class="line"><span class="keyword"># scp</span> /root/.erlang.cookie root@rabbitmq3:/root/</span><br></pre></td></tr></tbody></table></figure><h3 id="构建集群节点"><a href="#构建集群节点" class="headerlink" title="构建集群节点"></a>构建集群节点</h3><p>在每个集群节点上分别启动 RabbitMQ 的服务，这里默认使用的用户为 <code>root</code>。<strong>当使用解压缩的方式来安装 RabbitMQ 时，cookie 是存放在 <code>${home}/.erlang.cookie</code>，因此这里必须注意各个节点的 RabbitMQ 是使用哪个用户启动，否则后续很可能由于各节点的 <code>.erlang.cookie</code> 不一致而导致节点无法加入集群。</strong></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入安装目录</span></span><br><span class="line"><span class="keyword"># cd</span> /usr/<span class="built_in">local</span>/rabbitmq/sbin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后台启动RabbitMQ服务</span></span><br><span class="line"><span class="comment"># ./rabbitmq-server -detached</span></span><br></pre></td></tr></tbody></table></figure><p>在节点二执行以下操作，将节点二（<code>rabbit@rabbitmq2</code>）加入到 RabbitMQ 集群</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入节点二的安装目录</span></span><br><span class="line"><span class="keyword"># cd</span> /usr/<span class="built_in">local</span>/rabbitmq/sbin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止节点二的RabbitMQ的服务</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl -n rabbit@rabbitmq2 stop_app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将节点二加入到集群中，"--ram" 表示节点二为内存节点</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl -n rabbit@rabbitmq2 join_cluster rabbit@rabbitmq1 --ram</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动节点二的RabbitMQ服务</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl -n rabbit@rabbitmq2 start_app</span></span><br></pre></td></tr></tbody></table></figure><p>在节点三执行以下操作，将节点三（<code>rabbit@rabbitmq3</code>）加入到 RabbitMQ 集群</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入节点三的安装目录</span></span><br><span class="line"><span class="keyword"># cd</span> /usr/<span class="built_in">local</span>/rabbitmq/sbin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止节点三的RabbitMQ的服务</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl -n rabbit@rabbitmq3 stop_app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将节点三加入到集群中，"--ram" 表示节点三为内存节点</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl -n rabbit@rabbitmq3 join_cluster rabbit@rabbitmq1 --ram</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动节点三的RabbitMQ的服务</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl -n rabbit@rabbitmq3 start_app</span></span><br></pre></td></tr></tbody></table></figure><p>在任意节点上查看集群的状态</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入安装目录</span></span><br><span class="line"><span class="keyword"># cd</span> /usr/<span class="built_in">local</span>/rabbitmq/sbin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群状态</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl cluster_status</span></span><br></pre></td></tr></tbody></table></figure><blockquote><ul><li>搭建集群时，停止 RabbitMQ 服务必须使用 <code>stop_app</code> 命令，而不是 <code>stop</code> 命令，否则无法将节点加入到集群中</li><li>默认情况下，RabbitMQ 启动后是磁盘节点，在上面的 <code>join_cluster</code> 命令下，<code>rabbitmq2</code> 和 <code>rabbitmq3</code> 是内存节点，<code>rabbitmq1</code> 是磁盘节点</li><li>若要使 <code>rabbitmq2</code> 和 <code>rabbitmq3</code> 都成为磁盘节点，去掉 <code>--ram</code> 参数即可，或者使用 <code>--disc</code> 参数替代</li><li>如果想要更改节点类型，可以使用命令 <code>rabbitmqctl change_cluster_node_type disc(ram)</code>，前提是必须停掉 RabbitMQ 服务</li></ul></blockquote><h3 id="测试集群节点"><a href="#测试集群节点" class="headerlink" title="测试集群节点"></a>测试集群节点</h3><p>若集群节点构建成功，通过浏览器访问任意节点的 Web 控制台，例如 <code>http://192.168.1.109:15672</code>，会看到如下的内容。最后可以在节点一创建队列 <code>test</code>，如果在节点二、节点三的 Web 控制台，也可以看到对应的 <code>test</code> 队列，则说明各集群节点的元数据（队列的结构）同步正常。至此，RabbitMQ 的普通集群搭建完成。</p><p><img data-src="../../../asset/2021/03/rabbitmq-cluster-1.png" alt="rabbitmq-cluster-1"></p><h2 id="RabbitMQ-镜像集群搭建"><a href="#RabbitMQ-镜像集群搭建" class="headerlink" title="RabbitMQ 镜像集群搭建"></a>RabbitMQ 镜像集群搭建</h2><p>上面已经完成 RabbitMQ 普通集群的搭建，但并不能保证队列的高可用性，尽管交换机、队列、绑定这些可以复制到集群里的任何一个节点，但是队列内容（消息）不会复制。虽然普通集群解决可以一项目组的节点压力，但队列节点（磁盘节点）宕机会直接导致其他节点的队列（内存节点）无法使用，只能等待队列节点（磁盘节点）重启，所以要想在队列节点（磁盘节点）宕机或故障也能正常应用，就要复制队列内容（消息）到集群里的每个节点，因此必须要创建镜像队列。镜像队列是基于普通的集群模式的，然后再添加一些策略，所以还是得先配置普通集群，然后才能设置镜像队列。设置镜像队列可以在 RabbitMQ 的 Web 控制台进行，也可以通过命令，这里介绍是其中的 Web 控制台设置方式。</p><h3 id="创建策略"><a href="#创建策略" class="headerlink" title="创建策略"></a>创建策略</h3><p>在节点一的 Web 控制台上创建策略：</p><ul><li><ol><li>点击 <code>Admin</code> 菜单 –&gt; 右侧的 <code>Policies</code> 选项</li></ol></li><li><ol start="2"><li>按照图中的内容根据自己的需求填写</li></ol></li></ul><p><img data-src="../../../asset/2021/03/rabbitmq-cluster-2.png" alt="rabbitmq-cluster-2"></p><blockquote><ul><li> Name：策略名称</li><li> Pattern：匹配的规则，<code>^a</code> 表示匹配 <code>a</code> 开头的队列，如果是匹配所有的队列，那就是 <code>^.</code></li><li>Definition：使用 <code>ha-mode</code> 模式中的 <code>all</code>，也就是同步所有匹配的队列</li></ul></blockquote><ul><li><ol start="3"><li>点击左侧最下边的 <code>Add/update a policy</code> 按钮新增策略</li></ol></li></ul><p><img data-src="../../../asset/2021/03/rabbitmq-cluster-3.png" alt="rabbitmq-cluster-3"></p><ul><li><ol start="4"><li>此时分别登录节点二、节点三的 Web 控制台，同样可以看到刚添加的这个策略</li></ol></li></ul><p><img data-src="../../../asset/2021/03/rabbitmq-cluster-4.png" alt="rabbitmq-cluster-4"></p><p><img data-src="../../../asset/2021/03/rabbitmq-cluster-5.png" alt="rabbitmq-cluster-5"></p><h3 id="创建队列"><a href="#创建队列" class="headerlink" title="创建队列"></a>创建队列</h3><p>在节点一的 Web 控制台上创建队列：</p><ul><li><ol><li>点击 <code>Queues</code> 菜单</li></ol></li><li><ol start="2"><li>输入 <code>Name 和</code> Arguments` 参数的值，别的参数默认即可</li></ol></li></ul><p><img data-src="../../../asset/2021/03/rabbitmq-cluster-6.png" alt="rabbitmq-cluster-6"></p><blockquote><p>Name：队列名称<br>Durability：队列是否持久化<br>Node：消息队列的节点<br>Auto delete：是否自动删除<br>Arguments：使用的策略类型</p></blockquote><ul><li><ol start="3"><li>点击左侧下边的 <code>Add a new queue</code> 按钮新增队列，将鼠标指向 <code>+2</code> 可以显示出另外两台节点</li></ol></li></ul><p><img data-src="../../../asset/2021/03/rabbitmq-cluster-7.png" alt="rabbitmq-cluster-7"></p><h3 id="创建消息"><a href="#创建消息" class="headerlink" title="创建消息"></a>创建消息</h3><ul><li><ol><li>点击 <code>ab</code> 队列按钮，拖动滚动条</li></ol></li><li><ol start="2"><li>填写相关内容</li></ol></li></ul><p><img data-src="../../../asset/2021/03/rabbitmq-cluster-8.png" alt="rabbitmq-cluster-8"></p><blockquote><p>2-Persistent：表示持久化<br>Headers：随便填写即可<br>Properties：点击问号，选择一个消息 ID 号<br>Payload：消息内容</p></blockquote><ul><li><ol start="3"><li>点击 <code>Publish message</code> 按钮新增消息，可发现 <code>ab</code> 队列的 <code>Ready</code> 和 <code>Total</code> 中多了一条消息记录</li></ol></li></ul><p><img data-src="../../../asset/2021/03/rabbitmq-cluster-9.png" alt="rabbitmq-cluster-9"></p><h3 id="验证高可用性"><a href="#验证高可用性" class="headerlink" title="验证高可用性"></a>验证高可用性</h3><ul><li><ol><li>将节点一的 RabbitMQ 服务关闭，再通过节点一和节点二，查看消息记录是否还存在，结果可以看到在其他节点的消息记录是存在的</li></ol></li></ul><p><img data-src="../../../asset/2021/03/rabbitmq-cluster-10.png" alt="rabbitmq-cluster-10"></p><p><img data-src="../../../asset/2021/03/rabbitmq-cluster-11.png" alt="rabbitmq-cluster-11"></p><ul><li><ol start="2"><li>再将节点二的 RabbitMQ 服务关闭，通过节点三查看消息记录是否还存在，结果可以看到 <code>ab</code> 队列和消息记录还是存在的，只是变成了只有一个节点</li></ol></li></ul><p><img data-src="../../../asset/2021/03/rabbitmq-cluster-12.png" alt="rabbitmq-cluster-12"></p><ul><li><ol start="3"><li>将节点一和节点二的 RabbitMQ 服务重启，从中可以看到 <code>ab</code> 队列后面 <code>+2</code> 变成了红色，鼠标指上去显示镜像无法同步</li></ol></li></ul><p><img data-src="../../../asset/2021/03/rabbitmq-cluster-13.png" alt="rabbitmq-cluster-13"></p><ul><li><ol start="4"><li>采取的解决办法是选择在节点二上执行同步命令</li></ol></li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入节点一的安装目录</span></span><br><span class="line"><span class="keyword"># cd</span> /usr/<span class="built_in">local</span>/rabbitmq/sbin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 同步特定的队列</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl sync_queue ab</span></span><br></pre></td></tr></tbody></table></figure><p><img data-src="../../../asset/2021/03/rabbitmq-cluster-14.png" alt="rabbitmq-cluster-14"></p><p>同步完成后，<code>+2</code> 标识又变成了蓝色，这样就测试了 RabbitMQ 集群的高可用性，说明镜像集群配置成功。</p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><h3 id="erlang-cookie-解惑"><a href="#erlang-cookie-解惑" class="headerlink" title=".erlang.cookie 解惑"></a>.erlang.cookie 解惑</h3><p><code>.erlang.cookie</code> 是 Erlang 实现分布式集群的必要文件，Erlang 分布式集群要求每个节点上都要有相同的 <code>.erlang.cookie</code> 文件，同时保证文件的权限是 400。在搭建 RabbitMQ 集群的时候往往会因为 <code>.erlang.cookie</code> 而报各种错误，官方在介绍集群的文档中提到过 <code>.erlang.cookie</code> 一般会存在这两个路径：第一个是 <code>${home}/.erlang.cookie</code>，第二个就是 <code>/var/lib/rabbitmq/.erlang.cookie</code>，具体说明如下：</p><ul><li>如果 RPM 等安装包方式进行安装的，那么这个文件会在 <code>/var/lib/rabbitmq</code> 目录下，完整路径为 <code>/var/lib/rabbitmq/.erlang.cookie</code></li><li>如果使用解压缩方式安装部署 RabbitMQ，那么这个文件会在 <code>${home}</code> 目录下，也就是用户的 Home 目录下，完整路径为 <code>${home}/.erlang.cookie</code></li></ul><hr><p>通过 RabbitMQ 的启动日志，可以查看其 Home 目录是哪里，就可以知道 <code>.erlang.cookie</code> 存放在哪里，以及 <code>mnesia</code> 数据库信息存在哪里</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># RPM包安装方式</span><br><span class="line">node           : rabbit@he10</span><br><span class="line">home dir       : /var/lib/rabbitmq</span><br><span class="line">config file(s) : /etc/rabbitmq/rabbitmq.config (not found)</span><br><span class="line">cookie hash    : qhOGp9TtH4Rn+BekiYXxIg==</span><br><span class="line">log            : /var/log/rabbitmq/rabbit@he07.log</span><br><span class="line">sasl log       : /var/log/rabbitmq/rabbit@he07-sasl.log</span><br><span class="line">database dir   : /var/lib/rabbitmq/mnesia/rabbit@he07</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 解压缩安装方式（这里使用Root用户启动）</span><br><span class="line">node           : rabbit@he10</span><br><span class="line">home dir       : /root</span><br><span class="line">config file(s) : /usr/local/rabbitmq/etc/rabbitmq/rabbitmq.config (not found)</span><br><span class="line">cookie hash    : 063Gh+RyPjHRzyuSPf9wWA==</span><br><span class="line">log            : /usr/local/rabbitmq/var/log/rabbitmq/rabbit@he10.log</span><br><span class="line">sasl log       : /usr/local/rabbitmq/var/log/rabbitmq/rabbit@he10-sasl.log</span><br><span class="line">database dir   : /usr/local/rabbitmq/var/lib/rabbitmq/mnesia/rabbit@he10</span><br></pre></td></tr></tbody></table></figure><h3 id="重新将节点加入集群"><a href="#重新将节点加入集群" class="headerlink" title="重新将节点加入集群"></a>重新将节点加入集群</h3><p>这里假设由于各种原因（例如断电重启、节点宕机重启），节点二无法成功加入到集群，那么可以执行以下操作来解决。<strong>特别注意，以下操作会删除节点二的元数据（虚拟机、用户、角色、权限、已持久化的消息等），因此当节点二成功加入集群后，必须重新配置节点二的虚拟机、用户、角色、权限等，否则 RabbitMQ 客户端将无法连接节点二。</strong></p><hr><p>首先在节点一里，将节点二移出集群</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入节点一的安装目录</span></span><br><span class="line"><span class="keyword"># cd</span> /usr/<span class="built_in">local</span>/rabbitmq/sbin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将节点二移出集群</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl -n rabbit@rabbitmq1 forget_cluster_node rabbit@rabbitmq2</span></span><br></pre></td></tr></tbody></table></figure><p>然后重置节点二的元数据、集群配置等信息，其中会删除虚拟机、用户、角色、权限、已持久化的消息等元数据</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入节点二的安装目录</span></span><br><span class="line"><span class="keyword"># cd</span> /usr/<span class="built_in">local</span>/rabbitmq/sbin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后台启动节点二的RabbitMQ服务</span></span><br><span class="line"><span class="comment"># ./rabbitmq-server -detached</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止节点二的RabbitMQ的服务</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl -n rabbit@rabbitmq2 stop_app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重置节点二的元数据、集群配置等信息</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl -n rabbit@rabbitmq2 reset</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新将节点二加入到集群</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl -n rabbit@rabbitmq2 join_cluster rabbit@rabbitmq1 --ram</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动节点二的RabbitMQ服务</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl -n rabbit@rabbitmq2 start_app</span></span><br></pre></td></tr></tbody></table></figure><p>如果节点二仍然无法加入集群，可以直接删除节点二的所有数据库文件，然后重启节点二的 RabbitMQ 服务，最后重新将节点二加入到集群</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入节点二的安装目录</span></span><br><span class="line"><span class="keyword"># cd</span> /usr/<span class="built_in">local</span>/rabbitmq/sbin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 彻底关闭节点二的RabbitMQ服务</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl -n rabbit@rabbitmq2 stop</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除节点二的数据文件</span></span><br><span class="line"><span class="keyword"># rm</span><span class="params"> -rf</span> /usr/<span class="built_in">local</span>/rabbitmq/var/lib/rabbitmq/mnesia/*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后台启动节点二的RabbitMQ服务</span></span><br><span class="line"><span class="comment"># ./rabbitmq-server -detached</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止节点二的RabbitMQ的服务</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl -n rabbit@rabbitmq2 stop_app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重置节点二的元数据、集群配置等信息</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl -n rabbit@rabbitmq2 reset</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新将节点二加入到集群</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl -n rabbit@rabbitmq2 join_cluster rabbit@rabbitmq1 --ram</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动节点二的RabbitMQ服务</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl -n rabbit@rabbitmq2 start_app</span></span><br></pre></td></tr></tbody></table></figure><p>强制重置节点，<code>force_reset</code> 命令和 <code>reset</code> 的区别是无条件重置节点，不管当前管理数据库状态以及集群的配置，如果数据库或者集群配置发生错误才使用这个最后的手段</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./rabbitmqctl force_reset</span></span><br></pre></td></tr></tbody></table></figure><h3 id="RabbitMQ-更改默认端口"><a href="#RabbitMQ-更改默认端口" class="headerlink" title="RabbitMQ 更改默认端口"></a>RabbitMQ 更改默认端口</h3><p>RabbitMQ 默认占用 4369、5672、15672、25672 默认端口号，更改默认端口的方法如下：</p><ul><li>更改 15672 端口，配置文件路径：<code>/usr/local/rabbitmq/etc/rabbitmq/rabbitmq.config</code></li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  {rabbitmq_management,</span><br><span class="line">      [</span><br><span class="line">        {listener,</span><br><span class="line">                [</span><br><span class="line">                   {port, 15672},</span><br><span class="line">                   {ip, "0.0.0.0"},</span><br><span class="line">                   {ssl, false}</span><br><span class="line">                ]</span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">  }</span><br><span class="line">].</span><br></pre></td></tr></tbody></table></figure><ul><li>更改 5672、25672 端口，配置文件路径：<code>/usr/local/rabbitmq/etc/rabbitmq/rabbitmq-env.conf</code></li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NODE_PORT=5673</span><br><span class="line">DIST_PORT=25673</span><br></pre></td></tr></tbody></table></figure><ul><li>更改 4369 端口，配置文件路径：<code>/etc/profile</code>，单机可以多个 RabbitMQ 节点共用同一个 <code>ERL_EPMD_PORT</code> 端口</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export ERL_EPMD_PORT=4363</span><br></pre></td></tr></tbody></table></figure><h3 id="RabbitMQ-集群开机自启动-方案一"><a href="#RabbitMQ-集群开机自启动-方案一" class="headerlink" title="RabbitMQ 集群开机自启动-方案一"></a>RabbitMQ 集群开机自启动 - 方案一</h3><p>将集群各节点的 RabbitMQ 服务托管给 Systemd 管理，这里以节点一为例子，若其他节点的端口号不相同，默认情况下只需更改服务自启动脚本中对应的端口号即可，该脚本支持单机搭建 RabbitMQ 集群。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建服务自启动脚本</span></span><br><span class="line"><span class="keyword"># touch</span> /etc/init.d/rabbitmq-cluster-15672</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更改服务自启动脚本，写入后面给出的脚本内容</span></span><br><span class="line"><span class="keyword"># vim</span> /etc/init.d/rabbitmq-cluster-15672</span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务自启动脚本授权</span></span><br><span class="line"><span class="keyword"># chmod</span> u+x /etc/init.d/rabbitmq-cluster-15672</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机自启动</span></span><br><span class="line"><span class="keyword"># chkconfig</span> rabbitmq-cluster-15672 on</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看开机自启动列表</span></span><br><span class="line"><span class="keyword"># chkconfig</span><span class="params"> --list</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭开机自启动</span></span><br><span class="line"><span class="keyword"># chkconfig</span> rabbitmq-cluster-15672 off</span><br></pre></td></tr></tbody></table></figure><p>RabbitMQ 集群各节点的服务管理</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭服务</span></span><br><span class="line"><span class="keyword"># systemctl</span> stop rabbitmq-cluster-15672</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line"><span class="keyword"># systemctl</span> start rabbitmq-cluster-15672</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看服务状态</span></span><br><span class="line"><span class="keyword"># systemctl</span> status rabbitmq-cluster-15672</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启服务</span></span><br><span class="line"><span class="keyword"># systemctl</span> restart rabbitmq-cluster-15672</span><br></pre></td></tr></tbody></table></figure><details><summary>★展开服务自启动脚本的完整内容★</summary><code><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">#</span><br><span class="line"># rabbitmq-cluster-15672 RabbitMQ broker</span><br><span class="line">#</span><br><span class="line"># chkconfig: - 80 05</span><br><span class="line"># description: Enable AMQP service provided by RabbitMQ</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">### BEGIN INIT INFO</span><br><span class="line"># Provides:          rabbitmq-cluster-15672</span><br><span class="line"># Required-Start:    $remote_fs $network</span><br><span class="line"># Required-Stop:     $remote_fs $network</span><br><span class="line"># Description:       RabbitMQ broker</span><br><span class="line"># Short-Description: Enable AMQP service provided by RabbitMQ broker</span><br><span class="line">### END INIT INFO</span><br><span class="line"></span><br><span class="line"># Source function library.</span><br><span class="line">. /etc/init.d/functions</span><br><span class="line">export HOME=/home/rabbitmq</span><br><span class="line">PATH=/sbin:/usr/sbin:/bin:/usr/bin</span><br><span class="line"></span><br><span class="line">USER=rabbitmq</span><br><span class="line">NAME=rabbitmq-server</span><br><span class="line">MQ_HOME=/usr/local/rabbitmq</span><br><span class="line">DAEMON=${MQ_HOME}/sbin/${NAME}</span><br><span class="line">CONTROL=${MQ_HOME}/sbin/rabbitmqctl</span><br><span class="line"></span><br><span class="line">ROTATE_SUFFIX=</span><br><span class="line">DESC=rabbitmq-cluster-15672</span><br><span class="line"></span><br><span class="line">MAX_OPEN_FILES=1048576</span><br><span class="line">ulimit -n $MAX_OPEN_FILES</span><br><span class="line"></span><br><span class="line">START_PROG="daemon"</span><br><span class="line">PID_FILE=/var/run/rabbitmq/pid-15672</span><br><span class="line">LOCK_FILE=/var/lock/subsys/$NAME-15672</span><br><span class="line">INIT_LOG_DIR=${MQ_HOME}/var/log/rabbitmq</span><br><span class="line"></span><br><span class="line">test -x $DAEMON || exit 0</span><br><span class="line">test -x $CONTROL || exit 0</span><br><span class="line"></span><br><span class="line">RETVAL=0</span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">[ -f /etc/default/${NAME} ] &amp;&amp; . /etc/default/${NAME}</span><br><span class="line"></span><br><span class="line">ensure_pid_dir () {</span><br><span class="line">    PID_DIR=`dirname ${PID_FILE}`</span><br><span class="line">    if [ ! -d ${PID_DIR} ] ; then</span><br><span class="line">        mkdir -p ${PID_DIR}</span><br><span class="line">        chown -R ${USER}:${USER} ${PID_DIR}</span><br><span class="line">        chmod 755 ${PID_DIR}</span><br><span class="line">    fi</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">remove_pid () {</span><br><span class="line">    rm -f ${PID_FILE}</span><br><span class="line">    rmdir `dirname ${PID_FILE}` || :</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">start_rabbitmq () {</span><br><span class="line">    status_rabbitmq quiet</span><br><span class="line">    if [ $RETVAL = 0 ] ; then</span><br><span class="line">        echo RabbitMQ is currently running</span><br><span class="line">    else</span><br><span class="line">        RETVAL=0</span><br><span class="line">        ensure_pid_dir</span><br><span class="line">        set +e</span><br><span class="line">        RABBITMQ_PID_FILE=$PID_FILE $START_PROG $DAEMON \</span><br><span class="line">            &gt; "${INIT_LOG_DIR}/startup_log" \</span><br><span class="line">            2&gt; "${INIT_LOG_DIR}/startup_err" \</span><br><span class="line">            0&lt;&amp;- &amp;</span><br><span class="line">        $CONTROL wait $PID_FILE &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">        RETVAL=$?</span><br><span class="line">        set -e</span><br><span class="line">        case "$RETVAL" in</span><br><span class="line">            0)</span><br><span class="line">                echo SUCCESS</span><br><span class="line">                if [ -n "$LOCK_FILE" ] ; then</span><br><span class="line">                    touch $LOCK_FILE</span><br><span class="line">                fi</span><br><span class="line">                ;;</span><br><span class="line">            *)</span><br><span class="line">                remove_pid</span><br><span class="line">                echo FAILED - check ${INIT_LOG_DIR}/startup_\{log, _err\}</span><br><span class="line">                RETVAL=1</span><br><span class="line">                ;;</span><br><span class="line">        esac</span><br><span class="line">    fi</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">stop_rabbitmq () {</span><br><span class="line">    status_rabbitmq quiet</span><br><span class="line">    if [ $RETVAL = 0 ] ; then</span><br><span class="line">        set +e</span><br><span class="line">        $CONTROL stop ${PID_FILE} &gt; ${INIT_LOG_DIR}/shutdown_log 2&gt; ${INIT_LOG_DIR}/shutdown_err</span><br><span class="line">        RETVAL=$?</span><br><span class="line">        set -e</span><br><span class="line">        if [ $RETVAL = 0 ] ; then</span><br><span class="line">            remove_pid</span><br><span class="line">            if [ -n "$LOCK_FILE" ] ; then</span><br><span class="line">                rm -f $LOCK_FILE</span><br><span class="line">            fi</span><br><span class="line">        else</span><br><span class="line">            echo FAILED - check ${INIT_LOG_DIR}/shutdown_log, _err</span><br><span class="line">        fi</span><br><span class="line">    else</span><br><span class="line">        echo RabbitMQ is not running</span><br><span class="line">        RETVAL=0</span><br><span class="line">    fi</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">status_rabbitmq() {</span><br><span class="line">    set +e</span><br><span class="line">    if [ "$1" != "quiet" ] ; then</span><br><span class="line">        $CONTROL status 2&gt;&amp;1</span><br><span class="line">    else</span><br><span class="line">        $CONTROL status &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">    fi</span><br><span class="line">    if [ $? != 0 ] ; then</span><br><span class="line">        RETVAL=3</span><br><span class="line">    fi</span><br><span class="line">    set -e</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">rotate_logs_rabbitmq() {</span><br><span class="line">    set +e</span><br><span class="line">    $CONTROL rotate_logs ${ROTATE_SUFFIX}</span><br><span class="line">    if [ $? != 0 ] ; then</span><br><span class="line">        RETVAL=1</span><br><span class="line">    fi</span><br><span class="line">    set -e</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">restart_running_rabbitmq () {</span><br><span class="line">    status_rabbitmq quiet</span><br><span class="line">    if [ $RETVAL = 0 ] ; then</span><br><span class="line">        restart_rabbitmq</span><br><span class="line">    else</span><br><span class="line">        echo RabbitMQ is not runnning</span><br><span class="line">        RETVAL=0</span><br><span class="line">    fi</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">restart_rabbitmq() {</span><br><span class="line">    stop_rabbitmq</span><br><span class="line">    start_rabbitmq</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">case "$1" in</span><br><span class="line">    start)</span><br><span class="line">        echo -n "Starting $DESC: "</span><br><span class="line">        start_rabbitmq</span><br><span class="line">        echo "$NAME."</span><br><span class="line">        ;;</span><br><span class="line">    stop)</span><br><span class="line">        echo -n "Stopping $DESC: "</span><br><span class="line">        stop_rabbitmq</span><br><span class="line">        echo "$NAME."</span><br><span class="line">        ;;</span><br><span class="line">    status)</span><br><span class="line">        status_rabbitmq</span><br><span class="line">        ;;</span><br><span class="line">    rotate-logs)</span><br><span class="line">        echo -n "Rotating log files for $DESC: "</span><br><span class="line">        rotate_logs_rabbitmq</span><br><span class="line">        ;;</span><br><span class="line">    force-reload|reload|restart)</span><br><span class="line">        echo -n "Restarting $DESC: "</span><br><span class="line">        restart_rabbitmq</span><br><span class="line">        echo "$NAME."</span><br><span class="line">        ;;</span><br><span class="line">    try-restart)</span><br><span class="line">        echo -n "Restarting $DESC: "</span><br><span class="line">        restart_running_rabbitmq</span><br><span class="line">        echo "$NAME."</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        echo "Usage: $0 {start|stop|status|rotate-logs|restart|condrestart|try-restart|reload|force-reload}" &gt;&amp;2</span><br><span class="line">        RETVAL=1</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">exit $RETVAL</span><br></pre></td></tr></tbody></table></figure><code></code></code></details><code><code><h3 id="RabbitMQ-集群开机自启动-方案二"><a href="#RabbitMQ-集群开机自启动-方案二" class="headerlink" title="RabbitMQ 集群开机自启动-方案二"></a>RabbitMQ 集群开机自启动-方案二</h3><p>严格来说 RabbitMQ 并不适用使用 Supervior 来管理服务，因为当手动 Kill 掉 RabbitMQ 的进程时，Supervior 无法正常重启 RabbitMQ 的进程，具体原因可以看<a target="_blank" rel="external nofollow" href="https://www.cnblogs.com/cwp-bg/p/8939792.html">这里</a>，但若只是简单实现 RabbitMQ 开机自启动，Supervior 无疑是可以胜任的。</p><hr><p>使用 Supervior 托管管理 RabbitMQ 的服务，以节点一为例给出下述配置示例，其他节点只需更改对应的端口号即可。值得一提的是，这里必须指定 <code>environment=HOME=/home/rabbitmq</code>，否则 RabbitMQ 会找不到 <code>.erlang.cookie</code> 而导致启动失败</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[program:rabbitmq]</span><br><span class="line">environment=HOME=/home/rabbitmq</span><br><span class="line">directory=/usr/local/rabbitmq</span><br><span class="line">command=/usr/local/rabbitmq/sbin/rabbitmq-server</span><br><span class="line">user=rabbitmq</span><br><span class="line">numprocs=1</span><br><span class="line">autostart=true</span><br><span class="line">autorestart=true</span><br><span class="line">startretries=10</span><br><span class="line">process_name=%(program_name)s</span><br><span class="line">stdout_logfile_backups=5</span><br><span class="line">stdout_logfile_maxbytes=10MB</span><br><span class="line">stdout_logfile=/var/log/supervisor/rabbitmq.log</span><br><span class="line">stderr_logfile_backups=5</span><br><span class="line">stderr_logfile_maxbytes=10MB</span><br><span class="line">stderr_logfile=/var/log/supervisor/rabbitmq-error.log</span><br></pre></td></tr></tbody></table></figure><p>以节点一为例通过 Supervisor 管理 RabbitMQ 服务，其他节点不再累述</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭服务</span></span><br><span class="line"><span class="keyword"># supervisorctl</span> stop rabbitmq</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line"><span class="keyword"># supervisorctl</span> start rabbitmq</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看服务状态</span></span><br><span class="line"><span class="keyword"># supervisorctl</span> status rabbitmq</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启服务</span></span><br><span class="line"><span class="keyword"># supervisorctl</span> restart rabbitmq</span><br></pre></td></tr></tbody></table></figure><h3 id="RabbitMQ-无法操作集群节点"><a href="#RabbitMQ-无法操作集群节点" class="headerlink" title="RabbitMQ 无法操作集群节点"></a>RabbitMQ 无法操作集群节点</h3><p>若执行以下命令出现下述的错误，一般是当前执行操作的用户的家目录下的 <code>.erlang.cookie</code> 与 集群节点的 <code>.erlang.cookie</code> 不一致导致。解决办法是集群节点是以哪个用户启动的，就切换到对应的用户，例如 <code>su rabbitmq</code> ，然后再执行集群操作命令。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看集群状态</span></span><br><span class="line"><span class="comment"># ./rabbitmqctl cluster_status</span></span><br></pre></td></tr></tbody></table></figure><p>执行集群状态查看命令，出现以下错误信息</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Error: unable to perform an operation on node 'rabbit2@rabbitmq2'. Please see diagnostics information and suggestions below.</span><br><span class="line"></span><br><span class="line">Most common reasons for this are:</span><br><span class="line"></span><br><span class="line"> * Target node is unreachable (e.g. due to hostname resolution, TCP connection or firewall issues)</span><br><span class="line"> * CLI tool fails to authenticate with the server (e.g. due to CLI tool's Erlang cookie not matching that of the server)</span><br><span class="line"> * Target node is not running</span><br><span class="line"></span><br><span class="line">In addition to the diagnostics info below:</span><br><span class="line"></span><br><span class="line"> * See the CLI, clustering and networking guides on https://rabbitmq.com/documentation.html to learn more</span><br><span class="line"> * Consult server logs on node rabbit2@rabbitmq2</span><br><span class="line"> * If target node is configured to use long node names, don't forget to use --longnames with CLI tools</span><br><span class="line"></span><br><span class="line">DIAGNOSTICS</span><br><span class="line">===========</span><br><span class="line"></span><br><span class="line">attempted to contact: [rabbit2@rabbitmq2]</span><br><span class="line"></span><br><span class="line">rabbit2@rabbitmq2:</span><br><span class="line">  * connected to epmd (port 4369) on rabbitmq2</span><br><span class="line">  * epmd reports node 'rabbit2' uses port 25674 for inter-node and CLI tool traffic</span><br><span class="line">  * TCP connection succeeded but Erlang distribution failed</span><br><span class="line"></span><br><span class="line">  * Authentication failed (rejected by the remote node), please check the Erlang cookie</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Current node details:</span><br><span class="line"> * node name: 'rabbitmqcli-7936-rabbit2@rabbitmq2'</span><br><span class="line"> * effective user's home directory: /home/centos</span><br><span class="line"> * Erlang cookie hash: 5hmDFFQNoU5sdfrafENxAg==</span><br></pre></td></tr></tbody></table></figure><h3 id="RabbitMQ-集群配置文件概述"><a href="#RabbitMQ-集群配置文件概述" class="headerlink" title="RabbitMQ 集群配置文件概述"></a>RabbitMQ 集群配置文件概述</h3><p>这里以节点一为例，各个配置文件的路径如下，其他节点不再累述</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">安装目录：/usr/local/rabbitmq</span><br><span class="line">日志目录：/usr/local/rabbitmq/var/log/rabbitmq</span><br><span class="line">数据目录：/usr/local/rabbitmq/var/lib/rabbitmq/mnesia</span><br><span class="line">配置文件：/usr/local/rabbitmq/etc/rabbitmq/rabbitmq.config</span><br><span class="line">环境变量配置文件：/usr/local/rabbitmq/etc/rabbitmq/rabbitmq-env.conf</span><br><span class="line">服务自启动脚本：/etc/init.d/rabbitmq-cluster-15672</span><br></pre></td></tr></tbody></table></figure><h2 id="参考博客"><a href="#参考博客" class="headerlink" title="参考博客"></a>参考博客</h2><ul><li><a target="_blank" rel="external nofollow" href="https://blog.51cto.com/11134648/2155934">RabbitMQ 集群搭建</a></li><li><a target="_blank" rel="external nofollow" href="https://my.oschina.net/genghz/blog/1840262">.erlang.cookie 解惑</a></li><li><a target="_blank" rel="external nofollow" href="https://www.rabbitmq.com/configure.html">RabbitMQ 官方配置说明</a></li><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/yaomingyang/article/details/103583024">RabbitMQ 更改默认端口</a></li><li><a target="_blank" rel="external nofollow" href="https://www.cnblogs.com/cwp-bg/p/8939792.html">Supervior 管理 RabbitMQ 服务</a></li><li><a target="_blank" rel="external nofollow" href="https://my.oschina.net/genghz/blog/1840262">RabbitMQ 使用分析和高可用集群搭建</a></li></ul></code></code><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes"})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/486aeff3.html" title="Centos7 搭建 RabbitMQ 集群（超详细）">https://www.techgrow.cn/posts/486aeff3.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/Centos/" rel="tag"><i class="fa fa-tag"></i> Centos</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/869a4db4.html" rel="prev" title="RabbitMQ 开发随笔"><i class="fa fa-chevron-left"></i> RabbitMQ 开发随笔</a></div><div class="post-nav-item"> <a href="/posts/b683a4df.html" rel="next" title="编写 DockerFile 构建 ZooKeeper 镜像">编写 DockerFile 构建 ZooKeeper 镜像<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">896k</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">13:35</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤 ICP 备 19024664 号</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035 号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-N6JtCNwaYm6kizuG92UtOOXamRHPwu+V1yF10g3bu/c="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"/lib/mermaid/dist/mermaid.min.js","integrity":"sha256-e0o3JYsdjqKajf9eOe22FhioYSz9WofRY4dLKo3F6do="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode-js.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://unpkg.com/qiniu-js@3.3.1/dist/qiniu.min.js"></script><script>
    var qiniu_domain = "https://qiniu.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/app/api/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn:9360","cssUrl":"https://unpkg.com/@waline/client@2.5.1/dist/waline.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://unpkg.com/@waline/client@2.5.1/dist/waline.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://unpkg.com/@waline/emojis@1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://qiniu.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/app/api/qiniu/token/upload","el":"#waline","comment":true,"path":"/posts/486aeff3.html"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@2.5.1/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>