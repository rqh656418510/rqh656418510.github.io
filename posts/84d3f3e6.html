<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.13.0","exturl":false,"sidebar":{"position":"left","width":300,"display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要记录 Seata 的四大事务模式，包括 AT、TCC、SAGA 和 XA 事务模式的介绍和使用。"><meta property="og:type" content="article"><meta property="og:title" content="Seata 入门教程 - 中级篇"><meta property="og:url" content="https://www.techgrow.cn/posts/84d3f3e6.html"><meta property="og:site_name" content="远方的思念"><meta property="og:description" content="本文主要记录 Seata 的四大事务模式，包括 AT、TCC、SAGA 和 XA 事务模式的介绍和使用。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-modules.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-model-at-4.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-model-at-5.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-model-at-6.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-model-at-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-model-at-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-model-at-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-tcc-model.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-saga-model.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-saga-model-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-xa-model.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-xa-model-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-xa-model-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-xa-model-4.png"><meta property="article:published_time" content="2020-12-28T13:12:19.000Z"><meta property="article:modified_time" content="2020-12-28T13:12:19.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="微服务"><meta property="article:tag" content="分布式"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2020/12/seata-modules.png"><link rel="canonical" href="https://www.techgrow.cn/posts/84d3f3e6.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/84d3f3e6.html","path":"posts/84d3f3e6.html","title":"Seata 入门教程 - 中级篇"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Seata 入门教程 - 中级篇 | 远方的思念</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn:9360"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="远方的思念" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax>!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/app/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt></div><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">远方的思念</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-openplatform"><a href="https://open.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-toolbox fa-fw"></i>开放平台</a></li><li class="menu-item menu-item-readingnotes"><a href="https://docs.techgrow.cn/notes/" rel="external nofollow" target="_blank"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn:9360/ui/login?lng=zh-cn" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81Seata-%E6%95%B4%E4%BD%93%E6%A1%86%E6%9E%B6"><span class="nav-text">1、Seata 整体框架</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1%E3%80%81Seata-%E6%A6%82%E8%BF%B0"><span class="nav-text">1.1、Seata 概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2%E3%80%81Seata-%E7%9A%84%E4%B8%89%E5%A4%A7%E6%A8%A1%E5%9D%97"><span class="nav-text">1.2、Seata 的三大模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3%E3%80%81Seata-%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-text">1.3、Seata 的执行流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81AT-%E6%A8%A1%E5%BC%8F"><span class="nav-text">2、AT 模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1%E3%80%81%E5%89%8D%E6%8F%90"><span class="nav-text">2.1、前提</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2%E3%80%81%E5%86%99%E9%9A%94%E7%A6%BB"><span class="nav-text">2.2、写隔离</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3%E3%80%81%E8%AF%BB%E9%9A%94%E7%A6%BB"><span class="nav-text">2.3、读隔离</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4%E3%80%81%E6%95%B4%E4%BD%93%E6%9C%BA%E5%88%B6"><span class="nav-text">2.4、整体机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5%E3%80%81%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF%E4%B8%8E%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-text">2.5、适用场景与优缺点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81TCC-%E6%A8%A1%E5%BC%8F"><span class="nav-text">3、TCC 模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1%E3%80%81%E6%A6%82%E8%BF%B0"><span class="nav-text">3.1、概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2%E3%80%81AT-%E4%B8%8E-TCC-%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-text">3.2、AT 与 TCC 的区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3%E3%80%81%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF%E4%B8%8E%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-text">3.3、适用场景与优缺点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81Saga-%E6%A8%A1%E5%BC%8F"><span class="nav-text">4、Saga 模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1%E3%80%81%E6%A6%82%E8%BF%B0"><span class="nav-text">4.1、概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2%E3%80%81%E6%95%B4%E4%BD%93%E6%9C%BA%E5%88%B6"><span class="nav-text">4.2、整体机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3%E3%80%81%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF%E4%B8%8E%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-text">4.3、适用场景与优缺点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5%E3%80%81XA-%E6%A8%A1%E5%BC%8F"><span class="nav-text">5、XA 模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1%E3%80%81%E5%89%8D%E6%8F%90"><span class="nav-text">5.1、前提</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2%E3%80%81%E6%95%B4%E4%BD%93%E6%9C%BA%E5%88%B6"><span class="nav-text">5.2、整体机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3%E3%80%81%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6"><span class="nav-text">5.3、工作机制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6%E3%80%81%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="nav-text">6、参考文献</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">403</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">41</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → &#x2F;sitemap.xml"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="external nofollow" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/84d3f3e6.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="远方的思念"><meta itemprop="description" content="专注于 Java、前端、移动端、微服务、分布式系统、数据库、系统架构、人工智能、大数据、云计算、物联网、虚拟化学习的技术博客。"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Seata 入门教程 - 中级篇 | 远方的思念"><meta itemprop="description" content="本文主要记录 Seata 的四大事务模式，包括 AT、TCC、SAGA 和 XA 事务模式的介绍和使用。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Seata 入门教程 - 中级篇</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-12-28 21:12:19" itemprop="dateCreated datePublished" datetime="2020-12-28T21:12:19+08:00">2020-12-28</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/84d3f3e6.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/84d3f3e6.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>5.5k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>5 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><div id="readmore-container"><h2 id="1、Seata-整体框架"><a href="#1、Seata-整体框架" class="headerlink" title="1、Seata 整体框架"></a>1、Seata 整体框架</h2><h3 id="1-1、Seata-概述"><a href="#1-1、Seata-概述" class="headerlink" title="1.1、Seata 概述"></a>1.1、Seata 概述</h3><p>Seata 是一套一站式分布式事务解决方案，为用户提供了 AT、TCC、SAGA 和 XA 事务模式，致力于提供高性能和简单易用的分布式事务服务。</p><span id="more"></span><h3 id="1-2、Seata-的三大模块"><a href="#1-2、Seata-的三大模块" class="headerlink" title="1.2、Seata 的三大模块"></a>1.2、Seata 的三大模块</h3><p>Seata 中有三大模块，分别是 TM、RM 和 TC，其中 TM 和 RM 是作为 Seata 的客户端与业务系统集成在一起，TC 作为 Seata 的服务端独立部署。</p><p><img data-src="../../../asset/2020/12/seata-modules.png" alt="seata-modules"></p><ul><li>TC：Transaction Coordinator 事务协调器，维护全局和分支事务的状态，负责协调并驱动全局事务的提交或回滚</li><li> TM：Transaction Manager 事务管理器，控制全局事务的边界，负责开启一个全局事务，并最终发起全局提交或全局回滚的决议</li><li> RM：Resource Manager 资源管理器，管理分支事务处理的资源，向 TC 注册分支事务，上报分支事务的状态，接受 TC 的命令来提交或者回滚分支事务</li></ul><h3 id="1-3、Seata-的执行流程"><a href="#1-3、Seata-的执行流程" class="headerlink" title="1.3、Seata 的执行流程"></a>1.3、Seata 的执行流程</h3><ul><li>TM 开启分布式事务（TM 向 TC 注册全局事务记录）</li><li>按业务场景，编排数据库、服务等事务内资源（RM 向 TC 汇报资源准备状态 ）</li><li>TM 结束分布式事务，事务一阶段结束（TM 通知 TC 提交 / 回滚分布式事务）</li><li>TC 汇总事务信息，决定分布式事务是提交还是回滚</li><li> TC 通知所有 RM 提交 / 回滚 资源，事务二阶段结束</li></ul><h2 id="2、AT-模式"><a href="#2、AT-模式" class="headerlink" title="2、AT 模式"></a>2、AT 模式</h2><h3 id="2-1、前提"><a href="#2-1、前提" class="headerlink" title="2.1、前提"></a>2.1、前提</h3><ul><li>Java 应用，通过 JDBC 访问数据库</li><li>基于支持本地 ACID 事务的关系型数据库</li></ul><h3 id="2-2、写隔离"><a href="#2-2、写隔离" class="headerlink" title="2.2、写隔离"></a>2.2、写隔离</h3><ul><li>一阶段本地事务提交前，需要确保先拿到全局锁</li><li>拿不到全局锁 ，不能提交本地事务</li><li>拿全局锁的尝试被限制在一定范围内，超出范围将放弃，并回滚本地事务，释放本地锁</li></ul><p><strong>举例说明：两个全局事务 tx1 和 tx2，分别对 a 表的 m 字段进行更新操作，m 的初始值 1000</strong></p><p>tx1 先开始，开启本地事务，拿到本地锁，更新操作 m = 1000 - 100 = 900。本地事务提交前，先拿到该记录的全局锁，本地提交事务释放本地锁。tx2 后开始，开启本地事务，拿到本地锁，更新操作 m = 900 - 100 = 800。tx2 本地事务提交前，尝试拿该记录的全局锁；tx1 全局提交前，该记录的全局锁被 tx1 持有，tx2 需要重试等待全局锁 。</p><p><img data-src="../../../asset/2020/12/seata-model-at-4.png" alt="seata-model-at-4"></p><p>如果 tx1 二阶段全局提交，释放全局锁，tx2 拿到全局锁后提交本地事务</p><p><img data-src="../../../asset/2020/12/seata-model-at-5.png" alt="seata-model-at-5"></p><p>如果 tx1 的二阶段全局回滚，则 tx1 需要重新获取该数据的本地锁，进行反向补偿的更新操作，实现分支事务的回滚。此时，如果 tx2 仍在等待该数据的全局锁，同时持有本地锁，则 tx1 的分支事务回滚会失败。tx1 的分支事务回滚会一直重试，直到 tx2 的全局锁等锁超时，放弃等待全局锁并回滚本地事务释放本地锁，tx1 的分支事务最终回滚成功。因为整个过程全局锁在 tx1 结束前一直是被 tx1 持有的，所以不会出现脏写的问题。</p><h3 id="2-3、读隔离"><a href="#2-3、读隔离" class="headerlink" title="2.3、读隔离"></a>2.3、读隔离</h3><p>在数据库本地事务隔离级别<code>读已提交（Read Committed）</code>或以上的基础上，Seata（AT 模式）的默认全局隔离级别是<code>读未提交（Read Uncommitted）</code>。如果应用在特定场景下，必需要求全局的<code>读已提交</code>，目前 Seata 的方式是通过 <code>SELECT FOR UPDATE</code> 语句的代理。</p><p><img data-src="../../../asset/2020/12/seata-model-at-6.png" alt="seata-model-at-6"></p><p><code>SELECT FOR UPDATE</code> 语句的执行会申请全局锁，如果全局锁被其他事务持有，则释放本地锁（回滚 <code>SELECT FOR UPDATE</code> 语句的本地执行）并重试。这个过程中，查询是被 <code>block</code> 住的，直到拿到全局锁，即读取的相关数据是已提交的才返回。出于总体性能上的考虑，Seata 目前的方案并没有对所有 <code>SELECT</code> 语句都进行代理，仅针对 <code>FOR UPDATE</code> 的 <code>SELECT</code> 语句。</p><h3 id="2-4、整体机制"><a href="#2-4、整体机制" class="headerlink" title="2.4、整体机制"></a>2.4、整体机制</h3><p>AT 模式本质是两阶段提交协议（2PC）的演变：</p><ul><li>一阶段：业务数据和回滚日志记录在同一个本地事务中提交，释放本地锁和连接资源</li><li>二阶段：<ul><li>提交异步化，非常快速地完成</li><li>回滚是通过一阶段的回滚日志进行反向补偿</li></ul></li></ul><p><strong>一阶段：</strong></p><p>在一阶段，Seata 会拦截<code>业务 SQL</code>：</p><ul><li>1）首先解析 SQL 语义，找到<code>业务 SQL</code> 要更新的业务数据，在业务数据被更新前，将其保存成 <code>before image</code></li><li>2）执行 <code>业务 SQL</code> 更新业务数据，在业务数据更新之后，再将其保存成 <code>after image</code></li><li>3）最后生成行锁</li></ul><p>以上操作全部在一个数据库事务内完成，这样保证了一阶段操作的原子性，任何提交的业务数据的更新一定有相应的回滚日志存在</p><p><img data-src="../../../asset/2020/12/seata-model-at-1.png" alt="seata-model-at-1"></p><p>基于这样的机制，分支的本地事务便可以在全局事务的第一阶段提交，并马上释放本地事务锁定的资源；这也是 Seata 和 XA 事务的不同之处，两阶段提交往往对资源的锁定需要持续到第二阶段实际的提交或者回滚操作，而有了回滚日志之后，可以在第一阶段释放对资源的锁定，降低了锁范围，提高效率，即使第二阶段发生异常需要回滚，只需找对 <code>undolog</code> 中对应数据并反解析成 SQL 来达到回滚目的。同时 Seata 通过代理数据源将业务 SQL 的执行解析成 <code>undolog</code> 来与业务数据的更新同时入库，达到了对业务无侵入的效果。</p><p><strong>二阶段提交：</strong></p><p>二阶段如果是提交的话，因为 <code>业务 SQL</code> 在一阶段已经提交至数据库，所以 Seata 框架只需将一阶段保存的快照数据和行锁删掉，完成数据清理即可。</p><p><img data-src="../../../asset/2020/12/seata-model-at-2.png" alt="seata-model-at-2"></p><p><strong>二阶段回滚：</strong></p><p>二阶段如果是回滚的话，Seata 就需要回滚一阶段已经执行的 <code>业务 SQL</code> 来还原业务数据。回滚方式便是用 <code>before image</code> 还原业务数据；但在还原前要首先要校验脏写，对比 <code>数据库当前业务数据</code> 和 <code>after image</code>，如果两份数据完全一致就说明没有脏写，可以还原业务数据，<strong>如果不一致就说明有脏写，出现脏写就需要根据配置策略来做处理（如转人工处理）</strong>。</p><p><img data-src="../../../asset/2020/12/seata-model-at-3.png" alt="seata-model-at-3"></p><p><strong>通俗讲：</strong></p><ul><li>第一阶段：假如我们现在插入或更新一条数据，根据动态代理它会提取你插入或更新的数据，保存一个原快照，然后再去执行 <code>业务 SQL</code>，再保存一个新快照，生成一个行锁。当你这个业务方法没有执行完，这个锁是不会释放的。最终提交 <code>业务 SQL</code>，业务表和 <code>unlog</code> 表是在同一个本地事务中，也就是要么同时成功，要么同时失败。因为你更新或插入一条数据，<code>unlog</code> 表会记录一些原始数据便于回滚，是 Seata 帮助我们实现了回滚</li><li>第二阶段：在这个阶段 Seata 会查看你的日志是否成功，如果成功不会做任何操作，如果失败，它会做一个反向补偿，使用 <code>unlog</code> 表记录一些原数据进行回滚操作</li></ul><h3 id="2-5、适用场景与优缺点"><a href="#2-5、适用场景与优缺点" class="headerlink" title="2.5、适用场景与优缺点"></a>2.5、适用场景与优缺点</h3><p><strong>适用场景：</strong></p><p>分布式事务的业务逻辑中仅仅是纯数据库操作，不包含其他中间件的事务逻辑</p><p><strong>优点：</strong></p><p>改动及代码侵入最小，由 Seata 来负责 Commit 和 Rollback 的自动化提交或回滚操作</p><p><strong>缺点：</strong></p><ul><li>如果事务中包含缓存存储或发送 MQ 消息等，则不适合使用</li><li>多次对数据库操作，以及全局行锁的存在对并发处理性能有影响</li><li>为了保证镜像 SQL 的可靠性，需要用户对 SQL 尽量做简化，建议做法：将多条 SQL 语句分解为多个事务中的原子步骤（对应 Seata AT 模式的分支 Branch 概念），如果单条 SQL 语句跨表，也分解成为多个事务中的原子步骤（尽量降低 Seata 存储前 SQL 镜像结果时的风险）</li></ul><h2 id="3、TCC-模式"><a href="#3、TCC-模式" class="headerlink" title="3、TCC 模式"></a>3、TCC 模式</h2><h3 id="3-1、概述"><a href="#3-1、概述" class="headerlink" title="3.1、概述"></a>3.1、概述</h3><p>该模式由蚂蚁金服贡献，TCC 需要用户根据自己的业务场景实现 Try、Confirm 和 Cancel 三个接口。事务发起方在一阶段执行 Try 操作，在二阶段提交执行 Confirm 操作，二阶段回滚执行 Cancel 操作。TCC 三个接口的描述如下：</p><ul><li>Try：资源的检测和预留</li><li> Confirm：执行的业务操作提交，要求 Try 成功 Confirm 就一定要能成功</li><li> Cancel：预留资源释放</li></ul><hr><p>一个分布式的全局事务，整体是两阶段提交的模型。全局事务是由若干分支事务组成的，分支事务要满足两阶段提交的模型要求，即需要每个分支事务都具备自己的：</p><ul><li>一阶段 prepare 行为</li><li>二阶段 commit 或 rollback 行为</li></ul><p><img data-src="../../../asset/2020/12/seata-tcc-model.png" alt="seata-tcc-model"></p><h3 id="3-2、AT-与-TCC-的区别"><a href="#3-2、AT-与-TCC-的区别" class="headerlink" title="3.2、AT 与 TCC 的区别"></a>3.2、AT 与 TCC 的区别</h3><p>根据两阶段行为模式的不同，可以将分支事务划分为 Automatic (Branch) Transaction Mode 和 Manual (Branch) Transaction Mode。</p><p>AT 模式基于支持本地 ACID 事务的关系型数据库：</p><ul><li>一阶段 prepare 行为：在本地事务中，一并提交业务数据更新和相应回滚日志记录</li><li>二阶段 commit 行为：马上成功结束，自动异步批量清理回滚日志</li><li>二阶段 rollback 行为：通过回滚日志，自动生成补偿操作，完成数据回滚</li></ul><p>相应的，TCC 模式，不依赖于底层数据资源的事务支持：</p><ul><li>一阶段 prepare 行为：调用 自定义 的 prepare 逻辑</li><li>二阶段 commit 行为：调用 自定义 的 commit 逻辑</li><li>二阶段 rollback 行为：调用 自定义 的 rollback 逻辑</li></ul><p><strong>所谓的 Seata TCC 模式，是指支持把自定义的分支事务纳入到全局事务的管理中</strong></p><h3 id="3-3、适用场景与优缺点"><a href="#3-3、适用场景与优缺点" class="headerlink" title="3.3、适用场景与优缺点"></a>3.3、适用场景与优缺点</h3><p><strong>适用场景：</strong></p><ul><li>分布式事务的业务逻辑中除了数据库操作外，包含其他中间件事务逻辑</li></ul><p><strong>优点：</strong></p><ul><li>适合微服务化场景</li><li>无 AT 模式的全局行锁，TCC 性能会比 AT 模式高很多</li><li>用户可以自己定义业务的补偿逻辑，由业务层保证事务的一致性</li></ul><p><strong>缺点：</strong></p><ul><li>TCC 模式下开发者需要自行实现 Try、Confirm、Cancel 接口，对业务代码有一定的侵入性</li><li>需要考虑如何将业务模型拆成 2 阶段，实现成 TCC 的 3 个方法，并且保证 Try 成功 Confirm 就一定能成功，Confirm 失败会不断重试</li></ul><h2 id="4、Saga-模式"><a href="#4、Saga-模式" class="headerlink" title="4、Saga 模式"></a>4、Saga 模式</h2><h3 id="4-1、概述"><a href="#4-1、概述" class="headerlink" title="4.1、概述"></a>4.1、概述</h3><p>Saga 模式是 Seata 提供的长事务解决方案，该模式主要由蚂蚁金服贡献，在 Saga 模式中，业务流程中每个参与者都提交本地事务，当出现某一个参与者失败则补偿前面已经成功的参与者，一阶段正向服务和二阶段补偿服务都由业务开发实现。</p><p><img data-src="../../../asset/2020/12/seata-saga-model.png" alt="seata-saga-model"></p><h3 id="4-2、整体机制"><a href="#4-2、整体机制" class="headerlink" title="4.2、整体机制"></a>4.2、整体机制</h3><p>目前 Seata 提供的 Saga 模式是基于状态机引擎来实现的，机制是：</p><ul><li>1）通过状态图来定义服务调用的流程，并生成 Json 状态语言定义文件</li><li> 2）状态图中一个节点可以是调用一个服务，节点可以配置它的补偿节点</li><li> 3）状态图 Json 由状态机引擎驱动执行，当出现异常时状态引擎反向执行已成功节点对应的补偿节点将事务回滚（注意：异常发生时是否进行补偿也可由用户自定义决定）</li><li>4）可以实现服务编排需求，支持单项选择、并发、子流程、参数转换、参数映射、服务执行状态判断、异常捕获等功能</li></ul><p><img data-src="../../../asset/2020/12/seata-saga-model-2.png" alt="seata-saga-model-2"></p><h3 id="4-3、适用场景与优缺点"><a href="#4-3、适用场景与优缺点" class="headerlink" title="4.3、适用场景与优缺点"></a>4.3、适用场景与优缺点</h3><p><strong>适用场景：</strong></p><ul><li>对数据隔离性要求不高，对性能要求高的场景</li><li>参与者包含其它公司或遗留系统服务，无法提供 TCC 模式要求的三个接口</li><li>业务流程长、业务流程多、不需马上返回最终结果，只要保证最终一致性的场景</li></ul><p><strong>优点：</strong></p><ul><li>补偿逻辑易于实现</li><li>一阶段提交本地事务，无锁，高性能</li><li>事件驱动架构，参与者可异步执行，高吞吐量</li></ul><p><strong>缺点：</strong></p><ul><li>不保证隔离性</li><li>补偿逻辑需要自行实现</li></ul><h2 id="5、XA-模式"><a href="#5、XA-模式" class="headerlink" title="5、XA 模式"></a>5、XA 模式</h2><h3 id="5-1、前提"><a href="#5-1、前提" class="headerlink" title="5.1、前提"></a>5.1、前提</h3><ul><li>支持 XA 事务的数据库</li><li> Java 应用，通过 JDBC 访问数据库</li></ul><h3 id="5-2、整体机制"><a href="#5-2、整体机制" class="headerlink" title="5.2、整体机制"></a>5.2、整体机制</h3><p>在 Seata 定义的分布式事务框架内，利用事务资源（数据库、消息服务等）对 XA 协议的支持，以 XA 协议的机制来管理分支事务的一种事务模式。</p><p><img data-src="../../../asset/2020/12/seata-xa-model.png" alt="seata-xa-model"></p><p><strong>执行阶段：</strong></p><ul><li>可回滚：业务 SQL 操作放在 XA 分支中进行，由资源对 XA 协议的支持来保证可回滚</li><li>持久化：XA 分支完成后，执行 XA Prepare，同样，由资源对 XA 协议的支持来保证持久化（即之后任何意外都不会造成无法回滚的情况）</li></ul><p><strong>完成阶段：</strong></p><ul><li>分支提交：执行 XA 分支的 Commit</li><li> 分支回滚：执行 XA 分支的 Rollback</li></ul><h3 id="5-3、工作机制"><a href="#5-3、工作机制" class="headerlink" title="5.3、工作机制"></a>5.3、工作机制</h3><p><strong>整体运行机制：</strong></p><p><img data-src="../../../asset/2020/12/seata-xa-model-2.png" alt="seata-xa-model-2"></p><p>XA 模式 运行在 Seata 定义的事务框架内：</p><ul><li>执行阶段（E xecute）：XA start/XA end/XA prepare + SQL + 注册分支</li><li>完成阶段（F inish）：XA commit/XA rollback</li></ul><p><strong>数据源代理：</strong></p><p>XA 模式需要依赖 XAConnection，获取 XAConnection 两种方式：</p><ul><li>方式一：要求开发者配置 XADataSource，给开发者增加了认知负担，需要为 XA 模式专门去学习和使用 XA 数据源，与透明化 XA 编程模型的设计目标相违背</li><li>方式二：根据开发者的普通 DataSource 来创建，对开发者比较友好，和 AT 模式使用一样，开发者完全不必关心 XA 层面的任何问题，保持本地编程模型即可</li></ul><p>Seata 优先设计实现第二种方式：数据源代理根据普通数据源中获取的普通 JDBC 连接创建出相应的 XAConnection，类比 AT 模式的数据源代理机制（如下）:</p><p><img data-src="../../../asset/2020/12/seata-xa-model-3.png" alt="seata-xa-model-3"></p><p>但是第二种方法有局限：无法保证兼容的正确性。实际上，这种方法是在做数据库驱动程序要做的事情；不同的厂商、不同版本的数据库驱动实现机制是厂商私有的，Seata 只能保证在充分测试过的驱动程序上是正确的，开发者使用的驱动程序版本差异很可能造成机制的失效，这点在 Oracle 上体现非常明显。</p><hr><p>综合考虑，XA 模式的数据源代理设计需要同时支持第一种方式：基于 XA 数据源进行代理，类比 AT 模式的数据源代理机制（如下）：</p><p><img data-src="../../../asset/2020/12/seata-xa-model-4.png" alt="seata-xa-model-4"></p><p><strong>分支注册：</strong></p><p>XA Start 需要 Xid 参数，这个 Xid 需要和 Seata 全局事务的 XID 和 BranchId 关联起来，以便由 TC 驱动 XA 分支的提交或回滚。目前 Seata 的 BranchId 是在分支注册过程，由 TC 统一生成的，所以 XA 模式分支注册的时机需要在 XA start 之前。Seata 的 XA 模式将来一个可能的优化方向：把分支注册尽量延后。类似 AT 模式在本地事务提交之前才注册分支，避免分支执行失败情况下，没有意义的分支注册。这个优化方向需要 BranchId 生成机制的变化来配合，即 BranchId 不通过分支注册过程生成，而是生成后再带着 BranchId 去注册分支。</p><p><strong>XA 模式的使用：</strong></p><p>从编程模型上，XA 模式与 AT 模式保持完全一致，只需要修改数据源代理，即可实现 XA 模式与 AT 模式之间的切换，示例代码如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean("dataSource")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">(DruidDataSource druidDataSource)</span> </span>{</span><br><span class="line">        <span class="comment">// DataSourceProxy for AT mode</span></span><br><span class="line">        <span class="comment">// return new DataSourceProxy(druidDataSource);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// DataSourceProxyXA for XA mode</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceProxyXA(druidDataSource);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><h2 id="6、参考文献"><a href="#6、参考文献" class="headerlink" title="6、参考文献"></a>6、参考文献</h2><ul><li><a target="_blank" rel="external nofollow" href="http://seata.io/zh-cn/docs/dev/mode/at-mode.html">Seata 官方文档 - AT 模式</a></li><li><a target="_blank" rel="external nofollow" href="http://seata.io/zh-cn/docs/dev/mode/xa-mode.html">Seata 官方文档 - XA 模式</a></li><li><a target="_blank" rel="external nofollow" href="http://seata.io/zh-cn/docs/dev/mode/tcc-mode.html">Seata 官方文档 - TCC 模式</a></li><li><a target="_blank" rel="external nofollow" href="http://seata.io/zh-cn/docs/user/saga.html">Seata 官方文档 - Saga 模式</a></li></ul></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script>var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if(!isMobile)try{var plugin=new ReadmorePlugin;plugin.init({id:"readmore-container",blogId:"96641-5333172926158-056",name:"全栈技术驿站",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",lockToc:"yes",type:"hexo",random:"0.9",interval:"30",expires:"365",height:"auto"})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>坚持原创技术分享，您的支持将鼓励我继续创作！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/84d3f3e6.html" title="Seata 入门教程 - 中级篇">https://www.techgrow.cn/posts/84d3f3e6.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎加入微信群</span><br> <img src="/img/wx-group-qr-technology.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="fa fa-tag"></i> 微服务</a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag"><i class="fa fa-tag"></i> 分布式</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/e8b71fbe.html" rel="prev" title="Seata 入门教程 - 基础篇"><i class="fa fa-chevron-left"></i> Seata 入门教程 - 基础篇</a></div><div class="post-nav-item"> <a href="/posts/b0f7bd00.html" rel="next" title="Seata 入门教程 - 实战篇（电商）">Seata 入门教程 - 实战篇（电商）<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright &copy; 2018 – <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">797k</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 &asymp;</span> <span title="站点阅读时长">12:04</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="beian"> <span><img src="/img/gonganbeian.png" alt></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备19024664号</a></span></div></div></footer><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-tu9j5pBilBQrWSDePOOajCUdz6hWsid/lBNzK4KgEPM="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"/lib/mermaid/dist/mermaid.min.js","integrity":"sha256-ZfzwelSToHk5YAcr9wbXAmWgyn9Jyq08fSLrLhZE89w="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://unpkg.com/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://unpkg.com/qiniu-js@3.3.1/dist/qiniu.min.js"></script><script>
    var qiniu_domain = "https://qiniu.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/app/api/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn:9360","cssUrl":"https://unpkg.com/@waline/client@2.5.1/dist/waline.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://unpkg.com/@waline/client@2.5.1/dist/waline.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://unpkg.com/@waline/emojis@1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://qiniu.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/app/api/qiniu/token/upload","el":"#waline","comment":true,"path":"/posts/84d3f3e6.html"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@2.5.1/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>