<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要记录 Seata 的四大事务模式，包括 AT、TCC、Saga 和 XA 事务模式的介绍和使用。"><meta property="og:type" content="article"><meta property="og:title" content="Seata 入门教程 - 中级篇（2020 年）"><meta property="og:url" content="https://www.techgrow.cn/posts/84d3f3e6.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要记录 Seata 的四大事务模式，包括 AT、TCC、Saga 和 XA 事务模式的介绍和使用。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-model-at-4.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-model-at-5.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-model-at-6.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-model-at-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-model-at-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-model-at-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-tcc-model.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-saga-model.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-saga-model-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-xa-model.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-xa-model-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-xa-model-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-xa-model-4.png"><meta property="article:published_time" content="2020-12-28T13:12:19.000Z"><meta property="article:modified_time" content="2020-12-28T13:12:19.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="微服务"><meta property="article:tag" content="分布式"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2020/12/seata-model-at-4.png"><link rel="canonical" href="https://www.techgrow.cn/posts/84d3f3e6.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/84d3f3e6.html","path":"posts/84d3f3e6.html","title":"Seata 入门教程 - 中级篇（2020 年）"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Seata 入门教程 - 中级篇（2020 年） | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%98%E6%96%B9%E8%B5%84%E6%BA%90"><span class="nav-text">官方资源</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Seata-%E7%9A%84%E5%9B%9B%E5%A4%A7%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%BC%8F"><span class="nav-text">Seata 的四大事务模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81AT-%E6%A8%A1%E5%BC%8F"><span class="nav-text">1、AT 模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1%E3%80%81%E6%A6%82%E8%BF%B0"><span class="nav-text">1.1、概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2%E3%80%81%E4%BD%BF%E7%94%A8%E5%89%8D%E6%8F%90"><span class="nav-text">1.2、使用前提</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3%E3%80%81%E6%95%B4%E4%BD%93%E6%9C%BA%E5%88%B6"><span class="nav-text">1.3、整体机制</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-3-1%E3%80%81%E5%86%99%E9%9A%94%E7%A6%BB"><span class="nav-text">1.3.1、写隔离</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-3-2%E3%80%81%E8%AF%BB%E9%9A%94%E7%A6%BB"><span class="nav-text">1.3.2、读隔离</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4%E3%80%81%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6"><span class="nav-text">1.4、工作机制</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-4-1%E3%80%81%E4%B8%80%E9%98%B6%E6%AE%B5"><span class="nav-text">1.4.1、一阶段</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-4-2%E3%80%81%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4"><span class="nav-text">1.4.2、二阶段提交</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-4-3%E3%80%81%E4%BA%8C%E9%98%B6%E6%AE%B5%E5%9B%9E%E6%BB%9A"><span class="nav-text">1.4.3、二阶段回滚</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-4-4%E3%80%81%E4%B8%BE%E4%BE%8B%E8%AF%B4%E6%98%8E"><span class="nav-text">1.4.4、举例说明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-4-5%E3%80%81%E6%80%BB%E7%BB%93%E8%AF%B4%E6%98%8E"><span class="nav-text">1.4.5、总结说明</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-5%E3%80%81%E4%BC%98%E7%BC%BA%E7%82%B9%E4%B8%8E%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">1.5、优缺点与使用场景</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81TCC-%E6%A8%A1%E5%BC%8F"><span class="nav-text">2、TCC 模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1%E3%80%81%E6%A6%82%E8%BF%B0"><span class="nav-text">2.1、概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2%E3%80%81AT-%E4%B8%8E-TCC-%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-text">2.2、AT 与 TCC 的区别</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3%E3%80%81%E4%BC%98%E7%BC%BA%E7%82%B9%E4%B8%8E%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">2.3、优缺点与使用场景</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81Saga-%E6%A8%A1%E5%BC%8F"><span class="nav-text">3、Saga 模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1%E3%80%81%E6%A6%82%E8%BF%B0"><span class="nav-text">3.1、概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2%E3%80%81%E6%95%B4%E4%BD%93%E6%9C%BA%E5%88%B6"><span class="nav-text">3.2、整体机制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3%E3%80%81%E4%BC%98%E7%BC%BA%E7%82%B9%E4%B8%8E%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">3.3、优缺点与使用场景</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%E3%80%81XA-%E6%A8%A1%E5%BC%8F"><span class="nav-text">4、XA 模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1%E3%80%81%E6%A6%82%E8%BF%B0"><span class="nav-text">4.1、概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2%E3%80%81%E4%BD%BF%E7%94%A8%E5%89%8D%E6%8F%90"><span class="nav-text">4.2、使用前提</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3%E3%80%81%E6%95%B4%E4%BD%93%E6%9C%BA%E5%88%B6"><span class="nav-text">4.3、整体机制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4%E3%80%81%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6"><span class="nav-text">4.4、工作机制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5%E3%80%81%E4%BC%98%E7%BC%BA%E7%82%B9%E4%B8%8E%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">4.5、优缺点与使用场景</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Seata-%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81"><span class="nav-text">Seata 的数据库类型支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">744</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">53</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/84d3f3e6.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Seata 入门教程 - 中级篇（2020 年） | Clay 的技术空间"><meta itemprop="description" content="本文主要记录 Seata 的四大事务模式，包括 AT、TCC、Saga 和 XA 事务模式的介绍和使用。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Seata 入门教程 - 中级篇（2020 年）</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-12-28 21:12:19" itemprop="dateCreated datePublished" datetime="2020-12-28T21:12:19+08:00">2020-12-28</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/84d3f3e6.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/84d3f3e6.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>7.2k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>7 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/e8b71fbe.html">Seata 入门教程 - 基础篇（2020 年）</a></li><li><a href="/posts/84d3f3e6.html">Seata 入门教程 - 中级篇（2020 年）</a></li><li><a href="/posts/b0f7bd00.html">Seata 入门教程 - 实战篇（2020 年）</a></li><li><a href="/posts/85fab89c.html">Seata 入门教程 - 实战篇（2024 年）</a></li></ul><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="官方资源"><a href="#官方资源" class="headerlink" title="官方资源"></a>官方资源</h3><ul><li><a target="_blank" rel="external nofollow" href="https://github.com/apache/incubator-seata">Seata GitHub</a></li><li><a target="_blank" rel="external nofollow" href="https://seata.apache.org/zh-cn/docs/user/quickstart/">Seata 官方文档</a></li><li><a target="_blank" rel="external nofollow" href="https://github.com/apache/incubator-seata-samples">Seata 官方示例代码</a></li></ul><h2 id="Seata-的四大事务模式"><a href="#Seata-的四大事务模式" class="headerlink" title="Seata 的四大事务模式"></a>Seata 的四大事务模式</h2><p>Seata 为用户提供了 AT、TCC、Saga 和 XA 事务模式，致力于提供高性能和简单易用的分布式事务服务。</p><span id="more"></span><h3 id="1、AT-模式"><a href="#1、AT-模式" class="headerlink" title="1、AT 模式"></a>1、AT 模式</h3><h4 id="1-1、概述"><a href="#1-1、概述" class="headerlink" title="1.1、概述"></a>1.1、概述</h4><p>AT 模式是 Seata 创新的一种非入侵式的分布式事务解决方案，Seata 在内部做了对数据库操作的代理层。当我们使用 Seata AT 模式时，实际上用的是 Seata 自带的数据源代理 DataSourceProxy 类，Seata 在这层代理中加入了很多逻辑，比如插入回滚 <code>undo_log</code> 日志、检查全局锁等。</p><h4 id="1-2、使用前提"><a href="#1-2、使用前提" class="headerlink" title="1.2、使用前提"></a>1.2、使用前提</h4><ul><li>属于 Java 应用，通过 JDBC 访问数据库</li><li>基于支持本地 ACID 事务的关系型数据库</li></ul><h4 id="1-3、整体机制"><a href="#1-3、整体机制" class="headerlink" title="1.3、整体机制"></a>1.3、整体机制</h4><p><strong>AT 模式本质是二阶段提交协议（2PC）的演变：</strong></p><ul><li><p>一阶段：业务数据和回滚日志记录在同一个本地事务中提交，释放本地锁和连接资源</p></li><li><p>二阶段：</p><ul><li>提交异步化，非常快速地完成</li><li>回滚是通过一阶段的回滚日志进行反向补偿</li></ul></li></ul><h5 id="1-3-1、写隔离"><a href="#1-3-1、写隔离" class="headerlink" title="1.3.1、写隔离"></a>1.3.1、写隔离</h5><ul><li>一阶段本地事务提交前，需要确保先拿到全局锁</li><li>拿不到全局锁 ，不能提交本地事务</li><li>拿全局锁的尝试被限制在一定范围内，超出范围将放弃，并回滚本地事务，释放本地锁</li></ul><blockquote><p>举例说明：两个全局事务 tx1 和 tx2，分别对 a 表的 m 字段进行更新操作，m 字段的初始值 1000</p></blockquote><p>tx1 先开始，开启本地事务，拿到本地锁，执行更新操作 <code>m = 1000 - 100 = 900</code>。在 tx1 本地事务提交前，先拿到该记录的全局锁，本地提交事务后会释放本地锁。</p><p>tx2 后开始，开启本地事务，拿到本地锁，执行更新操作 <code>m = 900 - 100 = 800</code>。在 tx2 本地事务提交前，尝试拿该记录的全局锁；由于在 tx1 全局提交前，该记录的全局锁被 tx1 持有，tx2 需要重试等待获取全局锁 。</p><p><img data-src="../../../asset/2020/12/seata-model-at-4.png" alt="seata-model-at-4"></p><p>如果 tx1 二阶段全局提交事务，释放全局锁，那么 tx2 拿到全局锁后就可以提交本地事务</p><p><img data-src="../../../asset/2020/12/seata-model-at-5.png" alt="seata-model-at-5"></p><p>如果 tx1 的二阶段全局回滚，则 tx1 需要重新获取该数据的本地锁，进行反向补偿的更新操作，实现分支事务的回滚。</p><p>此时，如果 tx2 仍在等待该数据的全局锁，同时持有本地锁，则 tx1 的分支事务回滚会失败。tx1 的分支事务回滚会一直重试，直到 tx2 的全局锁等锁超时，放弃等待全局锁并回滚本地事务释放本地锁，tx1 的分支事务最终回滚成功。</p><p>因为整个过程全局锁在 tx1 结束前一直是被 tx1 持有的，所以不会出现脏写的问题。</p><h5 id="1-3-2、读隔离"><a href="#1-3-2、读隔离" class="headerlink" title="1.3.2、读隔离"></a>1.3.2、读隔离</h5><p>在数据库本地事务隔离级别<code>读已提交（Read Committed）</code>或以上的基础上，Seata（AT 模式）的默认全局隔离级别是<code>读未提交（Read Uncommitted）</code>。<br>如果应用在特定场景下，必需要求全局的<code>读已提交</code>，目前 Seata 的方式是通过 <code>SELECT FOR UPDATE</code> 语句的代理。</p><p><img data-src="../../../asset/2020/12/seata-model-at-6.png" alt="seata-model-at-6"></p><p><code>SELECT FOR UPDATE</code> 语句的执行会申请全局锁，如果全局锁被其他事务持有，则释放本地锁（回滚 <code>SELECT FOR UPDATE</code> 语句的本地执行）并重试。这个过程中，查询是被 <code>block</code> 住的，直到拿到全局锁，即读取的相关数据是已提交的才返回。<br>出于总体性能上的考虑，Seata 目前的方案并没有对所有 <code>SELECT</code> 语句都进行代理，仅针对 <code>FOR UPDATE</code> 的 <code>SELECT</code> 语句。</p><h4 id="1-4、工作机制"><a href="#1-4、工作机制" class="headerlink" title="1.4、工作机制"></a>1.4、工作机制</h4><h5 id="1-4-1、一阶段"><a href="#1-4-1、一阶段" class="headerlink" title="1.4.1、一阶段"></a>1.4.1、一阶段</h5><p>在一阶段，Seata 会拦截<code>业务 SQL</code>：</p><ul><li>1）首先解析 SQL 语义，找到<code>业务 SQL</code> 要更新的业务数据，在业务数据被更新前，将其保存成 <code>before image</code></li><li>2）执行 <code>业务 SQL</code> 更新业务数据，在业务数据更新之后，再将其保存成 <code>after image</code></li><li>3）最后生成行锁</li></ul><p>以上操作全部在一个数据库事务内完成，这样保证了一阶段操作的原子性，任何提交的业务数据的更新一定有相应的回滚日志存在</p><p><img data-src="../../../asset/2020/12/seata-model-at-1.png" alt="seata-model-at-1"></p><p>基于这样的机制，分支的本地事务便可以在全局事务的第一阶段提交，并马上释放本地事务锁定的资源；这也是 Seata 和 XA 事务的不同之处，二阶段提交往往对资源的锁定需要持续到第二阶段实际的提交或者回滚操作，而有了回滚日志之后，可以在第一阶段释放对资源的锁定，降低了锁范围，提高效率，即使第二阶段发生异常需要回滚，只需找对 <code>undolog</code> 中对应数据并反解析成 SQL 来达到回滚目的。同时 Seata 通过代理数据源将业务 SQL 的执行解析成 <code>undolog</code> 来与业务数据的更新同时入库，达到了对业务无侵入的效果。</p><h5 id="1-4-2、二阶段提交"><a href="#1-4-2、二阶段提交" class="headerlink" title="1.4.2、二阶段提交"></a>1.4.2、二阶段提交</h5><p>二阶段如果是提交的话，因为 <code>业务 SQL</code> 在一阶段已经提交至数据库，所以 Seata 框架只需将一阶段保存的快照数据和行锁删掉，完成数据清理即可。</p><p><img data-src="../../../asset/2020/12/seata-model-at-2.png" alt="seata-model-at-2"></p><h5 id="1-4-3、二阶段回滚"><a href="#1-4-3、二阶段回滚" class="headerlink" title="1.4.3、二阶段回滚"></a>1.4.3、二阶段回滚</h5><p>二阶段如果是回滚的话，Seata 就需要回滚一阶段已经执行的 <code>业务 SQL</code> 来还原业务数据。回滚方式便是用 <code>before image</code> 还原业务数据；但在还原前要首先要校验脏写，对比 <code>数据库当前业务数据</code> 和 <code>after image</code>，如果两份数据完全一致就说明没有脏写，可以还原业务数据，<strong>如果不一致就说明有脏写，出现脏写就需要根据配置策略来做处理（如转人工处理）</strong>。</p><p><img data-src="../../../asset/2020/12/seata-model-at-3.png" alt="seata-model-at-3"></p><h5 id="1-4-4、举例说明"><a href="#1-4-4、举例说明" class="headerlink" title="1.4.4、举例说明"></a>1.4.4、举例说明</h5><p>这里以一个示例来说明整个 AT 分支的工作过程。</p><blockquote><p>业务查询逻辑</p></blockquote><ul><li>(1) 业务表 <code>product</code> 的结构</li></ul><table><thead><tr><th> Field</th><th>Type</th><th>Key</th></tr></thead><tbody><tr><td>id</td><td>bigint(20)</td><td>PRI</td></tr><tr><td>name</td><td>varchar(100)</td><td></td></tr><tr><td>since</td><td>varchar(100)</td><td></td></tr></tbody></table><ul><li>(2) AT 分支事务的业务查询逻辑：</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update product <span class="keyword">set</span> name <span class="operator">=</span> <span class="string">'GTS'</span> <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">'TXC'</span>;</span><br></pre></td></tr></tbody></table></figure><blockquote><p>一阶段</p></blockquote><ul><li>(1) 解析 SQL：得到 SQL 的类型（<code>update</code>），表（<code>product</code>），条件（<code>where name = 'TXC'</code>）等相关的信息。</li><li>(2) 查询前镜像：根据解析得到的条件信息，生成查询语句，定位数据。</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id, name, since <span class="keyword">from</span> product <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">'TXC'</span>;</span><br></pre></td></tr></tbody></table></figure><p>得到前镜像：</p><table><thead><tr><th>id</th><th>name</th><th>since</th></tr></thead><tbody><tr><td>1</td><td>TXC</td><td>2014</td></tr></tbody></table><ul><li>(3) 执行业务 SQL：更新这条记录的 <code>name</code> 为 <code>GTS</code>。</li><li>(4) 查询后镜像：根据前镜像的结果，通过主键定位数据。</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id, name, since <span class="keyword">from</span> product <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure><p>得到后镜像：</p><table><thead><tr><th>id</th><th>name</th><th>since</th></tr></thead><tbody><tr><td>1</td><td>GTS</td><td>2014</td></tr></tbody></table><ul><li>(5) 插入回滚日志：把前后镜像数据以及业务 SQL 相关的信息组成一条回滚日志记录，插入到 <code>UNDO_LOG</code> 表中。</li></ul><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">     <span class="attr">"branchId"</span>: <span class="number">641789253</span>,</span><br><span class="line">     <span class="attr">"undoItems"</span>: [</span><br><span class="line">          {</span><br><span class="line">               <span class="attr">"afterImage"</span>: {</span><br><span class="line">                    <span class="attr">"rows"</span>: [</span><br><span class="line">                         {</span><br><span class="line">                              <span class="attr">"fields"</span>: [</span><br><span class="line">                                   {</span><br><span class="line">                                        <span class="attr">"name"</span>: <span class="string">"id"</span>,</span><br><span class="line">                                        <span class="attr">"type"</span>: <span class="number">4</span>,</span><br><span class="line">                                        <span class="attr">"value"</span>: <span class="number">1</span></span><br><span class="line">                                   },</span><br><span class="line">                                   {</span><br><span class="line">                                        <span class="attr">"name"</span>: <span class="string">"name"</span>,</span><br><span class="line">                                        <span class="attr">"type"</span>: <span class="number">12</span>,</span><br><span class="line">                                        <span class="attr">"value"</span>: <span class="string">"GTS"</span></span><br><span class="line">                                   },</span><br><span class="line">                                   {</span><br><span class="line">                                        <span class="attr">"name"</span>: <span class="string">"since"</span>,</span><br><span class="line">                                        <span class="attr">"type"</span>: <span class="number">12</span>,</span><br><span class="line">                                        <span class="attr">"value"</span>: <span class="string">"2014"</span></span><br><span class="line">                                   }</span><br><span class="line">                              ]</span><br><span class="line">                         }</span><br><span class="line">                    ],</span><br><span class="line">                    <span class="attr">"tableName"</span>: <span class="string">"product"</span></span><br><span class="line">               },</span><br><span class="line">               <span class="attr">"beforeImage"</span>: {</span><br><span class="line">                    <span class="attr">"rows"</span>: [</span><br><span class="line">                         {</span><br><span class="line">                              <span class="attr">"fields"</span>: [</span><br><span class="line">                                   {</span><br><span class="line">                                        <span class="attr">"name"</span>: <span class="string">"id"</span>,</span><br><span class="line">                                        <span class="attr">"type"</span>: <span class="number">4</span>,</span><br><span class="line">                                        <span class="attr">"value"</span>: <span class="number">1</span></span><br><span class="line">                                   },</span><br><span class="line">                                   {</span><br><span class="line">                                        <span class="attr">"name"</span>: <span class="string">"name"</span>,</span><br><span class="line">                                        <span class="attr">"type"</span>: <span class="number">12</span>,</span><br><span class="line">                                        <span class="attr">"value"</span>: <span class="string">"TXC"</span></span><br><span class="line">                                   },</span><br><span class="line">                                   {</span><br><span class="line">                                        <span class="attr">"name"</span>: <span class="string">"since"</span>,</span><br><span class="line">                                        <span class="attr">"type"</span>: <span class="number">12</span>,</span><br><span class="line">                                        <span class="attr">"value"</span>: <span class="string">"2014"</span></span><br><span class="line">                                   }</span><br><span class="line">                              ]</span><br><span class="line">                         }</span><br><span class="line">                    ],</span><br><span class="line">                    <span class="attr">"tableName"</span>: <span class="string">"product"</span></span><br><span class="line">               },</span><br><span class="line">               <span class="attr">"sqlType"</span>: <span class="string">"UPDATE"</span></span><br><span class="line">          }</span><br><span class="line">     ],</span><br><span class="line">     <span class="attr">"xid"</span>: <span class="string">"xid:xxx"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>(6) 提交前，向 TC 注册分支：申请 <code>product</code> 表中，主键值等于 1 的记录的全局锁 。</li><li>(7) 本地事务提交：业务数据的更新和前面步骤中生成的 UNDO LOG 一并提交。</li><li>(8) 将本地事务提交的结果上报给 TC。</li></ul><blockquote><p>二阶段 - 提交</p></blockquote><ul><li>(1) 收到 TC 的分支提交请求，把请求放入一个异步任务的队列中，马上返回提交成功的结果给 TC。</li><li>(2) 异步任务阶段的分支提交请求将异步和批量地删除相应 UNDO LOG 记录。</li></ul><blockquote><p>二阶段 - 回滚</p></blockquote><ul><li>(1) 收到 TC 的分支回滚请求，开启一个本地事务，执行如下操作。</li><li>(2) 通过 XID 和 Branch ID 查找到相应的 UNDO LOG 记录。</li><li>(3) 数据校验：拿 UNDO LOG 中的后镜像与当前数据进行比较，如果有不同，说明数据被当前全局事务之外的动作做了修改。这种情况，需要根据配置策略来做处理（如转人工处理）。</li><li>(4) 根据 UNDO LOG 中的前镜像和业务 SQL 的相关信息生成并执行回滚的 SQL 语句：</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update product <span class="keyword">set</span> name <span class="operator">=</span> <span class="string">'TXC'</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure><ul><li>(5) 提交本地事务，并把本地事务的执行结果（即分支事务回滚的结果）上报给 TC。</li></ul><blockquote><p>回滚日志表的结构</p></blockquote><p><code>UNDO_LOG</code> 表的结构如下，不同数据库在类型上会略有差别。</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 注意此处0.7.0+ 增加字段 context</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `undo_log` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `branch_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `xid` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `context` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `rollback_info` longblob <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_status` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_created` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `ux_undo_log` (`xid`,`branch_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></tbody></table></figure><h5 id="1-4-5、总结说明"><a href="#1-4-5、总结说明" class="headerlink" title="1.4.5、总结说明"></a>1.4.5、总结说明</h5><ul><li>第一阶段：假如我们现在插入或更新一条数据，根据动态代理它会提取你插入或更新前的数据，保存一个原快照，然后再去执行 <code>业务 SQL</code>，再保存一个新快照，生成一个行锁。当你这个业务方法没有执行完，这个锁是不会释放的。最终提交 <code>业务 SQL</code>，业务表和 <code>unlog</code> 表是在同一个本地事务提交中，也就是要么同时成功，要么同时失败。因为你更新或插入一条数据，<code>unlog</code> 表会记录一些原始数据便于回滚，是 Seata 帮助我们实现了回滚。</li><li>第二阶段：在这个阶段 Seata 会查看你的日志是否成功，如果成功不会做任何操作，如果失败，它会做一个反向补偿，使用 <code>unlog</code> 表记录一些原数据进行回滚操作。</li></ul><h4 id="1-5、优缺点与使用场景"><a href="#1-5、优缺点与使用场景" class="headerlink" title="1.5、优缺点与使用场景"></a>1.5、优缺点与使用场景</h4><ul><li><p>优点：</p><ul><li>改动及代码侵入最小，由 Seata 来负责 Commit 和 Rollback 的自动化提交或回滚操作</li></ul></li><li><p>缺点：</p><ul><li>如果事务中包含缓存存储或发送 MQ 消息等，则不适合使用</li><li>多次对数据库操作，以及全局行锁的存在对并发处理性能有影响</li><li>为了保证镜像 SQL 的可靠性，需要用户对 SQL 尽量做简化，建议做法：将多条 SQL 语句分解为多个事务中的原子步骤（对应 Seata AT 模式的分支 Branch 概念），如果单条 SQL 语句跨表，也分解成为多个事务中的原子步骤（尽量降低 Seata 存储前 SQL 镜像结果时的风险）</li></ul></li><li><p>适用场景：</p><ul><li>分布式事务的业务逻辑中仅仅是纯数据库操作，不包含其他中间件的事务逻辑</li></ul></li></ul><h3 id="2、TCC-模式"><a href="#2、TCC-模式" class="headerlink" title="2、TCC 模式"></a>2、TCC 模式</h3><h4 id="2-1、概述"><a href="#2-1、概述" class="headerlink" title="2.1、概述"></a>2.1、概述</h4><p>TCC 模式是 Seata 支持的一种由业务方细粒度控制的入侵式分布式事务解决方案，是继 AT 模式后第二种支持的事务模式，最早由蚂蚁金服贡献。其分布式事务模型直接作用于服务层，不依赖底层数据库，可以灵活选择业务资源的锁定粒度，减少资源锁持有时间，可扩展性好，可以说是为独立部署的 SOA 服务而设计的。TCC 需要用户根据自己的业务场景实现 Try、Confirm 和 Cancel 三个接口。事务发起方在一阶段执行 Try 操作，在二阶段提交执行 Confirm 操作，二阶段回滚执行 Cancel 操作。TCC 三个接口的描述如下：</p><ul><li>Try：资源的检测和预留</li><li> Confirm：执行的业务操作提交，要求 Try 成功 Confirm 就一定要能成功</li><li> Cancel：预留资源释放</li></ul><hr><p>一个分布式的全局事务，整体是二阶段提交的模型。全局事务是由若干分支事务组成的，分支事务要满足二阶段提交的模型要求，即需要每个分支事务都具备自己的：</p><ul><li>一阶段 prepare 行为</li><li>二阶段 commit 或 rollback 行为</li></ul><p><img data-src="../../../asset/2020/12/seata-tcc-model.png" alt="seata-tcc-model"></p><h4 id="2-2、AT-与-TCC-的区别"><a href="#2-2、AT-与-TCC-的区别" class="headerlink" title="2.2、AT 与 TCC 的区别"></a>2.2、AT 与 TCC 的区别</h4><p>根据二阶段行为模式的不同，可以将分支事务划分为 Automatic (Branch) Transaction Mode 和 Manual (Branch) Transaction Mode。</p><ul><li><p>AT 模式是基于支持本地 ACID 事务的关系型数据库：</p><ul><li>一阶段 prepare 行为：在本地事务中，一并提交业务数据更新和相应回滚日志记录</li><li>二阶段 commit 行为：马上成功结束，自动异步批量清理回滚日志</li><li>二阶段 rollback 行为：通过回滚日志，自动生成补偿操作，完成数据回滚</li></ul></li><li><p> TCC 模式不依赖于底层数据资源的事务支持：</p><ul><li>一阶段 prepare 行为：调用 自定义 的 prepare 逻辑</li><li>二阶段 commit 行为：调用 自定义 的 commit 逻辑</li><li>二阶段 rollback 行为：调用 自定义 的 rollback 逻辑</li></ul></li></ul><div class="admonition note"><p class="admonition-title">提示</p><p>所谓的 Seata TCC 模式，是指支持把自定义的分支事务纳入到全局事务的管理中。</p></div><h4 id="2-3、优缺点与使用场景"><a href="#2-3、优缺点与使用场景" class="headerlink" title="2.3、优缺点与使用场景"></a>2.3、优缺点与使用场景</h4><ul><li><p>优点：</p><ul><li>适合微服务化场景</li><li>无 AT 模式的全局行锁，TCC 性能会比 AT 模式高很多</li><li>用户可以自己定义业务的补偿逻辑，由业务层保证事务的一致性</li><li> TCC 完全不依赖底层数据库，能够实现跨数据库、跨应用资源管理，可以提供给业务方更细粒度的控制</li></ul></li><li><p>缺点：</p><ul><li>TCC 模式下开发者需要针对业务系统自行实现 Try、Confirm、Cancel 接口，对业务代码有着非常大的入侵性，设计相对复杂</li><li>需要考虑如何将业务模型拆成二阶段，实现成 TCC 的 3 个接口，并且保证 Try 成功 Confirm 就一定能成功，Confirm 失败会不断重试</li></ul></li><li><p>适用场景：</p><ul><li>分布式事务的业务逻辑中除了数据库操作外，包含了其他中间件（如 MQ）的事务逻辑</li><li> TCC 模式是高性能分布式事务解决方案，适用于核心系统等对性能有很高要求的场景</li></ul></li></ul><h3 id="3、Saga-模式"><a href="#3、Saga-模式" class="headerlink" title="3、Saga 模式"></a>3、Saga 模式</h3><h4 id="3-1、概述"><a href="#3-1、概述" class="headerlink" title="3.1、概述"></a>3.1、概述</h4><p>Saga 模式是 Seata 提供的长事务解决方案，该模式主要由蚂蚁金服贡献。在 Saga 模式中，业务流程中每个参与者都提交本地事务，当出现某一个参与者失败则补偿前面已经成功的参与者，一阶段正向服务和二阶段补偿服务都由业务开发实现。</p><p><img data-src="../../../asset/2020/12/seata-saga-model.png" alt="seata-saga-model"></p><h4 id="3-2、整体机制"><a href="#3-2、整体机制" class="headerlink" title="3.2、整体机制"></a>3.2、整体机制</h4><p>目前 Seata 提供的 Saga 模式是基于状态机引擎来实现的，机制是：</p><ul><li>1）通过状态图来定义服务调用的流程，并生成 Json 状态语言定义文件</li><li> 2）状态图中一个节点可以是调用一个服务，节点可以配置它的补偿节点</li><li> 3）状态图 Json 由状态机引擎驱动执行，当出现异常时状态引擎反向执行已成功节点对应的补偿节点将事务回滚（注意：异常发生时是否进行补偿也可由用户自定义决定）</li><li>4）可以实现服务编排需求，支持单项选择、并发、子流程、参数转换、参数映射、服务执行状态判断、异常捕获等功能</li></ul><p><img data-src="../../../asset/2020/12/seata-saga-model-2.png" alt="seata-saga-model-2"></p><h4 id="3-3、优缺点与使用场景"><a href="#3-3、优缺点与使用场景" class="headerlink" title="3.3、优缺点与使用场景"></a>3.3、优缺点与使用场景</h4><ul><li><p>优点：</p><ul><li>补偿逻辑易于实现</li><li>一阶段提交本地事务，无锁，高性能</li><li>事件驱动架构，参与者可异步执行，高吞吐量</li></ul></li><li><p>缺点：</p><ul><li>不保证隔离性</li><li>补偿逻辑需要自行实现</li></ul></li><li><p>适用场景：</p><ul><li>对数据隔离性要求不高，对性能要求高的场景</li><li>参与者包含其它公司或遗留系统服务，无法提供 TCC 模式要求的三个接口</li><li>业务流程长、业务流程多、不需马上返回最终结果，只要保证最终一致性的场景</li></ul></li></ul><h3 id="4、XA-模式"><a href="#4、XA-模式" class="headerlink" title="4、XA 模式"></a>4、XA 模式</h3><h4 id="4-1、概述"><a href="#4-1、概述" class="headerlink" title="4.1、概述"></a>4.1、概述</h4><p>XA 模式是从 Seata <code>1.2</code> 版本支持的事务模式。XA 规范 是 X/Open 组织定义的分布式事务处理（DTP，Distributed Transaction Processing）标准。Seata XA 模式是利用事务资源（数据库、消息服务等）对 XA 协议的支持，以 XA 协议的机制来管理分支事务的一种事务模式。</p><h4 id="4-2、使用前提"><a href="#4-2、使用前提" class="headerlink" title="4.2、使用前提"></a>4.2、使用前提</h4><ul><li>支持 XA 事务的数据库</li><li>属于 Java 应用，通过 JDBC 访问数据库</li></ul><h4 id="4-3、整体机制"><a href="#4-3、整体机制" class="headerlink" title="4.3、整体机制"></a>4.3、整体机制</h4><p>在 Seata 定义的分布式事务框架内，利用事务资源（数据库、消息服务等）对 XA 协议的支持，以 XA 协议的机制来管理分支事务的一种事务模式。</p><p><img data-src="../../../asset/2020/12/seata-xa-model.png" alt="seata-xa-model"></p><p><strong>执行阶段：</strong></p><ul><li>可回滚：业务 SQL 操作放在 XA 分支中进行，由资源对 XA 协议的支持来保证可回滚</li><li>持久化：XA 分支完成后，执行 XA Prepare，同样，由资源对 XA 协议的支持来保证持久化（即之后任何意外都不会造成无法回滚的情况）</li></ul><p><strong>完成阶段：</strong></p><ul><li>分支提交：执行 XA 分支的 Commit</li><li> 分支回滚：执行 XA 分支的 Rollback</li></ul><h4 id="4-4、工作机制"><a href="#4-4、工作机制" class="headerlink" title="4.4、工作机制"></a>4.4、工作机制</h4><blockquote><p>整体运行机制</p></blockquote><p><img data-src="../../../asset/2020/12/seata-xa-model-2.png" alt="seata-xa-model-2"></p><p>XA 模式 运行在 Seata 定义的事务框架内：</p><ul><li>执行阶段（E xecute）：XA start/XA end/XA prepare + SQL + 注册分支</li><li>完成阶段（F inish）：XA commit/XA rollback</li></ul><blockquote><p>数据源代理</p></blockquote><p>XA 模式需要依赖 XAConnection，获取 XAConnection 两种方式：</p><ul><li>方式一：要求开发者配置 XADataSource，给开发者增加了认知负担，需要为 XA 模式专门去学习和使用 XA 数据源，与透明化 XA 编程模型的设计目标相违背</li><li>方式二：根据开发者的普通 DataSource 来创建，对开发者比较友好，和 AT 模式使用一样，开发者完全不必关心 XA 层面的任何问题，保持本地编程模型即可</li></ul><p>Seata 优先设计实现第二种方式：数据源代理根据普通数据源中获取的普通 JDBC 连接创建出相应的 XAConnection，类比 AT 模式的数据源代理机制（如下）:</p><p><img data-src="../../../asset/2020/12/seata-xa-model-3.png" alt="seata-xa-model-3"></p><p>但是第二种方法有局限：无法保证兼容的正确性。实际上，这种方法是在做数据库驱动程序要做的事情；不同的厂商、不同版本的数据库驱动实现机制是厂商私有的，Seata 只能保证在充分测试过的驱动程序上是正确的，开发者使用的驱动程序版本差异很可能造成机制的失效，这点在 Oracle 上体现非常明显。</p><hr><p>综合考虑，XA 模式的数据源代理设计需要同时支持第一种方式：基于 XA 数据源进行代理，类比 AT 模式的数据源代理机制（如下）：</p><p><img data-src="../../../asset/2020/12/seata-xa-model-4.png" alt="seata-xa-model-4"></p><blockquote><p>分支注册</p></blockquote><p>XA Start 需要 Xid 参数，这个 Xid 需要和 Seata 全局事务的 XID 和 BranchId 关联起来，以便由 TC 驱动 XA 分支的提交或回滚。目前 Seata 的 BranchId 是在分支注册过程，由 TC 统一生成的，所以 XA 模式分支注册的时机需要在 XA start 之前。Seata 的 XA 模式将来一个可能的优化方向：把分支注册尽量延后。类似 AT 模式在本地事务提交之前才注册分支，避免分支执行失败情况下，没有意义的分支注册。这个优化方向需要 BranchId 生成机制的变化来配合，即 BranchId 不通过分支注册过程生成，而是生成后再带着 BranchId 去注册分支。</p><blockquote><p>XA 模式的使用</p></blockquote><p>从编程模型上，XA 模式与 AT 模式保持完全一致，只需要修改数据源代理，即可实现 XA 模式与 AT 模式之间的切换，示例代码如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean("dataSource")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">(DruidDataSource druidDataSource)</span> </span>{</span><br><span class="line">        <span class="comment">// DataSourceProxy for AT mode</span></span><br><span class="line">        <span class="comment">// return new DataSourceProxy(druidDataSource);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// DataSourceProxyXA for XA mode</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceProxyXA(druidDataSource);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><h4 id="4-5、优缺点与使用场景"><a href="#4-5、优缺点与使用场景" class="headerlink" title="4.5、优缺点与使用场景"></a>4.5、优缺点与使用场景</h4><ul><li><p>优点</p><ul><li>XA 模式使用的是二阶段提交（2PC）协议，可以确保分布式事务的强一致性</li><li> XA 模式和 AT 模式一样，对业务是无侵入的，不会给应用设计和开发带来额外负担</li><li> XA 协议被主流关系型数据库广泛支持，开发者不需要手动实现分布式事务的逻辑，数据库 XA 驱动和 Seata 会自动完成分布式事务的管理</li></ul></li><li><p>缺点</p><ul><li>二阶段提交（2PC）会带来较高的事务开销，尤其是在事务参与者较多的场景下，可能导致较大的延迟</li><li>在事务提交的第一阶段（准备阶段），会锁定资源，可能造成阻塞等待。事务资源长时间得不到释放，锁定周期长，而且在应用层上面无法干预，性能表现较差</li><li>要求所有参与者的数据库节点高度可用，如果某个数据库节点不可用，事务可能会被阻塞</li></ul></li><li><p>适用场景</p><ul><li>适用于 AT 模式未适配的数据库应用</li><li>适用于想要迁移到 Seata 平台基于 XA 协议的老旧应用</li><li>适用于事务较短、并发量较低的场景，可以接受较高的性能开销来保证数据一致性</li><li>适用于金融、电信等对一致性要求高的场景，比如银行转账、支付等</li><li>适用于跨数据库、跨服务的场景，但需要数据库支持 XA 协议</li></ul></li></ul><h2 id="Seata-的数据库类型支持"><a href="#Seata-的数据库类型支持" class="headerlink" title="Seata 的数据库类型支持"></a>Seata 的数据库类型支持</h2><ul><li><p>AT 模式</p><ul><li>AT 模式支持 MySQL、Oracle、PostgreSQL、MariaDB、TiDB。</li></ul></li><li><p>TCC 模式</p><ul><li>TCC 模式不依赖数据源（Seata <code>1.4.2</code> 版本及之前）</li><li>在 Seata <code>1.4.2</code> 版本之后增加了 TCC 防悬挂措施，需要数据源支持</li></ul></li><li><p> Saga 模式</p><ul><li>Saga 模式不依赖数据源。</li></ul></li><li><p>XA 模式</p><ul><li>XA 模式只支持实现了 XA 协议的数据库</li><li>比如，XA 模式支持 MySQL、Oracle、PostgreSQL、MariaDB</li></ul></li></ul><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a target="_blank" rel="external nofollow" href="https://seata.apache.org/zh-cn/docs/user/mode/at/">Seata 官方文档 - 事务模式</a></li></ul><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/84d3f3e6.html" title="Seata 入门教程 - 中级篇（2020 年）">https://www.techgrow.cn/posts/84d3f3e6.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="fa fa-tag"></i> 微服务</a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag"><i class="fa fa-tag"></i> 分布式</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/e8b71fbe.html" rel="prev" title="Seata 入门教程 - 基础篇（2020 年）"><i class="fa fa-angle-left"></i> Seata 入门教程 - 基础篇（2020 年）</a></div><div class="post-nav-item"> <a href="/posts/b0f7bd00.html" rel="next" title="Seata 入门教程 - 实战篇（2020 年）">Seata 入门教程 - 实战篇（2020 年）<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">2.1m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">31:43</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/84d3f3e6.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>