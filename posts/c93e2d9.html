<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍如何在 Linux 环境中，HaProxy 如何利用 Keepalived 实现双机热备（即双机主备），从而保证高可用性。"><meta property="og:type" content="article"><meta property="og:title" content="HaProxy 与 Keepalived 实现双机热备高可用"><meta property="og:url" content="https://www.techgrow.cn/posts/c93e2d9.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍如何在 Linux 环境中，HaProxy 如何利用 Keepalived 实现双机热备（即双机主备），从而保证高可用性。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/11/haproxy-ha-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/11/haproxy-ha-2.png"><meta property="article:published_time" content="2019-05-15T11:50:21.000Z"><meta property="article:modified_time" content="2025-11-08T11:50:21.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="Linux运维"><meta property="article:tag" content="Web服务器"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2025/11/haproxy-ha-1.png"><link rel="canonical" href="https://www.techgrow.cn/posts/c93e2d9.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/c93e2d9.html","path":"posts/c93e2d9.html","title":"HaProxy 与 Keepalived 实现双机热备高可用"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>HaProxy 与 Keepalived 实现双机热备高可用 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-text">准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="nav-text">整体架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E8%A7%84%E5%88%92"><span class="nav-text">部署规划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99"><span class="nav-text">关闭防火墙</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-HaProxy"><span class="nav-text">安装 HaProxy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%A6%82%E8%BF%B0"><span class="nav-text">安装概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4"><span class="nav-text">安装步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7"><span class="nav-text">创建用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1"><span class="nav-text">配置服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="nav-text">启动服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E6%9C%8D%E5%8A%A1"><span class="nav-text">验证服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-Keepalived"><span class="nav-text">安装 Keepalived</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%A6%82%E8%BF%B0-1"><span class="nav-text">安装概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4-1"><span class="nav-text">安装步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%84%9A%E6%9C%AC"><span class="nav-text">创建脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1-1"><span class="nav-text">配置服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1-1"><span class="nav-text">启动服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7"><span class="nav-text">验证高可用性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">756</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">54</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/c93e2d9.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="HaProxy 与 Keepalived 实现双机热备高可用 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍如何在 Linux 环境中，HaProxy 如何利用 Keepalived 实现双机热备（即双机主备），从而保证高可用性。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> HaProxy 与 Keepalived 实现双机热备高可用</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-05-15 19:50:21" itemprop="dateCreated datePublished" datetime="2019-05-15T19:50:21+08:00">2019-05-15</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2025-11-08 19:50:21" itemprop="dateModified" datetime="2025-11-08T19:50:21+08:00">2025-11-08</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/c93e2d9.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/c93e2d9.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>5.4k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>5 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文将介绍在 Linux 环境中，HaProxy 如何利用 Keepalived 实现双机热备（即双机主备），从而保证其高可用性，适用于 CentOS、Debian、Ubuntu 等 Linux 发行版。</p><span id="more"></span><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h3><p>由于本文重点在于介绍 HAProxy + Keepalived 实现双机主备（即双机热备），因此下图中 HAProxy 针对后端 Web 服务（例如 Kubernetes API Server）的反向代理配置将不再展开详细介绍。</p><p><img data-src="../../../asset/2025/11/haproxy-ha-1.png"></p><h3 id="部署规划"><a href="#部署规划" class="headerlink" title="部署规划"></a>部署规划</h3><table><thead><tr><th>节点</th><th>名称</th><th>角色</th><th> IP</th><th> 备注</th></tr></thead><tbody><tr><td>节点一</td><td> node1</td><td>Master</td><td><code>192.168.2.191</code></td><td>安装 HaProxy、Keepalived</td></tr><tr><td> 节点二</td><td> node2</td><td>Backup</td><td><code>192.168.2.148</code></td><td>安装 HaProxy、Keepalived</td></tr></tbody></table><div class="admonition note"><p class="admonition-title">虚拟 IP（VIP）的说明</p><ul><li>虚拟 IP（VIP）由 Keepalived 提供。</li><li>在配置 Keepalived 的 <code>virtual_ipaddress</code> 参数时，所指定的 VIP 地址必须与 HaProxy 所在节点处于同一网段。</li><li>例如，如果两个 HaProxy 节点的网段为 <code>192.168.2.0/24</code>，则 VIP 也应设置为该网段内的地址（如 <code>192.168.2.x</code>）。</li></ul></div><h3 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h3><p>关闭系统防火墙，避免 Keepalived 主备节点之间无法正常通信</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 临时关闭</span></span><br><span class="line"><span class="keyword"># systemctl</span> stop firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 永久关闭</span></span><br><span class="line"><span class="keyword"># systemctl</span> <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></tbody></table></figure><p>若不希望关闭防火墙，则需要开放以下防火墙端口，尤其是 Keepalived 的 <code>112</code>（VRRP）端口</p><table><thead><tr><th>组件</th><th>协议 / 端口</th><th>是否必须开放</th><th>作用</th></tr></thead><tbody><tr><td> Keepalived</td><td>IP 协议号 <code>112</code>（VRRP）</td><td>必须</td><td> VRRP 主备心跳</td></tr><tr><td> HaProxy</td><td>TCP <code>80</code></td><td>可选</td><td>代理 HTTP 服务</td></tr><tr><td> HaProxy</td><td>TCP <code>443</code></td><td>可选</td><td>代理 HTTPS 服务</td></tr><tr><td> HaProxy Stats</td><td>TCP <code>1080</code>（可自定义）</td><td>可选</td><td>访问 HAProxy 的统计页面</td></tr></tbody></table><h2 id="安装-HaProxy"><a href="#安装-HaProxy" class="headerlink" title="安装 HaProxy"></a>安装 HaProxy</h2><div class="admonition warning"><p class="admonition-title">特别注意</p><ul><li><strong>在两个节点上，分别编译安装 HaProxy，这两个节点上的 HaProxy 配置文件是完全相同的</strong>。</li></ul></div><h3 id="安装概述"><a href="#安装概述" class="headerlink" title="安装概述"></a>安装概述</h3><table><thead><tr><th>安装说明</th><th>路径</th></tr></thead><tbody><tr><td> HaProxy 的安装路径</td><td><code>/usr/local/sbin/haproxy</code></td></tr><tr><td>HaProxy 的配置文件</td><td><code>/etc/haproxy/haproxy.cfg</code></td></tr><tr><td>HaProxy 的 PID 文件</td><td><code>/var/lib/haproxy/haproxy.pid</code></td></tr><tr><td>HaProxy 的 Socket 文件</td><td><code>/var/lib/haproxy/stats</code></td></tr><tr><td>HaProxy 的 Systemd 服务配置文件</td><td><code>/usr/lib/systemd/system/haproxy.service</code></td></tr></tbody></table><h3 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h3><p>安装依赖软件包</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword"># CentOS</span>系统安装软件包</span><br><span class="line"><span class="keyword"># yum</span> install<span class="params"> -y</span> gcc make pcre-devel openssl openssl-devel systemd-devel wget</span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"># Debian</span>、Ubuntu系统安装软件包</span><br><span class="line"><span class="keyword"># apt</span> install<span class="params"> -y</span> gcc make libpcre3-dev openssl libssl-dev libsystemd-dev wget</span><br></pre></td></tr></tbody></table></figure><p>下载 HaProxy 源码包（<a target="_blank" rel="external nofollow" href="https://www.haproxy.org/download">官网下载地址</a>）</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载源码包</span></span><br><span class="line"><span class="keyword"># wget</span> https://www.haproxy.org/download/2.8/src/haproxy-2.8.5.tar.gz</span><br></pre></td></tr></tbody></table></figure><p>下载 HaProxy 源码包</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解压源码包</span></span><br><span class="line"><span class="keyword"># tar</span><span class="params"> -xvf</span> haproxy-2.8.5.tar.gz</span><br></pre></td></tr></tbody></table></figure><p>编译源码与安装</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入源码包的解压目录</span></span><br><span class="line"><span class="keyword"># cd</span> haproxy-2.8.5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译源码</span></span><br><span class="line"><span class="keyword"># make</span> TARGET=linux-glibc \</span><br><span class="line">     USE_OPENSSL=1 \</span><br><span class="line">     USE_PCRE=1 \</span><br><span class="line">     USE_SYSTEMD=1 \</span><br><span class="line">     USE_ZLIB=1 \<span class="params"></span></span><br><span class="line"><span class="params">     -j</span>$(nproc)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line"><span class="keyword"># make</span> install</span><br></pre></td></tr></tbody></table></figure><h3 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h3><p>创建 HaProxy 用户与用户组</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建用户组</span></span><br><span class="line"><span class="keyword"># groupadd</span><span class="params"> --system</span> haproxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户（禁止登录）</span></span><br><span class="line"><span class="keyword"># sudo</span> useradd<span class="params"> --system</span><span class="params"> --no</span>-create-home<span class="params"> --shell</span> /sbin/nologin<span class="params"> --gid</span> haproxy haproxy</span><br></pre></td></tr></tbody></table></figure><h3 id="配置服务"><a href="#配置服务" class="headerlink" title="配置服务"></a>配置服务</h3><p>配置 Systemd 管理 HaProxy 服务</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建系统配置文件，添加以下配置内容</span></span><br><span class="line"><span class="keyword"># vim</span> /usr/lib/systemd/system/haproxy.service</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=HAProxy Load Balancer</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=haproxy</span><br><span class="line">Group=haproxy</span><br><span class="line">LimitNOFILE=1048576</span><br><span class="line">Environment="CONFIG=/etc/haproxy/haproxy.cfg" "PIDFILE=/var/lib/haproxy/haproxy.pid"</span><br><span class="line">ExecStartPre=/usr/local/sbin/haproxy -f $CONFIG -c -q</span><br><span class="line">ExecStart=/usr/local/sbin/haproxy -Ws -f $CONFIG -p $PIDFILE</span><br><span class="line">ExecReload=/bin/kill -USR2 $MAINPID</span><br><span class="line">KillMode=mixed</span><br><span class="line">Type=notify</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></tbody></table></figure><hr><p>创建 HaProxy 的运行目录</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建运行目录</span></span><br><span class="line"><span class="keyword"># mkdir</span><span class="params"> -p</span> /var/lib/haproxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更改运行目录的所有者</span></span><br><span class="line"><span class="keyword"># chown</span><span class="params"> -R</span> haproxy:haproxy /var/lib/haproxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置运行目录的权限</span></span><br><span class="line"><span class="keyword"># chmod</span> 750 /var/lib/haproxy</span><br></pre></td></tr></tbody></table></figure><p>创建 HaProxy 的配置目录</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建配置目录</span></span><br><span class="line"><span class="keyword"># mkdir</span><span class="params"> -p</span> /etc/haproxy</span><br></pre></td></tr></tbody></table></figure><p>创建 HaProxy 的配置文件</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建配置文件，添加以下配置内容</span></span><br><span class="line"><span class="keyword"># vim</span> /etc/haproxy/haproxy.cfg</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># Global settings</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line">global</span><br><span class="line">    # to have these messages end up in /var/log/haproxy.log you will</span><br><span class="line">    # need to:</span><br><span class="line">    # 1) configure syslog to accept network log events.  This is done</span><br><span class="line">    #    by adding the '-r' option to the SYSLOGD_OPTIONS in</span><br><span class="line">    #    /etc/sysconfig/syslog</span><br><span class="line">    # 2) configure local2 events to go to the /var/log/haproxy.log</span><br><span class="line">    #   file. A line like the following can be added to</span><br><span class="line">    #   /etc/sysconfig/syslog</span><br><span class="line">    #</span><br><span class="line">    #    local2.*                       /var/log/haproxy.log</span><br><span class="line">    #</span><br><span class="line">    log         127.0.0.1 local2</span><br><span class="line">    </span><br><span class="line">    # chroot      /var/lib/haproxy</span><br><span class="line">    # pidfile     /var/run/haproxy.pid</span><br><span class="line">    # user        haproxy</span><br><span class="line">    # group       haproxy</span><br><span class="line">    maxconn     4000</span><br><span class="line">    nbthread    4</span><br><span class="line">    # nbproc    1</span><br><span class="line">    # daemon</span><br><span class="line">       </span><br><span class="line">    # turn on stats unix socket</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line"></span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># common defaults that all the 'listen' and 'backend' sections will</span><br><span class="line"># use if not designated in their block</span><br><span class="line">#---------------------------------------------------------------------  </span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    log                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line">    maxconn                 3000</span><br><span class="line"></span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># collection haproxy statistics message</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line">listen stats</span><br><span class="line">    bind                 *:1080</span><br><span class="line">    stats auth           admin:admin</span><br><span class="line">    stats refresh        5s</span><br><span class="line">    stats realm          HAProxy\ Statistics</span><br><span class="line">    stats uri            /admin?stats</span><br></pre></td></tr></tbody></table></figure><p>HaProxy 配置文件的使用说明</p><table><thead><tr><th>配置项</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>maxconn</code></td><td>全局 / 前端 / 后端</td><td><code>2000</code></td><td>最大连接数，控制 HAProxy 可以同时处理的并发连接数。</td></tr><tr><td><code>nbthread</code></td><td>全局</td><td><code>1</code></td><td>指定每个进程使用的线程数。多线程模式可提高单进程并发性能。</td></tr><tr><td><code>nbproc</code></td><td>全局</td><td><code>1</code></td><td>指定 HAProxy 启动的进程数。多进程模式用于多核优化，但 Systemd 下不推荐与 <code>daemon</code> 配合使用。</td></tr><tr><td><code>daemon</code></td><td>全局</td><td>禁用</td><td>是否后台运行。Systemd 管理 HaProxy 时通常禁用，HAProxy 由 Systemd 控制前后台。</td></tr><tr><td><code>mode</code></td><td>defaults/frontend/backend</td><td><code>http</code></td><td>连接模式，可选 <code>http</code> 或 <code>tcp</code>。可以使用 <code>tcp</code> 来实现 Kubernetes API Server 代理。</td></tr><tr><td><code>balance</code></td><td>backend</td><td><code>roundrobin</code></td><td>负载均衡算法，可选 <code>roundrobin</code>、<code>leastconn</code>、<code>source</code> 等。</td></tr><tr><td><code>stats auth</code></td><td>listen</td><td></td><td> 设置统计页面认证用户名和密码，例如 <code>admin:admin</code>。</td></tr><tr><td><code>stats refresh</code></td><td>listen</td><td><code>10s</code></td><td>统计页面刷新时间，单位秒。</td></tr><tr><td><code>stats realm</code></td><td>listen</td><td></td><td>HTTP Basic Auth 的 <code>realm</code> 名称，显示在认证弹窗中。</td></tr><tr><td><code>stats uri</code></td><td>listen</td><td><code>/</code></td><td>HaProxy 统计页面访问 URI，例如 <code>/admin?stats</code>。</td></tr></tbody></table><div class="admonition note"><p class="admonition-title">Haproxy 的配置建议</p><ul><li><code>maxconn</code> + <code>nbthread</code> 可以提升单进程并发性能。</li><li><code>mode tcp</code> 是代理 Kubernetes API Server 的标准配置，因为 API Server 是 HTTPS / TCP 流量。</li><li>当使用 Systemd 管理 HaProxy 时，建议配置 <strong><code>nbproc = 1</code> + <code>nbthread &gt; 1</code> + 不启用 daemon</strong>，这是最稳定和高效的配置方式。</li></ul></div><hr><p>若 HaProxy 需要对后端 Web 服务（例如 Kubernetes API Server）进行反向代理，可以在上述 HaProxy 配置内容的基础上，再添加以下内容（<strong>请根据实际业务进行更改</strong>），完整的配置案例可以看 <a href="/posts/fb1a55bb.html#%E9%83%A8%E7%BD%B2-Keepalived">这里</a></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># kubernetes apiserver frontend which proxys to the backends</span><br><span class="line">#--------------------------------------------------------------------- </span><br><span class="line">frontend kubernetes-apiserver</span><br><span class="line">    mode                 tcp</span><br><span class="line">    bind                 *:16443</span><br><span class="line">    option               tcplog</span><br><span class="line">    default_backend      kubernetes-apiserver    </span><br><span class="line"></span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># round robin balancing between the various backends</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line">backend kubernetes-apiserver</span><br><span class="line">    mode        tcp</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      master01.k8s.io   192.168.2.191:6443 check</span><br><span class="line">    server      master02.k8s.io   192.168.2.148:6443 check</span><br></pre></td></tr></tbody></table></figure><p>HaProxy 加上反向代理的配置后，就可以通过 <code>http://&lt;node-ip&gt;:16443</code> 来访问后端的多个 Web 服务</p><h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><p>设置开机自启动 HaProxy 服务</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新系统配置</span></span><br><span class="line"><span class="keyword"># systemctl</span> daemon-reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机自启动HaProxy</span></span><br><span class="line"><span class="keyword"># systemctl</span> <span class="built_in">enable</span> haproxy</span><br></pre></td></tr></tbody></table></figure><p>立刻启动 HaProxy 服务</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动HaProxy</span></span><br><span class="line"><span class="keyword"># systemctl</span> start haproxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看HaProxy的运行状态</span></span><br><span class="line"><span class="keyword"># systemctl</span> status haproxy</span><br></pre></td></tr></tbody></table></figure><p>当 HaProxy 的配置文件发生变更后，可以执行热加载（也叫平滑重载，不会中断现有连接），让配置文件生效</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 热加载HaProxy配置文件</span></span><br><span class="line"><span class="keyword"># systemctl</span> reload haproxy</span><br></pre></td></tr></tbody></table></figure><h3 id="验证服务"><a href="#验证服务" class="headerlink" title="验证服务"></a>验证服务</h3><p>浏览器通过 <code>http://&lt;node-ip&gt;:1080/admin?stats</code> 访问 HaProxy 的统计页面，默认的登录用户名和密码是 <code>admin / admin</code>；如果可以正常访问（如下图所示），则说明 HaProxy 可以正常运行</p><p><img data-src="../../../asset/2025/11/haproxy-ha-2.png"></p><h2 id="安装-Keepalived"><a href="#安装-Keepalived" class="headerlink" title="安装 Keepalived"></a>安装 Keepalived</h2><div class="admonition warning"><p class="admonition-title">特别注意</p><ul><li><strong>在两个节点上，分别安装 Keepalived，这两个节点上的 Keepalived 配置文件是不一样的。</strong></li></ul></div><h3 id="安装概述-1"><a href="#安装概述-1" class="headerlink" title="安装概述"></a>安装概述</h3><ul><li>Keepalived 是一个高可用软件，基于 VIP 绑定实现服务器双机主备（也叫双机热备），在上述拓扑中，Keepalived 主要根据 HaProxy 的运行状态判断是否需要故障转移（VIP 切换）。</li><li>例如，当 HaProxy 主节点挂掉，VIP 会自动绑定在 HaProxy 备节点，从而保证 VIP 一直可用，实现 HaProxy 高可用。</li></ul><table><thead><tr><th>安装说明</th><th>路径</th></tr></thead><tbody><tr><td> Keepalived 的安装路径</td><td><code>/usr/local/keepalived</code></td></tr><tr><td>Keepalived 的配置文件</td><td><code>/usr/local/keepalived/etc/keepalived/keepalived.conf</code></td></tr><tr><td>Keepalived 的 Systemd 服务配置文件（自动生成）</td><td><code>/usr/lib/systemd/system/keepalived.service</code></td></tr><tr><td>Keepalived 检测 HaProxy 是否可用的 Shell 脚本</td><td><code>/usr/local/keepalived/etc/keepalived/scripts/haproxy_check.sh</code></td></tr></tbody></table><h3 id="安装步骤-1"><a href="#安装步骤-1" class="headerlink" title="安装步骤"></a>安装步骤</h3><p>安装依赖软件包</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword"># CentOS</span>系统安装软件包</span><br><span class="line"><span class="keyword"># yum</span> install<span class="params"> -y</span> gcc gcc-c++ make openssl-devel libnl libnl-devel net-snmp-devel popt-devel</span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"># Debian</span>、Ubuntu系统安装软件包</span><br><span class="line"><span class="keyword"># apt</span> install<span class="params"> -y</span> gcc g++ make libssl-dev libnl-3-dev libnl-genl-3-dev libsnmp-dev libpopt-dev</span><br></pre></td></tr></tbody></table></figure><p>下载 Keepalived 源码包（<a target="_blank" rel="external nofollow" href="https://www.keepalived.org/download.html">官网下载地址</a>）</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载源码包</span></span><br><span class="line"><span class="keyword"># wget</span> https://www.keepalived.org/software/keepalived-2.2.8.tar.gz</span><br></pre></td></tr></tbody></table></figure><p>解压 Keepalived 源码包</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解压源码包</span></span><br><span class="line"><span class="keyword"># tar</span><span class="params"> -xvf</span> keepalived-2.2.8.tar.gz</span><br></pre></td></tr></tbody></table></figure><p>编译源码与安装</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入源码包的解压目录</span></span><br><span class="line"><span class="keyword"># cd</span> keepalived-2.2.8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成构建文件（Makefile）</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/keepalived</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译源码</span></span><br><span class="line"><span class="keyword"># make</span><span class="params"> -j</span>$(nproc)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line"><span class="keyword"># make</span> install</span><br></pre></td></tr></tbody></table></figure><h3 id="创建脚本"><a href="#创建脚本" class="headerlink" title="创建脚本"></a>创建脚本</h3><p>创建用于 Keepalived 检测 HaProxy 服务是否可用的 Shell 脚本（比如 <code>haproxy_check.sh</code>）</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建存放检测脚本的目录</span></span><br><span class="line"><span class="keyword"># mkdir</span><span class="params"> -p</span> /usr/<span class="built_in">local</span>/keepalived/etc/keepalived/scripts/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建检测脚本，并写入以下脚本内容</span></span><br><span class="line"><span class="keyword"># vim</span> /usr/<span class="built_in">local</span>/keepalived/etc/keepalived/scripts/haproxy_check.sh</span><br></pre></td></tr></tbody></table></figure><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取HaProxy进程数量</span></span><br><span class="line">HAPROXY_COUNT=$(pgrep<span class="params"> -x</span> haproxy | wc<span class="params"> -l</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果没有HaProxy进程，则返回非 0，Keepalived 会认为节点失效</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$HAPROXY_COUNT</span>"</span><span class="params"> -eq</span> 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"HAProxy not running"</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"HAProxy running"</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></tbody></table></figure><p>授予 HaProxy 检测脚本可执行权限</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 脚本授权</span></span><br><span class="line"><span class="keyword"># chmod</span> +x /usr/<span class="built_in">local</span>/keepalived/etc/keepalived/scripts/haproxy_check.sh</span><br></pre></td></tr></tbody></table></figure><h3 id="配置服务-1"><a href="#配置服务-1" class="headerlink" title="配置服务"></a>配置服务</h3><blockquote><p>Keepalived 配置文件的使用说明</p></blockquote><table><thead><tr><th>配置项</th><th>示例值</th><th>说明</th></tr></thead><tbody><tr><td><code>router_id</code></td><td><code>k8s</code></td><td>本节点唯一标识，用于日志区分（不同节点可不同）。</td></tr><tr><td><code>script</code></td><td><code>"killall -0 haproxy"</code></td><td>检测 HAProxy 服务是否可用，可以是 Shell 命令，还可以是 Shell 脚本的绝对路径。返回 0 表示正常，返回非 0 表示失败。</td></tr><tr><td><code>interval</code></td><td><code>2</code></td><td>检测脚本执行间隔（秒），指定 Keepalived 多久执行一次健康检查脚本。</td></tr><tr><td><code>weight</code></td><td><code>-100</code></td><td>节点权重变化值，检测脚本失败时降低优先级或成功时增加优先级。负值表示降低权重，正值表示增加权重。</td></tr><tr><td><code>fall</code></td><td><code>3</code></td><td>连续失败次数阈值，当检测脚本连续失败次数达到 <code>fall</code> 时，节点会认为服务不可用，并扣减权重或触发 VIP 切换。</td></tr><tr><td><code>rise</code></td><td><code>2</code></td><td>连续成功次数阈值，当检测脚本连续成功次数达到 <code>rise</code> 时，节点会认为服务恢复，并恢复权重初始值。</td></tr><tr><td><code>state</code></td><td><code>MASTER</code></td><td>节点初始角色（<code>MASTER</code> 或 <code>BACKUP</code>），最终由优先级决定。</td></tr><tr><td><code>interface</code></td><td><code>enp0s3</code></td><td>VRRP 使用的网络接口名称，可通过 <code>ifconfig</code> 命令得知。</td></tr><tr><td><code>virtual_router_id</code></td><td><code>51</code></td><td>VRRP 组 ID，两个节点必须一致。</td></tr><tr><td><code>priority</code></td><td><code>200</code></td><td>节点优先级（权重），数值越大优先级越高。</td></tr><tr><td><code>advert_int</code></td><td><code>1</code></td><td>VRRP 心跳间隔（秒），默认 1 秒。</td></tr><tr><td><code>auth_type</code></td><td><code>PASS</code></td><td>VRRP 认证方式（<code>PASS</code> 或 <code>AH</code>）。</td></tr><tr><td><code>auth_pass</code></td><td><code>ceb1b3ec013d66163d6ab</code></td><td>VRRP 认证密码，两个节点必须一致。</td></tr><tr><td><code>virtual_ipaddress</code></td><td><code>192.168.2.100</code></td><td>Keepalived 提供的 VIP（虚拟 IP），由 <code>MASTER</code> 持有。</td></tr><tr><td><code>track_script</code></td><td><code>check_haproxy</code></td><td>指定用于健康检查的脚本，检测失败时会调节点整权重或触发 VIP 切换。</td></tr></tbody></table><div class="admonition warning"><p class="admonition-title">Keepalived 什么时候触发 VIP 切换</p><ul><li>Keepalived 的 VIP 切换依赖节点权重变化，只有当 <code>MASTER</code> 节点的实时权重下降到低于 <code>BACKUP</code> 节点时，VIP 才会切换到权重更高的节点。</li><li>在 Keepalived 配置文件中，<code>vrrp_script</code> 可以通过 <code>weight</code> 动态调整节点权重：正值会增加节点权重，负值会降低节点权重。</li><li>当 Keepalived 脚本检测失败时，节点权重会根据 <code>weight</code> 设置下降，如果下降后 <code>MASTER</code> 节点的权重低于 <code>BACKUP</code> 节点，VIP 就会切换。</li><li>当 Keepalived 脚本检测成功时，且连续检测成功的次数达到 <code>rise</code> 次后，节点权重会恢复为初始值，原 <code>MASTER</code> 节点可能会重新成为 <code>MASTER</code>。</li><li><strong>Keepalived 的 <code>weight</code> 必须设置足够大，否则即使 Keepalived 脚本检测失败，<code>MASTER</code> 节点的权重仍可能比 <code>BACKUP</code> 节点高，从而导致不会触发 VIP 切换。</strong></li></ul></div><div class="admonition warning"><p class="admonition-title">Keepalived 调整节点权重的细节</p><ul><li>Keepalived 不会因为检测脚本持续失败而反复扣减节点权重，只有当检测脚本的检测结果从 "成功" 变为 "失败" 时，才会触发一次节点权重扣减。</li><li>也就是说，第一次检测被判定为失败，会执行一次 <code>weight</code> 扣减；当后续检测脚本继续失败时，由于节点已经处于失败状态，不会再重复扣减节点权重。</li><li>当检测脚本恢复成功后，Keepalived 会依据 <code>rise</code> 参数进行节点权重恢复。当检测脚本连续成功达到 <code>rise</code> 次后，节点权重会恢复到初始值。</li><li><strong>简而言之，Keepalived 的节点权重扣减是一次性的，直到检测脚本恢复成功，才再次生效</strong>。同样的，在节点处于健康状态期间，检测脚本即便持续成功，也不会重复增加节点权重。</li></ul></div><blockquote><p>在<strong>第一个节点</strong>（比如 <code>node1</code>）中，创建 Keepalived 的配置文件，<strong>请自行更改 <code>interface</code>（网卡接口名称）与 <code>virtual_ipaddress</code>（虚拟 IP）配置项</strong></p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建配置文件，写入以下配置内容</span></span><br><span class="line"><span class="keyword"># vim</span> /usr/<span class="built_in">local</span>/keepalived/etc/keepalived/keepalived.conf</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs {</span><br><span class="line">    router_id k8s</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vrrp_script check_haproxy {</span><br><span class="line">    script "/usr/local/keepalived/etc/keepalived/scripts/haproxy_check.sh"</span><br><span class="line">    interval 2</span><br><span class="line">    weight -100</span><br><span class="line">    fall 3</span><br><span class="line">    rise 2</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 {</span><br><span class="line">    state MASTER</span><br><span class="line">    interface enp0s3</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 250</span><br><span class="line">    advert_int 1</span><br><span class="line"></span><br><span class="line">    authentication {</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass ceb1b3ec013d66163d6ab</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    virtual_ipaddress {</span><br><span class="line">        192.168.2.100</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    track_script {</span><br><span class="line">        check_haproxy</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><blockquote><p>在<strong>第二个节点</strong>（比如 <code>node2</code>）中，创建 Keepalived 的配置文件，<strong>请自行更改 <code>interface</code>（网卡接口名称）与 <code>virtual_ipaddress</code>（虚拟 IP）配置项</strong></p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建配置文件，写入以下配置内容</span></span><br><span class="line"><span class="keyword"># vim</span> /usr/<span class="built_in">local</span>/keepalived/etc/keepalived/keepalived.conf</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs {</span><br><span class="line">    router_id k8s</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vrrp_script check_haproxy {</span><br><span class="line">    script "/usr/local/keepalived/etc/keepalived/scripts/haproxy_check.sh"</span><br><span class="line">    interval 2</span><br><span class="line">    weight -100</span><br><span class="line">    fall 3</span><br><span class="line">    rise 2</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 {</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface enp0s3</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 200</span><br><span class="line">    advert_int 1</span><br><span class="line"></span><br><span class="line">    authentication {</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass ceb1b3ec013d66163d6ab</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    virtual_ipaddress {</span><br><span class="line">        192.168.2.100</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    track_script {</span><br><span class="line">        check_haproxy</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="启动服务-1"><a href="#启动服务-1" class="headerlink" title="启动服务"></a>启动服务</h3><p>设置开机自启动 Keepalived 服务</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新系统配置</span></span><br><span class="line"><span class="keyword"># systemctl</span> daemon-reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机自启动Keepalived</span></span><br><span class="line"><span class="keyword"># systemctl</span> <span class="built_in">enable</span> keepalived</span><br></pre></td></tr></tbody></table></figure><p>立刻启动 Keepalived 服务</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动Keepalived</span></span><br><span class="line"><span class="keyword"># systemctl</span> start keepalived</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Keepalived的运行状态</span></span><br><span class="line"><span class="keyword"># systemctl</span> status keepalived</span><br></pre></td></tr></tbody></table></figure><p>当 Keepalived 的配置文件发生变更后，可以重启服务让其生效</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重启Keepalived</span></span><br><span class="line"><span class="keyword"># systemctl</span> restart keepalived</span><br></pre></td></tr></tbody></table></figure><h2 id="验证高可用性"><a href="#验证高可用性" class="headerlink" title="验证高可用性"></a>验证高可用性</h2><div class="admonition note"><p class="admonition-title">验证目标</p><p>本节旨在验证 HaProxy + Keepalived 是否能够实现双机主备（即双机热备）高可用机制。具体而言，当第一个 Master 节点上的 HaProxy 发生宕机时，Keepalived 能够将虚拟 IP（VIP）自动切换到第二个 Master 节点上。当第一个 Master 节点上的 HaProxy 恢复运行时，虚拟 IP（VIP）会自动切换回第一个 Master 节点上。</p></div><ul><li>(1) 在第一个节点（比如 <code>node1</code>）中，查看指定网卡（比如 <code>enp0s3</code>）的详细 IP 地址与状态信息，<strong>请自行更改网卡接口名称</strong></li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看网卡的详细信息</span></span><br><span class="line"><span class="keyword"># ip</span> a s enp0s3</span><br></pre></td></tr></tbody></table></figure><p>输出示例如下，可以看到 VIP（虚拟 IP）地址 <code>192.168.2.100</code> 绑定了网卡接口 <code>enp0s3</code></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 08:00:27:de:6f:6b brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.2.191/24 brd 192.168.2.255 scope global noprefixroute dynamic enp0s3</span><br><span class="line">       valid_lft 42617sec preferred_lft 42617sec</span><br><span class="line">    inet 192.168.2.100/32 scope global enp0s3</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::8b9e:77d3:4d79:eab9/64 scope link tentative noprefixroute dadfailed </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::6c1a:25c4:bdbd:dad3/64 scope link tentative noprefixroute dadfailed </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::8dee:f54a:fcd2:369b/64 scope link tentative noprefixroute dadfailed </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></tbody></table></figure><ul><li>(2) 在第一个节点（比如 <code>node1</code>）中，关闭 HaProxy 服务，并查看 Keepalived 的运行状态</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭Haproxy</span></span><br><span class="line"><span class="keyword"># systemctl</span> stop haproxy</span><br></pre></td></tr></tbody></table></figure><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看Keepalived的运行状态</span></span><br><span class="line"><span class="keyword"># systemctl</span> status keepalived</span><br></pre></td></tr></tbody></table></figure><p>输出示例如下，可以看到 Keepalived 扣减了当前节点的权重（计算公式：<code>250 - 100 = 150</code>），同时 VIP 也被移除了</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">11月 08 14:14:40 node1 Keepalived_vrrp[30483]: Sending gratuitous ARP on enp0s3 for 192.168.2.100</span><br><span class="line">11月 08 14:14:40 node1 Keepalived_vrrp[30483]: Sending gratuitous ARP on enp0s3 for 192.168.2.100</span><br><span class="line">11月 08 14:18:02 node1 Keepalived_vrrp[30483]: Script `check_haproxy` now returning 1</span><br><span class="line">11月 08 14:18:06 node1 Keepalived_vrrp[30483]: VRRP_Script(check_haproxy) failed (exited with status 1)</span><br><span class="line">11月 08 14:18:06 node1 Keepalived_vrrp[30483]: (VI_1) Changing effective priority from 250 to 150</span><br><span class="line">11月 08 14:18:09 node1 Keepalived_vrrp[30483]: (VI_1) Master received advert from 192.168.2.148 with higher priority 200, ours 150</span><br><span class="line">11月 08 14:18:09 node1 Keepalived_vrrp[30483]: (VI_1) Entering BACKUP STATE</span><br><span class="line">11月 08 14:18:09 node1 Keepalived_vrrp[30483]: (VI_1) removing VIPs.</span><br></pre></td></tr></tbody></table></figure><ul><li>(3) 在第二个节点（比如 <code>node2</code>）中，查看指定网卡（比如 <code>enp0s3</code>）的详细 IP 地址与状态信息，<strong>请自行更改网卡接口名称</strong></li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看网卡的详细信息</span></span><br><span class="line"><span class="keyword"># ip</span> a s enp0s3</span><br></pre></td></tr></tbody></table></figure><p>输出示例如下，可以看到 VIP（虚拟 IP）地址 <code>192.168.2.100</code> 绑定了网卡接口 <code>enp0s3</code>，也就是 VIP 成功切换到 <code>BACKUP</code> 节点</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 08:00:27:78:05:48 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.2.148/24 brd 192.168.2.255 scope global noprefixroute dynamic enp0s3</span><br><span class="line">       valid_lft 41406sec preferred_lft 41406sec</span><br><span class="line">    inet 192.168.2.100/32 scope global enp0s3</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::8b9e:77d3:4d79:eab9/64 scope link tentative noprefixroute dadfailed </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::6c1a:25c4:bdbd:dad3/64 scope link tentative noprefixroute dadfailed </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::8dee:f54a:fcd2:369b/64 scope link tentative noprefixroute dadfailed </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></tbody></table></figure><ul><li>(4) 在第一个 Master 节点（比如 <code>node1</code>）中，重新启动 HaProxy 服务，并查看指定网卡（比如 <code>enp0s3</code>）的详细 IP 地址与状态信息，<strong>请自行更改网卡接口名称</strong></li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动Haproxy</span></span><br><span class="line"><span class="keyword"># systemctl</span> start haproxy</span><br></pre></td></tr></tbody></table></figure><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看网卡的详细信息</span></span><br><span class="line"><span class="keyword"># ip</span> a s enp0s3</span><br></pre></td></tr></tbody></table></figure><p>输出示例如下，可以看到 VIP（虚拟 IP）地址 <code>192.168.2.100</code> 又绑定了网卡接口 <code>enp0s3</code>，也就是 VIP 再次切换回 <code>MASTER</code> 节点</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 08:00:27:de:6f:6b brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.2.191/24 brd 192.168.2.255 scope global noprefixroute dynamic enp0s3</span><br><span class="line">       valid_lft 42617sec preferred_lft 42617sec</span><br><span class="line">    inet 192.168.2.100/32 scope global enp0s3</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::8b9e:77d3:4d79:eab9/64 scope link tentative noprefixroute dadfailed </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::6c1a:25c4:bdbd:dad3/64 scope link tentative noprefixroute dadfailed </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::8dee:f54a:fcd2:369b/64 scope link tentative noprefixroute dadfailed </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></tbody></table></figure><p>此时，若再次在第一个 Master 节点（比如 <code>node1</code>）中查看 Keepalived 的运行状态，可以看到 Keepalived 将当前节点的权重恢复为初始值，输出示例如下</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">11月 08 14:23:49 node1 Keepalived_vrrp[30483]: VRRP_Script(check_haproxy) succeeded</span><br><span class="line">11月 08 14:23:49 node1 Keepalived_vrrp[30483]: (VI_1) Changing effective priority from 150 to 250</span><br><span class="line">11月 08 14:23:52 node1 Keepalived_vrrp[30483]: Sending gratuitous ARP on enp0s3 for 192.168.2.100</span><br><span class="line">11月 08 14:23:52 node1 Keepalived_vrrp[30483]: Sending gratuitous ARP on enp0s3 for 192.168.2.100</span><br><span class="line">11月 08 14:23:52 node1 Keepalived_vrrp[30483]: Sending gratuitous ARP on enp0s3 for 192.168.2.100</span><br></pre></td></tr></tbody></table></figure><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="/posts/e6d17f23.html">Linux 生产环境安装 HaProxy</a></li><li><a href="/posts/503c34e4.html">Nginx + Keepalived 实现双机主备高可用</a></li></ul><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/c93e2d9.html" title="HaProxy 与 Keepalived 实现双机热备高可用">https://www.techgrow.cn/posts/c93e2d9.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/Linux%E8%BF%90%E7%BB%B4/" rel="tag"><i class="fa fa-tag"></i> Linux运维</a><a href="/tags/Web%E6%9C%8D%E5%8A%A1%E5%99%A8/" rel="tag"><i class="fa fa-tag"></i> Web服务器</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/62ce5629.html" rel="prev" title="MyBatis 入门教程之二"><i class="fa fa-angle-left"></i> MyBatis 入门教程之二</a></div><div class="post-nav-item"> <a href="/posts/7f6021d6.html" rel="next" title="Spring Cloud 系统架构图">Spring Cloud 系统架构图<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">2.2m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">33:13</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/c93e2d9.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>