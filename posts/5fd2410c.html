<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍 Spring Cloud Sleuth 的进阶使用，包括 SkyWalking 和 Pinpoint 的使用。"><meta property="og:type" content="article"><meta property="og:title" content="Sleuth 入门教程 - 中级篇"><meta property="og:url" content="https://www.techgrow.cn/posts/5fd2410c.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍 Spring Cloud Sleuth 的进阶使用，包括 SkyWalking 和 Pinpoint 的使用。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sleuth-skywalking-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sleuth-skywalking-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sleuth-skywalking-5.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sleuth-skywalking-6.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sleuth-skywalking-7.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sleuth-skywalking-8.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sleuth-skywalking-9.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sleuth-pinpoint-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sleuth-pinpoint-4.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sleuth-pinpoint-5.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sleuth-pinpoint-6.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sleuth-pinpoint-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sleuth-pinpoint-2.png"><meta property="article:published_time" content="2020-05-16T14:33:05.000Z"><meta property="article:modified_time" content="2020-05-16T14:33:05.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="微服务"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2024/10/sleuth-skywalking-1.png"><link rel="canonical" href="https://www.techgrow.cn/posts/5fd2410c.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/5fd2410c.html","path":"posts/5fd2410c.html","title":"Sleuth 入门教程 - 中级篇"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Sleuth 入门教程 - 中级篇 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-Cloud-%E4%B8%8E-SkyWalking"><span class="nav-text">Spring Cloud 与 SkyWalking</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SkyWalking-%E4%BB%8B%E7%BB%8D"><span class="nav-text">SkyWalking 介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SkyWalking-%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="nav-text">SkyWalking 的概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SkyWalking-%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="nav-text">SkyWalking 的功能</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SkyWalking-%E7%9A%84%E7%89%B9%E6%80%A7"><span class="nav-text">SkyWalking 的特性</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SkyWalking-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="nav-text">SkyWalking 整体架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SkyWalking-%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="nav-text">SkyWalking 实战案例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="nav-text">1. 版本说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%AE%89%E8%A3%85%E4%B8%8E%E5%90%AF%E5%8A%A8-SkyWalking"><span class="nav-text">2. 安装与启动 SkyWalking</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E5%88%9B%E5%BB%BA-Maven-%E7%88%B6%E7%BA%A7-Pom-%E5%B7%A5%E7%A8%8B"><span class="nav-text">3. 创建 Maven 父级 Pom 工程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E5%88%9B%E5%BB%BA-Eureka-%E5%B7%A5%E7%A8%8B"><span class="nav-text">4. 创建 Eureka 工程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-%E5%88%9B%E5%BB%BA-Zuul-%E5%B7%A5%E7%A8%8B"><span class="nav-text">5. 创建 Zuul 工程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-%E5%88%9B%E5%BB%BA-Provider-%E5%B7%A5%E7%A8%8B"><span class="nav-text">6. 创建 Provider 工程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-%E5%88%9B%E5%BB%BA-Consumer-%E5%B7%A5%E7%A8%8B"><span class="nav-text">7. 创建 Consumer 工程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-%E4%BD%BF%E7%94%A8-Agent-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%E5%92%8C%E7%9B%91%E6%8E%A7"><span class="nav-text">8. 使用 Agent 启动服务和监控</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-%E4%B8%8B%E8%BD%BD%E6%A1%88%E4%BE%8B%E4%BB%A3%E7%A0%81"><span class="nav-text">9. 下载案例代码</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-Cloud-%E4%B8%8E-Pinpoint"><span class="nav-text">Spring Cloud 与 Pinpoint</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Pinpoint-%E4%BB%8B%E7%BB%8D"><span class="nav-text">Pinpoint 介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Pinpoint-%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="nav-text">Pinpoint 的概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Pinpoint-%E7%9A%84%E7%89%B9%E6%80%A7"><span class="nav-text">Pinpoint 的特性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Pinpoint-%E7%9A%84%E5%85%BC%E5%AE%B9%E6%80%A7"><span class="nav-text">Pinpoint 的兼容性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Pinpoint-%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%9D%97"><span class="nav-text">Pinpoint 的核心模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Pinpoint-%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-text">Pinpoint 的数据结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Pinpoint-%E4%B8%8E-Zipkin-%E5%AF%B9%E6%AF%94"><span class="nav-text">Pinpoint 与 Zipkin 对比</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pinpoint-%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="nav-text">Pinpoint 实战案例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">685</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">53</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/5fd2410c.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Sleuth 入门教程 - 中级篇 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍 Spring Cloud Sleuth 的进阶使用，包括 SkyWalking 和 Pinpoint 的使用。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Sleuth 入门教程 - 中级篇</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-05-16 22:33:05" itemprop="dateCreated datePublished" datetime="2020-05-16T22:33:05+08:00">2020-05-16</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/5fd2410c.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/5fd2410c.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>5.4k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>5 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/b01a14e8.html">Sleuth 入门教程 - 基础篇</a></li><li><a href="/posts/5fd2410c.html">Sleuth 入门教程 - 中级篇</a></li><li><a href="/posts/905c65b7.html">Micrometer 入门教程 - 基础篇</a></li></ul><span id="more"></span><h2 id="Spring-Cloud-与-SkyWalking"><a href="#Spring-Cloud-与-SkyWalking" class="headerlink" title="Spring Cloud 与 SkyWalking"></a>Spring Cloud 与 SkyWalking</h2><h3 id="SkyWalking-介绍"><a href="#SkyWalking-介绍" class="headerlink" title="SkyWalking 介绍"></a>SkyWalking 介绍</h3><h4 id="SkyWalking-的概述"><a href="#SkyWalking-的概述" class="headerlink" title="SkyWalking 的概述"></a>SkyWalking 的概述</h4><p><a target="_blank" rel="external nofollow" href="https://github.com/apache/SkyWalking">SkyWalking</a> 创建于 2015 年，用于提供分布式追踪功能。从 <code>5.x</code> 开始，项目进化为一个完成功能的 APM 系统，被用于追踪、监控和诊断分布式系统，特别是使用微服务架构、云原生或容器技术。更多介绍可参考：<a target="_blank" rel="external nofollow" href="https://skywalking.apache.org/">SkyWalking 官网</a>、<a target="_blank" rel="external nofollow" href="https://github.com/apache/SkyWalking">SkyWalking GitHub 项目</a>。</p><h4 id="SkyWalking-的功能"><a href="#SkyWalking-的功能" class="headerlink" title="SkyWalking 的功能"></a>SkyWalking 的功能</h4><p>SkyWalking 提供的主要功能如下：</p><ul><li>分布式追踪和上下文传输</li><li>应用、实例、服务性能指标分析</li><li>根源分析</li><li>应用拓扑分析</li><li>应用和服务依赖分析</li><li>慢服务检测</li><li>性能优化</li></ul><h4 id="SkyWalking-的特性"><a href="#SkyWalking-的特性" class="headerlink" title="SkyWalking 的特性"></a>SkyWalking 的特性</h4><p>SkyWalking 主要特性如下：</p><ul><li>多语言探针或者类库<ul><li> Java 自动探针，追踪和监控程序时，不需要修改源码</li><li>社区提供的语言探针：．NET Core、Node.js</li></ul></li><li> 多种后端存储<ul><li>支持 Elastic Search、H2</li><li> 支持 OpenTrancing：Java 自动探针和 OpenTracing API 协同工作。</li></ul></li><li>轻量级、完善的后端聚合和分析功能</li><li>现代化 WebUI</li><li> 日志集成</li><li>应用、实例和服务的告警</li><li>支持接受其他跟踪器的数据格式：<ul><li>Zipkin JSON、Thrift、Protobuf v1 和 v2 格式，由 OpenZipkin 库提供支持</li><li> Jaeger 采用 Zipkin Thrift 或 JSON v1/v2 格式</li></ul></li></ul><h3 id="SkyWalking-整体架构"><a href="#SkyWalking-整体架构" class="headerlink" title="SkyWalking 整体架构"></a>SkyWalking 整体架构</h3><p>SkyWalking 的整体架构主要由四部分组成 Collector、Agent、Web、Storage，具体如下图所示。从上到下是应用级别的接入，可以使用 SDK 形式的接入，也使用非入侵性的 Agent 形式接入，Agent 负载将数据转化成 SkyWalking Trace 数据协议，通过 HTTP 或者是 gRPC 发送到 Collector，然后 Collector 对收集到的数据进行分析和聚合，最后存储到 ElasticSearch 或者 H2 中，一般情况下 H2 只用于测试，右边的 UI 是通过 HTTP + GrahQL 进行数据获取展示，大体的流程就是这样。</p><p><img data-src="../../../asset/2024/10/sleuth-skywalking-1.png"></p><h3 id="SkyWalking-实战案例"><a href="#SkyWalking-实战案例" class="headerlink" title="SkyWalking 实战案例"></a>SkyWalking 实战案例</h3><p>本节将演示 Spring Cloud 与 SkyWalking 的实战案例，该案例使用了两个核心服务（Consumer Service、Provider Service）、Zuul 网关、Eureka 作为注册中心。案例的调用流程是这样的，首先通过访问 Zuul 网关，然后再将请求转发到 Consumer Service，接着 Consumer Service 通过 Feign 远程调用 Provider Service，最后返回响应结果。具体的调用流程图如下所示：</p><p><img data-src="../../../asset/2024/10/sleuth-skywalking-2.png"></p><h4 id="1-版本说明"><a href="#1-版本说明" class="headerlink" title="1. 版本说明"></a>1. 版本说明</h4><p>在本案例中，使用各组件的版本如下所示：</p><table><thead><tr><th>组件</th><th>版本</th></tr></thead><tbody><tr><td> Spring Boot</td><td>2.0.3</td></tr><tr><td>Spring Cloud</td><td>Finchley.RELEASE</td></tr><tr><td>ElasticSearch</td><td>5.6.10</td></tr><tr><td>SkyWalking</td><td>5.0.0-GA</td></tr></tbody></table><h4 id="2-安装与启动-SkyWalking"><a href="#2-安装与启动-SkyWalking" class="headerlink" title="2. 安装与启动 SkyWalking"></a>2. 安装与启动 SkyWalking</h4><ul><li><a href="/posts/9e227cab.html">SkyWalking 安装与运行教程</a></li></ul><h4 id="3-创建-Maven-父级-Pom-工程"><a href="#3-创建-Maven-父级-Pom-工程" class="headerlink" title="3. 创建 Maven 父级 Pom 工程"></a>3. 创建 Maven 父级 Pom 工程</h4><p>在父工程里面配置好工程需要的父级依赖，目的是为了更方便管理与简化配置，具体 Maven 配置如下：</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 利用传递依赖，公共部分 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 管理依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>Finchley.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--注意：这里需要添加以下配置，否则可能会有各种依赖问题 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/libs-milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h4 id="4-创建-Eureka-工程"><a href="#4-创建-Eureka-工程" class="headerlink" title="4. 创建 Eureka 工程"></a>4. 创建 Eureka 工程</h4><p>创建 Eureka Server 的 Maven 工程，配置工程里的 <code>pom.xml</code> 文件，需要引入 <code>spring-cloud-starter-netflix-eureka-server</code></p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>创建 Eureka Server 的启动主类，这里添加相应注解，作为程序的入口：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaServerApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>{</span><br><span class="line">        SpringApplication.run(EurekaServerApplication.class, args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>添加 Eureka Server 需要的 <code>application.yml</code> 配置文件到工程中</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8090</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">registerWithEureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">fetchRegistry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://${eureka.instance.hostname}:${server.port}/eureka/</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">waitTimeInMsWhenSyncEmpty:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">enableSelfPreservation:</span> <span class="literal">false</span></span><br></pre></td></tr></tbody></table></figure><h4 id="5-创建-Zuul-工程"><a href="#5-创建-Zuul-工程" class="headerlink" title="5. 创建 Zuul 工程"></a>5. 创建 Zuul 工程</h4><p>创建 Zuul 的 Maven 工程，配置工程里的 <code>pom.xml</code> 文件，需要引入 <code>spring-cloud-starter-netflix-zuul</code>。由于需要将服务注册到 Eureka Server，工程下的 <code>pom.xml</code> 文件还需要引入 <code>spring-cloud-starter-netflix-eureka-client</code>。</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>创建 Zuul 的启动主类，添加 <code>@EnableDiscoveryClient</code> 和 <code>@EnableZuulProxy</code> 注解，作为程序的入口：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZuulApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        SpringApplication.run(ZuulApplication.class, args);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">提示</p><p>在主启动类上面的 <code>@EnableDiscoveryClient</code> 和 <code>@EnableZuulProxy</code> 注解，主要用于开启服务发现和 Zuul 代理转发的功能。</p></div><p>添加 Zuul 需要的 <code>application.yml</code> 配置文件到工程中</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7070</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">zuul-service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:8090/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="attr">service-consumer:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/client/**</span></span><br><span class="line">      <span class="attr">serviceId:</span> <span class="string">consumer-service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">eureka:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">30000</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">30000</span></span><br><span class="line">  <span class="attr">MaxAutoRetries:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">MaxAutoRetriesNextServer:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">OkToRetryOnAllOperations:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">threadpool:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">coreSize:</span> <span class="number">1000</span>  <span class="comment"># 并发执行的最大线程数，默认 10</span></span><br><span class="line">      <span class="attr">maxQueueSize:</span> <span class="number">1000</span>  <span class="comment"># BlockingQueue 的最大队列数</span></span><br><span class="line">      <span class="attr">queueSizeRejectionThreshold:</span> <span class="number">500</span>  <span class="comment"># 即使 maxQueueSize 没有达到，达到 queueSizeRejectionThreshold 该值后，请求也会被拒绝</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">thread:</span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds:</span> <span class="number">120001</span></span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">提示</p><p>在上述配置内容中，添加了 Ribbon 和 Hystrix 相关配置是为了在首次请求时不会出现超时现象。</p></div><h4 id="6-创建-Provider-工程"><a href="#6-创建-Provider-工程" class="headerlink" title="6. 创建 Provider 工程"></a>6. 创建 Provider 工程</h4><p>为了测试 Feign 的 Web 服务客户端的功能，必须要有一个服务提供者。创建 Provider 的 Maven 工程后，由于需要将服务注册到 Eureka Server，工程下的 <code>pom.xml</code> 文件需要引入 <code>spring-cloud-starter-netflix-eureka-client</code></p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>创建 Provider 的启动主类，添加注解 <code>@EnableDiscoveryClient</code>，将服务注册到 Eureka Server：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        SpringApplication.run(ProviderApplication.class, args);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>在 <code>application.yml</code> 文件中指定<strong>服务名称（<code>provider-service</code>）</strong>、注册中心地址与端口号：</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">provider-service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:8090/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure><p>创建用于测试的 Controller 类：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = "/getSendInfo", method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSendInfo</span><span class="params">(<span class="meta">@RequestParam("serviceName")</span> String serviceName)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> serviceName + <span class="string">" ---&gt; "</span> + <span class="string">"Provider-Service"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="7-创建-Consumer-工程"><a href="#7-创建-Consumer-工程" class="headerlink" title="7. 创建 Consumer 工程"></a>7. 创建 Consumer 工程</h4><p>创建 Consumer 的 Maven 工程，配置工程里的 <code>pom.xml</code> 文件，需要引入 <code>spring-cloud-starter-openfeign</code>。由于需要从 Eureka Server 获取服务列表，即作为 Eureka 客户端，还需要引入 <code>spring-cloud-starter-netflix-eureka-client</code>。</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>创建启动主类，添加注解 <code>@EnableFeignClients</code>、<code>@EnableDiscoveryClient</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>{</span><br><span class="line">        SpringApplication.run(ConsumerApplication.class, args);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>创建服务接口类，用于通过 Feign 调用 Provider 服务：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name = "provider-service")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SkyFeignService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = "/getSendInfo", method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function">String <span class="title">getSendInfo</span><span class="params">(<span class="meta">@RequestParam("serviceName")</span> String serviceName)</span></span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>创建用于测试的 Controller 类，使用多种方式调用 Provider 服务的那个自定义 API：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SkyFeignService providerFeignService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = "/getInfo", method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getInfo</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> providerFeignService.getSendInfo(<span class="string">"Consumer-Service"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>在 <code>application.yml</code> 文件中配置端口号、注册中心地址：</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">6060</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consumer-service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:8090/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure><h4 id="8-使用-Agent-启动服务和监控"><a href="#8-使用-Agent-启动服务和监控" class="headerlink" title="8. 使用 Agent 启动服务和监控"></a>8. 使用 Agent 启动服务和监控</h4><p>在 <a target="_blank" rel="external nofollow" href="https://archive.apache.org/dist/incubator/skywalking/">官网</a> 下载 SkyWalking 的 <code>5.0.0-GA</code> 版本，解压后得到里面的 <code>agent</code> 目录（如下），该目录是探针相关的。</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apache-skywalking-apm-incubating</span><br><span class="line">├── agent</span><br><span class="line">├── bin</span><br><span class="line">├── collector-libs</span><br><span class="line">├── config</span><br><span class="line">├── DISCLAIMER</span><br><span class="line">├── LICENSE</span><br><span class="line">├── licenses</span><br><span class="line">├── NOTICE</span><br><span class="line">├── README.txt</span><br><span class="line">└── webapp</span><br></pre></td></tr></tbody></table></figure><p>手动创建四个目录（如下），分别为 service-eureka、service-zuul、service-consumer、service-provider，主要用于存放被监控的 Jar 和 <code>agent</code> 目录，每个应用单独使用一个对应的 <code>agent</code> 目录进行启动。</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">├── service-consumer</span><br><span class="line">│&nbsp;&nbsp; ├── agent</span><br><span class="line">│&nbsp;&nbsp; └── consumer-service-1.0-SNAPSHOT.jar</span><br><span class="line">├── service-eureka</span><br><span class="line">│&nbsp;&nbsp; ├── agent</span><br><span class="line">│&nbsp;&nbsp; └── eureka-service-1.0-SNAPSHOT.jar</span><br><span class="line">├── service-provider</span><br><span class="line">│&nbsp;&nbsp; ├── agent</span><br><span class="line">│&nbsp;&nbsp; └── provider-service-1.0-SNAPSHOT.jar</span><br><span class="line">└── service-zuul</span><br><span class="line">    ├── agent</span><br><span class="line">    └── zuul-service-1.0-SNAPSHOT.jar</span><br></pre></td></tr></tbody></table></figure><p>其中的 <code>agent</code> 目录是之前下载 SkyWalking 并解压后得到的，分别修改 <code>agent/config</code> 目录里面的 <code>agent.config</code> 文件，只需要修改 <code>agent.application_ code</code> 这一项配置，这个代表应用。每个配置文件对应改为：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">agent.application_code=service-eureka</span><br><span class="line">agent.application_code=service-zuul</span><br><span class="line">agent.application_code=service-provider</span><br><span class="line">agent.application_code=service-consumer</span><br></pre></td></tr></tbody></table></figure><p>而服务应用是上面开发好的，通过 Maven 命令 <code>maven package</code> 将项目打包后得到可执行的 Jar。最后，通过下面的命令按顺序启动要监控的服务，具体如下：</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">java<span class="params"> -javaagent</span>:/usr/<span class="built_in">local</span>/skywalking/service-eureka/agent/skywalking-agent.jar<span class="params"> -jar</span> /usr/<span class="built_in">local</span>/skywalking/service-eureka/eureka-service-1.0-SNAPSHOT.jar</span><br><span class="line"></span><br><span class="line">java<span class="params"> -javaagent</span>:/usr/<span class="built_in">local</span>/skywalking/service-zuul/agent/skywalking-agent.jar<span class="params"> -jar</span> /usr/<span class="built_in">local</span>/skywalking/service-zuul/zuul-service-1.0-SNAPSHOT.jar</span><br><span class="line"></span><br><span class="line">java<span class="params"> -javaagent</span>:/usr/<span class="built_in">local</span>/skywalking/service-provider/agent/skywalking-agent.jar<span class="params"> -jar</span> /usr/<span class="built_in">local</span>/skywalking/service-provider/provider-service-1.0-SNAPSHOT.jar</span><br><span class="line"></span><br><span class="line">java<span class="params"> -javaagent</span>:/usr/<span class="built_in">local</span>/skywalking/service-consumer/agent/skywalking-agent.jar<span class="params"> -jar</span> /usr/<span class="built_in">local</span>/skywalking/service-consumer/consumer-service-1.0-SNAPSHOT.jar</span><br></pre></td></tr></tbody></table></figure><p>启动命令从上到下依次执行即可，所有应用启动完成后，通过 <code>http://localhost:8080</code> 可以访问 SkyWalking 的管理界面，默认登录的用户名 / 密码是 <code>admin / admin</code>：</p><p><img data-src="../../../asset/2024/10/sleuth-skywalking-5.png"></p><p>通过 Postman 等 HTTP 工具调用 <code>http://127.0.0.1:7070/client/getInfo</code> 接口后，此时观察 SkyWalking 首页最下面会出现一个调用过程：</p><p><img data-src="../../../asset/2024/10/sleuth-skywalking-6.png"></p><p>更详细的调用信息可以切换顶部左侧菜单中的 Applicaiotn、Service、Topology、Trace 和 Alarm 等标签项，首先看一下 Application 展示的内容：</p><p><img data-src="../../../asset/2024/10/sleuth-skywalking-7.png"></p><p>接下来看一下 Service 展示的内容：</p><p><img data-src="../../../asset/2024/10/sleuth-skywalking-8.png"></p><p>接下来看一下 Toplogy 展示的内容（整个拓扑图）：</p><p><img data-src="../../../asset/2024/10/sleuth-skywalking-9.png"></p><div class="admonition note"><p class="admonition-title">提示</p><ul><li>刷新 Toplogy 页面时，可能会先看到一个 <code>service-eureka</code> 的节点。重复刷新可能会出现 <code>serivce-consumer</code> 指向 <code>service-provider</code> 的请求，再请求一次，再刷新可能会出现 <code>user --&gt; service-zuul --&gt; service-consumer --&gt; service-provider</code> 的调用，为什么会出现这样的现象呢？</li><li>这里出现延迟的原因和请求调用顺序有关系，请求调用是顺序开始，但完成却是倒序完成的。在每个应用中完成请求处理后，会发送监控信息到 Collector，然后 Collector 才能依次输出采集的结果，所以就出现这种延迟显示的情况。</li></ul></div><h4 id="9-下载案例代码"><a href="#9-下载案例代码" class="headerlink" title="9. 下载案例代码"></a>9. 下载案例代码</h4><ul><li>完整的案例代码可以从 <a href="/downloads/2020/05/sleuth-skywalking-demo.zip">这里</a> 下载得到。</li></ul><h2 id="Spring-Cloud-与-Pinpoint"><a href="#Spring-Cloud-与-Pinpoint" class="headerlink" title="Spring Cloud 与 Pinpoint"></a>Spring Cloud 与 Pinpoint</h2><h3 id="Pinpoint-介绍"><a href="#Pinpoint-介绍" class="headerlink" title="Pinpoint 介绍"></a>Pinpoint 介绍</h3><h4 id="Pinpoint-的概述"><a href="#Pinpoint-的概述" class="headerlink" title="Pinpoint 的概述"></a>Pinpoint 的概述</h4><p>Pinpoint 是一个分析大规模分布式系统的平台，并提供处理大量跟踪数据的解决方案。它自 2012 年 7 月开发，并千 2015 年 1 月 9 日作为开源项目推出。Pinpoint 是由韩国人编写的著名的 APM (Application Performance Management) 系统。</p><h4 id="Pinpoint-的特性"><a href="#Pinpoint-的特性" class="headerlink" title="Pinpoint 的特性"></a>Pinpoint 的特性</h4><ul><li><p>Pinpoint 的特点</p><ul><li>分布式事务跟踪，跟踪跨分布式应用的消息。</li><li>自动检测应用拓扑，帮助开发者搞清楚应用的架构。</li><li>水平扩展以便支持大规模服务器集群。</li><li>提供代码级别的可见性以便轻松定位失败点和瓶颈。</li><li>使用字节码增强技术，添加新功能而无须修改代码。</li></ul></li><li><p>Pinpoint 的优势</p><ul><li>非入侵式：使用字节码增强技术，添加新功能而无须修改代码。</li><li>资源消耗：对性能的影响最小（资源使用量增加）</li></ul></li></ul><h4 id="Pinpoint-的兼容性"><a href="#Pinpoint-的兼容性" class="headerlink" title="Pinpoint 的兼容性"></a>Pinpoint 的兼容性</h4><p>下面对 Pinpoint 涉及的组件和存储方面的中间件进行版本对比。</p><p><img data-src="../../../asset/2024/10/sleuth-pinpoint-3.png"></p><p><img data-src="../../../asset/2024/10/sleuth-pinpoint-4.png"></p><p><img data-src="../../../asset/2024/10/sleuth-pinpoint-5.png"></p><p><img data-src="../../../asset/2024/10/sleuth-pinpoint-6.png"></p><h4 id="Pinpoint-的核心模块"><a href="#Pinpoint-的核心模块" class="headerlink" title="Pinpoint 的核心模块"></a>Pinpoint 的核心模块</h4><p>Pinpoint 主要包含以下 4 个架构模块：</p><ul><li>HBase（用于存储数据）。</li><li>PinpointCollector（部署在 Web 容器上）。</li><li>Pinpoint Web（部署在 Web 容器上）。</li><li>Pinpoint Agent（附加到需要分析的 Java 应用程序）。</li></ul><p>为了更好地说明 Pinpoint 中架构的模块，需要看详细的架构图（如下）。大体的流程是这样的：首先通过 Agent 收集调用应用的数据，将数据发送给 Collector，Collector 负责处理和分析数据，最后将数据存储到 HBase 中，可以通过 Pinpoint Web UI 查看已经分析好的调用分析数据。</p><p><img data-src="../../../asset/2024/10/sleuth-pinpoint-1.png"></p><h4 id="Pinpoint-的数据结构"><a href="#Pinpoint-的数据结构" class="headerlink" title="Pinpoint 的数据结构"></a>Pinpoint 的数据结构</h4><p>在 Pinpoint 中，数据结构的核心由 Span、Trace 和 TraceId 组成。</p><ul><li><strong>Span</strong>：RPC（远程过程调用）跟踪的基本单位。它表示 RPC 到达时处理的工作，包含跟踪数据。为确保代码级别的可见性，Span 将子项标记为 SpanEvent，作为数据结构。每个 Span 包含一个 TraceId。</li><li><strong>Trace</strong>：一系列跨度；它由相关的 RPC（Spans）组成。同一个跟踪中的跨距共享相同的 TransactionId。Trace 通过 SpanIds 和 ParentSpanIds 排序为分层树状结构。</li><li><strong>TraceId</strong>：由 TransactionId、SpanId 和 ParentSpanId 组成的密钥集合。TransactionId 表示消息 ID，SpanId 和 ParentSpanId 都表示 RPC 的父子调用关系。<ul><li><strong>TransactionId（TxId）</strong>：来自单个事务的分布式系统发送 / 接收的消息的 ID；它必须在整个服务器组中是全局唯一的。</li><li><strong>SpanId</strong>：接收 RPC 消息时处理的作业的 ID；它是在 RPC 到达服务器节点时生成的。</li><li><strong>ParentSpanId（pSpanId）</strong>：生成 RPC 的父 Span 的 SpanId。如果节点是事务的起始点，则不会有父跨度（对于这些情况，使用值 <code>-1</code> 来表示跨度是事务的根跨度。</li></ul></li></ul><p><img data-src="../../../asset/2024/10/sleuth-pinpoint-2.png"></p><div class="admonition note"><p class="admonition-title">提示</p><p>上图能够比较直观地说明这些 ID 结构直接的关系，同时可以很好地描述一个 Trace 的过程。</p></div><h4 id="Pinpoint-与-Zipkin-对比"><a href="#Pinpoint-与-Zipkin-对比" class="headerlink" title="Pinpoint 与 Zipkin 对比"></a>Pinpoint 与 Zipkin 对比</h4><table><thead><tr><th>对比点</th><th> Zipkin</th><th>Pinpoint</th><th> 说明</th></tr></thead><tbody><tr><td>技术点</td><td></td><td>√</td><td>Zipkin 依赖于 Spring 框架的 API 支持，监控内容和范围有限<br> Pinpoint 使用字节码注入技术，监控更为深入和广泛，比如可以看到调用了几次 Redis、哪几个微服务、MySQL 以及执行的 SQL 等，可以非常方便地追踪问题</td></tr><tr><td>接入成本</td><td></td><td>√</td><td>Zipkin 需要对应用进行简单改造，包括 Sleuth 的引入和配置<br> Pinpoint 只需要在服务器打入探针，对业务没有任何改动</td></tr><tr><td>扩展性</td><td>√</td><td></td><td>Zipkin 使用了 Spring Cloud 常用的 RESTful 协议，可以方便地进行扩展<br> Pinpoint 现在使用 gRPC 协议，也可以使用 Thrift 传输协议，出于传输数据量和性能的考虑</td></tr><tr><td>兼容性</td><td>√</td><td></td><td>Zipkin 对 Spring Cloud 的兼容性更好，也得益于上面说的扩展性</td></tr><tr><td>产品</td><td></td><td>√</td><td>相比较而言，Pinpoint 可以说是一款更成熟的产品</td></tr><tr><td>性能</td><td>√</td><td></td><td>由于采集的数据范围不同，即使 Pinpoint 采用了高性能的传输协议，但是 Zipkin 的性能依然更高</td></tr></tbody></table><h3 id="Pinpoint-实战案例"><a href="#Pinpoint-实战案例" class="headerlink" title="Pinpoint 实战案例"></a>Pinpoint 实战案例</h3><p>由于篇幅有限，详细的实战案例代码可参考《重新定义 Spring Cloud 实战》的 第 16.7 小节（389 页）。</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a target="_blank" rel="external nofollow" href="https://blog.51cto.com/u_15338614/3584560">Spring Cloud 学习 - Pinpoint</a></li><li><a target="_blank" rel="external nofollow" href="https://www.cnblogs.com/wangjunwei/p/12015930.html">PinPoint + SpringBoot 环境搭建</a></li><li><a target="_blank" rel="external nofollow" href="https://www.jb51.net/article/237852.htm">基于 Pinpoint 对 SpringCloud 项目实现全链路监控</a></li></ul><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/5fd2410c.html" title="Sleuth 入门教程 - 中级篇">https://www.techgrow.cn/posts/5fd2410c.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="fa fa-tag"></i> 微服务</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/3006124f.html" rel="prev" title="Debian 12 安装 Python 2"><i class="fa fa-angle-left"></i> Debian 12 安装 Python 2</a></div><div class="post-nav-item"> <a href="/posts/912f33ba.html" rel="next" title="基于 MySQL 实现分布式锁">基于 MySQL 实现分布式锁<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">1.8m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">26:32</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"/lib/mermaid/dist/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/5fd2410c.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>