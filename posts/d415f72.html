<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍 ZooKeeper 的使用教程。"><meta property="og:type" content="article"><meta property="og:title" content="ZooKeeper 入门教程之六"><meta property="og:url" content="https://www.techgrow.cn/posts/d415f72.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍 ZooKeeper 的使用教程。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/01/zookeeper-source-9.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/01/zookeeper-source-10.png"><meta property="article:published_time" content="2021-07-08T14:13:45.000Z"><meta property="article:modified_time" content="2021-07-08T14:13:45.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="分布式"><meta property="article:tag" content="大数据"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2025/01/zookeeper-source-9.png"><link rel="canonical" href="https://www.techgrow.cn/posts/d415f72.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/d415f72.html","path":"posts/d415f72.html","title":"ZooKeeper 入门教程之六"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>ZooKeeper 入门教程之六 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/app/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%BA%90"><span class="nav-text">学习资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="nav-text">版本说明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Leader-%E5%92%8C-Follower-%E7%8A%B6%E6%80%81%E5%90%8C%E6%AD%A5%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">Leader 和 Follower 状态同步源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Leader-%E4%B8%8E-Follower-%E7%9A%84%E7%8A%B6%E6%80%81%E5%90%8C%E6%AD%A5%E7%BB%86%E8%8A%82"><span class="nav-text">Leader 与 Follower 的状态同步细节</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Leader-%E7%AD%89%E5%BE%85%E6%8E%A5%E6%94%B6-Follower-%E7%9A%84%E7%8A%B6%E6%80%81%E5%90%8C%E6%AD%A5%E7%94%B3%E8%AF%B7"><span class="nav-text">Leader 等待接收 Follower 的状态同步申请</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Follower-%E6%9F%A5%E6%89%BE%E5%B9%B6%E8%BF%9E%E6%8E%A5-Leader"><span class="nav-text">Follower 查找并连接 Leader</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Leader-%E5%88%9B%E5%BB%BA-LearnerHandler-%E5%AF%B9%E8%B1%A1"><span class="nav-text">Leader 创建 LearnerHandler 对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Follower-%E5%90%91-Leader-%E6%B3%A8%E5%86%8C"><span class="nav-text">Follower 向 Leader 注册</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Leader-%E6%8E%A5%E6%94%B6-Follower-%E7%9A%84%E7%8A%B6%E6%80%81%E4%BF%A1%E6%81%AF%EF%BC%8C%E6%A0%B9%E6%8D%AE%E5%90%8C%E6%AD%A5%E6%96%B9%E5%BC%8F%E5%8F%91%E9%80%81%E5%90%8C%E6%AD%A5%E6%B6%88%E6%81%AF"><span class="nav-text">Leader 接收 Follower 的状态信息，根据同步方式发送同步消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Follower-%E5%BA%94%E7%AD%94-Leader-%E5%90%8C%E6%AD%A5%E7%BB%93%E6%9E%9C"><span class="nav-text">Follower 应答 Leader 同步结果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Leader-%E5%BA%94%E7%AD%94-Follower"><span class="nav-text">Leader 应答 Follower</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ZK-%E6%9C%8D%E5%8A%A1%E7%AB%AF-Leader-%E5%90%AF%E5%8A%A8"><span class="nav-text">ZK 服务端 Leader 启动</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">636</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">54</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/d415f72.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="ZooKeeper 入门教程之六 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍 ZooKeeper 的使用教程。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> ZooKeeper 入门教程之六</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-07-08 22:13:45" itemprop="dateCreated datePublished" datetime="2021-07-08T22:13:45+08:00">2021-07-08</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/d415f72.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/d415f72.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>1.6k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>1 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/23b4218e.html">ZooKeeper 入门教程之一</a></li><li><a href="/posts/18340f27.html">ZooKeeper 入门教程之二</a></li><li><a href="/posts/5a68992a.html">ZooKeeper 入门教程之三</a></li><li><a href="/posts/16baf534.html">ZooKeeper 入门教程之四</a></li><li><a href="/posts/b589771.html">ZooKeeper 入门教程之五</a></li><li><a href="/posts/d415f72.html">ZooKeeper 入门教程之六</a></li></ul><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="学习资源"><a href="#学习资源" class="headerlink" title="学习资源"></a>学习资源</h3><ul><li><a href="/posts/ecc33bf4.html">ZooKeeper 学习路线</a></li><li><a target="_blank" rel="external nofollow" href="https://zookeeper.apache.org/documentation.html">ZooKeeper 官方英文文档</a></li><li><a target="_blank" rel="external nofollow" href="https://zookeeper.net.cn/doc/r3.9.2/index.html">ZooKeeper 官方中文文档</a></li></ul><span id="more"></span><h3 id="版本说明"><a href="#版本说明" class="headerlink" title="版本说明"></a>版本说明</h3><table><thead><tr><th>软件</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td> ZooKeeper 的源码</td><td><code>3.5.7</code></td><td>本文给出的 ZooKeeper 源码分析，都是基于 ZooKeeper 的 <code>3.5.7</code> 版本进行讲解。</td></tr></tbody></table><h2 id="Leader-和-Follower-状态同步源码分析"><a href="#Leader-和-Follower-状态同步源码分析" class="headerlink" title="Leader 和 Follower 状态同步源码分析"></a>Leader 和 Follower 状态同步源码分析</h2><p><img data-src="../../../asset/2025/01/zookeeper-source-9.png"></p><p><img data-src="../../../asset/2025/01/zookeeper-source-10.png"></p><h3 id="Leader-与-Follower-的状态同步细节"><a href="#Leader-与-Follower-的状态同步细节" class="headerlink" title="Leader 与 Follower 的状态同步细节"></a>Leader 与 Follower 的状态同步细节</h3><p>当选举结束后，每个节点都需要根据自己的角色更新自己的状态。选举出来的 Leader 更新自己的状态为 Leader，其他节点更新自己的状态为 Follower。</p><ul><li>Leader 更新状态的入口：<code>leader.lead()</code></li><li>Follower 更新状态的入口：<code>follower.followerLeader()</code></li></ul><p>特别注意的事项：</p><ul><li><p>(1) Follower 必须要让 Leader 知道自己的状态，包括：epoch、zxid、sid</p><ul><li>必须找出谁是 Leader</li><li> 发起请求去连接 Leader</li><li> 发送自己的信息给 Leader</li><li>Leader 接收到信息后，必须返回对应的信息给 Follower</li></ul></li><li><p>(2) 当 Leader 得知 Follower 的状态后，就可以确定需要做何种方式的数据同步，包括：DIFF、TRUNC、SNAP</p></li><li><p>(3) Leader 和 Follower 之间执行数据同步</p></li><li><p>(4) 当 Leader 接收到超过半数 Follower 的 ACK 之后，进入正常工作状态，此时集群启动已完成。</p></li></ul><p>同步策略的总结：</p><ul><li>(1) DIFF（差异化同步策略），咱两一样，不需要做什么</li><li> (2) TRUNC（回滚同步策略），Follower 的 zxid 比 Leader 的 zxid 大，所以 Follower 要执行回滚</li><li> (3) COMMIT，Leader 的 zxid 比 Follower 的 zxid 大，发送 Proposal（提案）给 Foloower 执行提交</li><li> (4) SNAP（全量同步策略），如果 Follower 并没有任何数据，直接将数据全部序列给 Follower</li></ul><h3 id="Leader-等待接收-Follower-的状态同步申请"><a href="#Leader-等待接收-Follower-的状态同步申请" class="headerlink" title="Leader 等待接收 Follower 的状态同步申请"></a>Leader 等待接收 Follower 的状态同步申请</h3><ul><li><code>Leader.lead()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lead</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>{</span><br><span class="line">    self.end_fle = Time.currentElapsedTime();</span><br><span class="line">    <span class="keyword">long</span> electionTimeTaken = self.end_fle - self.start_fle;</span><br><span class="line">    self.setElectionTimeTaken(electionTimeTaken);</span><br><span class="line">    LOG.info(<span class="string">"LEADING - LEADER ELECTION TOOK - {} {}"</span>, electionTimeTaken,</span><br><span class="line">            QuorumPeer.FLE_TIME_UNIT);</span><br><span class="line">    self.start_fle = <span class="number">0</span>;</span><br><span class="line">    self.end_fle = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    zk.registerJMX(<span class="keyword">new</span> LeaderBean(<span class="keyword">this</span>, zk), self.jmxLocalPeerBean);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        self.tick.set(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 恢复数据到内存，在 ZK 启动时，其实已经加载过数据了</span></span><br><span class="line">        zk.loadData();</span><br><span class="line"></span><br><span class="line">        leaderStateSummary = <span class="keyword">new</span> StateSummary(self.getCurrentEpoch(), zk.getLastProcessedZxid());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start thread that waits for connection requests from</span></span><br><span class="line">        <span class="comment">// new followers.</span></span><br><span class="line">        <span class="comment">// 等待其他 Follower 节点向 Leader 节点发送同步状态</span></span><br><span class="line">        cnxAcceptor = <span class="keyword">new</span> LearnerCnxAcceptor();</span><br><span class="line">        cnxAcceptor.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> epoch = getEpochToPropose(self.getId(), self.getAcceptedEpoch());</span><br><span class="line"></span><br><span class="line">        zk.setZxid(ZxidUtils.makeZxid(epoch, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>){</span><br><span class="line">            lastProposed = zk.getZxid();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        newLeaderProposal.packet = <span class="keyword">new</span> QuorumPacket(NEWLEADER, zk.getZxid(),</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((newLeaderProposal.packet.getZxid() &amp; <span class="number">0xffffffffL</span>) != <span class="number">0</span>) {</span><br><span class="line">            LOG.info(<span class="string">"NEWLEADER proposal has Zxid of "</span></span><br><span class="line">                    + Long.toHexString(newLeaderProposal.packet.getZxid()));</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        zk.unregisterJMX(<span class="keyword">this</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>LearnerCnxAcceptor</code> 类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LearnerCnxAcceptor</span> <span class="keyword">extends</span> <span class="title">ZooKeeperCriticalThread</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> stop = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LearnerCnxAcceptor</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">"LearnerCnxAcceptor-"</span> + ss.getLocalSocketAddress(), zk</span><br><span class="line">                .getZooKeeperServerListener());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">while</span> (!stop) {</span><br><span class="line">                Socket s = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">boolean</span> error = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="comment">// 等待接收 Follower 节点的状态同步申请</span></span><br><span class="line">                    s = ss.accept();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// start with the initLimit, once the ack is processed</span></span><br><span class="line">                    <span class="comment">// in LearnerHandler switch to the syncLimit</span></span><br><span class="line">                    s.setSoTimeout(self.tickTime * self.initLimit);</span><br><span class="line">                    s.setTcpNoDelay(nodelay);</span><br><span class="line"></span><br><span class="line">                    BufferedInputStream is = <span class="keyword">new</span> BufferedInputStream(</span><br><span class="line">                            s.getInputStream());</span><br><span class="line">                    <span class="comment">// 一旦接收到 Follower 的请求，就创建 LearnerHandler 对象来处理请求</span></span><br><span class="line">                    LearnerHandler fh = <span class="keyword">new</span> LearnerHandler(s, is, Leader.<span class="keyword">this</span>);</span><br><span class="line">                    <span class="comment">// 启动线程</span></span><br><span class="line">                    fh.start();</span><br><span class="line">                } <span class="keyword">catch</span> (SocketException e) {</span><br><span class="line">                    ......</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                ......</span><br><span class="line">                </span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            LOG.warn(<span class="string">"Exception while accepting follower"</span>, e.getMessage());</span><br><span class="line">            handleException(<span class="keyword">this</span>.getName(), e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">halt</span><span class="params">()</span> </span>{</span><br><span class="line">        stop = <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>Leader.Leader()</code> 方法，上述的 <code>ss</code> 的初始化是在创建 Leader 对象时进行的。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ServerSocket ss;</span><br><span class="line"></span><br><span class="line">Leader(QuorumPeer self,LeaderZooKeeperServer zk) <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="keyword">this</span>.self = self;</span><br><span class="line">    <span class="keyword">this</span>.proposalStats = <span class="keyword">new</span> BufferStats();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">if</span> (self.shouldUsePortUnification() || self.isSslQuorum()) {</span><br><span class="line">            <span class="keyword">boolean</span> allowInsecureConnection = self.shouldUsePortUnification();</span><br><span class="line">            <span class="keyword">if</span> (self.getQuorumListenOnAllIPs()) {</span><br><span class="line">                ss = <span class="keyword">new</span> UnifiedServerSocket(self.getX509Util(), allowInsecureConnection, self.getQuorumAddress().getPort());</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                ss = <span class="keyword">new</span> UnifiedServerSocket(self.getX509Util(), allowInsecureConnection);</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">if</span> (self.getQuorumListenOnAllIPs()) {</span><br><span class="line">                ss = <span class="keyword">new</span> ServerSocket(self.getQuorumAddress().getPort());</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                ss = <span class="keyword">new</span> ServerSocket();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        ss.setReuseAddress(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (!self.getQuorumListenOnAllIPs()) {</span><br><span class="line">            ss.bind(self.getQuorumAddress());</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (BindException e) {</span><br><span class="line">        <span class="keyword">if</span> (self.getQuorumListenOnAllIPs()) {</span><br><span class="line">            LOG.error(<span class="string">"Couldn't bind to port "</span> + self.getQuorumAddress().getPort(), e);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            LOG.error(<span class="string">"Couldn't bind to "</span> + self.getQuorumAddress(), e);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">this</span>.zk = zk;</span><br><span class="line">    <span class="keyword">this</span>.learnerSnapshotThrottler = createLearnerSnapshotThrottler(</span><br><span class="line">            maxConcurrentSnapshots, maxConcurrentSnapshotTimeout);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="Follower-查找并连接-Leader"><a href="#Follower-查找并连接-Leader" class="headerlink" title="Follower 查找并连接 Leader"></a>Follower 查找并连接 Leader</h3><ul><li><code>Follower.followLeader()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">followLeader</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>{</span><br><span class="line">    self.end_fle = Time.currentElapsedTime();</span><br><span class="line">    <span class="keyword">long</span> electionTimeTaken = self.end_fle - self.start_fle;</span><br><span class="line">    self.setElectionTimeTaken(electionTimeTaken);</span><br><span class="line">    LOG.info(<span class="string">"FOLLOWING - LEADER ELECTION TOOK - {} {}"</span>, electionTimeTaken,</span><br><span class="line">            QuorumPeer.FLE_TIME_UNIT);</span><br><span class="line">    self.start_fle = <span class="number">0</span>;</span><br><span class="line">    self.end_fle = <span class="number">0</span>;</span><br><span class="line">    fzk.registerJMX(<span class="keyword">new</span> FollowerBean(<span class="keyword">this</span>, zk), self.jmxLocalPeerBean);</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// Follower 查找 Leader</span></span><br><span class="line">        QuorumServer leaderServer = findLeader();            </span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// Follower 连接 Leader</span></span><br><span class="line">            connectToLeader(leaderServer.addr, leaderServer.hostname);</span><br><span class="line">            <span class="comment">// Follower 向 Leader 注册</span></span><br><span class="line">            <span class="keyword">long</span> newEpochZxid = registerWithLeader(Leader.FOLLOWERINFO);</span><br><span class="line">            <span class="keyword">if</span> (self.isReconfigStateChange())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"learned about role change"</span>);</span><br><span class="line">            <span class="comment">//check to see if the leader zxid is lower than ours</span></span><br><span class="line">            <span class="comment">//this should never happen but is just a safety check</span></span><br><span class="line">            <span class="keyword">long</span> newEpoch = ZxidUtils.getEpochFromZxid(newEpochZxid);</span><br><span class="line">            <span class="keyword">if</span> (newEpoch &lt; self.getAcceptedEpoch()) {</span><br><span class="line">                LOG.error(<span class="string">"Proposed leader epoch "</span> + ZxidUtils.zxidToString(newEpochZxid)</span><br><span class="line">                        + <span class="string">" is less than our accepted epoch "</span> + ZxidUtils.zxidToString(self.getAcceptedEpoch()));</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Error: Epoch of leader is lower"</span>);</span><br><span class="line">            }</span><br><span class="line">            syncWithLeader(newEpochZxid);                </span><br><span class="line">            QuorumPacket qp = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">this</span>.isRunning()) {</span><br><span class="line">                readPacket(qp);</span><br><span class="line">                processPacket(qp);</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            LOG.warn(<span class="string">"Exception when following the leader"</span>, e);</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                sock.close();</span><br><span class="line">            } <span class="keyword">catch</span> (IOException e1) {</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// clear pending revalidations</span></span><br><span class="line">            pendingRevalidations.clear();</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        zk.unregisterJMX((Learner)<span class="keyword">this</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>Follower.findLeader()</code> 方法，Follower 查找 Leader。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> QuorumServer <span class="title">findLeader</span><span class="params">()</span> </span>{</span><br><span class="line">    QuorumServer leaderServer = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// Find the leader by id</span></span><br><span class="line">    <span class="comment">// 选举投票的时候记录的，最后推荐的 Leader 的 sid</span></span><br><span class="line">    Vote current = self.getCurrentVote();</span><br><span class="line">    <span class="comment">// 如果这个 sid 在启动的所有集群节点范围内</span></span><br><span class="line">    <span class="keyword">for</span> (QuorumServer s : self.getView().values()) {</span><br><span class="line">        <span class="keyword">if</span> (s.id == current.getId()) {</span><br><span class="line">            <span class="comment">// Ensure we have the leader's correct IP address before</span></span><br><span class="line">            <span class="comment">// attempting to connect.</span></span><br><span class="line">            <span class="comment">// 尝试连接 Leader 的 IP 地址</span></span><br><span class="line">            s.recreateSocketAddresses();</span><br><span class="line">            leaderServer = s;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (leaderServer == <span class="keyword">null</span>) {</span><br><span class="line">        LOG.warn(<span class="string">"Couldn't find the leader with id = "</span></span><br><span class="line">                + current.getId());</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> leaderServer;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>Learner.connectToLeader()</code> 方法，Follower 连接 Leader。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">connectToLeader</span><span class="params">(InetSocketAddress addr, String hostname)</span> <span class="keyword">throws</span> IOException, InterruptedException, X509Exception </span>{</span><br><span class="line">    <span class="keyword">this</span>.sock = createSocket();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> initLimitTime = self.tickTime * self.initLimit;</span><br><span class="line">    <span class="keyword">int</span> remainingInitLimitTime = initLimitTime;</span><br><span class="line">    <span class="keyword">long</span> startNanoTime = nanoTime();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> tries = <span class="number">0</span>; tries &lt; <span class="number">5</span>; tries++) {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// recalculate the init limit time because retries sleep for 1000 milliseconds</span></span><br><span class="line">            remainingInitLimitTime = initLimitTime - (<span class="keyword">int</span>)((nanoTime() - startNanoTime) / <span class="number">1000000</span>);</span><br><span class="line">            <span class="keyword">if</span> (remainingInitLimitTime &lt;= <span class="number">0</span>) {</span><br><span class="line">                LOG.error(<span class="string">"initLimit exceeded on retries."</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"initLimit exceeded on retries."</span>);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            sockConnect(sock, addr, Math.min(self.tickTime * self.syncLimit, remainingInitLimitTime));</span><br><span class="line">            <span class="keyword">if</span> (self.isSslQuorum())  {</span><br><span class="line">                ((SSLSocket) sock).startHandshake();</span><br><span class="line">            }</span><br><span class="line">            sock.setTcpNoDelay(nodelay);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            remainingInitLimitTime = initLimitTime - (<span class="keyword">int</span>)((nanoTime() - startNanoTime) / <span class="number">1000000</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (remainingInitLimitTime &lt;= <span class="number">1000</span>) {</span><br><span class="line">                LOG.error(<span class="string">"Unexpected exception, initLimit exceeded. tries="</span> + tries +</span><br><span class="line">                            <span class="string">", remaining init limit="</span> + remainingInitLimitTime +</span><br><span class="line">                            <span class="string">", connecting to "</span> + addr,e);</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (tries &gt;= <span class="number">4</span>) {</span><br><span class="line">                LOG.error(<span class="string">"Unexpected exception, retries exceeded. tries="</span> + tries +</span><br><span class="line">                            <span class="string">", remaining init limit="</span> + remainingInitLimitTime +</span><br><span class="line">                            <span class="string">", connecting to "</span> + addr,e);</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                LOG.warn(<span class="string">"Unexpected exception, tries="</span> + tries +</span><br><span class="line">                        <span class="string">", remaining init limit="</span> + remainingInitLimitTime +</span><br><span class="line">                        <span class="string">", connecting to "</span> + addr,e);</span><br><span class="line">                <span class="keyword">this</span>.sock = createSocket();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    self.authLearner.authenticate(sock, hostname);</span><br><span class="line"></span><br><span class="line">    leaderIs = BinaryInputArchive.getArchive(<span class="keyword">new</span> BufferedInputStream(</span><br><span class="line">            sock.getInputStream()));</span><br><span class="line">    bufferedOutput = <span class="keyword">new</span> BufferedOutputStream(sock.getOutputStream());</span><br><span class="line">    leaderOs = BinaryOutputArchive.getArchive(bufferedOutput);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="Leader-创建-LearnerHandler-对象"><a href="#Leader-创建-LearnerHandler-对象" class="headerlink" title="Leader 创建 LearnerHandler 对象"></a>Leader 创建 LearnerHandler 对象</h3><ul><li><code>Leader.lead()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lead</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>{</span><br><span class="line">    self.end_fle = Time.currentElapsedTime();</span><br><span class="line">    <span class="keyword">long</span> electionTimeTaken = self.end_fle - self.start_fle;</span><br><span class="line">    self.setElectionTimeTaken(electionTimeTaken);</span><br><span class="line">    LOG.info(<span class="string">"LEADING - LEADER ELECTION TOOK - {} {}"</span>, electionTimeTaken,</span><br><span class="line">            QuorumPeer.FLE_TIME_UNIT);</span><br><span class="line">    self.start_fle = <span class="number">0</span>;</span><br><span class="line">    self.end_fle = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    zk.registerJMX(<span class="keyword">new</span> LeaderBean(<span class="keyword">this</span>, zk), self.jmxLocalPeerBean);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        self.tick.set(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 恢复数据到内存，在 ZK 启动时，其实已经加载过数据了</span></span><br><span class="line">        zk.loadData();</span><br><span class="line"></span><br><span class="line">        leaderStateSummary = <span class="keyword">new</span> StateSummary(self.getCurrentEpoch(), zk.getLastProcessedZxid());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start thread that waits for connection requests from</span></span><br><span class="line">        <span class="comment">// new followers.</span></span><br><span class="line">        <span class="comment">// 等待其他 Follower 节点向 Leader 节点发送同步状态</span></span><br><span class="line">        cnxAcceptor = <span class="keyword">new</span> LearnerCnxAcceptor();</span><br><span class="line">        cnxAcceptor.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> epoch = getEpochToPropose(self.getId(), self.getAcceptedEpoch());</span><br><span class="line"></span><br><span class="line">        zk.setZxid(ZxidUtils.makeZxid(epoch, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>){</span><br><span class="line">            lastProposed = zk.getZxid();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        newLeaderProposal.packet = <span class="keyword">new</span> QuorumPacket(NEWLEADER, zk.getZxid(),</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((newLeaderProposal.packet.getZxid() &amp; <span class="number">0xffffffffL</span>) != <span class="number">0</span>) {</span><br><span class="line">            LOG.info(<span class="string">"NEWLEADER proposal has Zxid of "</span></span><br><span class="line">                    + Long.toHexString(newLeaderProposal.packet.getZxid()));</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        zk.unregisterJMX(<span class="keyword">this</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>LearnerCnxAcceptor</code> 类，创建 LearnerHandler 对象。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LearnerCnxAcceptor</span> <span class="keyword">extends</span> <span class="title">ZooKeeperCriticalThread</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> stop = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LearnerCnxAcceptor</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">"LearnerCnxAcceptor-"</span> + ss.getLocalSocketAddress(), zk</span><br><span class="line">                .getZooKeeperServerListener());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">while</span> (!stop) {</span><br><span class="line">                Socket s = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">boolean</span> error = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="comment">// 等待接收 Follower 节点的状态同步申请</span></span><br><span class="line">                    s = ss.accept();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// start with the initLimit, once the ack is processed</span></span><br><span class="line">                    <span class="comment">// in LearnerHandler switch to the syncLimit</span></span><br><span class="line">                    s.setSoTimeout(self.tickTime * self.initLimit);</span><br><span class="line">                    s.setTcpNoDelay(nodelay);</span><br><span class="line"></span><br><span class="line">                    BufferedInputStream is = <span class="keyword">new</span> BufferedInputStream(</span><br><span class="line">                            s.getInputStream());</span><br><span class="line">                    <span class="comment">// 一旦接收到 Follower 的请求，就创建 LearnerHandler 对象来处理请求</span></span><br><span class="line">                    LearnerHandler fh = <span class="keyword">new</span> LearnerHandler(s, is, Leader.<span class="keyword">this</span>);</span><br><span class="line">                    <span class="comment">// 启动线程</span></span><br><span class="line">                    fh.start();</span><br><span class="line">                } <span class="keyword">catch</span> (SocketException e) {</span><br><span class="line">                    ......</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                ......</span><br><span class="line">                </span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            LOG.warn(<span class="string">"Exception while accepting follower"</span>, e.getMessage());</span><br><span class="line">            handleException(<span class="keyword">this</span>.getName(), e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">halt</span><span class="params">()</span> </span>{</span><br><span class="line">        stop = <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>LearnerHandler.run()</code> 方法，LearnerHandler 是一个线程类，上述的 <code>fh.start()</code> 执行的是 LearnerHandler 中的 <code>run()</code> 方法。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        leader.addLearnerHandler(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// 心跳处理</span></span><br><span class="line">        tickOfNextAckDeadline = leader.self.tick.get()</span><br><span class="line">                + leader.self.initLimit + leader.self.syncLimit;</span><br><span class="line"></span><br><span class="line">        ia = BinaryInputArchive.getArchive(bufferedInput);</span><br><span class="line">        bufferedOutput = <span class="keyword">new</span> BufferedOutputStream(sock.getOutputStream());</span><br><span class="line">        oa = BinaryOutputArchive.getArchive(bufferedOutput);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从网络中接收消息，并反序列化为 Packet</span></span><br><span class="line">        QuorumPacket qp = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">        ia.readRecord(qp, <span class="string">"packet"</span>);</span><br><span class="line">        <span class="comment">// 选举结束后，Observer 和 Follower 都应该给 Leader 发送一个标志信息：FOLLOWERINFO 或者 OBSERVERINFO</span></span><br><span class="line">        <span class="keyword">if</span>(qp.getType() != Leader.FOLLOWERINFO &amp;&amp; qp.getType() != Leader.OBSERVERINFO){</span><br><span class="line">            LOG.error(<span class="string">"First packet "</span> + qp.toString()</span><br><span class="line">                    + <span class="string">" is not FOLLOWERINFO or OBSERVERINFO!"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span> learnerInfoData[] = qp.getData();</span><br><span class="line">        <span class="keyword">if</span> (learnerInfoData != <span class="keyword">null</span>) {</span><br><span class="line">            ByteBuffer bbsid = ByteBuffer.wrap(learnerInfoData);</span><br><span class="line">            <span class="keyword">if</span> (learnerInfoData.length &gt;= <span class="number">8</span>) {</span><br><span class="line">                <span class="keyword">this</span>.sid = bbsid.getLong();</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (learnerInfoData.length &gt;= <span class="number">12</span>) {</span><br><span class="line">                <span class="keyword">this</span>.version = bbsid.getInt(); <span class="comment">// protocolVersion</span></span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (learnerInfoData.length &gt;= <span class="number">20</span>) {</span><br><span class="line">                <span class="keyword">long</span> configVersion = bbsid.getLong();</span><br><span class="line">                <span class="keyword">if</span> (configVersion &gt; leader.self.getQuorumVerifier().getVersion()) {</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Follower is ahead of the leader (has a later activated configuration)"</span>);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">this</span>.sid = leader.followerCounter.getAndDecrement();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (leader.self.getView().containsKey(<span class="keyword">this</span>.sid)) {</span><br><span class="line">            LOG.info(<span class="string">"Follower sid: "</span> + <span class="keyword">this</span>.sid + <span class="string">" : info : "</span></span><br><span class="line">                    + leader.self.getView().get(<span class="keyword">this</span>.sid).toString());</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            LOG.info(<span class="string">"Follower sid: "</span> + <span class="keyword">this</span>.sid + <span class="string">" not in the current config "</span> + Long.toHexString(leader.self.getQuorumVerifier().getVersion()));</span><br><span class="line">        }</span><br><span class="line">                    </span><br><span class="line">        <span class="keyword">if</span> (qp.getType() == Leader.OBSERVERINFO) {</span><br><span class="line">                learnerType = LearnerType.OBSERVER;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取 Follower 发送过来的 lastAcceptedEpoch</span></span><br><span class="line">        <span class="comment">// 选举过程中，所使用的 epoch（任期代号），其实还是上一任 Leader 的 epoch</span></span><br><span class="line">        <span class="keyword">long</span> lastAcceptedEpoch = ZxidUtils.getEpochFromZxid(qp.getZxid());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> peerLastZxid;</span><br><span class="line">        StateSummary ss = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取 Follower 发送过来的 zxid</span></span><br><span class="line">        <span class="keyword">long</span> zxid = qp.getZxid();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Leader 根据从 Follower 获取到的 sid 和旧的 epoch，构建新的 epoch</span></span><br><span class="line">        <span class="keyword">long</span> newEpoch = leader.getEpochToPropose(<span class="keyword">this</span>.getSid(), lastAcceptedEpoch);</span><br><span class="line">        <span class="keyword">long</span> newLeaderZxid = ZxidUtils.makeZxid(newEpoch, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.getVersion() &lt; <span class="number">0x10000</span>) {</span><br><span class="line">            <span class="comment">// we are going to have to extrapolate the epoch information</span></span><br><span class="line">            <span class="keyword">long</span> epoch = ZxidUtils.getEpochFromZxid(zxid);</span><br><span class="line">            ss = <span class="keyword">new</span> StateSummary(epoch, zxid);</span><br><span class="line">            <span class="comment">// fake the message</span></span><br><span class="line">            leader.waitForEpochAck(<span class="keyword">this</span>.getSid(), ss);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">byte</span> ver[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">            ByteBuffer.wrap(ver).putInt(<span class="number">0x10000</span>);</span><br><span class="line">            <span class="comment">// Leader 向 Follower 发送信息，包含：zxid 和 newEpoch</span></span><br><span class="line">            QuorumPacket newEpochPacket = <span class="keyword">new</span> QuorumPacket(Leader.LEADERINFO, newLeaderZxid, ver, <span class="keyword">null</span>);</span><br><span class="line">            oa.writeRecord(newEpochPacket, <span class="string">"packet"</span>);</span><br><span class="line">            bufferedOutput.flush();</span><br><span class="line">            QuorumPacket ackEpochPacket = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">            ia.readRecord(ackEpochPacket, <span class="string">"packet"</span>);</span><br><span class="line">            <span class="keyword">if</span> (ackEpochPacket.getType() != Leader.ACKEPOCH) {</span><br><span class="line">                LOG.error(ackEpochPacket.toString()</span><br><span class="line">                        + <span class="string">" is not ACKEPOCH"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">            ByteBuffer bbepoch = ByteBuffer.wrap(ackEpochPacket.getData());</span><br><span class="line">            ss = <span class="keyword">new</span> StateSummary(bbepoch.getInt(), ackEpochPacket.getZxid());</span><br><span class="line">            leader.waitForEpochAck(<span class="keyword">this</span>.getSid(), ss);</span><br><span class="line">        }</span><br><span class="line">        peerLastZxid = ss.getLastZxid();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Take any necessary action if we need to send TRUNC or DIFF</span></span><br><span class="line">        <span class="comment">// startForwarding() will be called in all cases</span></span><br><span class="line">        <span class="keyword">boolean</span> needSnap = syncFollower(peerLastZxid, leader.zk.getZKDatabase(), leader);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* if we are not truncating or sending a diff just send a snapshot */</span></span><br><span class="line">        <span class="keyword">if</span> (needSnap) {</span><br><span class="line">            <span class="keyword">boolean</span> exemptFromThrottle = getLearnerType() != LearnerType.OBSERVER;</span><br><span class="line">            LearnerSnapshot snapshot = </span><br><span class="line">                    leader.getLearnerSnapshotThrottler().beginSnapshot(exemptFromThrottle);</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="keyword">long</span> zxidToSend = leader.zk.getZKDatabase().getDataTreeLastProcessedZxid();</span><br><span class="line">                oa.writeRecord(<span class="keyword">new</span> QuorumPacket(Leader.SNAP, zxidToSend, <span class="keyword">null</span>, <span class="keyword">null</span>), <span class="string">"packet"</span>);</span><br><span class="line">                bufferedOutput.flush();</span><br><span class="line"></span><br><span class="line">                LOG.info(<span class="string">"Sending snapshot last zxid of peer is 0x{}, zxid of leader is 0x{}, "</span></span><br><span class="line">                        + <span class="string">"send zxid of db as 0x{}, {} concurrent snapshots, "</span> </span><br><span class="line">                        + <span class="string">"snapshot was {} from throttle"</span>,</span><br><span class="line">                        Long.toHexString(peerLastZxid), </span><br><span class="line">                        Long.toHexString(leaderLastZxid),</span><br><span class="line">                        Long.toHexString(zxidToSend), </span><br><span class="line">                        snapshot.getConcurrentSnapshotNumber(),</span><br><span class="line">                        snapshot.isEssential() ? <span class="string">"exempt"</span> : <span class="string">"not exempt"</span>);</span><br><span class="line">                <span class="comment">// Dump data to peer</span></span><br><span class="line">                leader.zk.getZKDatabase().serializeSnapshot(oa);</span><br><span class="line">                oa.writeString(<span class="string">"BenWasHere"</span>, <span class="string">"signature"</span>);</span><br><span class="line">                bufferedOutput.flush();</span><br><span class="line">            } <span class="keyword">finally</span> {</span><br><span class="line">                snapshot.close();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        LOG.debug(<span class="string">"Sending NEWLEADER message to "</span> + sid);</span><br><span class="line">        <span class="comment">// the version of this quorumVerifier will be set by leader.lead() in case</span></span><br><span class="line">        <span class="comment">// the leader is just being established. waitForEpochAck makes sure that readyToStart is true if</span></span><br><span class="line">        <span class="comment">// we got here, so the version was set</span></span><br><span class="line">        <span class="keyword">if</span> (getVersion() &lt; <span class="number">0x10000</span>) {</span><br><span class="line">            QuorumPacket newLeaderQP = <span class="keyword">new</span> QuorumPacket(Leader.NEWLEADER,</span><br><span class="line">                    newLeaderZxid, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            oa.writeRecord(newLeaderQP, <span class="string">"packet"</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            QuorumPacket newLeaderQP = <span class="keyword">new</span> QuorumPacket(Leader.NEWLEADER,</span><br><span class="line">                    newLeaderZxid, leader.self.getLastSeenQuorumVerifier()</span><br><span class="line">                            .toString().getBytes(), <span class="keyword">null</span>);</span><br><span class="line">            queuedPackets.add(newLeaderQP);</span><br><span class="line">        }</span><br><span class="line">        bufferedOutput.flush();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start thread that blast packets in the queue to learner</span></span><br><span class="line">        startSendingPackets();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * Have to wait for the first ACK, wait until</span></span><br><span class="line"><span class="comment">        * the leader is ready, and only then we can</span></span><br><span class="line"><span class="comment">        * start processing messages.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        qp = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">        ia.readRecord(qp, <span class="string">"packet"</span>);</span><br><span class="line">        <span class="keyword">if</span>(qp.getType() != Leader.ACK){</span><br><span class="line">            LOG.error(<span class="string">"Next packet was supposed to be an ACK,"</span></span><br><span class="line">                + <span class="string">" but received packet: {}"</span>, packetToString(qp));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(LOG.isDebugEnabled()){</span><br><span class="line">            LOG.debug(<span class="string">"Received NEWLEADER-ACK message from "</span> + sid);   </span><br><span class="line">        }</span><br><span class="line">        leader.waitForNewLeaderAck(getSid(), qp.getZxid());</span><br><span class="line"></span><br><span class="line">        syncLimitCheck.start();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// now that the ack has been processed expect the syncLimit</span></span><br><span class="line">        sock.setSoTimeout(leader.self.tickTime * leader.self.syncLimit);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * Wait until leader starts up</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">synchronized</span>(leader.zk){</span><br><span class="line">            <span class="keyword">while</span>(!leader.zk.isRunning() &amp;&amp; !<span class="keyword">this</span>.isInterrupted()){</span><br><span class="line">                leader.zk.wait(<span class="number">20</span>);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// Mutation packets will be queued during the serialize,</span></span><br><span class="line">        <span class="comment">// so we need to mark when the peer can actually start</span></span><br><span class="line">        <span class="comment">// using the data</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        LOG.debug(<span class="string">"Sending UPTODATE message to "</span> + sid);      </span><br><span class="line">        queuedPackets.add(<span class="keyword">new</span> QuorumPacket(Leader.UPTODATE, -<span class="number">1</span>, <span class="keyword">null</span>, <span class="keyword">null</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) {</span><br><span class="line">            qp = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">            ia.readRecord(qp, <span class="string">"packet"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">long</span> traceMask = ZooTrace.SERVER_PACKET_TRACE_MASK;</span><br><span class="line">            <span class="keyword">if</span> (qp.getType() == Leader.PING) {</span><br><span class="line">                traceMask = ZooTrace.SERVER_PING_TRACE_MASK;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (LOG.isTraceEnabled()) {</span><br><span class="line">                ZooTrace.logQuorumPacket(LOG, traceMask, <span class="string">'i'</span>, qp);</span><br><span class="line">            }</span><br><span class="line">            tickOfNextAckDeadline = leader.self.tick.get() + leader.self.syncLimit;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            ByteBuffer bb;</span><br><span class="line">            <span class="keyword">long</span> sessionId;</span><br><span class="line">            <span class="keyword">int</span> cxid;</span><br><span class="line">            <span class="keyword">int</span> type;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (qp.getType()) {</span><br><span class="line">            <span class="keyword">case</span> Leader.ACK:</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.learnerType == LearnerType.OBSERVER) {</span><br><span class="line">                    <span class="keyword">if</span> (LOG.isDebugEnabled()) {</span><br><span class="line">                        LOG.debug(<span class="string">"Received ACK from Observer  "</span> + <span class="keyword">this</span>.sid);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">                syncLimitCheck.updateAck(qp.getZxid());</span><br><span class="line">                leader.processAck(<span class="keyword">this</span>.sid, qp.getZxid(), sock.getLocalSocketAddress());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Leader.PING:</span><br><span class="line">                <span class="comment">// Process the touches</span></span><br><span class="line">                ByteArrayInputStream bis = <span class="keyword">new</span> ByteArrayInputStream(qp</span><br><span class="line">                        .getData());</span><br><span class="line">                DataInputStream dis = <span class="keyword">new</span> DataInputStream(bis);</span><br><span class="line">                <span class="keyword">while</span> (dis.available() &gt; <span class="number">0</span>) {</span><br><span class="line">                    <span class="keyword">long</span> sess = dis.readLong();</span><br><span class="line">                    <span class="keyword">int</span> to = dis.readInt();</span><br><span class="line">                    leader.zk.touch(sess, to);</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Leader.REVALIDATE:</span><br><span class="line">                bis = <span class="keyword">new</span> ByteArrayInputStream(qp.getData());</span><br><span class="line">                dis = <span class="keyword">new</span> DataInputStream(bis);</span><br><span class="line">                <span class="keyword">long</span> id = dis.readLong();</span><br><span class="line">                <span class="keyword">int</span> to = dis.readInt();</span><br><span class="line">                ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                DataOutputStream dos = <span class="keyword">new</span> DataOutputStream(bos);</span><br><span class="line">                dos.writeLong(id);</span><br><span class="line">                <span class="keyword">boolean</span> valid = leader.zk.checkIfValidGlobalSession(id, to);</span><br><span class="line">                <span class="keyword">if</span> (valid) {</span><br><span class="line">                    <span class="keyword">try</span> {</span><br><span class="line">                        <span class="comment">//set the session owner</span></span><br><span class="line">                        <span class="comment">// as the follower that</span></span><br><span class="line">                        <span class="comment">// owns the session</span></span><br><span class="line">                        leader.zk.setOwner(id, <span class="keyword">this</span>);</span><br><span class="line">                    } <span class="keyword">catch</span> (SessionExpiredException e) {</span><br><span class="line">                        LOG.error(<span class="string">"Somehow session "</span> + Long.toHexString(id) +</span><br><span class="line">                                <span class="string">" expired right after being renewed! (impossible)"</span>, e);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">if</span> (LOG.isTraceEnabled()) {</span><br><span class="line">                    ZooTrace.logTraceMessage(LOG,</span><br><span class="line">                                                ZooTrace.SESSION_TRACE_MASK,</span><br><span class="line">                                                <span class="string">"Session 0x"</span> + Long.toHexString(id)</span><br><span class="line">                                                + <span class="string">" is valid: "</span>+ valid);</span><br><span class="line">                }</span><br><span class="line">                dos.writeBoolean(valid);</span><br><span class="line">                qp.setData(bos.toByteArray());</span><br><span class="line">                queuedPackets.add(qp);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Leader.REQUEST:</span><br><span class="line">                bb = ByteBuffer.wrap(qp.getData());</span><br><span class="line">                sessionId = bb.getLong();</span><br><span class="line">                cxid = bb.getInt();</span><br><span class="line">                type = bb.getInt();</span><br><span class="line">                bb = bb.slice();</span><br><span class="line">                Request si;</span><br><span class="line">                <span class="keyword">if</span>(type == OpCode.sync){</span><br><span class="line">                    si = <span class="keyword">new</span> LearnerSyncRequest(<span class="keyword">this</span>, sessionId, cxid, type, bb, qp.getAuthinfo());</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    si = <span class="keyword">new</span> Request(<span class="keyword">null</span>, sessionId, cxid, type, bb, qp.getAuthinfo());</span><br><span class="line">                }</span><br><span class="line">                si.setOwner(<span class="keyword">this</span>);</span><br><span class="line">                leader.zk.submitLearnerRequest(si);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                LOG.warn(<span class="string">"unexpected quorum packet, type: {}"</span>, packetToString(qp));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">        <span class="keyword">if</span> (sock != <span class="keyword">null</span> &amp;&amp; !sock.isClosed()) {</span><br><span class="line">            LOG.error(<span class="string">"Unexpected exception causing shutdown while sock "</span></span><br><span class="line">                    + <span class="string">"still open"</span>, e);</span><br><span class="line">            <span class="comment">//close the socket to make sure the</span></span><br><span class="line">            <span class="comment">//other side can see it being close</span></span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                sock.close();</span><br><span class="line">            } <span class="keyword">catch</span>(IOException ie) {</span><br><span class="line">                <span class="comment">// do nothing</span></span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">        LOG.error(<span class="string">"Unexpected exception causing shutdown"</span>, e);</span><br><span class="line">    } <span class="keyword">catch</span> (SnapshotThrottleException e) {</span><br><span class="line">        LOG.error(<span class="string">"too many concurrent snapshots: "</span> + e);</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        LOG.warn(<span class="string">"******* GOODBYE "</span></span><br><span class="line">                + (sock != <span class="keyword">null</span> ? sock.getRemoteSocketAddress() : <span class="string">"&lt;null&gt;"</span>)</span><br><span class="line">                + <span class="string">" ********"</span>);</span><br><span class="line">        shutdown();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="Follower-向-Leader-注册"><a href="#Follower-向-Leader-注册" class="headerlink" title="Follower 向 Leader 注册"></a>Follower 向 Leader 注册</h3><ul><li><code>Follower.followLeader()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">followLeader</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>{</span><br><span class="line">    self.end_fle = Time.currentElapsedTime();</span><br><span class="line">    <span class="keyword">long</span> electionTimeTaken = self.end_fle - self.start_fle;</span><br><span class="line">    self.setElectionTimeTaken(electionTimeTaken);</span><br><span class="line">    LOG.info(<span class="string">"FOLLOWING - LEADER ELECTION TOOK - {} {}"</span>, electionTimeTaken,</span><br><span class="line">            QuorumPeer.FLE_TIME_UNIT);</span><br><span class="line">    self.start_fle = <span class="number">0</span>;</span><br><span class="line">    self.end_fle = <span class="number">0</span>;</span><br><span class="line">    fzk.registerJMX(<span class="keyword">new</span> FollowerBean(<span class="keyword">this</span>, zk), self.jmxLocalPeerBean);</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// Follower 查找 Leader</span></span><br><span class="line">        QuorumServer leaderServer = findLeader();            </span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// Follower 连接 Leader</span></span><br><span class="line">            connectToLeader(leaderServer.addr, leaderServer.hostname);</span><br><span class="line">            <span class="comment">// Follower 向 Leader 注册</span></span><br><span class="line">            <span class="keyword">long</span> newEpochZxid = registerWithLeader(Leader.FOLLOWERINFO);</span><br><span class="line">            <span class="keyword">if</span> (self.isReconfigStateChange())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"learned about role change"</span>);</span><br><span class="line">            <span class="comment">//check to see if the leader zxid is lower than ours</span></span><br><span class="line">            <span class="comment">//this should never happen but is just a safety check</span></span><br><span class="line">            <span class="keyword">long</span> newEpoch = ZxidUtils.getEpochFromZxid(newEpochZxid);</span><br><span class="line">            <span class="keyword">if</span> (newEpoch &lt; self.getAcceptedEpoch()) {</span><br><span class="line">                LOG.error(<span class="string">"Proposed leader epoch "</span> + ZxidUtils.zxidToString(newEpochZxid)</span><br><span class="line">                        + <span class="string">" is less than our accepted epoch "</span> + ZxidUtils.zxidToString(self.getAcceptedEpoch()));</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Error: Epoch of leader is lower"</span>);</span><br><span class="line">            }</span><br><span class="line">            syncWithLeader(newEpochZxid);                </span><br><span class="line">            QuorumPacket qp = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">            <span class="comment">// 循环等待接收消息</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">this</span>.isRunning()) {</span><br><span class="line">                <span class="comment">// 读取 Packet 消息</span></span><br><span class="line">                readPacket(qp);</span><br><span class="line">                <span class="comment">// 处理 Packet 消息</span></span><br><span class="line">                processPacket(qp);</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            LOG.warn(<span class="string">"Exception when following the leader"</span>, e);</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                sock.close();</span><br><span class="line">            } <span class="keyword">catch</span> (IOException e1) {</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// clear pending revalidations</span></span><br><span class="line">            pendingRevalidations.clear();</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        zk.unregisterJMX((Learner)<span class="keyword">this</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>Learner.registerWithLeader()</code> 方法，Follower 向 Leader 注册</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">long</span> <span class="title">registerWithLeader</span><span class="params">(<span class="keyword">int</span> pktType)</span> <span class="keyword">throws</span> IOException</span>{</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * Send follower info, including last zxid and sid</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">long</span> lastLoggedZxid = self.getLastLoggedZxid();</span><br><span class="line">    QuorumPacket qp = <span class="keyword">new</span> QuorumPacket();                </span><br><span class="line">    qp.setType(pktType);</span><br><span class="line">    qp.setZxid(ZxidUtils.makeZxid(self.getAcceptedEpoch(), <span class="number">0</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * Add sid to payload</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    LearnerInfo li = <span class="keyword">new</span> LearnerInfo(self.getId(), <span class="number">0x10000</span>, self.getQuorumVerifier().getVersion());</span><br><span class="line">    ByteArrayOutputStream bsid = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">    BinaryOutputArchive boa = BinaryOutputArchive.getArchive(bsid);</span><br><span class="line">    boa.writeRecord(li, <span class="string">"LearnerInfo"</span>);</span><br><span class="line">    qp.setData(bsid.toByteArray());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送 Follower 的信息（FollowerInfo）给 Leader</span></span><br><span class="line">    writePacket(qp, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取 Leader 返回的结果（LeaderInfo）</span></span><br><span class="line">    readPacket(qp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> newEpoch = ZxidUtils.getEpochFromZxid(qp.getZxid());</span><br><span class="line">    <span class="comment">// 如果接收到 Leader 返回的结果</span></span><br><span class="line">    <span class="keyword">if</span> (qp.getType() == Leader.LEADERINFO) {</span><br><span class="line">        <span class="comment">// we are connected to a 1.0 server so accept the new epoch and read the next packet</span></span><br><span class="line">        leaderProtocolVersion = ByteBuffer.wrap(qp.getData()).getInt();</span><br><span class="line">        <span class="keyword">byte</span> epochBytes[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">        <span class="keyword">final</span> ByteBuffer wrappedEpochBytes = ByteBuffer.wrap(epochBytes);</span><br><span class="line">        <span class="comment">// 接收 Leader 的 epoch</span></span><br><span class="line">        <span class="keyword">if</span> (newEpoch &gt; self.getAcceptedEpoch()) {</span><br><span class="line">            <span class="comment">// 将自己原来的 epoch 保存在 wrappedEpochBytes 里面</span></span><br><span class="line">            wrappedEpochBytes.putInt((<span class="keyword">int</span>)self.getCurrentEpoch());</span><br><span class="line">            <span class="comment">// 将 Leader 发送过来的 epoch 保存起来</span></span><br><span class="line">            self.setAcceptedEpoch(newEpoch);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (newEpoch == self.getAcceptedEpoch()) {</span><br><span class="line">            <span class="comment">// since we have already acked an epoch equal to the leaders, we cannot ack</span></span><br><span class="line">            <span class="comment">// again, but we still need to send our lastZxid to the leader so that we can</span></span><br><span class="line">            <span class="comment">// sync with it if it does assume leadership of the epoch.</span></span><br><span class="line">            <span class="comment">// the -1 indicates that this reply should not count as an ack for the new epoch</span></span><br><span class="line">            wrappedEpochBytes.putInt(-<span class="number">1</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Leaders epoch, "</span> + newEpoch + <span class="string">" is less than accepted epoch, "</span> + self.getAcceptedEpoch());</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 发送 ackepoch 给 Leader，包含了 Follwoer 自己的 epoch 和 zxid</span></span><br><span class="line">        QuorumPacket ackNewEpoch = <span class="keyword">new</span> QuorumPacket(Leader.ACKEPOCH, lastLoggedZxid, epochBytes, <span class="keyword">null</span>);</span><br><span class="line">        writePacket(ackNewEpoch, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> ZxidUtils.makeZxid(newEpoch, <span class="number">0</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">if</span> (newEpoch &gt; self.getAcceptedEpoch()) {</span><br><span class="line">            self.setAcceptedEpoch(newEpoch);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (qp.getType() != Leader.NEWLEADER) {</span><br><span class="line">            LOG.error(<span class="string">"First packet should have been NEWLEADER"</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"First packet should have been NEWLEADER"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> qp.getZxid();</span><br><span class="line">    }</span><br><span class="line">} </span><br></pre></td></tr></tbody></table></figure><h3 id="Leader-接收-Follower-的状态信息，根据同步方式发送同步消息"><a href="#Leader-接收-Follower-的状态信息，根据同步方式发送同步消息" class="headerlink" title="Leader 接收 Follower 的状态信息，根据同步方式发送同步消息"></a>Leader 接收 Follower 的状态信息，根据同步方式发送同步消息</h3><ul><li><code>LearnerHandler.run()</code> 方法，处理 Follower 的请求。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        leader.addLearnerHandler(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// 心跳处理</span></span><br><span class="line">        tickOfNextAckDeadline = leader.self.tick.get()</span><br><span class="line">                + leader.self.initLimit + leader.self.syncLimit;</span><br><span class="line"></span><br><span class="line">        ia = BinaryInputArchive.getArchive(bufferedInput);</span><br><span class="line">        bufferedOutput = <span class="keyword">new</span> BufferedOutputStream(sock.getOutputStream());</span><br><span class="line">        oa = BinaryOutputArchive.getArchive(bufferedOutput);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从网络中接收消息，并反序列化为 Packet</span></span><br><span class="line">        QuorumPacket qp = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">        ia.readRecord(qp, <span class="string">"packet"</span>);</span><br><span class="line">        <span class="comment">// 选举结束后，Observer 和 Follower 都应该给 Leader 发送一个标志信息：FOLLOWERINFO 或者 OBSERVERINFO</span></span><br><span class="line">        <span class="keyword">if</span>(qp.getType() != Leader.FOLLOWERINFO &amp;&amp; qp.getType() != Leader.OBSERVERINFO){</span><br><span class="line">            LOG.error(<span class="string">"First packet "</span> + qp.toString()</span><br><span class="line">                    + <span class="string">" is not FOLLOWERINFO or OBSERVERINFO!"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span> learnerInfoData[] = qp.getData();</span><br><span class="line">        <span class="keyword">if</span> (learnerInfoData != <span class="keyword">null</span>) {</span><br><span class="line">            ByteBuffer bbsid = ByteBuffer.wrap(learnerInfoData);</span><br><span class="line">            <span class="keyword">if</span> (learnerInfoData.length &gt;= <span class="number">8</span>) {</span><br><span class="line">                <span class="keyword">this</span>.sid = bbsid.getLong();</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (learnerInfoData.length &gt;= <span class="number">12</span>) {</span><br><span class="line">                <span class="keyword">this</span>.version = bbsid.getInt(); <span class="comment">// protocolVersion</span></span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (learnerInfoData.length &gt;= <span class="number">20</span>) {</span><br><span class="line">                <span class="keyword">long</span> configVersion = bbsid.getLong();</span><br><span class="line">                <span class="keyword">if</span> (configVersion &gt; leader.self.getQuorumVerifier().getVersion()) {</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Follower is ahead of the leader (has a later activated configuration)"</span>);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">this</span>.sid = leader.followerCounter.getAndDecrement();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (leader.self.getView().containsKey(<span class="keyword">this</span>.sid)) {</span><br><span class="line">            LOG.info(<span class="string">"Follower sid: "</span> + <span class="keyword">this</span>.sid + <span class="string">" : info : "</span></span><br><span class="line">                    + leader.self.getView().get(<span class="keyword">this</span>.sid).toString());</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            LOG.info(<span class="string">"Follower sid: "</span> + <span class="keyword">this</span>.sid + <span class="string">" not in the current config "</span> + Long.toHexString(leader.self.getQuorumVerifier().getVersion()));</span><br><span class="line">        }</span><br><span class="line">                    </span><br><span class="line">        <span class="keyword">if</span> (qp.getType() == Leader.OBSERVERINFO) {</span><br><span class="line">                learnerType = LearnerType.OBSERVER;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取 Follower 发送过来的 lastAcceptedEpoch</span></span><br><span class="line">        <span class="comment">// 选举过程中，所使用的 epoch（任期代号），其实还是上一任 Leader 的 epoch</span></span><br><span class="line">        <span class="keyword">long</span> lastAcceptedEpoch = ZxidUtils.getEpochFromZxid(qp.getZxid());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> peerLastZxid;</span><br><span class="line">        StateSummary ss = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取 Follower 发送过来的 zxid</span></span><br><span class="line">        <span class="keyword">long</span> zxid = qp.getZxid();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Leader 根据从 Follower 获取到的 sid 和旧的 epoch，构建新的 epoch</span></span><br><span class="line">        <span class="keyword">long</span> newEpoch = leader.getEpochToPropose(<span class="keyword">this</span>.getSid(), lastAcceptedEpoch);</span><br><span class="line">        <span class="keyword">long</span> newLeaderZxid = ZxidUtils.makeZxid(newEpoch, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.getVersion() &lt; <span class="number">0x10000</span>) {</span><br><span class="line">            <span class="comment">// we are going to have to extrapolate the epoch information</span></span><br><span class="line">            <span class="keyword">long</span> epoch = ZxidUtils.getEpochFromZxid(zxid);</span><br><span class="line">            ss = <span class="keyword">new</span> StateSummary(epoch, zxid);</span><br><span class="line">            <span class="comment">// fake the message</span></span><br><span class="line">            leader.waitForEpochAck(<span class="keyword">this</span>.getSid(), ss);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">byte</span> ver[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">            ByteBuffer.wrap(ver).putInt(<span class="number">0x10000</span>);</span><br><span class="line">            <span class="comment">// Leader 向 Follower 发送信息，包含：zxid 和 newEpoch</span></span><br><span class="line">            QuorumPacket newEpochPacket = <span class="keyword">new</span> QuorumPacket(Leader.LEADERINFO, newLeaderZxid, ver, <span class="keyword">null</span>);</span><br><span class="line">            oa.writeRecord(newEpochPacket, <span class="string">"packet"</span>);</span><br><span class="line">            bufferedOutput.flush();</span><br><span class="line">            <span class="comment">// 接收到 Follower 应答的 ackepoch</span></span><br><span class="line">            QuorumPacket ackEpochPacket = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">            ia.readRecord(ackEpochPacket, <span class="string">"packet"</span>);</span><br><span class="line">            <span class="keyword">if</span> (ackEpochPacket.getType() != Leader.ACKEPOCH) {</span><br><span class="line">                LOG.error(ackEpochPacket.toString()</span><br><span class="line">                        + <span class="string">" is not ACKEPOCH"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">            ByteBuffer bbepoch = ByteBuffer.wrap(ackEpochPacket.getData());</span><br><span class="line">            <span class="comment">// 保存了对方 Follower 或者 Observer 的状态信息，包括：epoch 和 zxid</span></span><br><span class="line">            ss = <span class="keyword">new</span> StateSummary(bbepoch.getInt(), ackEpochPacket.getZxid());</span><br><span class="line">            leader.waitForEpochAck(<span class="keyword">this</span>.getSid(), ss);</span><br><span class="line">        }</span><br><span class="line">        peerLastZxid = ss.getLastZxid();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Take any necessary action if we need to send TRUNC or DIFF</span></span><br><span class="line">        <span class="comment">// startForwarding() will be called in all cases</span></span><br><span class="line">        <span class="comment">// 判断 Leader 和 Follower 之间是否需要进行同步</span></span><br><span class="line">        <span class="keyword">boolean</span> needSnap = syncFollower(peerLastZxid, leader.zk.getZKDatabase(), leader);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* if we are not truncating or sending a diff just send a snapshot */</span></span><br><span class="line">        <span class="keyword">if</span> (needSnap) {</span><br><span class="line">            <span class="keyword">boolean</span> exemptFromThrottle = getLearnerType() != LearnerType.OBSERVER;</span><br><span class="line">            LearnerSnapshot snapshot = </span><br><span class="line">                    leader.getLearnerSnapshotThrottler().beginSnapshot(exemptFromThrottle);</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="keyword">long</span> zxidToSend = leader.zk.getZKDatabase().getDataTreeLastProcessedZxid();</span><br><span class="line">                oa.writeRecord(<span class="keyword">new</span> QuorumPacket(Leader.SNAP, zxidToSend, <span class="keyword">null</span>, <span class="keyword">null</span>), <span class="string">"packet"</span>);</span><br><span class="line">                bufferedOutput.flush();</span><br><span class="line"></span><br><span class="line">                LOG.info(<span class="string">"Sending snapshot last zxid of peer is 0x{}, zxid of leader is 0x{}, "</span></span><br><span class="line">                        + <span class="string">"send zxid of db as 0x{}, {} concurrent snapshots, "</span> </span><br><span class="line">                        + <span class="string">"snapshot was {} from throttle"</span>,</span><br><span class="line">                        Long.toHexString(peerLastZxid), </span><br><span class="line">                        Long.toHexString(leaderLastZxid),</span><br><span class="line">                        Long.toHexString(zxidToSend), </span><br><span class="line">                        snapshot.getConcurrentSnapshotNumber(),</span><br><span class="line">                        snapshot.isEssential() ? <span class="string">"exempt"</span> : <span class="string">"not exempt"</span>);</span><br><span class="line">                <span class="comment">// Dump data to peer</span></span><br><span class="line">                leader.zk.getZKDatabase().serializeSnapshot(oa);</span><br><span class="line">                oa.writeString(<span class="string">"BenWasHere"</span>, <span class="string">"signature"</span>);</span><br><span class="line">                bufferedOutput.flush();</span><br><span class="line">            } <span class="keyword">finally</span> {</span><br><span class="line">                snapshot.close();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        LOG.debug(<span class="string">"Sending NEWLEADER message to "</span> + sid);</span><br><span class="line">        <span class="comment">// the version of this quorumVerifier will be set by leader.lead() in case</span></span><br><span class="line">        <span class="comment">// the leader is just being established. waitForEpochAck makes sure that readyToStart is true if</span></span><br><span class="line">        <span class="comment">// we got here, so the version was set</span></span><br><span class="line">        <span class="keyword">if</span> (getVersion() &lt; <span class="number">0x10000</span>) {</span><br><span class="line">            QuorumPacket newLeaderQP = <span class="keyword">new</span> QuorumPacket(Leader.NEWLEADER,</span><br><span class="line">                    newLeaderZxid, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            oa.writeRecord(newLeaderQP, <span class="string">"packet"</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            QuorumPacket newLeaderQP = <span class="keyword">new</span> QuorumPacket(Leader.NEWLEADER,</span><br><span class="line">                    newLeaderZxid, leader.self.getLastSeenQuorumVerifier()</span><br><span class="line">                            .toString().getBytes(), <span class="keyword">null</span>);</span><br><span class="line">            queuedPackets.add(newLeaderQP);</span><br><span class="line">        }</span><br><span class="line">        bufferedOutput.flush();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start thread that blast packets in the queue to learner</span></span><br><span class="line">        startSendingPackets();</span><br><span class="line">        </span><br><span class="line">        ......</span><br><span class="line">  </span><br><span class="line">    } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">        ......</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        ......</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>LearnerHandler.syncFollower()</code> 方法，判断 Leader 和 Follower 之间是否需要进行同步。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">syncFollower</span><span class="params">(<span class="keyword">long</span> peerLastZxid, ZKDatabase db, Leader leader)</span> </span>{</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * When leader election is completed, the leader will set its</span></span><br><span class="line"><span class="comment">    * lastProcessedZxid to be (epoch &lt; 32). There will be no txn associated</span></span><br><span class="line"><span class="comment">    * with this zxid.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * The learner will set its lastProcessedZxid to the same value if</span></span><br><span class="line"><span class="comment">    * it get DIFF or SNAP from the leader. If the same learner come</span></span><br><span class="line"><span class="comment">    * back to sync with leader using this zxid, we will never find this</span></span><br><span class="line"><span class="comment">    * zxid in our history. In this case, we will ignore TRUNC logic and</span></span><br><span class="line"><span class="comment">    * always send DIFF if we have old enough history</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">boolean</span> isPeerNewEpochZxid = (peerLastZxid &amp; <span class="number">0xffffffffL</span>) == <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// Keep track of the latest zxid which already queued</span></span><br><span class="line">    <span class="keyword">long</span> currentZxid = peerLastZxid;</span><br><span class="line">    <span class="keyword">boolean</span> needSnap = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">boolean</span> txnLogSyncEnabled = db.isTxnLogSyncEnabled();</span><br><span class="line">    ReentrantReadWriteLock lock = db.getLogLock();</span><br><span class="line">    ReadLock rl = lock.readLock();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        rl.lock();</span><br><span class="line">        <span class="keyword">long</span> maxCommittedLog = db.getmaxCommittedLog();</span><br><span class="line">        <span class="keyword">long</span> minCommittedLog = db.getminCommittedLog();</span><br><span class="line">        <span class="keyword">long</span> lastProcessedZxid = db.getDataTreeLastProcessedZxid();</span><br><span class="line"></span><br><span class="line">        LOG.info(<span class="string">"Synchronizing with Follower sid: {} maxCommittedLog=0x{}"</span></span><br><span class="line">                + <span class="string">" minCommittedLog=0x{} lastProcessedZxid=0x{}"</span></span><br><span class="line">                + <span class="string">" peerLastZxid=0x{}"</span>, getSid(),</span><br><span class="line">                Long.toHexString(maxCommittedLog),</span><br><span class="line">                Long.toHexString(minCommittedLog),</span><br><span class="line">                Long.toHexString(lastProcessedZxid),</span><br><span class="line">                Long.toHexString(peerLastZxid));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (db.getCommittedLog().isEmpty()) {</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            * It is possible that committedLog is empty. In that case</span></span><br><span class="line"><span class="comment">            * setting these value to the latest txn in leader db</span></span><br><span class="line"><span class="comment">            * will reduce the case that we need to handle</span></span><br><span class="line"><span class="comment">            *</span></span><br><span class="line"><span class="comment">            * Here is how each case handle by the if block below</span></span><br><span class="line"><span class="comment">            * 1. lastProcessZxid == peerZxid -&gt; Handle by (2)</span></span><br><span class="line"><span class="comment">            * 2. lastProcessZxid &lt; peerZxid -&gt; Handle by (3)</span></span><br><span class="line"><span class="comment">            * 3. lastProcessZxid &gt; peerZxid -&gt; Handle by (5)</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            minCommittedLog = lastProcessedZxid;</span><br><span class="line">            maxCommittedLog = lastProcessedZxid;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * Here are the cases that we want to handle</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * 1. Force sending snapshot (for testing purpose)</span></span><br><span class="line"><span class="comment">        * 2. Peer and leader is already sync, send empty diff</span></span><br><span class="line"><span class="comment">        * 3. Follower has txn that we haven't seen. This may be old leader</span></span><br><span class="line"><span class="comment">        *    so we need to send TRUNC. However, if peer has newEpochZxid,</span></span><br><span class="line"><span class="comment">        *    we cannot send TRUNC since the follower has no txnlog</span></span><br><span class="line"><span class="comment">        * 4. Follower is within committedLog range or already in-sync.</span></span><br><span class="line"><span class="comment">        *    We may need to send DIFF or TRUNC depending on follower's zxid</span></span><br><span class="line"><span class="comment">        *    We always send empty DIFF if follower is already in-sync</span></span><br><span class="line"><span class="comment">        * 5. Follower missed the committedLog. We will try to use on-disk</span></span><br><span class="line"><span class="comment">        *    txnlog + committedLog to sync with follower. If that fail,</span></span><br><span class="line"><span class="comment">        *    we will send snapshot</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (forceSnapSync) {</span><br><span class="line">            <span class="comment">// Force leader to use snapshot to sync with follower</span></span><br><span class="line">            LOG.warn(<span class="string">"Forcing snapshot sync - should not see this in production"</span>);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (lastProcessedZxid == peerLastZxid) {</span><br><span class="line">            <span class="comment">// Follower is already sync with us, send empty diff</span></span><br><span class="line">            LOG.info(<span class="string">"Sending DIFF zxid=0x"</span> + Long.toHexString(peerLastZxid) +</span><br><span class="line">                        <span class="string">" for peer sid: "</span> +  getSid());</span><br><span class="line">            queueOpPacket(Leader.DIFF, peerLastZxid);</span><br><span class="line">            needOpPacket = <span class="keyword">false</span>;</span><br><span class="line">            needSnap = <span class="keyword">false</span>;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (peerLastZxid &gt; maxCommittedLog &amp;&amp; !isPeerNewEpochZxid) {</span><br><span class="line">            <span class="comment">// Newer than committedLog, send trunc and done</span></span><br><span class="line">            LOG.debug(<span class="string">"Sending TRUNC to follower zxidToSend=0x"</span> +</span><br><span class="line">                        Long.toHexString(maxCommittedLog) +</span><br><span class="line">                        <span class="string">" for peer sid:"</span> +  getSid());</span><br><span class="line">            queueOpPacket(Leader.TRUNC, maxCommittedLog);</span><br><span class="line">            currentZxid = maxCommittedLog;</span><br><span class="line">            needOpPacket = <span class="keyword">false</span>;</span><br><span class="line">            needSnap = <span class="keyword">false</span>;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> ((maxCommittedLog &gt;= peerLastZxid)</span><br><span class="line">                &amp;&amp; (minCommittedLog &lt;= peerLastZxid)) {</span><br><span class="line">            <span class="comment">// Follower is within commitLog range</span></span><br><span class="line">            LOG.info(<span class="string">"Using committedLog for peer sid: "</span> +  getSid());</span><br><span class="line">            Iterator&lt;Proposal&gt; itr = db.getCommittedLog().iterator();</span><br><span class="line">            currentZxid = queueCommittedProposals(itr, peerLastZxid,</span><br><span class="line">                                                    <span class="keyword">null</span>, maxCommittedLog);</span><br><span class="line">            needSnap = <span class="keyword">false</span>;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (peerLastZxid &lt; minCommittedLog &amp;&amp; txnLogSyncEnabled) {</span><br><span class="line">            <span class="comment">// Use txnlog and committedLog to sync</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Calculate sizeLimit that we allow to retrieve txnlog from disk</span></span><br><span class="line">            <span class="keyword">long</span> sizeLimit = db.calculateTxnLogSizeLimit();</span><br><span class="line">            <span class="comment">// This method can return empty iterator if the requested zxid</span></span><br><span class="line">            <span class="comment">// is older than on-disk txnlog</span></span><br><span class="line">            Iterator&lt;Proposal&gt; txnLogItr = db.getProposalsFromTxnLog(</span><br><span class="line">                    peerLastZxid, sizeLimit);</span><br><span class="line">            <span class="keyword">if</span> (txnLogItr.hasNext()) {</span><br><span class="line">                LOG.info(<span class="string">"Use txnlog and committedLog for peer sid: "</span> +  getSid());</span><br><span class="line">                currentZxid = queueCommittedProposals(txnLogItr, peerLastZxid,</span><br><span class="line">                                                        minCommittedLog, maxCommittedLog);</span><br><span class="line"></span><br><span class="line">                LOG.debug(<span class="string">"Queueing committedLog 0x"</span> + Long.toHexString(currentZxid));</span><br><span class="line">                Iterator&lt;Proposal&gt; committedLogItr = db.getCommittedLog().iterator();</span><br><span class="line">                currentZxid = queueCommittedProposals(committedLogItr, currentZxid,</span><br><span class="line">                                                        <span class="keyword">null</span>, maxCommittedLog);</span><br><span class="line">                needSnap = <span class="keyword">false</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// closing the resources</span></span><br><span class="line">            <span class="keyword">if</span> (txnLogItr <span class="keyword">instanceof</span> TxnLogProposalIterator) {</span><br><span class="line">                TxnLogProposalIterator txnProposalItr = (TxnLogProposalIterator) txnLogItr;</span><br><span class="line">                txnProposalItr.close();</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            LOG.warn(<span class="string">"Unhandled scenario for peer sid: "</span> +  getSid());</span><br><span class="line">        }</span><br><span class="line">        LOG.debug(<span class="string">"Start forwarding 0x"</span> + Long.toHexString(currentZxid) +</span><br><span class="line">                    <span class="string">" for peer sid: "</span> +  getSid());</span><br><span class="line">        leaderLastZxid = leader.startForwarding(<span class="keyword">this</span>, currentZxid);</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        rl.unlock();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (needOpPacket &amp;&amp; !needSnap) {</span><br><span class="line">        <span class="comment">// This should never happen, but we should fall back to sending</span></span><br><span class="line">        <span class="comment">// snapshot just in case.</span></span><br><span class="line">        LOG.error(<span class="string">"Unhandled scenario for peer sid: "</span> +  getSid() +</span><br><span class="line">                    <span class="string">" fall back to use snapshot"</span>);</span><br><span class="line">        needSnap = <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> needSnap;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="Follower-应答-Leader-同步结果"><a href="#Follower-应答-Leader-同步结果" class="headerlink" title="Follower 应答 Leader 同步结果"></a>Follower 应答 Leader 同步结果</h3><ul><li><code>Follower.processPacket()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processPacket</span><span class="params">(QuorumPacket qp)</span> <span class="keyword">throws</span> Exception</span>{</span><br><span class="line">    <span class="keyword">switch</span> (qp.getType()) {</span><br><span class="line">    <span class="keyword">case</span> Leader.PING:            </span><br><span class="line">        ping(qp);            </span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Leader.PROPOSAL:           </span><br><span class="line">        TxnHeader hdr = <span class="keyword">new</span> TxnHeader();</span><br><span class="line">        Record txn = SerializeUtils.deserializeTxn(qp.getData(), hdr);</span><br><span class="line">        <span class="keyword">if</span> (hdr.getZxid() != lastQueued + <span class="number">1</span>) {</span><br><span class="line">            LOG.warn(<span class="string">"Got zxid 0x"</span></span><br><span class="line">                    + Long.toHexString(hdr.getZxid())</span><br><span class="line">                    + <span class="string">" expected 0x"</span></span><br><span class="line">                    + Long.toHexString(lastQueued + <span class="number">1</span>));</span><br><span class="line">        }</span><br><span class="line">        lastQueued = hdr.getZxid();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (hdr.getType() == OpCode.reconfig){</span><br><span class="line">            SetDataTxn setDataTxn = (SetDataTxn) txn;       </span><br><span class="line">            QuorumVerifier qv = self.configFromString(<span class="keyword">new</span> String(setDataTxn.getData()));</span><br><span class="line">            self.setLastSeenQuorumVerifier(qv, <span class="keyword">true</span>);                               </span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        fzk.logRequest(hdr, txn);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Leader.COMMIT:</span><br><span class="line">        fzk.commit(qp.getZxid());</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">case</span> Leader.COMMITANDACTIVATE:</span><br><span class="line">        <span class="comment">// get the new configuration from the request</span></span><br><span class="line">        Request request = fzk.pendingTxns.element();</span><br><span class="line">        SetDataTxn setDataTxn = (SetDataTxn) request.getTxn();                                                                                                      </span><br><span class="line">        QuorumVerifier qv = self.configFromString(<span class="keyword">new</span> String(setDataTxn.getData()));                                </span><br><span class="line"></span><br><span class="line">        <span class="comment">// get new designated leader from (current) leader's message</span></span><br><span class="line">        ByteBuffer buffer = ByteBuffer.wrap(qp.getData());    </span><br><span class="line">        <span class="keyword">long</span> suggestedLeaderId = buffer.getLong();</span><br><span class="line">        <span class="keyword">boolean</span> majorChange = </span><br><span class="line">                self.processReconfig(qv, suggestedLeaderId, qp.getZxid(), <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// commit (writes the new config to ZK tree (/zookeeper/config)                     </span></span><br><span class="line">        fzk.commit(qp.getZxid());</span><br><span class="line">        <span class="keyword">if</span> (majorChange) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"changes proposed in reconfig"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Leader.UPTODATE:</span><br><span class="line">        LOG.error(<span class="string">"Received an UPTODATE message after Follower started"</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Leader.REVALIDATE:</span><br><span class="line">        revalidate(qp);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Leader.SYNC:</span><br><span class="line">        fzk.sync();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        LOG.warn(<span class="string">"Unknown packet type: {}"</span>, LearnerHandler.packetToString(qp));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>FollowerZooKeeperServer.commit()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">(<span class="keyword">long</span> zxid)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (pendingTxns.size() == <span class="number">0</span>) {</span><br><span class="line">        LOG.warn(<span class="string">"Committing "</span> + Long.toHexString(zxid)</span><br><span class="line">                + <span class="string">" without seeing txn"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">long</span> firstElementZxid = pendingTxns.element().zxid;</span><br><span class="line">    <span class="keyword">if</span> (firstElementZxid != zxid) {</span><br><span class="line">        LOG.error(<span class="string">"Committing zxid 0x"</span> + Long.toHexString(zxid)</span><br><span class="line">                + <span class="string">" but next pending txn 0x"</span></span><br><span class="line">                + Long.toHexString(firstElementZxid));</span><br><span class="line">        System.exit(<span class="number">12</span>);</span><br><span class="line">    }</span><br><span class="line">    Request request = pendingTxns.remove();</span><br><span class="line">    commitProcessor.commit(request);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sync</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="keyword">if</span>(pendingSyncs.size() ==<span class="number">0</span>){</span><br><span class="line">        LOG.warn(<span class="string">"Not expecting a sync."</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    Request r = pendingSyncs.remove();</span><br><span class="line">    commitProcessor.commit(r);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="Leader-应答-Follower"><a href="#Leader-应答-Follower" class="headerlink" title="Leader 应答 Follower"></a>Leader 应答 Follower</h3><ul><li><code>LearnerHandler.run()</code> 方法，处理 Follower 的请求。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    {</span><br><span class="line">        </span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        LOG.debug(<span class="string">"Sending UPTODATE message to "</span> + sid);</span><br><span class="line">        queuedPackets.add(<span class="keyword">new</span> QuorumPacket(Leader.UPTODATE, -<span class="number">1</span>, <span class="keyword">null</span>, <span class="keyword">null</span>));</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>) {</span><br><span class="line">            ......</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span>(IOException e) {</span><br><span class="line">        ......</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        ......</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="ZK-服务端-Leader-启动"><a href="#ZK-服务端-Leader-启动" class="headerlink" title="ZK 服务端 Leader 启动"></a>ZK 服务端 Leader 启动</h2><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/d415f72.html" title="ZooKeeper 入门教程之六">https://www.techgrow.cn/posts/d415f72.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag"><i class="fa fa-tag"></i> 分布式</a><a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" rel="tag"><i class="fa fa-tag"></i> 大数据</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/b589771.html" rel="prev" title="ZooKeeper 入门教程之五"><i class="fa fa-angle-left"></i> ZooKeeper 入门教程之五</a></div><div class="post-nav-item"> <a href="/posts/8d13e75d.html" rel="next" title="VuePress 入门教程之一基础篇">VuePress 入门教程之一基础篇<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">1.6m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">23:54</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤 ICP 备 19024664 号</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035 号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"/lib/mermaid/dist/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/app/api/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/app/api/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/d415f72.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>