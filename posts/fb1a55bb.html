<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍如何搭建 Kubernetes 高可用集群。"><meta property="og:type" content="article"><meta property="og:title" content="基于二进制包方式搭建 Kubernetes 多 Master 高可用集群"><meta property="og:url" content="https://www.techgrow.cn/posts/fb1a55bb.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍如何搭建 Kubernetes 高可用集群。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/11/k8s-ha-cluster.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/11/k8s-ha-cluster-2.png"><meta property="article:published_time" content="2021-03-23T13:42:52.000Z"><meta property="article:modified_time" content="2025-11-06T14:34:29.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="容器化"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2025/11/k8s-ha-cluster.png"><link rel="canonical" href="https://www.techgrow.cn/posts/fb1a55bb.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/fb1a55bb.html","path":"posts/fb1a55bb.html","title":"基于二进制包方式搭建 Kubernetes 多 Master 高可用集群"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>基于二进制包方式搭建 Kubernetes 多 Master 高可用集群 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="nav-text">高可用集群的概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A-Master-%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84"><span class="nav-text">多 Master 集群架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A-Master-%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="nav-text">多 Master 集群搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%AF%E8%AF%AD%E8%AF%B4%E6%98%8E"><span class="nav-text">术语说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="nav-text">版本说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E9%9B%86%E7%BE%A4"><span class="nav-text">搭建集群</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E6%99%AE%E9%80%9A%E7%9A%84-K8s-%E9%9B%86%E7%BE%A4"><span class="nav-text">搭建普通的 K8s 集群</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%80%E6%9C%89%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="nav-text">所有集群节点的操作</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E4%B8%BB%E6%9C%BA%E4%BF%A1%E6%81%AF"><span class="nav-text">设置主机信息</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0-Master-%E8%8A%82%E7%82%B9%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="nav-text">新 Master 节点的操作</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%A8%E7%BD%B2%E8%A7%84%E5%88%92"><span class="nav-text">服务器部署规划</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">操作系统初始化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-Docker-%E6%9C%8D%E5%8A%A1"><span class="nav-text">安装 Docker 服务</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%A4%E5%8F%B0-Master-%E8%8A%82%E7%82%B9%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="nav-text">两台 Master 节点的操作</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-HaProxy"><span class="nav-text">安装 HaProxy</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%A6%82%E8%BF%B0"><span class="nav-text">安装概述</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4"><span class="nav-text">安装步骤</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1"><span class="nav-text">配置服务</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="nav-text">启动服务</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E6%9C%8D%E5%8A%A1"><span class="nav-text">验证服务</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-Keepalived"><span class="nav-text">安装 Keepalived</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%A6%82%E8%BF%B0-1"><span class="nav-text">安装概述</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4-1"><span class="nav-text">安装步骤</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1-1"><span class="nav-text">配置服务</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1-1"><span class="nav-text">启动服务</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E6%9C%8D%E5%8A%A1-1"><span class="nav-text">验证服务</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">747</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">53</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/fb1a55bb.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="基于二进制包方式搭建 Kubernetes 多 Master 高可用集群 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍如何搭建 Kubernetes 高可用集群。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 基于二进制包方式搭建 Kubernetes 多 Master 高可用集群</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-03-23 21:42:52" itemprop="dateCreated datePublished" datetime="2021-03-23T21:42:52+08:00">2021-03-23</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2025-11-06 22:34:29" itemprop="dateModified" datetime="2025-11-06T22:34:29+08:00">2025-11-06</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/fb1a55bb.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/fb1a55bb.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>4.7k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>4 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/ccd6f2d4.html">基于二进制包方式搭建 Kubernetes 单 Master 集群</a></li><li><a href="/posts/b728042a.html">基于 Kubeadm 方式搭建 Kubernetes 单 Master 集群</a></li><li><a href="/posts/fb1a55bb.html">基于二进制包方式搭建 Kubernetes 多 Master 高可用集群</a></li></ul><span id="more"></span><h2 id="高可用集群的概述"><a href="#高可用集群的概述" class="headerlink" title="高可用集群的概述"></a>高可用集群的概述</h2><p>Kubernetes 作为容器集群系统，通过健康检查与重启策略实现了 Pod 的故障自我修复能力，通过调度算法将 Pod 分布式部署，并持续监控其预期副本数。当节点发生故障时，系统能够自动在正常节点上重新启动 Pod，从而实现应用层的高可用性。<strong>在 Kubernetes 集群环境中，高可用性还需考虑以下两个层面：Etcd 数据库的高可用性以及 Kubernetes Master 节点的高可用性。</strong>由于之前的 Kubernetes 集群是基于 <a href="/posts/ccd6f2d4.html">二进制包方式</a> 搭建的，因此 Etcd 已经采用 3 节点集群方式实现了高可用，本文将重点介绍和实施 Master 节点的高可用方案。Master 节点承担总控中心角色，通过持续与工作节点（Worker）上的 <code>kubelet</code> 和 <code>kube-proxy</code> 进行通信，维护整个集群的健康工作状态。一旦 Master 节点发生故障，将无法使用 <code>kubectl</code> 工具或 API 进行集群管理。<strong>Master 节点主要包含三个核心服务：<code>kube-apiserver</code>、<code>kube-controller-manager</code> 和 <code>kube-scheduler</code>。其中，<code>kube-controller-manager</code> 和 <code>kube-scheduler</code> 组件自身已通过选举机制实现了高可用。因此，Master 节点的高可用主要是针对 <code>kube-apiserver</code> 组件，该组件以 HTTP API 形式提供服务，其高可用实现方式与 Web 服务器类似，可以通过负载均衡器（比如 HaProxy / Nginx）对其多个实例进行负载均衡，支持水平扩展，并使用 Keepalived 来保证负载均衡器的高可用性。</strong></p><h2 id="多-Master-集群架构"><a href="#多-Master-集群架构" class="headerlink" title="多 Master 集群架构"></a>多 Master 集群架构</h2><p>Kubernetes 多 Master 集群的整体架构如下，多个 Master 节点之间通过 HaProxy 实现负载均衡，而 HaProxy 通过 Keepalived 来保证自身的高可用性（即双机主备高可用，也叫双机热备高可用）。</p><p><img data-src="../../../asset/2025/11/k8s-ha-cluster.png"></p><h2 id="多-Master-集群搭建"><a href="#多-Master-集群搭建" class="headerlink" title="多 Master 集群搭建"></a>多 Master 集群搭建</h2><h3 id="术语说明"><a href="#术语说明" class="headerlink" title="术语说明"></a>术语说明</h3><p>为了方便描述，本文使用 <code>Node 节点</code> 来替代 Kubernetes 的 <code>Worker Node</code>，使用 <code>Master 节点</code> 来替代 <code>Master Node</code>。</p><h3 id="版本说明"><a href="#版本说明" class="headerlink" title="版本说明"></a>版本说明</h3><table><thead><tr><th>软件</th><th>版本</th><th>安装方式</th></tr></thead><tbody><tr><td> CentOS</td><td><code>7.9</code></td><td>多个独立虚拟机</td></tr><tr><td> Docker</td><td><code>19.03.9</code></td><td>二进制安装包</td></tr><tr><td> Kubernetes</td><td><code>1.19.10</code></td><td>二进制安装包</td></tr><tr><td> Etcd</td><td><code>3.4.9</code></td><td>二进制安装包</td></tr></tbody></table><h3 id="搭建集群"><a href="#搭建集群" class="headerlink" title="搭建集群"></a>搭建集群</h3><h4 id="搭建普通的-K8s-集群"><a href="#搭建普通的-K8s-集群" class="headerlink" title="搭建普通的 K8s 集群"></a>搭建普通的 K8s 集群</h4><p>首先，采用二进制包方式搭建 Kubernetes 单 Master 集群（服务器规划如下表所示），详细教程可以看 <a href="/posts/ccd6f2d4.html">这里</a>，后续会在此基础上搭建 Kubernetes 多 Master 高可用集群。</p><table><thead><tr><th>Host 名称</th><th>角色</th><th> IP</th><th>CPU 核数</th><th>内存</th><th>磁盘</th><th>安装的组件</th><th>备注</th></tr></thead><tbody><tr><td> k8s-master</td><td>master</td><td>192.168.2.191</td><td>&gt;= 2C</td><td>&gt;=2G</td><td>&gt;=20G</td><td>kube-apiserver，kube-controller-manager，kube-scheduler，kubelet，kube-proxy，cni plugin, docker，etcd</td><td> 部署 Etcd 集群节点</td></tr><tr><td> k8s-node1</td><td>node（worker）</td><td>192.168.2.112</td><td>&gt;= 4C</td><td>&gt;=4G</td><td>&gt;=40G</td><td>kubelet，kube-proxy，cni plugin, docker，etcd</td><td> 部署 Etcd 集群节点</td></tr><tr><td> k8s-node2</td><td>node（worker）</td><td>192.168.2.131</td><td>&gt;= 4C</td><td>&gt;=4G</td><td>&gt;=40G</td><td>kubelet，kube-proxy，cni plugin, docker，etcd</td><td> 部署 Etcd 集群节点</td></tr><tr><td> k8s-node3</td><td>node（worker）</td><td>192.168.2.236</td><td>&gt;= 4C</td><td>&gt;=4G</td><td>&gt;=40G</td><td>kubelet，kube-proxy，cni plugin, docker</td><td> 不部署 Etcd 集群节点（保证 Etcd 集群有奇数个节点）</td></tr></tbody></table><h4 id="所有集群节点的操作"><a href="#所有集群节点的操作" class="headerlink" title="所有集群节点的操作"></a>所有集群节点的操作</h4><div class="admonition warning"><p class="admonition-title">特别注意</p><ul><li><strong>以下所有操作，需要在所有 Kubernetes 集群节点（包括 Master 和 Node）上分别执行，除特别说明除外。</strong></li></ul></div><h5 id="设置主机信息"><a href="#设置主机信息" class="headerlink" title="设置主机信息"></a>设置主机信息</h5><p>添加 hosts 配置信息</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑系统配置文件，添加 hosts 记录（如下所示）</span></span><br><span class="line"><span class="keyword"># vim</span> /etc/hosts</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">192.168.2.191 k8s-master</span><br><span class="line">192.168.2.112 k8s-node1</span><br><span class="line">192.168.2.131 k8s-node2</span><br><span class="line">192.168.2.236 k8s-node3</span><br><span class="line">192.168.2.148 k8s-master2</span><br></pre></td></tr></tbody></table></figure><h4 id="新-Master-节点的操作"><a href="#新-Master-节点的操作" class="headerlink" title="新 Master 节点的操作"></a>新 Master 节点的操作</h4><div class="admonition warning"><p class="admonition-title">特别注意</p><ul><li><strong>以下所有操作，都只在新增的 Master 节点上执行，除特别说明除外。</strong></li></ul></div><h5 id="服务器部署规划"><a href="#服务器部署规划" class="headerlink" title="服务器部署规划"></a>服务器部署规划</h5><p>在 Kubernetes 单 Master 集群的基础上，新增一个 Master 节点，用于搭建 Kubernetes 高可用集群，其中两个 Master 节点都安装了 HaProxy 与 KeepAlived。最终的服务器规划如下表所示：</p><table><thead><tr><th>Host 名称</th><th>角色</th><th> IP</th><th>CPU 核数</th><th>内存</th><th>磁盘</th><th>安装的组件</th><th>备注</th></tr></thead><tbody><tr><td> k8s-master</td><td>master</td><td>192.168.2.191</td><td>&gt;= 2C</td><td>&gt;=2G</td><td>&gt;=20G</td><td>kube-apiserver，kube-controller-manager，kube-scheduler，kubelet，kube-proxy，cni plugin, docker，etcd，haproxy，keepalived</td><td> 部署 Etcd 集群节点</td></tr><tr><td> k8s-node1</td><td>node（worker）</td><td>192.168.2.112</td><td>&gt;= 4C</td><td>&gt;=4G</td><td>&gt;=40G</td><td>kubelet，kube-proxy，cni plugin, docker，etcd</td><td> 部署 Etcd 集群节点</td></tr><tr><td> k8s-node2</td><td>node（worker）</td><td>192.168.2.131</td><td>&gt;= 4C</td><td>&gt;=4G</td><td>&gt;=40G</td><td>kubelet，kube-proxy，cni plugin, docker，etcd</td><td> 部署 Etcd 集群节点</td></tr><tr><td> k8s-node3</td><td>node（worker）</td><td>192.168.2.236</td><td>&gt;= 4C</td><td>&gt;=4G</td><td>&gt;=40G</td><td>kubelet，kube-proxy，cni plugin, docker</td><td> 不部署 Etcd 集群节点（保证 Etcd 集群有奇数个节点）</td></tr><tr><td>k8s-master2</td><td>master</td><td>192.168.2.148</td><td>&gt;= 2C</td><td>&gt;=2G</td><td>&gt;=20G</td><td>kube-apiserver，kube-controller-manager，kube-scheduler，kubelet，kube-proxy，cni plugin, docker，haproxy，keepalived</td><td> 不部署 Etcd 集群节点（保证 Etcd 集群有奇数个节点）</td></tr></tbody></table><h5 id="操作系统初始化"><a href="#操作系统初始化" class="headerlink" title="操作系统初始化"></a>操作系统初始化</h5><p>关闭防火墙</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 临时关闭</span></span><br><span class="line"><span class="keyword"># systemctl</span> stop firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 永久关闭</span></span><br><span class="line"><span class="keyword"># systemctl</span> <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></tbody></table></figure><p>关闭 selinux</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 临时关闭</span></span><br><span class="line"><span class="keyword"># setenforce</span> 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 永久关闭</span></span><br><span class="line"><span class="keyword"># sed</span><span class="params"> -i</span> <span class="string">'s/enforcing/disabled/'</span> /etc/selinux/config</span><br></pre></td></tr></tbody></table></figure><p>关闭 swap 分区</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 临时关闭</span></span><br><span class="line"><span class="keyword">$ swapoff</span><span class="params"> -a</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 永久关闭</span></span><br><span class="line"><span class="keyword"># sed</span><span class="params"> -i</span> <span class="string">'s/.*swap.*/#&amp;/'</span> /etc/fstab</span><br></pre></td></tr></tbody></table></figure><p>系统时间同步（强烈建议使用 chrony 而不是 ntpdate）</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 卸载ntpdate服务</span></span><br><span class="line"><span class="keyword"># yum</span> remove<span class="params"> -y</span> ntpdate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装chrony服务</span></span><br><span class="line"><span class="keyword"># yum</span> install<span class="params"> -y</span> chrony</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机自启动chrony服务</span></span><br><span class="line"><span class="keyword"># systemctl</span> <span class="built_in">enable</span> chronyd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动chrony服务</span></span><br><span class="line"><span class="keyword"># systemctl</span> start chronyd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置NTP源，添加国内公共的NTP服务器</span></span><br><span class="line"><span class="keyword"># vim</span> /etc/chrony.conf</span><br><span class="line">server ntp.aliyun.com iburst</span><br><span class="line">server ntp1.tencent.com iburst</span><br><span class="line">server cn.pool.ntp.org iburst</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启chrony服务</span></span><br><span class="line"><span class="keyword"># systemctl</span> restart chronyd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查chrony服务的运行状态</span></span><br><span class="line"><span class="keyword"># systemctl</span> status chronyd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看chrony服务的时间同步状态</span></span><br><span class="line"><span class="keyword"># chronyc</span> tracking</span><br><span class="line"></span><br><span class="line"><span class="comment"># 强制同步一次时间（只在刚部署、时间差很多的时候用）</span></span><br><span class="line"><span class="keyword"># chronyc</span> makestep</span><br></pre></td></tr></tbody></table></figure><p>设置主机名（比如 <code>k8s-master2</code>）</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword"># hostnamectl</span> <span class="built_in">set</span>-hostname &lt;hostname&gt;</span><br></pre></td></tr></tbody></table></figure><p>将桥接的 IPv4 流量传递到 iptables 的链</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加路由规则</span></span><br><span class="line"><span class="keyword"># vim</span> /etc/sysctl.d/k8s.conf</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置生效</span></span><br><span class="line"><span class="keyword"># sysctl</span><span class="params"> --system</span></span><br></pre></td></tr></tbody></table></figure><h5 id="安装-Docker-服务"><a href="#安装-Docker-服务" class="headerlink" title="安装 Docker 服务"></a>安装 Docker 服务</h5><div class="admonition warning"><p class="admonition-title">特别注意</p><ul><li><strong>在新的 Master 节点上安装 Docker 服务，这里采用二进制安装方式，CentOS 上还可以通过 YUM 安装。</strong></li><li><strong>如果新的 Master 节点仅用于运行控制平面组件（如 API Server、Controller Manager 和 Scheduler），不承载用户 Pod 的调度和运行任务，则新的 Master 节点可以不安装 Docker 服务</strong>。</li></ul></div><p>下载并解压 Docker 的二进制包</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载Docker的二进制包</span></span><br><span class="line"><span class="keyword"># wget</span> https://download.docker.com/linux/static/stable/x86_64/docker-19.03.9.tgz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压文件</span></span><br><span class="line"><span class="keyword"># tar</span><span class="params"> -xvf</span> docker-19.03.9.tgz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 移动文件</span></span><br><span class="line"><span class="keyword"># mv</span> docker/* /usr/bin</span><br></pre></td></tr></tbody></table></figure><p>创建 Docker 的配置文件</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建Docker的配置目录</span></span><br><span class="line"><span class="keyword"># mkdir</span> /etc/docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置阿里的Docker镜像加速（请更换自己的镜像地址，或者使用国内公共的镜像地址）</span></span><br><span class="line"><span class="keyword"># cat</span> &gt; /etc/docker/daemon.json &lt;&lt; EOF</span><br><span class="line">{</span><br><span class="line">  <span class="string">"registry-mirrors"</span>: [</span><br><span class="line">     <span class="string">"https://b9pmyelo.mirror.aliyuncs.com"</span>,</span><br><span class="line">     <span class="string">"https://ustc-edu-cn.mirror.aliyuncs.com"</span>,</span><br><span class="line">     <span class="string">"https://mirror.iscas.ac.cn"</span>,</span><br><span class="line">     <span class="string">"https://docker.nju.edu.cn"</span>,</span><br><span class="line">     <span class="string">"https://docker.m.daocloud.io"</span>,</span><br><span class="line">     <span class="string">"https://ccr.ccs.tencentyun.com"</span>,</span><br><span class="line">     <span class="string">"https://dockerhub.timeweb.cloud"</span></span><br><span class="line">    ]</span><br><span class="line">}</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p>配置 Systemd 管理 Docker</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword"># cat</span> &gt; /usr/lib/systemd/system/docker.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target</span><br><span class="line">After=firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/bin/dockerd</span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span><span class="params"> -s</span> HUP <span class="variable">$MAINPID</span></span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p>启动并设置开机自启动 Docker 服务</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新系统配置</span></span><br><span class="line"><span class="keyword"># systemctl</span> daemon-reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机自启动Docker</span></span><br><span class="line"><span class="keyword"># systemctl</span> <span class="built_in">enable</span> docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Docker</span></span><br><span class="line"><span class="keyword"># systemctl</span> start docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Docker的运行状态</span></span><br><span class="line"><span class="keyword"># systemctl</span> status docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Docker的版本</span></span><br><span class="line"><span class="keyword"># docker</span><span class="params"> --version</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Docker的安装信息</span></span><br><span class="line"><span class="keyword"># docker</span> info</span><br></pre></td></tr></tbody></table></figure><h4 id="两台-Master-节点的操作"><a href="#两台-Master-节点的操作" class="headerlink" title="两台 Master 节点的操作"></a>两台 Master 节点的操作</h4><div class="admonition warning"><p class="admonition-title">特别注意</p><ul><li><strong>以下所有操作，都只在两台 Master 节点上执行，除特别说明除外。</strong></li></ul></div><h5 id="安装-HaProxy"><a href="#安装-HaProxy" class="headerlink" title="安装 HaProxy"></a>安装 HaProxy</h5><div class="admonition note"><p class="admonition-title">提示</p><ul><li>在两台 Master 节点上，分别安装 HaProxy，两台 Master 节点上的 HaProxy 配置文件都是一样的。</li><li>生产级 Kubernetes 高可用集群通常采用 HAProxy + Keepalived 实现 API Server 的负载均衡（高性能四层负载均衡），而不是使用 Nginx + Keepalived 来替代。同时会使用 Nginx Ingress 处理应用流量负载，两者分层清晰、运维简单。</li></ul></div><h6 id="安装概述"><a href="#安装概述" class="headerlink" title="安装概述"></a>安装概述</h6><p>HAProxy 是一个流行的反向代理服务器，这里用四层（L4）实现对 API Server 实现负载均衡。API Server 的高可用架构如下图所示：</p><p><img data-src="../../../asset/2025/11/k8s-ha-cluster-2.png"></p><table><thead><tr><th>安装说明</th><th>路径</th></tr></thead><tbody><tr><td> HaProxy 的安装路径</td><td></td></tr><tr><td> HaProxy 的配置文件</td><td></td></tr><tr><td> HaProxy 的 Systemd 服务配置文件</td><td></td></tr></tbody></table><h6 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h6><h6 id="配置服务"><a href="#配置服务" class="headerlink" title="配置服务"></a>配置服务</h6><h6 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h6><h6 id="验证服务"><a href="#验证服务" class="headerlink" title="验证服务"></a>验证服务</h6><h5 id="安装-Keepalived"><a href="#安装-Keepalived" class="headerlink" title="安装 Keepalived"></a>安装 Keepalived</h5><div class="admonition note"><p class="admonition-title">提示</p><ul><li>在两台 Master 节点上，分别安装 Keepalived，两台 Master 节点上的 Keepalived 配置文件是不一样的。</li></ul></div><h6 id="安装概述-1"><a href="#安装概述-1" class="headerlink" title="安装概述"></a>安装概述</h6><ul><li>Keepalived 是一个高可用软件，基于 VIP 绑定实现服务器双机主备（也叫双机热备），在上述拓扑中，Keepalived 主要根据 HaProxy 的运行状态判断是否需要故障转移（偏移 VIP）。</li><li>例如，当 HaProxy 主节点挂掉，VIP 会自动绑定在 HaProxy 备节点，从而保证 VIP 一直可用，实现 HaProxy 高可用。</li></ul><table><thead><tr><th>安装说明</th><th>路径</th></tr></thead><tbody><tr><td> Keepalived 的安装路径</td><td><code>/usr/local/keepalived</code></td></tr><tr><td>Keepalived 的配置文件</td><td><code>/usr/local/keepalived/etc/keepalived/keepalived.conf</code></td></tr><tr><td>Keepalived 的 Systemd 服务配置文件（自动生成）</td><td><code>/usr/lib/systemd/system/keepalived.service</code></td></tr></tbody></table><h6 id="安装步骤-1"><a href="#安装步骤-1" class="headerlink" title="安装步骤"></a>安装步骤</h6><p>安装依赖软件包</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装依赖包</span></span><br><span class="line"><span class="keyword"># yum</span> install<span class="params"> -y</span> gcc gcc-c++ make openssl-devel libnl libnl-devel net-snmp-devel popt-devel</span><br></pre></td></tr></tbody></table></figure><p>下载 Keepalived 源码包（<a target="_blank" rel="external nofollow" href="https://www.keepalived.org/download.html">官网下载地址</a>）</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载源码包</span></span><br><span class="line"><span class="keyword"># wget</span> https://www.keepalived.org/software/keepalived-2.2.8.tar.gz</span><br></pre></td></tr></tbody></table></figure><p>解压 Keepalived 源码包</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解压源码包</span></span><br><span class="line"><span class="keyword"># tar</span><span class="params"> -xvf</span> keepalived-2.2.8.tar.gz</span><br></pre></td></tr></tbody></table></figure><p>编译源码与安装</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入源码包的解压目录</span></span><br><span class="line"><span class="keyword"># cd</span> keepalived-2.2.8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成构建文件（Makefile）</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/keepalived</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译源码</span></span><br><span class="line"><span class="keyword"># make</span><span class="params"> -j4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line"><span class="keyword"># make</span> install</span><br></pre></td></tr></tbody></table></figure><h6 id="配置服务-1"><a href="#配置服务-1" class="headerlink" title="配置服务"></a>配置服务</h6><blockquote><p>Keepalived 配置文件的使用说明</p></blockquote><table><thead><tr><th>配置项</th><th>示例值</th><th>说明</th></tr></thead><tbody><tr><td><code>router_id</code></td><td><code>k8s</code></td><td>本节点唯一标识，用于日志区分（不同节点可不同）。</td></tr><tr><td><code>script</code></td><td><code>"killall -0 haproxy"</code></td><td>检测 HaProxy 服务是否可用，可以是 Shell 命令，还可以是 Shell 脚本的绝对路径。</td></tr><tr><td><code>state</code></td><td><code>BACKUP</code></td><td>节点初始角色（<code>MASTER</code> 或 <code>BACKUP</code>），最终由优先级决定。</td></tr><tr><td><code>interface</code></td><td><code>enp0s3</code></td><td>VRRP 使用的网络接口名称，可通过 <code>ifconfig</code> 命令得知。</td></tr><tr><td><code>virtual_router_id</code></td><td><code>51</code></td><td>VRRP 组 ID，两个节点必须一致。</td></tr><tr><td><code>priority</code></td><td><code>200</code></td><td>节点优先级，数值越大优先级越高。</td></tr><tr><td><code>advert_int</code></td><td><code>1</code></td><td>VRRP 心跳间隔（秒），默认 1 秒。</td></tr><tr><td><code>auth_type</code></td><td><code>PASS</code></td><td>VRRP 认证方式（<code>PASS</code> 或 <code>AH</code>）。</td></tr><tr><td><code>auth_pass</code></td><td><code>ceb1b3ec013d66163d6ab</code></td><td>VRRP 认证密码，两个节点必须一致。</td></tr><tr><td><code>virtual_ipaddress</code></td><td><code>192.168.2.100</code></td><td>Keepalived 提供的 VIP（虚拟 IP），由 <code>MASTER</code> 持有。</td></tr><tr><td><code>track_script</code></td><td><code>check_haproxy</code></td><td>指定用于健康检查的脚本，失败时会影响优先级或触发故障转移。</td></tr></tbody></table><blockquote><p>在<strong>第一个 Master 节点</strong>（比如 <code>k8s-master</code>）中，创建 Keepalived 的配置文件，<strong>请自行更改 <code>interface</code>（网卡接口名称）与 <code>virtual_ipaddress</code>（虚拟 IP）配置项</strong></p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建配置文件，写入以下配置内容</span></span><br><span class="line"><span class="keyword"># vim</span> /usr/<span class="built_in">local</span>/keepalived/etc/keepalived/keepalived.conf</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs {</span><br><span class="line">    router_id k8s</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vrrp_script check_haproxy {</span><br><span class="line">    script "killall -0 haproxy"</span><br><span class="line">    interval 3</span><br><span class="line">    weight -2</span><br><span class="line">    fall 10</span><br><span class="line">    rise 2</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 {</span><br><span class="line">    state MASTER</span><br><span class="line">    interface enp0s3</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 250</span><br><span class="line">    advert_int 1</span><br><span class="line"></span><br><span class="line">    authentication {</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass ceb1b3ec013d66163d6ab</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    virtual_ipaddress {</span><br><span class="line">        192.168.2.100</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    track_script {</span><br><span class="line">        check_haproxy</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><blockquote><p>在<strong>第二个 Master 节点</strong>（比如 <code>k8s-master2</code>）中，创建 Keepalived 的配置文件，<strong>请自行更改 <code>interface</code>（网卡接口名称）与 <code>virtual_ipaddress</code>（虚拟 IP）配置项</strong></p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建配置文件，写入以下配置内容</span></span><br><span class="line"><span class="keyword"># vim</span> /usr/<span class="built_in">local</span>/keepalived/etc/keepalived/keepalived.conf</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs {</span><br><span class="line">    router_id k8s</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vrrp_script check_haproxy {</span><br><span class="line">    script "killall -0 haproxy"</span><br><span class="line">    interval 3</span><br><span class="line">    weight -2</span><br><span class="line">    fall 10</span><br><span class="line">    rise 2</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 {</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface enp0s3</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 200</span><br><span class="line">    advert_int 1</span><br><span class="line"></span><br><span class="line">    authentication {</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass ceb1b3ec013d66163d6ab</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    virtual_ipaddress {</span><br><span class="line">        192.168.2.100</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    track_script {</span><br><span class="line">        check_haproxy</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h6 id="启动服务-1"><a href="#启动服务-1" class="headerlink" title="启动服务"></a>启动服务</h6><p>设置开机自启动 Keepalived 服务</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新系统配置</span></span><br><span class="line"><span class="keyword"># systemctl</span> daemon-reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机自启动Keepalived</span></span><br><span class="line"><span class="keyword"># systemctl</span> <span class="built_in">enable</span> keepalived</span><br></pre></td></tr></tbody></table></figure><p>立刻启动 Keepalived 服务</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动Keepalived</span></span><br><span class="line"><span class="keyword"># systemctl</span> start keepalived</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Keepalived的运行状态</span></span><br><span class="line"><span class="keyword"># systemctl</span> status keepalived</span><br></pre></td></tr></tbody></table></figure><h6 id="验证服务-1"><a href="#验证服务-1" class="headerlink" title="验证服务"></a>验证服务</h6><p>在第一个 Master 节点（比如 <code>k8s-master</code>）中，查看指定网卡（比如 <code>enp0s3</code>）的详细 IP 地址与状态信息，<strong>请自行更改网卡接口名称</strong></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看网卡的详细信息</span></span><br><span class="line"><span class="keyword"># ip</span> a s enp0s3</span><br></pre></td></tr></tbody></table></figure><p>输出示例如下，可以看到 VIP（虚拟 IP）地址 <code>192.168.2.100</code> 绑定了网卡接口 <code>enp0s3</code>，这就说明 Keepalived 可以正常运行</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 08:00:27:de:6f:6b brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.2.191/24 brd 192.168.2.255 scope global noprefixroute dynamic enp0s3</span><br><span class="line">       valid_lft 42617sec preferred_lft 42617sec</span><br><span class="line">    inet 192.168.2.100/32 scope global enp0s3</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::8b9e:77d3:4d79:eab9/64 scope link tentative noprefixroute dadfailed </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::6c1a:25c4:bdbd:dad3/64 scope link tentative noprefixroute dadfailed </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::8dee:f54a:fcd2:369b/64 scope link tentative noprefixroute dadfailed </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></tbody></table></figure><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="/posts/503c34e4.html">Nginx + Keepalived 实现双机主备高可用</a></li></ul><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/fb1a55bb.html" title="基于二进制包方式搭建 Kubernetes 多 Master 高可用集群">https://www.techgrow.cn/posts/fb1a55bb.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%AE%B9%E5%99%A8%E5%8C%96/" rel="tag"><i class="fa fa-tag"></i> 容器化</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/4a5f9755.html" rel="prev" title="Centos7 升级 GCC 版本"><i class="fa fa-angle-left"></i> Centos7 升级 GCC 版本</a></div><div class="post-nav-item"> <a href="/posts/bdfaacc7.html" rel="next" title="Java 基于 LinkedHashMap 实现 LRU 缓存">Java 基于 LinkedHashMap 实现 LRU 缓存<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">2.1m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">32:11</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/fb1a55bb.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>