<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍如何在生产环境的 Debian 11 系统上部署 MySQL 的 PXC 8.0 集群，并基于 Haproxy + Keepalived 实现双机热备方案。"><meta property="og:type" content="article"><meta property="og:title" content="Debian 11 生产环境部署 PXC 8.0 集群"><meta property="og:url" content="https://www.techgrow.cn/posts/ff0f2d6.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍如何在生产环境的 Debian 11 系统上部署 MySQL 的 PXC 8.0 集群，并基于 Haproxy + Keepalived 实现双机热备方案。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2023/10/mysql-pxc8-6.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2023/10/mysql-pxc8-7.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2023/10/mysql-pxc8-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2023/10/mysql-pxc8-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2023/10/mysql-pxc8-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2023/10/mysql-pxc8-4.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2023/10/mysql-pxc8-5.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2023/10/mysql-pxc8-6.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2023/10/docker-mysql-pxc-6.png"><meta property="article:published_time" content="2023-10-30T12:13:32.000Z"><meta property="article:modified_time" content="2023-11-12T12:13:32.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="Debian"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2023/10/mysql-pxc8-6.png"><link rel="canonical" href="https://www.techgrow.cn/posts/ff0f2d6.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/ff0f2d6.html","path":"posts/ff0f2d6.html","title":"Debian 11 生产环境部署 PXC 8.0 集群"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Debian 11 生产环境部署 PXC 8.0 集群 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/app/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B"><span class="nav-text">系列教程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3"><span class="nav-text">官方文档</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-text">准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E6%9E%B6%E6%9E%84"><span class="nav-text">部署架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E8%A7%84%E5%88%92"><span class="nav-text">部署规划</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">系统初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-Host"><span class="nav-text">配置 Host</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E4%B8%BB%E6%9C%BA%E5%90%8D"><span class="nav-text">设置主机名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E9%98%B2%E7%81%AB%E5%A2%99"><span class="nav-text">配置防火墙</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#PXC-%E9%9B%86%E7%BE%A4%E7%9A%84%E9%98%B2%E7%81%AB%E5%A2%99"><span class="nav-text">PXC 集群的防火墙</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Haproxy-%E7%9A%84%E9%98%B2%E7%81%AB%E5%A2%99"><span class="nav-text">Haproxy 的防火墙</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Keepalived-%E7%9A%84%E9%98%B2%E7%81%AB%E5%A2%99"><span class="nav-text">Keepalived 的防火墙</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E9%97%AD-SeLinux"><span class="nav-text">关闭 SeLinux</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-text">系统性能优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%B8%E8%BD%BD%E5%B7%B2%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6"><span class="nav-text">卸载已安装软件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A3%80%E6%9F%A5%E4%BA%A4%E6%8D%A2%E5%88%86%E5%8C%BA%E7%9A%84%E5%A4%A7%E5%B0%8F"><span class="nav-text">检查交换分区的大小</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PXC-%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85"><span class="nav-text">PXC 集群安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4"><span class="nav-text">安装步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%B5%8B%E8%AF%95"><span class="nav-text">安装测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PXC-%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE"><span class="nav-text">PXC 集群配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8B%B7%E8%B4%9D-SSL-TLS-%E8%AF%81%E4%B9%A6"><span class="nav-text">拷贝 SSL/TLS 证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E7%AC%AC%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%E4%B8%8A%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4"><span class="nav-text">在第一个节点上初始化集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%86%E7%AC%AC%E4%BA%8C%E4%B8%AA%E8%8A%82%E7%82%B9%E6%B7%BB%E5%8A%A0%E5%88%B0%E9%9B%86%E7%BE%A4%E4%B8%AD"><span class="nav-text">将第二个节点添加到集群中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%86%E7%AC%AC%E4%B8%89%E4%B8%AA%E8%8A%82%E7%82%B9%E6%B7%BB%E5%8A%A0%E5%88%B0%E9%9B%86%E7%BE%A4%E4%B8%AD"><span class="nav-text">将第三个节点添加到集群中</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PXC-%E9%9B%86%E7%BE%A4%E6%B5%8B%E8%AF%95"><span class="nav-text">PXC 集群测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">创建数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8"><span class="nav-text">创建数据库表</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PXC-%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86"><span class="nav-text">PXC 集群管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E6%93%8D%E4%BD%9C"><span class="nav-text">创建用户操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E5%90%84%E6%8C%87%E6%A0%87%E6%A3%80%E6%9F%A5"><span class="nav-text">集群各指标检查</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E5%AE%8C%E6%95%B4%E6%80%A7%E6%A3%80%E6%9F%A5"><span class="nav-text">集群完整性检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E7%8A%B6%E6%80%81%E6%A3%80%E6%9F%A5"><span class="nav-text">集群节点状态检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E5%81%A5%E5%BA%B7%E4%BF%A1%E6%81%AF%E6%A3%80%E6%9F%A5"><span class="nav-text">集群健康信息检查</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Haproxy-Keepalived-%E5%8F%8C%E6%9C%BA%E7%83%AD%E5%A4%87"><span class="nav-text">Haproxy + Keepalived 双机热备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8C%E6%9C%BA%E7%83%AD%E5%A4%87%E6%9E%B6%E6%9E%84"><span class="nav-text">双机热备架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%94%A8%E6%88%B7"><span class="nav-text">创建数据库用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Haproxy-%E5%AE%89%E8%A3%85"><span class="nav-text">Haproxy 安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Keepalived-%E5%AE%89%E8%A3%85"><span class="nav-text">Keepalived 安装</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Haproxy-%E8%8A%82%E7%82%B9%E4%B8%80%E5%AE%89%E8%A3%85-Keepalived"><span class="nav-text">Haproxy 节点一安装 Keepalived</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Haproxy-%E8%8A%82%E7%82%B9%E4%BA%8C%E5%AE%89%E8%A3%85-Keepalived"><span class="nav-text">Haproxy 节点二安装 Keepalived</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8C%E6%9C%BA%E7%83%AD%E5%A4%87%E6%96%B9%E6%A1%88%E6%B5%8B%E8%AF%95"><span class="nav-text">双机热备方案测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8C%E6%9C%BA%E7%83%AD%E5%A4%87%E6%96%B9%E6%A1%88%E5%AE%8C%E5%96%84"><span class="nav-text">双机热备方案完善</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PXC-%E9%9B%86%E7%BE%A4%E8%BF%90%E7%BB%B4"><span class="nav-text">PXC 集群运维</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97"><span class="nav-text">查看错误日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A3%E7%A1%AE%E5%85%B3%E9%97%AD%E9%9B%86%E7%BE%A4"><span class="nav-text">正确关闭集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E5%8A%A8%E6%80%81%E4%B8%8B%E7%BA%BF"><span class="nav-text">节点动态下线</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E8%8A%82%E7%82%B9%E7%9A%84%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E9%87%8D%E5%90%AF"><span class="nav-text">单节点的操作系统重启</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%96%AD%E7%94%B5%E9%87%8D%E5%90%AF%EF%BC%8C%E7%AC%AC%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%E5%90%AF%E5%8A%A8%E5%A4%B1%E8%B4%A5"><span class="nav-text">集群断电重启，第一个节点启动失败</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">651</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">54</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/ff0f2d6.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Debian 11 生产环境部署 PXC 8.0 集群 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍如何在生产环境的 Debian 11 系统上部署 MySQL 的 PXC 8.0 集群，并基于 Haproxy + Keepalived 实现双机热备方案。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Debian 11 生产环境部署 PXC 8.0 集群</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-10-30 20:13:32" itemprop="dateCreated datePublished" datetime="2023-10-30T20:13:32+08:00">2023-10-30</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2023-11-12 20:13:32" itemprop="dateModified" datetime="2023-11-12T20:13:32+08:00">2023-11-12</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/ff0f2d6.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/ff0f2d6.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>10k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>9 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文主要介绍 Deian 11 如何安装 Percona XtraDB Cluster 8.0 集群（三个物理节点），并基于 Haproxy + Keepalived （两个物理节点）实现双机热备方案。</p><h3 id="系列教程"><a href="#系列教程" class="headerlink" title="系列教程"></a>系列教程</h3><ul><li><a href="/posts/aba17375.html">Docker 部署 PXC 5.7 单机集群</a></li><li><a href="/posts/8dc5e7ed.html">Docker 部署 PXC 8.0 单机集群</a></li><li><a href="/posts/ff0f2d6.html">Debian 11 生产环境部署 PXC 8.0 集群</a></li></ul><span id="more"></span><h3 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h3><ul><li><a target="_blank" rel="external nofollow" href="https://docs.percona.com/percona-xtradb-cluster/8.0/apt.html">Percona XtraDB Cluster 8.0 官方文档</a></li></ul><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="部署架构"><a href="#部署架构" class="headerlink" title="部署架构"></a>部署架构</h3><p><img data-src="../../../asset/2023/10/mysql-pxc8-6.png"></p><h3 id="部署规划"><a href="#部署规划" class="headerlink" title="部署规划"></a>部署规划</h3><ul><li>软件版本说明</li></ul><table><thead><tr><th>软件</th><th>版本</th><th>描述</th></tr></thead><tbody><tr><td> Haproxy</td><td>1.5.18</td><td></td></tr><tr><td>Keepalived</td><td>1.3.5</td><td></td></tr><tr><td>Percona XtraDB Cluster (PXC)</td><td>8.0</td><td></td></tr></tbody></table><ul><li> 节点部署规划</li></ul><table><thead><tr><th>节点名称</th><th>主机名</th><th> IP</th><th> 系统</th><th>说明</th></tr></thead><tbody><tr><td> PXC 节点一</td><td> pxc-node-1</td><td>192.168.1.188</td><td>Debian 11 (Bullseye)</td><td>Percona XtraDB Cluster (PXC)</td></tr><tr><td>PXC 节点二</td><td> pxc-node-2</td><td>192.168.1.193</td><td>Debian 11 (Bullseye)</td><td>Percona XtraDB Cluster (PXC)</td></tr><tr><td>PXC 节点三</td><td> pxc-node-3</td><td>192.168.1.223</td><td>Debian 11 (Bullseye)</td><td>Percona XtraDB Cluster (PXC)</td></tr><tr><td>Haproxy 节点一</td><td> haproxy-node-1</td><td>192.168.1.235</td><td>Debian 11 (Bullseye)</td><td>Haproxy + Keepalived</td></tr><tr><td>Haproxy 节点二</td><td> haproxy-node-2</td><td>192.168.1.239</td><td>Debian 11 (Bullseye)</td><td>Haproxy + Keepalived</td></tr></tbody></table><div class="admonition note"><p class="admonition-title">提示</p><ul><li>Percona XtraDB Cluster 要求最小的集群大小是 3 个节点。</li><li>建议尽可能地控制 PXC 集群的规模，节点越多，数据同步速度越慢。</li><li>PXC 存在硬件配置短板限制，即整个集群的写吞吐量受最弱节点的限制。因此所有 PXC 节点的硬件配置要一致，否则如果一个节点变慢，整个集群会跟着变慢。</li></ul></div><h2 id="系统初始化"><a href="#系统初始化" class="headerlink" title="系统初始化"></a>系统初始化</h2><h3 id="配置-Host"><a href="#配置-Host" class="headerlink" title="配置 Host"></a>配置 Host</h3><p>在每个节点服务器上编辑 <code>/etc/hosts</code> 文件，加入以下内容：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.188    pxc-node-1</span><br><span class="line">192.168.1.193    pxc-node-2</span><br><span class="line">192.168.1.223    pxc-node-3</span><br><span class="line">192.168.1.235    haproxy-node-1</span><br><span class="line">192.168.1.239    haproxy-node-2</span><br></pre></td></tr></tbody></table></figure><h3 id="设置主机名"><a href="#设置主机名" class="headerlink" title="设置主机名"></a>设置主机名</h3><p>在每个节点服务器上设置主机名。若由于其他限制导致不允许更改主机名，则可以跳过以下步骤。</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看主机名</span></span><br><span class="line">$ hostnamectl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 永久更改主机名</span></span><br><span class="line">$ sudo hostnamectl set-hostname xx-xxxx</span><br></pre></td></tr></tbody></table></figure><h3 id="配置防火墙"><a href="#配置防火墙" class="headerlink" title="配置防火墙"></a>配置防火墙</h3><p>在配置系统防火墙之前，在每个服务器上分别安装 UFW 防火墙工具。</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装ufw</span></span><br><span class="line">sudo apt install ufw</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开放SSH端口</span></span><br><span class="line">sudo ufw allow OpenSSH</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用ufw</span></span><br><span class="line">sudo ufw <span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看ufw的运行状态</span></span><br><span class="line">sudo ufw status</span><br></pre></td></tr></tbody></table></figure><h4 id="PXC-集群的防火墙"><a href="#PXC-集群的防火墙" class="headerlink" title="PXC 集群的防火墙"></a>PXC 集群的防火墙</h4><p>在本节中，将在每个 PXC 集群节点服务器上使用 UFW 配置防火墙，使 PXC 集群节点之间可以互相通信。</p><ul><li><p>PXC 集群默认会使用到以下端口</p><ul><li><code>3306</code></li><li><code>4444</code></li><li><code>4567</code></li><li><code>4568</code></li></ul></li><li><p>基于 UFW 配置防火墙</p></li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开放 PXC 端口，192.168.1.0/24 是所有 PXC 集群节点的子网地址</span></span><br><span class="line">sudo ufw allow from 192.168.1.0/24 proto tcp to any port 3306</span><br><span class="line">sudo ufw allow from 192.168.1.0/24 proto tcp to any port 4444</span><br><span class="line">sudo ufw allow from 192.168.1.0/24 proto tcp to any port 4567</span><br><span class="line">sudo ufw allow from 192.168.1.0/24 proto tcp to any port 4568</span><br></pre></td></tr></tbody></table></figure><ul><li>查看 UFW 的运行状态</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看ufw的运行状态</span></span><br><span class="line">sudo ufw status</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Status: active</span><br><span class="line"></span><br><span class="line">To                         Action      From</span><br><span class="line">--                         ------      ----</span><br><span class="line">OpenSSH                    ALLOW       Anywhere                  </span><br><span class="line">3306/tcp                   ALLOW       192.168.1.0/24            </span><br><span class="line">4444/tcp                   ALLOW       192.168.1.0/24            </span><br><span class="line">4567/tcp                   ALLOW       192.168.1.0/24            </span><br><span class="line">4568/tcp                   ALLOW       192.168.1.0/24            </span><br><span class="line">OpenSSH (v6)               ALLOW       Anywhere (v6)     </span><br></pre></td></tr></tbody></table></figure><h4 id="Haproxy-的防火墙"><a href="#Haproxy-的防火墙" class="headerlink" title="Haproxy 的防火墙"></a>Haproxy 的防火墙</h4><p>在本节中，将在每个 Haproxy 节点服务器上使用 UFW 配置防火墙，使外部可以正常访问 Haproxy。</p><ul><li><p>Haproxy 默认会使用到以下端口</p><ul><li><code>3306</code>：Haproxy 代理 MySQL 的端口</li><li><code>8888</code>：Haproxy 监控页面的 Web 端口</li></ul></li><li><p>基于 UFW 配置防火墙</p></li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开放 Haproxy 端口，192.168.1.0/24 是所有 Haproxy 节点的子网地址</span></span><br><span class="line">sudo ufw allow from 192.168.1.0/24 proto tcp to any port 3306</span><br><span class="line">sudo ufw allow from 192.168.1.0/24 proto tcp to any port 8888</span><br></pre></td></tr></tbody></table></figure><ul><li>查看 UFW 的运行状态</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看ufw的运行状态</span></span><br><span class="line">sudo ufw status</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Status: active</span><br><span class="line"></span><br><span class="line">To                         Action      From</span><br><span class="line">--                         ------      ----</span><br><span class="line">OpenSSH                    ALLOW       Anywhere                  </span><br><span class="line">3306/tcp                   ALLOW       192.168.1.0/24            </span><br><span class="line">8888/tcp                   ALLOW       192.168.1.0/24            </span><br><span class="line">OpenSSH (v6)               ALLOW       Anywhere (v6)   </span><br></pre></td></tr></tbody></table></figure><h4 id="Keepalived-的防火墙"><a href="#Keepalived-的防火墙" class="headerlink" title="Keepalived 的防火墙"></a>Keepalived 的防火墙</h4><p>在本节中，将在每个 Keepalived 节点服务器上使用 UFW 配置防火墙，使 Keepalived 节点之间可以互相进行心跳通信。</p><ul><li><p>Keepalived 心跳通信</p><ul><li>Keepalived 使用 VRRP 协议进行通信（协议号码为 <code>112</code>）</li><li>Keepalived 用于心跳通信的默认 VRRP 广播地址是 <code>224.0.0.18</code></li><li>如果 Keepalived 节点之间不能正常进行心跳通信，就会发生脑裂现象，即多个 Keepalived 节点会同时抢占到虚拟 IP</li></ul></li><li><p> 基于 UFW 配置防火墙</p></li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开放 VRRP 广播地址，enp0s3 是网卡接口，192.168.1.0/24 是所有 Keepalived 节点的子网地址</span></span><br><span class="line">ufw allow <span class="keyword">in</span> on enp0s3 from 192.168.1.0/24 to 224.0.0.18;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Status: active</span><br><span class="line"></span><br><span class="line">To                         Action      From</span><br><span class="line">--                         ------      ----</span><br><span class="line">OpenSSH                    ALLOW       Anywhere                  </span><br><span class="line">3306/tcp                   ALLOW       192.168.1.0/24            </span><br><span class="line">8888/tcp                   ALLOW       192.168.1.0/24            </span><br><span class="line">224.0.0.18 on enp0s3       ALLOW       192.168.1.0/24            </span><br><span class="line">OpenSSH (v6)               ALLOW       Anywhere (v6)   </span><br></pre></td></tr></tbody></table></figure><h3 id="关闭-SeLinux"><a href="#关闭-SeLinux" class="headerlink" title="关闭 SeLinux"></a>关闭 SeLinux</h3><p>在本节中，将在每个节点服务器上永久关闭 SeLinux，保证 PXC 集群节点可以互相通信。值得一提的是，如果系统没有安装 SeLinux，则可以跳过以下步骤。</p><ul><li>编辑 SeLinux 的配置文件</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑配置文件</span></span><br><span class="line">sudo vi /etc/selinux/config</span><br></pre></td></tr></tbody></table></figure><ul><li>将 <code>SELINUX</code> 的值设置为 <code>disabled</code></li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># This file controls the state of SELinux on the system.</span><br><span class="line"># SELINUX= can take one of these three values:</span><br><span class="line">#     enforcing - SELinux security policy is enforced.</span><br><span class="line">#     permissive - SELinux prints warnings instead of enforcing.</span><br><span class="line">#     disabled - No SELinux policy is loaded.</span><br><span class="line">SELINUX=disabled</span><br><span class="line"># SELINUXTYPE= can take one of three two values:</span><br><span class="line">#     targeted - Targeted processes are protected,</span><br><span class="line">#     minimum - Modification of targeted policy. Only selected processes are protected.</span><br><span class="line">#     mls - Multi Level Security protection.</span><br><span class="line">SELINUXTYPE=targeted</span><br></pre></td></tr></tbody></table></figure><h3 id="系统性能优化"><a href="#系统性能优化" class="headerlink" title="系统性能优化"></a>系统性能优化</h3><p>在本节中，将在每个节点服务器上更改系统的最大打开文件描述符数，且更改永久生效。</p><div class="admonition note"><p class="admonition-title">提示</p><ul><li>关于更改最大打开文件描述符数的详细教程，可以看 <a href="/posts/88a10b.html">这里</a>。</li><li>PXC 集群无需配置 Percona Server 数据库的最大打开文件描述符数，因为在 Percona Server 服务的配置文件 <code>/lib/systemd/system/mysql.service</code> 和 <code>/lib/systemd/system/mysql@.service</code> 中，默认都已经配置了 <code>LimitNOFILE=16364</code>。</li></ul></div><ul><li>查看限制</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -n</span><br></pre></td></tr></tbody></table></figure><ul><li>更改配置</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第一步</span></span><br><span class="line">sudo vim /etc/security/limits.conf</span><br><span class="line"></span><br><span class="line">* soft nofile 1048576</span><br><span class="line">* hard nofile 1048576</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二步</span></span><br><span class="line">sudo vim /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line">fs.file-max = 1048576</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第三步（重启系统）</span></span><br><span class="line">sudo reboot</span><br></pre></td></tr></tbody></table></figure><ul><li>验证生效</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -n</span><br><span class="line"></span><br><span class="line">sudo sysctl fs.file-max</span><br></pre></td></tr></tbody></table></figure><h3 id="卸载已安装软件"><a href="#卸载已安装软件" class="headerlink" title="卸载已安装软件"></a>卸载已安装软件</h3><p>检查每个节点服务器上的 Debian 系统是否已经安装过 MySQL、MariaDB、Percona Server 数据库，如果安装过请先卸载掉，然后再安装 PXC 集群。</p><h3 id="检查交换分区的大小"><a href="#检查交换分区的大小" class="headerlink" title="检查交换分区的大小"></a>检查交换分区的大小</h3><p>检查每个节点服务器上的交换分区大小，如果 Debian 系统没有交换分区，则建议手动创建并挂载，详细教程请看 <a href="/posts/9301e8fd.html">这里</a>。</p><ul><li>交换分区大小配置规则<ul><li>如果 RAM 介于 2 GB 和 8 GB 之间，则 SWAP 为 RAM 大小的 2 倍。</li><li>如果 RAM 在 8 GB 到 32 GB 之间，则 SWAP 为 RAM 大小的 1.5 倍。</li><li>如果 RAM 大于 32 GB，则 SWAP 为 32 GB。</li></ul></li></ul><h2 id="PXC-集群安装"><a href="#PXC-集群安装" class="headerlink" title="PXC 集群安装"></a>PXC 集群安装</h2><p>在本节中，将在每个节点服务器上，基于 Debian 11 添加并设置 Percona XtraDB Cluster 存储库，然后安装 Percona XtraDB Cluster 软件包。此外，在安装过程中，系统会提示设置 MySQL 的 <code>root</code> 账号的密码，并为 Percona XtraDB Cluster 设置默认身份验证插件。最后，将通过配置的 <code>root</code> 用户和密码登录数据库，验证 Percona XtraDB Cluster 的安装。值得一提的，PXC 集群的部署规划如下表所示：</p><table><thead><tr><th>节点名称</th><th>主机名</th><th> IP</th><th> 系统</th><th>说明</th></tr></thead><tbody><tr><td> PXC 节点一</td><td> pxc-node-1</td><td>192.168.1.188</td><td>Debian 11 (Bullseye)</td><td>Percona XtraDB Cluster (PXC)</td></tr><tr><td>PXC 节点二</td><td> pxc-node-2</td><td>192.168.1.193</td><td>Debian 11 (Bullseye)</td><td>Percona XtraDB Cluster (PXC)</td></tr><tr><td>PXC 节点三</td><td> pxc-node-3</td><td>192.168.1.223</td><td>Debian 11 (Bullseye)</td><td>Percona XtraDB Cluster (PXC)</td></tr></tbody></table><h3 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h3><ul><li>安装基础依赖</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">sudo apt install -y wget gnupg2 lsb-release curl</span><br></pre></td></tr></tbody></table></figure><ul><li>安装 Percona XtraDB Cluster 的存储库包</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载存储库包</span></span><br><span class="line">wget -q https://repo.percona.com/apt/percona-release_latest.generic_all.deb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装存储库包</span></span><br><span class="line">sudo dpkg -i percona-release_latest.generic_all.deb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新包索引信息</span></span><br><span class="line">sudo apt-get update</span><br></pre></td></tr></tbody></table></figure><ul><li>启用 Percona XtraDB Cluster 8.0 （相当于 MySQL 8.0）的存储库</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo percona-release setup pxc80</span><br></pre></td></tr></tbody></table></figure><ul><li>安装 Percona XtraDB Cluster 软件包</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装PXC软件包</span></span><br><span class="line">sudo apt install -y percona-xtradb-cluster</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用代理，如果网络很卡导致安装失败，建议使用代理进行安装</span></span><br><span class="line">sudo apt install -y -o Acquire::http::proxy=<span class="string">"socks5h://127.0.0.1:1080/"</span> percona-xtradb-cluster</span><br></pre></td></tr></tbody></table></figure><ul><li>选择默认的认证插件（建议选择强加密）</li></ul><p><img data-src="../../../asset/2023/10/mysql-pxc8-7.png"></p><ul><li>根据提示输入 <code>root</code> 账号的密码（强）</li></ul><p><img data-src="../../../asset/2023/10/mysql-pxc8-1.png"></p><ul><li>根据提示确认 <code>root</code> 账号的密码（强）</li></ul><p><img data-src="../../../asset/2023/10/mysql-pxc8-2.png"></p><ul><li>启动 MySQL 服务</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line">sudo systemctl start mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看服务状态</span></span><br><span class="line">sudo systemctl status mysql</span><br></pre></td></tr></tbody></table></figure><h3 id="安装测试"><a href="#安装测试" class="headerlink" title="安装测试"></a>安装测试</h3><p>在每个节点服务器上执行以下命令，然后输入 <code>root</code> 账号的密码，若能成功登录 MySQL，则说明数据库正常运行。</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录MySQL</span></span><br><span class="line">sudo mysql -h localhost -u root -p</span><br></pre></td></tr></tbody></table></figure><h2 id="PXC-集群配置"><a href="#PXC-集群配置" class="headerlink" title="PXC 集群配置"></a>PXC 集群配置</h2><p><strong>特别注意，在开始配置 Percona XtraDB Cluster 集群之前，必须确保所有节点上的 MySQL 服务器都已停止运行。</strong></p><ul><li>关闭第一个节点（负责集群初始化）</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭服务</span></span><br><span class="line">sudo systemctl stop mysql@bootstrap.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看服务状态</span></span><br><span class="line">sudo systemctl status mysql@bootstrap.service</span><br></pre></td></tr></tbody></table></figure><ul><li>关闭其他节点</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭服务</span></span><br><span class="line">sudo systemctl stop mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看服务状态</span></span><br><span class="line">sudo systemctl status mysql</span><br></pre></td></tr></tbody></table></figure><h3 id="拷贝-SSL-TLS-证书"><a href="#拷贝-SSL-TLS-证书" class="headerlink" title="拷贝 SSL/TLS 证书"></a>拷贝 SSL/TLS 证书</h3><p>Percona XtraDB Cluster 有两种流量加密：客户端 / 服务器连接和复制流量。在最新的 Percona XtraDB Cluster 8.0 上，默认情况下会启用所有复制流量的加密以增强安全性。因此在创建和设置 Percona XtraDB Cluster 时，所有服务器都必须具有相同的 CA 和 Server 证书，即必须将默认的 CA 和 Server 证书从 <code>pxc-node-1</code> 节点拷贝到 <code>pxc-node-2</code> 节点和 <code>pxc-node-3</code> 节点。</p><ul><li>在 PXC 集群安装的过程中，SSL/TLS 证书已经在数据目录 <code>/var/lib/mysql</code> 下自动生成了，包括 Client、Server、CA 三种类型的证书</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看SSL/TLC证书列表</span></span><br><span class="line">ls /var/lib/mysql/*.pem</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/var/lib/mysql/ca.pem</span><br><span class="line">/var/lib/mysql/ca-key.pem</span><br><span class="line">/var/lib/mysql/public_key.pem</span><br><span class="line">/var/lib/mysql/private_key.pem</span><br><span class="line">/var/lib/mysql/client-key.pem</span><br><span class="line">/var/lib/mysql/client-cert.pem</span><br><span class="line">/var/lib/mysql/server-key.pem</span><br><span class="line">/var/lib/mysql/server-cert.pem</span><br></pre></td></tr></tbody></table></figure><ul><li>在 <code>pxc-node-1</code> 节点上，拷贝 CA 和 Server 证书到 <code>pxc-node-2</code> 节点和 <code>pxc-node-3</code> 节点。</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入证书目录</span></span><br><span class="line"><span class="built_in">cd</span> /var/lib/mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝证书</span></span><br><span class="line">scp server-key.pem server-cert.pem ca.pem root@pxc-node-2:/var/lib/mysql</span><br><span class="line">scp server-key.pem server-cert.pem ca.pem root@pxc-node-3:/var/lib/mysql</span><br></pre></td></tr></tbody></table></figure><h3 id="在第一个节点上初始化集群"><a href="#在第一个节点上初始化集群" class="headerlink" title="在第一个节点上初始化集群"></a>在第一个节点上初始化集群</h3><p>在本节中，将在第一个节点服务器 <code>pxc-node-1</code> 上初始化 Percona XtraDB Cluster 集群（即引导 PXC 集群启动）。<strong>请确保以下步骤都是在节点一服务器上执行。</strong></p><ul><li>编辑节点一的 MySQL 配置文件，添加以下配置内容</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份配置文件</span></span><br><span class="line">sudo cp /etc/mysql/mysql.conf.d/mysqld.cnf /etc/mysql/mysql.conf.d/mysqld.cnf.bak</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑配置文件</span></span><br><span class="line">sudo vi /etc/mysql/mysql.conf.d/mysqld.cnf</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">socket=/var/run/mysqld/mysqld.sock</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=1</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/run/mysqld/mysqld.sock</span><br><span class="line">log-error=/var/log/mysql/error.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line"></span><br><span class="line">######## wsrep ###############</span><br><span class="line"></span><br><span class="line"># Path to Galera library</span><br><span class="line">wsrep_provider=/usr/lib/libgalera_smm.so</span><br><span class="line"></span><br><span class="line"># Cluster connection URL contains the IPs of pxc01, pxc02, and pxc03</span><br><span class="line">wsrep_cluster_address=gcomm://192.168.1.188,192.168.1.193,192.168.1.223</span><br><span class="line"></span><br><span class="line"># In order for Galera to work correctly binlog format should be ROW</span><br><span class="line">binlog_format=ROW</span><br><span class="line"></span><br><span class="line"># Slave thread to use</span><br><span class="line">wsrep_slave_threads=4</span><br><span class="line"></span><br><span class="line"># Using the MyISAM storage engine is not recommended.</span><br><span class="line">default_storage_engine=InnoDB</span><br><span class="line"></span><br><span class="line"># This InnoDB autoincrement locking mode is a requirement for Galera</span><br><span class="line">innodb_autoinc_lock_mode=2</span><br><span class="line"></span><br><span class="line"># Node 1 address</span><br><span class="line">wsrep_node_address=192.168.1.188</span><br><span class="line"></span><br><span class="line"># SST method</span><br><span class="line">wsrep_sst_method=xtrabackup-v2</span><br><span class="line"></span><br><span class="line"># Cluster name</span><br><span class="line">wsrep_cluster_name=pxc_cluster</span><br><span class="line"></span><br><span class="line"># If is not specified, then system hostname will be used</span><br><span class="line">wsrep_node_name=pxc-cluster-node-1</span><br><span class="line"></span><br><span class="line"># PXC Strict Mode allowed values: DISABLED,PERMISSIVE,ENFORCING,MASTER</span><br><span class="line">pxc_strict_mode=ENFORCING</span><br><span class="line"></span><br><span class="line">wsrep_provider_options="socket.ssl_key=server-key.pem;socket.ssl_cert=server-cert.pem;socket.ssl_ca=ca.pem"</span><br><span class="line"></span><br><span class="line">[sst]</span><br><span class="line">encrypt=4</span><br><span class="line">ssl-key=server-key.pem</span><br><span class="line">ssl-ca=ca.pem</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">核心参数说明：</span><br><span class="line">    - `wsrep_cluster_name`：集群的名称</span><br><span class="line">    - `server-id`：MySQL 实例的唯一标识符（每个节点都不一样）</span><br><span class="line">    - `wsrep_node_name`：当前节点服务器的名称（每个节点都不一样），如果不指定默认使用主机名</span><br><span class="line">    - `wsrep_node_address`：当前节点服务器的 IP 地址（每个节点都不一样）</span><br><span class="line">    - `wsrep_cluster_address`：所有节点服务器的 IP 地址</span><br><span class="line"></span><br><span class="line">其他参数说明：</span><br><span class="line">    - `default_storage_engine=InnoDB`：指定默认的存储引擎为 InnoDB</span><br><span class="line">    - `innodb_autoinc_lock_mode=2`：该模式下所有 INSERT SQL 都不会有表级 AUTO-INC 锁，即多个语句可以同时执行</span><br><span class="line">    - `pxc_strict_mode=ENFORCING`：严厉模式，`ENFORCING` 表示会阻止用户执行 Percona XtraDB Cluster 所不支持的功能</span><br></pre></td></tr></tbody></table></figure><ul><li>初始化集群</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动节点一的MySQL服务（初始化集群）</span></span><br><span class="line">systemctl start mysql@bootstrap.service</span><br></pre></td></tr></tbody></table></figure><div class="admonition warning"><p class="admonition-title">特别注意</p><ul><li><code>mysql@bootstrap</code> 是一个用于运行 Percona XtraDB Cluster 的 Systemd 服务，这与普通的 <code>mysql</code> 服务有本质的区别，主要用于 PXC 集群的初始化（即引导 PXC 集群启动）。</li><li>使用 Percona XtraDB Cluster 构建 MySQL 服务器时，第一个节点必须使用 <code>mysql@bootstrap</code> 服务进行管理，包括启动、关闭、重启、查看状态等操作（如下所示），而其他节点则可以直接使用普通的 <code>mysql</code> 服务进行管理。</li><li>启动第一个节点服务器：<code>systemctl start mysql@bootstrap.service</code>。</li><li>关闭第一个节点服务器：<code>systemctl stop mysql@bootstrap.service</code>。</li><li>重启第一个节点服务器：<code>systemctl restart mysql@bootstrap.service</code>。</li><li>查看第一个节点服务器的状态：<code>systemctl status mysql@bootstrap.service</code>。</li></ul></div><ul><li>验证集群的初始化是否成功</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录MySQL</span></span><br><span class="line">sudo mysql -h localhost -u root -p</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看集群状态</span></span><br><span class="line">show status like <span class="string">'wsrep%'</span>;</span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">提示</p><p>当 PXC 集群初始化成功后，应该可以看到下述的状态信息。<code>wsrep_cluster_size</code> 的值是 <code>1</code>，这意味着 Percona XtraDB Cluster 是用一台服务器初始化的。<code>wsrep_incoming_address</code> 的值是节点一服务器的 IP 地址。最后，节点处于 <code>Synced</code> 状态，这意味着它已完全连接并准备好进行写集复制。</p></div><p><img data-src="../../../asset/2023/10/mysql-pxc8-3.png"></p><h3 id="将第二个节点添加到集群中"><a href="#将第二个节点添加到集群中" class="headerlink" title="将第二个节点添加到集群中"></a>将第二个节点添加到集群中</h3><ul><li>编辑节点二的 MySQL 配置文件，添加以下内容</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份配置文件</span></span><br><span class="line">sudo cp /etc/mysql/mysql.conf.d/mysqld.cnf /etc/mysql/mysql.conf.d/mysqld.cnf.bak</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑配置文件</span></span><br><span class="line">sudo vi /etc/mysql/mysql.conf.d/mysqld.cnf</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">socket=/var/run/mysqld/mysqld.sock</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/run/mysqld/mysqld.sock</span><br><span class="line">log-error=/var/log/mysql/error.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line"></span><br><span class="line">######## wsrep ###############</span><br><span class="line"></span><br><span class="line"># Path to Galera library</span><br><span class="line">wsrep_provider=/usr/lib/libgalera_smm.so</span><br><span class="line"></span><br><span class="line"># Cluster connection URL contains the IPs of pxc01, pxc02, and pxc03</span><br><span class="line">wsrep_cluster_address=gcomm://192.168.1.188,192.168.1.193,192.168.1.223</span><br><span class="line"></span><br><span class="line"># In order for Galera to work correctly binlog format should be ROW</span><br><span class="line">binlog_format=ROW</span><br><span class="line"></span><br><span class="line"># Slave thread to use</span><br><span class="line">wsrep_slave_threads=4</span><br><span class="line"></span><br><span class="line"># Using the MyISAM storage engine is not recommended.</span><br><span class="line">default_storage_engine=InnoDB</span><br><span class="line"></span><br><span class="line"># This InnoDB autoincrement locking mode is a requirement for Galera</span><br><span class="line">innodb_autoinc_lock_mode=2</span><br><span class="line"></span><br><span class="line"># Node 2 address</span><br><span class="line">wsrep_node_address=192.168.1.193</span><br><span class="line"></span><br><span class="line"># SST method</span><br><span class="line">wsrep_sst_method=xtrabackup-v2</span><br><span class="line"></span><br><span class="line"># Cluster name</span><br><span class="line">wsrep_cluster_name=pxc_cluster</span><br><span class="line"></span><br><span class="line"># If is not specified, then system hostname will be used</span><br><span class="line">wsrep_node_name=pxc-cluster-node-2</span><br><span class="line"></span><br><span class="line"># PXC Strict Mode allowed values: DISABLED,PERMISSIVE,ENFORCING,MASTER</span><br><span class="line">pxc_strict_mode=ENFORCING</span><br><span class="line"></span><br><span class="line">wsrep_provider_options="socket.ssl_key=server-key.pem;socket.ssl_cert=server-cert.pem;socket.ssl_ca=ca.pem"</span><br><span class="line"></span><br><span class="line">[sst]</span><br><span class="line">encrypt=4</span><br><span class="line">ssl-key=server-key.pem</span><br><span class="line">ssl-ca=ca.pem</span><br></pre></td></tr></tbody></table></figure><div class="admonition warning"><p class="admonition-title">特别注意</p><p><code>server-id</code>、<code>wsrep_node_address</code>、<code>wsrep_node_name</code> 这三个参数必须跟其他节点一、节点三不一样。</p></div><ul><li>验证节点二是否成功添加到集群，在节点二服务器上执行以下命令</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动MySQL服务</span></span><br><span class="line">sudo systemctl start mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看MySQL服务的状态</span></span><br><span class="line">sudo systemctl status mysql</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录MySQL</span></span><br><span class="line">sudo mysql -h localhost -u root -p</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看集群状态</span></span><br><span class="line">show status like <span class="string">'wsrep%'</span>;</span><br></pre></td></tr></tbody></table></figure><p><img data-src="../../../asset/2023/10/mysql-pxc8-4.png"></p><h3 id="将第三个节点添加到集群中"><a href="#将第三个节点添加到集群中" class="headerlink" title="将第三个节点添加到集群中"></a>将第三个节点添加到集群中</h3><ul><li>编辑节点三的 MySQL 配置文件，添加以下内容</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份配置文件</span></span><br><span class="line">sudo cp /etc/mysql/mysql.conf.d/mysqld.cnf /etc/mysql/mysql.conf.d/mysqld.cnf.bak</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑配置文件</span></span><br><span class="line">sudo vi /etc/mysql/mysql.conf.d/mysqld.cnf</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">socket=/var/run/mysqld/mysqld.sock</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=3</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/run/mysqld/mysqld.sock</span><br><span class="line">log-error=/var/log/mysql/error.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line"></span><br><span class="line">######## wsrep ###############</span><br><span class="line"></span><br><span class="line"># Path to Galera library</span><br><span class="line">wsrep_provider=/usr/lib/libgalera_smm.so</span><br><span class="line"></span><br><span class="line"># Cluster connection URL contains the IPs of pxc01, pxc02, and pxc03</span><br><span class="line">wsrep_cluster_address=gcomm://192.168.1.188,192.168.1.193,192.168.1.223</span><br><span class="line"></span><br><span class="line"># In order for Galera to work correctly binlog format should be ROW</span><br><span class="line">binlog_format=ROW</span><br><span class="line"></span><br><span class="line"># Slave thread to use</span><br><span class="line">wsrep_slave_threads=4</span><br><span class="line"></span><br><span class="line"># Using the MyISAM storage engine is not recommended.</span><br><span class="line">default_storage_engine=InnoDB</span><br><span class="line"></span><br><span class="line"># This InnoDB autoincrement locking mode is a requirement for Galera</span><br><span class="line">innodb_autoinc_lock_mode=2</span><br><span class="line"></span><br><span class="line"># Node 3 address</span><br><span class="line">wsrep_node_address=192.168.1.223</span><br><span class="line"></span><br><span class="line"># SST method</span><br><span class="line">wsrep_sst_method=xtrabackup-v2</span><br><span class="line"></span><br><span class="line"># Cluster name</span><br><span class="line">wsrep_cluster_name=pxc_cluster</span><br><span class="line"></span><br><span class="line"># If is not specified, then system hostname will be used</span><br><span class="line">wsrep_node_name=pxc-cluster-node-3</span><br><span class="line"></span><br><span class="line"># PXC Strict Mode allowed values: DISABLED,PERMISSIVE,ENFORCING,MASTER</span><br><span class="line">pxc_strict_mode=ENFORCING</span><br><span class="line"></span><br><span class="line">wsrep_provider_options="socket.ssl_key=server-key.pem;socket.ssl_cert=server-cert.pem;socket.ssl_ca=ca.pem"</span><br><span class="line"></span><br><span class="line">[sst]</span><br><span class="line">encrypt=4</span><br><span class="line">ssl-key=server-key.pem</span><br><span class="line">ssl-ca=ca.pem</span><br></pre></td></tr></tbody></table></figure><div class="admonition warning"><p class="admonition-title">特别注意</p><p><code>server-id</code>、<code>wsrep_node_address</code>、<code>wsrep_node_name</code> 这三个参数必须跟其他节点一、节点二不一样。</p></div><ul><li>验证节点三是否成功添加到集群，在节点三服务器上执行以下命令</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动MySQL服务</span></span><br><span class="line">sudo systemctl start mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看MySQL服务的状态</span></span><br><span class="line">sudo systemctl status mysql</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录MySQL</span></span><br><span class="line">sudo mysql -h localhost -u root -p</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看集群状态</span></span><br><span class="line">show status like <span class="string">'wsrep%'</span>;</span><br></pre></td></tr></tbody></table></figure><p><img data-src="../../../asset/2023/10/mysql-pxc8-5.png"></p><h2 id="PXC-集群测试"><a href="#PXC-集群测试" class="headerlink" title="PXC 集群测试"></a>PXC 集群测试</h2><p>在本节中，将对 PXC 集群的复制进行测试，包括创建数据库和表、插入数据。</p><h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><ul><li>登录节点二的 MySQL 服务器，创建 <code>percona</code> 数据库</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建数据库</span></span><br><span class="line">CREATE DATABASE `percona` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</span><br></pre></td></tr></tbody></table></figure><ul><li>登录节点一或者节点三的 MySQL 服务器，观察是否同步创建了相同的数据库</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看数据库列表</span></span><br><span class="line">SHOW DATABASES;</span><br></pre></td></tr></tbody></table></figure><h3 id="创建数据库表"><a href="#创建数据库表" class="headerlink" title="创建数据库表"></a>创建数据库表</h3><ul><li>登录节点三的 MySQL 服务器，创建 <code>example</code> 数据库表</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换数据库</span></span><br><span class="line">USE `percona`;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建数据库表</span></span><br><span class="line">CREATE TABLE example (node_id INT PRIMARY KEY, node_name VARCHAR(30));</span><br></pre></td></tr></tbody></table></figure><ul><li>登录节点一的 MySQL 服务器，往 <code>example</code> 数据库表插入数据</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换数据库</span></span><br><span class="line">USE `percona`;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插入数据</span></span><br><span class="line">INSERT INTO percona.example VALUES (1, <span class="string">'pxc01'</span>);</span><br><span class="line">INSERT INTO percona.example VALUES (2, <span class="string">'pxc02'</span>);</span><br><span class="line">INSERT INTO percona.example VALUES (3, <span class="string">'pxc03'</span>);</span><br></pre></td></tr></tbody></table></figure><ul><li>登录节点二的 MySQL 服务器，查询 <code>example</code> 表的数据</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换数据库</span></span><br><span class="line">USE `percona`;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询数据</span></span><br><span class="line">SELECT * FROM percona.example;</span><br></pre></td></tr></tbody></table></figure><h2 id="PXC-集群管理"><a href="#PXC-集群管理" class="headerlink" title="PXC 集群管理"></a>PXC 集群管理</h2><h3 id="创建用户操作"><a href="#创建用户操作" class="headerlink" title="创建用户操作"></a>创建用户操作</h3><p>登录任意一个 PXC 集群节点的数据库，执行以下命令创建新用户，并授权用户可以远程访问指定的数据库。</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录MySQL</span></span><br><span class="line">sudo mysql -h localhost -u root -p</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建用户</span></span><br><span class="line">CREATE USER <span class="string">'uatOption'</span>@<span class="string">'%'</span> IDENTIFIED WITH mysql_native_password BY <span class="string">'Pxc_User_123@456'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 授权远程访问指定的数据库</span></span><br><span class="line">GRANT ALL PRIVILEGES ON percona.* TO <span class="string">'uatOption'</span>@<span class="string">'%'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 刷新权限信息</span></span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看用户列表</span></span><br><span class="line">SELECT host, user, plugin, authentication_string FROM mysql.user;</span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">提示</p><p>这里为了兼容 MySQL 5 的认证方式，建议在创建数据库用户时，指定加密规则为 <code>mysql_native_password</code>。值得一提的是，MySQL 8 默认使用的加密规则是 <code>caching_sha2_password</code>。</p></div><h3 id="集群各指标检查"><a href="#集群各指标检查" class="headerlink" title="集群各指标检查"></a>集群各指标检查</h3><p>在检测 PXC 集群各指标之前，先登录任意一个 PXC 集群节点的数据库，然后再执行其他操作。</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录MySQL</span></span><br><span class="line">sudo mysql -h localhost -u root -p</span><br></pre></td></tr></tbody></table></figure><h4 id="集群完整性检查"><a href="#集群完整性检查" class="headerlink" title="集群完整性检查"></a>集群完整性检查</h4><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show global status <span class="built_in">where</span> variable_name <span class="keyword">in</span> (<span class="string">'wsrep_cluster_state_uuid'</span>,<span class="string">'wsrep_cluster_conf_id'</span>,<span class="string">'wsrep_cluster_size'</span>,<span class="string">'wsrep_cluster_status'</span>);</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+--------------------------+--------------------------------------+</span><br><span class="line">| Variable_name            | Value                                |</span><br><span class="line">+--------------------------+--------------------------------------+</span><br><span class="line">| wsrep_cluster_conf_id    | 7                                    |</span><br><span class="line">| wsrep_cluster_size       | 3                                    |</span><br><span class="line">| wsrep_cluster_state_uuid | e4bb8bf0-73d5-11ee-b279-3a5ebcc11ef7 |</span><br><span class="line">| wsrep_cluster_status     | Primary                              |</span><br><span class="line">+--------------------------+--------------------------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></tbody></table></figure><p>特别注意，在正常情况下以下指标值，在所有节点应该都是一致的。</p><table><thead><tr><th>指标</th><th>说明</th></tr></thead><tbody><tr><td><code>wsrep_cluster_state_uuid</code></td><td>在集群所有节点中该值应该是相同的，若有不同值，说明该节点没有连入集群。</td></tr><tr><td><code>wsrep_cluster_conf_id</code></td><td>在集群所有节点中该值应该是相同的，若有不同值，说明该节点被临时 <code>分区</code> 了，当节点之间网络连接恢复后，该值应该恢复成一致。</td></tr><tr><td><code>wsrep_cluster_size</code></td><td>如果与集群中的节点数一致，说明所有节点已经连接。</td></tr><tr><td><code>wsrep_cluster_status</code></td><td>集群状态，若不为 <code>Primary</code>，说明出现 <code>分区</code> 或是 <code>split-brain</code> 状况。</td></tr></tbody></table><h4 id="集群节点状态检查"><a href="#集群节点状态检查" class="headerlink" title="集群节点状态检查"></a>集群节点状态检查</h4><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show global status <span class="built_in">where</span> variable_name <span class="keyword">in</span> (<span class="string">'wsrep_ready'</span>,<span class="string">'wsrep_connected'</span>,<span class="string">'wsrep_local_state_comment'</span>);</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+---------------------------+--------+</span><br><span class="line">| Variable_name             | Value  |</span><br><span class="line">+---------------------------+--------+</span><br><span class="line">| wsrep_connected           | ON     |</span><br><span class="line">| wsrep_local_state_comment | Synced |</span><br><span class="line">| wsrep_ready               | ON     |</span><br><span class="line">+---------------------------+--------+</span><br></pre></td></tr></tbody></table></figure><p>特别注意，在正常情况下以下指标值，在所有节点应该都是一致的。</p><table><thead><tr><th>指标</th><th>说明</th></tr></thead><tbody><tr><td><code>wsrep_ready</code></td><td>该值为 <code>ON</code>，则说明可以接受 SQL 负载；如果为 <code>OFF</code>，则需要检查 <code>wsrep_connected</code>。</td></tr><tr><td><code>wsrep_connected</code></td><td>如果该值为 <code>OFF</code>，且 <code>wsrep_ready</code> 的值也为 <code>OFF</code>，则说明该节点没有连入集群，可能是 <code>wsrep_cluster_address</code> 或 <code>wsrep_cluster_name</code> 等配置错误造成的，具体需要排查 MySQL 的错误日志。</td></tr><tr><td><code>wsrep_local_state_comment</code></td><td>若 <code>wsrep_connected</code> 为 <code>ON</code>，但 <code>wsrep_ready</code> 为 <code>OFF</code>，则可以从该项查找错误原因。</td></tr></tbody></table><h4 id="集群健康信息检查"><a href="#集群健康信息检查" class="headerlink" title="集群健康信息检查"></a>集群健康信息检查</h4><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show global status <span class="built_in">where</span> variable_name <span class="keyword">in</span> (<span class="string">'wsrep_flow_control_paused'</span>,<span class="string">'wsrep_cert_deps_distance'</span>,<span class="string">'wsrep_flow_control_sent'</span>,<span class="string">'wsrep_local_recv_queue_avg'</span>);</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+----------------------------+-------+</span><br><span class="line">| Variable_name              | Value |</span><br><span class="line">+----------------------------+-------+</span><br><span class="line">| wsrep_cert_deps_distance   | 1     |</span><br><span class="line">| wsrep_flow_control_paused  | 0     |</span><br><span class="line">| wsrep_flow_control_sent    | 0     |</span><br><span class="line">| wsrep_local_recv_queue_avg | 0     |</span><br><span class="line">+----------------------------+-------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></tbody></table></figure><table><thead><tr><th>指标</th><th>说明</th></tr></thead><tbody><tr><td><code>wsrep_flow_control_paused</code></td><td>表示数据复制停止了多长时间（即因 Slave 延迟而慢的程度，取值范围为 0 ~ 1，越靠近 0 越好，值为 1 表示数据复制完全停止（停止广播），可优化 <code>wsrep_slave_threads</code> 的值来改善）。</td></tr><tr><td><code>wsrep_cert_deps_distance</code></td><td>表示有多少事务可以并行应用处理，<code>wsrep_slave_threads</code> 设置的值不应该高出该值太多。</td></tr><tr><td><code>wsrep_flow_control_sent</code></td><td>表示该节点已经停止复制了多少次。</td></tr><tr><td><code>wsrep_local_recv_queue_avg</code></td><td>表示 Slave 事务队列的平均长度，可作为 Slave 瓶颈的预兆。</td></tr></tbody></table><h2 id="Haproxy-Keepalived-双机热备"><a href="#Haproxy-Keepalived-双机热备" class="headerlink" title="Haproxy + Keepalived 双机热备"></a>Haproxy + Keepalived 双机热备</h2><p>在本节中，将使用 Haproxy + Keepalived 实现双机热备方案，其中 Haproxy 负责将请求转发给 PXC 集群各个节点。值得一提的，Haproxy 与 Keepalived 的部署规划如下表所示：</p><table><thead><tr><th>节点名称</th><th>主机名</th><th> IP</th><th> 系统</th><th>说明</th></tr></thead><tbody><tr><td> Haproxy 节点一</td><td> haproxy-node-1</td><td>192.168.1.235</td><td>Debian 11 (Bullseye)</td><td>Haproxy + Keepalived</td></tr><tr><td>Haproxy 节点二</td><td> haproxy-node-2</td><td>192.168.1.239</td><td>Debian 11 (Bullseye)</td><td>Haproxy + Keepalived</td></tr></tbody></table><h3 id="双机热备架构"><a href="#双机热备架构" class="headerlink" title="双机热备架构"></a>双机热备架构</h3><p><img data-src="../../../asset/2023/10/mysql-pxc8-6.png"></p><h3 id="创建数据库用户"><a href="#创建数据库用户" class="headerlink" title="创建数据库用户"></a>创建数据库用户</h3><p>在本节中，将创建 MySQL 用户，Haproxy 后续会使用这个用户对 PXC 集群节点进行心跳检测。</p><ul><li>登录任意一个 PXC 集群节点的数据库</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录MySQL</span></span><br><span class="line">sudo mysql -h localhost -u root -p</span><br></pre></td></tr></tbody></table></figure><ul><li>创建数据库用户 <code>haproxy</code>，不指定密码和权限，只允许远程访问</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建用户</span></span><br><span class="line">CREATE USER <span class="string">'haproxy'</span>@<span class="string">'%'</span> IDENTIFIED WITH mysql_native_password;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 刷新权限信息</span></span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看用户列表</span></span><br><span class="line">SELECT host, user, plugin, authentication_string FROM mysql.user;</span><br></pre></td></tr></tbody></table></figure><div class="admonition warning"><p class="admonition-title">特别注意</p><p>MySQL 8.0 默认使用的加密规则是 <code>caching_sha2_password</code>，为了让 Haproxy 可以对 PXC 集群节点进行心跳检测，在创建数据库用户时，必须指定加密规则为 <code>mysql_native_password</code>，否则 Haproxy 无法正常检测 PXC 集群节点的运行状态。</p></div><h3 id="Haproxy-安装"><a href="#Haproxy-安装" class="headerlink" title="Haproxy 安装"></a>Haproxy 安装</h3><p>在本节中，将在两个单独的服务器节点上分别安装 Haproxy 服务（两个节点的安装步骤和配置内容基本一致），实现对 PXC 集群的负载均衡。</p><ul><li>安装 Haproxy</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">sudo apt-get install -y haproxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机自启动</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> haproxy</span><br></pre></td></tr></tbody></table></figure><ul><li>配置 Haproxy</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份Haproxy的配置文件</span></span><br><span class="line">sudo cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑Haproxy的配置文件，添加以下内容</span></span><br><span class="line">sudo vim /etc/haproxy/haproxy.cfg</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">    # 工作目录</span><br><span class="line">    # chroot /usr/local/etc/haproxy</span><br><span class="line">    # 日志文件，使用rsyslog服务中local5日志设备（/var/log/local5），等级info</span><br><span class="line">    log 127.0.0.1 local5 info</span><br><span class="line">    # 以守护进程运行</span><br><span class="line">    daemon</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    log    global</span><br><span class="line">    mode    http</span><br><span class="line">    # 日志格式</span><br><span class="line">    option    httplog</span><br><span class="line">    # 日志中不记录负载均衡的心跳检测记录</span><br><span class="line">    option    dontlognull</span><br><span class="line">    # 连接超时（毫秒）</span><br><span class="line">    timeout connect 5000</span><br><span class="line">    # 客户端超时（毫秒）</span><br><span class="line">    timeout client  50000</span><br><span class="line">    # 服务器超时（毫秒）</span><br><span class="line">    timeout server  50000</span><br><span class="line"></span><br><span class="line"># 监控界面    </span><br><span class="line">listen  admin_stats</span><br><span class="line">    # 监控界面的访问的IP和端口</span><br><span class="line">    bind  0.0.0.0:8888</span><br><span class="line">    # 访问协议</span><br><span class="line">    mode        http</span><br><span class="line">    # URI相对地址</span><br><span class="line">    stats uri   /dbs</span><br><span class="line">    # 统计报告格式</span><br><span class="line">    stats realm     Global\ statistics</span><br><span class="line">    # 登陆账户信息</span><br><span class="line">    stats auth  admin:admin</span><br><span class="line"># 数据库负载均衡</span><br><span class="line">listen  proxy-pxc</span><br><span class="line">    # 访问的IP和端口</span><br><span class="line">    bind  0.0.0.0:3306</span><br><span class="line">    # 网络协议</span><br><span class="line">    mode  tcp</span><br><span class="line">    # 负载均衡算法（轮询算法）</span><br><span class="line">    # 轮询算法：roundrobin</span><br><span class="line">    # 权重算法：static-rr</span><br><span class="line">    # 最少连接算法：leastconn</span><br><span class="line">    # 请求源IP算法：source </span><br><span class="line">    balance  roundrobin</span><br><span class="line">    # 日志格式</span><br><span class="line">    option  tcplog</span><br><span class="line">    # Haproxy使用MySQL的haproxy账户对数据库进行心跳检测</span><br><span class="line">    option  mysql-check user haproxy</span><br><span class="line">    server  PXC_Node_1 192.168.1.188:3306 check weight 1 maxconn 2000  </span><br><span class="line">    server  PXC_Node_2 192.168.1.193:3306 check weight 1 maxconn 2000  </span><br><span class="line">    server  PXC_Node_3 192.168.1.223:3306 check weight 1 maxconn 2000 </span><br><span class="line">    # 使用Keepalived检测死链</span><br><span class="line">    option  tcpka</span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">Haproxy 配置说明</p><ul><li><code>bind 0.0.0.0:8888</code>： <code>8888</code> 端口用于 Haproxy 提供监控界面的 Web 服务。</li><li><code>bind 0.0.0.0:3306</code>： <code>3306</code> 端口用于 Haproxy 转发请求给 PXC 集群节点。</li><li><code>option mysql-check user haproxy</code>： 指定 Haproxy 使用 MySQL 的 <code>haproxy</code> 账户对 PXC 集群节点进行心跳检测。</li></ul></div><ul><li>重启 Haproxy</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重启</span></span><br><span class="line">sudo systemctl restart haproxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看运行状态</span></span><br><span class="line">sudo systemctl status haproxy</span><br></pre></td></tr></tbody></table></figure><ul><li>测试 Haproxy</li></ul><p>使用浏览器访问不同节点的 Haproxy 监控页面（如下图所示），登录用户名是 <code>admin</code>，登录密码是 <code>admin</code>。如果可以正常访问 Haproxy 的监控界面，则说明 Haproxy 成功部署。</p><ul><li>Haproxy 节点一的监控页面： <code>http://192.168.1.235:8888/dbs</code></li><li>Haproxy 节点二的监控页面： <code>http://192.168.1.239:8888/dbs</code></li></ul><p><img data-src="../../../asset/2023/10/docker-mysql-pxc-6.png"></p><h3 id="Keepalived-安装"><a href="#Keepalived-安装" class="headerlink" title="Keepalived 安装"></a>Keepalived 安装</h3><p>在本节中，将在两个单独的 Haproxy 服务器节点上分别安装 Keepalived 服务，实现 Haproxy + Keepalived 的双机热备方案。</p><div class="admonition note"><p class="admonition-title">提示</p><p>Keepalived 安装完成后，默认会将配置模板文件存放在 <code>/usr/share/doc/keepalived/samples/</code> 目录下。</p></div><h4 id="Haproxy-节点一安装-Keepalived"><a href="#Haproxy-节点一安装-Keepalived" class="headerlink" title="Haproxy 节点一安装 Keepalived"></a>Haproxy 节点一安装 Keepalived</h4><ul><li>安装 Keepalived</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">sudo apt-get install -y keepalived</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机自启动</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> keepalived</span><br></pre></td></tr></tbody></table></figure><ul><li>配置 Keepalived</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建或编辑Keepalived的配置文件，写入以下配置内容（请自行更改网卡设备参数）</span></span><br><span class="line">sudo vim /etc/keepalived/keepalived.conf</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance  VI_1 {</span><br><span class="line">    state  MASTER           # 必填，Keepalived 的身份（MASTER 是主服务器，BACKUP 是备服务器）</span><br><span class="line">    interface  enp0s3       # 必填，系统的网卡设备，虚拟 IP 所在</span><br><span class="line">    virtual_router_id  51   # 必填，虚拟路由标识，取值在0-255之间，用来区分多个Instance的VRRP组播，同一网段内ID不能重复，主备机器的该值必须为一样</span><br><span class="line">    priority  100           # 必填，用来选举Master的，MASTER 权重要高于 BACKUP，数字越大优先级越高，该项取值范围是1-255（在此范围之外会被识别成默认值100）</span><br><span class="line">    advert_int  1           # 必填，MASTER 和 BACKUP 节点同步检查的时间间隔（单位为秒），主备之间必须一致，可以认为是健康检查的时间间隔</span><br><span class="line">    authentication {        # 必填，主备服务器的验证方式，主备之间必须使用相同的密码才能正常通信</span><br><span class="line">        auth_type  PASS     # 必填，主备服务器的认证方式，其中有两种方式PASS和HA（IPSEC），推荐使用PASS（密码只识别前8位），主备之间必须使用相同的密码才能正常通信</span><br><span class="line">        auth_pass  123456</span><br><span class="line">    }</span><br><span class="line">    virtual_ipaddress {     # 必填，虚拟 IP，可以设置多个虚拟 IP 地址，每行一个</span><br><span class="line">        192.168.1.173</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>启动 Keepalived</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">sudo systemctl start keepalived</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看运行状态</span></span><br><span class="line">sudo systemctl status keepalived</span><br></pre></td></tr></tbody></table></figure><h4 id="Haproxy-节点二安装-Keepalived"><a href="#Haproxy-节点二安装-Keepalived" class="headerlink" title="Haproxy 节点二安装 Keepalived"></a>Haproxy 节点二安装 Keepalived</h4><ul><li>安装 Keepalived</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">sudo apt-get install -y keepalived</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机自启动</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> keepalived</span><br></pre></td></tr></tbody></table></figure><ul><li>配置 Keepalived</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建或编辑Keepalived的配置文件，写入以下配置内容（请自行更改网卡设备参数）</span></span><br><span class="line">sudo vim /etc/keepalived/keepalived.conf</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance  VI_1 {</span><br><span class="line">    state  BACKUP           # 必填，Keepalived 的身份（MASTER 是主服务器，BACKUP 是备服务器）</span><br><span class="line">    interface  enp0s3       # 必填，系统的网卡设备，虚拟 IP 所在</span><br><span class="line">    virtual_router_id  51   # 必填，虚拟路由标识，取值在0-255之间，用来区分多个Instance的VRRP组播，同一网段内ID不能重复，主备机器的该值必须为一样</span><br><span class="line">    priority  90            # 必填，用来选举Master的，MASTER 权重要高于 BACKUP，数字越大优先级越高，该项取值范围是1-255（在此范围之外会被识别成默认值100）</span><br><span class="line">    advert_int  1           # 必填，MASTER 和 BACKUP 节点同步检查的时间间隔（单位为秒），主备之间必须一致，可以认为是健康检查的时间间隔</span><br><span class="line">    authentication {        # 必填，主备服务器的验证方式，主备之间必须使用相同的密码才能正常通信</span><br><span class="line">        auth_type  PASS     # 必填，主备服务器的认证方式，其中有两种方式PASS和HA（IPSEC），推荐使用PASS（密码只识别前8位），主备之间必须使用相同的密码才能正常通信</span><br><span class="line">        auth_pass  123456</span><br><span class="line">    }</span><br><span class="line">    virtual_ipaddress {     # 必填，虚拟 IP，可以设置多个虚拟 IP 地址，每行一个</span><br><span class="line">        192.168.1.173</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>启动 Keepalived</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">sudo systemctl start keepalived</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看运行状态</span></span><br><span class="line">sudo systemctl status keepalived</span><br></pre></td></tr></tbody></table></figure><h3 id="双机热备方案测试"><a href="#双机热备方案测试" class="headerlink" title="双机热备方案测试"></a>双机热备方案测试</h3><ul><li>在其他电脑上，如果可以通过虚拟 IP <code>192.168.1.173</code> 正常访问 Haproxy 的 <code>8888</code> 与 <code>3306</code> 端口，则说明 PXC + Haproxy + Keepalived 的高可用集群搭建成功。</li></ul><table><thead><tr><th>测试内容</th><th>虚拟 IP</th><th> 端口</th><th>测试命令</th></tr></thead><tbody><tr><td> Haproxy 的监控页面</td><td> 192.168.1.173</td><td>8888</td><td><code>curl -basic -u admin:admin -I http://192.168.1.173:8888/dbs</code></td></tr><tr><td>Haproxy 的 MySQL 负载均衡</td><td> 192.168.1.173</td><td>3306</td><td><code>mysql -h 192.168.1.173 -u uatOption -P 3306 -p</code></td></tr></tbody></table><ul><li>通过 SSH 分别登录进两台 Haproxy 服务器，检查两个 Keepalived 节点之间是否可以正常进行心跳通信。如果不能进行心跳通信，则会发生脑裂现象（即两个 Keepalived 节点会同时抢占到虚拟 IP）。</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看IP地址</span></span><br><span class="line">ip addr</span><br></pre></td></tr></tbody></table></figure><ul><li>关闭 Haproxy 节点一服务器上的 Keepalived 服务，然后在其他电脑上，打开浏览器访问 <code>http://192.168.1.173:8888/dbs</code>。如果可以正常访问 Haproxy 的监控页面，则说明 Haproxy + Keepalived 的双机热备方案生效了。</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭Keepalived服务</span></span><br><span class="line">sudo systemctl stop keepalived</span><br></pre></td></tr></tbody></table></figure><ul><li>在 Haproxy 节点一服务器上的 Keepalived 服务关闭之后，通过 SSH 登录进 Haproxy 节点二服务器，使用 <code>ip addr</code> 命令查看 IP 地址，可以观察到 Haproxy 节点二服务器已经抢占到虚拟 IP。</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看IP地址</span></span><br><span class="line">ip addr</span><br></pre></td></tr></tbody></table></figure><h3 id="双机热备方案完善"><a href="#双机热备方案完善" class="headerlink" title="双机热备方案完善"></a>双机热备方案完善</h3><p>第一个问题：上述两个 Haproxy 服务器内的 Keepalived 服务，彼此仅仅是基于心跳检测来实现双机热备（故障切换）。如果第一个 Haproxy 服务器内的 Keepalived 服务（Master）正常运行，而 Haproxy 自身运行异常，那么将会出现 Haproxy 负载均衡服务失效，无法切换到备用的 Haproxy 负载均衡器上，最终导致后端的 Web 服务无法收到响应。所以，<strong>应该是要基于 Shell 脚本每隔一段时间检测 Haproxy 服务是否正常运行，而不是仅仅依靠 Keepalived 主备节点之间的心跳检测。</strong>比如，当检测到 Haproxy 服务不是正常运行，首先尝试启动 Haproxy 服务；若 Haproxy 服务重启失败，就应该关闭掉该节点上的 Keepalived 服务，并发送报警邮件，这样才能自动切换到 Keepalived 服务的 Backup 节点上。详细的解决方案建议参考 <a href="/posts/503c34e4.html#Keepalived-%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE">这里</a> 的教程。</p><hr><div class="admonition note"><p class="admonition-title">扩展阅读</p><ul><li><a target="_blank" rel="external nofollow" href="https://www.cnblogs.com/f-ck-need-u/p/9370579.html">Haproxy 代理 MySQL 要考虑的问题</a></li></ul></div><p>第二个问题：Haproxy 代理 MySQL 的时候，事务持久性的问题必须解决。这个事务持久性不是 ACID 的 D（持久性，Durability），而是 Transaction Persistent，这里简单描述一下此处的事务持久性。</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">start transaction</span><br><span class="line">update1...</span><br><span class="line">update2...</span><br><span class="line">insert3...</span><br><span class="line">commit</span><br></pre></td></tr></tbody></table></figure><p>当客户端显式开启一个事务，然后执行上述几个数据库操作，然后提交或回滚。如果使用代理软件（如 Haproxy）对 MySQL 进行代理，必须要保证这 5 个语句全都路由到同一个 MySQL 节点上，即使后端的 MySQL 采用的是多主模型（MGR、Galera 都提供多主模型），否则事务中各语句分散，轻则返回失败，重则数据不一致、提交混乱。这就是 Transaction Persistent 的概念，即让同一个事务路由到同一个后端节点。Haproxy 如何保证事务持久性呢？对于非 MySQL 协议感知的代理（LVS、Nginx、Haproxy 等），要保证事务持久性，只能通过间接的方法实现，比较通用的方法是在代理软件上监听不同的端口（实现读写分离）。具体的思路如下：</p><ul><li>1）在 Haproxy 上监听不同端口，例如 <code>3307</code> 端口的请求作为写端口，<code>3306</code> 端口的请求作为读端口。</li><li>2）从后端 MySQL 节点中选一个节点 (只能是一个) 作为逻辑写节点，Haproxy 将 <code>3307</code> 端口的请求全都路由给这个节点。</li><li>3）可以在 Haproxy 上配置多个备用写节点 (Backup)，但 <code>3307</code> 端口在某一时刻，路由到的必须只能有一个写节点。</li></ul><p>这样能保证事务的持久性，也能解决一些乐观锁问题。但是，如果后端是多主模型的 MGR（组复制）或 Galera，这样的代理方式将强制变为单主模型，虽然是逻辑上的强制。当然，这并非什么问题，至少到目前为止的开源技术，都建议采用单主模型。Haproxy 保证事务持久性的配置示例如下：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">listen  haproxy_3306_read_multi</span><br><span class="line">        bind *:3306</span><br><span class="line">        mode tcp</span><br><span class="line">        timeout client  10800s</span><br><span class="line">        timeout server  10800s</span><br><span class="line">        balance leastconn</span><br><span class="line">        option httpchk</span><br><span class="line">        option allbackups</span><br><span class="line">        default-server port 9200 inter 2s downinter 5s rise 3 fall 2 slowstart 60s maxconn 64 maxqueue 128 weight 100</span><br><span class="line">        server galera1 192.168.55.111:3306 check</span><br><span class="line">        server galera2 192.168.55.112:3306 check</span><br><span class="line">        server galera3 192.168.55.113:3306 check</span><br><span class="line"> </span><br><span class="line">listen  haproxy_3307_write_single</span><br><span class="line">        bind *:3307</span><br><span class="line">        mode tcp</span><br><span class="line">        timeout client  10800s</span><br><span class="line">        timeout server  10800s</span><br><span class="line">        balance leastconn</span><br><span class="line">        option httpchk</span><br><span class="line">        option allbackups</span><br><span class="line">        default-server port 9200 inter 2s downinter 5s rise 3 fall 2 slowstart 60s maxconn 64 maxqueue 128 weight 100</span><br><span class="line">        server galera1 192.168.55.111:3306 check</span><br><span class="line">        server galera2 192.168.55.112:3306 check backup</span><br><span class="line">        server galera3 192.168.55.113:3306 check backup</span><br></pre></td></tr></tbody></table></figure><p>上面的配置通过 <code>3306</code> 端口和 <code>3307</code> 端口进行读写分离，并且在负责写的 <code>3307</code> 端口中只有一个节点可写，其余两个节点作为 Backup 节点。对于 MySQL 的负载来说，更建议采用 MySQL 协议感知的程序来实现，例如 MySQL Router、ProxySql，MaxScale、MyCat 等数据库中间件。</p><h2 id="PXC-集群运维"><a href="#PXC-集群运维" class="headerlink" title="PXC 集群运维"></a>PXC 集群运维</h2><h3 id="查看错误日志"><a href="#查看错误日志" class="headerlink" title="查看错误日志"></a>查看错误日志</h3><p>PXC 集群使用的是 Percona Server 数据库，它是 MySQL 的衍生版本，因此 PXC 集群节点的很多操作跟 MySQL 一样，其错误日志信息存放在每个节点的 <code>/var/log/mysql/error.log</code> 文件里面。</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看错误日志文件</span></span><br><span class="line">sudo vi /var/<span class="built_in">log</span>/mysql/error.log</span><br></pre></td></tr></tbody></table></figure><h3 id="正确关闭集群"><a href="#正确关闭集群" class="headerlink" title="正确关闭集群"></a>正确关闭集群</h3><p>如果第一个节点（负责集群初始化）不是最后一个离开集群的，那么它在一般情况下就不能再以第一个节点的形式启动了。这是因为从这个节点引导集群启动可能是不安全的，即这个节点可能不包含所有更新的数据。<strong>综上所述，PXC 集群节点的正确关闭顺序，应该与它们的启动顺序相反（类似栈结构 - 先进后出），即最先启动的节点应该最后关闭。</strong></p><ul><li>启动集群</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动第一个节点</span></span><br><span class="line">sudo systemctl start mysql@bootstrap.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动第二个节点（必须等待第一个节点启动完成再启动）</span></span><br><span class="line">sudo systemctl start mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动第三个节点（必须等待第一个节点启动完成再启动）</span></span><br><span class="line">sudo systemctl start mysql</span><br></pre></td></tr></tbody></table></figure><ul><li>关闭集群</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭第三个节点</span></span><br><span class="line">sudo systemctl stop mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭第二个节点</span></span><br><span class="line">sudo systemctl stop mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭第一个节点</span></span><br><span class="line">sudo systemctl stop mysql@bootstrap.service</span><br></pre></td></tr></tbody></table></figure><h3 id="节点动态下线"><a href="#节点动态下线" class="headerlink" title="节点动态下线"></a>节点动态下线</h3><p>PXC 集群允许动态下线节点，但需要注意的是节点的启动命令和关闭命令必须一致；比如使用 <code>mysql@bootstrap.service</code> 服务启动的第一个节点服务器（负责集群初始化），在它关闭时也必须使用 <code>mysql@bootstrap.service</code> 服务来操作（<strong>该结论有待验证</strong>）。</p><ul><li>第一个节点上下线</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第一个节点下线</span></span><br><span class="line">sudo systemctl stop mysql@bootstrap.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一个节点上线</span></span><br><span class="line">sudo systemctl start mysql@bootstrap.service</span><br></pre></td></tr></tbody></table></figure><ul><li>其他节点上下线</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 其他节点下线</span></span><br><span class="line">sudo service stop mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他节点上线</span></span><br><span class="line">sudo service start mysql</span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">提示</p><p>由于 PXC 集群的所有节点都是对等的，所以下线第一个节点和下线其他节点在效果上都是相同的。</p></div><h3 id="单节点的操作系统重启"><a href="#单节点的操作系统重启" class="headerlink" title="单节点的操作系统重启"></a>单节点的操作系统重启</h3><p><strong>特别注意，当 PXC 集群中某个节点所在的 Debian 系统重启后，PXC 会自动将该节点的 MySQL 服务从集群中剔除（因为节点不可用了），以此保证高可用，但该节点的 MySQL 服务后续是不会自动启动的。</strong>也就是说，等 Debian 系统重启完成后，必须手动启动该节点上的 MySQL 服务。此时只要确保 PXC 集群中至少有一个节点存活着，那么就不需要再重新初始化 PXC 集群（引导 PXC 集群启动），因此无论等待重启的节点是第一个节点（负责集群初始化），还是其他节点，都可以直接使用 <code>mysql</code> 服务进行启动。</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重启意外关闭的节点</span></span><br><span class="line">sudo service start mysql</span><br></pre></td></tr></tbody></table></figure><h3 id="集群断电重启，第一个节点启动失败"><a href="#集群断电重启，第一个节点启动失败" class="headerlink" title="集群断电重启，第一个节点启动失败"></a>集群断电重启，第一个节点启动失败</h3><ul><li>PXC 集群的三台节点服务器都突然断电重启了（即所有集群节点几乎都在同一时刻意外关闭），等服务器上的 Debian 系统相继重新启动完成后，无法使用以下命令正常启动第一个节点服务器（负责集群初始化）上的 MySQL 服务</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动第一个节点</span></span><br><span class="line">sudo systemctl start mysql@bootstrap.service</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第一个节点启动的错误信息</span></span><br><span class="line">systemctl start mysql@bootstrap.service Job <span class="keyword">for</span> mysql@bootstrap.service failed because the control process exited with error code. See <span class="string">"systemctl status mysql@bootstrap.service"</span> and <span class="string">"journalctl -xe"</span> <span class="keyword">for</span> details.</span><br></pre></td></tr></tbody></table></figure><ul><li>首先使用以下几种方式，查看 MySQL 的日志信息</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看系统日志信息</span></span><br><span class="line">journalctl -xe</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看MySQL的错误日志文件</span></span><br><span class="line">sudo vi /var/<span class="built_in">log</span>/mysql/error.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看MySQL的运行状态信息</span></span><br><span class="line">sudo systemctl status mysql@bootstrap.service</span><br></pre></td></tr></tbody></table></figure><ul><li>进一步在 MySQL 的错误日志文件中，发现了以下错误内容（留意 ERROR 部分）</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">2023-10-26T22:13:35.822653Z 0 [Note] [MY-000000] [Galera] ####### Assign initial position for certification: e4bb8bf0-73d5-11ee-b279-3a5ebcc11ef7:29, protocol version: -1</span><br><span class="line">2023-10-26T22:13:35.822752Z 0 [Note] [MY-000000] [WSREP] Starting replication</span><br><span class="line">2023-10-26T22:13:35.822790Z 0 [Note] [MY-000000] [Galera] Connecting with bootstrap option: 1</span><br><span class="line">2023-10-26T22:13:35.822809Z 0 [Note] [MY-000000] [Galera] Setting GCS initial position to e4bb8bf0-73d5-11ee-b279-3a5ebcc11ef7:29</span><br><span class="line">2023-10-26T22:13:35.822823Z 0 [ERROR] [MY-000000] [Galera] It may not be safe to bootstrap the cluster from this node. It was not the last one to leave the cluster and may not contain all the updates. To force cluster bootstrap with this node, edit the grastate.dat file manually and set safe_to_bootstrap to 1 .</span><br><span class="line">2023-10-26T22:13:35.822844Z 0 [ERROR] [MY-000000] [WSREP] Provider/Node (gcomm://192.168.1.188,192.168.1.193,192.168.1.223) failed to establish connection with cluster (reason: 7)</span><br><span class="line">2023-10-26T22:13:35.822855Z 0 [ERROR] [MY-010119] [Server] Aborting</span><br><span class="line">2023-10-26T22:13:35.823148Z 0 [System] [MY-010910] [Server] /usr/sbin/mysqld: Shutdown complete (mysqld 8.0.33-25.1)  Percona XtraDB Cluster (GPL), Release rel25, Revision 0c56202, WSREP version 26.1.4.3.</span><br><span class="line">2023-10-26T22:13:35.824298Z 0 [ERROR] [MY-010065] [Server] Failed to shutdown components infrastructure.</span><br></pre></td></tr></tbody></table></figure><p>意思是从这个节点引导集群启动可能是不安全。由于该节点不是最后一个离开集群的节点（最后停掉的节点），可能不包含所有更新的数据。要强制使用该节点进行集群引导，请手动编辑该节点的 <code>grastate.dat</code> 文件，并将 <code>safe_to_bootstrap</code> 参数设置为 <code>1</code>。当然了，一般情况下不需要强制从该节点启动，可以逐一排查每个节点下的 <code>grastate.dat</code> 文件，找到 <code>safe_to_bootstrap=1</code> 的节点，然后在该节点上引导 PXC 集群启动即可。如果所有节点的 <code>safe_to_bootstrap</code> 都为 <code>0</code>，那么只能任意选择一个节点，更改该节点下的 <code>grastate.dat</code> 文件，将 <code>safe_to_bootstrap</code> 设置为 <code>1</code>，然后在该节点上引导 PXC 集群启动。<strong>特别注意，引导 PXC 集群启动（第一个节点）使用的是 <code>sudo systemctl start mysql@bootstrap.service</code> 命令，而启动其他节点使用的则是 <code>sudo systemctl start mysql</code> 命令。必须等待第一个节点启动成功，也就是 PXC 集群初始化完成之后，才能接着启动其他节点，最后再检查集群的数据是否可以正常同步。</strong></p><div class="admonition note"><p class="admonition-title">提示</p><ul><li><code>grastate.dat</code> 文件的完整路径是 <code>/var/lib/mysql/grastate.dat</code>。</li><li>在第一个节点服务器上引导 PXC 集群启动（即集群初始化）的命令是 <code>sudo systemctl start mysql@bootstrap.service</code>，其他节点的 MySQL 服务启动命令则是 <code>sudo systemctl start mysql</code>。</li></ul></div><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a target="_blank" rel="external nofollow" href="http://www.jiangguo.net/c/mog/1w2.html">CentOS 搭建 PXC 5.7 集群</a></li><li><a target="_blank" rel="external nofollow" href="https://www.cnblogs.com/f-ck-need-u/p/9370579.html">Haproxy 代理 MySQL 要考虑的问题</a></li><li><a target="_blank" rel="external nofollow" href="https://docs.morpheusdata.com/en/5.5.1/getting_started/installation/distributed/full/perconaTls-ubuntu.html">Debian/Ubuntu Percona XtraDB Cluster with TLS</a></li><li><a target="_blank" rel="external nofollow" href="https://www.howtoforge.com/how-to-install-percona-xtradb-cluster-on-debian-11/">How to Install Percona XtraDB Cluster on Debian 11</a></li><li><a target="_blank" rel="external nofollow" href="http://blog.itpub.net/30310891/viewspace-2772587/">基于 Centos 7 部署 Percona Xtradb Cluster 5.7 高可用架构</a></li></ul><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/ff0f2d6.html" title="Debian 11 生产环境部署 PXC 8.0 集群">https://www.techgrow.cn/posts/ff0f2d6.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/Debian/" rel="tag"><i class="fa fa-tag"></i> Debian</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/8dc5e7ed.html" rel="prev" title="Docker 部署 PXC 8.0 单机集群"><i class="fa fa-angle-left"></i> Docker 部署 PXC 8.0 单机集群</a></div><div class="post-nav-item"> <a href="/posts/a6c59612.html" rel="next" title="Debian 12 编译安装 Erlang 23.2">Debian 12 编译安装 Erlang 23.2<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">1.6m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">24:28</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤 ICP 备 19024664 号</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035 号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"/lib/mermaid/dist/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/app/api/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/app/api/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/ff0f2d6.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>