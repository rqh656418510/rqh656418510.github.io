<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍 Kubernetes 的入门使用教程。"><meta property="og:type" content="article"><meta property="og:title" content="Kubernetes 入门教程之十"><meta property="og:url" content="https://www.techgrow.cn/posts/6158b4d2.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍 Kubernetes 的入门使用教程。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/11/k8s-grafana-0.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/11/k8s-grafana-0.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/11/k8s-grafana-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/11/k8s-grafana-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/11/k8s-grafana-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/11/k8s-grafana-4.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/11/k8s-grafana-5.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/11/k8s-grafana-6.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/11/k8s-cicd-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/11/k8s-cicd-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/11/k8s-cicd-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/11/k8s-cicd-6.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/11/k8s-cicd-5.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/11/k8s-cicd-4.png"><meta property="article:published_time" content="2025-09-13T13:12:19.000Z"><meta property="article:modified_time" content="2025-09-13T13:12:19.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="容器化"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2025/11/k8s-grafana-0.png"><link rel="canonical" href="https://www.techgrow.cn/posts/6158b4d2.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/6158b4d2.html","path":"posts/6158b4d2.html","title":"Kubernetes 入门教程之十"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Kubernetes 入门教程之十 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kubernetes-%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF"><span class="nav-text">Kubernetes 核心技术</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E9%9B%86%E7%BE%A4%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0"><span class="nav-text">部署集群性能监控平台</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E5%8F%AF%E7%9B%91%E6%8E%A7%E7%9A%84%E6%8C%87%E6%A0%87"><span class="nav-text">集群可监控的指标</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88"><span class="nav-text">集群性能监控方案</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E9%83%A8%E7%BD%B2"><span class="nav-text">性能监控平台部署</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="nav-text">版本说明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-text">准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F"><span class="nav-text">拉取镜像</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-CoreDNS"><span class="nav-text">安装 CoreDNS</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-Ingress"><span class="nav-text">安装 Ingress</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E6%AD%A5%E9%AA%A4"><span class="nav-text">部署步骤</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Prometheus-%E9%83%A8%E7%BD%B2"><span class="nav-text">Prometheus 部署</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Grafana-%E9%83%A8%E7%BD%B2"><span class="nav-text">Grafana 部署</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%AF%B9%E5%A4%96%E6%9A%B4%E9%9C%B2%E8%8A%82%E7%82%B9"><span class="nav-text">对外暴露节点</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E6%AD%A5%E9%AA%A4"><span class="nav-text">验证步骤</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E9%80%9A%E8%BF%87-Service-%E8%AE%BF%E9%97%AE-Grafana"><span class="nav-text">通过 Service 访问 Grafana</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E9%80%9A%E8%BF%87-Ingress-%E8%AE%BF%E9%97%AE-Grafana"><span class="nav-text">通过 Ingress 访问 Grafana</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Grafana-%E5%B1%95%E7%A4%BA%E7%9B%91%E6%8E%A7%E6%95%B0%E6%8D%AE%E5%9B%BE%E8%A1%A8"><span class="nav-text">Grafana 展示监控数据图表</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E6%88%98%E9%83%A8%E7%BD%B2-Java-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="nav-text">实战部署 Java 应用程序</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E4%BA%A4%E4%BB%98%E7%9A%84%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B"><span class="nav-text">容器交付的完整流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-Java-%E5%BA%94%E7%94%A8%E7%9A%84%E9%95%9C%E5%83%8F"><span class="nav-text">创建 Java 应用的镜像</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%B6%E4%BD%9C-Java-%E5%BA%94%E7%94%A8%E7%9A%84%E9%95%9C%E5%83%8F"><span class="nav-text">制作 Java 应用的镜像</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8E%A8%E9%80%81-Java-%E5%BA%94%E7%94%A8%E7%9A%84%E9%95%9C%E5%83%8F"><span class="nav-text">推送 Java 应用的镜像</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-Java-%E5%BA%94%E7%94%A8%E7%9A%84%E9%95%9C%E5%83%8F"><span class="nav-text">部署 Java 应用的镜像</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A9%E5%AE%B9-%E7%BC%A9%E5%AE%B9-Java-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="nav-text">扩容 / 缩容 Java 应用程序</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%89%A9%E5%AE%B9-Java-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="nav-text">扩容 Java 应用程序</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BC%A9%E5%AE%B9-Java-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="nav-text">缩容 Java 应用程序</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%87%E7%BA%A7-%E5%9B%9E%E6%BB%9A-Java-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="nav-text">升级 / 回滚 Java 应用程序</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8D%87%E7%BA%A7-Java-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="nav-text">升级 Java 应用程序</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9B%9E%E6%BB%9A-Java-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="nav-text">回滚 Java 应用程序</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B9%B3%E6%BB%91%E9%87%8D%E5%90%AF-Java-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="nav-text">平滑重启 Java 应用程序</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%B9%B3%E6%BB%91%E9%87%8D%E5%90%AF"><span class="nav-text">什么是平滑重启</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%B9%B3%E6%BB%91%E9%87%8D%E5%90%AF%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-text">平滑重启的实现</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">759</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">54</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/6158b4d2.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Kubernetes 入门教程之十 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍 Kubernetes 的入门使用教程。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Kubernetes 入门教程之十</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2025-09-13 21:12:19" itemprop="dateCreated datePublished" datetime="2025-09-13T21:12:19+08:00">2025-09-13</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/6158b4d2.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/6158b4d2.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>7.5k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>7 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/99bf51b3.html">Kubernetes 入门教程之一</a>、<a href="/posts/c57e8370.html">Kubernetes 入门教程之二</a>、<a href="/posts/2722157d.html">Kubernetes 入门教程之三</a></li><li><a href="/posts/37a21b7b.html">Kubernetes 入门教程之四</a>、<a href="/posts/6bf07963.html">Kubernetes 入门教程之五</a>、<a href="/posts/76121b26.html">Kubernetes 入门教程之六</a></li><li><a href="/posts/2ca57d7f.html">Kubernetes 入门教程之七</a>、<a href="/posts/723af70c.html">Kubernetes 入门教程之八</a>、<a href="/posts/cfb1715d.html">Kubernetes 入门教程之九</a></li><li><a href="/posts/6158b4d2.html">Kubernetes 入门教程之十</a></li></ul><h2 id="Kubernetes-核心技术"><a href="#Kubernetes-核心技术" class="headerlink" title="Kubernetes 核心技术"></a>Kubernetes 核心技术</h2><h3 id="部署集群性能监控平台"><a href="#部署集群性能监控平台" class="headerlink" title="部署集群性能监控平台"></a>部署集群性能监控平台</h3><p>开源软件 cAdvisor（Container Advisor）可用于监控所在节点的容器运行状态，当前已经被默认集成到 Kubernetes 的 Kubelet 组件内，默认使用 TCP <code>4194</code> 端口。在中小型规模容器集群中，通常使用 Prometheus + Grafana 来实现容器集群性能数据的采集、存储与展示。</p><h4 id="集群可监控的指标"><a href="#集群可监控的指标" class="headerlink" title="集群可监控的指标"></a>集群可监控的指标</h4><p>在 Kubernetes 集群中，可以监控的指标有以下这些：</p><ul><li><p>节点级（Node Metrics）：监控每个工作节点（Worker Node）的系统资源使用情况</p><ul><li>CPU 使用率 / 空闲率 / 负载（Load Average）</li><li>内存使用量 / 可用内存</li><li>磁盘使用量 / I/O 吞吐</li><li>网络流量（带宽、收发包量、错误包）</li><li>节点状态（Ready / NotReady）</li><li>节点文件系统使用率（根分区、容器存储路径）</li></ul></li><li><p>Pod / 容器级（Pod &amp; Container Metrics）：监控集群中每个 Pod 或容器的资源使用情况</p><ul><li>Pod 的 CPU 使用率 / 限额 / 请求</li><li> Pod 的内存使用量 / 限额 / 请求</li><li>容器重启次数</li><li>容器启动时间、运行时间</li><li>网络收发流量（in/out bytes）</li><li>文件系统使用（容器内存储卷）</li><li>容器状态（Running / Waiting / Terminated）</li></ul></li><li><p>Kubernetes 组件指标（Control Plane Metrics）：监控 K8s 控制面（Control Plane）自身的健康状态</p><ul><li>API Server 请求速率 / 延迟 / 错误率</li><li> Scheduler 调度延迟 / 排队任务数</li><li> Controller Manager 队列长度 / 事件处理速率</li><li> Etcd 存储延迟 / Leader 选举状态 / 写入吞吐</li></ul></li><li><p>服务与网络（Service &amp; Network Metrics）：监控 Service、Ingress、DNS、网络插件等组件</p><ul><li>Service 请求速率 / 成功率 / 延迟</li><li> Ingress 访问量 / 响应时间 / 4xx、5xx 错误率</li><li> DNS 查询速率 / 失败率（CoreDNS）</li><li>CNI 插件流量、丢包、延迟</li></ul></li><li><p>工作负载与资源对象状态（Workload Metrics）：反映 K8s 资源对象（如 Deployment、DaemonSet、Job 等）的运行健康度</p><ul><li>Deployment 可用副本数 / 期望副本数</li><li> ReplicaSet、StatefulSet 状态</li><li> Job 成功 / 失败次数</li><li> CronJob 最近执行时间</li><li> Namespace 级资源使用量</li><li> HPA（HorizontalPodAutoScaler）触发状态</li></ul></li><li><p>存储指标（Storage Metrics）：监控 PV、PVC、StorageClass 的使用与性能</p><ul><li>PV 容量使用率</li><li> PVC 绑定状态</li><li> I/O 延迟、读写吞吐</li><li>挂载错误 / 超时</li></ul></li><li><p>应用与业务指标（Application Metrics）: 通过 Prometheus Exporter 或 SDK 自定义的应用性能指标</p><ul><li>请求 QPS（请求数每秒）</li><li>错误率（Error Rate）</li><li>响应时间（Latency）</li><li>业务统计（订单数、任务完成数等）</li><li>自定义计数器 / 计时器 / 直方图（Histogram）</li></ul></li><li><p>告警与事件（Events &amp; Alerts）：用于监控异常行为与故障</p><ul><li>Pod CrashLoopBackOff</li><li> 节点不可用</li><li>资源超限（CPU / 内存）</li><li>Deployment 副本不足</li><li> PV 绑定失败 / 存储空间不足</li><li> API 请求超时 / 错误率过高</li></ul></li></ul><h4 id="集群性能监控方案"><a href="#集群性能监控方案" class="headerlink" title="集群性能监控方案"></a>集群性能监控方案</h4><blockquote><p>常见的 Kubernetes 集群性能监控方案</p></blockquote><ul><li><p>Heapster + InfluxDB + Grafana</p><ul><li>架构：Heapster + InfluxDB + Grafana</li><li> 功能：Heapster 汇聚各 Node 上 cAdvisor 的监控数据，存入 InfluxDB 后通过 Grafana 展示。</li><li>状态：已被 Kubernetes 官方弃用，自 Kubernetes <code>v1.13</code> 起不再维护。</li><li>适用场景：早期集群监控，仅作学习了解。</li></ul></li><li><p>Metrics Server</p><ul><li>角色：Heapster 的官方替代品。</li><li>功能：提供实时的资源用量指标（CPU、内存）给 <code>kubectl top</code>、Horizontal Pod Autoscaler（HPA）等使用。</li><li>限制：不存储历史数据，不提供可视化界面或持久化存储。</li><li>状态：Kubernetes 官方的核心组件。</li><li>适用场景：HPA 自动扩缩容、轻量实时监控。</li></ul></li><li><p>Prometheus + Grafana</p><ul><li>架构：Prometheus + Grafana</li><li> 功能：<ul><li>Prometheus = 数据收集 + 存储 + 告警。</li><li>Grafana = 数据展示 + 可视化分析界面。</li></ul></li><li>优点：<ul><li>Prometheus 会周期性自动拉取 kubelet、cAdvisor、kube-state-metrics、node-exporter 等监控指标</li><li>监控维度丰富（节点、容器、Pod、Service、集群状态）</li><li>数据查询灵活（PromQL）</li><li>支持历史数据存储</li></ul></li><li>状态：当前主流的开源监控方案。</li><li>适用场景：中小型或自建环境中的主力方案。</li></ul></li><li><p>Prometheus Operator + kube-prometheus-stack</p><ul><li>架构组件：<ul><li>Prometheus（采集与存储指标）</li><li>Alertmanager（告警）</li><li>Grafana（可视化）</li><li>kube-state-metrics（集群资源状态）</li><li>node-exporter（节点系统指标）</li></ul></li><li>特点：<ul><li>Operator 自动化管理 Prometheus、Alertmanager、Grafana 等部署与配置。</li><li>社区维护的 “kube-prometheus-stack” Helm Chart 是生产级推荐方案。</li></ul></li><li>状态：功能最全、生态最活跃。</li><li>适用场景：生产级集群的监控、告警、可视化一体化方案。</li></ul></li><li><p>Weave Scope / Weave Cloud</p><ul><li>功能：<ul><li>直观展示 Pod、容器、Service 之间的拓扑关系与状态。</li><li>支持查看部分性能指标（CPU、内存、网络流量）。</li></ul></li><li>定位：<ul><li>更偏向于可视化与运维调试工具。</li><li>不属于严格意义上的 “性能监控方案”。</li></ul></li><li>适用场景：<ul><li>集群拓扑观测、实时诊断、开发或测试环境。</li><li>可作为 Prometheus 或 Metrics Server 的补充。</li></ul></li></ul></li></ul><blockquote><p>不同 Kubernetes 集群性能监控方案的对比</p></blockquote><table><thead><tr><th>性能监控方案</th><th>类型</th><th>是否官方推荐</th><th>是否可替代 Heapster</th><th> 可视化展示</th><th>是否持久化存储</th></tr></thead><tbody><tr><td> Heapster + InfluxDB + Grafana</td><td> 旧版指标监控</td><td>❌ 已弃用</td><td>✔</td><td>✔</td><td>✔</td></tr><tr><td>Metrics Server</td><td> 资源指标采集</td><td>✔ 官方推荐</td><td>✔</td><td>❌</td><td>❌</td></tr><tr><td>Prometheus + Grafana</td><td> 指标监控</td><td>✔ 官方推荐</td><td>✔</td><td>✔</td><td>✔</td></tr><tr><td>Prometheus Operator Stack</td><td> 生产级集群监控告警平台</td><td>✔ 官方推荐</td><td>✔</td><td>✔</td><td>✔</td></tr><tr><td>Weave Scope / Weave Cloud</td><td> 拓扑与可视化</td><td>⚙️ 可选</td><td>❌</td><td>✔</td><td>部分</td></tr></tbody></table><h4 id="性能监控平台部署"><a href="#性能监控平台部署" class="headerlink" title="性能监控平台部署"></a>性能监控平台部署</h4><p>本节将基于 Prometheus + Grafana 搭建 Kubernetes 集群的性能监控平台。</p><h5 id="版本说明"><a href="#版本说明" class="headerlink" title="版本说明"></a>版本说明</h5><table><thead><tr><th>组件</th><th>版本</th></tr></thead><tbody><tr><td> Kubernetes</td><td><code>v1.19.10</code></td></tr><tr><td>Prometheus</td><td><code>v2.0.0</code></td></tr><tr><td>Grafana</td><td><code>v4.4.3</code></td></tr><tr><td>NodeExporter</td><td><code>v1.10.2</code></td></tr></tbody></table><h5 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h5><h6 id="拉取镜像"><a href="#拉取镜像" class="headerlink" title="拉取镜像"></a>拉取镜像</h6><p>在 Kubernetes 部署服务时，为了避免部署过程中出现镜像拉取超时（Image Pull Timeout）的问题，建议：</p><ul><li>提前将相关镜像预拉取到所有节点里面，确保部署时无需从远程仓库重新下载镜像；</li><li>或者搭建本地镜像仓库（比如 Harbor），提高镜像拉取的速度与可靠性。</li></ul><p>在 Kubernetes 集群的所有节点上（包括 Master 和 Worker），分别执行以下命令，提前将镜像拉取到本地</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拉取 Node Exporter 镜像</span></span><br><span class="line">docker pull prom/node-exporter:v1.10.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉取 Prometheus 镜像</span></span><br><span class="line">docker pull prom/prometheus:v2.0.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉取 Grafana 镜像</span></span><br><span class="line">docker pull grafana/grafana:4.2.0</span><br></pre></td></tr></tbody></table></figure><h6 id="安装-CoreDNS"><a href="#安装-CoreDNS" class="headerlink" title="安装 CoreDNS"></a>安装 CoreDNS</h6><ul><li><a href="/posts/ccd6f2d4.html#%E9%83%A8%E7%BD%B2-CoreDNS%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89">Kubernetes 安装 CoreDNS 组件</a></li></ul><h6 id="安装-Ingress"><a href="#安装-Ingress" class="headerlink" title="安装 Ingress"></a>安装 Ingress</h6><ul><li><a href="/posts/6bf07963.html#Ingress-%E7%9A%84%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4">Kubernetes 安装 Ingress 组件</a></li></ul><div class="admonition warning"><p class="admonition-title">特别注意</p><p>建议先安装 CoreDNS，然后再安装 Ingress，因为 Ingress 在启动时需要解析域名，有时候会依赖集群 DNS 组件（比如 CoreDNS）。</p></div><h5 id="部署步骤"><a href="#部署步骤" class="headerlink" title="部署步骤"></a>部署步骤</h5><h6 id="Prometheus-部署"><a href="#Prometheus-部署" class="headerlink" title="Prometheus 部署"></a>Prometheus 部署</h6><ul><li>创建 YAML 配置文件 <code>prometheus-config.yml</code>，用于部署 Prometheus 的 ConfigMap</li></ul><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">prometheus.yml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    global:</span></span><br><span class="line"><span class="string">      scrape_interval:     15s</span></span><br><span class="line"><span class="string">      evaluation_interval: 15s</span></span><br><span class="line"><span class="string">    scrape_configs:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'kubernetes-apiservers'</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">tls_config:</span></span><br><span class="line">        <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">      <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>, <span class="string">__meta_kubernetes_service_name</span>, <span class="string">__meta_kubernetes_endpoint_port_name</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">default;kubernetes;https</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'kubernetes-nodes'</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">      <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">tls_config:</span></span><br><span class="line">        <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">      <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">kubernetes.default.svc:443</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_node_name</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">/api/v1/nodes/${1}/proxy/metrics</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'kubernetes-cadvisor'</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">      <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">tls_config:</span></span><br><span class="line">        <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">      <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">kubernetes.default.svc:443</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_node_name</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">/api/v1/nodes/${1}/proxy/metrics/cadvisor</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'kubernetes-service-endpoints'</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_scrape</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_scheme</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__scheme__</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(https?)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_path</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>, <span class="string">__meta_kubernetes_service_annotation_prometheus_io_port</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">$1:$2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_service_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_name</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_name</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'kubernetes-services'</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">service</span></span><br><span class="line">      <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">      <span class="attr">params:</span></span><br><span class="line">        <span class="attr">module:</span> [<span class="string">http_2xx</span>]</span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_probe</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">blackbox-exporter.example.com:9115</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_service_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_name</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_name</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'kubernetes-ingresses'</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">ingress</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_ingress_annotation_prometheus_io_probe</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_ingress_scheme</span>,<span class="string">__address__</span>,<span class="string">__meta_kubernetes_ingress_path</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+);(.+);(.+)</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">${1}://${2}${3}</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">blackbox-exporter.example.com:9115</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_ingress_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_ingress_name</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_name</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'kubernetes-pods'</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">pod</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_scrape</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_path</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>, <span class="string">__meta_kubernetes_pod_annotation_prometheus_io_port</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">$1:$2</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_pod_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_name</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_pod_name</span></span><br></pre></td></tr></tbody></table></figure><ul><li>创建 YAML 配置文件 <code>prometheus-deploy.yml</code>，用于部署 Prometheus 的 Deployment</li></ul><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">prometheus-deployment</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">prom/prometheus:v2.0.0</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">"/bin/prometheus"</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">"--config.file=/etc/prometheus/prometheus.yml"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">"--storage.tsdb.path=/prometheus"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">"--storage.tsdb.retention=24h"</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9090</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">"/prometheus"</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">"/etc/prometheus"</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">2500Mi</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">prometheus</span>    </span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="attr">emptyDir:</span> {}</span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br></pre></td></tr></tbody></table></figure><ul><li>创建 YAML 配置文件 <code>prometheus-svc.yml</code>，用于部署 Prometheus 的 Service</li></ul><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9090</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30003</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br></pre></td></tr></tbody></table></figure><ul><li>创建 YAML 配置文件 <code>prometheus-rbac.yml</code>，用于对 Prometheus 进行 RBAC 授权</li></ul><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">""</span>]</span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/proxy</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">nonResourceURLs:</span> [<span class="string">"/metrics"</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">"get"</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></tbody></table></figure><ul><li>通过上述的 YAML 配置文件，快速部署 Prometheus（注意 K8s 资源对象的部署顺序）</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署 ConfigMap</span></span><br><span class="line">kubectl apply<span class="params"> -f</span> prometheus-config.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署 Deployment</span></span><br><span class="line">kubectl apply<span class="params"> -f</span> prometheus-deploy.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署 Service</span></span><br><span class="line">kubectl apply<span class="params"> -f</span> prometheus-svc.yml</span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"># RBAC</span> 授权</span><br><span class="line">kubectl apply<span class="params"> -f</span> prometheus-rbac.yml</span><br></pre></td></tr></tbody></table></figure><ul><li>查看相关的 Pod</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods<span class="params"> -n</span> kube-system<span class="params"> -l</span> app=prometheus</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">prometheus-68546b8d9-bg69k   1/1     Running   0          96s</span><br></pre></td></tr></tbody></table></figure><ul><li>查看相关的 Service</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc<span class="params"> -n</span> kube-system<span class="params"> -l</span> app=prometheus</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME         TYPE       CLUSTER-IP   EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">prometheus   NodePort   10.0.0.21    &lt;none&gt;        9090:30003/TCP   2m12s</span><br></pre></td></tr></tbody></table></figure><h6 id="Grafana-部署"><a href="#Grafana-部署" class="headerlink" title="Grafana 部署"></a>Grafana 部署</h6><ul><li>创建 YAML 配置文件 <code>grafana-deploy.yml</code>，用于部署 Grafana 的 Deployment</li></ul><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana-core</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">core</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">      <span class="attr">component:</span> <span class="string">core</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">        <span class="attr">component:</span> <span class="string">core</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">grafana/grafana:4.2.0</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">grafana-core</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="comment"># env:</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="comment"># keep request = limit to keep this container in guaranteed class</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="comment"># The following env variables set up basic auth twith the default admin user and admin password.</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_AUTH_BASIC_ENABLED</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">"true"</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_AUTH_ANONYMOUS_ENABLED</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">"false"</span></span><br><span class="line">          <span class="comment"># - name: GF_AUTH_ANONYMOUS_ORG_ROLE</span></span><br><span class="line">          <span class="comment">#   value: Admin</span></span><br><span class="line">          <span class="comment"># does not really work, because of template variables in exported dashboards:</span></span><br><span class="line">          <span class="comment"># - name: GF_DASHBOARDS_JSON_ENABLED</span></span><br><span class="line">          <span class="comment">#   value: "true"</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/login</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">          <span class="comment"># initialDelaySeconds: 30</span></span><br><span class="line">          <span class="comment"># timeoutSeconds: 1</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-persistent-storage</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-persistent-storage</span></span><br><span class="line">        <span class="attr">emptyDir:</span> {}</span><br></pre></td></tr></tbody></table></figure><ul><li>创建 YAML 配置文件 <code>grafana-svc.yml</code>，用于部署 Grafana 的 Service</li></ul><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">core</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">core</span></span><br></pre></td></tr></tbody></table></figure><ul><li>创建 YAML 配置文件 <code>grafana-ingress.yml</code>，用于部署 Ingress 的路由规则</li></ul><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">k8s.grafana.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">3000</span></span><br></pre></td></tr></tbody></table></figure><ul><li>通过上述的 YAML 配置文件，快速部署 Grafana（注意 K8s 资源对象的部署顺序）</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署 Deployment</span></span><br><span class="line">kubectl apply<span class="params"> -f</span> grafana-deploy.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署 Service</span></span><br><span class="line">kubectl apply<span class="params"> -f</span> grafana-svc.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署 Ingress 的路由规则</span></span><br><span class="line">kubectl apply<span class="params"> -f</span> grafana-ingress.yml</span><br></pre></td></tr></tbody></table></figure><ul><li>查看相关的 Pod</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods<span class="params"> -n</span> kube-system<span class="params"> -l</span> app=grafana<span class="params"> -o</span> wide</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                           READY   STATUS    RESTARTS   AGE   IP            NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">grafana-core-6d6fb7566-5tv6t   1/1     Running   0          13m   10.244.0.16   k8s-node1    &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></tbody></table></figure><ul><li>查看相关的 Service</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc<span class="params"> -n</span> kube-system<span class="params"> -l</span> app=grafana</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME      TYPE       CLUSTER-IP   EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">grafana   NodePort   10.0.0.242   &lt;none&gt;        3000:31671/TCP   3m41s</span><br></pre></td></tr></tbody></table></figure><ul><li>查看相关的 Ingress 路由规则</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get ingress<span class="params"> -n</span> kube-system</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME      CLASS    HOSTS             ADDRESS   PORTS   AGE</span><br><span class="line">grafana   &lt;none&gt;   k8s.grafana.com             80      86m</span><br></pre></td></tr></tbody></table></figure><h6 id="对外暴露节点"><a href="#对外暴露节点" class="headerlink" title="对外暴露节点"></a>对外暴露节点</h6><ul><li>创建 YAML 配置文件 <code>node-exporter.yml</code>，用于对外暴露节点（Node）</li></ul><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">node-exporter</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">node-exporter</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">prom/node-exporter:v1.10.2</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9100</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9100</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">31672</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">node-exporter</span></span><br></pre></td></tr></tbody></table></figure><ul><li>通过上述的 YAML 配置文件，对外暴露节点（Node）</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署 DaemonSet 和 Service</span></span><br><span class="line">kubectl apply<span class="params"> -f</span> node-exporter.yml</span><br></pre></td></tr></tbody></table></figure><ul><li>查看相关的 Pod</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods<span class="params"> -n</span> kube-system<span class="params"> -l</span> k8s-app=node-exporter</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NAME                  READY   STATUS    RESTARTS   AGE</span><br><span class="line">node-exporter-2xgh6   1/1     Running   0          37s</span><br><span class="line">node-exporter-6r2jz   1/1     Running   0          37s</span><br><span class="line">node-exporter-l5hjf   1/1     Running   0          37s</span><br><span class="line">node-exporter-q5zc2   1/1     Running   0          37s</span><br></pre></td></tr></tbody></table></figure><ul><li>查看相关的 Service</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc<span class="params"> -n</span> kube-system<span class="params"> -l</span> k8s-app=node-exporter</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME            TYPE       CLUSTER-IP   EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">node-exporter   NodePort   10.0.0.118   &lt;none&gt;        9100:31672/TCP   5m16s</span><br></pre></td></tr></tbody></table></figure><ul><li>查看相关的 Ingress 规则</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get ingress<span class="params"> -n</span> kube-system</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME      CLASS    HOSTS             ADDRESS   PORTS   AGE</span><br><span class="line">grafana   &lt;none&gt;   k8s.grafana.com             80      86m</span><br></pre></td></tr></tbody></table></figure><h5 id="验证步骤"><a href="#验证步骤" class="headerlink" title="验证步骤"></a>验证步骤</h5><h6 id="通过-Service-访问-Grafana"><a href="#通过-Service-访问-Grafana" class="headerlink" title="通过 Service 访问 Grafana"></a>通过 Service 访问 Grafana</h6><ul><li>首先，查看 Grafana 相关的 Service</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc<span class="params"> -n</span> kube-system</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NAME            TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">grafana         NodePort    10.0.0.242   &lt;none&gt;        3000:31671/TCP           20m</span><br><span class="line">kube-dns        ClusterIP   10.0.0.2     &lt;none&gt;        53/UDP,53/TCP,9153/TCP   8d</span><br><span class="line">node-exporter   NodePort    10.0.0.153   &lt;none&gt;        9100:31672/TCP           38m</span><br><span class="line">prometheus      NodePort    10.0.0.21    &lt;none&gt;        9090:30003/TCP           31m</span><br></pre></td></tr></tbody></table></figure><ul><li>通过任意一个集群节点的 IP 与 Grafana 的 Service 对外暴露的端口（比如 <code>http://192.168.2.191:31671</code>），就可以在 Kubernetes 集群外部通过浏览器访问 Grafana 的控制台页面（如下图所示）</li></ul><p><img data-src="../../../asset/2025/11/k8s-grafana-0.png"></p><div class="admonition warning"><p class="admonition-title">特别注意</p><p>在 Kubernetes 集群外部，浏览器通过任意集群节点的 IP + Service 对外暴露的端口（<code>NodePort</code>）来访问 Grafana 的控制台页面（比如 <code>http://192.168.2.191:31671</code>），这并没有使用到 Ingress。</p></div><h6 id="通过-Ingress-访问-Grafana"><a href="#通过-Ingress-访问-Grafana" class="headerlink" title="通过 Ingress 访问 Grafana"></a>通过 Ingress 访问 Grafana</h6><ul><li>查看 Grafana 相关的 Ingress 路由规则</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get ingress<span class="params"> -n</span> kube-system</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME      CLASS    HOSTS             ADDRESS   PORTS   AGE</span><br><span class="line">grafana   &lt;none&gt;   k8s.grafana.com             80      86m</span><br></pre></td></tr></tbody></table></figure><ul><li>查看 Nginx Ingress Controller 所在的节点（Node）</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods<span class="params"> -n</span> ingress-nginx<span class="params"> -o</span> wide</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE     IP              NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-ingress-controller-5dc64b58f-s82x6   1/1     Running   0          6m51s   192.168.2.131   k8s-node2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></tbody></table></figure><ul><li>在 K8s 集群外部的操作系统中，编辑系统配置文件 <code>/etc/hosts</code>，添加域名映射记录，其中 <code>192.168.2.131</code> 是 Nginx Ingress Controller 所在节点的 IP 地址（<strong>请自行更改 IP 地址</strong>）</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑系统配置文件，添加以下内容</span></span><br><span class="line">vim /etc/hosts</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.2.131      k8s.grafana.com </span><br></pre></td></tr></tbody></table></figure><ul><li>在 K8s 集群外部的操作系统中，浏览器通过域名 <code>k8s.grafana.com</code> 访问 Ingress。如果可以成功访问 Grafana 的控制台页面（如下图所示），则说明 Ingress + Service + Grafana 可以正常运行</li></ul><p><img data-src="../../../asset/2025/11/k8s-grafana-0.png"></p><h6 id="Grafana-展示监控数据图表"><a href="#Grafana-展示监控数据图表" class="headerlink" title="Grafana 展示监控数据图表"></a>Grafana 展示监控数据图表</h6><ul><li>首先，查看所有 Service，记住 Prometheus 的 ClusterIP（比如 <code>10.0.0.21</code>）</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc<span class="params"> -n</span> kube-system</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NAME            TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">grafana         NodePort    10.0.0.242   &lt;none&gt;        3000:31671/TCP           20m</span><br><span class="line">kube-dns        ClusterIP   10.0.0.2     &lt;none&gt;        53/UDP,53/TCP,9153/TCP   8d</span><br><span class="line">node-exporter   NodePort    10.0.0.153   &lt;none&gt;        9100:31672/TCP           38m</span><br><span class="line">prometheus      NodePort    10.0.0.21    &lt;none&gt;        9090:30003/TCP           31m</span><br></pre></td></tr></tbody></table></figure><ul><li>登录 Grafana 的控制台页面，默认的登录用户名和密码分别是 <code>admin / admin</code>，成功登录后的控制台页面如下：</li></ul><p><img data-src="../../../asset/2025/11/k8s-grafana-1.png"></p><ul><li>在 Grafana 的控制台页面中，添加相应的数据源，这里数据源地址里的 IP 是 Prometheus 的 Pod 在 K8s 集群内部的 IP 地址（ClusterIP），比如 <code>10.0.0.21</code>，端口号是 <code>9090</code></li></ul><p><img data-src="../../../asset/2025/11/k8s-grafana-2.png"></p><ul><li>在 Grafana 的控制台页面中，导入 DashBoard 模板</li></ul><p><img data-src="../../../asset/2025/11/k8s-grafana-3.png"></p><ul><li>在模板输入框中填写数字 <code>315</code>（Grafana 模板的编号），然后让模板输入框失去焦点（或者点击 <code>Load</code> 按钮），等待一会模板信息就会加载出来</li></ul><p><img data-src="../../../asset/2025/11/k8s-grafana-4.png"></p><ul><li>模板信息加载出来后，手动选择之前添加的数据源，然后点击 <code>Import</code> 按钮就可以导入模板</li></ul><p><img data-src="../../../asset/2025/11/k8s-grafana-5.png"></p><ul><li>模板导入成功后，Grafana 会自动跳转到 DashBoard 页面</li></ul><p><img data-src="../../../asset/2025/11/k8s-grafana-6.png"></p><ul><li>在 DashBoard 页面中，如果可以看到 K8s 集群的监控图表，则说明基于 Prometheus + Grafana 的 K8s 集群性能监控平台搭建成功</li></ul><h3 id="实战部署-Java-应用程序"><a href="#实战部署-Java-应用程序" class="headerlink" title="实战部署 Java 应用程序"></a>实战部署 Java 应用程序</h3><p>本节将介绍如何在 Kubernetes 环境中实现 Java 项目的 CI/CD（持续集成与持续交付），其中 Docker 镜像仓库采用阿里云容器镜像服务（ACR）。</p><h4 id="容器交付的完整流程"><a href="#容器交付的完整流程" class="headerlink" title="容器交付的完整流程"></a>容器交付的完整流程</h4><blockquote><p>Java 项目开发 / 部署的流程</p></blockquote><p><img data-src="../../../asset/2025/11/k8s-cicd-1.png"></p><blockquote><p>Kubernetes 部署项目的流程</p></blockquote><p><img data-src="../../../asset/2025/11/k8s-cicd-2.png"></p><blockquote><p>Kubernetes 实现 CI / CD 的流程</p></blockquote><p><img data-src="../../../asset/2025/11/k8s-cicd-3.png"></p><h4 id="创建-Java-应用的镜像"><a href="#创建-Java-应用的镜像" class="headerlink" title="创建 Java 应用的镜像"></a>创建 Java 应用的镜像</h4><h5 id="制作-Java-应用的镜像"><a href="#制作-Java-应用的镜像" class="headerlink" title="制作 Java 应用的镜像"></a>制作 Java 应用的镜像</h5><div class="admonition note"><p class="admonition-title">运行环境说明</p><p>制作镜像的所有操作，都可以在任意一台安装了 JDK + Maven + Docker 的机器上执行。</p></div><ul><li>(1) 准备一个 Java 项目（基于 SpringBoot），项目结构如下（<a href="../../../downloads/2025/11/demojenkins.tar.gz">点击下载完整的项目源码</a>）：</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">demojenkins</span><br><span class="line">├── demojenkins.iml</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── pom.xml</span><br><span class="line">└── src</span><br><span class="line">    ├── main</span><br><span class="line">    │&nbsp;&nbsp; ├── java</span><br><span class="line">    │&nbsp;&nbsp; │&nbsp;&nbsp; └── com</span><br><span class="line">    │&nbsp;&nbsp; │&nbsp;&nbsp;     └── clay</span><br><span class="line">    │&nbsp;&nbsp; │&nbsp;&nbsp;         └── demojenkins</span><br><span class="line">    │&nbsp;&nbsp; │&nbsp;&nbsp;             ├── controller</span><br><span class="line">    │&nbsp;&nbsp; │&nbsp;&nbsp;             │&nbsp;&nbsp; └── UserController.java</span><br><span class="line">    │&nbsp;&nbsp; │&nbsp;&nbsp;             └── DemoJenkinsApplication.java</span><br><span class="line">    │&nbsp;&nbsp; └── resources</span><br><span class="line">    │&nbsp;&nbsp;     └── application.yml</span><br><span class="line">    └── test</span><br><span class="line">        └── java</span><br><span class="line">            └── com</span><br><span class="line">                └── clay</span><br><span class="line">                    └── demojenkins</span><br><span class="line">                        └── DemoJenkinsApplicationTests.java</span><br></pre></td></tr></tbody></table></figure><ul><li>(2) 使用 Maven 命令将 Java 项目打包成可执行的 Jar 包或者 War 包（运行依赖 Tomcat 等外部 Web 容器），比如 <code>demojenkins.jar</code></li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入项目根目录</span></span><br><span class="line"><span class="keyword"># cd</span> demojenkins</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译打包项目</span></span><br><span class="line"><span class="keyword"># mvn</span> clean package</span><br></pre></td></tr></tbody></table></figure><ul><li>(3) 使用 Docker 命令构建镜像</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入项目根目录（该目录下有 Dockerfile 文件）</span></span><br><span class="line"><span class="keyword"># cd</span> demojenkins</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建镜像（注意，命令的末尾有一个点号）</span></span><br><span class="line"><span class="keyword"># docker</span> build<span class="params"> -t</span> demojenkins:0.0.1 .</span><br></pre></td></tr></tbody></table></figure><ul><li>(4) 查看构建生成的 Docker 镜像</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看镜像列表</span></span><br><span class="line"><span class="keyword"># docker</span> images</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY                              TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">demojenkins                             0.0.1               51ecb07ed574        48 seconds ago      122MB</span><br><span class="line">openjdk                                 8-jdk-alpine        a3562aa0b991        6 years ago         105MB</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure><ul><li>(5) 测试 Docker 镜像是否可用</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动容器（后台启动）</span></span><br><span class="line"><span class="keyword"># docker</span> run<span class="params"> -d</span><span class="params"> --name</span> demojenkins<span class="params"> -p</span> 8111:8111 demojenkins:0.0.1</span><br></pre></td></tr></tbody></table></figure><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看容器的运行状态，输出示例如下所示</span></span><br><span class="line"><span class="keyword"># docker</span> ps<span class="params"> -a</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS                     PORTS                    NAMES</span><br><span class="line">85d0ce0e5edd        demojenkins:0.0.1             "java -jar /demojenk…"   7 seconds ago       Up 6 seconds               0.0.0.0:8111-&gt;8111/tcp   demojenkins</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过 Curl 工具测试 Java 项目的接口，输出示例如下所示</span></span><br><span class="line"><span class="keyword"># curl</span> http://127.0.0.1:8111/user/findAll</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello 1763004675787</span><br></pre></td></tr></tbody></table></figure><ul><li>(6) 最后删除前面启动的 Docker 容器</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword"># docker</span> rm<span class="params"> -f</span> demojenkins</span><br></pre></td></tr></tbody></table></figure><h5 id="推送-Java-应用的镜像"><a href="#推送-Java-应用的镜像" class="headerlink" title="推送 Java 应用的镜像"></a>推送 Java 应用的镜像</h5><div class="admonition note"><p class="admonition-title">运行环境说明</p><p>推送镜像的所有操作，都可以在任意一台安装了 JDK + Maven + Docker 的机器上执行。</p></div><ul><li>(1) 浏览器打开阿里云的 <a target="_blank" rel="external nofollow" href="https://cr.console.aliyun.com/">容器镜像服务（ACR）</a> 页面（选择个人版实例）</li></ul><p><img data-src="../../../asset/2025/11/k8s-cicd-6.png"></p><ul><li>(2) 创建命名空间（比如 <code>java-dev</code>）</li></ul><p><img data-src="../../../asset/2025/11/k8s-cicd-5.png"></p><ul><li>(3) 创建镜像仓库（比如 <code>demojenkins</code>），<strong>需要选择上面创建的命名空间，且代码源必须选择本地仓库</strong></li></ul><p><img data-src="../../../asset/2025/11/k8s-cicd-4.png"></p><ul><li> (4) 在终端中使用命令登录阿里云镜像仓库（<strong>用于登录的用户名为阿里云账号全名，密码为开通容器镜像服务时设置的密码，镜像仓库域名可以从阿里云特定镜像仓库的详情页面获取</strong>）</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录阿里云镜像仓库</span></span><br><span class="line"><span class="keyword"># docker</span> login<span class="params"> --username</span>=xxxxx [镜像仓库域名]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 比如</span></span><br><span class="line"><span class="keyword"># docker</span> login<span class="params"> --username</span>=xxxxx registry.cn-beijing.aliyuncs.com</span><br></pre></td></tr></tbody></table></figure><ul><li>(5) 推送镜像到阿里云镜像仓库</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 镜像打上标签</span></span><br><span class="line"><span class="keyword"># docker</span> tag [镜像ID] [镜像仓库域名]/[命名空间]/[镜像名称]:[镜像版本号]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 比如</span></span><br><span class="line"><span class="keyword"># docker</span> tag 51ecb07ed574 registry.cn-beijing.aliyuncs.com/java-dev/demojenkins:0.0.1</span><br></pre></td></tr></tbody></table></figure><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 推送镜像</span></span><br><span class="line"><span class="keyword"># docker</span> push [镜像仓库域名]/[命名空间]/[镜像名称]:[镜像版本号]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 比如</span></span><br><span class="line"><span class="keyword"># docker</span> push registry.cn-beijing.aliyuncs.com/java-dev/demojenkins:0.0.1</span><br></pre></td></tr></tbody></table></figure><h5 id="部署-Java-应用的镜像"><a href="#部署-Java-应用的镜像" class="headerlink" title="部署 Java 应用的镜像"></a>部署 Java 应用的镜像</h5><div class="admonition note"><p class="admonition-title">运行环境说明</p><p>部署镜像所有操作，必须在 Kubernetes 集群的任意一个 Master 节点上执行。</p></div><ul><li>(1) 在 Kubernetes 集群中，创建镜像拉取凭据 Secret（<strong>用于登录的用户名为阿里云账号全名，密码为开通容器镜像服务时设置的密码，邮箱地址可以自定义，镜像仓库域名可以从阿里云特定镜像仓库的详情页面获取</strong>）</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建Secret</span></span><br><span class="line"><span class="keyword"># kubectl</span> create secret docker-registry aliyun-regcred \<span class="params"></span></span><br><span class="line"><span class="params">  --docker</span>-server=&lt;镜像仓库域名&gt; \<span class="params"></span></span><br><span class="line"><span class="params">  --docker</span>-username=&lt;登录用户名&gt; \<span class="params"></span></span><br><span class="line"><span class="params">  --docker</span>-password=&lt;登录密码&gt; \<span class="params"></span></span><br><span class="line"><span class="params">  --docker</span>-email=&lt;邮箱地址&gt;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看创建的Secret，输出示例如下</span></span><br><span class="line"><span class="keyword"># kubectl</span> get secret aliyun-regcred</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME             TYPE                             DATA   AGE</span><br><span class="line">aliyun-regcred   kubernetes.io/dockerconfigjson   1      14s</span><br></pre></td></tr></tbody></table></figure><ul><li>(2) 创建一个 YAML 配置文件（比如 <code>demojenkins-deploy.yaml</code>），用于部署 Deployment 和 Service，使用了阿里云镜像仓库中的 Docker 镜像</li></ul><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">demojenkins</span>         <span class="comment"># Service 的名称</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span>            <span class="comment"># ervice 类型为 NodePort，可通过节点 IP 访问</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demojenkins</span>        <span class="comment"># 选择标签为 app=demojenkins 的 Pod 作为后端</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span>              <span class="comment"># Service 对外暴露的端口，集群内部访问时也可以使用该端口</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8111</span>      <span class="comment"># Pod 内容器实际监听的端口（即将请求转发到容器的 xxxx 端口）</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">demojenkins</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span>       <span class="comment"># Pod 的副本数量</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demojenkins</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">demojenkins</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">demojenkins</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">&lt;镜像仓库域名&gt;/&lt;命名空间&gt;/&lt;镜像名称&gt;:&lt;镜像版本号&gt;</span>    <span class="comment"># 阿里云镜像地址，比如：registry.cn-beijing.aliyuncs.com/java-dev/demojenkins:0.0.1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8111</span>     <span class="comment"># 容器内应用（比如 Tomcat）监听的端口</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span>           <span class="comment"># 引用镜像拉取凭据 Secret</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">aliyun-regcred</span></span><br></pre></td></tr></tbody></table></figure><ul><li>(3) 应用 YAML 配置文件，创建 Deployment 和 Service 资源对象</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 应用YAML配置文件</span></span><br><span class="line"><span class="keyword"># kubectl</span> apply<span class="params"> -f</span> demojenkins-deploy.yaml</span><br></pre></td></tr></tbody></table></figure><ul><li>(4) 查看 Service 的列表</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看Service列表，输出示例如下</span></span><br><span class="line"><span class="keyword"># kubectl</span> get svc</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME          TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">demojenkins   NodePort    10.0.0.112   &lt;none&gt;        80:30577/TCP   2m25s</span><br><span class="line">kubernetes    ClusterIP   10.0.0.1     &lt;none&gt;        443/TCP        30h</span><br></pre></td></tr></tbody></table></figure><ul><li>(5) 查看 Deployment 的列表</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看Deployment列表，输出示例如下</span></span><br><span class="line"><span class="keyword"># kubectl</span> get deployments</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME          READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">demojenkins   3/3     3            3           171m</span><br></pre></td></tr></tbody></table></figure><ul><li>(6) 查看所有 Pod 的运行状态</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有Pod的运行状态，输出示例如下</span></span><br><span class="line"><span class="keyword"># kubectl</span> get pods<span class="params"> -o</span> wide</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NAME                           READY   STATUS    RESTARTS   AGE    IP            NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">demojenkins-5486657b45-9ck68   1/1     Running   0          169m   10.244.4.10   k8s-node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">demojenkins-5486657b45-n6t88   1/1     Running   0          169m   10.244.2.6    k8s-node3     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">demojenkins-5486657b45-v6zsl   1/1     Running   0          169m   10.244.3.8    k8s-node2     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果Pod启动失败，可以查看Pod的详细运行情况来定位问题</span></span><br><span class="line"><span class="keyword"># kubectl</span> describe pod &lt;pod-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除启动失败的Pod，触发Deployment对Pod的重建</span></span><br><span class="line"><span class="keyword"># kubectl</span> delete pod &lt;pod-name&gt;</span><br></pre></td></tr></tbody></table></figure><ul><li>(7) 在 Kubernetes 集群外部，通过 <code>curl</code> 网络工具访问容器内的 Java 应用（<strong>IP 可以是 Kubernetes 集群任意一个节点的 IP 地址，端口号可以通过 <code>kubectl get svc</code> 命令获取得到</strong>）</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 访问Java应用的接口，输出示例如下</span></span><br><span class="line"><span class="keyword"># curl</span> http://&lt;node-ip&gt;:30577/user/findAll</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello 1763023637288</span><br></pre></td></tr></tbody></table></figure><ul><li>(8) 若希望删除上面创建的 Secret、Deployment、Service、Pod 所有资源对象，可以执行以下命令</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除Deployment、Service、Pod</span></span><br><span class="line"><span class="keyword"># kubectl</span> delete<span class="params"> -f</span> demojenkins-deploy.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除Secret</span></span><br><span class="line"><span class="keyword"># kubectl</span> delete secret aliyun-regcred </span><br></pre></td></tr></tbody></table></figure><h4 id="扩容-缩容-Java-应用程序"><a href="#扩容-缩容-Java-应用程序" class="headerlink" title="扩容 / 缩容 Java 应用程序"></a>扩容 / 缩容 Java 应用程序</h4><div class="admonition note"><p class="admonition-title">运行环境说明</p><p>扩容和缩容操作，必须在 Kubernetes 集群的任意一个 Master 节点上执行。</p></div><h5 id="扩容-Java-应用程序"><a href="#扩容-Java-应用程序" class="headerlink" title="扩容 Java 应用程序"></a>扩容 Java 应用程序</h5><ul><li>(1) 当完成上述步骤并将 Java 应用部署到 Kubernetes 集群后，可以通过以下命令调整该应用对应 Pod 的副本数量，实现扩容操作</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 对Pod的副本进行扩容（比如，扩容至 5 个副本）</span></span><br><span class="line"><span class="keyword"># kubectl</span> scale deployment &lt;Deployment名称&gt;<span class="params"> --replicas</span>=5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 比如</span></span><br><span class="line"><span class="keyword"># kubectl</span> scale deployment demojenkins<span class="params"> --replicas</span>=5</span><br></pre></td></tr></tbody></table></figure><ul><li>(2) 查看所有 Pod 的运行状态</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有Pod的运行状态，输出示例如下</span></span><br><span class="line"><span class="keyword"># kubectl</span> get pods<span class="params"> -o</span> wide</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME                           READY   STATUS    RESTARTS   AGE    IP            NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">demojenkins-5486657b45-9ck68   1/1     Running   0          177m   10.244.4.10   k8s-node2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">demojenkins-5486657b45-bkc6s   1/1     Running   0          52s    10.244.1.8    k8s-node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">demojenkins-5486657b45-n6t88   1/1     Running   0          177m   10.244.2.6    k8s-node3     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">demojenkins-5486657b45-v6zsl   1/1     Running   0          177m   10.244.3.8    k8s-node2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">demojenkins-5486657b45-vjpxq   1/1     Running   0          58s    10.244.0.8    k8s-node1     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></tbody></table></figure><h5 id="缩容-Java-应用程序"><a href="#缩容-Java-应用程序" class="headerlink" title="缩容 Java 应用程序"></a>缩容 Java 应用程序</h5><ul><li>(1) 当完成上述步骤并将 Java 应用部署到 Kubernetes 集群后，可以通过以下命令调整该应用对应 Pod 的副本数量，实现缩容操作</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 对Pod的副本进行缩容（比如，缩容至 2 个副本）</span></span><br><span class="line"><span class="keyword"># kubectl</span> scale deployment &lt;Deployment名称&gt;<span class="params"> --replicas</span>=2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 比如</span></span><br><span class="line"><span class="keyword"># kubectl</span> scale deployment demojenkins<span class="params"> --replicas</span>=2</span><br></pre></td></tr></tbody></table></figure><ul><li>(2) 查看所有 Pod 的运行状态</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有Pod的运行状态，输出示例如下</span></span><br><span class="line"><span class="keyword"># kubectl</span> get pods<span class="params"> -o</span> wide</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                           READY   STATUS    RESTARTS   AGE    IP            NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">demojenkins-5486657b45-9ck68   1/1     Running   0          3h4m   10.244.4.10   k8s-node2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">demojenkins-5486657b45-n6t88   1/1     Running   0          3h4m   10.244.2.6    k8s-node3     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></tbody></table></figure><h4 id="升级-回滚-Java-应用程序"><a href="#升级-回滚-Java-应用程序" class="headerlink" title="升级 / 回滚 Java 应用程序"></a>升级 / 回滚 Java 应用程序</h4><div class="admonition note"><p class="admonition-title">运行环境说明</p><p>升级和回滚操作，必须在 Kubernetes 集群的任意一个 Master 节点上执行。<strong>值得注意的是，这里的升级和回滚操作针对的是 Pod 所使用的 Docker 镜像版本，也就意味着在实际执行时，相当于对 Java 应用的版本进行升级或回退。</strong></p></div><h5 id="升级-Java-应用程序"><a href="#升级-Java-应用程序" class="headerlink" title="升级 Java 应用程序"></a>升级 Java 应用程序</h5><ul><li><p>(1) 项目代码迭代更新后，重新 <a href="/posts/6158b4d2.html#%E5%88%B6%E4%BD%9C-Java-%E5%BA%94%E7%94%A8%E7%9A%84%E9%95%9C%E5%83%8F">制作 Java 应用的镜像</a>，且镜像使用新的版本号（比如 <code>0.0.2</code>），并推送新版本镜像到阿里云仓库</p></li><li><p>(2) 为了更好观察 Java 应用的升级过程，先查看所有 Pod 的运行状态</p></li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有Pod的运行状态，输出示例如下</span></span><br><span class="line"><span class="keyword"># kubectl</span> get pods<span class="params"> -o</span> wide</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                           READY   STATUS    RESTARTS   AGE    IP            NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">demojenkins-5486657b45-9ck68   1/1     Running   0          3h4m   10.244.4.10   k8s-node2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">demojenkins-5486657b45-n6t88   1/1     Running   0          3h4m   10.244.2.6    k8s-node3     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></tbody></table></figure><ul><li>(3) 当新版本镜像推送到阿里云仓库后，可以通过以下命令来升级 Java 应用对应 Pod 的版本（比如，升级到 <code>0.0.2</code> 版本）</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 升级Pod的版本</span></span><br><span class="line"><span class="keyword"># kubectl</span> <span class="built_in">set</span> image deployment &lt;Deployment名称&gt; &lt;容器名称&gt;=&lt;镜像仓库域名&gt;/&lt;命名空间&gt;/&lt;镜像名&gt;:&lt;版本号&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 比如</span></span><br><span class="line"><span class="keyword"># kubectl</span> <span class="built_in">set</span> image deployment demojenkins demojenkins=registry.cn-beijing.aliyuncs.com/java-dev/demojenkins:0.0.2</span><br></pre></td></tr></tbody></table></figure><ul><li>(4) 查看 Java 应用升级版本的状态（过程）</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看升级版本的状态</span></span><br><span class="line"><span class="keyword"># kubectl</span> rollout status deployment &lt;Deployment名称&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 比如，输出示例如下</span></span><br><span class="line"><span class="keyword"># kubectl</span> rollout status deployment demojenkins</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Waiting for deployment "demojenkins" rollout to finish: 1 out of 2 new replicas have been updated...</span><br><span class="line">Waiting for deployment "demojenkins" rollout to finish: 1 out of 2 new replicas have been updated...</span><br><span class="line">Waiting for deployment "demojenkins" rollout to finish: 1 out of 2 new replicas have been updated...</span><br><span class="line">Waiting for deployment "demojenkins" rollout to finish: 1 old replicas are pending termination...</span><br><span class="line">Waiting for deployment "demojenkins" rollout to finish: 1 old replicas are pending termination...</span><br><span class="line">deployment "demojenkins" successfully rolled out</span><br></pre></td></tr></tbody></table></figure><ul><li>(5) 再次查看所有 Pod 的运行状态，发现 Pod 名称已经发生变化</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有Pod的运行状态，输出示例如下</span></span><br><span class="line"><span class="keyword"># kubectl</span> get pods<span class="params"> -o</span> wide</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                          READY   STATUS    RESTARTS   AGE     IP           NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">demojenkins-6c58b8c7b-mt8hp   1/1     Running   0          6m50s   10.244.1.9   k8s-node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">demojenkins-6c58b8c7b-tng8r   1/1     Running   0          6m20s   10.244.3.9   k8s-node2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></tbody></table></figure><h5 id="回滚-Java-应用程序"><a href="#回滚-Java-应用程序" class="headerlink" title="回滚 Java 应用程序"></a>回滚 Java 应用程序</h5><ul><li>(1) 为了更好观察 Java 应用的回滚过程，先查看所有 Pod 的运行状态</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有Pod的运行状态，输出示例如下</span></span><br><span class="line"><span class="keyword"># kubectl</span> get pods<span class="params"> -o</span> wide</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                          READY   STATUS    RESTARTS   AGE   IP           NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">demojenkins-6c58b8c7b-mt8hp   1/1     Running   0          10m   10.244.1.9   k8s-node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">demojenkins-6c58b8c7b-tng8r   1/1     Running   0          10m   10.244.3.9   k8s-node2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></tbody></table></figure><ul><li>(2) 查看指定 Deployment 的所有历史版本</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看指定Deployment的所有历史版本</span></span><br><span class="line"><span class="keyword"># kubectl</span> rollout <span class="built_in">history</span> deployment &lt;Deployment名称&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 比如，输出示例如下</span></span><br><span class="line"><span class="keyword"># kubectl</span> rollout <span class="built_in">history</span> deployment demojenkins</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deployment.apps/demojenkins </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         &lt;none&gt;</span><br><span class="line">2         &lt;none&gt;</span><br></pre></td></tr></tbody></table></figure><ul><li>(3) 当执行完上述步骤将 Java 应用 的版本从 <code>0.0.1</code> 升级到 <code>0.0.2</code> 后，若希望回滚到旧的版本（即用旧版本的 Pod 替换掉所有新版本的 Pod），可以执行以下命令</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 回滚指定Deployment到上一个版本</span></span><br><span class="line"><span class="keyword"># kubectl</span> rollout undo deployment &lt;Deployment名称&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 比如</span></span><br><span class="line"><span class="keyword"># kubectl</span> rollout undo deployment demojenkins</span><br></pre></td></tr></tbody></table></figure><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 或者，回滚指定Deployment到指定的版本</span></span><br><span class="line"><span class="keyword"># kubectl</span> rollout undo deployment &lt;Deployment名称&gt;<span class="params"> --to</span>-revision=&lt;版本&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 比如</span></span><br><span class="line"><span class="keyword"># kubectl</span> rollout undo deployment demojenkins<span class="params"> --to</span>-revision=1</span><br></pre></td></tr></tbody></table></figure><ul><li>(4) 再次查看所有 Pod 的运行状态，发现 Pod 名称已经发生变化</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有Pod的运行状态，输出示例如下</span></span><br><span class="line"><span class="keyword"># kubectl</span> get pods<span class="params"> -o</span> wide</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                           READY   STATUS    RESTARTS   AGE   IP            NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">demojenkins-5486657b45-knbnp   1/1     Running   0          66s   10.244.4.11   k8s-node2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">demojenkins-5486657b45-md6lh   1/1     Running   0          64s   10.244.2.7    k8s-node3     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></tbody></table></figure><h4 id="平滑重启-Java-应用程序"><a href="#平滑重启-Java-应用程序" class="headerlink" title="平滑重启 Java 应用程序"></a>平滑重启 Java 应用程序</h4><div class="admonition note"><p class="admonition-title">运行环境说明</p><p>平滑重启操作，必须在 Kubernetes 集群的任意一个 Master 节点上执行。</p></div><h5 id="什么是平滑重启"><a href="#什么是平滑重启" class="headerlink" title="什么是平滑重启"></a>什么是平滑重启</h5><ul><li>在 Kubernetes 中实现 Java 应用程序的平滑重启，本质上是通过 Deployment 滚动更新（Rolling Update）的方式实现，也就是逐个重建 Pod，而不是将全部 Pod 停掉再重建，这样可以保证服务在重启过程中尽量不丢失请求。</li><li>所谓 Java 应用平滑重启（Graceful Restart）有两个关键点：<ul><li>(1) 不中断现有请求：Java 应用在收到 <code>SIGTERM</code> 信号时，应该先停止接收新请求，但允许正在处理的请求完成，再退出。</li><li>(2) 保证服务可用性：Kubernetes 通过 Deployment 的滚动更新或 Pod 生命周期钩子来保证至少有一部分实例在运行，避免服务全部不可用。</li></ul></li></ul><div class="admonition warning"><p class="admonition-title">扩展阅读</p><p>更多关于 Kubernetes 如何实现 Java 应用程序平滑重启的详细介绍，可以看 <a href="/posts/5f66357f.html#%E5%B9%B3%E6%BB%91%E9%87%8D%E5%90%AF-Java-%E5%BA%94%E7%94%A8">这里</a>。</p></div><h5 id="平滑重启的实现"><a href="#平滑重启的实现" class="headerlink" title="平滑重启的实现"></a>平滑重启的实现</h5><ul><li>(1) 手动触发 Deployment 滚动更新（Rolling Update），也就是说，Kubernetes 会逐个重建 Pod，而不是将全部 Pod 停掉再重建</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 触发Deployment滚动更新</span></span><br><span class="line"><span class="keyword"># kubectl</span> rollout restart deployment &lt;Deployment名称&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 比如</span></span><br><span class="line"><span class="keyword"># kubectl</span> rollout restart deployment demojenkins</span><br></pre></td></tr></tbody></table></figure><ul><li>(2) <strong>特别注意，光是依靠 <code>kubectl rollout restart deployment &lt;Deployment名称&gt;</code> 命令，不一定就可以真正实现 Java 应用的平滑重启，它是有几个前提条件的，详细说明请看 <a href="/posts/5f66357f.html#%E5%B9%B3%E6%BB%91%E9%87%8D%E5%90%AF-Java-%E5%BA%94%E7%94%A8">这里</a>。</strong></li></ul><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="/posts/54626c2e.html">DevOps 的技术选型介绍</a></li><li><a href="/posts/37a21b7b.html#%E5%BA%94%E7%94%A8%E5%8D%87%E7%BA%A7%E5%9B%9E%E6%BB%9A">Kubernetes 应用升级回滚</a></li><li><a href="/posts/37a21b7b.html#%E5%BA%94%E7%94%A8%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9">Kubernetes 应用弹性伸缩</a></li></ul><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/6158b4d2.html" title="Kubernetes 入门教程之十">https://www.techgrow.cn/posts/6158b4d2.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%AE%B9%E5%99%A8%E5%8C%96/" rel="tag"><i class="fa fa-tag"></i> 容器化</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/6bf07963.html" rel="prev" title="Kubernetes 入门教程之五"><i class="fa fa-angle-left"></i> Kubernetes 入门教程之五</a></div><div class="post-nav-item"> <a href="/posts/2ca57d7f.html" rel="next" title="Kubernetes 入门教程之七">Kubernetes 入门教程之七<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">2.2m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">33:25</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/6158b4d2.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>