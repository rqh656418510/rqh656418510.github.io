<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要记录 RabbitMQ 的日常使用笔记。"><meta property="og:type" content="article"><meta property="og:title" content="RabbitMQ 开发随笔"><meta property="og:url" content="https://www.techgrow.cn/posts/869a4db4.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要记录 RabbitMQ 的日常使用笔记。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/03/rabbitmq-6.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/03/rabbitmq-7.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/03/rabbitmq-8.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/03/rabbitmq-9.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/03/rabbitmq-10.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/03/rabbitmq-11.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/03/rabbitmq-12.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/11/message-queue-order-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/11/message-queue-ha-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/11/message-queue-ha-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/11/mq-expansion.png"><meta property="article:published_time" content="2019-06-16T04:00:00.000Z"><meta property="article:modified_time" content="2023-08-30T04:00:00.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="开发随笔"><meta property="article:tag" content="消息队列"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2025/03/rabbitmq-6.png"><link rel="canonical" href="https://www.techgrow.cn/posts/869a4db4.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/869a4db4.html","path":"posts/869a4db4.html","title":"RabbitMQ 开发随笔"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>RabbitMQ 开发随笔 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-text">核心概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9B%E5%A4%A7%E6%A6%82%E5%BF%B5"><span class="nav-text">四大概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9B%E5%A4%A7%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="nav-text">四大交换机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%83%E5%A4%A7%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="nav-text">七大工作模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E6%A8%A1%E5%BC%8F"><span class="nav-text">简单模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97%E6%A8%A1%E5%BC%8F"><span class="nav-text">工作队列模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%91%E5%B8%83-%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F"><span class="nav-text">发布 / 订阅模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F"><span class="nav-text">路由模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BB%E9%A2%98%E6%A8%A1%E5%BC%8F"><span class="nav-text">主题模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RPC-%E6%A8%A1%E5%BC%8F"><span class="nav-text">RPC 模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%E8%80%85%E7%A1%AE%E8%AE%A4%E6%A8%A1%E5%BC%8F"><span class="nav-text">发布者确认模式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86"><span class="nav-text">消息处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B6%88%E6%81%AF%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="nav-text">使用自定义消息转换器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%BB%BB%E5%8A%A1%E7%9A%84%E5%B9%B3%E6%BB%91%E5%85%B3%E9%97%AD"><span class="nav-text">消息队列任务的平滑关闭</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5"><span class="nav-text">客户端连接</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF-SSL-%E8%BF%9E%E6%8E%A5"><span class="nav-text">客户端 SSL 连接</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E4%BA%A7%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5"><span class="nav-text">生产落地实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E7%9A%84%E9%A1%BA%E5%BA%8F%E6%80%A7"><span class="nav-text">如何保证消息的顺序性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E6%B6%88%E6%81%AF%E4%B8%A2%E5%A4%B1%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-text">如何避免消息丢失的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7"><span class="nav-text">如何保证消息队列的高可用性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E6%B6%88%E6%81%AF%E5%A4%A7%E9%87%8F%E7%A7%AF%E5%8E%8B%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-text">如何解决消息大量积压的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E8%BF%87%E6%9C%9F%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98"><span class="nav-text">如何解决消息队列的过期失效问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E7%A3%81%E7%9B%98%E6%BB%A1%E4%BA%86%E5%BA%94%E8%AF%A5%E6%80%8E%E4%B9%88%E5%A4%84%E7%90%86"><span class="nav-text">消息队列的磁盘满了应该怎么处理</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">719</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">53</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/869a4db4.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="RabbitMQ 开发随笔 | Clay 的技术空间"><meta itemprop="description" content="本文主要记录 RabbitMQ 的日常使用笔记。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> RabbitMQ 开发随笔</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-06-16 12:00:00" itemprop="dateCreated datePublished" datetime="2019-06-16T12:00:00+08:00">2019-06-16</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2023-08-30 12:00:00" itemprop="dateModified" datetime="2023-08-30T12:00:00+08:00">2023-08-30</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/869a4db4.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/869a4db4.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>9.5k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>9 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><h3 id="四大概念"><a href="#四大概念" class="headerlink" title="四大概念"></a>四大概念</h3><ul><li><p>生产者（Producer）</p><ul><li>产生数据发送消息的程序是生产者。</li></ul></li><li><p>交换机（Exchange）</p><ul><li>交换机是 RabbitMQ 非常重要的一个组件，一方面它接收来自生产者的消息，另一方面它将消息推送到队列中。</li><li>交换机必须确切知道如何处理它接收到的消息，是将这些消息推送到特定队列还是推送到多个队列，亦或者是把消息丢弃，这个得由交换机的类型来决定。</li></ul></li><li><p>队列（Queue）</p><ul><li>队列是 RabbitMQ 内部使用的一种数据结构，尽管消息流经 RabbitMQ 和应用程序，但它们只能存储在队列中。</li><li>队列仅受主机的内存和磁盘限制的约束，本质上是一个大的消息缓冲区。</li><li>许多生产者可以将消息发送到一个队列，多个消费者可以尝试从一个队列接收数据，这就是最常见使用队列的方式。</li></ul></li><li><p>消费者（Consumer）</p><ul><li>消费与接收具有相似的含义，消费者大多时候是一个等待接收消息的程序。</li><li>请注意生产者、消费者和消息中间件很多时候并不在同一机器上。同一个应用程序既可以是生产者又是可以是消费者。</li></ul></li></ul><p><img data-src="../../../asset/2025/03/rabbitmq-6.png"></p><span id="more"></span><h3 id="四大交换机"><a href="#四大交换机" class="headerlink" title="四大交换机"></a>四大交换机</h3><ul><li>扇形交换机（Fanout），消息会被广播到所有绑定的队列，不依赖 RoutingKey。</li><li>直接交换机（Direct），消息根据 RoutingKey 精确匹配队列。</li><li>主题交换机（Topic），消息根据 RoutingKey 模糊匹配队列（支持通配符匹配）。</li><li>头交换机（Headers），根据消息 Header 属性匹配队列。</li></ul><div class="admonition note"><p class="admonition-title">默认交换机</p><p>当使用默认交换机（通过空字符串 <code>""</code> 进行标识），在生产者发送消息时，指定的 <code>RoutingKey</code> 其实就是队列名称，比如：<code>channel.basicPublish("", QUEUE_NAME, null, message.getBytes(StandardCharsets.UTF_8));</code></p></div><h3 id="七大工作模式"><a href="#七大工作模式" class="headerlink" title="七大工作模式"></a>七大工作模式</h3><table><thead><tr><th>工作模式</th><th>别名</th><th>说明</th><th>对应的交换机</th></tr></thead><tbody><tr><td>简单模式</td><td> Simple Queue 模式</td><td>只有一个生产者和一个消费者</td><td>默认交换机（使用空字符串 “” 进行标识）</td></tr><tr><td>工作队列模式</td><td> Work Queue 模式</td><td>一个生产者，多个消费者，同一条消息只会被一个消费者成功消费</td><td>默认交换机（使用空字符串 “” 进行标识）</td></tr><tr><td>发布 / 订阅模式</td><td> Fanout 模式</td><td>一个生产者发送的消息会被多个消费者获取，不依赖路由键（RoutingKey）</td><td>扇形交换机（Fanout）</td></tr><tr><td>路由模式</td><td> Direct 模式</td><td>发送消息到交换机，并且要指定路由键（RoutingKey），消费者在将队列绑定到交换机时需要指定路由键（RoutingKey）</td><td>直接交换机（Direct）</td></tr><tr><td>主题模式</td><td> Topic 模式</td><td>根据主题进行匹配，此时队列需要绑定在一个模式上，<code>*</code> 代表一个单词，<code>#</code> 代表零个或多个单词</td><td>主题交换机（Topic）</td></tr><tr><td>RPC 模式</td><td></td><td>使用 MQ 可以实现 RPC 的异步调用</td><td>直接交换机（Direct）</td></tr><tr><td>发布者确认模式</td><td></td><td> RabbitMQ 确保消息可靠投递的机制</td><td></td></tr></tbody></table><h4 id="简单模式"><a href="#简单模式" class="headerlink" title="简单模式"></a>简单模式</h4><ul><li>这种模式只有一个生产者、一个队列、一个消费者，也被称为 “简单队列模式”。</li><li>消息产生者将消息放入队列，消息的消费者监听消息队列，如果队列中有消息，就消费掉，消息被消费后，会自动从队列中删除。</li><li>存在隐患，比如：消息可能没有被消费者正确处理，但在队列中已经被删除了，造成消息的丢失。</li><li>应用场景：聊天（中间需要有一个过度的服务器 - P 端 与 C 端）。</li></ul><p><img data-src="../../../asset/2025/03/rabbitmq-7.png"></p><h4 id="工作队列模式"><a href="#工作队列模式" class="headerlink" title="工作队列模式"></a>工作队列模式</h4><ul><li>这种模式（竞争资源 - 在工作进程之间分发任务）有一个生产者、一个队列、多个消费者，同一条消息只会被一个消费者成功消费。</li><li>消息生产者将消息放入队列，消费者可以有多个。比如：消费者 1 与 消费者 2 同时监听同一个队列，消息被消费时，两个消费者共同争抢当前的消息队列内容，谁先抢到谁负责消费消息。</li><li>存在隐患：高并发情况下，可能会发生某一个消息被多个消费者共同消费。</li><li>应用场景：抢红包、大型项目中的资源调度（任务分配系统不需知道哪一个任务执行系统处于空闲状态，直接将任务放进到消息队列中，空闲的任务执行系统自动争抢任务）。</li></ul><p><img data-src="../../../asset/2025/03/rabbitmq-8.png"></p><h4 id="发布-订阅模式"><a href="#发布-订阅模式" class="headerlink" title="发布 / 订阅模式"></a>发布 / 订阅模式</h4><ul><li>这种模式（共享资源 - 将消息同时发送给多个消费者）有一个生产者、一个交换机、多个队列、多个消费者，也被称为 “交换机模式”。</li><li>每个消费队列中的消息内容都一致，且每个消费者都会从自己的消息队列的第一个消息开始消费，直到最后一个消息。</li><li>交换机是 RabbitMQ 中的内部组件。消息生产者将消息发送给 RabbitMQ 后，RabbitMQ 会根据订阅的消费者个数，自动生成对应数量的消息队列，这样每个消费者都能获取生产者发送的全部消息。</li><li>实际上，前两种模式也使用了交换机，只是使用了采用默认设置的交换机。交换机参数是可以配置的，如果消息配置的交换机参数和 RabbitMQ 队列绑定（Binding）的交换机名称相同，则转发消息，否则丢弃消息。</li><li>存在隐患：一旦消费者断开与 RabbitMQ 的连接，队列就会消失。如果消费者数目很多，对于 RabbitMQ 而言，也是个重大负担；因为发布 / 订阅模式是个长连接，占用并发数，且每个消费者分配一个队列会占用大量资源。</li><li>应用场景：邮件群发、群聊、广播通信。</li></ul><p><img data-src="../../../asset/2025/03/rabbitmq-9.png"></p><h4 id="路由模式"><a href="#路由模式" class="headerlink" title="路由模式"></a>路由模式</h4><ul><li>这种模式（选择性地接收消息）有一个生产者、一个交换机、多个队列、多个消息消费者，也被称为 “Routing 转发模式”。</li><li>一个交换机绑定多个消息队列，每个消息队列都有自己唯一的 RoutingKey，每一个消息队列都被一个消费者监听。</li><li>消息生产者将消息发送给交换机，交换机按照路由的 Key 进行判断，将消息推送到与之绑定的队列。即交换机根据路由的 Key，匹配上路由键（RoutingKey） 对应的消息队列，最后由监听队列的消费者消费消息。</li></ul><p><img data-src="../../../asset/2025/03/rabbitmq-10.png"></p><h4 id="主题模式"><a href="#主题模式" class="headerlink" title="主题模式"></a>主题模式</h4><ul><li>这种模式（基于 Topic 接收消息）有一个生产者、一个交换机、多个队列、多个消息消费者，也被称为 “主题转发模式” 或者 “模糊匹配队列模式”，本质上是路由模式的一种（只是在路由功能的基础上增加了模糊匹配）。</li><li>一个交换机绑定多个消息队列，每个消息队列都有自己唯一的 RoutingKey，每一个消息队列都被一个消费者监听。</li><li>每个消息队列自己唯一的 Routekey 不是一个确定值，更像是正则表达式对应的匹配规则。</li><li>消息生产者将消息发送给交换机，交换机根据 RoutingKey 模糊匹配到对应的队列，由监听队列的消费者消费消息。</li><li>路由模糊匹配的规则：<ul><li><code>#</code> 和 <code>*</code> 都是代表通配符。</li><li><code>*</code> 代表一个单词，<code>#</code> 代表零个或多个单词。</li></ul></li></ul><p><img data-src="../../../asset/2025/03/rabbitmq-11.png"></p><h4 id="RPC-模式"><a href="#RPC-模式" class="headerlink" title="RPC 模式"></a>RPC 模式</h4><p>RPC 即客户端远程调用服务端的方法，使用 RabbitMQ 可以实现 RPC 的异步调用，基于 Direct 交换机实现。</p><ul><li><p><strong>RPC 模式的核心组件</strong></p><ul><li>Direct 交换机<ul><li>通过精确匹配路由键（RoutingKey）实现消息路由，确保请求消息与响应消息能准确传递到目标队列‌。</li><li>每个 RPC 客户端需创建一个‌独立的回调队列‌（Callback Queue），并绑定到 Direct 交换机，绑定时的路由键（RoutingKey）需唯一（通常为队列名称）‌。</li></ul></li><li>‌队列与路由逻辑‌<ul><li>‌请求流程‌：客户端发送请求消息时，需指定回调队列的路由键（RoutingKey）。</li><li>‌响应流程‌：服务端消费消息后，通过 Direct 交换机和回调队列的路由键（RoutingKey），将响应精准返回给对应的客户端‌。</li><li>临时队列管理‌：建议客户端使用自动删除的临时队列作为回调队列，避免资源浪费‌。</li></ul></li></ul></li><li><p><strong>RPC 模式的工作流程</strong></p><ul><li>(1) 客户端即是生产者也是消费者，客户端生成唯一的回调队列，并监听该队列。</li><li>(2) 客户端发送请求消息到服务端的请求队列，消息头包含 <code>reply_to</code>（回调队列的路由键）和 <code>correlation_id</code>（请求唯一标识）。</li><li>(3) 服务端从请求队列中消费消息，处理完消息后通过 Direct 交换机将响应结果发送到 <code>reply_to</code> 指定的回调队列。</li><li>(4) 客户端监听回调队列，根据 <code>correlation_id</code> 匹配响应与请求，完成远程调用‌。</li></ul></li></ul><p><img data-src="../../../asset/2025/03/rabbitmq-12.png"></p><h4 id="发布者确认模式"><a href="#发布者确认模式" class="headerlink" title="发布者确认模式"></a>发布者确认模式</h4><ul><li>这种模式是 RabbitMQ 确保消息可靠投递的机制。</li><li>生产者发送消息后，Broker 会异步返回 ACK（<code>channel.basicAck()</code>）表示消息已被接收并处理（如持久化到磁盘），若因故障或无法路由导致失败则返回 Nack（<code>channel.basicNack()</code>）。</li><li>相比事务机制，该模式性能更高，适用于要求消息严格防丢失的场景，需要通过 <code>channel.confirmSelect()</code> 启用并监听确认结果，常配合消息持久化、重试等策略一起使用。</li></ul><h2 id="消息处理"><a href="#消息处理" class="headerlink" title="消息处理"></a>消息处理</h2><h3 id="使用自定义消息转换器"><a href="#使用自定义消息转换器" class="headerlink" title="使用自定义消息转换器"></a>使用自定义消息转换器</h3><p>业务之间大多数数据都是以 JSON 的数据格式进行传输的，即生产者服务将 JSON 类型的数据发送到对应的队列，而消费端从队列中接收到的数据类型也是 JSON 类型。为了方便将 POJO 对象转为 JSON 类型的数据来传输，可以使用 Spring 内置的 <code>Jackson2JsonMessageConverter</code> 消息转换器，具体代码如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.config.SimpleRabbitListenerContainerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.ConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitAdmin;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.support.converter.Jackson2JsonMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.support.converter.MessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMqConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * RabbitMQ的管理对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> connectionFactory</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RabbitAdmin <span class="title">rabbitAdmin</span><span class="params">(ConnectionFactory connectionFactory)</span> </span>{</span><br><span class="line">        RabbitAdmin rabbitAdmin = <span class="keyword">new</span> RabbitAdmin(connectionFactory);</span><br><span class="line">        <span class="keyword">return</span> rabbitAdmin;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * RabbitMq的消息转换器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MessageConverter <span class="title">jsonMessageConverter</span><span class="params">()</span> </span>{</span><br><span class="line">        Jackson2JsonMessageConverter messageConverter = <span class="keyword">new</span> Jackson2JsonMessageConverter();</span><br><span class="line">        <span class="keyword">return</span> messageConverter;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * RabbitMq的模版</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RabbitTemplate <span class="title">rabbitTemplate</span><span class="params">(ConnectionFactory connectionFactory, MessageConverter messageConverter)</span> </span>{</span><br><span class="line">        RabbitTemplate template = <span class="keyword">new</span> RabbitTemplate(connectionFactory);</span><br><span class="line">        <span class="comment">// 设置发送消息时所用的消息转换器</span></span><br><span class="line">        template.setMessageConverter(messageConverter);</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * RabbitMq的监听容器工厂</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SimpleRabbitListenerContainerFactory <span class="title">rabbitListenerContainerFactory</span><span class="params">(ConnectionFactory connectionFactory, MessageConverter messageConverter)</span> </span>{</span><br><span class="line">        SimpleRabbitListenerContainerFactory factory = <span class="keyword">new</span> SimpleRabbitListenerContainerFactory();</span><br><span class="line">        factory.setConnectionFactory(connectionFactory);</span><br><span class="line">        <span class="comment">// 设置线程数</span></span><br><span class="line">        factory.setConcurrentConsumers(<span class="number">3</span>);</span><br><span class="line">        <span class="comment">// 最大线程数</span></span><br><span class="line">        factory.setMaxConcurrentConsumers(<span class="number">10</span>);</span><br><span class="line">        <span class="comment">// 设置接收消息时所用的消息转换器</span></span><br><span class="line">        factory.setMessageConverter(messageConverter);</span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="消息队列任务的平滑关闭"><a href="#消息队列任务的平滑关闭" class="headerlink" title="消息队列任务的平滑关闭"></a>消息队列任务的平滑关闭</h3><ul><li><a target="_blank" rel="external nofollow" href="https://jaesonchen.iteye.com/blog/2342761">Java 消息队列任务的平滑关闭分析</a></li></ul><h2 id="客户端连接"><a href="#客户端连接" class="headerlink" title="客户端连接"></a>客户端连接</h2><h3 id="客户端-SSL-连接"><a href="#客户端-SSL-连接" class="headerlink" title="客户端 SSL 连接"></a>客户端 SSL 连接</h3><p>RabbitMQ 客户端使用 SSL 证书连接 RabbitMQ 服务器的 Java 示例代码如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.GetResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.KeyManagerFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLContext;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.TrustManagerFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyManagementException;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyStore;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyStoreException;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">import</span> java.security.UnrecoverableKeyException;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.CertificateException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SslConnectionDemo</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> TimeoutException </span>{</span><br><span class="line">        <span class="comment">// 证书路径</span></span><br><span class="line">        String classpath = SslReceiver.class.getResource(<span class="string">"/"</span>).getPath();</span><br><span class="line">        <span class="comment">// 证书密码</span></span><br><span class="line">        <span class="keyword">char</span>[] sslPwd1 = <span class="string">"password1"</span>.toCharArray();</span><br><span class="line">        <span class="keyword">char</span>[] sslPwd2 = <span class="string">"password2"</span>.toCharArray();</span><br><span class="line">        <span class="comment">// 读取client密钥和rabbitStore证书</span></span><br><span class="line">        <span class="keyword">try</span> (InputStream sslCardStream = <span class="keyword">new</span> FileInputStream(classpath + <span class="string">"ssl/keycert.p12"</span>);</span><br><span class="line">             InputStream rabbitStoreStream = <span class="keyword">new</span> FileInputStream(classpath + <span class="string">"ssl/rabbitStore"</span>)) {</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 加载秘钥</span></span><br><span class="line">            KeyStore ks = KeyStore.getInstance(<span class="string">"PKCS12"</span>);</span><br><span class="line">            ks.load(sslCardStream, sslPwd1);</span><br><span class="line">            KeyManagerFactory keyManagerFactory = KeyManagerFactory.getInstance(<span class="string">"SunX509"</span>);</span><br><span class="line">            keyManagerFactory.init(ks, sslPwd1);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 读取授权证书，只含有服务端的公钥</span></span><br><span class="line">            KeyStore jks = KeyStore.getInstance(<span class="string">"JKS"</span>);</span><br><span class="line">            jks.load(rabbitStoreStream, sslPwd2);</span><br><span class="line">            TrustManagerFactory keyStoreManager = TrustManagerFactory.getInstance(<span class="string">"SunX509"</span>);</span><br><span class="line">            keyStoreManager.init(jks);</span><br><span class="line">            SSLContext context = SSLContext.getInstance(<span class="string">"TLSv1.2"</span>);</span><br><span class="line">            context.init(keyManagerFactory.getKeyManagers(), keyStoreManager.getTrustManagers(), <span class="keyword">null</span>);</span><br><span class="line">            ConnectionFactory factory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">            <span class="comment">// RabbitMQ的登录账号与密码</span></span><br><span class="line">            factory.setUsername(<span class="string">"yourUserName"</span>);</span><br><span class="line">            factory.setPassword(<span class="string">"yourPassword"</span>);</span><br><span class="line">            <span class="comment">// RabbitMQ的主机地址</span></span><br><span class="line">            factory.setHost(<span class="string">"127.0.0.1"</span>);</span><br><span class="line">            <span class="comment">// RabbitMQ的SSL端口</span></span><br><span class="line">            factory.setPort(<span class="number">5671</span>);</span><br><span class="line">            factory.setAutomaticRecoveryEnabled(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置sslContext</span></span><br><span class="line">            factory.useSslProtocol(context);</span><br><span class="line">            Connection connection = factory.newConnection();</span><br><span class="line">            Channel channel = connection.createChannel();</span><br><span class="line">            <span class="comment">// 声明RabbitMQ的队列</span></span><br><span class="line">            channel.queueDeclare(<span class="string">"rabbitmq-queue"</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">            channel.basicPublish(<span class="string">""</span>, <span class="string">"rabbitmq-queue"</span>, <span class="keyword">null</span>, <span class="string">"Test,Test"</span>.getBytes());</span><br><span class="line">            GetResponse chResponse = channel.basicGet(<span class="string">"rabbitmq-queue"</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (chResponse == <span class="keyword">null</span>) {</span><br><span class="line">                System.out.println(<span class="string">"No message retrieved"</span>);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">byte</span>[] body = chResponse.getBody();</span><br><span class="line">                System.out.println(<span class="string">"Recieved: "</span> + <span class="keyword">new</span> String(body));</span><br><span class="line">            }</span><br><span class="line">            channel.close();</span><br><span class="line">            connection.close();</span><br><span class="line">        } <span class="keyword">catch</span> (KeyStoreException | UnrecoverableKeyException | KeyManagementException | CertificateException | NoSuchAlgorithmException | IOException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="生产落地实践"><a href="#生产落地实践" class="headerlink" title="生产落地实践"></a>生产落地实践</h2><h3 id="如何保证消息的顺序性"><a href="#如何保证消息的顺序性" class="headerlink" title="如何保证消息的顺序性"></a>如何保证消息的顺序性</h3><blockquote><p>关键点</p></blockquote><ul><li><p>不同 MQ 对消息顺序性的支持</p><ul><li>在 Kafka 和 RabbitMQ 中，无法保证消息的顺序性，需要开发者自己实现。</li><li>在 RocketMQ 中，有完整的针对性设计（原生支持消息的顺序性），可以保证消息的顺序性。</li></ul></li><li><p>全局有序和局部有序</p><ul><li>MQ 通常只需要保证消息在局部有序，而不需要保证消息在全局有序。</li><li>比如，在局部层面上，某个订单的多个消息必须有序的，但在全局层面上，不同订单的消息是不需要保证有序的。这类似微信的聊天窗口，在单个聊天窗口内，多个消息必须是有序的，但在多个聊天窗口中消息不一定是要有序的。</li></ul></li><li><p>生产实践案例分析</p><ul><li>大数据团队需要开发一个 MySQL Binlog 同步系统，要求同步一个 MySQL 库的数据过来，对公司业务系统的数据做各种复杂的分析。那么在 MySQL 里增删改一条数据，对应出来了增删改 3 条 Binlog，接着这三条 Binlog 发送到 MQ 里面。当消费者将消息读取出来依次执行时，这就要保证消息是有序，不然本来依次是增加、修改、删除；搞错顺序后，给执行成删除、修改、增加，这就全乱套了。因为本来这条数据同步过来，最后这条数据应该被删除了；结果搞错了这个顺序，最后这条数据保留下来了，这就造成数据同步出错了。</li></ul></li></ul><blockquote><p>解决方案</p></blockquote><ul><li>要保证一个生产者只对应一个交换机（Exchange），一个交换机只对应一个队列，并且一个队列只对应一个消费者。</li></ul><p><img data-src="../../../asset/2024/11/message-queue-order-1.png"></p><div class="admonition note"><p class="admonition-title">扩展阅读</p><ul><li><a target="_blank" rel="external nofollow" href="https://juejin.cn/post/6844904099540893710">《如何保证消息的顺序性》</a></li><li><a target="_blank" rel="external nofollow" href="https://juejin.cn/post/6844903605221195790">《如何解决消息顺序与消息重复两大硬伤》</a></li></ul></div><h3 id="如何避免消息丢失的问题"><a href="#如何避免消息丢失的问题" class="headerlink" title="如何避免消息丢失的问题"></a>如何避免消息丢失的问题</h3><p>这问题相当于 “如何保证消息的可靠性” 或者 “如何保证消息可靠传输”。消息丢失的问题，可能会出现在生产者、消息队列服务器、消费者中的任一环节。</p><blockquote><p>生产者发送消息丢失</p></blockquote><p>生产者发送消息后，由于网络故障或网络延迟，可能会导致消息在传输过程中丢失。</p><ul><li><p>解决方案</p><ul><li><p>(1) 使用 RabbitMQ 提供的事务机制</p><ul><li><code>channel.txSelect()</code> 开启事务</li><li><code>channel.txCommit()</code> 提交事务</li><li><code>channel.txRollback()</code> 回滚事务</li><li>生产者在发送数据之前开启事务，然后再发送消息；如果消息没有成功被 RabbitMQ 接收到，那么生产者会出现异常报错，此时就可以回滚事务，然后重试发送消息；如果消息成功被 RabbitMQ 接收到，那么就可以提交事务。</li><li>特别注意，事务机制是同步的，生产者发送消息后会同步阻塞，也就是会一直等待直到 RabbitMQ 返回响应，这往往会导致 MQ 的吞吐量大大下降。</li></ul></li><li><p>(2) 使用 RabbitMQ 提供的生产者确认机制（Confirm）</p><ul><li>在生产者那里设置开启 Confirm 机制之后，每次写消息的时候都会分配一个唯一的 ID，然后将消息写入了 RabbitMQ 后，RabbitMQ 会回调你提供的一个 ACK 回调通知函数，告诉你这个消息成功被接收到了。如果 RabbitMQ 没能处理这个消息，会回调你提供的一个 NACK 回调通知函数，告诉你这个消息接收失败，此时你可以重试发送消息。另外，你还可以结合这个确认机制（Confirm），自己在内存里维护每个消息 ID 的状态，如果超过一定时间还没接收到这个消息的回调通知，那么你就可以重新发送消息。</li><li>RabbitMQ 的事务机制和 Cnofirm 机制最大的不同在于，事务机制是同步的，生产者提交一个事务之后就会阻塞在那里；但是 Confirm 机制是异步的，生产者发送个消息之后就可以继续发送下一个消息，然后那个消息被 RabbitMQ 成功接收到之后，会异步回调你提供的一个回调通知函数来通知你这个消息被成功接收到了。所以，如果希望在生产者这边避免数据丢失的话，一般都是用 Confirm 机制，因为它是异步非阻塞的。</li></ul></li></ul></li></ul><blockquote><p>MQ 服务器消息同步丢失</p></blockquote><p>在 MQ 集群中，多个节点之间同步消息时，可能会发生消息丢失。</p><ul><li>问题发生<ul><li>在普通集群中，消息是分散存储在不同的节点上，节点之间不会主动进行消息同步，当存储消息的节点宕机了，这可能会丢失消息</li></ul></li><li>解决方案<ul><li>使用镜像集群，因为镜像集群会在节点之间主动进行消息同步，这样消息的可靠性可以得到提高</li></ul></li></ul><blockquote><p>MQ 服务器消息存盘丢失</p></blockquote><p>MQ 服务器将内存中的数据持久化到硬盘时，可能会发生消息丢失（比如 MQ 在持久化之前意外宕机）。</p><ul><li>解决方案<ul><li> (1) 使用持久化队列<ul><li>当使用 RabbitMQ 的持久化队列后，消息写入之后会持久化到磁盘，哪怕是 RabbitMQ 宕机了，恢复之后会自动读取之前存储的数据，这样数据一般就不会丢失。除非极其罕见的是，RabbitMQ 还没来得及持久化，自己就宕机了，这可能导致少量数据会丢失，但是这个概率比较小。</li><li>使用持久化队列有两个设置步骤，第一个是在创建队列时将其设置为持久化的，这样就可以保证 RabbitMQ 会持久化队列的元数据，但是这并不会持久化队列里的数据；第二个是发送消息的时候将消息的 <code>deliveryMode</code> 设置为 <code>2</code>，表示将消息设置为持久化，这样 RabbitMQ 就会将消息持久化到磁盘。特别注意，必须执行这两个持久化步骤才行，缺一不可，这样哪怕 RabbitMQ 宕机了，再次重启后，也可以从磁盘上恢复队列里的数据。</li><li>持久化队列可以跟生产者那边的确认机制（Confirm）配合起来使用，只有消息被持久化到磁盘之后，RabbitMQ 才会给生产者回传 ACK 消息。所以，哪怕是在消息持久化到磁盘之前，RabbitMQ 宕机了，数据丢失了，生产者接收不到消息被成功接收的 ACK 消息，生产者还可以重新发送消息。</li></ul></li><li>(2) 使用 Quorum 队列（仲裁队列）<ul><li>Quorum 队列采用 Raft 一致性协议进行消息持久化，从 3.8.0 版本开始才支持。</li></ul></li></ul></li></ul><blockquote><p>消费者消费消息丢失</p></blockquote><p>消费者拉取消息后，需要处理业务，这期间可能会发生消息丢失。</p><ul><li><p>问题发生</p><ul><li>消费者之所以会丢失消息，主要是开启了 RabbitMQ 的自动 ACK 功能。一旦使用了自动 ACK 功能，在消费者消费的时候，刚拉取消息，还没来得及处理完业务逻辑，消费者就自动发送 ACK 消息，此时应用进程突然宕机了（比如重启），那么 RabbitMQ 就会认为消息已经被消费，这样消息就丢失了。</li></ul></li><li><p>解决方案</p><ul><li>关闭自动 ACK，使用手动 ACK<ul><li> 关闭 RabbitMQ 自动 ACK 功能，调用一个 API 就可以关闭；然后每次你确保执行完业务处理后，手动执行 ACK 操作。这样的话，如果应用还没来得及处理完业务就宕机了，自然就不会再发送 ACK 消息；那么 RabbitMQ 就会认为你还没处理完业务，这个时候 RabbitMQ 会把这个消息重新分配给别的消费者去处理，消息是不会丢的。</li></ul></li></ul></li></ul><div class="admonition note"><p class="admonition-title">扩展阅读</p><ul><li><a target="_blank" rel="external nofollow" href="https://juejin.cn/post/6844904096894304269">《如何保证消息的可靠性传输》</a></li><li><a target="_blank" rel="external nofollow" href="https://juejin.cn/post/7022530252857409550">《如何回答消息队列的丢失、重复与积压问题》</a></li></ul></div><h3 id="如何保证消息队列的高可用性"><a href="#如何保证消息队列的高可用性" class="headerlink" title="如何保证消息队列的高可用性"></a>如何保证消息队列的高可用性</h3><p>RabbitMQ 是基于主从实现高可用性的，它有三种模式：单机模式、普通集群模式、镜像集群模式。</p><blockquote><p>单机模式</p></blockquote><ul><li>概述<ul><li>单机模式是 RabbitMQ 最简单的部署方式，即在单台机器上运行一个 RabbitMQ 实例。所有的队列和消息都存放在这台机器上，适合开发、测试等应用场景。单机模式没有集群的冗余和容错特性，因此在生产环境中不推荐使用。</li></ul></li><li>特点<ul><li>配置简单，部署快速。</li><li>没有容错能力，服务器宕机会导致消息服务不可用。</li></ul></li><li>适用场景<ul><li>适合开发、测试环境，或对消息队列要求不高的小型项目。</li></ul></li></ul><blockquote><p>普通集群模式</p></blockquote><ul><li>概述<ul><li>普通集群模式是由多个 RabbitMQ 实例组成的一个集群。集群中的每个节点都会维护队列的元数据，但队列中的消息只存储在一个节点上，其他节点只存储该队列的元数据。这意味着，如果队列所在的节点故障，那么该队列的消息将会丢失，无法自动恢复。</li><li>大概意思就是在多台机器上部署多个 RabbitMQ 实例，你创建的队列只会放在一个 RabbitMQ 实例上，不过每个实例都会同步队列的元数据（元数据可以认为是队列的一些配置信息，通过元数据可以找到队列所在的实例），但队列中消息本身不复制到其他节点。当客户端消费的时候，如果队列就在自己所连接的 RabbitMQ 实例中，那么就可以直接消费消息；如果队列不在自己所连接的 RabbitMQ 实例中，那么就要从另一个 RabbitMQ 实例的队列中拉取消息过来再消费。</li><li>这种集群模式没做到真正的分布式，就是一个普通的集群。因为这导致消费者要么每次随机连接一个 RabbitMQ 实例，然后可能需要从另一个 RabbitMQ 实例拉取数据；要么固定连接那个队列所在的 RabbitMQ 实例，然后直接消费数据；前者有数据拉取的开销，后者有单实例性能瓶颈。</li><li>另外，如果那个存放队列的 RabbitMQ 实例宕机了，会导致其他实例无法从那个宕机实例拉取数据。如果 RabbitMQ 开启了消息持久化，让 RabbitMQ 落地存储消息的话，消息不一定会丢，但是得等那个宕机实例恢复了，然后才可以继续从那个实例的队列中拉取数据。</li><li>简而言之，RabbitMQ 普通集群模式没有什么所谓的高可用性可言，这方案主要是提高吞吐量的，就是说让集群中多个节点来服务某个队列的读写操作。</li></ul></li><li>特点<ul><li>集群中的节点共享队列元数据，但消息本身不复制到其他节点。</li><li>扩展性较好，能够增加集群节点来支持更大的负载。</li><li>存在单点故障风险，当某个队列所在节点发生故障后，队列中的消息将不可用。</li></ul></li><li>适用场景<ul><li>适合需要一定扩展能力，可以接受一定数据丢失（不强求高可用）的场景。</li></ul></li></ul><p><img data-src="../../../asset/2024/11/message-queue-ha-1.png"></p><blockquote><p>镜像集群模式</p></blockquote><ul><li>概述<ul><li>镜像集群模式是在普通集群模式的基础上增加了消息冗余的能力。通过设置队列为镜像队列（Mirrored Queue），可以将队列的数据同步到多个节点上。在 RabbitMQ 的镜像集群模式中，每个镜像队列都有一个主节点和多个备份节点，当主节点不可用时，其他备份节点可以自动接管服务，从而提高了高可用性。</li><li>这种集群模式，才是所谓的 RabbitMQ 高可用模式，跟普通集群模式不一样的是，你创建的队列，无论是队列的元数据还是队列里的消息都会存在于多个 RabbitMQ 实例上。当你每次写消息到队列的时候，RabbitMQ 都会自动将消息同步到多个实例的队列里。</li><li>这样的好处在于任何一个 RabbitMQ 实例宕机了，其他的实例都可以继续使用。坏处在于，第一，这会导致性能开销很大，消息需要同步到其他机器，导致网络带宽压力和消耗很重；第二，这样就没有扩展性可言了，如果某个队列负载很重，你想增加 RabbitMQ 实例，但新增的实例也包含了这个队列的所有数据，也就是没有办法线性扩展这个队列。思考一下，如果这个队列的数据量很大，大到在这台机器上无法容纳了，此时该怎么办呢？</li><li>那么怎么开启镜像集群模式呢？其实很简单，RabbitMQ 有很好用的管理控制台，就是在控制台新增一个策略，这个策略是镜像集群模式的策略，新增的时候可以要求将消息同步到所有节点，也可以要求将消息同步到指定数量的节点。最后，在你再次创建的队列时候，应用这个策略就可以自动将队列里的消息同步到其他的节点上了。</li></ul></li><li>特点<ul><li>队列数据会复制到多个节点，具备高可用性，适合生产环境。</li><li>节点故障时可以自动切换，确保消息的持久性和可用性。</li><li>消耗更多的资源，增加了系统的 I/O 负担，因此性能会受到一定影响。</li></ul></li><li>适用场景<ul><li>适合对高可用性要求高、数据不允许丢失、需要容灾的场景。</li></ul></li></ul><p><img data-src="../../../asset/2024/11/message-queue-ha-2.png"></p><h3 id="如何解决消息大量积压的问题"><a href="#如何解决消息大量积压的问题" class="headerlink" title="如何解决消息大量积压的问题"></a>如何解决消息大量积压的问题</h3><blockquote><p>消息积压的概述</p></blockquote><p>消息积压指的是消息在消息队列中堆积而未能及时处理的情况。消息的积压主要来自于两方面：要么消息生产变快了，要么消息消费变慢了。</p><ul><li>监控发现，生产和消费消息的速度没什么变化，出现消息积压的情况，检查是有消费失败反复消费的情况。</li><li>监控发现，消费消息的速度变慢，检查消费实例，日志中是否有大量消费错误、消费线程是否死锁、是否卡在某些资源上。</li><li>单位时间内发送的消息增多，比如赶上大促或者抢购，短时间内不太可能优化消费端的代码来提升消费性能，但可以<strong>通过扩容消费端的实例数来提升总体的消费能力</strong>。</li><li>如果短时间内没有服务器资源扩容，可以<strong>将系统降级，通过关闭某些不重要的业务，减少消息发送的数据量，最低限度让系统还能正常运转，保证核心业务的可用性</strong>。</li><li>严重影响 MQ 甚至整个系统时，可以考虑<strong>临时启用多个消费者，并发接收消息，同时持久化消息（比如写入数据库），过段时间再将持久化的消息重新写回 MQ 中进行消费，或者极端情况下直接丢弃消息</strong>。</li></ul><blockquote><p>消息积压的解决方案</p></blockquote><p>可以使用扩容来解决消息积压的问题，比如利用临时消费者，消费原来积压在队列中的消息。该消费者不做任何耗时的操作，将消息均匀写入新创建的队列里，最后将更多 Consumer 部署到更多的机器上消费新创建队列上的消息。等待积压的消息被消费，恢复到正常状态后，撤掉扩容服务器。具体步骤和思路如下：</p><ul><li>(1) 先修复 Consumer 的问题，确保其恢复正常的消费速度，然后将现有的 Consumer 都停掉</li><li> (2) 临时建立好原先 10 倍或者 20 倍的 Queue 数量</li><li> (3) 写一个临时的分发消息的 Consumer 程序，将这个程序部署上去消费积压的消息，消费之后不做任何耗时的处理，直接均匀轮询写入临时建立好的 10 倍数量的 Queue</li><li>(4) 接着临时征用 10 倍机器来部署 Consumer 实例，每一个（或者一批） Consumer 消费一个临时 Queue 的数据</li><li> (5) 等积压的数据都被消费完之后，恢复原先的部署架构，重新用原先的 Consumer 机器来消费消息</li></ul><p>这种做法相当于临时将 Queue 资源和 Consumer 资源扩大了 10 倍，即以正常的 10 倍速度消费积压的消息，如下图所示：</p><p><img data-src="../../../asset/2024/11/mq-expansion.png"></p><h3 id="如何解决消息队列的过期失效问题"><a href="#如何解决消息队列的过期失效问题" class="headerlink" title="如何解决消息队列的过期失效问题"></a>如何解决消息队列的过期失效问题</h3><p>假设用的是 RabbitMQ，由于 RabbitMQ 是可以设置过期时间的（TTL），如果消息在 Queue 中积压超过一定的时间，就会被 RabbitMQ 清理掉。这个时候就不会有消息被大量积压的问题，而是会有大量的消息丢失了。这种情况下，就不是说要增加 Consumer 消费积压的消息了，因为实际上消息是没有积压的，而是丢了大量的消息。</p><p>可以采取的一个解决方案就是 “批量重导”。当大量的消息积压的时候，由于设置了过期时间，RabbitMQ 会直接丢弃数据，然后等业务高峰期过了之后，例如在晚上 12 点以后，写个临时程序将丢失的那批数据查询出来，然后重新将消息写入 RabbitMQ 里，即把白天丢的消息全部补回来。假设 10000 个订单积压在 RabbitMQ 里面，没有来得及处理掉，其中 2000 个订单都丢了，那么只能手动写个临时程序把那 2000 个订单查询出来，然后手动发送消息到 RabbitMQ 中重新进行消费。</p><h3 id="消息队列的磁盘满了应该怎么处理"><a href="#消息队列的磁盘满了应该怎么处理" class="headerlink" title="消息队列的磁盘满了应该怎么处理"></a>消息队列的磁盘满了应该怎么处理</h3><p>消息积压在 MQ 里，那么如果很长时间都没有处理掉，此时导致 MQ 都快将磁盘写满了，那应该怎么办？这个时候可以写一个临时程序，启用多个消费者，并发消费消息，同时将消息持久化（比如写入数据库），即快速消费掉 MQ 中积压的消息。到凌晨的时候，将持久化的消息重新写回 MQ 中进行消费；如果希望加快已持久化消息的消费速度，可以引入上述的<a href="/posts/869a4db4.html#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E6%B6%88%E6%81%AF%E5%A4%A7%E9%87%8F%E7%A7%AF%E5%8E%8B%E7%9A%84%E9%97%AE%E9%A2%98">消息积压扩容解决方案</a>。</p><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/869a4db4.html" title="RabbitMQ 开发随笔">https://www.techgrow.cn/posts/869a4db4.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%BC%80%E5%8F%91%E9%9A%8F%E7%AC%94/" rel="tag"><i class="fa fa-tag"></i> 开发随笔</a><a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" rel="tag"><i class="fa fa-tag"></i> 消息队列</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/be3a6fb9.html" rel="prev" title="初探 RabbitMQ 使用"><i class="fa fa-angle-left"></i> 初探 RabbitMQ 使用</a></div><div class="post-nav-item"> <a href="/posts/486aeff3.html" rel="next" title="Centos 7 生产环境搭建 RabbitMQ 集群">Centos 7 生产环境搭建 RabbitMQ 集群<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">1.9m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">29:30</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"/lib/mermaid/dist/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/869a4db4.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>