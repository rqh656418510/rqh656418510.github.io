<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍 MyBatis-Plus 的入门教程内容，包括分页插件、乐观锁插件、防全表更新与删除插件等内容。"><meta property="og:type" content="article"><meta property="og:title" content="MyBatis-Plus 入门教程之六"><meta property="og:url" content="https://www.techgrow.cn/posts/315d5197.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍 MyBatis-Plus 的入门教程内容，包括分页插件、乐观锁插件、防全表更新与删除插件等内容。"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2019-07-17T15:12:41.000Z"><meta property="article:modified_time" content="2022-09-15T15:12:41.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="ORM"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.techgrow.cn/posts/315d5197.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/315d5197.html","path":"posts/315d5197.html","title":"MyBatis-Plus 入门教程之六"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>MyBatis-Plus 入门教程之六 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="nav-text">版本说明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MyBatis-Plus-%E6%8F%92%E4%BB%B6%E4%BB%8B%E7%BB%8D"><span class="nav-text">MyBatis-Plus 插件介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#InnerInterceptor-%E6%8E%A5%E5%8F%A3"><span class="nav-text">InnerInterceptor 接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BF%BD%E7%95%A5%E6%8F%92%E4%BB%B6%E6%8B%A6%E6%88%AA%E7%9A%84%E6%B3%A8%E8%A7%A3"><span class="nav-text">忽略插件拦截的注解</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MyBatis-Plus-%E6%8F%92%E4%BB%B6%E4%BD%BF%E7%94%A8"><span class="nav-text">MyBatis-Plus 插件使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MyBatis-Plus-%E5%88%86%E9%A1%B5%E6%8F%92%E4%BB%B6"><span class="nav-text">MyBatis-Plus 分页插件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E9%A1%B5%E6%8F%92%E4%BB%B6%E7%9A%84%E4%BB%8B%E7%BB%8D"><span class="nav-text">分页插件的介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E9%A1%B5%E6%8F%92%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">分页插件的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E5%88%86%E9%A1%B5%E6%8F%92%E4%BB%B6"><span class="nav-text">配置分页插件</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Spring-XML-%E6%96%B9%E5%BC%8F"><span class="nav-text">Spring XML 方式</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#SpringBoot-%E9%85%8D%E7%BD%AE%E7%B1%BB%E6%96%B9%E5%BC%8F"><span class="nav-text">SpringBoot 配置类方式</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#MyBatis-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%96%B9%E5%BC%8F"><span class="nav-text">MyBatis 配置文件方式</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%86%E9%A1%B5%E6%93%8D%E4%BD%9C%EF%BC%88%E5%9F%BA%E4%BA%8E-AR-%E6%A8%A1%E5%BC%8F%EF%BC%89"><span class="nav-text">分页操作（基于 AR 模式）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%86%E9%A1%B5%E6%93%8D%E4%BD%9C%EF%BC%88%E5%9F%BA%E4%BA%8E%E9%80%9A%E7%94%A8-Mapper%EF%BC%89"><span class="nav-text">分页操作（基于通用 Mapper）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%86%E9%A1%B5%E6%93%8D%E4%BD%9C%EF%BC%88%E5%9F%BA%E4%BA%8E%E8%87%AA%E5%AE%9A%E4%B9%89-Mapper-%E6%96%B9%E6%B3%95%EF%BC%89"><span class="nav-text">分页操作（基于自定义 Mapper 方法）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MyBatis-Plus-%E4%B9%90%E8%A7%82%E9%94%81%E6%8F%92%E4%BB%B6"><span class="nav-text">MyBatis-Plus 乐观锁插件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9C%9F%E5%AE%9E%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF"><span class="nav-text">真实业务场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A8%A1%E6%8B%9F%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%94%B9%E5%86%B2%E7%AA%81"><span class="nav-text">模拟数据更改冲突</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B9%90%E8%A7%82%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%B5%81%E7%A8%8B"><span class="nav-text">乐观锁的实现流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B9%90%E8%A7%82%E9%94%81%E6%8F%92%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">乐观锁插件的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%B9%90%E8%A7%82%E9%94%81%E6%8F%92%E4%BB%B6"><span class="nav-text">配置乐观锁插件</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Spring-XML-%E6%96%B9%E5%BC%8F-1"><span class="nav-text">Spring XML 方式</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#SpringBoot-%E9%85%8D%E7%BD%AE%E7%B1%BB%E6%96%B9%E5%BC%8F-1"><span class="nav-text">SpringBoot 配置类方式</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#MyBatis-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%96%B9%E5%BC%8F-1"><span class="nav-text">MyBatis 配置文件方式</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0-Version-%E6%B3%A8%E8%A7%A3"><span class="nav-text">添加 @Version 注解</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Junit-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="nav-text">Junit 单元测试代码</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MyBatis-Plus-%E9%98%B2%E5%85%A8%E8%A1%A8%E6%9B%B4%E6%96%B0%E4%B8%8E%E5%88%A0%E9%99%A4%E6%8F%92%E4%BB%B6"><span class="nav-text">MyBatis-Plus 防全表更新与删除插件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%B2%E5%85%A8%E8%A1%A8%E6%9B%B4%E6%96%B0%E4%B8%8E%E5%88%A0%E9%99%A4%E6%8F%92%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">防全表更新与删除插件的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E9%98%B2%E5%85%A8%E8%A1%A8%E6%9B%B4%E6%96%B0%E4%B8%8E%E5%88%A0%E9%99%A4%E6%8F%92%E4%BB%B6"><span class="nav-text">配置防全表更新与删除插件</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Spring-XML-%E6%96%B9%E5%BC%8F-2"><span class="nav-text">Spring XML 方式</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#SpringBoot-%E9%85%8D%E7%BD%AE%E7%B1%BB%E6%96%B9%E5%BC%8F-2"><span class="nav-text">SpringBoot 配置类方式</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#MyBatis-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%96%B9%E5%BC%8F-2"><span class="nav-text">MyBatis 配置文件方式</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Junit-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-1"><span class="nav-text">Junit 单元测试代码</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">738</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">53</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/315d5197.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="MyBatis-Plus 入门教程之六 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍 MyBatis-Plus 的入门教程内容，包括分页插件、乐观锁插件、防全表更新与删除插件等内容。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> MyBatis-Plus 入门教程之六</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-07-17 23:12:41" itemprop="dateCreated datePublished" datetime="2019-07-17T23:12:41+08:00">2019-07-17</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-09-15 23:12:41" itemprop="dateModified" datetime="2022-09-15T23:12:41+08:00">2022-09-15</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/315d5197.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/315d5197.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>4.1k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>4 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/ed9df8e6.html">MyBatis-Plus 入门教程之一</a></li><li><a href="/posts/3fd3ab84.html">MyBatis-Plus 入门教程之二</a></li><li><a href="/posts/7d8f3d89.html">MyBatis-Plus 入门教程之三</a></li><li><a href="/posts/2cbf33d2.html">MyBatis-Plus 入门教程之四</a></li><li><a href="/posts/c5f15a9c.html">MyBatis-Plus 入门教程之五</a></li><li><a href="/posts/315d5197.html">MyBatis-Plus 入门教程之六</a></li><li><a href="/posts/2aa6fbd1.html">MyBatis-Plus 入门教程之七</a></li></ul><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="版本说明"><a href="#版本说明" class="headerlink" title="版本说明"></a>版本说明</h3><p>本文的教程内容是基于 MyBatis-Plus <code>3.5.2</code> 版本编写的，若你使用的是 <code>2.x</code> 或其他版本，可能会有部分知识点、案例代码不兼容，一切以 MyBatis-Plus 官方文档为准。</p><h2 id="MyBatis-Plus-插件介绍"><a href="#MyBatis-Plus-插件介绍" class="headerlink" title="MyBatis-Plus 插件介绍"></a>MyBatis-Plus 插件介绍</h2><h3 id="InnerInterceptor-接口"><a href="#InnerInterceptor-接口" class="headerlink" title="InnerInterceptor 接口"></a>InnerInterceptor 接口</h3><p>MyBatis-Plus 的插件都是基于 <code>InnerInterceptor</code> 接口来实现的，目前已有的插件：</p><ul><li>分页 - <code>PaginationInnerInterceptor</code></li><li>多租户 - <code>TenantLineInnerInterceptor</code></li><li>动态表名 - <code>DynamicTableNameInnerInterceptor</code></li><li>乐观锁 - <code>OptimisticLockerInnerInterceptor</code></li><li>SQL 性能规范 - <code>IllegalSQLInnerInterceptor</code></li><li>防止全表更新与删除 - <code>BlockAttackInnerInterceptor</code></li></ul><span id="more"></span><div class="admonition warning"><p class="admonition-title">使用多个插件时需要注意顺序关系，建议使用如下顺序</p><ul><li>多租户、动态表名</li><li>分页、乐观锁</li><li> SQL 性能规范、防止全表更新与删除</li><li>总结：对 SQL 进行单次改造的优先放入，不对 SQL 进行改造的最后放入</li></ul></div><h3 id="忽略插件拦截的注解"><a href="#忽略插件拦截的注解" class="headerlink" title="忽略插件拦截的注解"></a>忽略插件拦截的注解</h3><p><code>@InterceptorIgnore</code> 注解可用于忽略插件的拦截，支持注解在 Mapper 上以及 Mapper 方法上，若两者同时存在则 Mapper 方法 比 Mapper 的优先级高。各属性表示对应的插件，支持取值为 <code>true</code> 和 <code>false</code>、<code>1</code> 和 <code>0</code>、<code>on</code> 和 <code>off</code>。属性值返回 <code>true</code> 表示不走插件（在配置了插件的情况下，不填则默认表示 <code>false</code>）。属性列表如下：</p><table><thead><tr><th>属性名</th><th>类型</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td> tenantLine</td><td>String</td><td>“”</td><td> 行级租户</td></tr><tr><td> dynamicTableName</td><td>String</td><td>“”</td><td> 动态表名</td></tr><tr><td> blockAttack</td><td>String</td><td>“”</td><td> 攻击 SQL 阻断解析器，防止全表更新与删除</td></tr><tr><td> illegalSql</td><td>String</td><td>“”</td><td> 垃圾 SQL 拦截</td></tr></tbody></table><blockquote><p>更多的使用说明详见 <code>@InterceptorIgnore</code> 注解的源码注释</p></blockquote><h2 id="MyBatis-Plus-插件使用"><a href="#MyBatis-Plus-插件使用" class="headerlink" title="MyBatis-Plus 插件使用"></a>MyBatis-Plus 插件使用</h2><p>本节所需的案例代码，可以直接从 <a target="_blank" rel="external nofollow" href="https://github.com/rqh656418510/mybatis-code/tree/main/mybatis-plus-study">GitHub</a> 下载对应章节 <code>mybatis-plus-lesson-07</code>。</p><h3 id="MyBatis-Plus-分页插件"><a href="#MyBatis-Plus-分页插件" class="headerlink" title="MyBatis-Plus 分页插件"></a>MyBatis-Plus 分页插件</h3><h4 id="分页插件的介绍"><a href="#分页插件的介绍" class="headerlink" title="分页插件的介绍"></a>分页插件的介绍</h4><p><code>PaginationInnerInterceptor</code> 分页拦截器类的属性说明如下：</p><table><thead><tr><th>属性名</th><th>类型</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td> overflow</td><td>boolean</td><td>false</td><td> 溢出总页数后是否进行处理 (默认不处理，参见 <code>插件#continuePage</code> 方法)</td></tr><tr><td>maxLimit</td><td>Long</td><td></td><td> 单页分页条数限制 (默认无限制，参见 <code>插件#handlerLimit</code> 方法)</td></tr><tr><td>dbType</td><td>DbType</td><td></td><td> 数据库类型 (根据类型获取应使用的分页方言，参见 <code>插件#findIDialect</code> 方法)</td></tr><tr><td>dialect</td><td>IDialect</td><td></td><td> 方言实现类 (参见 <code>插件#findIDialect</code> 方法)</td></tr></tbody></table><div class="admonition warning"><p class="admonition-title">注意</p><ul><li>建议单一数据库类型的均设置 <code>dbType</code> 属性，避免每次分页都去抓取数据库类型</li><li>生成 <code>countSql</code> 会在 <code>left join</code> 的表不参与 <code>where</code> 条件的情况下，把 <code>left join</code> 优化掉</li><li>所以建议任何带有 <code>left join</code> 的 SQL，都写成标准 SQL，即给于表一个别名，字段也要 <code>别名.字段</code></li></ul></div><h4 id="分页插件的使用"><a href="#分页插件的使用" class="headerlink" title="分页插件的使用"></a>分页插件的使用</h4><div class="admonition note"><p class="admonition-title">分页插件的配置步骤</p><p>只需要使用 Spring XML 方式、 SpringBoot 配置类方式或者 MyBatis 配置文件方式中的任意一种配置乐观锁插件即可。</p></div><h5 id="配置分页插件"><a href="#配置分页插件" class="headerlink" title="配置分页插件"></a>配置分页插件</h5><p>注入 <code>MybatisPlusInterceptor</code> 类，并配置 <code>PaginationInnerInterceptor</code> 拦截器。</p><h6 id="Spring-XML-方式"><a href="#Spring-XML-方式" class="headerlink" title="Spring XML 方式"></a>Spring XML 方式</h6><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"sqlSessionFactory"</span> <span class="attr">class</span>=<span class="string">"com.baomidou.mybatisplus.extension.spring.MybatisSqlSessionFactoryBean"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"plugins"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"mybatisPlusInterceptor"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"mybatisPlusInterceptor"</span> <span class="attr">class</span>=<span class="string">"com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"interceptors"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"paginationInnerInterceptor"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"paginationInnerInterceptor"</span> <span class="attr">class</span>=<span class="string">"com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"dbType"</span> <span class="attr">value</span>=<span class="string">"MYSQL"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h6 id="SpringBoot-配置类方式"><a href="#SpringBoot-配置类方式" class="headerlink" title="SpringBoot 配置类方式"></a>SpringBoot 配置类方式</h6><ul><li>配置类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MyBatis-Plus 配置类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan("com.clay.mybatis.dao")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisPlusConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 添加 MyBatis-Plus 分页插件</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> MybatisPlusInterceptor <span class="title">mybatisPlusInterceptor</span><span class="params">()</span> </span>{</span><br><span class="line">		MybatisPlusInterceptor interceptor = <span class="keyword">new</span> MybatisPlusInterceptor();</span><br><span class="line">		interceptor.addInnerInterceptor(<span class="keyword">new</span> PaginationInnerInterceptor(DbType.MYSQL));</span><br><span class="line">		<span class="keyword">return</span> interceptor;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>若 MyBatis-Plus 使用的是较低的版本（例如 <code>3.3.1</code>），则配置类的写法如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MyBatis-Plus 配置类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan("com.clay.mybatis.dao")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisPlusConfiguration</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分页插件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PaginationInterceptor <span class="title">paginationInterceptor</span><span class="params">()</span> </span>{</span><br><span class="line">        PaginationInterceptor paginationInterceptor = <span class="keyword">new</span> PaginationInterceptor();</span><br><span class="line">        paginationInterceptor.setDbType(DbType.MYSQL);</span><br><span class="line">        <span class="keyword">return</span> paginationInterceptor;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>启动类</li></ul><div class="admonition note"><p class="admonition-title">提示</p><p>特殊情况下，可能还需要在启动类上通过 <code>@ComponentScan</code> 注解来扫描上面定义的 <code>MybatisPlusConfig</code> 配置类。</p></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@ComponentScan("com.clay.mybatis")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisPlusApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">		SpringApplication.run(MyBatisPlusApplication.class, args);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h6 id="MyBatis-配置文件方式"><a href="#MyBatis-配置文件方式" class="headerlink" title="MyBatis 配置文件方式"></a>MyBatis 配置文件方式</h6><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- property 的配置说明详见 MybatisPlusInterceptor.setProperties() 的源码方法注释 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugin</span> <span class="attr">interceptor</span>=<span class="string">"com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"@page"</span> <span class="attr">value</span>=<span class="string">"com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor"</span>/&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"page:dbType"</span> <span class="attr">value</span>=<span class="string">"mysql"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h5 id="分页操作（基于-AR-模式）"><a href="#分页操作（基于-AR-模式）" class="headerlink" title="分页操作（基于 AR 模式）"></a>分页操作（基于 AR 模式）</h5><p>MyBatis-Plus 分页插件支持在 <a href="/posts/7d8f3d89.html#ActiveRecord-%E6%A8%A1%E5%BC%8F">ActiveRecord</a> 模式下使用，示例代码如下。</p><ul><li>实体类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Employee</span> <span class="keyword">extends</span> <span class="title">Model</span>&lt;<span class="title">Employee</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Long id;</span><br><span class="line">	<span class="keyword">private</span> String lastName;</span><br><span class="line">	<span class="keyword">private</span> String gender;</span><br><span class="line">	<span class="keyword">private</span> String email;</span><br><span class="line">	<span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">	....</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Serializable <span class="title">pkVal</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.id;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Mapper 接口</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EmployeeMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">Employee</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Junit 测试代码</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PagePluginTest</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 基于 ActiveRecord 模式的分页查询</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectByPageForAR</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="comment">// 分页信息</span></span><br><span class="line">		Page&lt;Employee&gt; page = <span class="keyword">new</span> Page&lt;&gt;(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 查询条件</span></span><br><span class="line">		QueryWrapper&lt;Employee&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">		wrapper.eq(<span class="string">"gender"</span>, <span class="string">"1"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 执行分页查询</span></span><br><span class="line">		Employee employee = <span class="keyword">new</span> Employee();</span><br><span class="line">		employee.selectPage(page, wrapper);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 获取分页结果</span></span><br><span class="line">		List&lt;Employee&gt; list = page.getRecords();</span><br><span class="line">		list.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 获取分页信息</span></span><br><span class="line">		System.out.println(<span class="string">"总页数： "</span> + page.getPages());</span><br><span class="line">		System.out.println(<span class="string">"总记录数： "</span> + page.getTotal());</span><br><span class="line">		System.out.println(<span class="string">"当前的页码： "</span> + page.getCurrent());</span><br><span class="line">		System.out.println(<span class="string">"每页的记录数： "</span> + page.getSize());</span><br><span class="line">		System.out.println(<span class="string">"是否有上一页： "</span> + page.hasPrevious());</span><br><span class="line">		System.out.println(<span class="string">"是否有下一页： "</span> + page.hasNext());</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>执行上面的测试代码后，控制台输出的日志信息如下：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">==&gt;  Preparing: SELECT COUNT(*) AS total FROM t_employee WHERE (gender = ?)</span><br><span class="line">==&gt; Parameters: 1(String)</span><br><span class="line">&lt;==    Columns: total</span><br><span class="line">&lt;==        Row: 4</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line"></span><br><span class="line">==&gt;  Preparing: SELECT id,email,last_name,gender,age FROM t_employee WHERE (gender = ?) LIMIT ?,?</span><br><span class="line">==&gt; Parameters: 1(String), 2(Long), 2(Long)</span><br><span class="line">&lt;==    Columns: id, email, last_name, gender, age</span><br><span class="line">&lt;==        Row: 3, jim@gmail.com, Jim, 1, 26</span><br><span class="line">&lt;==        Row: 4, peter@gmail.com, Peter, 1, 29</span><br><span class="line">&lt;==      Total: 2</span><br><span class="line"></span><br><span class="line">Employee [id=3, lastName=Jim, gender=1, email=jim@gmail.com, age=26]</span><br><span class="line">Employee [id=4, lastName=Peter, gender=1, email=peter@gmail.com, age=29]</span><br><span class="line">总页数： 2</span><br><span class="line">总记录数： 4</span><br><span class="line">当前的页码： 2</span><br><span class="line">每页的记录数： 2</span><br><span class="line">是否有上一页： true</span><br><span class="line">是否有下一页： false</span><br></pre></td></tr></tbody></table></figure><h5 id="分页操作（基于通用-Mapper）"><a href="#分页操作（基于通用-Mapper）" class="headerlink" title="分页操作（基于通用 Mapper）"></a>分页操作（基于通用 Mapper）</h5><p>MyBatis-Plus 分页插件支持通用 Mapper 的使用，示例代码如下。</p><ul><li>Mapper 接口</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EmployeeMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">Employee</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Junit 测试代码</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PagePluginTest</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> EmployeeMapper empMapper;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 基于通用 Mapper 的分页查询</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectByPage</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="comment">// 分页信息</span></span><br><span class="line">		Page&lt;Employee&gt; page = <span class="keyword">new</span> Page&lt;&gt;(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 查询条件</span></span><br><span class="line">		QueryWrapper&lt;Employee&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">		wrapper.eq(<span class="string">"gender"</span>, <span class="string">"1"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 执行分页查询</span></span><br><span class="line">		empMapper.selectPage(page, wrapper);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 获取分页结果</span></span><br><span class="line">		List&lt;Employee&gt; list = page.getRecords();</span><br><span class="line">		list.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 获取分页信息</span></span><br><span class="line">		System.out.println(<span class="string">"总页数： "</span> + page.getPages());</span><br><span class="line">		System.out.println(<span class="string">"总记录数： "</span> + page.getTotal());</span><br><span class="line">		System.out.println(<span class="string">"当前的页码： "</span> + page.getCurrent());</span><br><span class="line">		System.out.println(<span class="string">"每页的记录数： "</span> + page.getSize());</span><br><span class="line">		System.out.println(<span class="string">"是否有上一页： "</span> + page.hasPrevious());</span><br><span class="line">		System.out.println(<span class="string">"是否有下一页： "</span> + page.hasNext());</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h5 id="分页操作（基于自定义-Mapper-方法）"><a href="#分页操作（基于自定义-Mapper-方法）" class="headerlink" title="分页操作（基于自定义 Mapper 方法）"></a>分页操作（基于自定义 Mapper 方法）</h5><p>MyBatis-Plus 分页插件支持自定义 Mapper 方法的分页查询，示例代码如下。</p><ul><li>Mapper 接口</li></ul><div class="admonition note"><p class="admonition-title">提示</p><p>1、自定义 Mapper 方法时，需要指定返回值的类型为 <code>IPage</code> 或 <code>List</code>，同时还需要指定其中的一个方法参数的类型为 <code>IPage</code><br> 2、若自定义 Mapper 方法的返回类型是 <code>IPage</code>，则入参的 <code>IPage</code> 不能为 <code>null</code>，因为返回的 <code>IPage</code> 等于入参的 <code>IPage</code>；如果想临时不分页，可以在初始化 <code>IPage</code> 时指定 <code>size</code> 属性为小于零的值即可<br> 3、若自定义 Mapper 方法的返回类型是 <code>List</code>，则入参的 <code>IPage</code> 可以为 <code>null</code>（为 <code>null</code> 则表示不分页）<br> 4、若在 SQL 映射文件中，需要从 <code>page</code> 对象里取值，可以使用 <code>page.属性名</code> 的方式来获取<br></p></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EmployeeMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">Employee</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 第一种方式：方法的返回值为 IPage 类型</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> page</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> gender</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">IPage&lt;Employee&gt; <span class="title">queryByPage</span><span class="params">(IPage&lt;Employee&gt; page, <span class="meta">@Param("gender")</span> String gender)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 第二种方式：方法的返回值为 List 类型</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> page</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> gender</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">List&lt;Employee&gt; <span class="title">queryListByPage</span><span class="params">(IPage&lt;Employee&gt; page, <span class="meta">@Param("gender")</span> String gender)</span></span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>SQL 映射文件</li></ul><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.clay.mybatis.dao.EmployeeMapper"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryByPage"</span> <span class="attr">resultType</span>=<span class="string">"Employee"</span>&gt;</span></span><br><span class="line">		select id, email, last_name as lastName, gender, age</span><br><span class="line">		from t_employee</span><br><span class="line">		where gender = #{gender}</span><br><span class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryListByPage"</span> <span class="attr">resultType</span>=<span class="string">"Employee"</span>&gt;</span></span><br><span class="line">		select id, email, last_name as lastName, gender, age</span><br><span class="line">		from t_employee</span><br><span class="line">		where gender = #{gender}</span><br><span class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><ul><li>Junit 测试代码</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PagePluginTest</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> EmployeeMapper empMapper;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 基于自定义 Mapper 方法（返回值为 IPage）的分页查询</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryByPage</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="comment">// 分页信息</span></span><br><span class="line">		Page&lt;Employee&gt; page = <span class="keyword">new</span> Page&lt;&gt;(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 执行分页查询</span></span><br><span class="line">		empMapper.queryByPage(page, <span class="string">"1"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 获取分页结果</span></span><br><span class="line">		List&lt;Employee&gt; list = page.getRecords();</span><br><span class="line">		list.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 获取分页信息</span></span><br><span class="line">		System.out.println(<span class="string">"总页数： "</span> + page.getPages());</span><br><span class="line">		System.out.println(<span class="string">"总记录数： "</span> + page.getTotal());</span><br><span class="line">		System.out.println(<span class="string">"当前的页码： "</span> + page.getCurrent());</span><br><span class="line">		System.out.println(<span class="string">"每页的记录数： "</span> + page.getSize());</span><br><span class="line">		System.out.println(<span class="string">"是否有上一页： "</span> + page.hasPrevious());</span><br><span class="line">		System.out.println(<span class="string">"是否有下一页： "</span> + page.hasNext());</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 基于自定义 Mapper 方法（返回值为 List）的分页查询</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryListByPage</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="comment">// 分页信息</span></span><br><span class="line">		Page&lt;Employee&gt; page = <span class="keyword">new</span> Page&lt;&gt;(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 执行分页查询</span></span><br><span class="line">		List&lt;Employee&gt; list = empMapper.queryListByPage(page, <span class="string">"1"</span>);</span><br><span class="line">		list.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 获取分页信息</span></span><br><span class="line">		System.out.println(<span class="string">"总页数： "</span> + page.getPages());</span><br><span class="line">		System.out.println(<span class="string">"总记录数： "</span> + page.getTotal());</span><br><span class="line">		System.out.println(<span class="string">"当前的页码： "</span> + page.getCurrent());</span><br><span class="line">		System.out.println(<span class="string">"每页的记录数： "</span> + page.getSize());</span><br><span class="line">		System.out.println(<span class="string">"是否有上一页： "</span> + page.hasPrevious());</span><br><span class="line">		System.out.println(<span class="string">"是否有下一页： "</span> + page.hasNext());</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="MyBatis-Plus-乐观锁插件"><a href="#MyBatis-Plus-乐观锁插件" class="headerlink" title="MyBatis-Plus 乐观锁插件"></a>MyBatis-Plus 乐观锁插件</h3><p>本节所需的案例代码，可以直接从 <a target="_blank" rel="external nofollow" href="https://github.com/rqh656418510/mybatis-code/tree/main/mybatis-plus-study">GitHub</a> 下载对应章节 <code>mybatis-plus-lesson-08</code>。</p><h4 id="真实业务场景"><a href="#真实业务场景" class="headerlink" title="真实业务场景"></a>真实业务场景</h4><p>一件商品，成本价是 80 元，售价是 100 元。老板先是通知小李，说你去把商品价格增加 50 元。小李正在玩游戏，耽搁了一个小时。正好一个小时后，老板觉得商品价格增加到 150 元，价格太高，可能会影响销量。又通知小王，你把商品价格降低 30 元。此时，小李和小王同时操作商品后台系统。小李操作的时候，系统先取出商品价格 100 元；小王也在操作，取出的商品价格也是 100 元。小李将价格加了 50 元，并将 100 + 50 = 150 元存入了数据库；小王将商品减了 30 元，并将 100 - 30 = 70 元存入了数据库。是的，如果没有锁，小李的操作就完全被小王的覆盖了。现在商品价格是 70 元，比成本价低 10 元。几分钟后，这个商品很快出售了 1 千多件商品，老板亏了 1 万多元。如果这里使用乐观锁，在小王保存价格前，可以检查到价格是否被人修改过。如果价格被修改过，则重新取出被修改后的价格（150 元），这样他最终会将 120 元存入数据库。如果是使用悲观锁，在小李取出数据时，小王只能等小李完成价格的更改之后，才能对价格进行操作，这也会保证最终的价格是 120 元。</p><h4 id="模拟数据更改冲突"><a href="#模拟数据更改冲突" class="headerlink" title="模拟数据更改冲突"></a>模拟数据更改冲突</h4><ul><li>创建数据库表</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建数据库表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t_product`</span><br><span class="line">(</span><br><span class="line">  id <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">'主键ID'</span>,</span><br><span class="line">  name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'商品名称'</span>,</span><br><span class="line">  price <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">5</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">'价格'</span>,</span><br><span class="line">  version <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">'乐观锁版本号'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (id)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入表数据</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_product (id, name, price) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">'C++ Primer Plus'</span>, <span class="number">100</span>);</span><br></pre></td></tr></tbody></table></figure><ul><li>实体类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Long id;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> Long version;</span><br><span class="line">	<span class="keyword">private</span> BigDecimal price;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">	</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Mapper 接口</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">Product</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Junit 测试代码</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisPlusApplicationTest</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ProductMapper productMapper;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updatePrice</span><span class="params">()</span> </span>{</span><br><span class="line"></span><br><span class="line">		Product product1 = productMapper.selectById(<span class="number">1L</span>);</span><br><span class="line">		System.out.println(<span class="string">"小李取出的商品价格:"</span> + product1.getPrice());</span><br><span class="line"></span><br><span class="line">		Product product2 = productMapper.selectById(<span class="number">1L</span>);</span><br><span class="line">		System.out.println(<span class="string">"小王取出的商品价格:"</span> + product2.getPrice());</span><br><span class="line"></span><br><span class="line">		product1.setPrice(product1.getPrice().add(<span class="keyword">new</span> BigDecimal(<span class="number">50</span>)));</span><br><span class="line">		<span class="keyword">int</span> result1 = productMapper.updateById(product1);</span><br><span class="line">		System.out.println(<span class="string">"小李修改商品价格的结果: "</span> + (result1 &gt; <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">		product2.setPrice(product2.getPrice().subtract(<span class="keyword">new</span> BigDecimal(<span class="number">30</span>)));</span><br><span class="line">		<span class="keyword">int</span> result2 = productMapper.updateById(product2);</span><br><span class="line">		System.out.println(<span class="string">"小王修改商品价格的结果: "</span> + (result2 &gt; <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">		Product product3 = productMapper.selectById(<span class="number">1L</span>);</span><br><span class="line">		System.out.println(<span class="string">"最终的商品价格: "</span> + product3.getPrice());</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>执行上面的测试代码后，控制台输出的日志信息如下，观察后可发现最终的商品价格并不是预期的 120 元。</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">小李取出的商品价格:100.00000</span><br><span class="line">小王取出的商品价格:100.00000</span><br><span class="line">小李修改商品价格的结果: true</span><br><span class="line">小王修改商品价格的结果: true</span><br><span class="line">最终的商品价格: 70.00000</span><br></pre></td></tr></tbody></table></figure><h4 id="乐观锁的实现流程"><a href="#乐观锁的实现流程" class="headerlink" title="乐观锁的实现流程"></a>乐观锁的实现流程</h4><ul><li>第一步：在数据库表中添加 <code>version</code> 字段</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t_product`</span><br><span class="line">(</span><br><span class="line">  id <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">'主键ID'</span>,</span><br><span class="line">  name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'商品名称'</span>,</span><br><span class="line">  price <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">5</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">'价格'</span>,</span><br><span class="line">  version <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">'乐观锁版本号'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (id)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></tbody></table></figure><ul><li>第二步：读取数据库表记录时，获取当前记录的 <code>version</code>（oldVersion）</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id, name, price, version <span class="keyword">from</span> t_product <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure><ul><li>第三步：更新数据库表记录时，执行 <code>version + 1</code>，如果 <code>where</code> 语句中的 <code>version</code> 版本不满足条件，则更新失败</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update t_product <span class="keyword">set</span> price <span class="operator">=</span> price <span class="operator">+</span> <span class="number">50</span>, version <span class="operator">=</span> version <span class="operator">+</span> <span class="number">1</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> version <span class="operator">=</span> oldVersion;</span><br></pre></td></tr></tbody></table></figure><p>或者可以简单理解为以下的 SQL 语句</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update t_product <span class="keyword">set</span> price <span class="operator">=</span> newPrice, version <span class="operator">=</span> newVersion <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> version <span class="operator">=</span> oldVersion;</span><br></pre></td></tr></tbody></table></figure><h4 id="乐观锁插件的使用"><a href="#乐观锁插件的使用" class="headerlink" title="乐观锁插件的使用"></a>乐观锁插件的使用</h4><div class="admonition note"><p class="admonition-title">乐观锁插件的配置步骤</p><ul><li><code>第一步</code>：使用 Spring XML 方式、 SpringBoot 配置类方式或者 MyBatis 配置文件方式中的任意一种配置乐观锁插件</li><li><code>第二步</code>：在实体类的属性上添加 <code>@Version</code> 注解</li></ul></div><h5 id="配置乐观锁插件"><a href="#配置乐观锁插件" class="headerlink" title="配置乐观锁插件"></a>配置乐观锁插件</h5><p>注入 <code>MybatisPlusInterceptor</code> 类，并配置 <code>OptimisticLockerInnerInterceptor</code> 拦截器。</p><h6 id="Spring-XML-方式-1"><a href="#Spring-XML-方式-1" class="headerlink" title="Spring XML 方式"></a>Spring XML 方式</h6><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"sqlSessionFactory"</span> <span class="attr">class</span>=<span class="string">"com.baomidou.mybatisplus.extension.spring.MybatisSqlSessionFactoryBean"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"plugins"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"mybatisPlusInterceptor"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"mybatisPlusInterceptor"</span> <span class="attr">class</span>=<span class="string">"com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"interceptors"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"optimisticLockerInnerInterceptor"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"optimisticLockerInnerInterceptor"</span> <span class="attr">class</span>=<span class="string">"com.baomidou.mybatisplus.extension.plugins.inner.OptimisticLockerInnerInterceptor"</span>/&gt;</span></span><br></pre></td></tr></tbody></table></figure><h6 id="SpringBoot-配置类方式-1"><a href="#SpringBoot-配置类方式-1" class="headerlink" title="SpringBoot 配置类方式"></a>SpringBoot 配置类方式</h6><ul><li>配置类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MyBatis-Plus 配置类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan("com.clay.mybatis.dao")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisPlusConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 添加 MyBatis-Plus 乐观锁插件</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> MybatisPlusInterceptor <span class="title">mybatisPlusInterceptor</span><span class="params">()</span> </span>{</span><br><span class="line">		MybatisPlusInterceptor interceptor = <span class="keyword">new</span> MybatisPlusInterceptor();</span><br><span class="line">		interceptor.addInnerInterceptor(<span class="keyword">new</span> OptimisticLockerInnerInterceptor());</span><br><span class="line">		<span class="keyword">return</span> interceptor;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>启动类</li></ul><div class="admonition note"><p class="admonition-title">提示</p><p>特殊情况下，可能还需要在启动类上通过 <code>@ComponentScan</code> 注解来扫描上面定义的 <code>MybatisPlusConfig</code> 配置类。</p></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@ComponentScan("com.clay.mybatis")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisPlusApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">		SpringApplication.run(MyBatisPlusApplication.class, args);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h6 id="MyBatis-配置文件方式-1"><a href="#MyBatis-配置文件方式-1" class="headerlink" title="MyBatis 配置文件方式"></a>MyBatis 配置文件方式</h6><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- property 的配置说明详见 MybatisPlusInterceptor.setProperties() 的源码方法注释 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugin</span> <span class="attr">interceptor</span>=<span class="string">"com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"@optimisticLocker"</span> <span class="attr">value</span>=<span class="string">"com.baomidou.mybatisplus.extension.plugins.inner.OptimisticLockerInnerInterceptor"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h5 id="添加-Version-注解"><a href="#添加-Version-注解" class="headerlink" title="添加 @Version 注解"></a>添加 @Version 注解</h5><p>在实体类的属性上添加 <code>@Version</code> 注解</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Version</span></span><br><span class="line">	<span class="keyword">private</span> Long version;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> BigDecimal price;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">	</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><div class="admonition warning"><p class="admonition-title">特别注意</p><ul><li><code>@Version</code> 注解支持的数据类型只有：int，Integer，long，Long，Date，Timestamp，LocalDateTime<br></li><li>整数类型下 <code>newVersion = oldVersion + 1</code>，其中的 <code>newVersion</code> 会回写到 Entity 中<br></li><li><code>@Version</code> 注解仅支持 <code>updateById(id)</code> 与 <code>update(entity, wrapper)</code> 方法<br></li><li>在使用 <code>update(entity, wrapper)</code> 方法的情况下，<code>wrapper</code> 不能复用！<br></li></ul></div><h5 id="Junit-单元测试代码"><a href="#Junit-单元测试代码" class="headerlink" title="Junit 单元测试代码"></a>Junit 单元测试代码</h5><ul><li>Mapper 接口</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">Product</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Junit 测试代码</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisPlusApplicationTest</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ProductMapper productMapper;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updatePrice</span><span class="params">()</span> </span>{</span><br><span class="line"></span><br><span class="line">		Product product1 = productMapper.selectById(<span class="number">1L</span>);</span><br><span class="line">		System.out.println(<span class="string">"小李取出的商品价格:"</span> + product1.getPrice());</span><br><span class="line"></span><br><span class="line">		Product product2 = productMapper.selectById(<span class="number">1L</span>);</span><br><span class="line">		System.out.println(<span class="string">"小王取出的商品价格:"</span> + product2.getPrice());</span><br><span class="line"></span><br><span class="line">		product1.setPrice(product1.getPrice().add(<span class="keyword">new</span> BigDecimal(<span class="number">50</span>)));</span><br><span class="line">		<span class="keyword">int</span> result1 = productMapper.updateById(product1);</span><br><span class="line">		System.out.println(<span class="string">"小李修改商品价格的结果: "</span> + (result1 &gt; <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">		product2.setPrice(product2.getPrice().subtract(<span class="keyword">new</span> BigDecimal(<span class="number">30</span>)));</span><br><span class="line">		<span class="keyword">int</span> result2 = productMapper.updateById(product2);</span><br><span class="line">		System.out.println(<span class="string">"小王修改商品价格的结果: "</span> + (result2 &gt; <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">		Product product3 = productMapper.selectById(<span class="number">1L</span>);</span><br><span class="line">		System.out.println(<span class="string">"最终的商品价格: "</span> + product3.getPrice());</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>执行上面的测试代码后，控制台输出的日志信息如下，观察后可发现最终只有小李成功更改了商品价格，也就是商品价格的更改不会再发生冲突。</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">==&gt;  Preparing: SELECT id,name,price,version FROM t_product WHERE id=?</span><br><span class="line">==&gt; Parameters: 1(Long)</span><br><span class="line">&lt;==    Columns: id, name, price, version</span><br><span class="line">&lt;==        Row: 1, C++ Primer Plus, 100.00000, 0</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">小李取出的商品价格:100.00000</span><br><span class="line"></span><br><span class="line">==&gt;  Preparing: SELECT id,name,price,version FROM t_product WHERE id=?</span><br><span class="line">==&gt; Parameters: 1(Long)</span><br><span class="line">&lt;==    Columns: id, name, price, version</span><br><span class="line">&lt;==        Row: 1, C++ Primer Plus, 100.00000, 0</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">小王取出的商品价格:100.00000</span><br><span class="line"></span><br><span class="line">==&gt;  Preparing: UPDATE t_product SET name=?, price=?, version=? WHERE id=? AND version=?</span><br><span class="line">==&gt; Parameters: C++ Primer Plus(String), 150.00000(BigDecimal), 1(Long), 1(Long), 0(Long)</span><br><span class="line">&lt;==    Updates: 1</span><br><span class="line">小李修改商品价格的结果: true</span><br><span class="line"></span><br><span class="line">==&gt;  Preparing: UPDATE t_product SET name=?, price=?, version=? WHERE id=? AND version=?</span><br><span class="line">==&gt; Parameters: C++ Primer Plus(String), 70.00000(BigDecimal), 1(Long), 1(Long), 0(Long)</span><br><span class="line">&lt;==    Updates: 0</span><br><span class="line">小王修改商品价格的结果: false</span><br><span class="line"></span><br><span class="line">最终的商品价格: 150.00000</span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">优化测试代码</p><p>上面的测试代码可以加入更新重试机制，也就是在当前记录更新失败时，可以重新读取记录，然后再次尝试更新记录，示例代码如下：</p></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisPlusApplicationTest</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ProductMapper productMapper;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updatePrice</span><span class="params">()</span> </span>{</span><br><span class="line"></span><br><span class="line">		Product product1 = productMapper.selectById(<span class="number">1L</span>);</span><br><span class="line">		System.out.println(<span class="string">"小李取出的商品价格:"</span> + product1.getPrice());</span><br><span class="line"></span><br><span class="line">		Product product2 = productMapper.selectById(<span class="number">1L</span>);</span><br><span class="line">		System.out.println(<span class="string">"小王取出的商品价格:"</span> + product2.getPrice());</span><br><span class="line"></span><br><span class="line">		product1.setPrice(product1.getPrice().add(<span class="keyword">new</span> BigDecimal(<span class="number">50</span>)));</span><br><span class="line">		<span class="keyword">int</span> result1 = productMapper.updateById(product1);</span><br><span class="line">		System.out.println(<span class="string">"小李修改商品价格的结果: "</span> + (result1 &gt; <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">		product2.setPrice(product2.getPrice().subtract(<span class="keyword">new</span> BigDecimal(<span class="number">30</span>)));</span><br><span class="line">		<span class="keyword">int</span> result2 = productMapper.updateById(product2);</span><br><span class="line">		System.out.println(<span class="string">"小王修改商品价格的结果: "</span> + (result2 &gt; <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (result2 == <span class="number">0</span>) {</span><br><span class="line">			Product productNew = productMapper.selectById(<span class="number">1L</span>);</span><br><span class="line">			productNew.setPrice(productNew.getPrice().subtract(<span class="keyword">new</span> BigDecimal(<span class="number">30</span>)));</span><br><span class="line">			<span class="keyword">int</span> resultNew = productMapper.updateById(productNew);</span><br><span class="line">			System.out.println(<span class="string">"小王第二次修改商品价格的结果: "</span> + (resultNew &gt; <span class="number">0</span>));</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		Product product3 = productMapper.selectById(<span class="number">1L</span>);</span><br><span class="line">		System.out.println(<span class="string">"最终的商品价格: "</span> + product3.getPrice());</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="MyBatis-Plus-防全表更新与删除插件"><a href="#MyBatis-Plus-防全表更新与删除插件" class="headerlink" title="MyBatis-Plus 防全表更新与删除插件"></a>MyBatis-Plus 防全表更新与删除插件</h3><p><code>BlockAttackInnerInterceptor</code> 拦截器作用于 <code>update</code> 和 <code>delete</code> 的 SQL 语句，可以阻止恶意的全表更新和全表删除操作。本节所需的案例代码，可以直接从 <a target="_blank" rel="external nofollow" href="https://github.com/rqh656418510/mybatis-code/tree/main/mybatis-plus-study">GitHub</a> 下载对应章节 <code>mybatis-plus-lesson-09</code>。</p><h4 id="防全表更新与删除插件的使用"><a href="#防全表更新与删除插件的使用" class="headerlink" title="防全表更新与删除插件的使用"></a>防全表更新与删除插件的使用</h4><div class="admonition note"><p class="admonition-title">防全表更新与删除插件的配置步骤</p><p>只需要使用 Spring XML 方式、 SpringBoot 配置类方式或者 MyBatis 配置文件方式中的任意一种配置防全表更新与删除插件即可。</p></div><h5 id="配置防全表更新与删除插件"><a href="#配置防全表更新与删除插件" class="headerlink" title="配置防全表更新与删除插件"></a>配置防全表更新与删除插件</h5><p>注入 <code>MybatisPlusInterceptor</code> 类，并配置 <code>BlockAttackInnerInterceptor</code> 拦截器。</p><h6 id="Spring-XML-方式-2"><a href="#Spring-XML-方式-2" class="headerlink" title="Spring XML 方式"></a>Spring XML 方式</h6><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"sqlSessionFactory"</span> <span class="attr">class</span>=<span class="string">"com.baomidou.mybatisplus.extension.spring.MybatisSqlSessionFactoryBean"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"plugins"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"mybatisPlusInterceptor"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"mybatisPlusInterceptor"</span> <span class="attr">class</span>=<span class="string">"com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"interceptors"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"blockAttackInnerInterceptor"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"blockAttackInnerInterceptor"</span> <span class="attr">class</span>=<span class="string">"com.baomidou.mybatisplus.extension.plugins.inner.BlockAttackInnerInterceptor"</span>/&gt;</span></span><br></pre></td></tr></tbody></table></figure><h6 id="SpringBoot-配置类方式-2"><a href="#SpringBoot-配置类方式-2" class="headerlink" title="SpringBoot 配置类方式"></a>SpringBoot 配置类方式</h6><ul><li>配置类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MyBatis-Plus 配置类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan("com.clay.mybatis.dao")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisPlusConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 添加 MyBatis-Plus 防全表更新与删除插件</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> MybatisPlusInterceptor <span class="title">mybatisPlusInterceptor</span><span class="params">()</span> </span>{</span><br><span class="line">		MybatisPlusInterceptor interceptor = <span class="keyword">new</span> MybatisPlusInterceptor();</span><br><span class="line">		interceptor.addInnerInterceptor(<span class="keyword">new</span> BlockAttackInnerInterceptor());</span><br><span class="line">		<span class="keyword">return</span> interceptor;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>启动类</li></ul><div class="admonition note"><p class="admonition-title">提示</p><p>特殊情况下，可能还需要在启动类上通过 <code>@ComponentScan</code> 注解来扫描上面定义的 <code>MybatisPlusConfig</code> 配置类。</p></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@ComponentScan("com.clay.mybatis")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisPlusApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">		SpringApplication.run(MyBatisPlusApplication.class, args);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h6 id="MyBatis-配置文件方式-2"><a href="#MyBatis-配置文件方式-2" class="headerlink" title="MyBatis 配置文件方式"></a>MyBatis 配置文件方式</h6><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- property 的配置说明详见 MybatisPlusInterceptor.setProperties() 的源码方法注释 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugin</span> <span class="attr">interceptor</span>=<span class="string">"com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"@blockAttack"</span> <span class="attr">value</span>=<span class="string">"com.baomidou.mybatisplus.extension.plugins.inner.BlockAttackInnerInterceptor"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h5 id="Junit-单元测试代码-1"><a href="#Junit-单元测试代码-1" class="headerlink" title="Junit 单元测试代码"></a>Junit 单元测试代码</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisPlusApplicationTest</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> EmployeeMapper empMapper;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAll</span><span class="params">()</span> </span>{</span><br><span class="line">		empMapper.delete(<span class="keyword">null</span>);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateAll</span><span class="params">()</span> </span>{</span><br><span class="line">		Employee employee = <span class="keyword">new</span> Employee();</span><br><span class="line">		employee.setGender(<span class="string">"1"</span>);</span><br><span class="line">		employee.setAge(<span class="number">26</span>);</span><br><span class="line">		empMapper.update(employee, <span class="keyword">null</span>);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>执行上面的测试代码后，若抛出如下的异常信息，则说明防全表更新与删除插件生效了</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Caused by: com.baomidou.mybatisplus.core.exceptions.MybatisPlusException: Prohibition of full table deletion</span><br><span class="line">	at com.baomidou.mybatisplus.core.toolkit.ExceptionUtils.mpe(ExceptionUtils.java:49)</span><br><span class="line">	at com.baomidou.mybatisplus.core.toolkit.Assert.isTrue(Assert.java:38)</span><br><span class="line">	at com.baomidou.mybatisplus.core.toolkit.Assert.isFalse(Assert.java:50)</span><br><span class="line">	at com.baomidou.mybatisplus.extension.plugins.inner.BlockAttackInnerInterceptor.checkWhere(BlockAttackInnerInterceptor.java:74)</span><br><span class="line">	at com.baomidou.mybatisplus.extension.plugins.inner.BlockAttackInnerInterceptor.processDelete(BlockAttackInnerInterceptor.java:65)</span><br><span class="line"></span><br><span class="line">Caused by: com.baomidou.mybatisplus.core.exceptions.MybatisPlusException: Prohibition of table update operation</span><br><span class="line">	at com.baomidou.mybatisplus.core.toolkit.ExceptionUtils.mpe(ExceptionUtils.java:49)</span><br><span class="line">	at com.baomidou.mybatisplus.core.toolkit.Assert.isTrue(Assert.java:38)</span><br><span class="line">	at com.baomidou.mybatisplus.core.toolkit.Assert.isFalse(Assert.java:50)</span><br><span class="line">	at com.baomidou.mybatisplus.extension.plugins.inner.BlockAttackInnerInterceptor.checkWhere(BlockAttackInnerInterceptor.java:74)</span><br><span class="line">	at com.baomidou.mybatisplus.extension.plugins.inner.BlockAttackInnerInterceptor.processUpdate(BlockAttackInnerInterceptor.java:70)</span><br></pre></td></tr></tbody></table></figure><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/315d5197.html" title="MyBatis-Plus 入门教程之六">https://www.techgrow.cn/posts/315d5197.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/ORM/" rel="tag"><i class="fa fa-tag"></i> ORM</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/3ffff1a5.html" rel="prev" title="Linux 安装 ElasticSearch（单机）"><i class="fa fa-angle-left"></i> Linux 安装 ElasticSearch（单机）</a></div><div class="post-nav-item"> <a href="/posts/53e1dc9b.html" rel="next" title="如何选择 GPU 搭建深度学习机器">如何选择 GPU 搭建深度学习机器<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">2m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">30:55</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/315d5197.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>