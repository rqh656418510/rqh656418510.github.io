<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.13.0","exturl":false,"sidebar":{"position":"left","width":300,"display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍 Hexo Next 主题如何使用 Waline 评论系统，包括Docker部署Waline、安装Next主题的插件、Waline配置邮件通知、启用暗黑模式、图片上传图床、反向代理等。"><meta property="og:type" content="article"><meta property="og:title" content="Hexo Next 主题使用 Waline 评论系统"><meta property="og:url" content="https://www.techgrow.cn/posts/ae18fb85.html"><meta property="og:site_name" content="Clay 的技术博客"><meta property="og:description" content="本文主要介绍 Hexo Next 主题如何使用 Waline 评论系统，包括Docker部署Waline、安装Next主题的插件、Waline配置邮件通知、启用暗黑模式、图片上传图床、反向代理等。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/04/hexo-waline-ui.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/04/waline-avatar.png"><meta property="article:published_time" content="2021-04-08T13:19:22.000Z"><meta property="article:modified_time" content="2022-06-15T13:19:22.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="静态博客"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2021/04/hexo-waline-ui.png"><link rel="canonical" href="https://www.techgrow.cn/posts/ae18fb85.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/ae18fb85.html","path":"posts/ae18fb85.html","title":"Hexo Next 主题使用 Waline 评论系统"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Hexo Next 主题使用 Waline 评论系统 | Clay 的技术博客</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn:9360"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术博客" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax>!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><script data-ad-client="ca-pub-4014850419768221" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/app/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt></div><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术博客</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-openplatform"><a href="https://open.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-toolbox fa-fw"></i>开放平台</a></li><li class="menu-item menu-item-readingnotes"><a href="https://docs.techgrow.cn/notes/" rel="external nofollow" target="_blank"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn:9360/ui/login?lng=zh-cn" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="nav-text">版本说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hexo-%E8%AF%84%E8%AE%BA%E7%B3%BB%E7%BB%9F%E9%80%89%E6%8B%A9"><span class="nav-text">Hexo 评论系统选择</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hexo-%E8%AF%84%E8%AE%BA%E7%B3%BB%E7%BB%9F%E4%BB%8B%E7%BB%8D"><span class="nav-text">Hexo 评论系统介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Valine-%E8%AF%84%E8%AE%BA%E7%B3%BB%E7%BB%9F"><span class="nav-text">Valine 评论系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Waline-%E8%AF%84%E8%AE%BA%E7%B3%BB%E7%BB%9F"><span class="nav-text">Waline 评论系统</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker-%E9%83%A8%E7%BD%B2-MySQL-Server"><span class="nav-text">Docker 部署 MySQL Server</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Doker-%E9%83%A8%E7%BD%B2-MySQL"><span class="nav-text">Doker 部署 MySQL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">MySQL 数据库表初始化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker-%E9%83%A8%E7%BD%B2-Waline-Server"><span class="nav-text">Docker 部署 Waline Server</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA-Waline-Server-%E9%95%9C%E5%83%8F"><span class="nav-text">构建 Waline Server 镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Docker-%E9%83%A8%E7%BD%B2-Waline-Server-1"><span class="nav-text">Docker 部署 Waline Server</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Waline-Server-%E7%9A%84%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-text">Waline Server 的环境变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Waline-Server-%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95"><span class="nav-text">Waline Server 运行测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Waline-Server-%E9%85%8D%E7%BD%AE%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="nav-text">Waline Server 配置反向代理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE"><span class="nav-text">Nginx 反向代理配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx-%E9%85%8D%E7%BD%AE%E8%B7%A8%E5%9F%9F%E8%AE%BF%E9%97%AE"><span class="nav-text">Nginx 配置跨域访问</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Next-%E4%B8%BB%E9%A2%98%E5%AE%89%E8%A3%85-Waline-%E5%AE%98%E6%96%B9%E6%8F%92%E4%BB%B6"><span class="nav-text">Next 主题安装 Waline 官方插件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-Waline-%E5%AE%98%E6%96%B9%E6%8F%92%E4%BB%B6"><span class="nav-text">安装 Waline 官方插件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-Waline-%E5%AE%98%E6%96%B9%E6%8F%92%E4%BB%B6"><span class="nav-text">配置 Waline 官方插件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E6%94%B9-Next-%E4%B8%BB%E9%A2%98%E7%9A%84%E6%A0%B7%E5%BC%8F"><span class="nav-text">更改 Next 主题的样式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hexo-%E6%9E%84%E5%BB%BA%E5%A4%B1%E8%B4%A5%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="nav-text">Hexo 构建失败的解决方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Waline-%E7%AC%AC%E4%B8%89%E6%96%B9%E6%8F%92%E4%BB%B6%E5%88%97%E8%A1%A8"><span class="nav-text">Waline 第三方插件列表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#hexo-waline-next"><span class="nav-text">hexo-waline-next</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hexo-next-darkmode"><span class="nav-text">hexo-next-darkmode</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Waline-%E8%BF%9B%E9%98%B6%E9%85%8D%E7%BD%AE"><span class="nav-text">Waline 进阶配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BD%BF%E7%94%A8-CDN"><span class="nav-text">客户端使用 CDN</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E9%82%AE%E7%AE%B1"><span class="nav-text">验证用户注册邮箱</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%85%8D%E7%BD%AE%E7%94%A8%E6%88%B7%E5%A4%B4%E5%83%8F"><span class="nav-text">客户端配置用户头像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%85%8D%E7%BD%AE%E8%AF%84%E8%AE%BA%E9%80%9A%E7%9F%A5"><span class="nav-text">服务端配置评论通知</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Waline-Client-%E7%9A%84%E5%85%B6%E4%BB%96%E7%89%B9%E6%80%A7"><span class="nav-text">Waline Client 的其他特性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%B7%E5%BC%8F"><span class="nav-text">自定义样式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A1%A8%E6%83%85%E5%8C%85"><span class="nav-text">自定义表情包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E7%94%A8%E6%9A%97%E9%BB%91%E6%A8%A1%E5%BC%8F"><span class="nav-text">启用暗黑模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Github-%E7%A4%BE%E4%BA%A4%E7%99%BB%E5%BD%95"><span class="nav-text">Github 社交登录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E8%87%B3%E4%B8%83%E7%89%9B%E5%9B%BE%E5%BA%8A"><span class="nav-text">上传图片至七牛图床</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Waline-%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97"><span class="nav-text">Waline 开发指南</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-text">准备工作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0%E5%BC%80%E5%8F%91"><span class="nav-text">本地开发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E6%9E%84%E5%BB%BA"><span class="nav-text">编译构建</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Waline-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="nav-text">Waline 常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%98%B2%E6%AD%A2%E6%81%B6%E6%84%8F%E5%88%B7%E8%AF%84%E8%AE%BA"><span class="nav-text">防止恶意刷评论</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Waline-%E5%8F%91%E5%B8%83%E8%AF%84%E8%AE%BA%E5%BE%88%E6%85%A2"><span class="nav-text">Waline 发布评论很慢</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Github-%E7%99%BB%E5%BD%95%E6%97%A0%E6%B3%95%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0"><span class="nav-text">Github 登录无法管理后台</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Waline-%E7%89%88%E6%9C%AC%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B"><span class="nav-text">Waline 版本更新流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E6%BA%90%E7%A0%81"><span class="nav-text">项目源码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E5%8D%9A%E5%AE%A2"><span class="nav-text">参考博客</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">387</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">41</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → &#x2F;sitemap.xml"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="external nofollow" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/ae18fb85.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术博客"><meta itemprop="description" content="专注于 Java、前端、移动端、微服务、分布式系统、数据库、系统架构、人工智能、大数据、云计算、物联网、虚拟化学习的技术博客。"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Hexo Next 主题使用 Waline 评论系统 | Clay 的技术博客"><meta itemprop="description" content="本文主要介绍 Hexo Next 主题如何使用 Waline 评论系统，包括Docker部署Waline、安装Next主题的插件、Waline配置邮件通知、启用暗黑模式、图片上传图床、反向代理等。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Hexo Next 主题使用 Waline 评论系统</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-04-08 21:19:22" itemprop="dateCreated datePublished" datetime="2021-04-08T21:19:22+08:00">2021-04-08</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-06-15 21:19:22" itemprop="dateModified" datetime="2022-06-15T21:19:22+08:00">2022-06-15</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/ae18fb85.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/ae18fb85.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>11k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>10 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><div id="readmore-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本教程的内容虽然会持续更新，但一切内容以 <a target="_blank" rel="external nofollow" href="https://waline.js.org/">Waline 官方文档</a> 为准。</p><h3 id="版本说明"><a href="#版本说明" class="headerlink" title="版本说明"></a>版本说明</h3><table><thead><tr><th>软件</th><th>版本</th><th>描述</th></tr></thead><tbody><tr><td> linux</td><td>CentOS 7.9</td><td></td></tr><tr><td>docker</td><td>20.10.5</td><td></td></tr><tr><td>mysql</td><td>5.7.26</td><td></td></tr><tr><td>node</td><td>14.17.3</td><td></td></tr><tr><td>hexo</td><td>5.4.0</td><td></td></tr><tr><td>next</td><td>8.12.1</td><td></td></tr><tr><td>waline-admin</td><td>0.18.0</td><td></td></tr><tr><td>waline-client</td><td>2.5.1</td><td></td></tr><tr><td>waline-server</td><td>1.18.5</td><td></td></tr></tbody></table><span id="more"></span><h3 id="Hexo-评论系统选择"><a href="#Hexo-评论系统选择" class="headerlink" title="Hexo 评论系统选择"></a>Hexo 评论系统选择</h3><p>Hexo 各类评论系统的对比可看<a target="_blank" rel="external nofollow" href="https://www.zhihu.com/question/267598518">这里</a>，之前博客一直使用的评论系统是基于 Github Issue 的 <a target="_blank" rel="external nofollow" href="http://127.0.0.1:4000/posts/fef9e726.html#Utterances-%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6%E9%9B%86%E6%88%90">Utterances</a>。由于 Utterances 默认没有 CDN 加速，经常造成页面加载完成后无法正常显示 Utterances 的评论区，而且需用用户登录 Github 账号才能评论，因此打算更换博客的评论系统。国外的 Disqus、Hypercomments 暂时不考虑，国内访问被墙的概率很大。Gitment、Gitalk、Gitter 和 Utterances 一样，访问速度不太稳定，且登录 Github 才能评论，暂时也不考虑。这一波排除下来，剩下的方案只有 Valine、Isso、Waline 或者 <code>自建评论系统</code>。考虑到 Valine 依赖 Leancloud 第三方服务，且需要在 Leancloud 额外部署 Valine Admin 才能实现邮件通知与评论管理等功能，这样一来感觉也不靠谱，万一 Leancloud 以后退出商业市场竞争呢？综合考虑下来，最终选择了 <a target="_blank" rel="external nofollow" href="https://waline.js.org/">Waline</a> 评论系统，一款从 Valine 衍生的带后端评论系统，支持多种部署方式和数据存储方式，这样就可以省去 <code>自建评论系统</code> 的开发成本，同时也可以尽量少依赖第三方服务，增加日后扩展和维护的自由度。</p><h2 id="Hexo-评论系统介绍"><a href="#Hexo-评论系统介绍" class="headerlink" title="Hexo 评论系统介绍"></a>Hexo 评论系统介绍</h2><h3 id="Valine-评论系统"><a href="#Valine-评论系统" class="headerlink" title="Valine 评论系统"></a>Valine 评论系统</h3><p><a target="_blank" rel="external nofollow" href="https://valine.js.org/">Valine</a> 是一款基于 Leancloud 的快速、简洁且高效的无后端评论系统，用户无需登录即可评论，目前已有 Hexo、Jekyll、Typecho、Hugo、Ghost 等博客程序在使用。由于 Valine 自身不支持邮件通知支持，因此诞生了 <a target="_blank" rel="external nofollow" href="https://github.com/DesertsP/Valine-Admin">Valine Admin</a> 开源项目；一个对 Valine 评论系统的拓展应用，可增强 Valine 的邮件通知功能；基于 Leancloud 的云引擎与云函数，主要实现评论邮件通知、评论管理、自定义邮件通知模板等功能，而且还可以提供邮件 <code>通知博主</code> 和 <code>@ 通知</code> 的功能。</p><h3 id="Waline-评论系统"><a href="#Waline-评论系统" class="headerlink" title="Waline 评论系统"></a>Waline 评论系统</h3><p><a target="_blank" rel="external nofollow" href="https://waline.js.org/">Waline</a> 一款从 Valine 衍生的带后端评论系统，可以将 Waline 等价成 With backend Valine，采用 Client/Server 架构并基于 NodeJS 开发。Valine 支持 MarkDown 语法、邮件通知、评论管理、<a target="_blank" rel="external nofollow" href="https://waline.js.org/server/vps-deploy.html">多种部署方式</a>、<a target="_blank" rel="external nofollow" href="https://waline.js.org/server/databases.html">多种数据存储方式</a>。</p><table><thead><tr><th></th><th>Waline</th><th></th></tr></thead><tbody><tr><td> <strong>客户端脚本</strong></td><td><strong>服务端部署</strong></td><td><strong>数据存储</strong></td></tr><tr><td> @waline/client</td><td>Vercel</td><td>LeanCloud</td></tr><tr><td>MiniValine</td><td>CloudBase</td><td>CloudBase</td></tr><tr><td></td><td>Docker</td><td>MongoDB</td></tr><tr><td></td><td> 独立部署</td><td> MySQL</td></tr><tr><td></td><td></td><td>SQLite</td></tr><tr><td></td><td></td><td>PostgreSQL</td></tr><tr><td></td><td></td><td>Github</td></tr></tbody></table><p>Waline 支持的功能：</p><ul><li><input checked="checked" disabled="disabled" type="checkbox"> 邮件通知</li><li><input checked="checked" disabled="disabled" type="checkbox"> 微信通知</li><li><input checked="checked" disabled="disabled" type="checkbox"> QQ 通知</li><li><input checked="checked" disabled="disabled" type="checkbox"> Telegram 通知</li><li><input checked="checked" disabled="disabled" type="checkbox"> Akismet 反垃圾评论</li><li><input checked="checked" disabled="disabled" type="checkbox"> 文章统计</li><li><input checked="checked" disabled="disabled" type="checkbox"> 多语言</li><li><input checked="checked" disabled="disabled" type="checkbox"> 自定义语言支持</li><li><input checked="checked" disabled="disabled" type="checkbox"> 登录支持</li><li><input checked="checked" disabled="disabled" type="checkbox"> 评论管理</li><li><input checked="checked" disabled="disabled" type="checkbox"> 评论删除</li><li><input checked="checked" disabled="disabled" type="checkbox"> 其它数据库服务支持（已支持 LeanCloud, MySQL, MongoDB, SQLite, PostgreSQL)</li><li><input checked="checked" disabled="disabled" type="checkbox"> 基于 IP 的评论发布频率限制</li><li><input checked="checked" disabled="disabled" type="checkbox"> 基于关键词的评论过滤限制</li><li><input checked="checked" disabled="disabled" type="checkbox"> IP 黑名单</li><li><input checked="checked" disabled="disabled" type="checkbox"> 重复内容检测</li><li><input checked="checked" disabled="disabled" type="checkbox"> CloudBase 腾讯云开发部署支持</li><li><input checked="checked" disabled="disabled" type="checkbox"> 社交登录</li><li><input disabled="disabled" type="checkbox"> AWS, GCP, Azure 部署支持</li><li><input checked="checked" disabled="disabled" type="checkbox"> 置顶评论</li><li><input checked="checked" disabled="disabled" type="checkbox"> 评论赞踩</li></ul><h2 id="Docker-部署-MySQL-Server"><a href="#Docker-部署-MySQL-Server" class="headerlink" title="Docker 部署 MySQL Server"></a>Docker 部署 MySQL Server</h2><p>使用 Docker 部署 MySQL，容器管理工具使用 Docker-Compose。</p><h3 id="Doker-部署-MySQL"><a href="#Doker-部署-MySQL" class="headerlink" title="Doker 部署 MySQL"></a>Doker 部署 MySQL</h3><p>在下述的 Docker-Compose 配置里，指定了 MySQL 容器的静态 IP 地址与系统时区，<code>yourPassword</code> 为数据库密码，<code>/usr/local/docker-volumes/mysql/*</code> 是 MySQL 容器各个数据卷目录的路径</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3.5"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:5.7.26</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">waline-mysql</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">'Asia/Shanghai'</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">yourPassword</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">3306</span><span class="string">:3306</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="attr">waline-network:</span></span><br><span class="line">        <span class="attr">ipv4_address:</span> <span class="number">172.23</span><span class="number">.0</span><span class="number">.3</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'/usr/local/docker-volumes/mysql/conf:/etc/mysql/conf.d'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'/usr/local/docker-volumes/mysql/data:/var/lib/mysql'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'/usr/local/docker-volumes/mysql/log:/var/log/mysql'</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">--default-authentication-plugin=mysql_native_password</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">waline-network:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">waline-network</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line">    <span class="attr">ipam:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">subnet:</span> <span class="number">172.23</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br></pre></td></tr></tbody></table></figure><h3 id="MySQL-数据库表初始化"><a href="#MySQL-数据库表初始化" class="headerlink" title="MySQL 数据库表初始化"></a>MySQL 数据库表初始化</h3><p>创建并启动 MySQL 的 Docker 容器后，导入最新的 <a target="_blank" rel="external nofollow" href="https://github.com/lizheming/waline/blob/master/assets/waline.sql">waline.sql</a> 脚本来创建好 Waline Server 所需的数据库表，其中相关表的结构如下：</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE waline <span class="keyword">DEFAULT</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `wl_Comment` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `user_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `comment` text,</span><br><span class="line">  `insertedAt` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  `ip` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  `link` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `mail` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `nick` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `pid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `rid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `sticky` <span class="type">boolean</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `status` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  `<span class="keyword">like</span>` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `ua` text,</span><br><span class="line">  `url` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `createdAt` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  `updatedAt` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `wl_Counter` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `<span class="type">time</span>` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `url` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  `createdAt` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  `updatedAt` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `wl_Users` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `display_name` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  `email` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  `password` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  `type` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  `label` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `url` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `avatar` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `github` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `twitter` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `facebook` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `google` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `weibo` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `qq` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `<span class="number">2</span>fa` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `createdAt` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  `updatedAt` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></tbody></table></figure><h2 id="Docker-部署-Waline-Server"><a href="#Docker-部署-Waline-Server" class="headerlink" title="Docker 部署 Waline Server"></a>Docker 部署 Waline Server</h2><p>使用 Docker 部署 Waline Server，数据存储方式选择 MySQL，容器管理工具使用 Docker-Compose。</p><h3 id="构建-Waline-Server-镜像"><a href="#构建-Waline-Server-镜像" class="headerlink" title="构建 Waline Server 镜像"></a>构建 Waline Server 镜像</h3><p>若不希望自己构建 Waline Server 的 Docker 镜像，可以直接使用 <a target="_blank" rel="external nofollow" href="https://hub.docker.com/r/lizheming/waline">Waline 官方的 Docker 镜像</a>，操作步骤如下：</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拉取最新的代码</span></span><br><span class="line"><span class="keyword"># git</span> <span class="built_in">clone</span> https://github.com/lizheming/waline.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入代码目录</span></span><br><span class="line"><span class="keyword"># cd</span> waline/packages/server/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建镜像</span></span><br><span class="line"><span class="keyword"># docker</span> build<span class="params"> -t</span> lizheming/waline<span class="params"> -f</span> Dockerfile .</span><br></pre></td></tr></tbody></table></figure><p>值得一提的是，官方提供的 Dockerfile 默认会使用最新的 Waline Server 代码来构建 Docker 镜像，若希望使用本地的 Waline Server 代码（经过更改的）来构建 Docker 镜像，需要自行更改 Dockerfile 的内容（如下所示）；为了统一使用东八区时区，建议更改系统默认的时区。</p><figure class="highlight docker"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://github.com/nodejs/LTS</span></span><br><span class="line"><span class="keyword">FROM</span> node:lts AS build</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"><span class="keyword">ENV</span> NODE_ENV production</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">set</span> -eux; \</span></span><br><span class="line"><span class="bash">        <span class="comment"># npm config set registry https://registry.npmmirror.com; \</span></span></span><br><span class="line"><span class="bash">        npm install --production --silent @waline/vercel</span></span><br><span class="line"><span class="comment"># use local source code</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> rm -rf /app/node_modules/@waline/vercel/src/*</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> ./src/ /app/node_modules/@waline/vercel/src</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> node:lts-buster-slim</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span></span><br><span class="line"><span class="keyword">ENV</span> TZ Asia/Shanghai</span><br><span class="line"><span class="keyword">ENV</span> NODE_ENV production</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=build /app .</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8360</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"node"</span>, <span class="string">"node_modules/@waline/vercel/vanilla.js"</span>]</span></span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">提示</p><p>若构建 Waline Server 的 Docker 镜像时，一直卡在 NPM 安装模块的过程里，可以更改对应的 Dockerfile（如下所示），使用淘宝的 NPM 源来加速 NPM 模块下载</p></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$ vim</span> waline/packages/server/Dockerfile</span><br><span class="line"></span><br><span class="line">...（省略）</span><br><span class="line">npm config <span class="built_in">set</span> registry https://registry.npmmirror.com; \</span><br><span class="line">npm install<span class="params"> --production</span><span class="params"> --silent</span> @waline/vercel</span><br><span class="line">...（省略）</span><br></pre></td></tr></tbody></table></figure><h3 id="Docker-部署-Waline-Server-1"><a href="#Docker-部署-Waline-Server-1" class="headerlink" title="Docker 部署 Waline Server"></a>Docker 部署 Waline Server</h3><p>在上面 MySQL 的 Docker-Compose 配置基础上，指定 Waline Server 容器的静态 IP 地址 与 Waline Server 启动时所需的环境变量</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3.5"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:5.7.26</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">waline-mysql</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">'Asia/Shanghai'</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">yourPassword</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">3306</span><span class="string">:3306</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="attr">waline-network:</span></span><br><span class="line">        <span class="attr">ipv4_address:</span> <span class="number">172.23</span><span class="number">.0</span><span class="number">.3</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'/usr/local/docker-volumes/mysql/conf:/etc/mysql/conf.d'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'/usr/local/docker-volumes/mysql/data:/var/lib/mysql'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'/usr/local/docker-volumes/mysql/log:/var/log/mysql'</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">--default-authentication-plugin=mysql_native_password</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">waline:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">waline</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">lizheming/waline:latest</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8360</span><span class="string">:8360</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="attr">waline-network:</span></span><br><span class="line">        <span class="attr">ipv4_address:</span> <span class="number">172.23</span><span class="number">.0</span><span class="number">.4</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">"Asia/Shanghai"</span></span><br><span class="line">      <span class="attr">AKISMET_KEY:</span> <span class="string">"false"</span></span><br><span class="line">      <span class="attr">DISABLE_USERAGENT:</span> <span class="string">"true"</span></span><br><span class="line">      <span class="attr">SITE_NAME:</span> <span class="string">"Your site name"</span></span><br><span class="line">      <span class="attr">SECURE_DOMAINS:</span> <span class="string">"example.cn"</span></span><br><span class="line">      <span class="attr">AUTHOR_EMAIL:</span> <span class="string">"example@qq.com"</span></span><br><span class="line">      <span class="attr">SITE_URL:</span> <span class="string">"https://www.example.cn"</span></span><br><span class="line">      <span class="attr">MYSQL_HOST:</span> <span class="number">172.23</span><span class="number">.0</span><span class="number">.3</span></span><br><span class="line">      <span class="attr">MYSQL_PORT:</span> <span class="number">3306</span></span><br><span class="line">      <span class="attr">MYSQL_DB:</span> <span class="string">waline</span></span><br><span class="line">      <span class="attr">MYSQL_PREFIX:</span> <span class="string">wl_</span></span><br><span class="line">      <span class="attr">MYSQL_USER:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">MYSQL_PASSWORD:</span> <span class="string">yourPassword</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/local/waline/data:/app/data</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">waline-network:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">waline-network</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line">    <span class="attr">ipam:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">subnet:</span> <span class="number">172.89</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br></pre></td></tr></tbody></table></figure><h3 id="Waline-Server-的环境变量"><a href="#Waline-Server-的环境变量" class="headerlink" title="Waline Server 的环境变量"></a>Waline Server 的环境变量</h3><p>Waline Server 的 自身环境变量如下：</p><table><thead><tr><th>环境变量名称</th><th>必填</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td> TZ</td><td></td><td></td><td> 时区</td></tr><tr><td> SITE_URL</td><td></td><td></td><td> 站点 URL</td></tr><tr><td>SITE_NAME</td><td></td><td></td><td> 站点名称</td></tr><tr><td> AUTHOR_EMAIL</td><td></td><td></td><td> 博主邮箱</td></tr><tr><td> SECURE_DOMAINS</td><td></td><td></td><td> 安全域名配置，支持逗号分隔配置多个域名，配置后非该域名来源的请求会返回 403 状态码，不配置表示允许所有域名来源</td></tr><tr><td> IPQPS</td><td></td><td>60</td><td> 基于 IP 的评论发布频率限制，单位为秒。默认为 60 秒，设置为 0 不限制</td></tr><tr><td> DISABLE_USERAGENT</td><td></td><td>false</td><td> 是否隐藏评论者的 UA，默认为否</td></tr><tr><td> DISABLE_REGION</td><td></td><td>false</td><td> 是否隐藏评论者的归属地，默认为否</td></tr><tr><td> DISABLE_AUTHOR_NOTIFY</td><td></td><td>false</td><td> 是否禁止新评论通知，默认为否</td></tr><tr><td> COMMENT_AUDIT</td><td></td><td></td><td> 评论发布审核开关，默认为否，配置后建议在 Placehoder 上提供文案提示</td></tr><tr><td> AKISMET_KEY</td><td></td><td></td><td>Akismet 反垃圾评论服务的 Key（默认开启，不用请设置为 false，关闭后可以加快评论提交的速度）</td></tr><tr><td>AVATAR_PROXY</td><td></td><td><a target="_blank" rel="external nofollow" href="https://avatar.75cdn.workers.dev/">https://avatar.75cdn.workers.dev/</a></td><td> 头像的代理地址，设置 <code>false</code> 可以关闭代理</td></tr><tr><td> LOGIN</td><td></td><td></td><td> 当设置为 <code>LOGIN: 'force'</code> 时，服务端会要求客户端必须登录才能评论；同时 Waline 客户端需要增加 <code>login： force</code> 的配置用于隐藏博客页面上的评论匿名输入框</td></tr><tr><td> GRAVATAR_STR</td><td></td><td><code>https://seccdn.libravatar.org/avatar/{{mail|md5}}</code></td><td>Gravatar 头像的地址，基于 Nunjucks 语法</td></tr><tr><td> OAUTH_URL</td><td></td><td><a target="_blank" rel="external nofollow" href="https://user.75.team/">https://user.75.team</a></td><td>OAuth 第三方登录服务地址，也可以使用 <a target="_blank" rel="external nofollow" href="https://github.com/walinejs/auth">auth</a> 自建</td></tr><tr><td> WEBHOOK</td><td></td><td></td><td> 评论成功后会向 WEBHOOK 配置的地址发送一条 POST 请求</td></tr></tbody></table><ul><li><code>COMMENT_AUDIT</code>：阅读源代码发现，环境变量中不配置 <code>COMMENT_AUDIT</code>，则默认关闭评论发布的审核功能，只要在环境变量中添加了该属性，无论属性值是什么，都会开启评论发布的审核功能</li></ul><hr><p>Waline Server 的 MySQL 环境变量如下：</p><table><thead><tr><th>环境变量名称</th><th>必填</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td><code>MYSQL_HOST</code></td><td></td><td>127.0.0.1</td><td>MySQL 服务的地址</td></tr><tr><td><code>MYSQL_PORT</code></td><td></td><td>3306</td><td>MySQL 服务的端口</td></tr><tr><td><code>MYSQL_DB</code></td><td>✓</td><td></td><td>MySQL 数据库库名</td></tr><tr><td><code>MYSQL_USER</code></td><td>✓</td><td></td><td>MySQL 数据库的用户名</td></tr><tr><td><code>MYSQL_PASSWORD</code></td><td>✓</td><td></td><td>MySQL 数据库的密码</td></tr><tr><td><code>MYSQL_PREFIX</code></td><td></td><td><code>wl_</code></td><td>MySQL 数据表的表前缀</td></tr><tr><td><code>MYSQL_CHARSET</code></td><td></td><td><code>utf8mb4</code></td><td>MySQL 数据表的字符集</td></tr></tbody></table><h3 id="Waline-Server-运行测试"><a href="#Waline-Server-运行测试" class="headerlink" title="Waline Server 运行测试"></a>Waline Server 运行测试</h3><p>分别创建并启动 MySQL 与 Waline Server 容器，然后浏览器访问 <code>http://ip:port/ui/register</code>，打开 Waline Server 的 Web 管理界面进行注册，第一个注册的用户会被 Waline Server 识别为系统管理员（博主），成功登录后的界面如下：</p><p><img data-src="../../../asset/2021/04/hexo-waline-ui.png" alt="hexo-waline-ui"></p><p>若 Waline Server 的 Web 管理界面无法正常访问，可以使用以下命令查看 Docker 容器的日志来定位问题</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword"># docker</span> logs<span class="params"> -f</span><span class="params"> --tail</span> 20 waline</span><br></pre></td></tr></tbody></table></figure><h2 id="Waline-Server-配置反向代理"><a href="#Waline-Server-配置反向代理" class="headerlink" title="Waline Server 配置反向代理"></a>Waline Server 配置反向代理</h2><h3 id="Nginx-反向代理配置"><a href="#Nginx-反向代理配置" class="headerlink" title="Nginx 反向代理配置"></a>Nginx 反向代理配置</h3><p>若使用 Nginx 作为 Waline Server 的反向代理，可参考以下配置内容。</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">server {</span><br><span class="line">     listen 80;</span><br><span class="line">     listen 443 ssl;</span><br><span class="line">     server_name www.example.com</span><br><span class="line"></span><br><span class="line">     if ($server_port !~ 443){</span><br><span class="line">         rewrite ^(/.*)$ https://$host$1 permanent;</span><br><span class="line">     }</span><br><span class="line"></span><br><span class="line">     # SSL 证书</span><br><span class="line">     ssl_certificate /usr/local/nginx/cert/waline.example.com.crt;</span><br><span class="line">     ssl_certificate_key /usr/local/nginx/cert/waline.example.com.key;</span><br><span class="line"></span><br><span class="line">     # SSL 性能调优</span><br><span class="line">     ssl_session_timeout 10m;</span><br><span class="line">     ssl_prefer_server_ciphers on;</span><br><span class="line">     ssl_session_cache shared:SSL:10m;</span><br><span class="line">     ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;</span><br><span class="line">     ssl_ciphers ECDHE-RSA-AES256-SHA384:AES256-SHA256:RC4:HIGH:!MD5:!aNULL:!eNULL:!NULL:!DH:!EDH:!AESGCM;</span><br><span class="line">     add_header Strict-Transport-Security 'max-age=31536000';</span><br><span class="line"></span><br><span class="line">     location / {</span><br><span class="line">         # 反向代理</span><br><span class="line">         proxy_pass http://$server_name;</span><br><span class="line">         proxy_set_header Host $host:$server_port;</span><br><span class="line">         proxy_set_header X-NginX-Proxy true;</span><br><span class="line">         proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">         proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">         proxy_set_header REMOTE-HOST $remote_addr;</span><br><span class="line"></span><br><span class="line">         # 缓存</span><br><span class="line">         add_header X-Cache $upstream_cache_status;</span><br><span class="line">         add_header Cache-Control no-cache;</span><br><span class="line">         expires 12h;</span><br><span class="line">     }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="Nginx-配置跨域访问"><a href="#Nginx-配置跨域访问" class="headerlink" title="Nginx 配置跨域访问"></a>Nginx 配置跨域访问</h3><p>默认情况下，当在 Waline 服务端的环境变量里添加了 <code>SITE_URL</code> 属性，那么 Nginx 的反向代理不再需要配置跨域，因为 Waline Server 会自动将 <code>SITE_URL</code> 添加到允许跨域的名单里。若 Waline Server 自带的跨域配置不能满足要求，可以参考以下内容自行配置 Nginx 的跨域。</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">location /comment {</span><br><span class="line">     # 清除Waline自带的跨域Header</span><br><span class="line">     proxy_hide_header Access-Control-Allow-Origin;</span><br><span class="line">     proxy_hide_header Access-Control-Allow-Methods;</span><br><span class="line">     proxy_hide_header Access-Control-Allow-Headers;</span><br><span class="line">     proxy_hide_header Access-Control-Allow-Credentials;</span><br><span class="line"></span><br><span class="line">     # 添加自定义的跨域Header</span><br><span class="line">     add_header 'Access-Control-Allow-Origin' '*' always;</span><br><span class="line">     add_header 'Access-Control-Allow-Credentials' 'true' always;</span><br><span class="line">     add_header 'Access-Control-Allow-Methods' 'GET,HEAD,PUT,POST,DELETE,PATCH,OPTIONS' always;</span><br><span class="line">     add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Origin' always;</span><br><span class="line"></span><br><span class="line">     # 反向代理</span><br><span class="line">     proxy_pass http://$server_name;</span><br><span class="line">     proxy_set_header Host $host:$server_port;</span><br><span class="line">     proxy_set_header X-NginX-Proxy true;</span><br><span class="line">     proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">     proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">     proxy_set_header REMOTE-HOST $remote_addr;</span><br><span class="line"></span><br><span class="line">     # 缓存</span><br><span class="line">     add_header X-Cache $upstream_cache_status;</span><br><span class="line">     add_header Cache-Control no-cache;</span><br><span class="line">     expires 12h;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block;text-align:center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-4014850419768221" data-ad-slot="7606918662"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><h2 id="Next-主题安装-Waline-官方插件"><a href="#Next-主题安装-Waline-官方插件" class="headerlink" title="Next 主题安装 Waline 官方插件"></a>Next 主题安装 Waline 官方插件</h2><h3 id="安装-Waline-官方插件"><a href="#安装-Waline-官方插件" class="headerlink" title="安装 Waline 官方插件"></a>安装 Waline 官方插件</h3><p>Waline 官方插件的版本必须与 Next 主题的版本匹配，否则 Waline 官方插件无法正常使用，两者的兼容性说明如下：</p><table><thead><tr><th>Next 主题的版本</th><th> Waline 官方插件的版本</th></tr></thead><tbody><tr><td> &lt;= 8.3.0</td><td>&lt;= 1.0.8</td></tr><tr><td>&gt;= 8.4.0</td><td>&gt;= 2.0.0</td></tr></tbody></table><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入博客的根目录</span></span><br><span class="line"><span class="keyword">$ cd</span> /blog-root</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装Waline插件（默认是最新版本）</span></span><br><span class="line"><span class="keyword">$ npm</span> install @waline/hexo-next<span class="params"> --save</span></span><br></pre></td></tr></tbody></table></figure><h3 id="配置-Waline-官方插件"><a href="#配置-Waline-官方插件" class="headerlink" title="配置 Waline 官方插件"></a>配置 Waline 官方插件</h3><p>更改 Next 主题的配置文件 <code>themes/next/_config.yml</code>，添加以下内容，其中 <code>serverURL</code> 是 Waline Server 的访问 URL，需要自行更改该属性的值</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Waline Config File</span></span><br><span class="line"><span class="comment"># For more information:</span></span><br><span class="line"><span class="comment"># - https://waline.js.org</span></span><br><span class="line"><span class="comment"># - https://waline.js.org/reference/component.html</span></span><br><span class="line"><span class="attr">waline:</span></span><br><span class="line">  <span class="comment"># New! Whether enable this plugin</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Waline server address url, you should set this to your own link</span></span><br><span class="line">  <span class="attr">serverURL:</span> <span class="string">https://waline.vercel.app</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Waline library CDN url, you can set this to your preferred CDN</span></span><br><span class="line">  <span class="comment"># libUrl: https://unpkg.com/@waline/client@v2/dist/waline.js</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Waline CSS styles CDN url, you can set this to your preferred CDN</span></span><br><span class="line">  <span class="attr">cssUrl:</span> <span class="string">https://unpkg.com/@waline/client@v2/dist/waline.css</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Custom locales</span></span><br><span class="line">  <span class="comment"># locale:</span></span><br><span class="line">  <span class="comment">#   placeholder: Welcome to comment # Comment box placeholder</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># If false, comment count will only be displayed in post page, not in home page</span></span><br><span class="line">  <span class="attr">commentCount:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Pageviews count, <span class="doctag">Note:</span> You should not enable both `waline.pageview` and `leancloud_visitors`.</span></span><br><span class="line">  <span class="attr">pageview:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Custom emoji</span></span><br><span class="line">  <span class="comment"># emoji:</span></span><br><span class="line">  <span class="comment">#   - https://unpkg.com/@waline/emojis@1.0.1/weibo</span></span><br><span class="line">  <span class="comment">#   - https://unpkg.com/@waline/emojis@1.0.1/alus</span></span><br><span class="line">  <span class="comment">#   - https://unpkg.com/@waline/emojis@1.0.1/bilibili</span></span><br><span class="line">  <span class="comment">#   - https://unpkg.com/@waline/emojis@1.0.1/qq</span></span><br><span class="line">  <span class="comment">#   - https://unpkg.com/@waline/emojis@1.0.1/tieba</span></span><br><span class="line">  <span class="comment">#   - https://unpkg.com/@waline/emojis@1.0.1/tw-emoji</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Comment infomation, valid meta are nick, mail and link</span></span><br><span class="line">  <span class="comment"># meta:</span></span><br><span class="line">  <span class="comment">#   - nick</span></span><br><span class="line">  <span class="comment">#   - mail</span></span><br><span class="line">  <span class="comment">#   - link</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Set required meta field, e.g.: [nick] | [nick, mail]</span></span><br><span class="line">  <span class="comment"># requiredMeta:</span></span><br><span class="line">  <span class="comment">#   - nick</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Language, available values: en-US, zh-CN, zh-TW, pt-BR, ru-RU, jp-JP</span></span><br><span class="line">  <span class="comment"># lang: zh-CN</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Word limit, no limit when setting to 0</span></span><br><span class="line">  <span class="comment"># wordLimit: 0</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Whether enable login, can choose from 'enable', 'disable' and 'force'</span></span><br><span class="line">  <span class="comment"># login: enable</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># comment per page</span></span><br><span class="line">  <span class="comment"># pageSize: 10</span></span><br></pre></td></tr></tbody></table></figure><h3 id="更改-Next-主题的样式"><a href="#更改-Next-主题的样式" class="headerlink" title="更改 Next 主题的样式"></a>更改 Next 主题的样式</h3><p>由于 Next 主题默认对所有图片都添加了 <code>display: block;</code> CSS 样式，这会导致 Waline 的表情包图片独立一行显示，需要往 Next 主题里添加以下自定义样式来解决，例如更改样式文件 <code>themes/next/source/css/_common/scaffolding/base.styl</code></p><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.wl-content</span> <span class="selector-class">.vemoji</span>, <span class="selector-class">.wl-content</span> <span class="selector-class">.wl-emoji</span> {</span><br><span class="line">  <span class="attribute">display</span>: inline <span class="meta">!important</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="Hexo-构建失败的解决方法"><a href="#Hexo-构建失败的解决方法" class="headerlink" title="Hexo 构建失败的解决方法"></a>Hexo 构建失败的解决方法</h3><p>若 Next 主题安装 Waline 官方插件后，执行 <code>hexo g</code> 命令抛出以下异常，这是由于 Hexo 或者 Next 的版本过低导致，此时需要升级 Hexo 或者 Next 的版本</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">ERROR Render HTML failed: index.html</span><br><span class="line">TypeError: Cannot read property 'parent' of null</span><br><span class="line">    at Function.exports.update (/usr/local/hexo/node_modules/cheerio/lib/parse.js:55:26)</span><br><span class="line">    at module.exports (/usr/local/hexo/node_modules/cheerio/lib/parse.js:17:11)</span><br><span class="line">    at Function.exports.load (/usr/local/hexo/node_modules/cheerio/lib/static.js:22:14)</span><br><span class="line">    at Hexo.hexoMetaGeneratorInject (/usr/local/hexo/node_modules/hexo/lib/plugins/filter/meta_generator.js:8:21)</span><br><span class="line">    at Hexo.tryCatcher (/usr/local/hexo/node_modules/bluebird/js/release/util.js:16:23)</span><br><span class="line">    at Hexo.&lt;anonymous&gt; (/usr/local/hexo/node_modules/bluebird/js/release/method.js:15:34)</span><br><span class="line">    at Promise.each.filter (/usr/local/hexo/node_modules/hexo/lib/extend/filter.js:60:50)</span><br><span class="line">    at tryCatcher (/usr/local/hexo/node_modules/bluebird/js/release/util.js:16:23)</span><br><span class="line">    at Object.gotValue (/usr/local/hexo/node_modules/bluebird/js/release/reduce.js:166:18)</span><br><span class="line">    at Object.gotAccum (/usr/local/hexo/node_modules/bluebird/js/release/reduce.js:155:25)</span><br><span class="line">    at Object.tryCatcher (/usr/local/hexo/node_modules/bluebird/js/release/util.js:16:23)</span><br><span class="line">    at Promise._settlePromiseFromHandler (/usr/local/hexo/node_modules/bluebird/js/release/promise.js:547:31)</span><br><span class="line">    at Promise._settlePromise (/usr/local/hexo/node_modules/bluebird/js/release/promise.js:604:18)</span><br><span class="line">    at Promise._settlePromiseCtx (/usr/local/hexo/node_modules/bluebird/js/release/promise.js:641:10)</span><br><span class="line">    at _drainQueueStep (/usr/local/hexo/node_modules/bluebird/js/release/async.js:97:12)</span><br><span class="line">    at _drainQueue (/usr/local/hexo/node_modules/bluebird/js/release/async.js:86:9)</span><br><span class="line">    at Async._drainQueues (/usr/local/hexo/node_modules/bluebird/js/release/async.js:102:5)</span><br><span class="line">    at Immediate.Async.drainQueues [as _onImmediate] (/usr/local/hexo/node_modules/bluebird/js/release/async.js:15:14)</span><br><span class="line">    at runCallback (timers.js:705:18)</span><br><span class="line">    at tryOnImmediate (timers.js:676:5)</span><br><span class="line">    at processImmediate (timers.js:658:5)</span><br></pre></td></tr></tbody></table></figure><h2 id="Waline-第三方插件列表"><a href="#Waline-第三方插件列表" class="headerlink" title="Waline 第三方插件列表"></a>Waline 第三方插件列表</h2><h3 id="hexo-waline-next"><a href="#hexo-waline-next" class="headerlink" title="hexo-waline-next"></a>hexo-waline-next</h3><ul><li><a target="_blank" rel="external nofollow" href="https://github.com/rqh656418510/hexo-waline-next">hexo-waline-next</a>，一款更强大且适用于 Next 主题的 Waline 插件，支持上传评论图片到七牛图床</li></ul><h3 id="hexo-next-darkmode"><a href="#hexo-next-darkmode" class="headerlink" title="hexo-next-darkmode"></a>hexo-next-darkmode</h3><ul><li><a target="_blank" rel="external nofollow" href="https://github.com/rqh656418510/hexo-next-darkmode">hexo-next-darkmode</a>，一款适用于 Waline 与 Next 主题的暗黑模式切换插件，详细的使用说明请看<a href="/posts/ae18fb85.html#%E5%90%AF%E7%94%A8%E6%9A%97%E9%BB%91%E6%A8%A1%E5%BC%8F">这里</a></li></ul><h2 id="Waline-进阶配置"><a href="#Waline-进阶配置" class="headerlink" title="Waline 进阶配置"></a>Waline 进阶配置</h2><h3 id="客户端使用-CDN"><a href="#客户端使用-CDN" class="headerlink" title="客户端使用 CDN"></a>客户端使用 CDN</h3><p>Waline 客户端若想使用 CDN 加速，只需在 Next 主题的 <code>_config.yml</code> 配置文件中，更改 Waline 官方插件的配置（如下所示）即可。由于 Waline 采用 Client/Server 架构，客户端与服务端的版本一般需要匹配才能正常运行；因此不建议每次自动都获取最新版的客户端文件，而是推荐日后统一更新客户端与服务端的版本。</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取最新版本的Waline</span></span><br><span class="line"><span class="attr">waline:</span></span><br><span class="line">  <span class="attr">libUrl:</span> <span class="string">https://unpkg.com/@waline/client@v2/dist/waline.js</span></span><br><span class="line">  <span class="attr">cssUrl:</span> <span class="string">https://unpkg.com/@waline/client@v2/dist/waline.css</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取指定版本的Waline</span></span><br><span class="line"><span class="attr">waline:</span></span><br><span class="line">  <span class="attr">libUrl:</span> <span class="string">https://unpkg.com/@waline/client@2.0.7/dist/waline.js</span></span><br><span class="line">  <span class="attr">cssUrl:</span> <span class="string">https://unpkg.com/@waline/client@2.0.7/dist/waline.css</span></span><br></pre></td></tr></tbody></table></figure><h3 id="验证用户注册邮箱"><a href="#验证用户注册邮箱" class="headerlink" title="验证用户注册邮箱"></a>验证用户注册邮箱</h3><p>用户注册和评论的邮件通知都会用到邮件服务，配置邮件服务相关变量后，用户注册流程会增加邮箱验证码确认相关的操作，用来防止恶意的注册。</p><table><thead><tr><th>环境变量名称</th><th>备注</th></tr></thead><tbody><tr><td><code>SMTP_SERVICE</code></td><td>SMTP 邮件发送服务提供商</td></tr><tr><td><code>SMTP_HOST</code></td><td>SMTP 服务器地址，一般可以在邮箱的设置中找到。</td></tr><tr><td><code>SMTP_PORT</code></td><td>SMTP 服务器端口，一般可以在邮箱的设置中找到。</td></tr><tr><td><code>SMTP_USER</code></td><td>SMTP 邮件发送服务的用户名，一般为登录邮箱。</td></tr><tr><td><code>SMTP_PASS</code></td><td>SMTP 邮件发送服务的密码，一般为邮箱登录密码，部分邮箱 (例如 163) 是单独的 SMTP 密码。</td></tr><tr><td><code>SENDER_NAME</code></td><td>自定义发送邮件的发件人</td></tr><tr><td><code>SENDER_EMAIL</code></td><td>自定义发送邮件的发件地址</td></tr></tbody></table><blockquote><p>提示：可以在<a target="_blank" rel="external nofollow" href="https://github.com/nodemailer/nodemailer/blob/master/lib/well-known/services.json">这里</a>查看支持的邮箱服务商，<code>SMTP_SERVICE</code> 和 (<code>SMTP_HOST</code>、<code>SMTP_PORT</code>）任选其一进行配置即可。如果在邮箱服务商列表中没有对应的 <code>SMTP_SERVICE</code> ，则需要同时配置 <code>SMTP_HOST</code> 和 <code>SMTP_PORT</code>。</p></blockquote><h3 id="客户端配置用户头像"><a href="#客户端配置用户头像" class="headerlink" title="客户端配置用户头像"></a>客户端配置用户头像</h3><p>Waline 目前使用 <a target="_blank" rel="external nofollow" href="https://www.libravatar.org/">Libravatar</a> 来获取评论列表头像。Libravatar 是自由、开放的头像服务，支持联邦托管并与 <a target="_blank" rel="external nofollow" href="http://cn.gravatar.com/">Gravatar</a> 完全兼容。首先博主或者用户自行使用邮箱登录或注册 <a target="_blank" rel="external nofollow" href="https://www.libravatar.org/">Libravatar</a>，然后更改自己的 Libravatar 头像。当在博客评论的时候，留下在 Libravatar 注册时所使用的邮箱即可，或者使用 Waline 客户端提供的登录功能；最后 Waline 会自动根据邮箱地址去 Libravatar 获取用户的头像，当未能从 Libravatar 查询到头像时，将会自动转为从 <a target="_blank" rel="external nofollow" href="http://cn.gravatar.com/">Gravatar</a> 查询。目前 Waline 非自定义头像有以下 7 种默认值可选：</p><p><img data-src="../../../asset/2021/04/waline-avatar.png" alt="waline-avatar"></p><p>在 Waline Server 中，通过配置环境变量 <code>GRAVATAR_STR</code> 来指定 Libravatar 头像服务的地址（基于 Nunjucks 语法），这样就可以自定义客户端所使用的用户头像类型，如下所示：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRAVATAR_STR: 'https://seccdn.libravatar.org/avatar/{{mail|md5}}?d=robohash'</span><br></pre></td></tr></tbody></table></figure><p>若 Libravatar 或者 Gravatar 在国内被墙，此时还可以使用 <a target="_blank" rel="external nofollow" href="https://cravatar.cn/">Cravatar</a> 替代。在 Waline Server 中配置以下环境变量，就可以快速切换到 Cravatar，并自定义客户端所使用的用户头像类型：</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">AVATAR_PROXY:</span> <span class="string">'false'</span></span><br><span class="line"><span class="attr">GRAVATAR_STR:</span> <span class="string">'https://cravatar.cn/avatar/<span class="template-variable">{{mail|md5}}</span>?d=robohash'</span></span><br></pre></td></tr></tbody></table></figure><div class="admonition warning"><p class="admonition-title">特别注意</p><p>尽管诸如谷歌、QQ 等邮件提供商对电子邮件不区分大小写，但是你仍需要保证 Libravatar 或者 Gravatar 注册的邮箱和填入的邮箱地址对应。虽然全球大部分大型邮件提供商均不对电子邮件用户名区分大小写，但是根据 <code>RFC 5231</code> 的规定，电子邮件是区分大小写的。这意味着邮件提供商可以将 <code>abc@xxx.com</code> 和 <code>ABC@xxx.com</code> 视为不同的账号，而且也的确有邮件提供商这样处理。所以为防止使用此类邮件提供商的用户无法收到邮件或显示错误的头像，Waline 并不会对邮箱进行大小写转换。</p></div><h3 id="服务端配置评论通知"><a href="#服务端配置评论通知" class="headerlink" title="服务端配置评论通知"></a>服务端配置评论通知</h3><p>当博客有用户发布评论或者用户回复评论时，Waline 支持对博主和回复评论作者进行通知。博主评论通知支持邮件、微信、QQ 与 Telegram，回复评论作者仅支持邮件通知。由于篇幅有限，这里仅介绍邮箱通知的配置，其他的通知方式可参考<a target="_blank" rel="external nofollow" href="https://waline.js.org/guide/server/notification.html#%E9%82%AE%E4%BB%B6%E9%80%9A%E7%9F%A5">官方文档</a>。邮件通知需要在环境变量中配置以下属性：</p><ul><li><code>AUTHOR_EMAIL</code>：博主邮箱，用来区分发布的评论是否是博主本身发布的。如果是博主发布的则不进行提醒通知。</li><li><code>SMTP_SERVICE</code>：SMTP 邮件发送服务提供商，可以在 <a target="_blank" rel="external nofollow" href="https://github.com/nodemailer/nodemailer/blob/master/lib/well-known/services.json">这里</a> 查看所有支持的运营商。如果没在列表中的可以自行配置 <code>SMTP_HOST</code> 和 <code>SMTP_PORT</code>。</li><li><code>SMTP_HOST</code>：SMTP 服务器地址，一般可以在邮箱的设置中找到。如果未配置 <code>SMTP_SERVICE</code> 的话该项必填。</li><li><code>SMTP_PORT</code>：SMTP 服务器端口，一般可以在邮箱的设置中找到。如果未配置 <code>SMTP_SERVICE</code> 的话该项必填。</li><li><code>SMTP_USER</code>：SMTP 邮件发送服务的用户名，一般为登录邮箱。</li><li><code>SMTP_PASS</code>：SMTP 邮件发送服务的密码，一般为邮箱登录密码，部分邮箱（例如 163）是单独的 SMTP 密码。</li><li><code>SMTP_SECURE</code>： SMTP 邮件发送加密，默认为 <code>true</code>，设置为 <code>false</code> 则不会加密请求</li><li><code>SITE_NAME</code>：网站名称，用于在消息中显示。</li><li><code>SITE_URL</code>：网站地址，用于在消息中显示。</li><li><code>SENDER_NAME</code>：自定义发送邮件的发件人，选填。</li><li><code>SENDER_EMAIL</code>：自定义发送邮件的发件地址，选填。</li><li><code>MAIL_SUBJECT</code>：评论回复邮件标题自定义</li><li><code>MAIL_TEMPLATE</code>：评论回复邮件内容自定义</li><li><code>MAIL_SUBJECT_ADMIN</code>：新评论通知邮件标题自定义</li><li><code>MAIL_TEMPLATE_ADMIN</code>：新评论通知邮件内容自定义</li></ul><div class="admonition note"><p class="admonition-title">提示</p><ol><li>用户注册和评论的邮件通知都会用到邮件服务</li><li>由于国内腾讯云、阿里云默认禁用了 25 端口，若 Waline 的服务端是部署在云服务器上，则需要使用 <code>465</code> 端口，并启用 SSL 邮件加密，最后系统防火墙别忘了开放 <code>465</code> 端口</li></ol></div><h2 id="Waline-Client-的其他特性"><a href="#Waline-Client-的其他特性" class="headerlink" title="Waline Client 的其他特性"></a>Waline Client 的其他特性</h2><h3 id="自定义样式"><a href="#自定义样式" class="headerlink" title="自定义样式"></a>自定义样式</h3><p>Waline 客户端默认提供了一些 CSS 变量，可以很轻松的通过这些变量自定义 Waline 客户端的 CSS 样式：</p><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-pseudo">:root</span> {</span><br><span class="line">  <span class="comment">/* 字体大小 */</span></span><br><span class="line">  --waline-<span class="attribute">font-size</span>: <span class="number">16px</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 常规颜色 */</span></span><br><span class="line">  --waline-white: <span class="number">#fff</span>;</span><br><span class="line">  --waline-light-grey: <span class="number">#999</span>;</span><br><span class="line">  --waline-dark-grey: <span class="number">#666</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 主题色 */</span></span><br><span class="line">  --waline-theme-<span class="attribute">color</span>: <span class="number">#27ae60</span>;</span><br><span class="line">  --waline-active-<span class="attribute">color</span>: <span class="number">#2ecc71</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 布局颜色 */</span></span><br><span class="line">  --waline-<span class="attribute">color</span>: <span class="number">#444</span>;</span><br><span class="line">  --waline-bgcolor: <span class="number">#fff</span>;</span><br><span class="line">  --waline-bgcolor-light: <span class="number">#f8f8f8</span>;</span><br><span class="line">  --waline-bgcolor-hover: <span class="number">#f0f0f0</span>;</span><br><span class="line">  --waline-<span class="attribute">border-color</span>: <span class="number">#ddd</span>;</span><br><span class="line">  --waline-disable-bgcolor: <span class="number">#f8f8f8</span>;</span><br><span class="line">  --waline-disable-<span class="attribute">color</span>: <span class="number">#bbb</span>;</span><br><span class="line">  --waline-<span class="selector-tag">code</span>-bgcolor: <span class="number">#282c34</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 特殊颜色 */</span></span><br><span class="line">  --waline-bq-<span class="attribute">color</span>: <span class="number">#f0f0f0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 头像 */</span></span><br><span class="line">  --waline-avatar-size: <span class="number">3.25rem</span>;</span><br><span class="line">  --waline-m-avatar-size: <span class="built_in">calc</span>(<span class="built_in">var</span>(--waline-avatar-size) * <span class="number">9</span> / <span class="number">13</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 徽章 */</span></span><br><span class="line">  --waline-badge-<span class="attribute">color</span>: <span class="number">#3498db</span>;</span><br><span class="line">  --waline-badge-<span class="attribute">font-size</span>: <span class="number">0.775em</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 信息 */</span></span><br><span class="line">  --waline-info-bgcolor: <span class="number">#f8f8f8</span>;</span><br><span class="line">  --waline-info-<span class="attribute">color</span>: <span class="number">#999</span>;</span><br><span class="line">  --waline-info-<span class="attribute">font-size</span>: <span class="number">0.625em</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 渲染选择 */</span></span><br><span class="line">  --waline-<span class="attribute">border</span>: <span class="number">1px</span> solid <span class="built_in">var</span>(--waline-border-color);</span><br><span class="line">  --waline-avatar-radius: <span class="number">50%</span>;</span><br><span class="line">  --waline-<span class="attribute">box-shadow</span>: none;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>如果使用了一个大量运用阴影 (box-shadow) 的主题，可以通过修改 <code>--waline-border</code> 和 <code>--waline-box-shadow</code> 来更改 Waline 客户端的阴影样式，如:</p><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-pseudo">:root</span> {</span><br><span class="line">  --waline-<span class="attribute">border</span>: none;</span><br><span class="line">  --waline-<span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">12px</span> <span class="number">40px</span> <span class="built_in">rgb</span>(<span class="number">134</span> <span class="number">151</span> <span class="number">168</span> / <span class="number">25%</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span> (<span class="attribute">prefers-color-scheme</span>: dark) {</span><br><span class="line">  <span class="selector-tag">body</span> {</span><br><span class="line">    --waline-<span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">12px</span> <span class="number">40px</span> <span class="number">#0f0e0d</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>如果上面的 CSS 变量无法满足你对 Waline 样式的定制要求，你可以停止导入 Waline 官方提供的样式，并自己制作 CSS。</p><h3 id="自定义表情包"><a href="#自定义表情包" class="headerlink" title="自定义表情包"></a>自定义表情包</h3><ul><li><a target="_blank" rel="external nofollow" href="https://waline.js.org/guide/client/emoji.html">Waline 客户端自定义表情包</a></li></ul><h3 id="启用暗黑模式"><a href="#启用暗黑模式" class="headerlink" title="启用暗黑模式"></a>启用暗黑模式</h3><p>Waline 客户端默认支持暗黑模式，只需在 Waline 客户端初始化的时候，指定 <code>dark</code> 参数即可</p><ul><li>设置 <code>dark: auto</code> 会根据设备颜色模式自动切换</li><li>填入 CSS 选择器，则会在对应选择器生效时启用暗黑模式</li></ul><p>针对不同的 Hexo 主题，Waline 客户端的配置示例如下：</p><ul><li><code>vuepress-theme-hope</code>：它会在 <code>&lt;body&gt;</code> 上添加 <code>theme-dark</code> class 来开启暗黑模式，那么需要将 <code>dark</code> 选项设置为 <code>body.theme-dark</code></li><li><code>Docusaurus</code>：它会在 <code>&lt;html&gt;</code> 上通过设置 <code>data-theme="dark"</code> 开启暗黑模式，那么需要将 <code>dark</code> 选项设置为 <code>'html[data-theme="dark"]'</code></li><li><code>hexo-theme-fluid</code>：它会在 <code>&lt;html&gt;</code> 上通过设置 <code>data-user-color-scheme="dark"</code> 开启暗黑模式，那么需要将 <code>dark</code> 选项设置为 <code>'html[data-user-color-scheme="dark"]'</code></li></ul><hr><p>若 Hexo 使用的是 Next 主题，且是通过插件 <a target="_blank" rel="external nofollow" href="https://github.com/rqh656418510/hexo-next-darkmode">hexo-next-darkmode</a> 来自动添加可切换的暗黑模式，那么可以在 Next 主题的 <code>_config.yml</code> 配置文件里添加以下内容来启用 Waline 客户端的暗黑模式</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">waline:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">dark:</span> <span class="string">'body.darkmode--activated'</span></span><br><span class="line">  <span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>在暗黑模式下，Waline 客户端默认会使用以下样式，若希望自定义暗黑模式的 CSS 样式，直接覆盖以下 CSS 样式即可。</p><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 根据用户设置 ↓ */</span></span><br><span class="line">darkmode-selector {</span><br><span class="line">  <span class="comment">/* 常规颜色 */</span></span><br><span class="line">  --waline-white: <span class="number">#000</span>;</span><br><span class="line">  --waline-light-grey: <span class="number">#666</span>;</span><br><span class="line">  --waline-dark-grey: <span class="number">#999</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 布局颜色 */</span></span><br><span class="line">  --waline-<span class="attribute">color</span>: <span class="number">#888</span>;</span><br><span class="line">  --waline-bgcolor: <span class="number">#1e1e1e</span>;</span><br><span class="line">  --waline-bgcolor-light: <span class="number">#272727</span>;</span><br><span class="line">  --waline-<span class="attribute">border-color</span>: <span class="number">#333</span>;</span><br><span class="line">  --waline-disable-bgcolor: <span class="number">#444</span>;</span><br><span class="line">  --waline-disable-<span class="attribute">color</span>: <span class="number">#272727</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 特殊颜色 */</span></span><br><span class="line">  --waline-bq-<span class="attribute">color</span>: <span class="number">#272727</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 其他颜色 */</span></span><br><span class="line">  --waline-info-bgcolor: <span class="number">#272727</span>;</span><br><span class="line">  --waline-info-<span class="attribute">color</span>: <span class="number">#666</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">提示</p><p>Next 主题使用插件 <a target="_blank" rel="external nofollow" href="https://github.com/rqh656418510/hexo-next-darkmode">hexo-next-darkmode</a> 来自动添加可切换的暗黑模式，详细的步骤可以参考<a href="/posts/abf4aee1.html">这篇博客</a>。</p></div><h3 id="Github-社交登录"><a href="#Github-社交登录" class="headerlink" title="Github 社交登录"></a>Github 社交登录</h3><p>最新版 Waline 增加了登录评论功能，除了普通的账号登录之外，还支持使用第三方社交账号进行直接登录。目前官方支持 Github 社交账号登录，当然默认没有开启 Github 社交账号登录功能，需要做一些配置才能支持。若要增加 Github 账号登录功能，需要配置 Github OAuth 密钥。点击 <a target="_blank" rel="external nofollow" href="https://github.com/settings/applications/new">《Register a new OAuth application》</a> 进入 Github OAuth 应用申请页面，这里需要填入以下几个配置：</p><ul><li>Application name：应用名称，可以随意，会在用户授权时显示，推荐使用博客名称。</li><li>Homepage URL：应用主页地址，可以随意，会在用户授权时显示，推荐使用博客地址。</li><li>Appcation description：应用描述，可以随意，会在用户授权时显示，非必填项。</li><li>Authorization callback URL：应用的回调地址，登录时需要使用。填入 <code>&lt;serverURL&gt;/oauth/github</code> 其中 <code>&lt;serverURL&gt;</code> 是你的 Waline 服务端地址。</li></ul><p>填完后点击 <code>Register application</code> 按钮就成功创建应用了，可以在页面中看到 <code>Client ID</code>。点击 <code>Client secrets</code> 栏右边的 <code>Generate a new client secret</code> 按钮，可以获取到该应用的 <code>Client secrets</code>。</p><hr><p>最后按照如下环境变量配置，将上面获取到的密钥（<code>Client secrets</code>）配置进 Waline 服务端的环境变量中，然后重新部署 Waline 服务端后即可使用 Github 登录。</p><table><thead><tr><th>环境变量名称</th><th>备注</th></tr></thead><tbody><tr><td><code>GITHUB_ID</code></td><td>对应 Github OAuth Application 中的 Client ID</td></tr><tr><td><code>GITHUB_SECRET</code></td><td>对应 Github OAuth Application 中的 Client secrets</td></tr></tbody></table><blockquote><p>由于 Github 的 API 调用在国内不太稳定，建议直接使用普通的账号登录</p></blockquote><h3 id="上传图片至七牛图床"><a href="#上传图片至七牛图床" class="headerlink" title="上传图片至七牛图床"></a>上传图片至七牛图床</h3><p>Waline 客户端内置了图像上传的支持，默认会将图片转换为 Base64 字符串，然后通过 Waline Server 进行存储，例如将图片存储到 MySQL。在 Hexo 的 Next 主题下，若希望使用<a target="_blank" rel="external nofollow" href="https://www.qiniu.com/">七牛图床</a>，则可以安装 Waline 的第三方插件 <a target="_blank" rel="external nofollow" href="https://github.com/rqh656418510/hexo-waline-next">hexo-waline-next</a> 来实现。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 卸载Waline官方插件</span></span><br><span class="line"><span class="keyword">$ npm</span> uninstall @waline/hexo-next<span class="params"> --save</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装Waline第三方插件（默认是最新版本）</span></span><br><span class="line"><span class="keyword">$ npm</span> install hexo-waline-next<span class="params"> --save</span></span><br></pre></td></tr></tbody></table></figure><p>第三方插件 <code>hexo-waline-next</code> 使用了七牛官方的 <code>Qiniu-JavaScript-SDK</code> ，为了安全考虑，默认没有包含 <code>Upload Token</code> 的生成实现，因此 <code>Upload Token</code> 需要通过网络从服务端（自建）获取，服务端代码可以参考<a target="_blank" rel="external nofollow" href="https://developer.qiniu.com/kodo/1239/java">七牛服务端 SDK 的文档</a>，插件的配置示例如下：</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">waline:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">qiniuDebug:</span> <span class="literal">false</span>                                                   <span class="comment"># print the error message of the picture uploaded by qiniu</span></span><br><span class="line">  <span class="attr">qiniuDomain:</span> <span class="string">https://qiniu.example.cn</span>                               <span class="comment"># The custom domain for qiniu, e.g https://qiniu.example.cn</span></span><br><span class="line">  <span class="attr">qiniuTokenUrl:</span> <span class="string">https://api.example.cn/qiniu/sdk/token/upload</span>        <span class="comment"># The api to get qiniu token, e.g https://api.example.cn/qiniu/sdk/token/upload</span></span><br><span class="line">  <span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><ul><li><code>qiniuDomain</code>：七牛的外链域名</li><li><code>qiniuDebug</code>：前端是否输出七牛上传图片的错误信息</li><li><code>qiniuTokenUrl</code>：获取七牛 Upload Token 的接口地址</li></ul><hr><p>若希望禁用图片上传的功能，可以使用以下配置内容，适用于 Waline 客户端默认的图片上传和七牛图床上传：</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">waline:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">allowUploadImage:</span> <span class="literal">false</span>       <span class="comment"># Allow upload picture</span></span><br><span class="line">  <span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><ul><li><code>allowUploadImage</code>：是否允许上传图片，默认值为：<code>true</code></li></ul><hr><p>第三方插件 <code>hexo-waline-next</code> 对七牛 Upload Token 接口返回数据（JSON）的定义如下：</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="attr">"data"</span>: <span class="string">"tdvdhnpSs2JFt8U9-c9hL74ddWtEj"</span>,</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"success"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><table><thead><tr><th>参数名称</th><th>类型</th><th>实例值</th><th>说明</th></tr></thead><tbody><tr><td> status code</td><td>Number</td><td>200</td><td>HTTP 响应状态码，成功返回 200，非法请求来源返回 403，接口调用太频繁返回 429，系统内部出错返回 500</td></tr><tr><td>data</td><td>String</td><td>tdvdhnpSs2JFt8U9-c9hL74ddWtEj</td><td>Upload Token 的值</td></tr><tr><td> msg</td><td>String</td><td>success</td><td> 消息提示内容</td></tr></tbody></table><p>提高七牛 Upload Token 接口的安全性：</p><ul><li>全站启用 HTTPS 协议</li><li>通过 HTTP Header 的 <code>referer</code> 、 <code>X-Real-IP</code> 、<code>X-Forwarded-For</code> 等来限制请求来源的域名、IP</li><li> 获取 Upload Token 的接口应该内置限流功能，避免外部恶意频繁调用接口，例如限制每分钟只能调用两次接口</li><li>服务端生成 Upload Token 时，应该指定上传策略，例如设置 Token 的有效时间（<code>expires</code>、<code>deadline</code>），具体可参考<a target="_blank" rel="external nofollow" href="https://developer.qiniu.com/kodo/manual/put-policy">七牛官方文档一</a>、<a target="_blank" rel="external nofollow" href="https://developer.qiniu.com/kodo/1239/java">七牛官方文档二</a>，Java 版服务端的示例代码如下：</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">String bucket = <span class="string">"bucket name"</span>;</span><br><span class="line">String accessKey = <span class="string">"access key"</span>;</span><br><span class="line">String secretKey = <span class="string">"secret key"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//指定UploadToken的有效时间为10秒</span></span><br><span class="line"><span class="keyword">long</span> expireSeconds = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">StringMap putPolicy = <span class="keyword">new</span> StringMap();</span><br><span class="line">Auth auth = Auth.create(accessKey, secretKey);</span><br><span class="line">String upToken = auth.uploadToken(bucket, <span class="keyword">null</span>, expireSeconds, putPolicy);</span><br><span class="line">System.out.println(upToken);</span><br></pre></td></tr></tbody></table></figure><h2 id="Waline-开发指南"><a href="#Waline-开发指南" class="headerlink" title="Waline 开发指南"></a>Waline 开发指南</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ol><li>使用 Git 克隆项目</li></ol><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$ git</span> <span class="built_in">clone</span> https://github.com/lizheming/waline.git</span><br></pre></td></tr></tbody></table></figure><ol start="2"><li>保证 NPM 的版本是 7</li></ol><blockquote><p>Node 14 及以下默认使用 <code>npm@v6</code>，你需要确保自己使用 <code>npm@v7</code> 版本，否则运行或者编译构建 Waline 组件时会出错</p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装最新版的NPM</span></span><br><span class="line"><span class="keyword">$ npm</span> i<span class="params"> -g</span> npm@latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看NPM的版本</span></span><br><span class="line"><span class="keyword">$ npm</span><span class="params"> -v</span></span><br></pre></td></tr></tbody></table></figure><ol start="3"><li>安装依赖</li></ol><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$ cd</span> waline</span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">$ npm</span> i</span><br></pre></td></tr></tbody></table></figure><h3 id="本地开发"><a href="#本地开发" class="headerlink" title="本地开发"></a>本地开发</h3><p>本地使用以下命令启动 <code>@waline/client</code>，由于 Waline 采用 Client/Server 架构，在调试 client 时，必须配置本地环境变量 <code>SERVERURL</code> 至 <code>waline/packages/client/.env</code>，其中在 <code>waline/packages/client/.env.example</code> 文件里有可参考的配置示例。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$ npm</span> run client:dev</span><br></pre></td></tr></tbody></table></figure><p><code>@waline/client</code> 正常启动时，输出的日志信息如下，此时浏览器直接访问 <code>http://127.0.0.1:9000</code> 就可以开始测试本地的 <code>@waline/client</code></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&gt; client:dev</span><br><span class="line">&gt; npm run dev --workspace=@waline/client</span><br><span class="line"></span><br><span class="line">&gt; @waline/client@1.3.3 dev</span><br><span class="line">&gt; webpack serve --mode=development --config ./build/webpack.config.js</span><br><span class="line"></span><br><span class="line">&lt;i&gt; [webpack-dev-server] Project is running at:</span><br><span class="line">&lt;i&gt; [webpack-dev-server] Loopback: http://127.0.0.1:9000</span><br><span class="line">&lt;i&gt; [webpack-dev-server] On Your Network (IPv4): http://192.168.1.128:9000/</span><br><span class="line">&lt;i&gt; [webpack-dev-server] Content not from webpack is served from '/usr/local/waline/packages/client/public' directory</span><br><span class="line">asset Waline.min.js 1010 KiB [emitted] (name: main) 1 related asset</span><br><span class="line">asset index.html 967 bytes [emitted]</span><br><span class="line">runtime modules 27.1 KiB 13 modules</span><br><span class="line">cacheable modules 832 KiB</span><br><span class="line">  modules by path ./src/ 95.3 KiB 48 modules</span><br><span class="line">  modules by path ../../node_modules/ 737 KiB</span><br><span class="line">    modules by path ../../node_modules/webpack-dev-server/client/ 48.9 KiB 12 modules</span><br><span class="line">    modules by path ../../node_modules/style-loader/dist/runtime/*.js 5.02 KiB 6 modules</span><br><span class="line">    modules by path ../../node_modules/webpack/hot/*.js 4.3 KiB 4 modules</span><br><span class="line">    modules by path ../../node_modules/html-entities/lib/*.js 81.3 KiB 4 modules</span><br><span class="line">    modules by path ../../node_modules/@vue/ 437 KiB 4 modules</span><br><span class="line">    modules by path ../../node_modules/url/ 37.4 KiB 3 modules</span><br><span class="line">    modules by path ../../node_modules/querystring/*.js 4.51 KiB</span><br><span class="line">      ../../node_modules/querystring/index.js 127 bytes [built] [code generated]</span><br><span class="line">      ../../node_modules/querystring/decode.js 2.34 KiB [built] [code generated]</span><br><span class="line">      ../../node_modules/querystring/encode.js 2.04 KiB [built] [code generated]</span><br><span class="line">webpack 5.50.0 compiled successfully in 3160 ms</span><br></pre></td></tr></tbody></table></figure><p>如果希望在 Hexo Next 主题里测试本地的 <code>@waline/client</code>，那么可以在 Next 的 <code>_config.yml</code> 配置文件中指定 Waline 插件的 <code>libUrl</code> 参数，配置示例如下：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">waline:</span><br><span class="line">  enable: true</span><br><span class="line">  libUrl: http://127.0.0.1:9000/Waline.min.js                # Set custom waline cdn url</span><br><span class="line">  ....</span><br></pre></td></tr></tbody></table></figure><hr><p>本地使用以下命令启动 <code>@waline/server</code>，为了使 <code>@waline/server</code> 能在本地正常运行，需要配置必要的本地环境变量至 <code>waline/example/.env</code>，其中在 <code>waline/example/.env.example</code> 文件里有可参考的配置示例。<code>@waline/server</code> 正常启动后，默认的服务器地址是 <code>http://127.0.0.1:9000</code>。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$ npm</span> run server:dev</span><br></pre></td></tr></tbody></table></figure><h3 id="编译构建"><a href="#编译构建" class="headerlink" title="编译构建"></a>编译构建</h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构建@waline/admin</span></span><br><span class="line"><span class="keyword">$ npm</span> run admin:build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建@waline/client</span></span><br><span class="line"><span class="keyword">$ npm</span> run client:build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者同时构建@waline/admin与@waline/client</span></span><br><span class="line"><span class="keyword">$ npm</span> run build</span><br></pre></td></tr></tbody></table></figure><p>Waline 组件编译构建完成后，默认会在 <code>waline/node_modules/@waline</code> 目录下生成对应的文件，目录结构如下：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">waline/node_modules/@waline</span><br><span class="line">├── admin -&gt; ../../packages/admin</span><br><span class="line">├── client -&gt; ../../packages/client</span><br><span class="line">├── cloudbase -&gt; ../../packages/cloudbase</span><br><span class="line">└── vercel -&gt; ../../packages/server</span><br></pre></td></tr></tbody></table></figure><blockquote><p>值得一提的是，以 <code>@waline/client</code> 组件为例，编译构建完成后，实际的输出路径是：<code>waline/packages/client/dist</code></p></blockquote><h2 id="Waline-常见问题"><a href="#Waline-常见问题" class="headerlink" title="Waline 常见问题"></a>Waline 常见问题</h2><h3 id="防止恶意刷评论"><a href="#防止恶意刷评论" class="headerlink" title="防止恶意刷评论"></a>防止恶意刷评论</h3><ul><li>Waline 服务端启用评论审核功能</li><li> Waline 服务端启用基于 IP 的评论发布频率限制功能</li><li> Waline 服务端启用客户端登录后才允许评论的功能，确保服务端的版本大于等于 <code>0.26.0</code>，同时 Waline 的客户端需要增加 <code>login=force</code> 的配置用于隐藏博客页面上的评论匿名输入框</li><li> Waline 的服务端如果启用客户端登录后才允许评论的功能，那么还需要在服务端的环境变量里配置邮件服务相关的参数；这是为了防止恶意注册，当配置了邮件服务相关的环境变量后，用户注册流程会增加邮箱验证码确认相关的操作</li></ul><h3 id="Waline-发布评论很慢"><a href="#Waline-发布评论很慢" class="headerlink" title="Waline 发布评论很慢"></a>Waline 发布评论很慢</h3><p>发布评论的时候因为一些特殊原因，例如垃圾邮件检测、评论通知都是串联操作。其中垃圾邮件检测使用的是 Akismet 提供的服务，这块由于调用国外服务可能会造成访问过慢，可以通过 <code>AKISMET_KEY=false</code> 后端环境变量关闭垃圾评论检测功能来定位问题。除了垃圾评论检测服务之外，评论通知中的邮件通知也有可能造成超时，这块建议可以先关闭评论通知再测一下是否是因为该功能导致的过慢。</p><h3 id="Github-登录无法管理后台"><a href="#Github-登录无法管理后台" class="headerlink" title="Github 登录无法管理后台"></a>Github 登录无法管理后台</h3><p>Github 登录后无法管理后台，解决方法可参考 Github Issue：<a target="_blank" rel="external nofollow" href="https://github.com/lizheming/waline/issues/207">通过 Github 登录无法管理后台</a></p><h2 id="Waline-版本更新流程"><a href="#Waline-版本更新流程" class="headerlink" title="Waline 版本更新流程"></a>Waline 版本更新流程</h2><ul><li>更新 <a target="_blank" rel="external nofollow" href="https://github.com/walinejs/waline/blob/main/assets/waline.sql">MySQL 数据库表结构</a></li><li>更新 <a target="_blank" rel="external nofollow" href="https://github.com/lizheming/waline/tree/master/packages/hexo-next">Hexo-Waline-Next</a> 插件</li><li>更新 <a target="_blank" rel="external nofollow" href="https://github.com/lizheming/waline/tree/master/packages/server">Waline Server</a> 的代码，重新构建 Docker 镜像</li><li>若在 Next 主题的 <code>_config.yml</code> 文件中，Waline 官方插件的 CDN 配置里有指定 Waline Client 的版本（如下配置），那么还需要更改 Client 的版本号，否则默认会使用最新版的 Waline Client</li></ul><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">waline:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">libUrl:</span> <span class="string">https://unpkg.com/@waline/client@2.0.7/dist/waline.js</span></span><br><span class="line">  <span class="attr">cssUrl:</span> <span class="string">https://unpkg.com/@waline/client@2.0.7/dist/waline.css</span></span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">提示</p><ol><li>由于 Waline 采用 Client/Server 架构，客户端与服务端的版本一般需要匹配才能正常运行。</li><li><code>waline/packages/server/src/controller/index.js</code> 源文件涉及到 Waline Client 版本的定义（最新版本）</li><li><code>waline/packages/server/src/middleware/dashboard.js</code> 源文件涉及到 Waline Admin 版本的定义（最新版本）</li></ol></div><h2 id="项目源码"><a href="#项目源码" class="headerlink" title="项目源码"></a>项目源码</h2><ul><li><a target="_blank" rel="external nofollow" href="https://github.com/lizheming/waline">Waline Github</a></li><li><a target="_blank" rel="external nofollow" href="https://hub.docker.com/r/lizheming/waline">Waline DockerHub</a></li></ul><h2 id="参考博客"><a href="#参考博客" class="headerlink" title="参考博客"></a>参考博客</h2><ul><li><a target="_blank" rel="external nofollow" href="https://waline.js.org/">Waline 官方中文文档</a></li></ul></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script>var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if(!isMobile)try{var plugin=new ReadmorePlugin;plugin.init({id:"readmore-container",blogId:"96641-5333172926158-056",name:"全栈技术驿站",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",lockToc:"yes",type:"hexo",random:"0.9",interval:"30",expires:"365",height:"auto"})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>坚持原创技术分享，您的支持将鼓励我继续创作！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/ae18fb85.html" title="Hexo Next 主题使用 Waline 评论系统">https://www.techgrow.cn/posts/ae18fb85.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎加入微信群</span><br> <img src="/img/wx-group-qr-technology.png"></div></div></div><div class="post-tags"><a href="/tags/%E9%9D%99%E6%80%81%E5%8D%9A%E5%AE%A2/" rel="tag"><i class="fa fa-tag"></i> 静态博客</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/1228be9f.html" rel="prev" title="C 语言基础之一"><i class="fa fa-chevron-left"></i> C 语言基础之一</a></div><div class="post-nav-item"> <a href="/posts/894ad1eb.html" rel="next" title="Spring Security + OAuth 2.0 + JWT 开发随笔">Spring Security + OAuth 2.0 + JWT 开发随笔<i class="fa fa-chevron-right"></i></a></div></div><div style="text-align:center"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4014850419768221" data-ad-slot="7586134725" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright &copy; 2018 – <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">758k</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 &asymp;</span> <span title="站点阅读时长">11:29</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="beian"> <span><img src="/img/gonganbeian.png" alt></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备19024664号</a></span></div></div></footer><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-tu9j5pBilBQrWSDePOOajCUdz6hWsid/lBNzK4KgEPM="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"/lib/mermaid/dist/mermaid.min.js","integrity":"sha256-ZfzwelSToHk5YAcr9wbXAmWgyn9Jyq08fSLrLhZE89w="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://unpkg.com/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '32px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://unpkg.com/qiniu-js@3.3.1/dist/qiniu.min.js"></script><script>
    var qiniu_domain = "https://qiniu.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/app/api/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn:9360","cssUrl":"https://unpkg.com/@waline/client@2.5.1/dist/waline.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://unpkg.com/@waline/client@2.5.1/dist/waline.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://unpkg.com/@waline/emojis@1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://qiniu.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/app/api/qiniu/token/upload","el":"#waline","comment":true,"path":"/posts/ae18fb85.html"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@2.5.1/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>