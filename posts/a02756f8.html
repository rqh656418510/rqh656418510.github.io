<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍 Java 如何通过 Hmily 实现 TCC 分布式事务。"><meta property="og:type" content="article"><meta property="og:title" content="基于 Hmily 实战 TCC 分布式事务之三"><meta property="og:url" content="https://www.techgrow.cn/posts/a02756f8.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍 Java 如何通过 Hmily 实现 TCC 分布式事务。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-34.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-40.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-41.png"><meta property="article:published_time" content="2021-03-10T13:12:19.000Z"><meta property="article:modified_time" content="2021-03-10T13:12:19.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="微服务"><meta property="article:tag" content="数据库"><meta property="article:tag" content="分布式"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-34.png"><link rel="canonical" href="https://www.techgrow.cn/posts/a02756f8.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/a02756f8.html","path":"posts/a02756f8.html","title":"基于 Hmily 实战 TCC 分布式事务之三"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>基于 Hmily 实战 TCC 分布式事务之三 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script>
  (function () {

  // 防止 Pjax 重复绑定事件
  if (window.__moonMenuCodeExpandBound) {
    return;
  }
  window.__moonMenuCodeExpandBound = true;

  const STORAGE_KEY = 'moon_menu_code_fold';

  /* ===============================
   * 1. 设置 moon-menu 按钮的 title
   * =============================== */
  (function bindMoonMenuTitles() {
    const items = [
      { selector: '#moon-menu-item-code',        title: '展开 / 折叠代码块' },
      { selector: '#moon-menu-item-back2top',    title: '回到页面顶部' },
      { selector: '#moon-menu-item-back2bottom', title: '回到页面底部' }
    ];

    let allReady = true;

    items.forEach(item => {
      const el = document.querySelector(item.selector);
      if (!el) {
        allReady = false;
        return;
      }
      el.setAttribute('title', item.title);
    });

    if (!allReady) {
      setTimeout(bindMoonMenuTitles, 100);
    }
  })();

  /* =================================
   * 2. 页面首次加载：代码块恢复展开或折叠状态
   * ================================= */
  function applyStoredCodeState() {
    const containers = document.querySelectorAll('.code-container');
    if (!containers.length) {
      return;
    }

    const state = localStorage.getItem(STORAGE_KEY);
    if (!state) {
      return;
    }

    containers.forEach(container => {
      if (state === 'expanded') {
        // 展开代码块
        container.classList.remove('highlight-fold');
      } else if (state === 'folded') {
        // 折叠代码块
        container.classList.add('highlight-fold');
      }
    });
  }

  // 等代码块出现后，再恢复展开或折叠状态
  function waitAndApplyState() {
    const containers = document.querySelectorAll('.code-container');

    if (!containers.length) {
      setTimeout(waitAndApplyState, 100);
      return;
    }

    applyStoredCodeState();
  }

  // 页面首次加载时恢复状态
  waitAndApplyState();
  
  // Pjax 切换页面后，必须重新恢复状态
  document.addEventListener('pjax:complete', function () {
    waitAndApplyState();
  });

  /* ===============================
   * 3. 点击按钮：切换状态并保存
   * =============================== */
  document.addEventListener('click', function (e) {
    const codeMenu = e.target.closest('#moon-menu-item-code');
    if (!codeMenu) {
      return;
    }

    toggleAllCodeBlocks();
  });

  // 展开或折叠代码块
  function toggleAllCodeBlocks() {
    const containers = document.querySelectorAll('.code-container');
    if (!containers.length) {
      return;
    }

    // 只要存在折叠的代码块，就认为当前是折叠状态
    const hasFolded = Array.from(containers).some(c => {
      return c.classList.contains('highlight-fold');
    });

    containers.forEach(container => {
      if (hasFolded) {
        // 展开代码块
        container.classList.remove('highlight-fold');
      } else {
        // 折叠代码块
        container.classList.add('highlight-fold');
      }
    });

    // 记录展开或折叠状态
    localStorage.setItem(
      STORAGE_KEY,
      hasFolded ? 'expanded' : 'folded'
    );
  }

})();
</script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%B5%E5%95%86%E7%B3%BB%E7%BB%9F-TCC-%E4%BA%8B%E5%8A%A1%E5%AE%9E%E6%88%98%EF%BC%88%E7%BC%96%E7%A0%81%EF%BC%89"><span class="nav-text">电商系统 TCC 事务实战（编码）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%B5%E5%95%86%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%A1%88%E4%BE%8B%EF%BC%88SpringCloud%EF%BC%89"><span class="nav-text">电商系统的案例（SpringCloud）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E4%B8%8B%E8%BD%BD"><span class="nav-text">代码下载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="nav-text">版本说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E8%AF%B4%E6%98%8E"><span class="nav-text">目录结构说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TCC-%E6%A8%A1%E5%9E%8B%E8%AF%B4%E6%98%8E"><span class="nav-text">TCC 模型说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E9%83%A8%E7%BD%B2%E6%9E%B6%E6%9E%84"><span class="nav-text">整体部署架构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">数据库初始化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81"><span class="nav-text">核心代码</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%88%B6-Pom-%E6%A8%A1%E5%9D%97"><span class="nav-text">父 Pom 模块</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%A8%A1%E5%9D%97"><span class="nav-text">注册中心模块</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE"><span class="nav-text">模块配置</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E4%BB%A3%E7%A0%81"><span class="nav-text">模块代码</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E6%A8%A1%E5%9D%97"><span class="nav-text">基础模块</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE"><span class="nav-text">核心配置</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-1"><span class="nav-text">核心代码</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97"><span class="nav-text">订单模块</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE-1"><span class="nav-text">模块配置</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E4%BB%A3%E7%A0%81-1"><span class="nav-text">模块代码</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B4%A6%E6%88%B7%E6%A8%A1%E5%9D%97"><span class="nav-text">账户模块</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE-2"><span class="nav-text">模块配置</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E4%BB%A3%E7%A0%81-2"><span class="nav-text">模块代码</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BA%93%E5%AD%98%E6%A8%A1%E5%9D%97"><span class="nav-text">库存模块</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE-3"><span class="nav-text">模块配置</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E4%BB%A3%E7%A0%81-3"><span class="nav-text">模块代码</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E6%B5%8B%E8%AF%95"><span class="nav-text">代码测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF"><span class="nav-text">常见错误</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SPI-%E5%BC%82%E5%B8%B8"><span class="nav-text">SPI 异常</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A1%A5%E5%85%85%E8%AF%B4%E6%98%8E"><span class="nav-text">补充说明</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#TCC-%E4%B8%8D%E9%80%82%E7%94%A8%E4%BA%8E%E5%A4%96%E9%83%A8%E6%94%AF%E4%BB%98%E7%B3%BB%E7%BB%9F"><span class="nav-text">TCC 不适用于外部支付系统</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">797</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">56</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/a02756f8.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="基于 Hmily 实战 TCC 分布式事务之三 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍 Java 如何通过 Hmily 实现 TCC 分布式事务。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 基于 Hmily 实战 TCC 分布式事务之三</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-03-10 21:12:19" itemprop="dateCreated datePublished" datetime="2021-03-10T21:12:19+08:00">2021-03-10</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/a02756f8.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/a02756f8.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>5k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>5 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/1625c614.html">基于 Hmily 实战 TCC 分布式事务之一</a></li><li><a href="/posts/3e028f15.html">基于 Hmily 实战 TCC 分布式事务之二</a></li><li><a href="/posts/a02756f8.html">基于 Hmily 实战 TCC 分布式事务之三</a></li></ul><span id="more"></span><h2 id="电商系统-TCC-事务实战（编码）"><a href="#电商系统-TCC-事务实战（编码）" class="headerlink" title="电商系统 TCC 事务实战（编码）"></a>电商系统 TCC 事务实战（编码）</h2><h3 id="电商系统的案例（SpringCloud）"><a href="#电商系统的案例（SpringCloud）" class="headerlink" title="电商系统的案例（SpringCloud）"></a>电商系统的案例（SpringCloud）</h3><div class="admonition warning"><p class="admonition-title">特别注意</p><p>本节中的案例代码仅用于演示如何通过 SpringCloud + Hmily 实现 TCC 分布式事务，并未全面涵盖 TCC 在实际运行过程中可能出现的<a href="/posts/1625c614.html#%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E7%9A%84-TCC-%E4%BA%8B%E5%8A%A1%E5%BC%82%E5%B8%B8%E5%88%86%E6%9E%90-1">各种事务异常处理</a>场景（如空回滚、防悬挂、第二阶段重复提交等问题），<strong>而这些事务异常问题在生产环境中是必须重点考虑并妥善处理的</strong>。</p></div><h4 id="代码下载"><a href="#代码下载" class="headerlink" title="代码下载"></a>代码下载</h4><ul><li>本节完整的案例代码可以直接从 <a target="_blank" rel="external nofollow" href="https://github.com/rqh656418510/spring-cloud-share/tree/main/distributed-database/distributed-transaction-study">GitHub</a> 下载对应章节 <code>distributed-transaction-02</code>。</li></ul><h4 id="版本说明"><a href="#版本说明" class="headerlink" title="版本说明"></a>版本说明</h4><table><thead><tr><th>组件</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td> JDK</td><td><code>11</code></td><td></td></tr><tr><td>MySQL</td><td><code>5.7.44</code></td><td></td></tr><tr><td>Hmily</td><td><code>2.1.1</code></td><td></td></tr><tr><td>SpringBoot</td><td><code>2.3.7.RELEASE</code></td><td>Hmily 官方并不支持 SpringBoot <code>3.x</code></td></tr><tr><td>SpringCloud</td><td><code>Hoxton.SR9</code></td><td></td></tr></tbody></table><div class="admonition note"><p class="admonition-title">Hmily 版本说明</p><ul><li>在 Maven 中央仓库中，Hmily 最新的版本是 <code>2.1.2</code>（2022 年 12 月发布）。特别注意，Maven 中央仓库中 <code>hmily-spring-boot-starter-springcloud</code> 的最新版本是 <code>2.1.1</code>，并没有 <code>2.1.2</code> 版本；如果需要 <code>2.1.2</code> 版本，可以从 <a target="_blank" rel="external nofollow" href="https://repo1.maven.org/maven2/org/dromara/hmily-spring-boot-starter-springcloud/">这里（不稳定，生产环境慎用）</a> 直接下载，并通过 <code>mvn install</code> 命令安装到本地。</li></ul></div><h4 id="目录结构说明"><a href="#目录结构说明" class="headerlink" title="目录结构说明"></a>目录结构说明</h4><ul><li>在本案例中，电商系统的核心模块如下所示：</li></ul><table><thead><tr><th>模块名称</th><th>端口</th><th>说明</th></tr></thead><tbody><tr><td><code>eureka-server</code></td><td><code>8761</code></td><td>Eureka 注册中心</td></tr><tr><td><code>hmily-demo-common</code></td><td></td><td>基础模块（Entity、DTO、Mapper）</td></tr><tr><td><code>hmily-demo-tcc-springcloud-order</code></td><td><code>8090</code></td><td>订单模块</td></tr><tr><td><code>hmily-demo-tcc-springcloud-account</code></td><td><code>8885</code></td><td>账户模块</td></tr><tr><td><code>hmily-demo-tcc-springcloud-inventory</code></td><td><code>8883</code></td><td>库存模块</td></tr></tbody></table><ul><li>在本案例中，电商系统的整体目录结构如下所示：</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">distributed-transaction-02</span><br><span class="line">├── hmily-demo-common</span><br><span class="line">│&nbsp;&nbsp; ├── pom.xml</span><br><span class="line">│&nbsp;&nbsp; └── src</span><br><span class="line">│&nbsp;&nbsp;     └── main</span><br><span class="line">│&nbsp;&nbsp;         ├── java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp; └── org</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;     └── dromara</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;         └── hmily</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             └── demo</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                 └── common</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                     ├── account</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                     │&nbsp;&nbsp; ├── dto</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                     │&nbsp;&nbsp; │&nbsp;&nbsp; ├── AccountDTO.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                     │&nbsp;&nbsp; │&nbsp;&nbsp; └── AccountNestedDTO.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                     │&nbsp;&nbsp; ├── entity</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                     │&nbsp;&nbsp; │&nbsp;&nbsp; └── AccountDO.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                     │&nbsp;&nbsp; └── mapper</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                     │&nbsp;&nbsp;     └── AccountMapper.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                     ├── inventory</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                     │&nbsp;&nbsp; ├── dto</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                     │&nbsp;&nbsp; │&nbsp;&nbsp; └── InventoryDTO.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                     │&nbsp;&nbsp; ├── entity</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                     │&nbsp;&nbsp; │&nbsp;&nbsp; └── InventoryDO.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                     │&nbsp;&nbsp; └── mapper</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                     │&nbsp;&nbsp;     └── InventoryMapper.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                     └── order</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         ├── entity</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         │&nbsp;&nbsp; └── Order.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         ├── enums</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         │&nbsp;&nbsp; └── OrderStatusEnum.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         └── mapper</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                             └── OrderMapper.java</span><br><span class="line">│&nbsp;&nbsp;         └── resources</span><br><span class="line">│&nbsp;&nbsp;             └── mybatis</span><br><span class="line">│&nbsp;&nbsp;                 └── mybatis-config.xml</span><br><span class="line">├── hmily-demo-tcc-springcloud-account</span><br><span class="line">│&nbsp;&nbsp; ├── pom.xml</span><br><span class="line">│&nbsp;&nbsp; └── src</span><br><span class="line">│&nbsp;&nbsp;     └── main</span><br><span class="line">│&nbsp;&nbsp;         ├── java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp; └── org</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;     └── dromara</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;         └── hmily</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             └── demo</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                 └── springcloud</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                     └── account</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         ├── client</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         │&nbsp;&nbsp; └── InventoryClient.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         ├── controller</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         │&nbsp;&nbsp; └── AccountController.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         ├── HmilyAccountApplication.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         └── service</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                             ├── AccountService.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                             └── impl</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                                 └── AccountServiceImpl.java</span><br><span class="line">│&nbsp;&nbsp;         └── resources</span><br><span class="line">│&nbsp;&nbsp;             ├── application.yml</span><br><span class="line">│&nbsp;&nbsp;             └── hmily.yml</span><br><span class="line">├── hmily-demo-tcc-springcloud-eureka</span><br><span class="line">│&nbsp;&nbsp; ├── pom.xml</span><br><span class="line">│&nbsp;&nbsp; └── src</span><br><span class="line">│&nbsp;&nbsp;     └── main</span><br><span class="line">│&nbsp;&nbsp;         ├── java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp; └── org</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;     └── dromara</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;         └── hmily</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             └── demo</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                 └── springcloud</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                     └── eureka</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         └── EurekaServerApplication.java</span><br><span class="line">│&nbsp;&nbsp;         └── resources</span><br><span class="line">│&nbsp;&nbsp;             └── application.yml</span><br><span class="line">├── hmily-demo-tcc-springcloud-inventory</span><br><span class="line">│&nbsp;&nbsp; ├── pom.xml</span><br><span class="line">│&nbsp;&nbsp; └── src</span><br><span class="line">│&nbsp;&nbsp;     └── main</span><br><span class="line">│&nbsp;&nbsp;         ├── java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp; └── org</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;     └── dromara</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;         └── hmily</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             └── demo</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                 └── springcloud</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                     └── inventory</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         ├── controller</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         │&nbsp;&nbsp; └── InventoryController.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         ├── HmilyInventoryApplication.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         └── service</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                             ├── impl</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                             │&nbsp;&nbsp; └── InventoryServiceImpl.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                             └── InventoryService.java</span><br><span class="line">│&nbsp;&nbsp;         └── resources</span><br><span class="line">│&nbsp;&nbsp;             ├── application.yml</span><br><span class="line">│&nbsp;&nbsp;             └── hmily.yml</span><br><span class="line">├── hmily-demo-tcc-springcloud-order</span><br><span class="line">│&nbsp;&nbsp; ├── pom.xml</span><br><span class="line">│&nbsp;&nbsp; └── src</span><br><span class="line">│&nbsp;&nbsp;     └── main</span><br><span class="line">│&nbsp;&nbsp;         ├── java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp; └── org</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;     └── dromara</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;         └── hmily</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;             └── demo</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                 └── springcloud</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                     └── order</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         ├── client</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         │&nbsp;&nbsp; ├── AccountClient.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         │&nbsp;&nbsp; └── InventoryClient.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         ├── configuration</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         │&nbsp;&nbsp; └── SwaggerConfig.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         ├── controller</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         │&nbsp;&nbsp; └── OrderController.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         ├── HmilyOrderApplication.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                         └── service</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                             ├── impl</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                             │&nbsp;&nbsp; ├── OrderServiceImpl.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                             │&nbsp;&nbsp; └── PaymentServiceImpl.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                             ├── OrderService.java</span><br><span class="line">│&nbsp;&nbsp;         │&nbsp;&nbsp;                             └── PaymentService.java</span><br><span class="line">│&nbsp;&nbsp;         └── resources</span><br><span class="line">│&nbsp;&nbsp;             ├── application.yml</span><br><span class="line">│&nbsp;&nbsp;             └── hmily.yml</span><br><span class="line">└── pom.xml</span><br></pre></td></tr></tbody></table></figure><h4 id="TCC-模型说明"><a href="#TCC-模型说明" class="headerlink" title="TCC 模型说明"></a>TCC 模型说明</h4><p>在本案例中，电商系统使用的 TCC 模型如下图所示：</p><p><img data-src="../../../asset/2026/01/tcc-transaction-34.png"></p><h4 id="整体部署架构"><a href="#整体部署架构" class="headerlink" title="整体部署架构"></a>整体部署架构</h4><p><img data-src="../../../asset/2026/01/tcc-transaction-40.png"></p><h4 id="数据库初始化"><a href="#数据库初始化" class="headerlink" title="数据库初始化"></a>数据库初始化</h4><ul><li>创建数据库</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建订单库</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `hmily_order` <span class="keyword">DEFAULT</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_bin ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建账户库</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `hmily_account` <span class="keyword">DEFAULT</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_bin ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建库存库</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `hmily_stock` <span class="keyword">DEFAULT</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_bin ;</span><br></pre></td></tr></tbody></table></figure><ul><li>创建订单表（<code>hmily_order.order</code>）</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 切换数据库</span></span><br><span class="line">USE `hmily_order`;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建订单表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">order</span>` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `create_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `number` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">COLLATE</span> utf8mb4_bin <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `status` tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `product_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `total_amount` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">0</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `count` <span class="type">int</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `user_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_bin;</span><br></pre></td></tr></tbody></table></figure><ul><li>创建账户表（<code>hmily_account.account</code>）</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 切换数据库</span></span><br><span class="line">USE `hmily_account`;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建账户表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `account` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `user_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `balance` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">0</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'用户余额'</span>,</span><br><span class="line">  `freeze_amount` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">0</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'冻结金额，扣款暂存余额'</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">2</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_bin;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入数据</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `account`(`id`,`user_id`,`balance`,`freeze_amount`,`create_time`,`update_time`) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'10000'</span>, <span class="number">10000000</span>,<span class="number">0</span>,<span class="string">'2017-09-18 14:54:22'</span>,<span class="keyword">NULL</span>);</span><br></pre></td></tr></tbody></table></figure><ul><li>创建库存表（<code>hmily_stock.inventory</code>）</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 切换数据库</span></span><br><span class="line">USE `hmily_stock`;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建库存表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `inventory` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `product_id` <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `total_inventory` <span class="type">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'总库存'</span>,</span><br><span class="line">  `lock_inventory` <span class="type">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'锁定库存'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">2</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_bin;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入数据</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `inventory`(`id`,`product_id`,`total_inventory`,`lock_inventory`) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'1'</span>,<span class="number">10000000</span>,<span class="number">0</span>);</span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">Hmily 数据库的初始化</p><p>当 Hmily 使用 MySQL 来存储事务日志时，只要项目引入 <code>hmily-spring-boot-starter-springcloud</code> 依赖，并且在 <code>hmily.yml</code> 中添加 MySQL 相关的配置，那么 Hmily 在执行分布式事务时，默认会自动创建相关的数据库（<code>hmily</code>）和数据库表，比如 MySQL 初始化的 SQL 脚本源文件可以查看 <a target="_blank" rel="external nofollow" href="https://github.com/dromara/hmily/blob/master/hmily-repository/hmily-repository-database/hmily-repository-database-mysql/src/main/resources/mysql/schema.sql">GitHub 仓库</a>。值得一提的是，不同版本的 Hmily，其数据库初始化的 SQL 脚本可能有差异。</p></div><h4 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h4><h5 id="父-Pom-模块"><a href="#父-Pom-模块" class="headerlink" title="父 Pom 模块"></a>父 Pom 模块</h5><div class="admonition note"><p class="admonition-title">提示</p><p>父 Pom 模块主要用于统一管理和定义项目中各类核心依赖的版本号，避免在各个子模块中重复声明版本，从而提升依赖管理的可维护性和一致性。</p></div><ul><li>Maven 的 XML 配置内容（<code>pom.xml</code>）</li></ul><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Hoxton.SR9<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">springfox.version</span>&gt;</span>2.6.1<span class="tag">&lt;/<span class="name">springfox.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>8.0.22<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mybatis.version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">mybatis.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hmily.version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">hmily.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- SpringCloud --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>${spring-cloud.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Hmily --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.dromara<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hmily-spring-boot-starter-springcloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>${hmily.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Swagger --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>${springfox.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>${springfox.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-bean-validators<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>${springfox.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- MyBatis --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>${mybatis.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- MySQL --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>${mysql.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Lombok --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h5 id="注册中心模块"><a href="#注册中心模块" class="headerlink" title="注册中心模块"></a>注册中心模块</h5><h6 id="模块配置"><a href="#模块配置" class="headerlink" title="模块配置"></a>模块配置</h6><ul><li>Maven 的 XML 配置内容（<code>pom.xml</code>）</li></ul><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Eureka --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><ul><li>SpringBoot 的 YML 配置内容（<code>application.yml</code>）</li></ul><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8761</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">springcloud-eureka</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Eureka 服务端配置</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="comment"># 实例主机名，使用环境变量 hostname，默认为 localhost</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">${hostname:localhost}</span></span><br><span class="line">    <span class="comment"># 优先使用 IP 地址而非主机名进行注册和通信</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 客户端向服务端发送心跳续约的间隔时间（秒），用于保持注册状态</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">30</span></span><br><span class="line">    <span class="comment"># 服务端在收到最后一次心跳后等待的时间（秒），超时后将实例标记为下线</span></span><br><span class="line">    <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">90</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="comment"># 更新 Eureka 集群节点列表的时间间隔（毫秒）</span></span><br><span class="line">    <span class="attr">peer-eureka-nodes-update-interval-ms:</span> <span class="number">60000</span></span><br><span class="line">    <span class="comment"># 是否开启自我保护模式，关闭后当大量实例异常时会直接剔除</span></span><br><span class="line">    <span class="attr">enable-self-preservation:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 服务端清理失效实例的任务执行间隔（毫秒）</span></span><br><span class="line">    <span class="attr">eviction-interval-timer-in-ms:</span> <span class="number">60000</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># 是否将本实例注册到 Eureka 服务器，单机模式通常设为 false，集群模式必须设置为 true</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 是否从 Eureka 服务器获取注册表信息，单机模式通常设为 false，集群模式必须设置为 true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># Eureka 服务器的服务地址</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">default-zone:</span> <span class="string">http://${eureka.instance.hostname}:${server.port}/eureka/</span></span><br><span class="line">    <span class="comment"># 轮询更新 Eureka 服务地址列表的时间间隔（秒）</span></span><br><span class="line">    <span class="attr">eureka-service-url-poll-interval-seconds:</span> <span class="number">60</span></span><br><span class="line">    <span class="comment"># 是否启用健康检查机制</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Spring Boot Actuator 端点配置</span></span><br><span class="line"><span class="attr">endpoints:</span></span><br><span class="line">  <span class="attr">health:</span></span><br><span class="line">    <span class="comment"># 是否对健康端点进行敏感信息保护，设为 false 允许无鉴权访问</span></span><br><span class="line">    <span class="attr">sensitive:</span> <span class="literal">false</span></span><br></pre></td></tr></tbody></table></figure><h6 id="模块代码"><a href="#模块代码" class="headerlink" title="模块代码"></a>模块代码</h6><ul><li>SpringBoot 的主启动类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaServerApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        SpringApplication.run(EurekaServerApplication.class);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h5 id="基础模块"><a href="#基础模块" class="headerlink" title="基础模块"></a>基础模块</h5><h6 id="核心配置"><a href="#核心配置" class="headerlink" title="核心配置"></a>核心配置</h6><ul><li>Maven 的 XML 配置内容（<code>pom.xml</code>）</li></ul><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Hmily --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.dromara<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hmily-annotation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>${hmily.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Web支持 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- AOP支持 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 自动配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- MyBatis --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><ul><li>MyBatis 的 XML 配置内容（<code>mybatis-config.xml</code>）</li></ul><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dialect"</span> <span class="attr">value</span>=<span class="string">"mysql"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"pageSqlId"</span> <span class="attr">value</span>=<span class="string">".*Page$"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"mapUnderscoreToCamelCase"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h6 id="核心代码-1"><a href="#核心代码-1" class="headerlink" title="核心代码"></a>核心代码</h6><ul><li>订单的 Entity 类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">8551347266419380333L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String number;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String productId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 付款金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal totalAmount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 购买数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer count;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 购买人</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>订单状态的枚举类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">OrderStatusEnum</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Not pay order status enum.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    NOT_PAY(<span class="number">1</span>, <span class="string">"未支付"</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Paying order status enum.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    PAYING(<span class="number">2</span>, <span class="string">"支付中"</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Pay fail order status enum.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    PAY_FAIL(<span class="number">3</span>, <span class="string">"支付失败"</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Pay success order status enum.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    PAY_SUCCESS(<span class="number">4</span>, <span class="string">"支付成功"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String desc;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>订单的 Mapper 接口</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderMapper</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存订单.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> order 订单对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> rows int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Insert(" insert into `order` (create_time,number,status,product_id,total_amount,count,user_id) " +</span></span><br><span class="line"><span class="meta">            " values ( #{createTime},#{number},#{status},#{productId},#{totalAmount},#{count},#{userId})")</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">save</span><span class="params">(Order order)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新订单.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> order 订单对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> rows int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Update("update `order` set status = #{status}  where number = #{number}")</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">update</span><span class="params">(Order order)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取所有的订单</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> List&lt;Order&gt; list</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Select("select * from  order")</span></span><br><span class="line">    <span class="function">List&lt;Order&gt; <span class="title">listAll</span><span class="params">()</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>账户的 Entity 类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountDO</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">81849676368907419L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BigDecimal balance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BigDecimal freezeAmount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>账户的 DTO 类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountDTO</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7223470850578998427L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扣款金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal amount;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>账户的 Mapper 接口</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountMapper</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Update int.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> accountDTO the account dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Update("update account set balance = balance - #{amount}," +</span></span><br><span class="line"><span class="meta">        " freeze_amount= freeze_amount + #{amount} ,update_time = now()" +</span></span><br><span class="line"><span class="meta">        " where user_id =#{userId}  and  balance &gt;= #{amount}  ")</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">update</span><span class="params">(AccountDTO accountDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Confirm int.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> accountDTO the account dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Update("update account set " +</span></span><br><span class="line"><span class="meta">        " freeze_amount= freeze_amount - #{amount}" +</span></span><br><span class="line"><span class="meta">        " where user_id =#{userId}  and freeze_amount &gt;= #{amount} ")</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">confirm</span><span class="params">(AccountDTO accountDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cancel int.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> accountDTO the account dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Update("update account set balance = balance + #{amount}," +</span></span><br><span class="line"><span class="meta">        " freeze_amount= freeze_amount -  #{amount} " +</span></span><br><span class="line"><span class="meta">        " where user_id =#{userId}  and freeze_amount &gt;= #{amount}")</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">cancel</span><span class="params">(AccountDTO accountDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据userId获取用户账户信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> AccountDO account do</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Select("select id,user_id,balance, freeze_amount from account where user_id =#{userId} limit 1")</span></span><br><span class="line">    <span class="function">AccountDO <span class="title">findByUserId</span><span class="params">(String userId)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>库存的 Entity 类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InventoryDO</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6957734749389133832L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品id.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String productId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 总库存.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer totalInventory;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 锁定库存.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer lockInventory;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>库存的 DTO 类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InventoryDTO</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">8229355519336565493L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品id.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String productId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数量.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer count;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>库存的 Mapper 接口</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InventoryMapper</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Decrease int.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inventoryDTO the inventory dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Update("update inventory set total_inventory = total_inventory - #{count}," +</span></span><br><span class="line"><span class="meta">        " lock_inventory= lock_inventory + #{count} " +</span></span><br><span class="line"><span class="meta">        " where product_id =#{productId} and total_inventory &gt; 0  ")</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">decrease</span><span class="params">(InventoryDTO inventoryDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Confirm int.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inventoryDTO the inventory dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Update("update inventory set " +</span></span><br><span class="line"><span class="meta">        " lock_inventory = lock_inventory - #{count} " +</span></span><br><span class="line"><span class="meta">        " where product_id =#{productId} and lock_inventory &gt; 0 ")</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">confirm</span><span class="params">(InventoryDTO inventoryDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cancel int.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inventoryDTO the inventory dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Update("update inventory set total_inventory = total_inventory + #{count}," +</span></span><br><span class="line"><span class="meta">        " lock_inventory= lock_inventory - #{count} " +</span></span><br><span class="line"><span class="meta">        " where product_id =#{productId}  and lock_inventory &gt; 0 ")</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">cancel</span><span class="params">(InventoryDTO inventoryDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Find by product id inventory do.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> productId the product id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the inventory do</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Select("select id,product_id,total_inventory ,lock_inventory from inventory where product_id =#{productId}")</span></span><br><span class="line">    <span class="function">InventoryDO <span class="title">findByProductId</span><span class="params">(String productId)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h5 id="订单模块"><a href="#订单模块" class="headerlink" title="订单模块"></a>订单模块</h5><h6 id="模块配置-1"><a href="#模块配置-1" class="headerlink" title="模块配置"></a>模块配置</h6><ul><li>Maven 的 XML 配置内容（<code>pom.xml</code>）</li></ul><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.distributed.transaction<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hmily-demo-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>${project.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Web支持 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- AOP支持 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 自动配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Eureka --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- OpenFeign --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- MyBatis --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Hmily --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.dromara<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hmily-spring-boot-starter-springcloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>${hmily.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Swagger --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-bean-validators<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><ul><li>SpringBoot 的 YML 配置内容（<code>application.yml</code>）</li></ul><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8090</span></span><br><span class="line">  <span class="attr">address:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">main:</span></span><br><span class="line">    <span class="attr">allow-bean-definition-overriding:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.2.140:3306/hmily_order?useUnicode=true&amp;characterEncoding=utf8</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">order-service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">org.dromara.hmily.demo.common.order.entity</span></span><br><span class="line">  <span class="attr">config-location:</span> <span class="string">classpath:mybatis/mybatis-config.xml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">${spring.application.name}-${server.port}</span>    <span class="comment"># 自定义服务名称</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>                                   <span class="comment"># 将IP注册到Eureka Server上，若不配置默认使用机器的主机名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Ribbon 的负载均衡策略</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span></span><br><span class="line">  <span class="attr">MaxAutoRetriesNextServer:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">MaxAutoRetries:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Feign 配置</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span>   <span class="comment"># 在 Feign 中是否开启 Hystrix 功能，默认情况下 Feign 不开启 hystrix 功能</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">root:</span> <span class="string">info</span></span><br><span class="line">    <span class="attr">org.apache.ibatis:</span> <span class="string">debug</span></span><br><span class="line">    <span class="attr">org.dromara.hmily.demo.bonuspoint:</span> <span class="string">debug</span></span><br><span class="line">    <span class="attr">org.dromara.hmily.demo.lottery:</span> <span class="string">debug</span></span><br><span class="line">    <span class="attr">org.dromara.hmily.demo:</span> <span class="string">debug</span></span><br><span class="line">    <span class="attr">io.netty:</span> <span class="string">info</span></span><br></pre></td></tr></tbody></table></figure><ul><li>Hmily 的 YML 配置内容（<code>hmily.yml</code>），<strong>可以根据实际业务需求，适当调整 Hmily 的配置参数</strong></li></ul><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Hmily 服务端相关配置</span></span><br><span class="line"><span class="attr">hmily:</span></span><br><span class="line">  <span class="comment"># Hmily Server 配置</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="comment"># 配置模式：local 表示本地配置模式</span></span><br><span class="line">    <span class="attr">configMode:</span> <span class="string">local</span></span><br><span class="line">    <span class="comment"># 当前应用名称（Hmily Server 使用）</span></span><br><span class="line">    <span class="attr">appName:</span> <span class="string">order-sc</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 只有 server.configMode 为 local 时才会读取以下配置</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="comment"># 当前应用名称（业务侧使用）</span></span><br><span class="line">    <span class="attr">appName:</span> <span class="string">order-sc</span></span><br><span class="line">    <span class="comment"># 序列化方式，推荐使用 kryo；支持 hessian、protostuff、jdk；测试表现：kryo &gt; hessian &gt; protostuff &gt; jdk</span></span><br><span class="line">    <span class="attr">serializer:</span> <span class="string">kryo</span></span><br><span class="line">    <span class="comment"># 上下文传递模式（threadLocal / transmittableThreadLocal）</span></span><br><span class="line">    <span class="attr">contextTransmittalMode:</span> <span class="string">threadLocal</span></span><br><span class="line">    <span class="comment"># 定时任务线程池最大线程数，高并发场景下可适当调大</span></span><br><span class="line">    <span class="attr">scheduledThreadMax:</span> <span class="number">16</span></span><br><span class="line">    <span class="comment"># 恢复任务首次延迟时间（秒）</span></span><br><span class="line">    <span class="attr">scheduledRecoveryDelay:</span> <span class="number">60</span></span><br><span class="line">    <span class="comment"># 清理任务执行间隔（秒）</span></span><br><span class="line">    <span class="attr">scheduledCleanDelay:</span> <span class="number">60</span></span><br><span class="line">    <span class="comment"># 物理删除任务执行间隔（秒）</span></span><br><span class="line">    <span class="attr">scheduledPhyDeletedDelay:</span> <span class="number">600</span></span><br><span class="line">    <span class="comment"># 定时任务初始化延迟时间（秒）</span></span><br><span class="line">    <span class="attr">scheduledInitDelay:</span> <span class="number">30</span></span><br><span class="line">    <span class="comment"># 事务恢复延迟时间（秒），强烈建议大于 RPC 调用的超时时间，否则可能误触发补偿；比如设置为：≥ RPC 超时 + 网络抖动余量</span></span><br><span class="line">    <span class="attr">recoverDelayTime:</span> <span class="number">60</span></span><br><span class="line">    <span class="comment"># 清理延迟时间（秒）</span></span><br><span class="line">    <span class="attr">cleanDelayTime:</span> <span class="number">180</span></span><br><span class="line">    <span class="comment"># 单次处理事务的最大数量限制</span></span><br><span class="line">    <span class="attr">limit:</span> <span class="number">200</span></span><br><span class="line">    <span class="comment"># 最大重试次数，默认 10 次，业务服务宕机时定时任务在 retryMax 次内执行 cancel 或 confirm</span></span><br><span class="line">    <span class="attr">retryMax:</span> <span class="number">10</span></span><br><span class="line">    <span class="comment"># Disruptor 缓冲区大小，高并发时可调大，建议为 2 的幂次方</span></span><br><span class="line">    <span class="attr">bufferSize:</span> <span class="number">8192</span></span><br><span class="line">    <span class="comment"># 消费者线程数</span></span><br><span class="line">    <span class="attr">consumerThreads:</span> <span class="number">16</span></span><br><span class="line">    <span class="comment"># 是否启用异步事务日志存储</span></span><br><span class="line">    <span class="attr">asyncRepository:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 是否自动建表（仅关系型数据库有效）</span></span><br><span class="line">    <span class="attr">autoSql:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 是否启用物理删除</span></span><br><span class="line">    <span class="attr">phyDeleted:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 事务数据保留天数</span></span><br><span class="line">    <span class="attr">storeDays:</span> <span class="number">3</span></span><br><span class="line">    <span class="comment"># 事务日志存储类型（mysql / postgresql / mongodb / redis / zookeeper / file 等）</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">mysql</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Hmily 仓库相关配置</span></span><br><span class="line"><span class="attr">repository:</span></span><br><span class="line">  <span class="comment"># 数据库相关配置</span></span><br><span class="line">  <span class="attr">database:</span></span><br><span class="line">    <span class="comment"># JDBC 驱动类名</span></span><br><span class="line">    <span class="attr">driverClassName:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="comment"># 数据库连接 URL</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.2.140:3306/hmily?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">    <span class="comment"># 数据库用户名</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="comment"># 数据库密码</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="comment"># 连接池最大连接数</span></span><br><span class="line">    <span class="attr">maxActive:</span> <span class="number">20</span></span><br><span class="line">    <span class="comment"># 连接池最小空闲连接数</span></span><br><span class="line">    <span class="attr">minIdle:</span> <span class="number">10</span></span><br><span class="line">    <span class="comment"># 获取连接超时时间（毫秒）</span></span><br><span class="line">    <span class="attr">connectionTimeout:</span> <span class="number">30000</span></span><br><span class="line">    <span class="comment"># 连接空闲超时时间（毫秒）</span></span><br><span class="line">    <span class="attr">idleTimeout:</span> <span class="number">600000</span></span><br><span class="line">    <span class="comment"># 连接最大生命周期（毫秒）</span></span><br><span class="line">    <span class="attr">maxLifetime:</span> <span class="number">1800000</span></span><br></pre></td></tr></tbody></table></figure><h6 id="模块代码-1"><a href="#模块代码-1" class="headerlink" title="模块代码"></a>模块代码</h6><ul><li>账户的 Feign 客户端（<strong>这里需要添加 <code>@Hmily</code> 注解，用于标记参与 TCC 分布式事务的业务方法，声明该方法由 Hmily 框架接管并按 Try / Confirm / Cancel 事务模型执行</strong>）</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = "account-service")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountClient</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户账户付款.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> accountDO 实体类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping("/account-service/account/payment")</span></span><br><span class="line">    <span class="meta">@Hmily</span></span><br><span class="line">    <span class="function">Boolean <span class="title">payment</span><span class="params">(<span class="meta">@RequestBody</span> AccountDTO accountDO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户账户信息.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> AccountDO big decimal</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping("/account-service/account/findByUserId")</span></span><br><span class="line">    <span class="function">BigDecimal <span class="title">findByUserId</span><span class="params">(<span class="meta">@RequestParam("userId")</span> String userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Mock with try exception boolean.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> accountDO the account do</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Hmily</span></span><br><span class="line">    <span class="meta">@RequestMapping("/account-service/account/mockWithTryException")</span></span><br><span class="line">    <span class="function">Boolean <span class="title">mockWithTryException</span><span class="params">(<span class="meta">@RequestBody</span> AccountDTO accountDO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Mock with try timeout boolean.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> accountDO the account do</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Hmily</span></span><br><span class="line">    <span class="meta">@RequestMapping("/account-service/account/mockWithTryTimeout")</span></span><br><span class="line">    <span class="function">Boolean <span class="title">mockWithTryTimeout</span><span class="params">(<span class="meta">@RequestBody</span> AccountDTO accountDO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Payment with nested boolean.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nestedDTO the nested dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Hmily</span></span><br><span class="line">    <span class="meta">@RequestMapping("/account-service/account/paymentWithNested")</span></span><br><span class="line">    <span class="function">Boolean <span class="title">paymentWithNested</span><span class="params">(<span class="meta">@RequestBody</span> AccountNestedDTO nestedDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Payment with nested exception boolean.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nestedDTO the nested dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Hmily</span></span><br><span class="line">    <span class="meta">@RequestMapping("/account-service/account/paymentWithNestedException")</span></span><br><span class="line">    <span class="function">Boolean <span class="title">paymentWithNestedException</span><span class="params">(<span class="meta">@RequestBody</span> AccountNestedDTO nestedDTO)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>库存的 Feign 客户端（<strong>这里需要添加 <code>@Hmily</code> 注解，用于标记参与 TCC 分布式事务的业务方法，声明该方法由 Hmily 框架接管并按 Try / Confirm / Cancel 事务模型执行</strong>）</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = "inventory-service")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InventoryClient</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 库存扣减.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inventoryDTO 实体对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping("/inventory-service/inventory/decrease")</span></span><br><span class="line">    <span class="meta">@Hmily</span></span><br><span class="line">    <span class="function">Boolean <span class="title">decrease</span><span class="params">(<span class="meta">@RequestBody</span> InventoryDTO inventoryDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Test decrease boolean.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inventoryDTO the inventory dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping("/inventory-service/inventory/testDecrease")</span></span><br><span class="line">    <span class="function">Boolean <span class="title">testDecrease</span><span class="params">(<span class="meta">@RequestBody</span> InventoryDTO inventoryDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取商品库存.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> productId 商品id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> InventoryDO integer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping("/inventory-service/inventory/findByProductId")</span></span><br><span class="line">    <span class="function">Integer <span class="title">findByProductId</span><span class="params">(<span class="meta">@RequestParam("productId")</span> String productId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模拟库存扣减异常.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inventoryDTO 实体对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Hmily</span></span><br><span class="line">    <span class="meta">@RequestMapping("/inventory-service/inventory/mockWithTryException")</span></span><br><span class="line">    <span class="function">Boolean <span class="title">mockWithTryException</span><span class="params">(<span class="meta">@RequestBody</span> InventoryDTO inventoryDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模拟库存扣减超时.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inventoryDTO 实体对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Hmily</span></span><br><span class="line">    <span class="meta">@RequestMapping("/inventory-service/inventory/mockWithTryTimeout")</span></span><br><span class="line">    <span class="function">Boolean <span class="title">mockWithTryTimeout</span><span class="params">(<span class="meta">@RequestBody</span> InventoryDTO inventoryDTO)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>订单的 Service 接口</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建订单并且进行扣除账户余额支付，并进行库存扣减操作.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count  购买数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount 支付金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">orderPay</span><span class="params">(Integer count, BigDecimal amount)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模拟在订单支付操作中，库存在try阶段中的库存异常.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count  购买数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount 支付金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">mockInventoryWithTryException</span><span class="params">(Integer count, BigDecimal amount)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Mock account with try exception string.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count  the count</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount the amount</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">mockAccountWithTryException</span><span class="params">(Integer count, BigDecimal amount)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模拟在订单支付操作中，库存在try阶段中的timeout.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count  购买数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount 支付金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">mockInventoryWithTryTimeout</span><span class="params">(Integer count, BigDecimal amount)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Mock account with try timeout string.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count  the count</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount the amount</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">mockAccountWithTryTimeout</span><span class="params">(Integer count, BigDecimal amount)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Order pay with nested string.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count  the count</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount the amount</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">orderPayWithNested</span><span class="params">(Integer count, BigDecimal amount)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Order pay with nested exception string.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count  the count</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount the amount</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">orderPayWithNestedException</span><span class="params">(Integer count, BigDecimal amount)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新订单状态.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> order 订单实体类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateOrderStatus</span><span class="params">(Order order)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>订单的 Service 实现类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service("orderService")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title">OrderService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(OrderServiceImpl.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OrderMapper orderMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PaymentService paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired(required = false)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderServiceImpl</span><span class="params">(OrderMapper orderMapper, PaymentService paymentService)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.orderMapper = orderMapper;</span><br><span class="line">        <span class="keyword">this</span>.paymentService = paymentService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">orderPay</span><span class="params">(Integer count, BigDecimal amount)</span> </span>{</span><br><span class="line">        Order order = saveOrder(count, amount);</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        paymentService.makePayment(order);</span><br><span class="line">        System.out.println(<span class="string">"hmily-cloud分布式事务耗时："</span> + (System.currentTimeMillis() - start));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">mockInventoryWithTryException</span><span class="params">(Integer count, BigDecimal amount)</span> </span>{</span><br><span class="line">        Order order = saveOrder(count, amount);</span><br><span class="line">        <span class="keyword">return</span> paymentService.mockPaymentInventoryWithTryException(order);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">mockAccountWithTryException</span><span class="params">(Integer count, BigDecimal amount)</span> </span>{</span><br><span class="line">        Order order = saveOrder(count, amount);</span><br><span class="line">        <span class="keyword">return</span> paymentService.mockPaymentAccountWithTryException(order);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模拟在订单支付操作中，库存在try阶段中的timeout</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count  购买数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount 支付金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">mockInventoryWithTryTimeout</span><span class="params">(Integer count, BigDecimal amount)</span> </span>{</span><br><span class="line">        Order order = saveOrder(count, amount);</span><br><span class="line">        <span class="keyword">return</span> paymentService.mockPaymentInventoryWithTryTimeout(order);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">mockAccountWithTryTimeout</span><span class="params">(Integer count, BigDecimal amount)</span> </span>{</span><br><span class="line">        Order order = saveOrder(count, amount);</span><br><span class="line">        <span class="keyword">return</span> paymentService.mockPaymentAccountWithTryTimeout(order);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">orderPayWithNested</span><span class="params">(Integer count, BigDecimal amount)</span> </span>{</span><br><span class="line">        Order order = saveOrder(count, amount);</span><br><span class="line">        <span class="keyword">return</span> paymentService.makePaymentWithNested(order);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">orderPayWithNestedException</span><span class="params">(Integer count, BigDecimal amount)</span> </span>{</span><br><span class="line">        Order order = saveOrder(count, amount);</span><br><span class="line">        <span class="keyword">return</span> paymentService.makePaymentWithNestedException(order);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateOrderStatus</span><span class="params">(Order order)</span> </span>{</span><br><span class="line">        orderMapper.update(order);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Order <span class="title">saveOrder</span><span class="params">(Integer count, BigDecimal amount)</span> </span>{</span><br><span class="line">        <span class="keyword">final</span> Order order = buildOrder(count, amount);</span><br><span class="line">        orderMapper.save(order);</span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Order <span class="title">buildOrder</span><span class="params">(Integer count, BigDecimal amount)</span> </span>{</span><br><span class="line">        LOGGER.info(<span class="string">"构建订单对象"</span>);</span><br><span class="line">        Order order = <span class="keyword">new</span> Order();</span><br><span class="line">        order.setCreateTime(<span class="keyword">new</span> Date());</span><br><span class="line">        order.setNumber(String.valueOf(IdWorkerUtils.getInstance().createUUID()));</span><br><span class="line">        <span class="comment">//demo中的表里只有商品id为 1的数据</span></span><br><span class="line">        order.setProductId(<span class="string">"1"</span>);</span><br><span class="line">        order.setStatus(OrderStatusEnum.NOT_PAY.getCode());</span><br><span class="line">        order.setTotalAmount(amount);</span><br><span class="line">        order.setCount(count);</span><br><span class="line">        <span class="comment">//demo中 表里面存的用户id为10000</span></span><br><span class="line">        order.setUserId(<span class="string">"10000"</span>);</span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>订单支付的 Service 接口</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PaymentService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单支付.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> order 订单实体</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">makePayment</span><span class="params">(Order order)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * mock订单支付的时候库存异常.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> order 订单实体</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">mockPaymentInventoryWithTryException</span><span class="params">(Order order)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Mock payment account with try exception string.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> order the order</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">mockPaymentAccountWithTryException</span><span class="params">(Order order)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * mock订单支付的时候库存超时.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> order 订单实体</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">mockPaymentInventoryWithTryTimeout</span><span class="params">(Order order)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Mock payment account with try timeout string.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> order the order</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">mockPaymentAccountWithTryTimeout</span><span class="params">(Order order)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Make payment with nested.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> order the order</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">makePaymentWithNested</span><span class="params">(Order order)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Make payment with nested exception.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> order the order</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">makePaymentWithNestedException</span><span class="params">(Order order)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>订单支付的 Service 实现类（<strong>这里需要使用 <code>@HmilyTCC</code> 注解，同时指定 <code>confirmMethod</code> 和 <code>cancelMethod</code> 参数</strong>）</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@SuppressWarnings("all")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentServiceImpl</span> <span class="keyword">implements</span> <span class="title">PaymentService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(PaymentServiceImpl.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OrderMapper orderMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AccountClient accountClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InventoryClient inventoryClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired(required = false)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PaymentServiceImpl</span><span class="params">(OrderMapper orderMapper,</span></span></span><br><span class="line"><span class="params"><span class="function">                              AccountClient accountClient,</span></span></span><br><span class="line"><span class="params"><span class="function">                              InventoryClient inventoryClient)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.orderMapper = orderMapper;</span><br><span class="line">        <span class="keyword">this</span>.accountClient = accountClient;</span><br><span class="line">        <span class="keyword">this</span>.inventoryClient = inventoryClient;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@HmilyTCC(confirmMethod = "confirmOrderStatus", cancelMethod = "cancelOrderStatus")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makePayment</span><span class="params">(Order order)</span> </span>{</span><br><span class="line">        LOGGER.info(<span class="string">"===========执行springcloud makePayment 扣减资金接口=========="</span>);</span><br><span class="line">        updateOrderStatus(order, OrderStatusEnum.PAYING);</span><br><span class="line">        <span class="comment">// 检查数据</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         final BigDecimal accountInfo = accountClient.findByUserId(order.getUserId());</span></span><br><span class="line"><span class="comment">         final Integer inventoryInfo = inventoryClient.findByProductId(order.getProductId());</span></span><br><span class="line"><span class="comment">         if (accountInfo.compareTo(order.getTotalAmount()) &lt; 0) {</span></span><br><span class="line"><span class="comment">            throw new HmilyRuntimeException("余额不足！");</span></span><br><span class="line"><span class="comment">         }</span></span><br><span class="line"><span class="comment">         if (inventoryInfo &lt; order.getCount()) {</span></span><br><span class="line"><span class="comment">            throw new HmilyRuntimeException("库存不足！");</span></span><br><span class="line"><span class="comment">         }</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        accountClient.payment(buildAccountDTO(order));</span><br><span class="line">        inventoryClient.decrease(buildInventoryDTO(order));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@HmilyTCC(confirmMethod = "confirmOrderStatus", cancelMethod = "cancelOrderStatus")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">mockPaymentInventoryWithTryException</span><span class="params">(Order order)</span> </span>{</span><br><span class="line">        LOGGER.info(<span class="string">"===========执行springcloud  mockPaymentInventoryWithTryException 扣减资金接口=========="</span>);</span><br><span class="line">        updateOrderStatus(order, OrderStatusEnum.PAYING);</span><br><span class="line">        <span class="comment">//扣除用户余额</span></span><br><span class="line">        accountClient.payment(buildAccountDTO(order));</span><br><span class="line">        inventoryClient.mockWithTryException(buildInventoryDTO(order));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@HmilyTCC(confirmMethod = "confirmOrderStatus", cancelMethod = "cancelOrderStatus")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">mockPaymentAccountWithTryException</span><span class="params">(Order order)</span> </span>{</span><br><span class="line">        LOGGER.info(<span class="string">"===========执行springcloud  mockPaymentAccountWithTryException 扣减资金接口=========="</span>);</span><br><span class="line">        updateOrderStatus(order, OrderStatusEnum.PAYING);</span><br><span class="line">        accountClient.mockWithTryException(buildAccountDTO(order));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@HmilyTCC(confirmMethod = "confirmOrderStatus", cancelMethod = "cancelOrderStatus")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">mockPaymentInventoryWithTryTimeout</span><span class="params">(Order order)</span> </span>{</span><br><span class="line">        LOGGER.info(<span class="string">"===========执行springcloud  mockPaymentInventoryWithTryTimeout 扣减资金接口=========="</span>);</span><br><span class="line">        updateOrderStatus(order, OrderStatusEnum.PAYING);</span><br><span class="line">        accountClient.payment(buildAccountDTO(order));</span><br><span class="line">        inventoryClient.mockWithTryTimeout(buildInventoryDTO(order));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@HmilyTCC(confirmMethod = "confirmOrderStatus", cancelMethod = "cancelOrderStatus")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">mockPaymentAccountWithTryTimeout</span><span class="params">(Order order)</span> </span>{</span><br><span class="line">        updateOrderStatus(order, OrderStatusEnum.PAYING);</span><br><span class="line">        accountClient.mockWithTryTimeout(buildAccountDTO(order));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@HmilyTCC(confirmMethod = "confirmOrderStatus", cancelMethod = "cancelOrderStatus")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">makePaymentWithNested</span><span class="params">(Order order)</span> </span>{</span><br><span class="line">        updateOrderStatus(order, OrderStatusEnum.PAYING);</span><br><span class="line">        <span class="keyword">final</span> BigDecimal balance = accountClient.findByUserId(order.getUserId());</span><br><span class="line">        <span class="keyword">if</span> (balance.compareTo(order.getTotalAmount()) &lt;= <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> HmilyRuntimeException(<span class="string">"余额不足！"</span>);</span><br><span class="line">        }</span><br><span class="line">        accountClient.paymentWithNested(buildAccountNestedDTO(order));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@HmilyTCC(confirmMethod = "confirmOrderStatus", cancelMethod = "cancelOrderStatus")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">makePaymentWithNestedException</span><span class="params">(Order order)</span> </span>{</span><br><span class="line">        updateOrderStatus(order, OrderStatusEnum.PAYING);</span><br><span class="line">        <span class="keyword">final</span> BigDecimal balance = accountClient.findByUserId(order.getUserId());</span><br><span class="line">        <span class="keyword">if</span> (balance.compareTo(order.getTotalAmount()) &lt;= <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> HmilyRuntimeException(<span class="string">"余额不足！"</span>);</span><br><span class="line">        }</span><br><span class="line">        accountClient.paymentWithNestedException(buildAccountNestedDTO(order));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirmOrderStatus</span><span class="params">(Order order)</span> </span>{</span><br><span class="line">        updateOrderStatus(order, OrderStatusEnum.PAY_SUCCESS);</span><br><span class="line">        LOGGER.info(<span class="string">"=========进行订单confirm操作完成================"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelOrderStatus</span><span class="params">(Order order)</span> </span>{</span><br><span class="line">        updateOrderStatus(order, OrderStatusEnum.PAY_FAIL);</span><br><span class="line">        LOGGER.info(<span class="string">"=========进行订单cancel操作完成================"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateOrderStatus</span><span class="params">(Order order, OrderStatusEnum orderStatus)</span> </span>{</span><br><span class="line">        order.setStatus(orderStatus.getCode());</span><br><span class="line">        orderMapper.update(order);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> AccountDTO <span class="title">buildAccountDTO</span><span class="params">(Order order)</span> </span>{</span><br><span class="line">        AccountDTO accountDTO = <span class="keyword">new</span> AccountDTO();</span><br><span class="line">        accountDTO.setAmount(order.getTotalAmount());</span><br><span class="line">        accountDTO.setUserId(order.getUserId());</span><br><span class="line">        <span class="keyword">return</span> accountDTO;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> InventoryDTO <span class="title">buildInventoryDTO</span><span class="params">(Order order)</span> </span>{</span><br><span class="line">        InventoryDTO inventoryDTO = <span class="keyword">new</span> InventoryDTO();</span><br><span class="line">        inventoryDTO.setCount(order.getCount());</span><br><span class="line">        inventoryDTO.setProductId(order.getProductId());</span><br><span class="line">        <span class="keyword">return</span> inventoryDTO;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> AccountNestedDTO <span class="title">buildAccountNestedDTO</span><span class="params">(Order order)</span> </span>{</span><br><span class="line">        AccountNestedDTO nestedDTO = <span class="keyword">new</span> AccountNestedDTO();</span><br><span class="line">        nestedDTO.setAmount(order.getTotalAmount());</span><br><span class="line">        nestedDTO.setUserId(order.getUserId());</span><br><span class="line">        nestedDTO.setProductId(order.getProductId());</span><br><span class="line">        nestedDTO.setCount(order.getCount());</span><br><span class="line">        <span class="keyword">return</span> nestedDTO;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Swagger 的配置类（Swagger UI 的访问地址：<code>/swagger-ui.html</code>，Swagger JSON 接口的访问地址：<code>/v2/api-docs</code>）</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger2</span></span><br><span class="line"><span class="meta">@SuppressWarnings("all")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SwaggerConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String VERSION = <span class="string">"1.0.0"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">ApiInfo <span class="title">apiInfo</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ApiInfoBuilder()</span><br><span class="line">            .title(<span class="string">"Swagger API"</span>)</span><br><span class="line">            .description(<span class="string">"基于 SpringCloud + Hmily 实战电商系统 TCC 分布式事务"</span>)</span><br><span class="line">            .license(<span class="string">"Apache 2.0"</span>)</span><br><span class="line">            .licenseUrl(<span class="string">"http://www.apache.org/licenses/LICENSE-2.0.html"</span>)</span><br><span class="line">            .termsOfServiceUrl(<span class="string">""</span>)</span><br><span class="line">            .version(VERSION)</span><br><span class="line">            .build();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Docket <span class="title">api</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Docket(DocumentationType.SWAGGER_2).apiInfo(apiInfo()).select().apis(RequestHandlerSelectors.withClassAnnotation(RestController.class))</span><br><span class="line">            <span class="comment">// .paths(paths())</span></span><br><span class="line">            .build().pathMapping(<span class="string">"/"</span>).directModelSubstitute(LocalDate.class, String.class)</span><br><span class="line">            .genericModelSubstitutes(ResponseEntity.class).useDefaultResponseMessages(<span class="keyword">false</span>)</span><br><span class="line">            .globalResponseMessage(RequestMethod.GET, newArrayList(<span class="keyword">new</span> ResponseMessageBuilder().code(<span class="number">500</span>).message(<span class="string">"500 message"</span>)</span><br><span class="line">                .responseModel(<span class="keyword">new</span> ModelRef(<span class="string">"Error"</span>)).build()));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>订单的 Controller 类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/order")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderController</span><span class="params">(OrderService orderService)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.orderService = orderService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = "/orderPay")</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = "订单支付接口（注意这里模拟的是创建订单并进行支付扣减库存等操作）")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">orderPay</span><span class="params">(<span class="meta">@RequestParam(value = "count")</span> Integer count,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="meta">@RequestParam(value = "amount")</span> BigDecimal amount)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> orderService.orderPay(count, amount);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = "/mockInventoryWithTryException")</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = "模拟下单付款操作在try阶段时候，库存异常，此时账户系统和订单状态会回滚，达到数据的一致性（注意:这里模拟的是系统异常，或者rpc异常）")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">mockInventoryWithTryException</span><span class="params">(<span class="meta">@RequestParam(value = "count")</span> Integer count,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                <span class="meta">@RequestParam(value = "amount")</span> BigDecimal amount)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> orderService.mockInventoryWithTryException(count, amount);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = "/mockInventoryWithTryTimeout")</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = "模拟下单付款操作在try阶段时候，库存超时异常（但是自身最后又成功了），此时账户系统和订单状态会回滚，（库存依赖事务日志进行恢复），达到数据的一致性（异常指的是超时异常）")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">mockInventoryWithTryTimeout</span><span class="params">(<span class="meta">@RequestParam(value = "count")</span> Integer count,</span></span></span><br><span class="line"><span class="params"><span class="function">                                              <span class="meta">@RequestParam(value = "amount")</span> BigDecimal amount)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> orderService.mockInventoryWithTryTimeout(count, amount);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = "/mockAccountWithTryException")</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = "模拟下单付款操作在try阶段时候，账户rpc异常，此时订单状态会回滚，达到数据的一致性（注意:这里模拟的是系统异常，或者rpc异常）")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">mockAccountWithTryException</span><span class="params">(<span class="meta">@RequestParam(value = "count")</span> Integer count,</span></span></span><br><span class="line"><span class="params"><span class="function">                                              <span class="meta">@RequestParam(value = "amount")</span> BigDecimal amount)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> orderService.mockAccountWithTryException(count, amount);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = "/mockAccountWithTryTimeout")</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = "模拟下单付款操作在try阶段时候，账户rpc超时异常（但是最后自身又成功了），此时订单状态会回滚，账户系统依赖自身的事务日志进行调度恢复，达到数据的一致性（异常指的是超时异常）")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">mockAccountWithTryTimeout</span><span class="params">(<span class="meta">@RequestParam(value = "count")</span> Integer count,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            <span class="meta">@RequestParam(value = "amount")</span> BigDecimal amount)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> orderService.mockAccountWithTryTimeout(count, amount);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = "/orderPayWithNested")</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = "订单支付接口（这里模拟的是rpc的嵌套调用 order--&gt; account--&gt; inventory）")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">orderPayWithNested</span><span class="params">(<span class="meta">@RequestParam(value = "count")</span> Integer count,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     <span class="meta">@RequestParam(value = "amount")</span> BigDecimal amount)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> orderService.orderPayWithNested(count, amount);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = "/orderPayWithNestedException")</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = "订单支付接口（里模拟的是rpc的嵌套调用 order--&gt; account--&gt; inventory, inventory异常情况")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">orderPayWithNestedException</span><span class="params">(<span class="meta">@RequestParam(value = "count")</span> Integer count,</span></span></span><br><span class="line"><span class="params"><span class="function">                                              <span class="meta">@RequestParam(value = "amount")</span> BigDecimal amount)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> orderService.orderPayWithNestedException(count, amount);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>SpringBoot 的主启动类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication(exclude = {MongoAutoConfiguration.class, MongoDataAutoConfiguration.class})</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@MapperScan("org.dromara.hmily.demo.common.order.mapper")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HmilyOrderApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> </span>{</span><br><span class="line">        SpringApplication.run(HmilyOrderApplication.class, args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h5 id="账户模块"><a href="#账户模块" class="headerlink" title="账户模块"></a>账户模块</h5><h6 id="模块配置-2"><a href="#模块配置-2" class="headerlink" title="模块配置"></a>模块配置</h6><ul><li>Maven 的 XML 配置内容（<code>pom.xml</code>）</li></ul><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.distributed.transaction<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hmily-demo-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>${project.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Web支持 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Eureka --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- OpenFeign --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Hmily --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.dromara<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hmily-spring-boot-starter-springcloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>${hmily.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><ul><li>SpringBoot 的 YML 配置内容（<code>application.yml</code>）</li></ul><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8885</span></span><br><span class="line">  <span class="attr">address:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/account-service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.2.140:3306/hmily_account?useUnicode=true&amp;characterEncoding=utf8</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">account-service</span></span><br><span class="line">  <span class="attr">main:</span></span><br><span class="line">    <span class="attr">allow-bean-definition-overriding:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">org.dromara.hmily.demo.common.account.entity</span></span><br><span class="line">  <span class="attr">config-location:</span> <span class="string">classpath:mybatis/mybatis-config.xml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">${spring.application.name}-${server.port}</span>    <span class="comment"># 自定义服务名称</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>                                   <span class="comment"># 将IP注册到Eureka Server上，若不配置默认使用机器的主机名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Ribbon 的负载均衡策略</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span></span><br><span class="line">  <span class="attr">MaxAutoRetriesNextServer:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">MaxAutoRetries:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Feign 配置</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span>  <span class="comment"># 在 Feign 中是否开启 Hystrix 功能，默认情况下 Feign 不开启 hystrix 功能</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">root:</span> <span class="string">info</span></span><br><span class="line">    <span class="attr">org.apache.ibatis:</span> <span class="string">debug</span></span><br><span class="line">    <span class="attr">org.dromara.hmily.demo.bonuspoint:</span> <span class="string">debug</span></span><br><span class="line">    <span class="attr">org.dromara.hmily.demo.lottery:</span> <span class="string">debug</span></span><br><span class="line">    <span class="attr">org.dromara.hmily.demo:</span> <span class="string">debug</span></span><br><span class="line">    <span class="attr">io.netty:</span> <span class="string">info</span></span><br></pre></td></tr></tbody></table></figure><ul><li>Hmily 的 YML 配置内容（<code>hmily.yml</code>），<strong>可以根据实际业务需求，适当调整 Hmily 的配置参数</strong></li></ul><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Hmily 服务端相关配置</span></span><br><span class="line"><span class="attr">hmily:</span></span><br><span class="line">  <span class="comment"># Hmily Server 配置</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="comment"># 配置模式：local 表示本地配置模式</span></span><br><span class="line">    <span class="attr">configMode:</span> <span class="string">local</span></span><br><span class="line">    <span class="comment"># 当前应用名称（Hmily Server 使用）</span></span><br><span class="line">    <span class="attr">appName:</span> <span class="string">account-sc</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 只有 server.configMode 为 local 时才会读取以下配置</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="comment"># 当前应用名称（业务侧使用）</span></span><br><span class="line">    <span class="attr">appName:</span> <span class="string">account-sc</span></span><br><span class="line">    <span class="comment"># 序列化方式，推荐使用 kryo；支持 hessian、protostuff、jdk；测试表现：kryo &gt; hessian &gt; protostuff &gt; jdk</span></span><br><span class="line">    <span class="attr">serializer:</span> <span class="string">kryo</span></span><br><span class="line">    <span class="comment"># 上下文传递模式（threadLocal / transmittableThreadLocal）</span></span><br><span class="line">    <span class="attr">contextTransmittalMode:</span> <span class="string">threadLocal</span></span><br><span class="line">    <span class="comment"># 定时任务线程池最大线程数，高并发场景下可适当调大</span></span><br><span class="line">    <span class="attr">scheduledThreadMax:</span> <span class="number">16</span></span><br><span class="line">    <span class="comment"># 恢复任务首次延迟时间（秒）</span></span><br><span class="line">    <span class="attr">scheduledRecoveryDelay:</span> <span class="number">60</span></span><br><span class="line">    <span class="comment"># 清理任务执行间隔（秒）</span></span><br><span class="line">    <span class="attr">scheduledCleanDelay:</span> <span class="number">60</span></span><br><span class="line">    <span class="comment"># 物理删除任务执行间隔（秒）</span></span><br><span class="line">    <span class="attr">scheduledPhyDeletedDelay:</span> <span class="number">600</span></span><br><span class="line">    <span class="comment"># 定时任务初始化延迟时间（秒）</span></span><br><span class="line">    <span class="attr">scheduledInitDelay:</span> <span class="number">30</span></span><br><span class="line">    <span class="comment"># 事务恢复延迟时间（秒），强烈建议大于 RPC 调用的超时时间，否则可能误触发补偿；比如设置为：≥ RPC 超时 + 网络抖动余量</span></span><br><span class="line">    <span class="attr">recoverDelayTime:</span> <span class="number">60</span></span><br><span class="line">    <span class="comment"># 清理延迟时间（秒）</span></span><br><span class="line">    <span class="attr">cleanDelayTime:</span> <span class="number">180</span></span><br><span class="line">    <span class="comment"># 单次处理事务的最大数量限制</span></span><br><span class="line">    <span class="attr">limit:</span> <span class="number">200</span></span><br><span class="line">    <span class="comment"># 最大重试次数，默认 10 次，业务服务宕机时定时任务在 retryMax 次内执行 cancel 或 confirm</span></span><br><span class="line">    <span class="attr">retryMax:</span> <span class="number">10</span></span><br><span class="line">    <span class="comment"># Disruptor 缓冲区大小，高并发时可调大，建议为 2 的幂次方</span></span><br><span class="line">    <span class="attr">bufferSize:</span> <span class="number">8192</span></span><br><span class="line">    <span class="comment"># 消费者线程数</span></span><br><span class="line">    <span class="attr">consumerThreads:</span> <span class="number">16</span></span><br><span class="line">    <span class="comment"># 是否启用异步事务日志存储</span></span><br><span class="line">    <span class="attr">asyncRepository:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 是否自动建表（仅关系型数据库有效）</span></span><br><span class="line">    <span class="attr">autoSql:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 是否启用物理删除</span></span><br><span class="line">    <span class="attr">phyDeleted:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 事务数据保留天数</span></span><br><span class="line">    <span class="attr">storeDays:</span> <span class="number">3</span></span><br><span class="line">    <span class="comment"># 事务日志存储类型（mysql / postgresql / mongodb / redis / zookeeper / file 等）</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">mysql</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Hmily 仓库相关配置</span></span><br><span class="line"><span class="attr">repository:</span></span><br><span class="line">  <span class="comment"># 数据库相关配置</span></span><br><span class="line">  <span class="attr">database:</span></span><br><span class="line">    <span class="comment"># JDBC 驱动类名</span></span><br><span class="line">    <span class="attr">driverClassName:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="comment"># 数据库连接 URL</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.2.140:3306/hmily?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">    <span class="comment"># 数据库用户名</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="comment"># 数据库密码</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="comment"># 连接池最大连接数</span></span><br><span class="line">    <span class="attr">maxActive:</span> <span class="number">20</span></span><br><span class="line">    <span class="comment"># 连接池最小空闲连接数</span></span><br><span class="line">    <span class="attr">minIdle:</span> <span class="number">10</span></span><br><span class="line">    <span class="comment"># 获取连接超时时间（毫秒）</span></span><br><span class="line">    <span class="attr">connectionTimeout:</span> <span class="number">30000</span></span><br><span class="line">    <span class="comment"># 连接空闲超时时间（毫秒）</span></span><br><span class="line">    <span class="attr">idleTimeout:</span> <span class="number">600000</span></span><br><span class="line">    <span class="comment"># 连接最大生命周期（毫秒）</span></span><br><span class="line">    <span class="attr">maxLifetime:</span> <span class="number">1800000</span></span><br></pre></td></tr></tbody></table></figure><h6 id="模块代码-2"><a href="#模块代码-2" class="headerlink" title="模块代码"></a>模块代码</h6><ul><li>账户的 Feign 客户端（<strong>这里需要添加 <code>@Hmily</code> 注解，用于标记参与 TCC 分布式事务的业务方法，声明该方法由 Hmily 框架接管并按 Try / Confirm / Cancel 事务模型执行</strong>）</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = "inventory-service")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InventoryClient</span> </span>{</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 库存扣减.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inventoryDTO 实体对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping("/inventory-service/inventory/decrease")</span></span><br><span class="line">    <span class="meta">@Hmily</span></span><br><span class="line">    <span class="function">Boolean <span class="title">decrease</span><span class="params">(<span class="meta">@RequestBody</span> InventoryDTO inventoryDTO)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模拟库存扣减异常.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inventoryDTO 实体对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Hmily</span></span><br><span class="line">    <span class="meta">@RequestMapping("/inventory-service/inventory/mockWithTryException")</span></span><br><span class="line">    <span class="function">Boolean <span class="title">mockWithTryException</span><span class="params">(<span class="meta">@RequestBody</span> InventoryDTO inventoryDTO)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>账户的 Service 接口</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountService</span> </span>{</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扣款支付.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> accountDTO 参数dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">payment</span><span class="params">(AccountDTO accountDTO)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Mock with try exception boolean.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> accountDTO the account dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">mockWithTryException</span><span class="params">(AccountDTO accountDTO)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Mock with try timeout boolean.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> accountDTO the account dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">mockWithTryTimeout</span><span class="params">(AccountDTO accountDTO)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Payment with nested boolean.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nestedDTO the nested dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">paymentWithNested</span><span class="params">(AccountNestedDTO nestedDTO)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Payment with nested exception boolean.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nestedDTO the nested dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">paymentWithNestedException</span><span class="params">(AccountNestedDTO nestedDTO)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户账户信息.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> AccountDO account do</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">AccountDO <span class="title">findByUserId</span><span class="params">(String userId)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>账户的 Service 实现类（<strong>这里需要使用 <code>@HmilyTCC</code> 注解，同时指定 <code>confirmMethod</code> 和 <code>cancelMethod</code> 参数</strong>）</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service("accountService")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title">AccountService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * logger.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(AccountServiceImpl.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AccountMapper accountMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InventoryClient inventoryClient;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Instantiates a new Account service.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> accountMapper the account mapper</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired(required = false)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AccountServiceImpl</span><span class="params">(<span class="keyword">final</span> AccountMapper accountMapper, <span class="keyword">final</span> InventoryClient inventoryClient)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.accountMapper = accountMapper;</span><br><span class="line">        <span class="keyword">this</span>.inventoryClient = inventoryClient;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@HmilyTCC(confirmMethod = "confirm", cancelMethod = "cancel")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">payment</span><span class="params">(<span class="keyword">final</span> AccountDTO accountDTO)</span> </span>{</span><br><span class="line">        LOGGER.info(<span class="string">"============执行try付款接口==============="</span>);</span><br><span class="line">        accountMapper.update(accountDTO);</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@HmilyTCC(confirmMethod = "confirm", cancelMethod = "cancel")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">mockWithTryException</span><span class="params">(AccountDTO accountDTO)</span> </span>{</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> HmilyRuntimeException(<span class="string">"账户扣减异常！"</span>);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@HmilyTCC(confirmMethod = "confirm", cancelMethod = "cancel")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">mockWithTryTimeout</span><span class="params">(AccountDTO accountDTO)</span> </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">//模拟延迟 当前线程暂停10秒</span></span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">int</span> decrease = accountMapper.update(accountDTO);</span><br><span class="line">        <span class="keyword">if</span> (decrease != <span class="number">1</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> HmilyRuntimeException(<span class="string">"账户余额不足"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@HmilyTCC(confirmMethod = "confirmNested", cancelMethod = "cancelNested")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">paymentWithNested</span><span class="params">(AccountNestedDTO nestedDTO)</span> </span>{</span><br><span class="line">        LOGGER.info(<span class="string">"============执行tryNested付款接口==============="</span>);</span><br><span class="line">        accountMapper.update(buildAccountDTO(nestedDTO));</span><br><span class="line">        inventoryClient.decrease(buildInventoryDTO(nestedDTO));</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@HmilyTCC(confirmMethod = "confirmNested", cancelMethod = "cancelNested")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">paymentWithNestedException</span><span class="params">(AccountNestedDTO nestedDTO)</span> </span>{</span><br><span class="line">        accountMapper.update(buildAccountDTO(nestedDTO));</span><br><span class="line">        inventoryClient.mockWithTryException(buildInventoryDTO(nestedDTO));</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AccountDO <span class="title">findByUserId</span><span class="params">(<span class="keyword">final</span> String userId)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> accountMapper.findByUserId(userId);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Confirm boolean.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> accountDTO the account dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">confirm</span><span class="params">(<span class="keyword">final</span> AccountDTO accountDTO)</span> </span>{</span><br><span class="line">        LOGGER.info(<span class="string">"============执行confirm 付款接口==============="</span>);</span><br><span class="line">        <span class="keyword">return</span> accountMapper.confirm(accountDTO) &gt; <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cancel boolean.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> accountDTO the account dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">final</span> AccountDTO accountDTO)</span> </span>{</span><br><span class="line">        LOGGER.info(<span class="string">"============执行cancel 付款接口==============="</span>);</span><br><span class="line">        <span class="keyword">return</span> accountMapper.cancel(accountDTO) &gt; <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">confirmNested</span><span class="params">(AccountNestedDTO accountNestedDTO)</span> </span>{</span><br><span class="line">        LOGGER.info(<span class="string">"============confirmNested确认付款接口==============="</span>);</span><br><span class="line">        <span class="keyword">return</span> accountMapper.confirm(buildAccountDTO(accountNestedDTO)) &gt; <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cancel nested boolean.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> accountNestedDTO the account nested dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancelNested</span><span class="params">(AccountNestedDTO accountNestedDTO)</span> </span>{</span><br><span class="line">        LOGGER.info(<span class="string">"============cancelNested 执行取消付款接口==============="</span>);</span><br><span class="line">        <span class="keyword">return</span> accountMapper.cancel(buildAccountDTO(accountNestedDTO)) &gt; <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> AccountDTO <span class="title">buildAccountDTO</span><span class="params">(AccountNestedDTO nestedDTO)</span> </span>{</span><br><span class="line">        AccountDTO dto = <span class="keyword">new</span> AccountDTO();</span><br><span class="line">        dto.setAmount(nestedDTO.getAmount());</span><br><span class="line">        dto.setUserId(nestedDTO.getUserId());</span><br><span class="line">        <span class="keyword">return</span> dto;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> InventoryDTO <span class="title">buildInventoryDTO</span><span class="params">(AccountNestedDTO nestedDTO)</span> </span>{</span><br><span class="line">        InventoryDTO inventoryDTO = <span class="keyword">new</span> InventoryDTO();</span><br><span class="line">        inventoryDTO.setCount(nestedDTO.getCount());</span><br><span class="line">        inventoryDTO.setProductId(nestedDTO.getProductId());</span><br><span class="line">        <span class="keyword">return</span> inventoryDTO;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>账户的 Controller 类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/account")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AccountService accountService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AccountController</span><span class="params">(AccountService accountService)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.accountService = accountService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping("/payment")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">payment</span><span class="params">(<span class="meta">@RequestBody</span> AccountDTO accountDO)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> accountService.payment(accountDO);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping("/mockWithTryException")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">mockWithTryException</span><span class="params">(<span class="meta">@RequestBody</span> AccountDTO accountDO)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> accountService.mockWithTryException(accountDO);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping("/mockWithTryTimeout")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">mockWithTryTimeout</span><span class="params">(<span class="meta">@RequestBody</span> AccountDTO accountDO)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> accountService.mockWithTryTimeout(accountDO);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping("/paymentWithNested")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">paymentWithNested</span><span class="params">(<span class="meta">@RequestBody</span> AccountNestedDTO nestedDTO)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> accountService.paymentWithNested(nestedDTO);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping("/paymentWithNestedException")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">paymentWithNestedException</span><span class="params">(<span class="meta">@RequestBody</span> AccountNestedDTO nestedDTO)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> accountService.paymentWithNestedException(nestedDTO);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping("/findByUserId")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">findByUserId</span><span class="params">(<span class="meta">@RequestParam("userId")</span> String userId)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> accountService.findByUserId(userId).getBalance();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>SpringBoot 的主启动类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication(exclude = {MongoAutoConfiguration.class, MongoDataAutoConfiguration.class})</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@MapperScan("org.dromara.hmily.demo.common.account.mapper")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HmilyAccountApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> </span>{</span><br><span class="line">        SpringApplication.run(HmilyAccountApplication.class, args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h5 id="库存模块"><a href="#库存模块" class="headerlink" title="库存模块"></a>库存模块</h5><h6 id="模块配置-3"><a href="#模块配置-3" class="headerlink" title="模块配置"></a>模块配置</h6><ul><li>Maven 的 XML 配置内容（<code>pom.xml</code>）</li></ul><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.distributed.transaction<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hmily-demo-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>${project.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Web支持 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Eureka --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- OpenFeign --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Hmily --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.dromara<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hmily-spring-boot-starter-springcloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>${hmily.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><ul><li>SpringBoot 的 YML 配置内容（<code>application.yml</code>）</li></ul><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8883</span></span><br><span class="line">  <span class="attr">address:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/inventory-service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">main:</span></span><br><span class="line">    <span class="attr">allow-bean-definition-overriding:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.2.140:3306/hmily_stock?useUnicode=true&amp;characterEncoding=utf8</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">inventory-service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">org.dromara.hmily.demo.common.inventory.entity</span></span><br><span class="line">  <span class="attr">config-location:</span> <span class="string">classpath:mybatis/mybatis-config.xml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">${spring.application.name}-${server.port}</span>    <span class="comment"># 自定义服务名称</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>                                   <span class="comment"># 将IP注册到Eureka Server上，若不配置默认使用机器的主机名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Ribbon 的负载均衡策略</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">root:</span> <span class="string">info</span></span><br><span class="line">    <span class="attr">org.apache.ibatis:</span> <span class="string">debug</span></span><br><span class="line">    <span class="attr">org.dromara.hmily.demo.bonuspoint:</span> <span class="string">debug</span></span><br><span class="line">    <span class="attr">org.dromara.hmily.demo.lottery:</span> <span class="string">debug</span></span><br><span class="line">    <span class="attr">org.dromara.hmily.demo:</span> <span class="string">debug</span></span><br><span class="line">    <span class="attr">io.netty:</span> <span class="string">info</span></span><br></pre></td></tr></tbody></table></figure><ul><li>Hmily 的 YML 配置内容（<code>hmily.yml</code>），<strong>可以根据实际业务需求，适当调整 Hmily 的配置参数</strong></li></ul><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Hmily 服务端相关配置</span></span><br><span class="line"><span class="attr">hmily:</span></span><br><span class="line">  <span class="comment"># Hmily Server 配置</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="comment"># 配置模式：local 表示本地配置模式</span></span><br><span class="line">    <span class="attr">configMode:</span> <span class="string">local</span></span><br><span class="line">    <span class="comment"># 当前应用名称（Hmily Server 使用）</span></span><br><span class="line">    <span class="attr">appName:</span> <span class="string">inventory-sc</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 只有 server.configMode 为 local 时才会读取以下配置</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="comment"># 当前应用名称（业务侧使用）</span></span><br><span class="line">    <span class="attr">appName:</span> <span class="string">inventory-sc</span></span><br><span class="line">    <span class="comment"># 序列化方式，推荐使用 kryo；支持 hessian、protostuff、jdk；测试表现：kryo &gt; hessian &gt; protostuff &gt; jdk</span></span><br><span class="line">    <span class="attr">serializer:</span> <span class="string">kryo</span></span><br><span class="line">    <span class="comment"># 上下文传递模式（threadLocal / transmittableThreadLocal）</span></span><br><span class="line">    <span class="attr">contextTransmittalMode:</span> <span class="string">threadLocal</span></span><br><span class="line">    <span class="comment"># 定时任务线程池最大线程数，高并发场景下可适当调大</span></span><br><span class="line">    <span class="attr">scheduledThreadMax:</span> <span class="number">16</span></span><br><span class="line">    <span class="comment"># 恢复任务首次延迟时间（秒）</span></span><br><span class="line">    <span class="attr">scheduledRecoveryDelay:</span> <span class="number">60</span></span><br><span class="line">    <span class="comment"># 清理任务执行间隔（秒）</span></span><br><span class="line">    <span class="attr">scheduledCleanDelay:</span> <span class="number">60</span></span><br><span class="line">    <span class="comment"># 物理删除任务执行间隔（秒）</span></span><br><span class="line">    <span class="attr">scheduledPhyDeletedDelay:</span> <span class="number">600</span></span><br><span class="line">    <span class="comment"># 定时任务初始化延迟时间（秒）</span></span><br><span class="line">    <span class="attr">scheduledInitDelay:</span> <span class="number">30</span></span><br><span class="line">    <span class="comment"># 事务恢复延迟时间（秒），强烈建议大于 RPC 调用的超时时间，否则可能误触发补偿；比如设置为：≥ RPC 超时 + 网络抖动余量</span></span><br><span class="line">    <span class="attr">recoverDelayTime:</span> <span class="number">60</span></span><br><span class="line">    <span class="comment"># 清理延迟时间（秒）</span></span><br><span class="line">    <span class="attr">cleanDelayTime:</span> <span class="number">180</span></span><br><span class="line">    <span class="comment"># 单次处理事务的最大数量限制</span></span><br><span class="line">    <span class="attr">limit:</span> <span class="number">200</span></span><br><span class="line">    <span class="comment"># 最大重试次数，默认 10 次，业务服务宕机时定时任务在 retryMax 次内执行 cancel 或 confirm</span></span><br><span class="line">    <span class="attr">retryMax:</span> <span class="number">10</span></span><br><span class="line">    <span class="comment"># Disruptor 缓冲区大小，高并发时可调大，建议为 2 的幂次方</span></span><br><span class="line">    <span class="attr">bufferSize:</span> <span class="number">8192</span></span><br><span class="line">    <span class="comment"># 消费者线程数</span></span><br><span class="line">    <span class="attr">consumerThreads:</span> <span class="number">16</span></span><br><span class="line">    <span class="comment"># 是否启用异步事务日志存储</span></span><br><span class="line">    <span class="attr">asyncRepository:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 是否自动建表（仅关系型数据库有效）</span></span><br><span class="line">    <span class="attr">autoSql:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 是否启用物理删除</span></span><br><span class="line">    <span class="attr">phyDeleted:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 事务数据保留天数</span></span><br><span class="line">    <span class="attr">storeDays:</span> <span class="number">3</span></span><br><span class="line">    <span class="comment"># 事务日志存储类型（mysql / postgresql / mongodb / redis / zookeeper / file 等）</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">mysql</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Hmily 仓库相关配置</span></span><br><span class="line"><span class="attr">repository:</span></span><br><span class="line">  <span class="comment"># 数据库相关配置</span></span><br><span class="line">  <span class="attr">database:</span></span><br><span class="line">    <span class="comment"># JDBC 驱动类名</span></span><br><span class="line">    <span class="attr">driverClassName:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="comment"># 数据库连接 URL</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.2.140:3306/hmily?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">    <span class="comment"># 数据库用户名</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="comment"># 数据库密码</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="comment"># 连接池最大连接数</span></span><br><span class="line">    <span class="attr">maxActive:</span> <span class="number">20</span></span><br><span class="line">    <span class="comment"># 连接池最小空闲连接数</span></span><br><span class="line">    <span class="attr">minIdle:</span> <span class="number">10</span></span><br><span class="line">    <span class="comment"># 获取连接超时时间（毫秒）</span></span><br><span class="line">    <span class="attr">connectionTimeout:</span> <span class="number">30000</span></span><br><span class="line">    <span class="comment"># 连接空闲超时时间（毫秒）</span></span><br><span class="line">    <span class="attr">idleTimeout:</span> <span class="number">600000</span></span><br><span class="line">    <span class="comment"># 连接最大生命周期（毫秒）</span></span><br><span class="line">    <span class="attr">maxLifetime:</span> <span class="number">1800000</span></span><br></pre></td></tr></tbody></table></figure><h6 id="模块代码-3"><a href="#模块代码-3" class="headerlink" title="模块代码"></a>模块代码</h6><ul><li>库存的 Service 接口</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InventoryService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取商品库存信息.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> productId 商品id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> InventoryDO inventory do</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">InventoryDO <span class="title">findByProductId</span><span class="params">(String productId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扣减库存操作.</span></span><br><span class="line"><span class="comment">     * 这一个tcc接口</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inventoryDTO 库存DTO对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Boolean <span class="title">decrease</span><span class="params">(InventoryDTO inventoryDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * mock 库存扣减try阶段异常.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inventoryDTO dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Boolean <span class="title">mockWithTryException</span><span class="params">(InventoryDTO inventoryDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * mock 库存扣减try阶段超时.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inventoryDTO dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Boolean <span class="title">mockWithTryTimeout</span><span class="params">(InventoryDTO inventoryDTO)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>库存的 Service 实现类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service("inventoryService")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InventoryServiceImpl</span> <span class="keyword">implements</span> <span class="title">InventoryService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(InventoryServiceImpl.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InventoryMapper inventoryMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired(required = false)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InventoryServiceImpl</span><span class="params">(InventoryMapper inventoryMapper)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.inventoryMapper = inventoryMapper;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取商品库存信息.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> productId 商品id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> InventoryDO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> InventoryDO <span class="title">findByProductId</span><span class="params">(String productId)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> inventoryMapper.findByProductId(productId);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扣减库存操作.</span></span><br><span class="line"><span class="comment">     * 这一个tcc接口</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inventoryDTO 库存DTO对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@HmilyTCC(confirmMethod = "confirmMethod", cancelMethod = "cancelMethod")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">decrease</span><span class="params">(InventoryDTO inventoryDTO)</span> </span>{</span><br><span class="line">        LOGGER.info(<span class="string">"==========try扣减库存decrease==========="</span>);</span><br><span class="line">        inventoryMapper.decrease(inventoryDTO);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@HmilyTCC(confirmMethod = "confirmMethod", cancelMethod = "cancelMethod")</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">mockWithTryException</span><span class="params">(InventoryDTO inventoryDTO)</span> </span>{</span><br><span class="line">        <span class="comment">//这里是模拟异常所以就直接抛出异常了</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> HmilyRuntimeException(<span class="string">"库存扣减异常！"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@HmilyTCC(confirmMethod = "confirmMethod", cancelMethod = "cancelMethod")</span></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">mockWithTryTimeout</span><span class="params">(InventoryDTO inventoryDTO)</span> </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">//模拟延迟 当前线程暂停10秒</span></span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        LOGGER.info(<span class="string">"==========springcloud调用扣减库存mockWithTryTimeout==========="</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> decrease = inventoryMapper.decrease(inventoryDTO);</span><br><span class="line">        <span class="keyword">if</span> (decrease != <span class="number">1</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> HmilyRuntimeException(<span class="string">"库存不足"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">confirmMethod</span><span class="params">(InventoryDTO inventoryDTO)</span> </span>{</span><br><span class="line">        LOGGER.info(<span class="string">"==========confirmMethod库存确认方法==========="</span>);</span><br><span class="line">        <span class="keyword">return</span> inventoryMapper.confirm(inventoryDTO) &gt; <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">confirmMethodTimeout</span><span class="params">(InventoryDTO inventoryDTO)</span> </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">//模拟延迟 当前线程暂停11秒</span></span><br><span class="line">            Thread.sleep(<span class="number">11000</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        LOGGER.info(<span class="string">"==========Springcloud调用扣减库存确认方法==========="</span>);</span><br><span class="line">        inventoryMapper.decrease(inventoryDTO);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">confirmMethodException</span><span class="params">(InventoryDTO inventoryDTO)</span> </span>{</span><br><span class="line">        LOGGER.info(<span class="string">"==========Springcloud调用扣减库存确认方法==========="</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> decrease = inventoryMapper.decrease(inventoryDTO);</span><br><span class="line">        <span class="keyword">if</span> (decrease != <span class="number">1</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> HmilyRuntimeException(<span class="string">"库存不足"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// throw new TccRuntimeException("库存扣减确认异常！");</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">cancelMethod</span><span class="params">(InventoryDTO inventoryDTO)</span> </span>{</span><br><span class="line">        LOGGER.info(<span class="string">"==========cancelMethod库存取消方法==========="</span>);</span><br><span class="line">        <span class="keyword">return</span> inventoryMapper.cancel(inventoryDTO) &gt; <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>库存的 Controller 类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/inventory")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InventoryController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InventoryService inventoryService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InventoryController</span><span class="params">(InventoryService inventoryService)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.inventoryService = inventoryService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping("/decrease")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">decrease</span><span class="params">(<span class="meta">@RequestBody</span> InventoryDTO inventoryDTO)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> inventoryService.decrease(inventoryDTO);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping("/findByProductId")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">findByProductId</span><span class="params">(<span class="meta">@RequestParam("productId")</span> String productId)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> inventoryService.findByProductId(productId).getTotalInventory();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping("/mockWithTryException")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">mockWithTryException</span><span class="params">(<span class="meta">@RequestBody</span> InventoryDTO inventoryDTO)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> inventoryService.mockWithTryException(inventoryDTO);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping("/mockWithTryTimeout")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">mockWithTryTimeout</span><span class="params">(<span class="meta">@RequestBody</span> InventoryDTO inventoryDTO)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> inventoryService.mockWithTryTimeout(inventoryDTO);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>SpringBoot 的主启动类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication(exclude = {MongoAutoConfiguration.class, MongoDataAutoConfiguration.class})</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@MapperScan("org.dromara.hmily.demo.common.inventory.mapper")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HmilyInventoryApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> </span>{</span><br><span class="line">        SpringApplication.run(HmilyInventoryApplication.class, args);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="代码测试"><a href="#代码测试" class="headerlink" title="代码测试"></a>代码测试</h4><ul><li><p>(1) 启动所有微服务应用</p></li><li><p>(2) 浏览器访问 <code>http://127.0.0.1:8090/swagger-ui.html</code>，打开 Swagger 的接口测试界面，如下图所示：</p></li></ul><p><img data-src="../../../asset/2026/01/tcc-transaction-41.png"></p><ul><li>(3) 通过 Swagger 的接口测试界面，分别测试不同的接口，并观察各个微服务应用输出的日志信息，验证 Hmily 的 TCC 分布式事务是否生效</li></ul><h4 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h4><h5 id="SPI-异常"><a href="#SPI-异常" class="headerlink" title="SPI 异常"></a>SPI 异常</h5><ul><li>问题描述：使用 <code>hmily-spring-boot-starter-springcloud</code> 的 <code>2.1.1</code> 版本时，无论是分布式事务发起者，还是分布式事务参与者，第一次执行 TCC 分布式事务之前都会抛出以下异常：</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.dromara.hmily.spi.ExtensionLoader : not found service provider for : org.dromara.hmily.core.service.HmilyTransactionHandlerFactory</span><br></pre></td></tr></tbody></table></figure><ul><li>解决方案：这异常只会在 Hmily 第一次执行 TCC 分布式事务之前才会抛出，不会影响 TCC 事务的真正执行，暂时找不到好的解决办法，建议参考 <a target="_blank" rel="external nofollow" href="https://github.com/dromara/hmily/issues?q=HmilyTransactionHandlerFactory">GitHub Issues</a>。</li></ul><h4 id="补充说明"><a href="#补充说明" class="headerlink" title="补充说明"></a>补充说明</h4><h5 id="TCC-不适用于外部支付系统"><a href="#TCC-不适用于外部支付系统" class="headerlink" title="TCC 不适用于外部支付系统"></a>TCC 不适用于外部支付系统</h5><p>当内部的账户系统变成外部第三方支付系统（如支付宝、微信支付）后，Hmily TCC 在 “资金扣款” 这个核心链路上基本不再适用。<strong>但注意，是 Hmily 不再适合做完整 TCC，而不是说 Hmily 完全没用了</strong>。</p><div class="admonition warning"><p class="admonition-title">特别注意</p><ul><li>当账户系统演进为第三方支付系统后，由于支付行为不可回滚、事务控制权不在本系统内，Hmily TCC 不再适合覆盖资金扣减链路。</li><li>实践中通常将 TCC 的事务边界限定在订单与库存等内部可控系统，支付采用异步回调与最终一致性方案，通过订单状态机和补偿机制保证业务正确性。</li></ul></div><blockquote><p>内部的账户系统变成外部第三方支付系统时，为什么 Hmily TCC 不再适用？</p></blockquote><ul><li><p>使用 TCC 的前提条件，其实非常苛刻，要求每个分布式事务参与方都必须：</p><ul><li>能暴露 Try / Confirm / Cancel 这三个核心接口</li><li>能保证：<ul><li>幂等</li><li>空回滚</li><li>防悬挂</li><li>业务资源可控、可回滚</li></ul></li><li>第三方支付系统，几乎不满足这些条件</li></ul></li><li><p>第三方支付系统的 “天然不兼容点”，以支付宝为例：</p></li></ul><table><thead><tr><th>TCC 要求</th><th>第三方支付系统的现状</th></tr></thead><tbody><tr><td> Try：预扣资源</td><td>❌ 没有 “预扣 + 不结算” 这种语义</td></tr><tr><td> Confirm：最终提交</td><td>❌ 支付成功即最终态</td></tr><tr><td> Cancel：回滚 Try</td><td>❌ 扣了钱只能走退款流程（异步、不可控）</td></tr><tr><td>事务控制权</td><td>❌ 在第三方手里</td></tr><tr><td>接口可幂等重试</td><td>⚠️ 部分支持，但语义不同</td></tr></tbody></table><blockquote><p>内部的账户系统变成外部第三方支付系统时，推荐的架构拆分方案</p></blockquote><ul><li><p>TCC 只覆盖「订单 + 库存」</p><ul><li>这是最常见、也是最成熟的方案（99% 电商系统的选择）<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">用户下单请求</span><br><span class="line">↓</span><br><span class="line">订单服务（Try）</span><br><span class="line">↓</span><br><span class="line">库存服务（Try）</span><br><span class="line">↓</span><br><span class="line">TCC Confirm</span><br><span class="line">↓</span><br><span class="line">生成 "待支付订单"</span><br><span class="line">↓</span><br><span class="line">跳转第三方支付</span><br></pre></td></tr></tbody></table></figure></li><li>方案特点<ul><li> Hmily TCC 只负责：<ul><li>订单创建</li><li>库存扣减</li></ul></li><li>支付系统：<ul><li>完全在 TCC 事务之外</li></ul></li><li>订单状态机控制后续流程</li></ul></li></ul></li><li><p>那钱和库存不一致怎么办？</p><ul><li><p>以订单状态驱动（核心）</p><ul><li>典型的订单状态流转：<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">→ INIT（初始化）</span><br><span class="line">→ STOCK_LOCKED（库存已锁）</span><br><span class="line">→ PAYING（支付中）</span><br><span class="line">→ PAID（支付成功）</span><br><span class="line">→ CANCELED / CLOSED</span><br></pre></td></tr></tbody></table></figure></li><li>TCC 只保证 <code>INIT → STOCK_LOCKED</code></li><li>支付结果通过异步回调驱动</li></ul></li><li><p>支付结果异步对账（最终一致性）</p><ul><li>支付成功回调：<ul><li>更新订单转投为 <code>PAID</code></li><li>触发发货</li></ul></li><li>支付超时 / 失败：<ul><li>定时任务关闭订单</li><li>释放库存（或反向补偿）</li></ul></li><li>这是 “可靠消息 + 最终一致性” 模型</li></ul></li></ul></li></ul><blockquote><p>什么时候还能 “部分用 TCC + 第三方支付”？</p></blockquote><ul><li>只有一种场景勉强可行：自己（内部）实现了 “账户体系”，第三方支付只是 “充值通道”</li><li> 例如：<ul><li>用户先用支付宝充值到内部账户余额</li><li>用户下单时：<ul><li>使用内部账户余额扣款（TCC）</li><li>不直接调用支付宝</li></ul></li></ul></li><li> Hmily 依然非常适合这种场景<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">支付宝 → 内部账户（非事务）</span><br><span class="line">内部账户 + 订单 + 库存（TCC）</span><br></pre></td></tr></tbody></table></figure></li></ul><blockquote><p>部分用 TCC + 第三方支付的时序图</p></blockquote><pre class="mermaid">sequenceDiagram
    participant U as 用户
    participant O as 订单服务
    participant S as 库存服务
    participant P as 第三方支付

    %% ========== TCC 事务第一阶段：Try ==========
    rect rgb(245,245,245)
        Note over O,S: TCC 事务第一阶段：Try（校验 + 资源预留）
        U-&gt;&gt;O: 1. 提交下单请求
        O-&gt;&gt;O: 2. 创建订单（状态 = INIT）
        O-&gt;&gt;S: 3. Try 锁定库存
        S--&gt;&gt;O: 库存锁定成功
        O-&gt;&gt;O: 4. 更新订单状态 = STOCK_LOCKED
    end

    %% ========== TCC 事务第二阶段：Confirm / Cancel ==========
    rect rgb(230,255,230)
        alt 全局事务成功
            Note over O,S: TCC 事务第二阶段：Confirm（提交 Try 结果）
            O-&gt;&gt;O: 5. Confirm 订单（状态保持 = STOCK_LOCKED）
            O-&gt;&gt;S: 6. Confirm 库存锁定生效
        else 全局事务失败
            Note over O,S: TCC 事务第二阶段：Cancel（回滚 Try 结果）
            O-&gt;&gt;O: 5'. Cancel 订单（状态 = CANCELED）
            O-&gt;&gt;S: 6'. Cancel 释放库存
        end
    end

    %% ========== TCC 事务结束 ==========
    Note over O,S: TCC 事务结束（仅涵盖订单 + 库存）

    %% ========== 支付在 TCC 事务之外 ==========
    O-&gt;&gt;O: 7. 更新订单状态 = PAYING
    O-&gt;&gt;U: 8. 返回支付信息
    U-&gt;&gt;P: 9. 跳转第三方支付
    P--&gt;&gt;O: 10. 支付结果回调

    alt 支付成功
        O-&gt;&gt;O: 11. 更新订单状态 = PAID
        O-&gt;&gt;S: 12. 业务确认库存扣减 / 发货
    else 支付失败 / 超时
        O-&gt;&gt;O: 11'. 关闭订单（状态 = CLOSED）
        O-&gt;&gt;S: 12'. 业务补偿释放库存
    end</pre><div class="admonition note"><p class="admonition-title">时序图说明</p><p>在工程实现（架构最佳实践）中，订单状态由 <code>INIT</code> 更新为 <code>STOCK_LOCKED</code> 的操作放在 Try 阶段完成，用于标识库存已成功预占；Confirm 阶段仅用于确认库存锁定结果，不再修改订单状态，从而降低 Confirm 阶段的并发写与幂等复杂度。值得一提的是，这没有绝对的对错，订单状态由 <code>INIT</code> 更新为 <code>STOCK_LOCKED</code> 的操作也可以放在 Confirm 阶段完成。</p></div><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/m0_61775876/article/details/129705464">Hmily 的 AOP 与 SPI 扩展浅析</a></li><li><a target="_blank" rel="external nofollow" href="https://cloud.tencent.com/developer/article/2082639">分布式事务解决方案之 TCC（Hmily）</a></li><li><a target="_blank" rel="external nofollow" href="https://juejin.cn/post/7433042711203545126">SpringBoot 整合 Hmily 实现 TCC 分布式事务</a></li><li><a target="_blank" rel="external nofollow" href="https://cloud.tencent.com/developer/article/2089364">分布式事务 TCC 框架 - Hmily（Spring Cloud Feign）</a></li></ul><script type="module"> import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';    mermaid.initialize({startOnLoad: true, flowchart: {curve: 'linear'}}); </script><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/a02756f8.html" title="基于 Hmily 实战 TCC 分布式事务之三">https://www.techgrow.cn/posts/a02756f8.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="fa fa-tag"></i> 微服务</a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag"><i class="fa fa-tag"></i> 数据库</a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag"><i class="fa fa-tag"></i> 分布式</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/e2246230.html" rel="prev" title="Knife4j 基础使用教程"><i class="fa fa-angle-left"></i> Knife4j 基础使用教程</a></div><div class="post-nav-item"> <a href="/posts/ffd8d40a.html" rel="next" title="LeetCode 刷题教程之一">LeetCode 刷题教程之一<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2026</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">2.4m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">35:47</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"/lib/mathjax/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/js/third-party/math/mathjax.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/a02756f8.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div><div id="moon-menu-item-code" class="moon-menu-item"><i class="fa-solid fa-code"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>