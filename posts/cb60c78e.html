<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍Spring Cloud Hystrix的基础使用，包括熔断机制、降级机制、超时机制、异常机制等。"><meta property="og:type" content="article"><meta property="og:title" content="Hystrix 入门教程 - 基础篇之二"><meta property="og:url" content="https://www.techgrow.cn/posts/cb60c78e.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍Spring Cloud Hystrix的基础使用，包括熔断机制、降级机制、超时机制、异常机制等。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/04/hystrix-handle-fallback.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/04/fallback-throw-exception.png"><meta property="article:published_time" content="2018-04-24T14:33:05.000Z"><meta property="article:modified_time" content="2018-04-24T14:33:05.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="微服务"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2020/04/hystrix-handle-fallback.png"><link rel="canonical" href="https://www.techgrow.cn/posts/cb60c78e.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/cb60c78e.html","path":"posts/cb60c78e.html","title":"Hystrix 入门教程 - 基础篇之二"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Hystrix 入门教程 - 基础篇之二 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hystrix-%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="nav-text">Hystrix 配置说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hystrix-%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8"><span class="nav-text">Hystrix 命令使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%A4%E7%A7%8D%E5%91%BD%E4%BB%A4%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-text">两种命令的区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%A4%E7%A7%8D%E5%91%BD%E4%BB%A4%E7%9A%84%E6%A0%B8%E5%BF%83%E6%96%B9%E6%B3%95"><span class="nav-text">两种命令的核心方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%A4%E7%A7%8D%E5%91%BD%E4%BB%A4%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-text">两种命令的最佳实践</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%A4%E7%A7%8D%E5%91%BD%E4%BB%A4%E7%9A%84%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="nav-text">两种命令的使用示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hystrix-%E9%9A%94%E7%A6%BB%E7%AD%96%E7%95%A5"><span class="nav-text">Hystrix 隔离策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%9A%94%E7%A6%BB"><span class="nav-text">线程池隔离</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7%E9%87%8F%E9%9A%94%E7%A6%BB"><span class="nav-text">信号量隔离</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hystrix-%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6"><span class="nav-text">Hystrix 熔断机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6%E7%9A%84%E4%BB%8B%E7%BB%8D"><span class="nav-text">熔断机制的介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="nav-text">熔断机制的配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">熔断机制的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-text">熔断机制的注意事项</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hystrix-%E9%99%8D%E7%BA%A7%E6%9C%BA%E5%88%B6"><span class="nav-text">Hystrix 降级机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%8D%E7%BA%A7%E6%9C%BA%E5%88%B6%E7%9A%84%E4%BB%8B%E7%BB%8D"><span class="nav-text">降级机制的介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%8D%E7%BA%A7%E6%9C%BA%E5%88%B6%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="nav-text">降级机制的配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%8D%E7%BA%A7%E6%9C%BA%E5%88%B6%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">降级机制的使用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hystrix-%E8%B6%85%E6%97%B6%E6%9C%BA%E5%88%B6"><span class="nav-text">Hystrix 超时机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B6%85%E6%97%B6%E6%9C%BA%E5%88%B6%E7%9A%84%E4%BB%8B%E7%BB%8D"><span class="nav-text">超时机制的介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B6%85%E6%97%B6%E6%9C%BA%E5%88%B6%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">超时机制的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B6%85%E6%97%B6%E6%9C%BA%E5%88%B6%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-text">超时机制的工作原理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hystrix-%E5%BC%82%E5%B8%B8%E6%9C%BA%E5%88%B6"><span class="nav-text">Hystrix 异常机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E7%A7%8D%E4%BC%9A%E8%A2%AB-fallback-%E6%88%AA%E8%8E%B7%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-text">5 种会被 fallback 截获的情况</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-fallback-%E9%87%8C%E7%9A%84%E5%BC%82%E5%B8%B8%E4%BF%A1%E6%81%AF"><span class="nav-text">获取 fallback 里的异常信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fallback-%E4%BC%9A%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-text">fallback 会抛出异常的情况</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hystrix-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%85%8D%E7%BD%AE"><span class="nav-text">Hystrix 线程池配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%B1%A0%E8%A7%84%E5%88%99"><span class="nav-text">默认的线程池规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8F%82%E6%95%B0"><span class="nav-text">线程池的核心参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%9A%94%E7%A6%BB%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82"><span class="nav-text">线程池隔离的实现细节</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0-%E6%9C%8D%E5%8A%A1-%E6%8E%A5%E5%8F%A3%E5%88%92%E5%88%86"><span class="nav-text">线程池 + 服务 + 接口划分</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E5%8F%82%E6%95%B0"><span class="nav-text">自定义线程池的参数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">738</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">53</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/cb60c78e.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Hystrix 入门教程 - 基础篇之二 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍Spring Cloud Hystrix的基础使用，包括熔断机制、降级机制、超时机制、异常机制等。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Hystrix 入门教程 - 基础篇之二</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2018-04-24 22:33:05" itemprop="dateCreated datePublished" datetime="2018-04-24T22:33:05+08:00">2018-04-24</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/cb60c78e.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/cb60c78e.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>15k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>13 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/2ed0fea6.html">Hystrix 入门教程 - 基础篇之一</a></li><li><a href="/posts/cb60c78e.html">Hystrix 入门教程 - 基础篇之二</a></li><li><a href="/posts/893c5183.html">Hystrix 入门教程 - 基础篇之三</a></li></ul><h2 id="Hystrix-配置说明"><a href="#Hystrix-配置说明" class="headerlink" title="Hystrix 配置说明"></a>Hystrix 配置说明</h2><p>Hystrix 的配置比较多，具体可以参考：<a target="_blank" rel="external nofollow" href="https://github.com/Netflix/Hystrix/wiki/Configuration">官方英文文档</a>，<a target="_blank" rel="external nofollow" href="https://xieyanze.gitbooks.io/hystrix-document/content/configuration.html">第三方中文文档</a></p><span id="more"></span><h2 id="Hystrix-命令使用"><a href="#Hystrix-命令使用" class="headerlink" title="Hystrix 命令使用"></a>Hystrix 命令使用</h2><p>Hystrix 提供了两种命令，包括 HystrixCommand（<code>@HystrixCommand</code>）和 HystrixObservableCommand，两者都支持故障与延迟容错、断路器、指标统计等功能。</p><div class="admonition warning"><p class="admonition-title">特别注意</p><p>Hystrix 为 HystrixCommand 提供了 <code>@HystrixCommand</code> 注解（底层基于自定义注解 + AOP 实现），但没有为 HystrixObservableCommand 提供相应的注解。这是因为 HystrixObservableCommand 是基于 RxJava 的 Observable 异步流，可以发射多个结果，逻辑更复杂。注解方式不适合封装这种流式、多次发射的异步执行，因为 AOP 拦截的是方法的一次调用，难以覆盖 Observable 的整个生命周期，也无法直接处理其订阅、错误回调和完成回调。</p></div><h3 id="两种命令的区别"><a href="#两种命令的区别" class="headerlink" title="两种命令的区别"></a>两种命令的区别</h3><ul><li>HystrixCommand 默认是阻塞式的，既支持同步调用，也支持异步调用；而 HystrixObservableCommand 默认是非阻塞式的，支持异步调用，也支持转换为同步调用。</li><li>HystrixCommand 的核心执行方法是 <code>run()</code>，而 HystrixObservableCommand 的核心执行方法是 <code>construct()</code>。</li><li>HystrixCommand 每次执行只能返回一个结果，而 HystrixObservableCommand 可以返回多个结果流。</li></ul><table><thead><tr><th>特性</th><th><code>HystrixCommand</code></th><th><code>HystrixObservableCommand</code></th></tr></thead><tbody><tr><td>返回结果</td><td>单个结果（同步 / 异步）</td><td>多个结果流（响应式，支持流式返回）</td></tr><tr><td>执行方式</td><td><code>run()</code> 返回单一值</td><td><code>construct()</code> 返回 <code>Observable&lt;T&gt;</code>（可发射多个元素或 0 个元素）</td></tr><tr><td>支持场景</td><td>一次调用只需要一个结果（比如：查询用户信息、下单操作）</td><td>需要返回数据流的场景（比如：获取一个批量数据流、事件推送）</td></tr><tr><td>编程模型</td><td>命令式 + Future</td><td> 响应式 + RxJava</td></tr><tr><td> 使用难度</td><td>较简单</td><td>相对复杂，需要 RxJava 思维</td></tr></tbody></table><h3 id="两种命令的核心方法"><a href="#两种命令的核心方法" class="headerlink" title="两种命令的核心方法"></a>两种命令的核心方法</h3><ul><li><p>HystrixCommand 的核心方法：</p><ul><li><code>run()</code>：核心方法，执行一次只会返回一个结果</li><li><code>execute()</code>：同步调用（阻塞式），调用后直接阻塞住，直到依赖服务返回单个结果或者抛出异常</li><li><code>queue()</code>：异步调用（非阻塞式），返回一个 Future，后面可以通过 Future 获取单个结果</li><li><code>observe()</code>：异步调用（非阻塞式），订阅一个 Observable 对象，Observable 代表的是依赖服务返回的结果，获取到一个代表结果的 Observable 对象的拷贝对象</li></ul></li><li><p> HystrixObservableCommand 的核心方法：</p><ul><li><code>construct()</code>：核心方法，返回 <code>Observable&lt;T&gt;</code>（可发射多个元素或 0 个元素）</li><li>如果确定只会返回一条数据，可以使用 <code>toBlocking().single()</code>、<code>toBlocking().toFuture().get()</code> 等方式阻塞等待执行结果（即同步调用）</li><li><code>observe()</code><ul><li>作用：返回一个热 <code>Observable</code>（Hot Observable）</li><li>特点：<ul><li>调用 <code>observe()</code> 的时候就会立刻触发执行（不会等待订阅）</li><li>多个订阅者会共享同一次执行结果（即多次订阅 → 复用同一次执行）</li></ul></li><li>适用场景：希望立即触发命令，并把同一个结果分发给多个订阅者</li></ul></li><li><code>toObservable()</code><ul><li>作用：直接返回一个冷 <code>Observable</code>（Cold Observable）</li><li>特点：<ul><li>只有当订阅（<code>subscribe()</code>）发生时，命令才会真正执行</li><li>每次有新的订阅者时，都会触发一次新的执行（即多次订阅 → 多次执行）</li></ul></li><li>适用场景：需要完全控制订阅时机，或者希望每个订阅者独立执行一次命令</li></ul></li></ul></li></ul><div class="admonition warning"><p class="admonition-title">HystrixCommand 的底层实现</p><ul><li>HystrixCommand 的 <code>execute()</code> 底层调用的是 <code>queue().get()</code>，接着会调用 <code>toObservable().toBlocking().toFuture()</code>；也就是说，无论是哪种执行 Command 的方式，最终都是依赖 <code>toObservable()</code> 去执行的。</li><li>换言之，<code>toObservable()</code> 才是 HystrixCommand 执行逻辑的统一入口，它负责触发 <code>construct()</code> 或者 <code>run()</code> 方法，执行命令逻辑，并把结果流式化为 Observable，其他方法只是包装了不同的同步 / 异步调用语义。</li></ul></div><div class="admonition warning"><p class="admonition-title">Hystrix 的超时处理机制</p><p>在 Hystrix 中，如果 <code>HystrixCommand.run()</code> 或 <code>HystrixObservableCommand.construct()</code> 的执行时间超过了配置的超时时长，那么命令（Command）所在的主调用线程会抛出一个 <code>TimeoutException</code>，并触发 <code>fallback</code> 降级逻辑，此时不会再关心 <code>run()</code> 或 <code>construct()</code> 的返回值。<strong>需要特别注意的是，Hystrix 并不能真正中断一个正在执行且已经超时的依赖调用线程，该线程仍然可能因为长时间阻塞而占用线程池资源，从而导致线程池被耗尽，即使此时新请求已经被限流或拒绝；这是因为 Java 线程的中断机制是协作式的，只能发出中断信号，而不能强制终止线程</strong>。相反，如果执行没有超时，那么依赖调用的结果会被正常返回，同时 Hystrix 会进行相关的日志记录和指标统计。</p></div><h3 id="两种命令的最佳实践"><a href="#两种命令的最佳实践" class="headerlink" title="两种命令的最佳实践"></a>两种命令的最佳实践</h3><p>从 Hystrix 的设计理念和最佳实践来看，HystrixCommand（<code>@HystrixCommand</code>）和 HystrixObservableCommand 应该尽量用在 Service 层，而不是 Controller 层。原因如下：</p><ul><li>(1) 业务逻辑和远程调用集中在 Service 层<ul><li> Hystrix 的核心作用是熔断、降级、隔离远程调用。</li><li>Controller 层只负责接收请求、组装参数和返回响应，不直接处理远程调用。</li><li>将 Hystrix 放在 Service 层，能保护实际的远程服务调用，而不是整个 HTTP 接口。</li></ul></li><li>(2) 便于代码复用<ul><li> Service 层的方法可能会被多个 Controller 调用，如果 Hystrix 用在 Service 层，熔断、降级和隔离策略可以被多个调用共享。</li></ul></li><li>(3) 避免 Controller 层阻塞过多<ul><li> Controller 层本身应该轻量化，尽量不直接处理熔断逻辑，否则会增加 Controller 复杂度。</li></ul></li><li>(4) 测试和维护更方便<ul><li>在 Service 层使用 HystrixCommand，可以单独测试远程调用逻辑和降级策略，而不依赖 Controller 层。</li></ul></li></ul><h3 id="两种命令的使用示例"><a href="#两种命令的使用示例" class="headerlink" title="两种命令的使用示例"></a>两种命令的使用示例</h3><p>HystrixCommand 的使用示例：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetProductInfoCommand</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Long productId;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GetProductInfoCommand</span><span class="params">(Long productId)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(HystrixCommandGroupKey.Factory.asKey(<span class="string">"ProductService"</span>));</span><br><span class="line">        <span class="keyword">this</span>.productId = productId;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">// 这里写远程调用逻辑，比如调用商品服务接口</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"ProductInfo for id="</span> + productId;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getFallback</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// 降级逻辑</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Fallback ProductInfo"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>HystrixCommand 的调用方式：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String result = <span class="keyword">new</span> GetProductInfoCommand(<span class="number">1L</span>).execute(); <span class="comment">// 同步调用</span></span><br><span class="line">Future&lt;String&gt; future = <span class="keyword">new</span> GetProductInfoCommand(<span class="number">1L</span>).queue(); <span class="comment">// 异步调用</span></span><br></pre></td></tr></tbody></table></figure><hr><p>HystrixObservableCommand 的使用示例：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> rx.Observable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetProductInfoObservableCommand</span> <span class="keyword">extends</span> <span class="title">HystrixObservableCommand</span>&lt;<span class="title">String</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Long[] productIds;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GetProductInfoObservableCommand</span><span class="params">(Long[] productId)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(HystrixCommandGroupKey.Factory.asKey(<span class="string">"ProductService"</span>));</span><br><span class="line">        <span class="keyword">this</span>.productIds = productId;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Observable&lt;String&gt; <span class="title">construct</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// 返回一个 Observable，可以发射多个结果</span></span><br><span class="line">        <span class="keyword">return</span> Observable.create(subscriber -&gt; {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="keyword">if</span> (!subscriber.isUnsubscribed()) {</span><br><span class="line">                    <span class="keyword">for</span> (Long productId : productIds) {</span><br><span class="line">                        subscriber.onNext(<span class="string">"ProductInfo part1 for id="</span> + productId);</span><br><span class="line">                    }</span><br><span class="line">                    subscriber.onCompleted();</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                subscriber.onError(e);</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Observable&lt;String&gt; <span class="title">resumeWithFallback</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> Observable.just(<span class="string">"Fallback ProductInfo"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>HystrixObservableCommand 的调用方式：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Observable&lt;String&gt; observable = <span class="keyword">new</span> GetProductInfoObservableCommand(<span class="number">1L</span>).observe();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 订阅并处理多个结果流</span></span><br><span class="line">observable.subscribe(<span class="keyword">new</span> Observer&lt;String&gt;() {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String result)</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"Received: "</span> + result);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"Error: "</span> + e);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"Completed"</span>);</span><br><span class="line">    }</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><h2 id="Hystrix-隔离策略"><a href="#Hystrix-隔离策略" class="headerlink" title="Hystrix 隔离策略"></a>Hystrix 隔离策略</h2><p>Hystrix 会对请求进行封装，然后管理请求的调用，从而实现断路器等多种功能。Hystrix 提供了两种隔离策略来处理请求，一种是线程池隔离（默认），一种是信号量隔离。</p><h3 id="线程池隔离"><a href="#线程池隔离" class="headerlink" title="线程池隔离"></a>线程池隔离</h3><p>Hystrix 采用 Bulkhead（舱壁隔离）技术，将外部依赖进行资源隔离，避免某个外部依赖的故障拖垮整个服务。在线程池隔离策略下，每个外部依赖的调用都在其独立的线程池中执行，从而与业务调用线程分离。这样即使外部依赖发生超时或延迟过长，也不会阻塞业务调用线程。此外，Hystrix 会为不同的外部依赖分配独立的线程池。如果某个依赖延迟严重，最多只会耗尽该依赖所属的线程池资源，而不会影响其他依赖的正常调用。</p><blockquote><p>线程池隔离的介绍</p></blockquote><ul><li>概述<ul><li> Hystrix 会为每个服务调用（Command）分配一个独立的线程池（可以自定义大小），调用服务时，会在这个线程池中执行。</li><li>这样即使某个服务调用非常慢或阻塞，也不会影响调用它的主调用线程或者其他服务调用。</li><li>线程池内部有一个等待队列（Queue），默认可配置 <code>maxQueueSize</code>，当一个请求到来时：<ul><li>如果线程池有空闲线程，直接处理请求；</li><li>如果线程池满但队列未满，请求进入等待队列，等待有空闲线程可用；</li><li>如果线程池满且队列也满，会立即拒绝该请求，拒绝后的处理方式：<ul><li>如果配置了 <code>fallback</code>，则执行 <code>fallback</code> 返回降级结果；</li><li>如果未配置 <code>fallback</code>，则对外会抛出异常 <code>HystrixRuntimeException</code>。</li></ul></li></ul></li><li>每个请求有独立的执行超时时间（默认 1 秒），即使请求进入线程池或队列，也可能因为执行时间过长而触发超时，Hystrix 会中断执行线程并调用 <code>fallback</code>(如果配置了)。</li><li>默认隔离策略就是线程池隔离。</li></ul></li><li>作用：<ul><li>不仅实现了限流控制，还实现了故障隔离：<ul><li>即便服务调用慢或挂掉，线程池线程阻塞，也不会影响主调用线程。</li><li>线程池提供队列和超时控制，可以防止调用链雪崩。</li><li>限流是通过线程池的大小来控制的。</li></ul></li></ul></li><li>特点：<ul><li>性能开销比信号量隔离大（线程上下文切换、线程池管理）。</li><li>自带超时机制，当线程池调用超时时自动中断线程，避免线程被长期占用。</li><li>Hystrix 线程池里的线程不是 Tomcat 的线程，而是 Hystrix 自己维护的线程池中的工作线程。</li><li>如果某个依赖（如远程服务调用）卡住了，最多会占用 Hystrix 自己维护的线程池中的工作线程，不会拖垮 Tomcat 的所有请求线程。</li></ul></li><li>优点：<ul><li>资源隔离：每个外部依赖都运行在自己的线程池中，即使某个线程池被耗尽，也不会影响其他外部依赖的调用。</li><li>超时控制：每个线程池内部的请求都可以配置执行超时时间，当调用超时时自动中断线程，避免线程被长期占用。</li><li>引入新依赖的安全性：即使新引入的外部依赖服务存在问题，也只会影响自身的线程池，不会拖累整个系统。</li><li>快速恢复能力：当故障依赖恢复时，只需清理或重建其线程池即可快速恢复调用，而不像 Tomcat 主线程池那样复杂。</li><li>可观测性与动态调整：线程池会统计成功、失败、拒绝、超时等指标，运维人员可以据此近实时地热修改外部依赖服务的配置，无需停机。</li><li>适应服务变化：当服务本身发生变更或调用特征变化时，线程池的健康状况能及时反映问题，方便动态调整配置。</li><li>支持异步调用：基于线程池的异步特性，可以在同步调用的基础上封装出一层异步调用能力。</li></ul></li><li>缺点：<ul><li>额外 CPU 开销：除了 Tomcat 的请求线程，还需要维护 Hystrix 自己的线程池，增加了额外的 CPU 开销。</li><li>线程上下文切换成本：每个命令（Command）都依赖独立线程执行，会带来排队、调度和线程上下文切换的开销。</li><li>调用延迟增加：多线程异步执行会引入一定的延时。<ul><li>Netflix API 每天通过 Hystrix 执行 10 亿次调用，每个服务实例有 40 个以上的线程池，每个线程池有 10 个左右的线程；</li><li>最后发现每次调用平均增加约 3ms 左右的延时，最高延时不超过 10ms；但相较于系统可用性和稳定性的提升，这个代价是可接受的。</li></ul></li></ul></li><li>适用场景：<ul><li>适用于可能出现网络延迟、阻塞的远程调用（如 HTTP / RPC / 数据库访问等）。</li></ul></li></ul><blockquote><p>线程池隔离的使用</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetBrandNameCommand</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Long brandId;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GetBrandNameCommand</span><span class="params">(Long brandId)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">"BrandServiceGroup"</span>))</span><br><span class="line">            .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="string">"GetBrandNameCommand"</span>))</span><br><span class="line">            <span class="comment">// 线程池的配置（默认使用线程池隔离策略）</span></span><br><span class="line">            .andThreadPoolPropertiesDefaults(HystrixThreadPoolProperties.Setter()</span><br><span class="line">                .withCoreSize(<span class="number">20</span>)</span><br><span class="line">                .withQueueSizeRejectionThreshold(<span class="number">20</span>)));</span><br><span class="line">        <span class="keyword">this</span>.brandId = brandId;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">// 执行远程调用的逻辑</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrandService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBrandName</span><span class="params">(Long brandId)</span> </span>{</span><br><span class="line">        GetBrandNameCommand brandCommand = <span class="keyword">new</span> GetBrandNameCommand(brandId);</span><br><span class="line">        <span class="keyword">return</span> brandCommand.execute();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="信号量隔离"><a href="#信号量隔离" class="headerlink" title="信号量隔离"></a>信号量隔离</h3><p>Hystrix 提供了 Semaphore（信号量）隔离技术，用于限制某个依赖服务的并发访问量，而不是依赖线程池和队列大小来限制流量。信号量机制主要用于限流与削峰，适合低延迟、非网络调用或对性能要求较高的场景，但它无法提供超时控制，也不能对高延迟的依赖进行隔离，如果底层调用发生严重延迟，业务调动线程会一直阻塞住。通过将 <code>execution.isolation.strategy=SEMAPHORE</code> 设置隔离策略为信号量隔离，Hystrix 就会使用信号量来代替线程池进行并发控制，一旦并发请求数超过设定阈值，新的请求会立即被拒绝，从而实现限流。</p><blockquote><p>信号量隔离的介绍</p></blockquote><ul><li>概述：<ul><li>不创建线程池，而是在调用的线程中执行，通过信号量限制并发请求数量。</li><li>当信号量不足（即超过并发请求数量限制）时，Hystrix 不会阻塞等待获取信号量，而是立即拒绝该请求，拒绝后的处理方式：<ul><li>如果配置了 <code>fallback</code>，则执行 <code>fallback</code> 返回降级结果；</li><li>如果未配置 <code>fallback</code>，则对外会抛出异常 <code>HystrixRuntimeException</code>。</li></ul></li><li>不是默认隔离策略，需要在配置里显式设置 <code>execution.isolation.strategy=SEMAPHORE</code>。</li></ul></li><li>作用：<ul><li>本质上是一种轻量级的限流机制，可以防止某个服务被过度并发调用导致资源耗尽。</li></ul></li><li>特点：<ul><li>不切换线程，开销小，延迟低。</li><li>只控制并发数量（即限流），没有线程隔离的保护作用，也没有超时机制。</li><li>如果服务调用阻塞（比如网络慢），主调用线程（如 Tomcat 线程）也会被阻塞。</li><li>信号量隔离本身没有等待队列，也没有阻塞等待获取信号量的逻辑。</li></ul></li><li>优点：<ul><li>性能开销小：不需要额外的线程池和线程切换，避免了排队、调度和上下文切换带来的成本。</li><li>实现简单：直接在调用线程内执行，依靠信号量计数来限制并发。</li><li>适合低延迟场景：对于本地方法调用或快速返回的依赖（如本地内存缓存访问），信号量隔离更高效。</li><li>即时拒绝：一旦并发请求超过信号量阈值，新的请求会立即被拒绝，从而快速保护系统。</li></ul></li><li>缺点：<ul><li>无法超时控制：调用仍运行在业务调用线程中，如果底层依赖延迟严重，业务调用线程会被一直阻塞，不能像线程池隔离一样强制超时。</li><li>缺乏真正的隔离：没有单独线程池，若依赖调用阻塞，会直接占用 Tomcat 线程，可能会拖慢整个系统。</li></ul></li><li>适用场景：<ul><li>适合非常轻量的服务调用，线程开销大于服务调用本身的场景。</li><li>仅适用于延迟可控、调用快速的依赖，不适合高延迟或不稳定的外部服务。</li><li>比如，内部调用 / 本地方法调用（例如本地内存缓存访问），因为这种调用一般快而可靠，不涉及任何网络请求，不需要超时机制，只需要并发保护。</li></ul></li></ul><blockquote><p>信号量隔离的使用</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetCityNameCommand</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Long cityId;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GetCityNameCommand</span><span class="params">(Long cityId)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">"GetCityNameGroup"</span>))</span><br><span class="line">            .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="string">"GetCityNameCommand"</span>))</span><br><span class="line">            <span class="comment">// 信号量隔离的配置</span></span><br><span class="line">            .andCommandPropertiesDefaults(HystrixCommandProperties.Setter()</span><br><span class="line">                .withExecutionIsolationStrategy(HystrixCommandProperties.ExecutionIsolationStrategy.SEMAPHORE)</span><br><span class="line">                .withExecutionIsolationSemaphoreMaxConcurrentRequests(<span class="number">20</span>)));</span><br><span class="line">        <span class="keyword">this</span>.cityId = cityId;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="keyword">return</span> LocationCache.getCityName(<span class="keyword">this</span>.cityId);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CityService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCityName</span><span class="params">(Long cityId)</span> </span>{</span><br><span class="line">        GetCityNameCommand CityCommand = <span class="keyword">new</span> GetCityNameCommand(cityId);</span><br><span class="line">        <span class="keyword">return</span> CityCommand.execute();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="Hystrix-熔断机制"><a href="#Hystrix-熔断机制" class="headerlink" title="Hystrix 熔断机制"></a>Hystrix 熔断机制</h2><h3 id="熔断机制的介绍"><a href="#熔断机制的介绍" class="headerlink" title="熔断机制的介绍"></a>熔断机制的介绍</h3><p>Hystrix 熔断机制的工作原理如下：</p><ul><li><p>(1) 请求量阈值判断</p><ul><li>断路器首先会统计一段时间内的请求情况，这个时间窗口由 <code>metrics.rollingStats.timeInMilliseconds</code>（默认 10 秒）控制。</li><li>在这个时间窗口内，若通过断路器的请求数未达到 <code>circuitBreaker.requestVolumeThreshold</code> 阀值（默认 20），则即使存在异常请求，也不会触发熔断判断。</li><li>换句话说，必须先有足够的请求量，断路器才会进行健康性评估。</li><li>举例：10 秒内经过断路器的请求总数只有 10 个，而阈值是 20，即使 10 个请求全部失败（100% 错误率），断路器也不会考虑熔断。</li></ul></li><li><p>(2) 错误比例阈值判断</p><ul><li>如果请求总量达到了阈值，断路器会计算失败请求的比例。</li><li>当失败比例 ≥ <code>circuitBreaker.errorThresholdPercentage</code> 阀值（默认 50%）时，断路器会从 Closed（关闭）状态转为 Open（打开）。</li><li>失败的请求包括：抛出异常、超时、线程池 / 信号量拒绝等情况。</li><li>举例：10 秒内共有 30 个请求，而阈值是 20，其中有 20 请求个失败，失败率 66% ≥ 50%，则断路器会被打开。</li></ul></li><li><p>(3) 断路器打开（Open）</p><ul><li>一旦断路器进入 Open（打开）状态，所有经过该断路器的请求都会被直接拒绝，不再调用后端逻辑，拒绝后的处理方式：<ul><li>如果配置了 <code>fallback</code>，则执行 <code>fallback</code> 返回降级结果；</li><li>如果未配置 <code>fallback</code>，则对外会抛出异常 <code>HystrixRuntimeException</code>。</li></ul></li></ul></li><li><p>(4) 断路器半开（Half-Open）</p><ul><li>断路器保持打开状态的时间由 <code>circuitBreaker.sleepWindowInMilliseconds</code>（默认 5 秒）决定。</li><li>在这个休眠时间结束后，断路器会进入 Half-Open（半开）状态，允许少量请求通过，作为探测。</li></ul></li><li><p>(5) 断路器关闭（Closed）</p><ul><li>如果探测请求执行成功，说明后端服务已恢复可用，断路器会从 Half-Open 状态转为 Closed 状态，恢复正常调用。</li><li>如果探测请求依旧失败，断路器会重新进入 Open 状态，继续熔断一段时间。</li></ul></li></ul><h3 id="熔断机制的配置"><a href="#熔断机制的配置" class="headerlink" title="熔断机制的配置"></a>熔断机制的配置</h3><div class="admonition warning"><p class="admonition-title">Hystrix 的默认熔断策略</p><p>在 10 秒内，如果请求数 ≥ 20 且错误率 ≥ 50%，断路器会打开；熔断 5 秒 后，断路器进入半开状态，尝试让少量请求通过，请求成功则断路器关闭（恢复正常），请求失败则断路器继续打开（再休眠 5 秒），如此往复。</p></div><ul><li><p><code>circuitBreaker.enabled</code></p><ul><li>作用：<ul><li>是否启用断路器：<ul><li><code>true</code>：启用。</li><li><code>false</code>：禁用（所有请求都会直接执行，不会触发熔断逻辑）。</li></ul></li></ul></li><li>默认值：<ul><li><code>true</code>。</li></ul></li><li>设置方法：<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HystrixCommandProperties.Setter().withCircuitBreakerEnabled(<span class="keyword">boolean</span> value);</span><br></pre></td></tr></tbody></table></figure></li></ul></li><li><p><code>metrics.rollingStats.timeInMilliseconds</code></p><ul><li>作用：<ul><li>设置统计滚动时间窗口的长度</li><li>举例：如果将它改为 20000 毫秒，那么 Hystrix 会基于过去 20 秒的请求统计数据来决定是否熔断。</li></ul></li><li>默认值：<ul><li>10000 毫秒（10 秒）。</li></ul></li><li>设置方法：<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HystrixCommandProperties.Setter().withMetricsRollingStatisticalWindowInMilliseconds(<span class="number">20000</span>);</span><br></pre></td></tr></tbody></table></figure></li></ul></li><li><p><code>circuitBreaker.requestVolumeThreshold</code></p><ul><li>作用：<ul><li>设置在滚动时间窗口（默认 10 秒）内，触发熔断所需的最小请求数。</li></ul></li><li>默认值：<ul><li>默认的请求数阀值是 20。</li></ul></li><li>说明：<ul><li>必须达到该请求数阈值，断路器才会开始计算错误比例。</li><li>如果请求数不足，即使全部请求失败，也不会触发熔断。</li></ul></li><li>设置方法：<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HystrixCommandProperties.Setter().withCircuitBreakerRequestVolumeThreshold(<span class="keyword">int</span> value);</span><br></pre></td></tr></tbody></table></figure></li></ul></li><li><p><code>circuitBreaker.errorThresholdPercentage</code></p><ul><li>作用：<ul><li>错误百分比阈值。</li></ul></li><li>默认值：<ul><li>50（即 50%）。</li></ul></li><li>说明：<ul><li>在滚动时间窗口内，若请求总数 ≥ <code>requestVolumeThreshold</code>，</li><li>且错误率 ≥ <code>errorThresholdPercentage</code>，</li><li>则断路器会从 Closed 状态转为 Open 状态。</li></ul></li><li>设置方法：<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HystrixCommandProperties.Setter().withCircuitBreakerErrorThresholdPercentage(<span class="keyword">int</span> value);</span><br></pre></td></tr></tbody></table></figure></li></ul></li><li><p><code>circuitBreaker.sleepWindowInMilliseconds</code></p><ul><li>作用：<ul><li>断路器打开（Open）后，休眠的时间窗口。</li></ul></li><li>默认值：<ul><li>默认休眠 5000 毫秒（5 秒）。</li></ul></li><li>说明：<ul><li>在该时间段内，请求会被快速失败（直接走 Fallback 逻辑）。</li><li>时间过后，断路器进入 Half-Open 状态，允许少量请求尝试调用后端服务。</li></ul></li><li>设置方法：<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HystrixCommandProperties.Setter().withCircuitBreakerSleepWindowInMilliseconds(<span class="keyword">int</span> value);</span><br></pre></td></tr></tbody></table></figure></li></ul></li><li><p><code>circuitBreaker.forceOpen</code></p><ul><li>作用：<ul><li>强制打开断路器。</li></ul></li><li>默认值：<ul><li><code>false</code>。</li></ul></li><li>说明：<ul><li>设置为 <code>true</code> 后，断路器会一直处于 Open 状态，所有请求直接走 Fallback 逻辑，相当于手动熔断。</li></ul></li><li>设置方法：<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HystrixCommandProperties.Setter().withCircuitBreakerForceOpen(<span class="keyword">boolean</span> value);</span><br></pre></td></tr></tbody></table></figure></li></ul></li><li><p><code>circuitBreaker.forceClosed</code></p><ul><li>作用：<ul><li>强制关闭断路器。</li></ul></li><li>默认值：<ul><li><code>false</code>。</li></ul></li><li>说明：<ul><li>设置为 <code>true</code> 后，断路器会忽略所有错误统计，始终允许请求通过，相当于手动关闭熔断。</li></ul></li><li>设置方法：<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HystrixCommandProperties.Setter().withCircuitBreakerForceClosed(<span class="keyword">boolean</span> value);</span><br></pre></td></tr></tbody></table></figure></li></ul></li></ul><h3 id="熔断机制的使用"><a href="#熔断机制的使用" class="headerlink" title="熔断机制的使用"></a>熔断机制的使用</h3><p>Hystrix 熔断机制的使用（基于继承类）：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetBrandNameCommand</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Long brandId;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GetBrandNameCommand</span><span class="params">(Long brandId)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">"BrandServiceGroup"</span>))</span><br><span class="line">            .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="string">"GetBrandNameCommand"</span>))</span><br><span class="line">            <span class="comment">// 熔断机制的配置</span></span><br><span class="line">            .andCommandPropertiesDefaults(HystrixCommandProperties.Setter()</span><br><span class="line">                .withCircuitBreakerRequestVolumeThreshold(<span class="number">15</span>)</span><br><span class="line">                .withCircuitBreakerErrorThresholdPercentage(<span class="number">40</span>)</span><br><span class="line">                .withCircuitBreakerSleepWindowInMilliseconds(<span class="number">6000</span>)));</span><br><span class="line">        <span class="keyword">this</span>.brandId = brandId;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">// 直接抛出异常（模拟远程调用失败），触发熔断机制</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 降级逻辑</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getFallback</span><span class="params">()</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"==&gt; 触发降级机制，从本地缓存获取品牌数据, brandId = "</span> + <span class="keyword">this</span>.brandId);</span><br><span class="line">        <span class="comment">// 从本地缓存获取数据</span></span><br><span class="line">        <span class="keyword">return</span> BrandCache.getBrandName(<span class="keyword">this</span>.brandId);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrandService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBrandName</span><span class="params">(Long brandId)</span> </span>{</span><br><span class="line">        GetBrandNameCommand brandCommand = <span class="keyword">new</span> GetBrandNameCommand(brandId);</span><br><span class="line">        <span class="keyword">return</span> brandCommand.execute();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Hystrix 熔断机制的使用（基于注解）：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeptService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果调用失败（超时、异常等），会自动调用 fallback 方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@HystrixCommand(</span></span><br><span class="line"><span class="meta">        commandKey = "getDeptCommand",</span></span><br><span class="line"><span class="meta">        groupKey = "DeptServiceGroup",</span></span><br><span class="line"><span class="meta">        fallbackMethod = "getDeptFallback",</span></span><br><span class="line"><span class="meta">        commandProperties = {</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold", value = "15"),</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = "circuitBreaker.errorThresholdPercentage", value = "40"),</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = "circuitBreaker.sleepWindowInMilliseconds", value = "6000")</span></span><br><span class="line"><span class="meta">        }</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDept</span><span class="params">(Long deptId)</span> </span>{</span><br><span class="line">        <span class="comment">// 直接抛出异常（模拟远程调用失败），触发熔断机制</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 降级逻辑（fallback 方法）</span></span><br><span class="line"><span class="comment">     * 1. fallback 方法的名称要与 <span class="doctag">@HystrixCommand</span> 的 fallbackMethod 一致</span></span><br><span class="line"><span class="comment">     * 2. fallback 方法的参数列表必须与原方法完全相同</span></span><br><span class="line"><span class="comment">     * 3. fallback 方法的返回值类型也必须与原方法相同</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDeptFallback</span><span class="params">(Long deptId)</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"==&gt; 触发降级机制，从本地缓存获取部门数据, deptId = "</span> + <span class="keyword">this</span>.deptId);</span><br><span class="line">        <span class="comment">// 从本地缓存获取数据</span></span><br><span class="line">        <span class="keyword">return</span> DeptCache.getDeptName(<span class="keyword">this</span>.deptId);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="熔断机制的注意事项"><a href="#熔断机制的注意事项" class="headerlink" title="熔断机制的注意事项"></a>熔断机制的注意事项</h3><blockquote><p>为什么没有 fallback 仍可能出现 “服务雪崩”</p></blockquote><p>即使断路器打开，如果没有 <code>fallback</code>，快速失败的请求就会直接抛异常给调用方：</p><ul><li>如果调用方是用户请求（如 Web 请求）：<ul><li>每个请求直接失败，会让用户感知到服务不可用。</li></ul></li><li>如果调用方是另一个服务（服务间调用）：<ul><li>异常被抛回去，服务调用方也可能因为未处理异常或线程被占用而失败。</li><li>当大量调用同时失败时，就可能形成连锁失败，类似 “雪崩效应”。</li></ul></li></ul><p>所以，断路器 + <code>fallback</code> 才能有效防止 “服务雪崩”：</p><ul><li>断路器快速失败 → 保护资源</li><li><code>fallback</code> 提供兜底处理逻辑 → 系统仍然可用</li></ul><blockquote><p>举例说明</p></blockquote><p>假设服务 A 调用服务 B，但服务 B 出现故障，服务 A 配置了 Hystrix：</p><ul><li>A 有 <code>fallback</code> → B 不可用时，A 调用 <code>fallback</code> 返回默认值，A 仍然可用。</li><li>A 无 <code>fallback</code> → B 不可用时，A 抛出异常，A 的线程被占用，更多请求堆积 → A 也可能挂掉 → 连锁失败 → 服务雪崩。</li></ul><div class="admonition note"><p class="admonition-title">总结</p><p>熔断机制可以防止对下游服务（服务提供方）的直接压力，但没有 <code>fallback</code> 时，上游服务（服务调用方）仍可能因异常堆积而失败，形成级联故障，所以单靠熔断机制不能完全避免雪崩，必须配合 <code>fallback</code> 才可以。</p></div><h2 id="Hystrix-降级机制"><a href="#Hystrix-降级机制" class="headerlink" title="Hystrix 降级机制"></a>Hystrix 降级机制</h2><h3 id="降级机制的介绍"><a href="#降级机制的介绍" class="headerlink" title="降级机制的介绍"></a>降级机制的介绍</h3><p>在以下几种情况下，Hystrix 会触发 fallback 降级机制：HystrixCommand 的 <code>run()</code> 方法或 HystrixObservableCommand 的 <code>construct()</code> 方法抛出异常、断路器打开、线程池 / 队列 / 信号量已满、命令（Command）执行超时。一般来说，fallback 建议返回一些默认值，比如默认结果或本地内存缓存数据，避免再次发起网络调用；如果确实需要网络调用，最好再封装到一个单独的 HystrixCommand 中，以保证资源隔离。在 HystrixCommand 中，可以通过重写 <code>getFallback()</code> 方法来提供降级逻辑；在 HystrixObservableCommand 中，可以通过实现 <code>resumeWithFallback()</code> 方法并返回一个 <code>Observable</code> 来提供降级结果。如果 fallback 成功返回结果，那么 Hystrix 会将该结果返回给调用方。对于 HystrixCommand，最终会包装成一个 <code>Observable</code> 发射结果；对于 HystrixObservableCommand，则直接返回原始的 <code>Observable</code>。</p><hr><p>如果没有实现 fallback，或者 fallback 本身抛出了异常，Hystrix 也会返回一个 <code>Observable</code>，但不会有任何数据发射，不同的执行方式在调用时的表现不同：</p><ul><li>对于 <code>execute()</code>，会直接抛出异常；</li><li>对于 <code>queue()</code>，会返回一个 <code>Future</code>，在调用 <code>get()</code> 时抛出异常；</li><li>对于 <code>observe()</code>，会返回一个 <code>Observable</code>，但在订阅时会触发调用者的 <code>onError()</code>；</li><li>对于 <code>toObservable()</code>，同样会返回一个 <code>Observable</code>，在订阅时触发调用者的 <code>onError()</code>。</li></ul><h3 id="降级机制的配置"><a href="#降级机制的配置" class="headerlink" title="降级机制的配置"></a>降级机制的配置</h3><p>Hystrix 为降级机制提供了配置参数 <code>fallback.isolation.semaphore.maxConcurrentRequests</code>，为什么需要这个参数呢？因为 Hystrix 的降级逻辑（fallback）本身可能也会访问本地资源（比如访问缓存、查询数据库、读文件等），如果没有访问限制，可能在高并发场景下将这些资源也压垮。该参数的核心作用如下：</p><ul><li>用于限制 fallback 方法（降级逻辑）同时能被多少个线程并发执行，默认值是 10。</li><li>fallback 方法默认是和调用线程在同一个线程里执行的，通过信号量隔离来控制并发数，而不是运行在独立的线程池。</li><li>当同时执行 fallback 方法的请求数（线程数）超过上限，新的请求不会进入 fallback 方法，而是会被直接拒绝并抛出异常 <code>HystrixRuntimeException</code>。</li><li>避免主逻辑挂了后，所有流量瞬间打到 fallback 方法，导致 fallback 方法自身也被压垮。</li><li>目的是避免因为大量请求失败时，fallback 方法被并发挤爆。</li></ul><h3 id="降级机制的使用"><a href="#降级机制的使用" class="headerlink" title="降级机制的使用"></a>降级机制的使用</h3><p>Hystrix 降级机制的使用（基于继承类）：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetBrandNameCommand</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Long brandId;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GetBrandNameCommand</span><span class="params">(Long brandId)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">"BrandServiceGroup"</span>))</span><br><span class="line">            .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="string">"GetBrandNameCommand"</span>))</span><br><span class="line">            <span class="comment">// 降级机制的配置</span></span><br><span class="line">            .andCommandPropertiesDefaults(HystrixCommandProperties.Setter()</span><br><span class="line">                .withFallbackIsolationSemaphoreMaxConcurrentRequests(<span class="number">10</span>)));</span><br><span class="line">        <span class="keyword">this</span>.brandId = brandId;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">// 直接抛出异常（模拟远程调用失败），触发降级机制</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 降级逻辑</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getFallback</span><span class="params">()</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"==&gt; 触发降级机制，从本地缓存获取品牌数据, brandId = "</span> + <span class="keyword">this</span>.brandId);</span><br><span class="line">        <span class="comment">// 从本地缓存获取数据</span></span><br><span class="line">        <span class="keyword">return</span> BrandCache.getBrandName(<span class="keyword">this</span>.brandId);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrandService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBrandName</span><span class="params">(Long brandId)</span> </span>{</span><br><span class="line">        GetBrandNameCommand brandCommand = <span class="keyword">new</span> GetBrandNameCommand(brandId);</span><br><span class="line">        <span class="keyword">return</span> brandCommand.execute();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Hystrix 降级机制的使用（基于注解）：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeptService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果调用失败（超时、异常等），会自动调用 fallback 方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@HystrixCommand(</span></span><br><span class="line"><span class="meta">        commandKey = "getDeptCommand",</span></span><br><span class="line"><span class="meta">        groupKey = "DeptServiceGroup",</span></span><br><span class="line"><span class="meta">        fallbackMethod = "getDeptFallback",</span></span><br><span class="line"><span class="meta">        commandProperties = {</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = "fallback.isolation.semaphore.maxConcurrentRequests", value = "10")</span></span><br><span class="line"><span class="meta">        }</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDept</span><span class="params">(Long deptId)</span> </span>{</span><br><span class="line">        <span class="comment">// 直接抛出异常（模拟远程调用失败），触发降级机制</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 降级逻辑（fallback 方法）</span></span><br><span class="line"><span class="comment">     * 1. fallback 方法的名称要与 <span class="doctag">@HystrixCommand</span> 的 fallbackMethod 一致</span></span><br><span class="line"><span class="comment">     * 2. fallback 方法的参数列表必须与原方法完全相同</span></span><br><span class="line"><span class="comment">     * 3. fallback 方法的返回值类型也必须与原方法相同</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDeptFallback</span><span class="params">(Long deptId)</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"==&gt; 触发降级机制，从本地缓存获取部门数据, deptId = "</span> + <span class="keyword">this</span>.deptId);</span><br><span class="line">        <span class="comment">// 从本地缓存获取数据</span></span><br><span class="line">        <span class="keyword">return</span> DeptCache.getDeptName(<span class="keyword">this</span>.deptId);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="Hystrix-超时机制"><a href="#Hystrix-超时机制" class="headerlink" title="Hystrix 超时机制"></a>Hystrix 超时机制</h2><h3 id="超时机制的介绍"><a href="#超时机制的介绍" class="headerlink" title="超时机制的介绍"></a>超时机制的介绍</h3><p>在 Hystrix 中，如果 <code>HystrixCommand.run()</code> 或 <code>HystrixObservableCommand.construct()</code> 的执行时间超过了配置的超时时长，那么命令（Command）所在的主调用线程会抛出一个 <code>TimeoutException</code>，并触发 <code>fallback</code> 降级逻辑，此时不会再关心 <code>run()</code> 或 <code>construct()</code> 的返回值。<strong>需要特别注意的是，Hystrix 并不能真正中断一个正在执行且已经超时的依赖调用线程，该线程仍然可能因为长时间阻塞而占用线程池资源，从而导致线程池被耗尽，即使此时新请求已经被限流或拒绝；这是因为 Java 线程的中断机制是协作式的，只能发出中断信号，而不能强制终止线程</strong>。相反，如果执行没有超时，那么依赖调用的结果会被正常返回，同时 Hystrix 会进行相关的日志记录和指标统计。</p><ul><li><p>作用对象：</p><ul><li>针对每个 <code>HystrixCommand</code> 的 <code>run()</code> 方法执行设置超时时间。</li><li><code>HystrixObservableCommand</code> 也支持超时机制，但不直接作用于 <code>construct()</code> 方法本身：<ul><li>Observable 本身返回一个 RxJava Observable；</li><li>超时需要依赖 <code>timeout</code> 操作符或者 Hystrix 提供的 Observable 封装的超时机制；</li><li>Hystrix 会在 Observable 执行过程中监控超时，并在超时后触发 <code>fallback</code>。</li></ul></li></ul></li><li><p>配置方式：</p><ul><li>编码方式：<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HystrixCommandProperties.Setter().withExecutionIsolationThreadTimeoutInMilliseconds(<span class="number">2000</span>);</span><br></pre></td></tr></tbody></table></figure></li><li>注解方式：<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand(</span></span><br><span class="line"><span class="meta">    commandProperties = {</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds", value = "2000")</span></span><br><span class="line"><span class="meta">    }</span></span><br><span class="line"><span class="meta">)</span></span><br></pre></td></tr></tbody></table></figure></li></ul></li><li><p>超时行为：</p><ul><li>当命令（Command）执行时间超过配置的超时时间（如 2000ms）：<ul><li>如果使用线程池隔离，执行线程会被标记为超时，但线程仍然可能继续运行，Hystrix 会执行 Fallback 逻辑（如果配置了）或抛出异常。</li><li>如果使用信号量隔离，超时机制不会生效，因为信号量隔离本身没有超时机制，超时需要由调用方自己控制。</li></ul></li></ul></li><li><p>作用与意义：</p><ul><li>避免单个请求长时间占用线程池资源。</li><li>配合线程池隔离使用，可防止故障蔓延。</li></ul></li></ul><div class="admonition warning"><p class="admonition-title">特别注意</p><p>Hystrix 的超时机制通常是配合线程池隔离策略一起使用的，而信号量隔离策略是没有超时机制的。</p></div><h3 id="超时机制的使用"><a href="#超时机制的使用" class="headerlink" title="超时机制的使用"></a>超时机制的使用</h3><p>Hystrix 超时机制的使用（基于继承类）：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetBrandNameCommand</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Long brandId;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GetBrandNameCommand</span><span class="params">(Long brandId)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">"BrandServiceGroup"</span>))</span><br><span class="line">            .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="string">"GetBrandNameCommand"</span>))</span><br><span class="line">            <span class="comment">// 线程池的配置（默认使用线程池隔离策略）</span></span><br><span class="line">            .andThreadPoolPropertiesDefaults(HystrixThreadPoolProperties.Setter()</span><br><span class="line">                .withCoreSize(<span class="number">10</span>)</span><br><span class="line">                .withMaxQueueSize(<span class="number">10</span>)</span><br><span class="line">                .withQueueSizeRejectionThreshold(<span class="number">8</span>))</span><br><span class="line">            .andCommandPropertiesDefaults(HystrixCommandProperties.Setter()</span><br><span class="line">                <span class="comment">// 降级机制的配置</span></span><br><span class="line">                .withFallbackIsolationSemaphoreMaxConcurrentRequests(<span class="number">10</span>)</span><br><span class="line">                <span class="comment">// 超时机制配置</span></span><br><span class="line">                .withExecutionTimeoutInMilliseconds(<span class="number">3000</span>)));</span><br><span class="line">        <span class="keyword">this</span>.brandId = brandId;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">// 模拟远程调用的耗时操作，触发超时机制</span></span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 降级逻辑</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getFallback</span><span class="params">()</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"==&gt; 触发降级机制，从本地缓存获取品牌数据, brandId = "</span> + <span class="keyword">this</span>.brandId);</span><br><span class="line">        <span class="comment">// 从本地缓存获取数据</span></span><br><span class="line">        <span class="keyword">return</span> BrandCache.getBrandName(<span class="keyword">this</span>.brandId);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrandService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBrandName</span><span class="params">(Long brandId)</span> </span>{</span><br><span class="line">        GetBrandNameCommand brandCommand = <span class="keyword">new</span> GetBrandNameCommand(brandId);</span><br><span class="line">        <span class="keyword">return</span> brandCommand.execute();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Hystrix 超时机制的使用（基于注解）：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeptService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果调用失败（超时、异常等），会自动调用 fallback 方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@HystrixCommand(</span></span><br><span class="line"><span class="meta">        commandKey = "getDeptCommand",</span></span><br><span class="line"><span class="meta">        groupKey = "DeptServiceGroup",</span></span><br><span class="line"><span class="meta">        fallbackMethod = "getDeptFallback",</span></span><br><span class="line"><span class="meta">        commandProperties = {</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds", value = "3000"),</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = "fallback.isolation.semaphore.maxConcurrentRequests", value = "10")</span></span><br><span class="line"><span class="meta">        },</span></span><br><span class="line"><span class="meta">        threadPoolProperties = {</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = "coreSize", value = "10"),</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = "maxQueueSize", value = "10"),</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = "queueSizeRejectionThreshold", value = "8")</span></span><br><span class="line"><span class="meta">        }</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDept</span><span class="params">(Long deptId)</span> </span>{</span><br><span class="line">        <span class="comment">// 模拟远程调用的耗时操作，触发超时机制</span></span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 降级逻辑（fallback 方法）</span></span><br><span class="line"><span class="comment">     * 1. fallback 方法的名称要与 <span class="doctag">@HystrixCommand</span> 的 fallbackMethod 一致</span></span><br><span class="line"><span class="comment">     * 2. fallback 方法的参数列表必须与原方法完全相同</span></span><br><span class="line"><span class="comment">     * 3. fallback 方法的返回值类型也必须与原方法相同</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDeptFallback</span><span class="params">(Long deptId)</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"==&gt; 触发降级机制，从本地缓存获取部门数据, deptId = "</span> + <span class="keyword">this</span>.deptId);</span><br><span class="line">        <span class="comment">// 从本地缓存获取数据</span></span><br><span class="line">        <span class="keyword">return</span> DeptCache.getDeptName(<span class="keyword">this</span>.deptId);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="超时机制的工作原理"><a href="#超时机制的工作原理" class="headerlink" title="超时机制的工作原理"></a>超时机制的工作原理</h3><p>Hystrix 的超时机制是通过 <code>HystrixTimer</code> 定时器 + <code>Future.cancel(true)</code> 实现的。</p><ul><li><strong>整体思路</strong><ul><li> Hystrix 会把 <code>HystrixCommand.run()</code> 或者 <code>HystrixObservableCommand.construct()</code> 的逻辑封装到一个 <code>FutureTask</code>，并交给线程池或信号量执行；</li><li>同时，Hystrix 内部有一个 <code>HystrixTimer</code>（基于 <code>ScheduledThreadPoolExecutor</code>），它会在超时时间到达时触发检查；</li><li>如果命令还没执行完，就会触发超时逻辑：抛出 <code>TimeoutException</code>，标记命令执行超时，并尝试调用 <code>Thread.interrupt()</code> 来中断执行线程；</li><li>最终，调用方得到的就是一个超时异常，Hystrix 会进入 fallback 逻辑（如果有配置）。</li></ul></li><li><strong>执行流程</strong><ul><li><ol><li>提交任务：<code>HystrixCommand.execute()</code> → <code>queue()</code> → <code>toObservable()</code> → <code>FutureTask</code> 提交到线程池中执行。</li></ol></li><li><ol start="2"><li>启动定时器：同时在 <code>HystrixTimer</code> 中注册一个定时任务，延迟时间 = 配置的超时时长。</li></ol></li><li><ol start="3"><li>定时器检查：如果到时间任务还未完成，定时器会：</li></ol><ul><li>标记命令为超时；</li><li>调用 <code>Future.cancel(true)</code> 来触发执行线程的 <code>interrupt()</code>；</li><li>向调用方返回 <code>TimeoutException</code>。</li></ul></li><li><ol start="4"><li>降级处理：Hystrix 检测到超时异常后，会尝试调用 <code>getFallback()</code> 或 <code>resumeWithFallback()</code> 来提供降级结果。</li></ol></li></ul></li><li><strong>注意事项</strong><ul><li>不能强制杀线程：<ul><li>Hystrix 的 <code>interrupt()</code> 只是对执行线程打个中断标记，无法强制中断正在执行的线程，如果业务代码没响应中断，线程依旧会继续执行，直到自然结束为止。</li></ul></li><li>线程池耗尽风险：<ul><li>如果依赖服务卡死，虽然 Hystrix 提前超时返回，但底层的线程仍然阻塞，可能导致线程池被耗尽。</li></ul></li><li>配置参数：<ul><li>超时时间由 <code>execution.isolation.thread.timeoutInMilliseconds</code> 控制，默认 1000ms。</li></ul></li></ul></li></ul><h2 id="Hystrix-异常机制"><a href="#Hystrix-异常机制" class="headerlink" title="Hystrix 异常机制"></a>Hystrix 异常机制</h2><h3 id="5-种会被-fallback-截获的情况"><a href="#5-种会被-fallback-截获的情况" class="headerlink" title="5 种会被 fallback 截获的情况"></a>5 种会被 fallback 截获的情况</h3><p>Hystrix 的异常处理中，有 5 种出错的情况会被 fallback 所截获，从而触发 fallback，这些情况分别是：</p><p><img data-src="../../../asset/2020/04/hystrix-handle-fallback.png" alt="hystrix-handle-fallback"></p><p>有一种异常是不会触发 fallback 的，且不会被计数进入熔断，它是 <code>BAD_REQUEST</code>，会抛出 <code>HystrixBadRequestException</code>，这种异常一般对应的是由非法参数或者一些非系统异常引起的，对于这种异常可以根据响应创建对应的异常进行异常封装或者直接处理。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * HystrixBadRequestException 不会触发 fallback</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/user")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/getUser")</span></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = "defaultUser")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUser</span><span class="params">(String userName)</span> </span>{</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> HystrixBadRequestException(<span class="string">"HystrixBadRequestException Error"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">defaultUser</span><span class="params">(String userName)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"the user not exist in this system"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="获取-fallback-里的异常信息"><a href="#获取-fallback-里的异常信息" class="headerlink" title="获取 fallback 里的异常信息"></a>获取 fallback 里的异常信息</h3><p>若想在 <code>@HystrixCommand</code> 里获取异常信息，只需要在方法内指定 <code>Throwable</code> 参数；</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/user")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/getUser")</span></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = "defaultUser")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUser</span><span class="params">(String userName)</span> </span>{</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"the user not exist"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">defaultUser</span><span class="params">(String userName, Throwable throwable)</span> </span>{</span><br><span class="line">        System.out.println(throwable.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"the user not exist in this system"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>或者继承 <code>@HystrixCommand</code> 的命令，通过方法来获取异常：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/getPSFallbackOtherExpcetion")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">pSFallbackOtherExpcetion</span><span class="params">()</span></span>{</span><br><span class="line">    	String result = <span class="keyword">new</span> PSFallbackOtherExpcetion().execute();</span><br><span class="line">    	<span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 继承HystrixCommand</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PSFallbackOtherExpcetion</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt;</span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PSFallbackOtherExpcetion</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(HystrixCommandGroupKey.Factory.asKey(<span class="string">"GroupOE"</span>));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    	<span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"this command will trigger fallback"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getFallback</span><span class="params">()</span> </span>{</span><br><span class="line">        System.out.println(getFailedExecutionException().getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"invoke PSFallbackOtherExpcetion fallback method"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>在 Feign Client 中可以用 <code>ErrorDecoder</code> 实现对这类异常的包装，在实际的使用中，很多时候调用接口会抛出这些 400-500 之间的错误，此时可以通过它进行封装：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignErrorDecoder</span> <span class="keyword">implements</span> <span class="title">feign</span>.<span class="title">codec</span>.<span class="title">ErrorDecoder</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Exception <span class="title">decode</span><span class="params">(String methodKey, Response response)</span> </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">if</span> (response.status() &gt;= <span class="number">400</span> &amp;&amp; response.status() &lt;= <span class="number">499</span>) {</span><br><span class="line">                String error = Util.toString(response.body().asReader());</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> HystrixBadRequestException(error);</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            System.out.println(e);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> feign.FeignException.errorStatus(methodKey, response);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="fallback-会抛出异常的情况"><a href="#fallback-会抛出异常的情况" class="headerlink" title="fallback 会抛出异常的情况"></a>fallback 会抛出异常的情况</h3><p><img data-src="../../../asset/2020/04/fallback-throw-exception.png" alt="fallback-throw-exception"></p><h2 id="Hystrix-线程池配置"><a href="#Hystrix-线程池配置" class="headerlink" title="Hystrix 线程池配置"></a>Hystrix 线程池配置</h2><h3 id="默认的线程池规则"><a href="#默认的线程池规则" class="headerlink" title="默认的线程池规则"></a>默认的线程池规则</h3><ul><li><p>(1) Hystrix 线程池的唯一标识是 <code>threadPoolKey</code></p><ul><li>如果 HystrixCommand / HystrixObservableCommand 没有显式指定 <code>threadPoolKey</code>：<ul><li>同一个类的所有方法默认使用 HystrixCommand / HystrixObservableCommand 的 <code>groupKey</code> 所对应的线程池。</li><li><code>groupKey</code> 默认是方法所在类名，即同一个类里的所有方法默认共享同一个线程池。</li></ul></li></ul></li><li><p>(2) 独立线程池的情况</p><ul><li>如果希望同一个类里的每个方法都使用独立的线程池，需要显式指定不同的 <code>threadPoolKey</code>，比如：<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand(threadPoolKey = "getUserThreadPool", fallbackMethod = "fallback1")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getUser</span><span class="params">()</span> </span>{ ... }</span><br><span class="line"></span><br><span class="line"><span class="meta">@HystrixCommand(threadPoolKey = "getOrderThreadPool", fallbackMethod = "fallback2")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getOrder</span><span class="params">()</span> </span>{ ... }</span><br></pre></td></tr></tbody></table></figure></li></ul></li></ul><h3 id="线程池的核心参数"><a href="#线程池的核心参数" class="headerlink" title="线程池的核心参数"></a>线程池的核心参数</h3><table><thead><tr><th>参数</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>coreSize</code></td><td><code>10</code></td><td>线程池核心线程数（最大并发线程数）。</td></tr><tr><td><code>maxQueueSize</code></td><td><code>-1</code></td><td>等待队列长度，-1 表示不使用队列，线程满直接拒绝。</td></tr><tr><td><code>queueSizeRejectionThreshold</code></td><td><code>5</code></td><td>当使用队列时，超过该阈值直接拒绝。因为 <code>maxQueueSize</code> 不允许热修改，因此提供这个可以热修改的参数，用于动态控制队列的最大大小。</td></tr><tr><td><code>keepAliveTimeMinutes</code></td><td><code>1</code></td><td>允许非核心线程空闲存活时间（分钟）。</td></tr><tr><td><code>allowMaximumSizeToDivergeFromCoreSize</code></td><td><code>false</code></td><td>是否允许 <code>maximumSize</code> 超过 <code>coreSize</code>。</td></tr><tr><td><code>maximumSize</code></td><td><code>10</code></td><td>最大线程数（当 <code>allowMaximumSizeToDivergeFromCoreSize=true</code> 时生效）。</td></tr><tr><td><code>executionTimeoutInMilliseconds</code></td><td><code>1000</code></td><td>任务执行的超时时间（毫秒），可通过 <code>withExecutionTimeoutInMilliseconds()</code> 设置。建议设置大一些，否则任务在队列中等待过久可能会直接超时，无法进入线程池执行。</td></tr></tbody></table><div class="admonition warning"><p class="admonition-title">特别注意</p><p>在使用 Hystrix 的线程池隔离时，线程池的等待队列默认是关闭的，只有手动指定等待队列的长度（大小）后才会启用等待队列。</p></div><h3 id="线程池隔离的实现细节"><a href="#线程池隔离的实现细节" class="headerlink" title="线程池隔离的实现细节"></a>线程池隔离的实现细节</h3><p>在 Hystrix 的线程池隔离中，HystrixCommand 的 <code>execute()</code> 的底层其实是把命令（Command）封装成一个 <code>FutureTask</code> 并提交到线程池（<code>ThreadPoolExecutor</code>）去执行。而 Java 的线程池执行规则（<code>ThreadPoolExecutor.execute()</code>）决定了 Hystrix 的任务是直接交给空闲线程执行还是先放入队列，具体逻辑是这样的：</p><ul><li>(1) 如果线程池中正在运行的线程数 &lt; <code>corePoolSize</code><ul><li> 会直接创建一个新线程来执行任务（即使有空闲线程也不会复用）。</li></ul></li><li>(2) 如果线程数 ≥ <code>corePoolSize</code><ul><li> 任务会尝试进入队列（Hystrix 默认用的是 <code>SynchronousQueue</code> 或 <code>BlockingQueue</code>）。</li></ul></li><li>(3) 如果队列已满且线程数 &lt; <code>maximumPoolSize</code><ul><li> 会再创建新线程来执行任务。</li></ul></li><li>(4) 如果队列已满且线程数 ≥ <code>maximumPoolSize</code><ul><li> 任务会被拒绝，抛出 <code>HystrixRuntimeException</code>，在 Hystrix 中就会触发 fallback。</li></ul></li></ul><h3 id="线程池-服务-接口划分"><a href="#线程池-服务-接口划分" class="headerlink" title="线程池 + 服务 + 接口划分"></a>线程池 + 服务 + 接口划分</h3><blockquote><p>HystrixCommand 的 <code>commandKey</code>、<code>groupKey</code>、<code>threadPoolKey</code> 的区别：</p></blockquote><ul><li><p><code>commandKey</code></p><ul><li>定义：<ul><li>代表某一个具体的命令（Command），是命令的唯一标识，一般对应依赖服务的某个接口调用。</li></ul></li><li>作用：<ul><li>熔断、降级、限流的最小单位，比如：断路器的状态统计是基于 <code>commandKey</code> 的。</li><li>在 <code>groupKey</code> 下进一步细分，可以在 Dashboard 监控中，看到每个 Command 的请求数、错误率、超时、熔断状态等统计信息。</li></ul></li><li>默认值：<ul><li>如果不显式指定 <code>commandKey</code>，其默认值有两种情况：<ul><li>继承方式：如果在继承 HystrixCommand 类时，在构造函数里没有显式指定 HystrixCommandKey，那么 <code>commandKey</code> 默认是继承类的类名。</li><li>注解方式：如果在使用 <code>@HystrixCommand</code> 注解时，未显式指定 <code>commandKey</code>，那么 <code>commandKey</code> 默认是方法名。</li></ul></li></ul></li><li>典型使用：<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HystrixCommandKey.Factory.asKey(<span class="string">"GetOrderDetail"</span>)</span><br></pre></td></tr></tbody></table></figure></li></ul></li><li><p><code>groupKey</code></p><ul><li>定义：<ul><li>代表一类命令（Command）的逻辑分组，即将一组相关的命令归类，一般对应某个依赖服务。</li></ul></li><li>作用：<ul><li>Dashboard、Metrics 中的监控图表、请求统计，都是按 <code>groupKey</code> 进行聚合显示。</li></ul></li><li>默认值：<ul><li>如果不显式指定 <code>threadPoolKey</code>，则 <code>groupKey</code> 也会作为默认的 <code>threadPoolKey</code> 来使用。</li><li>如果不显式指定 <code>groupKey</code>，则 <code>groupKey</code> 默认是方法所在类名，即同一个类里的所有方法默认共享同一个线程池。</li></ul></li><li>推荐用法：<ul><li>按依赖服务的维度来划分 Group，比如 <code>OrderServiceGroup</code>。</li><li>一个依赖服务可能暴露多个接口，每个接口对应一个 <code>commandKey</code>，但默认会落在 Group 级别的同一个线程池里。</li></ul></li><li>典型使用：<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HystrixCommandGroupKey.Factory.asKey(<span class="string">"OrderServiceGroup"</span>)</span><br></pre></td></tr></tbody></table></figure></li></ul></li><li><p><code>threadPoolKey</code></p><ul><li>定义：<ul><li>代表一个独立的 HystrixThreadPool（线程池）。</li></ul></li><li>作用：<ul><li>线程池隔离：指定命令（Command）使用哪个线程池。</li><li>资源隔离粒度：同一个 <code>threadPoolKey</code> 下的命令共享同一个线程池，彼此之间可能会互相影响；不同的 <code>threadPoolKey</code> 对应不同的线程池，互不干扰。</li></ul></li><li>默认值：<ul><li>如果没有显式指定 <code>threadPoolKey</code>，则默认会使用 <code>groupKey</code> 作为 <code>threadPoolKey</code>。</li></ul></li><li>推荐用法：<ul><li>共享线程池：默认情况下，同一个依赖服务下的所有接口（同一个 <code>groupKey</code> 下的多个 <code>commandKey</code>）共享同一个线程池。</li><li>独立线程池：如果一个依赖服务下某些接口的流量或耗时差异很大，可以给它们单独定义 <code>threadPoolKey</code>，即使用单独的线程池，避免 “拖垮” 其他接口的调用。</li></ul></li><li>典型使用：<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HystrixThreadPoolKey.Factory.asKey(<span class="string">"OrderServiceThreadPool"</span>)</span><br></pre></td></tr></tbody></table></figure></li></ul></li></ul><blockquote><p>HystrixCommand 的 <code>commandKey</code>、<code>groupKey</code>、<code>threadPoolKey</code> 的层级关系：</p></blockquote><ul><li><code>commandKey</code>：一个命令的唯一标识 = 一个接口。</li><li><code>groupKey</code>：多个接口命令的逻辑集合 = 一个服务。</li><li><code>threadPoolKey</code>：为一个或一组命令提供资源隔离 = 一个线程池。</li></ul><blockquote><p>HystrixCommand 的 <code>commandKey</code>、<code>groupKey</code>、<code>threadPoolKey</code> 的最佳实践：</p></blockquote><ul><li>一般情况下：<ul><li>一个依赖服务对应一个 <code>groupKey</code>，并共享同一个线程池。</li></ul></li><li>特殊情况下：<ul><li>如果一个依赖服务下的不同接口的 QPS、耗时差异很大，建议拆分线程池，给部分 <code>commandKey</code> 定义独立的 <code>threadPoolKey</code>，即使用单独的线程池，避免资源互相争抢。</li></ul></li><li>监控与报警：<ul><li>可以按 <code>groupKey</code> 聚合显示服务整体调用情况。</li><li>也可以按 <code>commandKey</code> 查看具体接口的性能和错误率。</li></ul></li></ul><div class="admonition note"><p class="admonition-title">总结说明</p><ul><li><code>commandKey</code> → 接口级别（熔断 / 降级 / 限流 / 监控最小单位）</li><li><code>groupKey</code> → 服务级别（逻辑分组 + 默认线程池）</li><li><code>threadPoolKey</code> → 线程池级别（资源隔离）</li></ul></div><h3 id="自定义线程池的参数"><a href="#自定义线程池的参数" class="headerlink" title="自定义线程池的参数"></a>自定义线程池的参数</h3><blockquote><p>第一种方式：使用 <code>@HystrixCommand</code> 注解配置线程池参数</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@HystrixCommand(</span></span><br><span class="line"><span class="meta">        commandKey = "getUserInfoCommand",</span></span><br><span class="line"><span class="meta">        groupKey = "UserGroup",</span></span><br><span class="line"><span class="meta">        threadPoolKey = "UserThreadPool",  // 指定独立线程池</span></span><br><span class="line"><span class="meta">        threadPoolProperties = {</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = "coreSize", value = "10"),              // 最大线程数</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = "maxQueueSize", value = "20"),          // 队列长度</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = "queueSizeRejectionThreshold", value = "20") // 动态拒绝阈值</span></span><br><span class="line"><span class="meta">        },</span></span><br><span class="line"><span class="meta">        commandProperties = {</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = "execution.isolation.strategy", value = "THREAD"), // 使用线程隔离</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds", value = "2000") // 超时时间</span></span><br><span class="line"><span class="meta">        },</span></span><br><span class="line"><span class="meta">        fallbackMethod = "getUserInfoFallback" // 降级方法</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUserInfo</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// 模拟调用外部依赖</span></span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://remote-service/user"</span>, String.class);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 降级逻辑</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUserInfoFallback</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"default-user"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><blockquote><p>第二种方式：使用全局默认配置 + 按需覆盖</p></blockquote><p>通过 <code>application.yml</code> 配置全局默认值，仅在特殊参数上覆盖：</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">threadpool:</span></span><br><span class="line">    <span class="attr">default:</span>              <span class="comment"># 默认线程池配置（未指定threadPoolKey时使用）</span></span><br><span class="line">      <span class="attr">coreSize:</span> <span class="number">15</span></span><br><span class="line">      <span class="attr">maxQueueSize:</span> <span class="number">-1</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">default:</span>              <span class="comment"># 所有命令默认配置</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">thread:</span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds:</span> <span class="number">2000</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>然后方法上只保留关键内容：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = "getUserInfoFallback")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getUserInfo</span><span class="params">()</span> </span>{</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 降级逻辑</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getUserInfoFallback</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"default-user"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><blockquote><p>第三种方式：按服务 / 业务分组配置</p></blockquote><p>为不同业务指定不同 <code>commandKey</code>、<code>threadPoolKey</code>，并在 <code>application.yml</code> 中集中管理：</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">threadpool:</span></span><br><span class="line">    <span class="attr">UserThreadPool:</span></span><br><span class="line">      <span class="attr">coreSize:</span> <span class="number">15</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">getUserInfoCommand:</span></span><br><span class="line">      <span class="attr">execution.isolation.thread.timeoutInMilliseconds:</span> <span class="number">3000</span></span><br></pre></td></tr></tbody></table></figure><p>然后方法上这样写：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand(</span></span><br><span class="line"><span class="meta">    commandKey = "getUserInfoCommand",</span></span><br><span class="line"><span class="meta">    threadPoolKey = "UserThreadPool",</span></span><br><span class="line"><span class="meta">    fallbackMethod = "getUserInfoFallback"</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getUserInfo</span><span class="params">()</span> </span>{</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 降级逻辑</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getUserInfoFallback</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"default-user"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><blockquote><p>第四种方式：封装通用注解 / 切面</p></blockquote><p>使用自定义注解 + AOP，减少重复代码：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@HystrixCommand(</span></span><br><span class="line"><span class="meta">    fallbackMethod = "defaultFallback",</span></span><br><span class="line"><span class="meta">    commandProperties = {</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds", value = "2000")</span></span><br><span class="line"><span class="meta">    }</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DefaultHystrixCommand {</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>然后方法上这样写：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DefaultHystrixCommand</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getUserInfo</span><span class="params">()</span> </span>{</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 降级逻辑</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">defaultFallback</span><span class="params">(String userId)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"default-user"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="/posts/4def2584.html">Resilience4j 入门教程 - 基础篇之一</a></li></ul><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/cb60c78e.html" title="Hystrix 入门教程 - 基础篇之二">https://www.techgrow.cn/posts/cb60c78e.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="fa fa-tag"></i> 微服务</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/316633c.html" rel="prev" title="Zuul 入门教程 - 基础篇"><i class="fa fa-angle-left"></i> Zuul 入门教程 - 基础篇</a></div><div class="post-nav-item"> <a href="/posts/6f728f64.html" rel="next" title="Zuul 入门教程 - 中级篇">Zuul 入门教程 - 中级篇<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">2m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">30:57</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/cb60c78e.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>