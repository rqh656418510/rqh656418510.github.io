<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍如何使用Seata，涉及分布式事务的场景、分布式事务解决方案、Seata 安装与配置的介绍。"><meta property="og:type" content="article"><meta property="og:title" content="Seata 入门教程 - 基础篇（2020 年）"><meta property="og:url" content="https://www.techgrow.cn/posts/e8b71fbe.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍如何使用Seata，涉及分布式事务的场景、分布式事务解决方案、Seata 安装与配置的介绍。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/distributed-transaction-scene-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/distributed-transaction-scene-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/distributed-transaction-scene-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/distributed-transaction-dtp-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/distributed-transaction-dtp-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/tcc-transaction.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/best-effort-notice.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/reliable-message-service.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-architecture.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-modules.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-nacos-service.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/seata-inport-to-config-center.png"><meta property="article:published_time" content="2020-12-25T13:12:19.000Z"><meta property="article:modified_time" content="2020-12-25T13:12:19.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="分布式"><meta property="article:tag" content="微服务"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2020/12/distributed-transaction-scene-1.png"><link rel="canonical" href="https://www.techgrow.cn/posts/e8b71fbe.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/e8b71fbe.html","path":"posts/e8b71fbe.html","title":"Seata 入门教程 - 基础篇（2020 年）"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Seata 入门教程 - 基础篇（2020 年） | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/app/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%98%E6%96%B9%E8%B5%84%E6%BA%90"><span class="nav-text">官方资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%93%E4%B8%9A%E6%9C%AF%E8%AF%AD"><span class="nav-text">专业术语</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%90%86%E8%AE%BA"><span class="nav-text">分布式理论</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%9F%BA%E7%A1%80"><span class="nav-text">分布式事务基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E4%BA%8B%E5%8A%A1"><span class="nav-text">什么是事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1"><span class="nav-text">什么是本地事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="nav-text">什么是分布式事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">分布式事务的适用场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-text">分布式事务解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E4%BA%8B%E5%8A%A1%EF%BC%88DTP%EF%BC%89"><span class="nav-text">全局事务（DTP）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%EF%BC%882PC%EF%BC%89"><span class="nav-text">两阶段提交（2PC）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%EF%BC%883PC%EF%BC%89"><span class="nav-text">三阶段提交（3PC）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCC%EF%BC%88%E4%B8%A4%E9%98%B6%E6%AE%B5%E5%9E%8B%E3%80%81%E8%A1%A5%E5%81%BF%E5%9E%8B%EF%BC%89"><span class="nav-text">TCC（两阶段型、补偿型）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%80%E5%A4%A7%E5%8A%AA%E5%8A%9B%E9%80%9A%E7%9F%A5%EF%BC%88%E5%AE%9A%E6%9C%9F%E6%A0%A1%E5%AF%B9%EF%BC%89"><span class="nav-text">最大努力通知（定期校对）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E5%8F%AF%E9%9D%A0%E6%B6%88%E6%81%AF%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-text">基于可靠消息服务实现最终一致性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Seata-%E4%BB%8B%E7%BB%8D"><span class="nav-text">Seata 介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Seata-%E7%9A%84%E7%AE%80%E4%BB%8B"><span class="nav-text">Seata 的简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Seata-%E7%9A%84%E6%BC%94%E8%BF%9B%E5%8E%86%E5%8F%B2"><span class="nav-text">Seata 的演进历史</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Seata-%E7%9A%84%E8%AE%BE%E8%AE%A1%E7%90%86%E5%BF%B5"><span class="nav-text">Seata 的设计理念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Seata-%E7%9A%84%E4%B8%89%E5%A4%A7%E7%BB%84%E4%BB%B6"><span class="nav-text">Seata 的三大组件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Seata-%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-text">Seata 的执行流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Seata-%E7%9A%84-ORM-%E6%A1%86%E6%9E%B6%E6%94%AF%E6%8C%81"><span class="nav-text">Seata 的 ORM 框架支持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Seata-%E5%AE%9E%E7%8E%B0%E7%9A%84-2PC-%E4%B8%8E%E4%BC%A0%E7%BB%9F-2PC-%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-text">Seata 实现的 2PC 与传统 2PC 的区别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Seata-Server-%E5%AE%89%E8%A3%85"><span class="nav-text">Seata Server 安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Seata-Server-%E4%B8%8B%E8%BD%BD"><span class="nav-text">Seata Server 下载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Seata-Server-%E9%85%8D%E7%BD%AE"><span class="nav-text">Seata Server 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Seata-Server-%E5%90%AF%E5%8A%A8"><span class="nav-text">Seata Server 启动</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Seata-Server-%E9%85%8D%E7%BD%AE%E4%BB%8B%E7%BB%8D"><span class="nav-text">Seata Server 配置介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E"><span class="nav-text">配置文件说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E4%BD%BF%E7%94%A8"><span class="nav-text">配置中心使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-TC-%E7%9A%84%E5%AD%98%E5%82%A8%E6%A8%A1%E5%BC%8F"><span class="nav-text">配置 TC 的存储模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BA%8B%E5%8A%A1%E7%BB%84%E7%9A%84%E5%90%8D%E7%A7%B0"><span class="nav-text">自定义事务组的名称</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Seata-Server-%E7%9A%84%E5%9D%91"><span class="nav-text">Seata Server 的坑</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#default-grouplist-%E5%B1%9E%E6%80%A7"><span class="nav-text">default.grouplist 属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#service-vgroup-mapping-%E5%B1%9E%E6%80%A7"><span class="nav-text">service.vgroup_mapping 属性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">626</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">53</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/e8b71fbe.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Seata 入门教程 - 基础篇（2020 年） | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍如何使用Seata，涉及分布式事务的场景、分布式事务解决方案、Seata 安装与配置的介绍。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Seata 入门教程 - 基础篇（2020 年）</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-12-25 21:12:19" itemprop="dateCreated datePublished" datetime="2020-12-25T21:12:19+08:00">2020-12-25</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/e8b71fbe.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/e8b71fbe.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>13k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>12 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/e8b71fbe.html">Seata 入门教程 - 基础篇（2020 年）</a></li><li><a href="/posts/84d3f3e6.html">Seata 入门教程 - 中级篇（2020 年）</a></li><li><a href="/posts/b0f7bd00.html">Seata 入门教程 - 实战篇（2020 年）</a></li><li><a href="/posts/85fab89c.html">Seata 入门教程 - 实战篇（2024 年）</a></li></ul><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="官方资源"><a href="#官方资源" class="headerlink" title="官方资源"></a>官方资源</h3><ul><li><a target="_blank" rel="external nofollow" href="https://github.com/apache/incubator-seata">Seata GitHub</a></li><li><a target="_blank" rel="external nofollow" href="https://seata.apache.org/zh-cn/docs/user/quickstart/">Seata 官方文档</a></li><li><a target="_blank" rel="external nofollow" href="https://github.com/apache/incubator-seata-samples">Seata 官方示例代码</a></li></ul><h3 id="专业术语"><a href="#专业术语" class="headerlink" title="专业术语"></a>专业术语</h3><ul><li><p><code>TX 协议</code>：应用或者应用服务器与事务管理器的接口</p></li><li><p><code>XA 协议</code>：全局事务管理器与资源管理器的接口。XA 是由 X/Open 组织提出的分布式事务规范，该规范主要定义了全局事务管理器和局部资源管理器之间的接口，主流的数据库产品都实现了 XA 接口。XA 接口是一个双向的系统接口，在事务管理器以及多个资源管理器之间作为通信桥梁。之所以需要 XA 是因为在分布式系统中从理论上讲两台机器是无法达到一致性状态的，因此引入一个单点进行协调。由全局事务管理器管理和协调的事务可以跨越多个资源和进程。全局事务管理器一般使用 XA 二阶段协议与数据库进行交互。</p></li></ul><span id="more"></span><h3 id="分布式理论"><a href="#分布式理论" class="headerlink" title="分布式理论"></a>分布式理论</h3><blockquote><p>CAP 理论</p></blockquote><p>CAP 定理是由加州大学伯克利分校 Eric Brewer 教授提出来的，他指出 WEB 服务无法同时满足一下三个属性：</p><ul><li>一致性 (Consistency)：客户端知道一系列的操作都会同时发生 (生效)</li><li> 可用性 (Availability)：每个操作都必须以可预期的响应结束</li><li>分区容错性 (Partition tolerance)：即使出现单个组件无法可用，操作依然可以完成</li></ul><p>具体地讲在分布式系统中，任何数据库设计或者 Web 应用至多只能同时支持上面的两个属性。显然，任何横向扩展策略都要依赖于数据分区。因此，设计人员<strong>必须在一致性与可用性之间做出选择</strong>。</p><blockquote><p>BASE 理论</p></blockquote><p>在分布式系统中，往往追求的是可用性，它的重要程序比一致性要高，那么如何实现高可用性呢？前人已经给我们提出来了另外一个理论，就是 BASE 理论，它是用来对 CAP 定理进行进一步扩充的。BASE 理论指的是：</p><ul><li>Basically Available（基本可用）</li><li>Soft state（软状态）</li><li>Eventually consistent（最终一致性）</li></ul><p>BASE 理论是对 CAP 中的一致性和可用性进行一个权衡的结果，理论的核心思想就是：<strong>无法做到强一致，但每个应用都可以根据自身的业务特点，采用适当的方式来使系统达到最终一致性（Eventual consistency）</strong>。</p><blockquote><p>酸碱平衡</p></blockquote><p>ACID 能够保证事务的强一致性，即数据是实时一致的，这在本地事务中是没有问题的。在分布式事务中，强一致性会极大影响分布式系统的性能，因此分布式系统中遵循 BASE 理论即可。但分布式系统的不同业务场景对一致性的要求也不同。如交易场景下，就要求强一致性，此时就需要遵循 ACID 理论，而在注册成功后发送短信验证码等场景下，并不需要实时一致，因此遵循 BASE 理论即可。因此要根据具体业务场景，在 ACID 和 BASE 之间寻求平衡。</p><h2 id="分布式事务基础"><a href="#分布式事务基础" class="headerlink" title="分布式事务基础"></a>分布式事务基础</h2><h3 id="什么是事务"><a href="#什么是事务" class="headerlink" title="什么是事务"></a>什么是事务</h3><p>事务指的就是一个操作单元，在这个操作单元中的所有操作最终要保持一致的行为，要么所有操都成功，要么所有的操作都被撤销。简单地说，事务提供一种” 要么什么都不做，要么做全套 “机制。</p><h3 id="什么是本地事务"><a href="#什么是本地事务" class="headerlink" title="什么是本地事务"></a>什么是本地事务</h3><p>本地事务其实可以认为是数据库提供的事务机制。说到数据库事务就不得不说，数据库事务中的四大特性（ACID）：</p><ul><li>A：原子性（Atomicity），一个事务中的所有操作，要么全部完成，要么全部不完成</li><li> C：一致性（Consistency），在一个事务执行之前和执行之后数据库都必须处于一致性状态</li><li> I：隔离性（Isolation），在并发环境中，当不同的事务同时操作相同的数据时，事务之间互不影响</li><li> D：持久性（Durability），指的是只要事务成功结束，它对数据库所做的更新就必须永久的保存下来</li></ul><p>数据库事务在实现时会将一次事务涉及的所有操作全部纳入到一个不可分割的执行单元，该执行单元中的所有操作要么都成功，要么都失败，只要其中任一操作执行失败，都将导致整个事务的回滚。</p><h3 id="什么是分布式事务"><a href="#什么是分布式事务" class="headerlink" title="什么是分布式事务"></a>什么是分布式事务</h3><p>分布式事务指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上。简而言之，就是一次大的操作由不同的小操作组成，这些小的操作分布在不同的服务器上，且属于不同的应用，分布式事务需要保证这些小操作要么全部成功，要么全部失败。本质上来说，分布式事务就是为了保证不同数据库的数据一致性。一句话概括就是，<strong>一次业务操作需要跨多个数据源或者需要跨多个系统进行远程调用，就会产生分布式事务问题。</strong></p><h3 id="分布式事务的适用场景"><a href="#分布式事务的适用场景" class="headerlink" title="分布式事务的适用场景"></a>分布式事务的适用场景</h3><ul><li>单体系统访问多个数据库：一个服务需要调用多个数据库实例完成数据的增删改操作</li></ul><p><img data-src="../../../asset/2020/12/distributed-transaction-scene-1.png" alt="distributed-transaction-scene-1"></p><ul><li>多个微服务访问同一个数据库：多个服务需要调用一个数据库实例完成数据的增删改操作</li></ul><p><img data-src="../../../asset/2020/12/distributed-transaction-scene-2.png" alt="distributed-transaction-scene-2"></p><ul><li>多个微服务访问多个数据库：多个服务需要调用多个数据库实例完成数据的增删改操作</li></ul><p><img data-src="../../../asset/2020/12/distributed-transaction-scene-3.png" alt="distributed-transaction-scene-3"></p><h2 id="分布式事务解决方案"><a href="#分布式事务解决方案" class="headerlink" title="分布式事务解决方案"></a>分布式事务解决方案</h2><h3 id="全局事务（DTP）"><a href="#全局事务（DTP）" class="headerlink" title="全局事务（DTP）"></a>全局事务（DTP）</h3><p>全局事务是基于 DTP 模型实现的，DTP 是由 X/Open 组织提出的一种分布式事务模型 — X/Open Distributed Transaction Processing Reference Model。它规定了要实现分布式事务，需要三种角色：</p><ul><li><code>AP</code>：Application 应用系统（微服务）</li><li><code>RM</code>：Resource Manager 资源管理器（数据库）</li><li><code>TM</code>：Transaction Manager 事务管理器（全局事务管理）</li></ul><p><strong>整个事务分成两个阶段：</strong></p><ul><li>阶段一：表决阶段（投票阶段），所有参与者都将本事务执行预提交，并将能否成功的信息反馈发给协调者</li><li>阶段二：执行阶段（提交阶段），协调者根据所有参与者的反馈，通知所有参与者，步调一致地执行提交或者回滚</li></ul><p><img data-src="../../../asset/2020/12/distributed-transaction-dtp-1.png" alt="distributed-transaction-dtp-1"></p><hr><p><img data-src="../../../asset/2020/12/distributed-transaction-dtp-2.png" alt="distributed-transaction-dtp-2"></p><p><strong>优点：</strong></p><ul><li>提高了数据一致性的概率，实现成本较低</li></ul><p><strong>缺点：</strong></p><ul><li>单点问题：事务协调者宕机</li><li>同步阻塞：延迟了提交时间，加长了资源阻塞时间</li><li>数据不一致：在提交的第二阶段，依然存在 Commit 结果未知的情况，有可能导致数据不一致（即两阶段提交无法解决的问题）</li></ul><h3 id="两阶段提交（2PC）"><a href="#两阶段提交（2PC）" class="headerlink" title="两阶段提交（2PC）"></a>两阶段提交（2PC）</h3><p>分布式系统的一个难点是如何保证架构下多个节点在进行事务性操作的时候保持一致性。为实现这个目的，两阶段提交算法的成立基于以下假设：</p><ul><li>该分布式系统中，存在一个节点作为协调者（Coordinator），其他节点作为参与者（Cohorts），且节点之间可以进行网络通信</li><li>所有节点都采用预写式日志，且日志被写入后即被保持在可靠的存储设备上，即使节点损坏不会导致日志数据的消失</li><li>所有节点不会永久性损坏，即使损坏后仍然可以恢复</li></ul><p><strong>第一阶段（投票阶段）:</strong></p><ul><li>协调者节点向所有参与者节点询问是否可以执行提交操作（vote），并开始等待各参与者节点的响应</li><li>参与者节点执行询问发起为止的所有事务操作，并将 Undo 信息和 Redo 信息写入日志（注意：如果成功，这里其实每个参与者已经执行了事务操作）</li><li>各参与者节点响应协调者节点发起的询问，如果参与者节点的事务操作实际执行成功，则它返回一个” 同意” 消息；如果参与者节点的事务操作实际执行失败，则它返回一个” 中止” 消息</li></ul><p><strong>第二阶段（提交阶段）：</strong></p><p>当协调者节点从所有参与者节点获得的相应消息都为” 同意” 时：</p><ul><li>协调者节点向所有参与者节点发出” 正式提交（Commit）” 的请求</li><li>参与者节点正式完成操作，并释放在整个事务期间内占用的资源</li><li>参与者节点向协调者节点发送” 完成” 消息</li><li>协调者节点受到所有参与者节点反馈的” 完成” 消息后，完成事务</li></ul><p><strong>中断事务的发生：</strong></p><p>如果任一参与者节点在第一阶段返回的响应消息为” 中止”，或者协调者节点在第一阶段的询问超时之前无法获取所有参与者节点的响应消息时：</p><ul><li>协调者节点向所有参与者节点发出” 回滚操作（Rollback）” 的请求</li><li>参与者节点利用之前写入的 Undo 信息执行回滚，并释放在整个事务期间内占用的资源</li><li>参与者节点向协调者节点发送” 回滚完成” 消息</li><li>协调者节点受到所有参与者节点反馈的” 回滚完成” 消息后，取消事务</li><li><strong>特别注意：不管最后结果如何，第二阶段都会结束当前事务</strong></li></ul><p><strong>两阶段提交的缺点：</strong></p><ul><li>资源阻塞：执行过程中，所有参与节点都是事务阻塞型的。当参与者占有公共资源时，其他第三方节点访问公共资源不得不处于阻塞状态</li><li>参与者发生故障：协调者需要给每个参与者额外指定超时机制，超时后整个事务失败（没有多少容错机制）</li><li>协调者发生故障：参与者会一直阻塞下去，需要额外的备机进行容错（这个可以依赖 Paxos 协议实现 HA）</li><li><strong>两阶段提交无法解决的问题：</strong>协调者在发出 Commit 消息之后宕机，而唯一接收到这条消息的参与者同时也宕机了。那么即使协调者通过选举协议产生了新的协调者，这条事务的状态也是不确定的，没人知道事务是否已经被提交成功，这就有可能导致数据不一致</li></ul><h3 id="三阶段提交（3PC）"><a href="#三阶段提交（3PC）" class="headerlink" title="三阶段提交（3PC）"></a>三阶段提交（3PC）</h3><p>与两阶段提交不同的是，三阶段提交有两个改动点：</p><ul><li>引入超时机制。同时在协调者和参与者中都引入超时机制</li><li>在第一阶段和第二阶段中插入一个准备阶段，保证了在最后提交阶段之前各参与节点的状态是一致的</li></ul><blockquote><p>也就是说，除了引入超时机制之外，3PC 把 2PC 的投票阶段再次一分为二，这样三阶段提交就有 CanCommit、PreCommit、DoCommit 三个阶段。</p></blockquote><p><strong>CanCommit 阶段：</strong></p><p>3PC 的 CanCommit 阶段其实和 2PC 的投票阶段很像，协调者向参与者发送 Commit 请求，参与者如果可以提交就返回 Yes 响应，否则返回 No 响应：</p><ul><li>事务询问：协调者向参与者发送 CanCommit 请求，询问是否可以执行事务提交操作，然后开始等待参与者的响应</li><li>响应反馈：参与者接到 CanCommit 请求之后，正常情况下，如果其自身认为可以顺利执行事务，则返回 Yes 响应，并进入预备状态，否则返回 No 响应</li></ul><p><strong>PreCommit 阶段：</strong></p><p>协调者根据参与者的响应情况来决定是否可以执行事务的 PreCommit 操作。根据响应情况，有以下两种可能：</p><ul><li><p>假如协调者从所有的参与者获得的反馈都是 Yes 响应，那么就会执行事务的预执行</p><ul><li>发送预提交请求：协调者向参与者发送 PreCommit 请求后，并进入 Prepared 阶段</li><li>事务预提交：参与者接收到 PreCommit 请求后，会执行事务操作，并将 Undo 和 Redo 信息记录到事务日志中</li><li>响应反馈：如果参与者成功的执行了事务操作，则返回 ACK 响应，同时开始等待最终指令</li></ul></li><li><p>假如有任何一个参与者向协调者发送了 No 响应，或者等待超时之后，协调者都没有接到参与者的响应，那么就执行事务的中断</p><ul><li>发送中断请求：协调者向所有参与者发送 Abort 请求</li><li>中断事务：参与者收到来自协调者的 Abort 请求之后（或超时之后，仍未收到协调者的请求），执行事务的中断</li></ul></li></ul><div class="admonition note"><p class="admonition-title">Undo 和 Redo 日志</p><ul><li>(1) Undo 和 Redo 日志是用于事务回滚和数据恢复的重要机制。</li><li>(2) Undo 日志：记录在事务操作前的数据状态，以便在需要回滚事务时，可以撤销已执行的操作，恢复到事务开始前的状态。举例来说，如果事务在某个步骤中修改了数据库表中的数据，Undo 日志就会在执行修改之前记录原始数据值。这样如果事务最终没有提交成功，系统可以通过这些日志信息将数据还原到修改前的状态。</li><li>(3) Redo 日志：记录事务操作后的数据状态，以便在事务失败需要恢复时重新应用这些操作。当事务最终准备提交时，Redo 日志会确保所有的更改都能被重复应用，以达到一致的提交效果。举例来说，如果事务已经提交，但系统在写入数据到持久性存储时发生了崩溃，那么通过 Redo 日志，就可以在系统恢复后重新执行已提交的操作，确保数据一致性。值得一提的是，Redo 是单词 <code>do again</code> 的含义，表示 <code>重做</code> 或者 <code>再次执行</code> 的意思。</li></ul></div><p><strong>DoCommit 阶段</strong></p><p>该阶段进行真正的事务提交，也可以分为以下两种情况：</p><ul><li><p>执行提交：</p><ul><li>发送提交请求：协调接收到参与者发送的 ACK 响应，那么它将从预提交状态进入到提交状态，并向所有参与者发送 DoCommit 请求</li><li>事务提交：参与者接收到 DoCommit 请求之后，执行正式的事务提交，并在完成事务提交之后释放所有事务资源</li><li>响应反馈：事务提交完之后，向协调者发送 ACK 响应</li><li>完成事务：协调者接收到所有参与者的 ACK 响应之后，完成事务</li></ul></li><li><p>中断事务</p><ul><li>发送中断请求：协调者向所有参与者发送 Abort 请求</li><li>事务回滚：参与者接收到 Abort 请求之后，利用其在阶段二记录的 Undo 信息来执行事务的回滚操作，并在完成回滚之后释放所有的事务资源</li><li>反馈结果：参与者完成事务回滚之后，向协调者发送 ACK 消息</li><li>中断事务：协调者接收到参与者反馈的 ACK 消息之后，执行事务的中断</li></ul></li></ul><p>这里协调者如果没有接收到参与者发送的 ACK 响应（可能是接受者发送的不是 ACK 响应，也可能响应超时），那么就会执行中断事务。</p><h3 id="TCC（两阶段型、补偿型）"><a href="#TCC（两阶段型、补偿型）" class="headerlink" title="TCC（两阶段型、补偿型）"></a>TCC（两阶段型、补偿型）</h3><p>TCC（Try Confirm Cancel）属于补偿型分布式事务（又被称为补偿事务），类似 2PC 的柔性分布式解决方案，属于 2PC 的改良版。TCC 实现分布式事务一共有三个步骤：</p><ul><li><p>Try（尝试待执行的业务）：这个过程并未执行业务，只是完成所有业务的一致性检查，并预留好执行所需的全部资源</p></li><li><p>Confirm（确认执行业务）：确认执行业务操作，不做任何业务检查，只使用 Try 阶段预留的业务资源。通常情况下，采用 TCC 则认为 Confirm 阶段是不会出错的。即只要 Try 成功，Confirm 就一定成功。若 Confirm 阶段真的出错了，需引入重试机制或人工处理</p></li><li><p>Cancel（取消待执行的业务）：取消 Try 阶段预留的业务资源。通常情况下，采用 TCC 则认为 Cancel 阶段也是一定成功的。若 Cancel 阶段真的出错了，需引入重试机制或人工处理</p></li></ul><p><img data-src="../../../asset/2020/12/tcc-transaction.png" alt="tcc-transaction"></p><p><strong>TCC 两阶段提交与 XA 两阶段提交的区别：</strong></p><ul><li>XA 是资源层面的分布式事务，强一致性，在两阶段提交的整个过程中，会一直持有资源的锁</li><li> TCC 是业务层面的分布式事务，最终一致性，不会一直持有资源的锁</li></ul><p><strong>TCC 事务的优缺点：</strong></p><ul><li>优点：把数据库层的两阶段提交上提到了应用层来实现，规避了数据库层的 2PC 性能低下的问题</li><li>缺点：TCC 的 Try、Confirm 和 Cancel 操作功能需业务提供，开发成本高</li></ul><h3 id="最大努力通知（定期校对）"><a href="#最大努力通知（定期校对）" class="headerlink" title="最大努力通知（定期校对）"></a>最大努力通知（定期校对）</h3><p>最大努力通知也被称为定期校对，其实是对第二种解决方案的进一步优化。它引入了本地消息表来记录错误消息，然后加入失败消息的定期校对功能，来进一步保证消息会被下游系统消费。</p><p><img data-src="../../../asset/2020/12/best-effort-notice.png" alt="best-effort-notice"></p><p><strong>第一步：消息由系统 A 投递到消息中间件</strong></p><ul><li>1）处理业务的同一事务中，向本地消息表中写入一条记录</li><li> 2）准备专门的消息发送者不断地发送本地消息表中的消息到消息中间件，如果发送失败则重试</li></ul><p><strong>第二步：消息由中间件投递到系统 B</strong></p><ul><li>1）消息中间件收到消息后负责将该消息同步投递给相应的下游系统，并触发下游系统的任务执行</li><li> 2）当下游系统处理成功后，向消息中间件反馈确认应答，消息中间件便可以将该条消息删除，从而该事务完成</li><li> 3）对于投递失败的消息，利用重试机制进行重试，对于重试失败的，写入错误消息表</li><li> 4）消息中间件需要提供失败消息的查询接口，下游系统会定期查询失败消息，并将其消费</li></ul><p><strong>优缺点：</strong></p><ul><li>优点： 一种非常经典的实现，实现了最终一致性</li><li>缺点： 消息表会耦合到业务系统中，如果没有封装好的解决方案，会有很多杂活需要处理，并且在业界并没有成熟的方案来解决</li></ul><h3 id="基于可靠消息服务实现最终一致性"><a href="#基于可靠消息服务实现最终一致性" class="headerlink" title="基于可靠消息服务实现最终一致性"></a>基于可靠消息服务实现最终一致性</h3><p>基于可靠消息服务的方案是通过消息中间件（如 Kafka、RocketMQ）保证上、下游应用数据操作的最终一致性。假设有 A 和 B 两个系统，分别可以处理任务 A 和任务 B。此时存在一个业务流程，需要将任务 A 和任务 B 在同一个事务中处理，此时就可以使用消息中间件来实现这种分布式事务。</p><p><img data-src="../../../asset/2020/12/reliable-message-service.png" alt="reliable-message-service"></p><p><strong>第一步：消息由系统 A 投递到消息中间件</strong></p><ul><li>1）在系统 A 处理任务 A 前，首先向消息中间件发送一条消息</li><li> 2）消息中间件收到后将该条消息持久化，但并不投递。持久化成功后，向 A 回复一个确认应答</li><li> 3）系统 A 收到确认应答后，则可以开始处理任务 A</li><li>4）任务 A 处理完成后，向消息中间件发送 Commit 或者 Rollback 请求。该请求发送完成后，对系统 A 而言，该事务的处理过程就结束了</li><li> 5）如果消息中间件收到 Commit，则向 B 系统投递消息；如果收到 Rollback，则直接丢弃消息。但是如果消息中间件收不到 Commit 和 Rollback 指令，那么就要依靠” 超时询问机制”</li></ul><blockquote><p>超时询问机制</p></blockquote><p>系统 A 除了实现正常的业务流程外，还需提供一个事务询问的接口，供消息中间件调用。当消息中间件收到发布消息便开始计时，如果到了超时没收到确认指令，就会主动调用系统 A 提供的事务询问接口询问该系统目前的状态。该接口会返回三种结果，中间件根据三种结果做出不同反应：</p><ul><li>提交：将该消息投递给系统 B</li><li> 回滚：直接将消息丢弃</li><li>处理中：继续等待</li></ul><p><strong>第二步：消息由中间件投递到系统 B</strong></p><p>消息中间件向下游系统投递完消息后便进入阻塞等待状态，下游系统便立即进行任务的处理，任务处理完成后便向消息中间件返回应答。</p><ul><li>如果消息中间件收到确认应答后便认为该事务处理完毕</li><li>如果消息中间件在等待确认应答超时之后就会重新投递，直到下游消费者返回消费成功响应为止。一般消息中间件可以设置消息重试的次数和时间间隔，如果最终还是不能成功投递，则需要手工干预。这里之所以使用人工干预，而不是使用让 A 系统回滚，主要是考虑到整个系统设计的复杂度问题</li></ul><p>基于可靠消息服务的分布式事务，前半部分使用异步，注重性能；后半部分使用同步，注重开发成本。</p><h2 id="Seata-介绍"><a href="#Seata-介绍" class="headerlink" title="Seata 介绍"></a>Seata 介绍</h2><h3 id="Seata-的简介"><a href="#Seata-的简介" class="headerlink" title="Seata 的简介"></a>Seata 的简介</h3><p>2019 年 1 月，阿里巴巴中间件团队发起了开源项目 Fescar（Fast &amp; Easy Commit And Rollback），其愿景是让分布式事务的使用像本地事务的使用一样，简单和高效，并逐步解决开发者们遇到的分布式事务方面的所有难题。Fescar 开源后，蚂蚁金服加入 Fescar 社区参与共建，并在 Fescar 0.4.0 版本中贡献了 TCC 模式。为了打造更中立、更开放、生态更加丰富的分布式事务开源社区，经过社区核心成员的投票，决定对 Fescar 进行品牌升级，于 2019 年 5 月 开始更名为 Seata，意为：Simple Extensible Autonomous Transaction Architecture，是一套一站式分布式事务解决方案，为用户提供了 AT、TCC、SAGA 和 XA 事务模式。Seata 融合了阿里巴巴和蚂蚁金服在分布式事务技术上的积累，并沉淀了新零售、云计算和新金融等场景下丰富的实践经验，但要实现适用于所有的分布式事务场景的愿景，仍有很长的路要走。更多介绍可参考：<a target="_blank" rel="external nofollow" href="https://github.com/seata/seata">Seata 项目</a>、<a target="_blank" rel="external nofollow" href="https://github.com/seata/seata-samples">Seata 官方示例代码</a>、<a target="_blank" rel="external nofollow" href="http://seata.io/zh-cn/">Seata 官网</a>、<a target="_blank" rel="external nofollow" href="http://seata.io/zh-cn/docs/overview/what-is-seata.html">Seata 官方中文文档</a></p><h3 id="Seata-的演进历史"><a href="#Seata-的演进历史" class="headerlink" title="Seata 的演进历史"></a>Seata 的演进历史</h3><ul><li>(1) 早在 2007 年，阿里巴巴和蚂蚁集团内部开发了分布式事务中间件，用于解决电商、支付、物流等业务场景中应用数据的一致性问题。内部项目分别被称为 TXC（Taobao Transaction Constructor） / XTS（eXtended Transaction Service），该项目几乎在每笔订单的交易支付链路几乎都有使用。</li><li>(2) 自 2013 年以来，阿里巴巴和蚂蚁集团已在阿里云和金融云上向企业客户分别发布了分布式事务云服务产品 GTS（Global Transaction Service） / DTX （Distributed Transaction-eXtended），在各个行业领域积累了大量用户。</li><li>(3) 2019 年 1 月，阿里巴巴集团正式开源了该项目，项目命名为 Fescar（Fast &amp; Easy Commit and Rollback）。项目开源以来，它受到了众多开发人员的热烈欢迎和赞扬，开源一周收获了超 3k star，曾一度蝉联 GitHub Trending 排行榜第一。</li><li>(4) 2019 年 4 月，蚂蚁集团数据中间件团队加入了 Fescar 社区。为了创建一个更加开放和中立的社区，Fescar 改名为 Seata（Simple Extensible Autonomous Transaction Architecture），代码仓库从 Alibaba Organization 迁移到其独立的 Seata Organization。</li><li>(5) 2019 年 12 月，Seata 开源项目正式发布 1.0.0 GA 版本，标志着项目已基本可生产使用。</li><li>(6) 2023 年 10 月，为了更好的通过社区驱动技术的演进，阿里和蚂蚁集团正式将 Seata 捐赠给 Apache 基金会，该提案已通过了 Apache 基金会的投票决议，Seata 正式进入 Apache 孵化器。</li></ul><h3 id="Seata-的设计理念"><a href="#Seata-的设计理念" class="headerlink" title="Seata 的设计理念"></a>Seata 的设计理念</h3><p>Seata 的设计目标是对业务无侵入，因此从业务无侵入的 2PC 方案着手，在传统 2PC 的基础上改良。它把一个分布式事务理解成一个包含了若干分支事务的全局事务。全局事务的职责是协调其下管辖的分支事务达成一致，要么一起成功提交，要么一起失败回滚。此外，通常分支事务本身就是一个关系型数据库的本地事务。</p><p><img data-src="../../../asset/2020/12/seata-architecture.png" alt="seata-architecture"></p><h3 id="Seata-的三大组件"><a href="#Seata-的三大组件" class="headerlink" title="Seata 的三大组件"></a>Seata 的三大组件</h3><ul><li>TC（Transaction Coordinator）：事务协调器，维护全局和分支事务的状态，负责协调并驱动全局事务的提交或回滚</li><li> TM（Transaction Manager）：事务管理器，控制全局事务的边界，负责开启一个全局事务，并最终发起全局提交或全局回滚的决议</li><li> RM（Resource Manager）：资源管理器，负责管理分支事务上的资源，向 TC 注册分支事务，上报分支事务的状态，接受 TC 的命令来提交或者回滚分支事务</li></ul><p><img data-src="../../../asset/2020/12/seata-modules.png" alt="seata-modules"></p><blockquote><p>XID 是全局事务的唯一标识，它可以在服务的调用链路中传递，绑定到服务的事务上下文中。</p></blockquote><div class="admonition note"><p class="admonition-title">总结</p><ul><li>TC（事务协调器）：就是 Seata 自身，负责维护全局事务和分支事务的状态，驱动全局事务提交或回滚。</li><li>TM（事务管理器）：就是标注全局事务注解 <code>@GlobalTransactional</code> 启动入口动作的微服务模块（比如订单模块），它是事务的发起者，负责定义全局事务的范围，并根据 TC 维护的全局事务和分支事务状态，作出开启全局事务、提交全局事务、回滚全局事务的决议。</li><li>RM（资源管理器）：就是 MySQL 数据库本身，可以有多个 RM，负责管理分支事务上的资源，向 TC 注册分支事务，上报分支事务状态，接受 TC 的命令来提交或者回滚分支事务。</li></ul></div><h3 id="Seata-的执行流程"><a href="#Seata-的执行流程" class="headerlink" title="Seata 的执行流程"></a>Seata 的执行流程</h3><p>Seata 三大组件会相互协作运行，TC 以 Seata 服务器（Server）形式独立部署，TM 和 RM 则是以 Seata Client 的形式集成在微服务应用中运行。Seata 的具体执行流程如下：</p><ul><li>1）A 服务的 TM 向 TC 申请开启一个全局事务，TC 就会创建一个全局事务并返回一个唯一的 XID</li><li>2）A 服务的 RM 向 TC 注册分支事务，并将其纳入 XID 对应全局事务的管辖</li><li> 3）A 服务执行分支事务，向数据库执行操作</li><li> 4）A 服务开始远程调用 B 服务，此时 XID 会在微服务的调用链上传播</li><li> 5）B 服务的 RM 向 TC 注册分支事务，并将其纳入 XID 对应的全局事务的管辖</li><li> 6）B 服务执行分支事务，向数据库执行操作</li><li> 7）全局事务调用链处理完毕，TM 根据有无异常向 TC 发起全局事务的提交或者回滚决议</li><li> 8）TC 协调其管辖之下的所有分支事务，决定是否回滚</li></ul><div class="admonition note"><p class="admonition-title">总结</p><ul><li>(1) TM 向 TC 申请开启一个全局事务，全局事务创建成功后会生成一个全局唯一的 XID</li><li>(2) XID 在微服务调用链路的上下文中传播</li><li> (3) RM 向 TC 注册分支事务，将其纳入 XID 对应全局事务的管辖</li><li> (4) TM 向 TC 发起针对 XID 的全局提交或回滚决议</li><li> (5) TC 调度 XID 下管辖的全部分支事务完成提交或回滚请求</li></ul></div><h3 id="Seata-的-ORM-框架支持"><a href="#Seata-的-ORM-框架支持" class="headerlink" title="Seata 的 ORM 框架支持"></a>Seata 的 ORM 框架支持</h3><p>Seata 虽然是保证数据一致性的组件，但对于 ORM 框架并没有特殊的要求，像主流的 Mybatis、Mybatis-Plus、Spring Data JPA、Hibernate 等都支持。这是因为 ORM 框架位于 JDBC 结构的上层，而 Seata 的 AT、XA 事务模式是对 JDBC 标准接口操作的拦截和增强。</p><h3 id="Seata-实现的-2PC-与传统-2PC-的区别"><a href="#Seata-实现的-2PC-与传统-2PC-的区别" class="headerlink" title="Seata 实现的 2PC 与传统 2PC 的区别"></a>Seata 实现的 2PC 与传统 2PC 的区别</h3><ul><li>1）架构层次方面：传统 2PC 方案的 RM 实际上是在数据库层，RM 本质上就是数据库自身，通过 XA 协议实现，而 Seata 的 RM 是以 Jar 包的形式作为中间件层部署在应用程序这一侧的</li><li> 2）两阶段提交方面：传统 2PC 无论第二阶段的决议是 Commit 还是 Rollback，事务性资源的锁都要保持到 Phase2（阶段二） 完成才释放。而 Seata 的做法是在 Phase1（阶段一） 就将本地事务提交，这样就可以省去 Phase2（阶段二） 持锁的时间，整体提高了效率</li></ul><h2 id="Seata-Server-安装"><a href="#Seata-Server-安装" class="headerlink" title="Seata Server 安装"></a>Seata Server 安装</h2><p>Seata 分 TC、TM 和 RM 三个角色，TC（Server 端）需要单独作为服务端部署，TM 和 RM（Client 端）由业务系统集成（如 Maven、Gradle）。</p><h3 id="Seata-Server-下载"><a href="#Seata-Server-下载" class="headerlink" title="Seata Server 下载"></a>Seata Server 下载</h3><p>1）Seata Server 的官方下载地址在<a target="_blank" rel="external nofollow" href="https://github.com/seata/seata/releases">这里</a>，直接下载已编译好的二进制包（<code>seata-server-1.4.0.tar.gz</code> ），然后解压即可使用</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载</span></span><br><span class="line"><span class="keyword">$ wget</span> https://github.com/seata/seata/releases/download/v1.4.0/seata-server-1.4.0.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line"><span class="keyword">$ tar</span><span class="params"> -xvf</span> seata-server-1.4.0.tar.gz</span><br></pre></td></tr></tbody></table></figure><p>2）Seata 的初始化资源的官方下载地址在<a target="_blank" rel="external nofollow" href="https://github.com/seata/seata/releases">这里</a>，需要下载 Seata 的源代码包（<code>Source code</code>），后面初始化数据库或者配置中心时会用到资源目录里的文件</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载</span></span><br><span class="line"><span class="keyword">$ wget</span> https://github.com/seata/seata/archive/v1.4.0.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line"><span class="keyword"># tar</span><span class="params"> -xvf</span> v1.4.0.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 资源目录的结构</span></span><br><span class="line">seata-1.4.0/script</span><br><span class="line">├── client</span><br><span class="line">├── config-center</span><br><span class="line">└── server</span><br></pre></td></tr></tbody></table></figure><p>资源目录说明如下：</p><ul><li><code>server</code>：Server 端数据库脚本及各个容器配置</li><li><code>client</code>：存放 Client 端的 SQL 脚本、参数配置</li><li><code>config-center</code>：各个配置中心参数导入脚本，其中的 <code>config.txt</code>(包含 Server 和 Client，原名为 <code>nacos-config.txt</code>) 为通用参数文件</li></ul><h3 id="Seata-Server-配置"><a href="#Seata-Server-配置" class="headerlink" title="Seata Server 配置"></a>Seata Server 配置</h3><p>1）将 Seata Server（TC）的存储模式更改为 DB，即使用数据库来存储全局事务会话信息，同时自定义事务组的名称。这里演示使用的数据库为 MySQL，默认支持的数据库类型包括：MySQL、Oracle、PostgreSQL、H2、Oceanbase，其中 <code>service.vgroupMapping</code> 的详细介绍可以看<a href="/posts/e8b71fbe.html#%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BA%8B%E5%8A%A1%E7%BB%84%E7%9A%84%E5%90%8D%E7%A7%B0">自定义事务组的名称</a></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份配置文件</span></span><br><span class="line"><span class="keyword">$ cp</span> seata/conf/file.conf seata/conf/file.conf.bak</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑配置文件，更改或者新增以下内容</span></span><br><span class="line"><span class="keyword">$ vim</span> seata/conf/file.conf</span><br><span class="line"></span><br><span class="line">service {</span><br><span class="line">  vgroupMapping.tx_group_test = <span class="string">"default"</span>        <span class="comment">#自定义事务组的名称，若不存在service配置项，直接新增对应的配置内容即可</span></span><br><span class="line">  default.grouplist = <span class="string">"127.0.0.1:8091"</span></span><br><span class="line">  enableDegrade = <span class="literal">false</span></span><br><span class="line">  <span class="built_in">disable</span> = <span class="literal">false</span></span><br><span class="line">  max.commit.retry.timeout = <span class="string">"-1"</span></span><br><span class="line">  max.rollback.retry.timeout = <span class="string">"-1"</span></span><br><span class="line">  disableGlobalTransaction = <span class="literal">false</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">store {</span><br><span class="line">  mode = <span class="string">"db"</span>                                     <span class="comment"># 存储模式</span></span><br><span class="line"></span><br><span class="line">  db {</span><br><span class="line">    dbType = <span class="string">"mysql"</span>                              <span class="comment"># 数据库类型</span></span><br><span class="line">    datasource = <span class="string">"druid"</span>                          <span class="comment"># 数据库连接池</span></span><br><span class="line">    driverClassName = <span class="string">"com.mysql.cj.jdbc.Driver"</span>  <span class="comment"># 数据库驱动</span></span><br><span class="line">    url = <span class="string">"jdbc:mysql://127.0.0.1:3306/seata?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=false"</span>    <span class="comment"># 数据库连接地址</span></span><br><span class="line">    user = <span class="string">"mysql"</span>                                <span class="comment"># 数据库用户名</span></span><br><span class="line">    password = <span class="string">"mysql"</span>                            <span class="comment"># 数据库密码</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>2）初始化 Seata Server（TC）依赖的 MySQL 数据库，用于存储全局事务会话信息，SQL 初始化脚本的位置是 Seata 源码目录下的 <code>script/server/db/mysql.sql</code>。全局事务会话信息由三块内容构成，全局事务 –&gt; 分支事务 –&gt; 全局锁，对应的表分别是 <code>global_table</code>、<code>branch_table</code>、<code>lock_table</code></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 创建Seata数据库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database seata <span class="keyword">default</span> <span class="type">character</span> <span class="keyword">set</span> utf8;</span><br><span class="line"></span><br><span class="line"># 切换数据库</span><br><span class="line">mysql<span class="operator">&gt;</span> use seata;</span><br><span class="line"></span><br><span class="line"># 执行<span class="keyword">SQL</span>初始化脚本</span><br><span class="line">mysql<span class="operator">&gt;</span> source seata<span class="number">-1.4</span><span class="number">.0</span><span class="operator">/</span>script<span class="operator">/</span>server<span class="operator">/</span>db<span class="operator">/</span>mysql.sql</span><br><span class="line"></span><br><span class="line"># 查看数据库表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_seata <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> branch_table    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> global_table    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> lock_table      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></tbody></table></figure><p>3）指定 Seata Server（TC）依赖的注册中心，这里使用的注册中心是 Nacos。为了演示方便，这里不再使用配置中心来存储 TC 的相关配置，即直接使用本地的 <code>file.conf</code> 配置文件。默认支持的注册中心与配置中心列表如下：</p><ul><li>配置中心支持类型：File、Nacos 、Apollo、Zookeeper、Consul、Etcd3</li><li> 注册中心支持类型：File 、Nacos 、Eureka、Zookeeper、Consul、Etcd3、Sofa、Redis</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份配置文件</span></span><br><span class="line"><span class="keyword">$ cp</span> seata/conf/registry.conf seata/conf/registry.conf.bak</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑配置文件，更改或者新增以下内容</span></span><br><span class="line"><span class="keyword">$ vim</span> seata/conf/registry.conf</span><br><span class="line"></span><br><span class="line">registry {</span><br><span class="line">  <span class="built_in">type</span> = <span class="string">"nacos"</span></span><br><span class="line"></span><br><span class="line">  nacos {</span><br><span class="line">    application = <span class="string">"seata-server"</span></span><br><span class="line">    serverAddr = <span class="string">"127.0.0.1:8848"</span></span><br><span class="line">    group = <span class="string">"SEATA_GROUP"</span></span><br><span class="line">    namespace = <span class="string">""</span></span><br><span class="line">    cluster = <span class="string">"default"</span></span><br><span class="line">    username = <span class="string">""</span></span><br><span class="line">    password = <span class="string">""</span></span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">config {</span><br><span class="line">  <span class="built_in">type</span> = <span class="string">"file"</span></span><br><span class="line"></span><br><span class="line">  file {</span><br><span class="line">    name = <span class="string">"file.conf"</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="Seata-Server-启动"><a href="#Seata-Server-启动" class="headerlink" title="Seata Server 启动"></a>Seata Server 启动</h3><p>先将 Seata Server 依赖的数据库、注册中心服务启动了，最后才启动 Seata Server。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建GC的日志目录</span></span><br><span class="line"><span class="keyword">$ mkdir</span> seata/logs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入bin目录</span></span><br><span class="line"><span class="keyword">$ cd</span> seata/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行启动脚本</span></span><br><span class="line"><span class="keyword">$ sh</span> seata-server.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者后台启动</span></span><br><span class="line"><span class="keyword">$ nohup</span> sh seata-server.sh &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者指定启动参数</span></span><br><span class="line"><span class="keyword">$ sh</span> seata-server.sh<span class="params"> -h</span> 127.0.0.1<span class="params"> -p</span> 8091<span class="params"> -n</span> 1</span><br></pre></td></tr></tbody></table></figure><p>启动参数说明如下：</p><ul><li><code>-h</code>: 注册到注册中心的 IP</li><li><code>-p</code>: Seata Server 的本地监听端口，默认端口是 <code>8091</code></li><li><code>-m</code>: 全局事务会话信息存储模式，file、db、redis，优先读取启动参数 (Seata-Server 1.3 及以上版本支持 Redis)</li><li><code>-n</code>: Server Node，多个 Server 时，需区分各自节点，用于生成不同区间的 <code>transactionId</code>，以免冲突</li><li><code>-e</code>: 多环境配置可以参考<a target="_blank" rel="external nofollow" href="http://seata.io/en-us/docs/ops/multi-configuration-isolation.html">这里</a></li></ul><div class="admonition warning"><p class="admonition-title">特别注意</p><p>堆内存建议分配 2G，堆外内存 1G，JVM 的内存参数可以直接在 <code>seata/bin/-server.sh</code> 脚本里调整。</p></div><p>Seata Server 成功启动后，在注册中心的服务列表里，可以看到 Seata Server 的服务已经成功注册：</p><p><img data-src="../../../asset/2020/12/seata-nacos-service.png" alt="seata-nacos-service"></p><h2 id="Seata-Server-配置介绍"><a href="#Seata-Server-配置介绍" class="headerlink" title="Seata Server 配置介绍"></a>Seata Server 配置介绍</h2><h3 id="配置文件说明"><a href="#配置文件说明" class="headerlink" title="配置文件说明"></a>配置文件说明</h3><ul><li><code>registry.conf</code>：用于指定 Seata Server（TC） 的注册中心和获取配置信息的方式，默认获取方式是 <code>file</code>。如果使用了其他注册中心，可以将 Seata Server 自身也注册到注册中心（如 Nacos）</li><li><code>file.conf</code>：用于指定 Seata Server（TC）的相关配置。如果使用了配置中心，可以将 <code>file.conf</code> 文件里的配置信息都存储到配置中心（如 Nacos）</li></ul><h3 id="配置中心使用"><a href="#配置中心使用" class="headerlink" title="配置中心使用"></a>配置中心使用</h3><p>若在 <code>registry.conf</code> 中指定使用配置中心来存储 TC 的相关配置（如下），即利用配置中心来替代 <code>file.conf</code> 配置文件，那么此时需要手动将 <code>file.conf</code> 里的配置信息添加到配置中心</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">config {</span><br><span class="line">  type = "nacos"</span><br><span class="line"></span><br><span class="line">  nacos {</span><br><span class="line">    serverAddr = "127.0.0.1:8848"</span><br><span class="line">    namespace = ""</span><br><span class="line">    group = "SEATA_GROUP"</span><br><span class="line">    username = ""</span><br><span class="line">    password = ""</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Seata 官方提供了将配置信息批量写入到各种主流配置中心的 Shell 脚本，存放路径是在 Seata 源码目录下的 <code>script/config-center</code> 目录（如下）</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">script/config-center</span><br><span class="line">├── apollo</span><br><span class="line">│&nbsp;&nbsp; └── apollo-config.sh</span><br><span class="line">├── config.txt</span><br><span class="line">├── consul</span><br><span class="line">│&nbsp;&nbsp; └── consul-config.sh</span><br><span class="line">├── etcd3</span><br><span class="line">│&nbsp;&nbsp; └── etcd3-config.sh</span><br><span class="line">├── nacos</span><br><span class="line">│&nbsp;&nbsp; ├── nacos-config.py</span><br><span class="line">│&nbsp;&nbsp; └── nacos-config.sh</span><br><span class="line">├── README.md</span><br><span class="line">└── zk</span><br><span class="line">    └── zk-config.sh</span><br></pre></td></tr></tbody></table></figure><p>其中 <code>config.txt</code> 为通用参数文件，包含了 Seata Server 需要的所有配置信息，只需执行对应的 Shell 脚本将配置信息写入到配置中心即可。值得一提的是，<code>config.txt</code> 文件必须在 <code>xxxx.sh</code> 的上级目录里；若使用 Nacos 作为配置中心，执行脚本时可以指定一些启动参数，如 Nacos 的 IP、端口号、命名空间、配置组等，Shell 脚本的具体使用方法可以查看 <code>script/config-center/README.md</code> 说明文档。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$ nacos</span>-config.sh<span class="params"> -h</span> 127.0.0.1<span class="params"> -p</span> 8848<span class="params"> -t</span> namespace<span class="params"> -g</span> group<span class="params"> -u</span> username<span class="params"> -w</span> password</span><br></pre></td></tr></tbody></table></figure><p>成功批量导入配置信息到配置中心后，控制台会输出如下提示：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">=========================================================================</span><br><span class="line"> Complete initialization parameters,  total-count:79 ,  failure-count:0</span><br><span class="line">=========================================================================</span><br><span class="line"> Init nacos config finished, please start seata-server.</span><br></pre></td></tr></tbody></table></figure><p>访问 Nacos 的控制台，可以看到已经有对应的配置信息</p><p><img data-src="../../../asset/2020/12/seata-inport-to-config-center.png" alt="seata-inport-to-config-center"></p><h3 id="配置-TC-的存储模式"><a href="#配置-TC-的存储模式" class="headerlink" title="配置 TC 的存储模式"></a>配置 TC 的存储模式</h3><p>Seata Server（TC）的存储模式现有 File、DB、Redis 三种（后续将引入 Raft、Mongodb），需要在 <code>file.conf</code> 配置文件中指定（如下）</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">store {</span><br><span class="line">  mode = "file"</span><br><span class="line"></span><br><span class="line">  ## file store property</span><br><span class="line">  file {</span><br><span class="line">    ## store location dir</span><br><span class="line">    dir = "sessionStore"</span><br><span class="line">    # branch session size , if exceeded first try compress lockkey, still exceeded throws exceptions</span><br><span class="line">    maxBranchSessionSize = 16384</span><br><span class="line">    # globe session size , if exceeded throws exceptions</span><br><span class="line">    maxGlobalSessionSize = 512</span><br><span class="line">    # file buffer size , if exceeded allocate new buffer</span><br><span class="line">    fileWriteBufferCacheSize = 16384</span><br><span class="line">    # when recover batch read size</span><br><span class="line">    sessionReloadReadSize = 100</span><br><span class="line">    # async, sync</span><br><span class="line">    flushDiskMode = async</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>默认存储模式为 File，若使用 File 模式则无需改动任何配置，直接启动即可，每种模式的说明如下：</p><ul><li>File 模式为单机模式，全局事务会话信息在内存中读写，并持久化为本地文件 <code>root.data</code>，性能较高</li><li> DB 模式为高可用模式，全局事务会话信息通过 DB 共享，性能会差一点</li><li> Redis 模式在 Seata-Server 1.3 及以上版本开始支持，性能较高，存在事务信息丢失风险，需要配置适合当前业务场景的 Redis 持久化策略</li></ul><h3 id="自定义事务组的名称"><a href="#自定义事务组的名称" class="headerlink" title="自定义事务组的名称"></a>自定义事务组的名称</h3><p><strong>特别注意，</strong><code>file.conf</code> 中的 <code>service.vgroupMapping</code> 这个配置，在 Spring Cloud 中的值默认是 <code>${spring.application.name}-fescar-service-group</code>，可以通过指定 <code>application.yml</code> 中的 <code>spring.cloud.alibaba.seata.tx-service-group</code> 这个属性来覆盖；但是必须要和 <code>file.conf</code> 中的 <code>service.vgroupMapping</code> 一致，否则会出现 <code>no available service 'null' found, please make sure registry config correct</code> 的错误，举例说明如下：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service {</span><br><span class="line">  vgroupMapping.tx_group_test = "default"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">alibaba:</span></span><br><span class="line">      <span class="attr">seata:</span></span><br><span class="line">        <span class="attr">tx-service-group:</span> <span class="string">tx_group_test</span></span><br></pre></td></tr></tbody></table></figure><p>在上述的配置中，Spring Cloud 中 <code>tx-service-group</code> 的值也必须为 <code>tx_group_test</code>；如果将 <code>vgroupMapping.xxxx</code> 中的 <code>xxxx</code>（Key 值）改为 <code>abcdefg</code>，则 Spring Cloud 中 <code>tx-service-group</code> 的值也必须为 <code>abcdefg</code>，即这两个值必须保持一致</p><h2 id="Seata-Server-的坑"><a href="#Seata-Server-的坑" class="headerlink" title="Seata Server 的坑"></a>Seata Server 的坑</h2><h3 id="default-grouplist-属性"><a href="#default-grouplist-属性" class="headerlink" title="default.grouplist 属性"></a>default.grouplist 属性</h3><p>在 Seata Server 的 <code>file.conf</code> 配置文件中，有个 <code>default.grouplist</code> 配置，该配置的使用说明如下：</p><ul><li>1）只有在 <code>registry.conf</code> 中配置了 <code>registry.type=file</code>，即注册中心是 File 模式时，该配置才会起作用</li><li> 2）对应的值可以配置多个，配置多个就需要搭建 Seata Server 集群。由于默认并未提供本地文件的同步功能，所以在 <code>store.mode=file</code> 模式下，这种集群方式的配置会报错；如果 Seata Server 搭建为集群，建议配置为 <code>store.mode=db</code>，这样就可以通过 DB 来共享 TC（Seata Server） 集群间的数据</li><li> 3）当 <code>registry.type=file</code> 时，这个 <code>default.grouplist</code> 才会起作用，但是 File 方式并不能提供一个注册中心的完整功能，比如健康检查机制，实例列表的更新剔出等，建议选择 Nacos 、Eureka、Redis、Zookeeper、Consul、Etcd3、Sofa 作为注册中心</li><li> 4）<code>registry.type=file</code> 或 <code>config.type=file</code> 的设计初衷，是让开发者在不依赖第三方注册中心或配置中心的前提下，可以通过 File 这种简单的直连快速验证 Seata 服务，达到快速上手的目的</li></ul><h3 id="service-vgroup-mapping-属性"><a href="#service-vgroup-mapping-属性" class="headerlink" title="service.vgroup_mapping 属性"></a>service.vgroup_mapping 属性</h3><p>Seata Server &lt;=1.0 的版本用的是 <code>service.vgroup_mapping</code>，但在新版本里改成了 <code>service.vgroupMapping</code>。若应用启动后无法连接 Seata Server，且抛出了以下异常信息，此时应该注意使用的是不是旧的 <code>service.vgroup_mapping</code></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">no available service 'null' found, please make sure registry config correct</span><br></pre></td></tr></tbody></table></figure><p>在 <code>file.conf</code> 配置文件中，<code>service.vgroupMapping</code> 支持配置多个：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service.vgroupMapping.user-service-group=default</span><br><span class="line">service.vgroupMapping.order-service-group=default</span><br><span class="line">service.vgroupMapping.account-service-group=default</span><br><span class="line">service.vgroupMapping.storage-service-group=default</span><br></pre></td></tr></tbody></table></figure><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a target="_blank" rel="external nofollow" href="https://www.jianshu.com/p/ee4071d0c951">分布式事务解决方案</a></li><li><a target="_blank" rel="external nofollow" href="https://zhuanlan.zhihu.com/p/100279671">微服务分布式事务 4 种解决方案实战</a></li><li><a target="_blank" rel="external nofollow" href="https://wenku.baidu.com/view/be946bec0975f46527d3e104.html">大规模 SOA 系统中的分布事务处事（程立）</a></li></ul><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/e8b71fbe.html" title="Seata 入门教程 - 基础篇（2020 年）">https://www.techgrow.cn/posts/e8b71fbe.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag"><i class="fa fa-tag"></i> 分布式</a><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="fa fa-tag"></i> 微服务</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/63e3926c.html" rel="prev" title="Sentinel 入门教程 - 整合篇（2020 年）"><i class="fa fa-angle-left"></i> Sentinel 入门教程 - 整合篇（2020 年）</a></div><div class="post-nav-item"> <a href="/posts/84d3f3e6.html" rel="next" title="Seata 入门教程 - 中级篇（2020 年）">Seata 入门教程 - 中级篇（2020 年）<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">1.5m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">23:22</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤 ICP 备 19024664 号</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035 号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"/lib/mermaid/dist/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/app/api/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/app/api/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/e8b71fbe.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>