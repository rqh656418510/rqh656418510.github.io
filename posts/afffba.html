<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要记录 Java 内存溢出异常的排查和处理。"><meta property="og:type" content="article"><meta property="og:title" content="Java 内存溢出异常的排查和处理"><meta property="og:url" content="https://www.techgrow.cn/posts/afffba.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要记录 Java 内存溢出异常的排查和处理。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/02/java-oom-1.png"><meta property="article:published_time" content="2020-03-21T15:42:35.000Z"><meta property="article:modified_time" content="2020-03-21T15:42:35.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="Java"><meta property="article:tag" content="Linux运维"><meta property="article:tag" content="开发工具"><meta property="article:tag" content="JVM 虚拟机"><meta property="article:tag" content="并发编程"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2025/02/java-oom-1.png"><link rel="canonical" href="https://www.techgrow.cn/posts/afffba.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/afffba.html","path":"posts/afffba.html","title":"Java 内存溢出异常的排查和处理"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Java 内存溢出异常的排查和处理 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA%E4%B9%8B%E6%97%A0%E6%B3%95%E5%88%9B%E5%BB%BA%E6%96%B0%E7%BA%BF%E7%A8%8B"><span class="nav-text">内存溢出之无法创建新线程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E6%8F%8F%E8%BF%B0"><span class="nav-text">错误描述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E5%88%86%E6%9E%90"><span class="nav-text">错误分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E6%AD%A5%E9%AA%A4%E4%B8%80"><span class="nav-text">分析步骤一</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E6%AD%A5%E9%AA%A4%E4%BA%8C"><span class="nav-text">分析步骤二</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E6%AD%A5%E9%AA%A4%E4%B8%89"><span class="nav-text">分析步骤三</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B"><span class="nav-text">操作示例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E7%BA%BF%E7%A8%8B%E5%A0%86%E6%A0%88%E4%BF%A1%E6%81%AF"><span class="nav-text">分析线程堆栈信息</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E7%BA%BF%E7%A8%8B%E5%A0%86%E6%A0%88-dump-%E6%96%87%E4%BB%B6"><span class="nav-text">生成线程堆栈 dump 文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E7%BA%BF%E7%A8%8B%E5%A0%86%E6%A0%88-dump-%E6%96%87%E4%BB%B6"><span class="nav-text">分析线程堆栈 dump 文件</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E6%9C%80%E5%A4%A7%E5%8F%AF%E6%89%93%E5%BC%80%E6%96%87%E4%BB%B6%E6%95%B0"><span class="nav-text">设置最大可打开文件数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-text">最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#XXL-JOB-%E6%97%A0%E6%B3%95%E5%88%9B%E5%BB%BA%E6%96%B0%E7%BA%BF%E7%A8%8B"><span class="nav-text">XXL-JOB 无法创建新线程</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">705</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">53</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/afffba.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Java 内存溢出异常的排查和处理 | Clay 的技术空间"><meta itemprop="description" content="本文主要记录 Java 内存溢出异常的排查和处理。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Java 内存溢出异常的排查和处理</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-03-21 23:42:35" itemprop="dateCreated datePublished" datetime="2020-03-21T23:42:35+08:00">2020-03-21</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/afffba.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/afffba.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>4.5k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>4 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/e0671e6d.html">JMeter 压测教程之二 JVM 调优</a></li><li><a href="/posts/b365ed8e.html">Linux 服务器 CPU 负载过高的定位分析</a></li><li><a href="/posts/62936140.html">Java 虚拟机入门教程之五 JVM 性能优化</a></li></ul><h2 id="内存溢出之无法创建新线程"><a href="#内存溢出之无法创建新线程" class="headerlink" title="内存溢出之无法创建新线程"></a>内存溢出之无法创建新线程</h2><h3 id="错误描述"><a href="#错误描述" class="headerlink" title="错误描述"></a>错误描述</h3><p>Java 应用抛出 <code>OutOfMemoryError</code> 异常，如下所示：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">java.lang.OutOfMemoryError: unable to create native thread: possibly out of memory or process/resource limits reached</span><br><span class="line">	at java.base/java.lang.Thread.start0(Native Method)</span><br><span class="line">	at java.base/java.lang.Thread.start(Thread.java:803)</span><br><span class="line">	at java.base/java.util.concurrent.ThreadPoolExecutor.addWorker(ThreadPoolExecutor.java:937)</span><br><span class="line">	at java.base/java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1343)</span><br><span class="line">	at java.base/java.util.concurrent.AbstractExecutorService.submit(AbstractExecutorService.java:140)</span><br><span class="line">	at java.base/java.util.concurrent.Executors$DelegatedExecutorService.submit(Executors.java:719)</span><br><span class="line">	at org.springframework.cloud.commons.util.InetUtils.convertAddress(InetUtils.java:163)</span><br><span class="line">	at org.springframework.cloud.commons.util.InetUtils.findFirstNonLoopbackHostInfo(InetUtils.java:66)</span><br><span class="line">	at org.springframework.cloud.client.HostInfoEnvironmentPostProcessor.getFirstNonLoopbackHostInfo(HostInfoEnvironmentPostProcessor.java:66)</span><br></pre></td></tr></tbody></table></figure><span id="more"></span><h3 id="错误分析"><a href="#错误分析" class="headerlink" title="错误分析"></a>错误分析</h3><h4 id="分析步骤一"><a href="#分析步骤一" class="headerlink" title="分析步骤一"></a>分析步骤一</h4><p>Java 异常 <code>java.lang.OutOfMemoryError</code> 一共有 8 种类型，其中 <code>java.lang.OutOfMemoryError: unable to create new native thread</code> 这类异常通常发生在应用试图创建新线程时。可能原因如下：</p><ul><li><strong>系统内存耗尽</strong>：操作系统无法为新线程分配内存。</li><li><strong>应用创建了过多线程</strong>：应用创建的线程数量超过了操作系统的限制。</li><li><strong>操作系统限制</strong>：操作系统并不允许应用程序创建这么多线程，Linux 系统默认允许单个进程可以创建的线程数是 1024 个，当应用创建超过这个数量的线程，就会抛出 OOM 异常。</li></ul><p>当遇到 <code>java.lang.OutOfMemoryError：unable to create new native thread</code> 异常时，可以使用以下方法排除解决：</p><ul><li>通过监控在发生 OOM 之前，服务器剩余物理内存、进程创建的线程数以及 <code>ulimit -n</code> 的结果进行综合排查解决。</li><li>同时，可以通过 <code>jstack -l</code> 命令将线程栈 dump 下来，进一步分析具体是哪里创建了线程，是否合理。</li><li>常见因分析及解决方案：<ul><li>(1) 创建了过多的线程：减少线程数。</li><li>(2) 操作系统对线程数的限制：调大线程数限制。</li><li>(3) 服务器内存不足：增加物理内存。</li><li>(4) 进程的堆内存太大：减小堆内存大小。</li><li>(5) 服务器的进程数太多：减少进程数。</li><li>(6) 线程栈的太大：调小线程栈。</li></ul></li></ul><div class="admonition warning"><p class="admonition-title">特别注意</p><p>通过分析，上述 OOM 异常通常与 JVM 的虚拟机栈和本地方法栈的内存溢出有关，出现该问题的情况有两种：<strong>一种是创建的线程过多，另一种是线程数量不多但是内存空间不足。</strong></p></div><h4 id="分析步骤二"><a href="#分析步骤二" class="headerlink" title="分析步骤二"></a>分析步骤二</h4><ul><li>查看系统当前的线程总数</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -eLf | wc -l</span><br></pre></td></tr></tbody></table></figure><ul><li>使用 Shell 脚本查看每个 Java 应用创建的线程数量</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">ps aux | grep java | grep -v grep | awk <span class="string">'{print $2, $NF}'</span> | <span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">    pid=$(<span class="built_in">echo</span> <span class="variable">$line</span>| awk <span class="string">'{print $1}'</span>)</span><br><span class="line">    pidname=$(<span class="built_in">echo</span> <span class="variable">$line</span>| awk <span class="string">'{print $2}'</span>)</span><br><span class="line">    pid_count=$(ps huH p <span class="variable">${pid}</span> | wc -l)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"pid: <span class="variable">${pid}</span>	线程数: <span class="variable">${pid_count}</span>	应用: <span class="variable">${pidname}</span>"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></tbody></table></figure><h4 id="分析步骤三"><a href="#分析步骤三" class="headerlink" title="分析步骤三"></a>分析步骤三</h4><p>使用 <code>ulimit</code> 命令，查看系统对进程资源的控制.。<strong>特别注意：必须在当前使用的用户下排查，因为不同用户会有不同的资源限制规则。</strong></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看单个进程可打开的最大文件数</span></span><br><span class="line"><span class="built_in">ulimit</span> -n</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看单个用户可创建的最大进程数</span></span><br><span class="line"><span class="built_in">ulimit</span> –u</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 查看进程可用的最大虚拟内存</span></span><br><span class="line"><span class="built_in">ulimit</span> -v</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 查看进程可用的最大栈大小</span></span><br><span class="line"><span class="built_in">ulimit</span> -s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看进程的所有资源限制</span></span><br><span class="line"><span class="built_in">ulimit</span> -a</span><br></pre></td></tr></tbody></table></figure><p>比如，执行 <code>ulimit -a</code> 命令，输出以下信息：</p><p><img data-src="../../../asset/2025/02/java-oom-1.png"></p><p>重点留意以下几个参数的值是否设置得当：</p><ul><li><code>open files</code>：单个进程能打开的最大文件数（<code>ulimit -n</code>）。</li><li><code>max user processes</code>：单个用户的最大并发进程数（<code>ulimit -u</code>）。</li><li><code>stack size</code>：进程栈的最大大小（<code>ulimit -s</code>）。</li><li><code>cpu time</code>：进程的最大 CPU 时间（<code>ulimit -t</code>）。</li><li><code>virtual memory</code>：进程可用的最大虚拟内存（<code>ulimit -v</code>）。</li><li><code>resident set size</code>：最大物理内存占用（<code>ulimit -m</code>，可能不适用）。</li></ul><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><ul><li><p><strong>排查应用是否创建了过多的线程</strong>：</p><ul><li>通过 <code>jstack -l</code> 命令确定应用创建了多少线程，超量创建的线程的堆栈信息，以及是谁创建了这些线程。一旦明确这些问题，便很容易解决。</li></ul></li><li><p><strong>调整操作系统线程数阈值</strong>：</p><ul><li>操作系统会限制进程允许创建的最大线程数，使用 <code>ulimit -u</code> 命令查看限制。</li><li>某些服务器上此阈值默认设置得过小，比如 <code>1024</code>。一旦应用创建超过 1024 个线程，就会遇到 <code>java.lang.OutOfMemoryError: unable to create new native thread</code> 异常。如果是这种情况，可以尝试增大操作系统线程数阈值。</li></ul></li><li><p><strong>增加服务器内存</strong>：</p><ul><li>如果上述两项未能排除问题，可能是正常增长的业务确实需要更多内存来创建更多线程。如果是这种情况，考虑增加服务器内存（物理内存）。</li></ul></li><li><p><strong>减小堆内存</strong>：</p><ul><li>在 Java 中，当创建一个线程时，会在 JVM 内存中创建一个内存对象，同时还会创建一个操作系统线程，而这个操作系统线程的内存不是使用 JVM 内存的，而是使用操作系统中剩下的物理内存。因此，即使 Java 堆内存是充足的，如果剩余的物理内存太小，无法满足更多操作系统线程创建所需的内存时，也会抛出 OOM 异常。</li><li>换而言之，给 JVM 分配的内存越多，能创建的线程数就越少，也就是越容易发生 <code>OutOfMemoryError</code> 异常。这说明不是 JVM 内存不够，而是因为线程消耗的是操作系统内存。线程不在 JVM 的堆内存上创建，而是在堆内存之外的内存上创建。</li><li>所以，如果分配了 JVM 堆内存后只剩下很少的可用物理内存，依然可能遇到 <code>java.lang.OutOfMemoryError: unable to create new native thread</code> 异常。</li><li>考虑如下场景：系统总内存 6G，堆内存分配了 5G，永久代 512M。在这种情况下，JVM 占用了 5.5G 内存，系统进程、其他用户进程和线程将共用剩下的 0.5G 内存，很有可能没有足够的可用内存创建新的线程。如果是这种情况，可以考虑减小堆内存的大小。</li></ul></li><li><p><strong>减少进程数</strong>：</p><ul><li>这和减小 JVM 堆内存的原理相似，考虑如下场景：系统总内存 32G，Java 进程数 5 个，每个进程的堆内存 6G。</li><li>在这种情况下，Java 进程总共占用 30G 内存，仅剩下 2G 内存用于系统进程、其他用户进程和线程，很有可能没有足够的可用内存创建新的线程。如果是这种情况，可以考虑减少每台机器上的进程数。</li></ul></li><li><p><strong>减小单个线程栈大小（-Xss 参数设置）</strong>：</p><ul><li>线程会占用内存，如果每个线程都占用更多内存，那么整体上将消耗更多的内存。</li><li>每个线程默认占用的内存大小取决于 JVM 实现，可以使用 JVM 的 <code>-Xss</code> 参数来限制单个线程栈大小，以此降低线程的总内存消耗。</li><li>早期 JVM 默认每个线程占用 256K 内存，现在一般为 1M 内存。假设要创建 500 个线程，如果每个线程需要 1M 内存，那么所有线程占用的总内存为 500M。</li><li>如果实际上 256K 内存足够线程正常运行，配置 <code>-Xss256k</code>，那么 500 个线程将只需要消耗 125M 内存，也就是只需要原本所占内存的四分之一。</li><li><strong>特别注意</strong>，如果线程栈大小通过 JVM 参数 <code>-Xss</code> 设置得过小，当线程请求分配的栈内存不足时，将会抛出 StackOverflowError 异常。</li></ul></li></ul><div class="admonition note"><p class="admonition-title">如何计算 Java 进程可创建的最大线程数量</p><ul><li>可创建最大线程数量的计算公式：<code>(MaxProcessMemory – JVMMemory – ResverdOsMemory) / ThreadStackSize = 线程数量</code></li><li><code>MaxProcessMemory</code>：一个进程最多使用的内存大小。</li><li><code>JVMMemory</code>：JVM 的堆内存大小，也就是 Heap。因为只能设置堆的大小，这个的值是堆的最小值 + PermGen 的大小。</li><li><code>ResverdOsMemory</code>：操作系统保留的内存，也就是操作系统内核使用的，一般为 120M。</li><li><code>ThreadStackSize</code>：线程栈的大小，单位为字节（byte），所以上面的公式要统一换成字节来计算。系统有 64G 内存，就算不适用公式计算也应该知道内存是绝对够用的。那到底是什么问题呢？</li></ul></div><h3 id="操作示例"><a href="#操作示例" class="headerlink" title="操作示例"></a>操作示例</h3><h4 id="分析线程堆栈信息"><a href="#分析线程堆栈信息" class="headerlink" title="分析线程堆栈信息"></a>分析线程堆栈信息</h4><p>使用 <code>jstack</code> 工具将 Java 进程的线程堆栈信息 dump 出来，并分析 <code>java.lang.OutOfMemoryError: unable to create new native thread</code> 问题的步骤如下。</p><h5 id="生成线程堆栈-dump-文件"><a href="#生成线程堆栈-dump-文件" class="headerlink" title="生成线程堆栈 dump 文件"></a>生成线程堆栈 dump 文件</h5><ul><li>(1) 获取 Java 进程的 ID（即 PID）</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jps -l</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 或者</span></span><br><span class="line">ps -aux|grep java</span><br></pre></td></tr></tbody></table></figure><ul><li>(2) 生成线程堆栈 dump 文件</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jstack -l PID &gt; thread_dump.txt</span><br></pre></td></tr></tbody></table></figure><p>如果 Java 进程已崩溃，可以使用以下命令强制生成线程堆栈 dump 文件</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jstack -F PID &gt; thread_dump_force.txt</span><br></pre></td></tr></tbody></table></figure><h5 id="分析线程堆栈-dump-文件"><a href="#分析线程堆栈-dump-文件" class="headerlink" title="分析线程堆栈 dump 文件"></a>分析线程堆栈 dump 文件</h5><ul><li>(1) 使用 <code>grep</code> 统计线程数（如果线程数过多，可能是程序创建了过多线程，导致操作系统无法创建新的本地线程）</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">'tid='</span> thread_dump.txt | wc -l</span><br></pre></td></tr></tbody></table></figure><ul><li>(2) 还可以结合 <code>ps</code> 命令查看特定进程的线程数</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -eLf | grep PID | wc -l</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 或者（显示当前内核认定的线程数，数据相对来说更准确）</span></span><br><span class="line">cat /proc/PID/status | grep Threads </span><br></pre></td></tr></tbody></table></figure><ul><li>(3) 检查线程创建来源，在 <code>thread_dump.txt</code> 中，找到可疑的线程，比如：</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打开线程堆栈 dump 文件</span></span><br><span class="line">vi thread_dump.txt</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">"pool-1-thread-1" #22 prio=5 os_prio=0 tid=0x00007f45c80a8000 nid=0x5a13 runnable [0x00007f45c81af000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">   at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)</span><br><span class="line">   at java.lang.Thread.run(Thread.java:748)</span><br></pre></td></tr></tbody></table></figure><ul><li>内容分析说明：<ul><li><code>tid=...</code> 是 Java 线程的 ID。</li><li><code>nid=...</code> 是本地线程的 ID（可用于与系统级工具关联）。</li><li><code>java.lang.Thread.State: RUNNABLE</code> 表示线程的状态，若有大量线程处于 <code>RUNNABLE</code> 状态，可能存在线程泄漏问题。</li><li><code>ThreadPoolExecutor$Worker.run</code> 说明线程来自 ThreadPoolExecutor 线程池，可能是线程池未正确回收线程导致 OOM。</li></ul></li></ul><h4 id="设置最大可打开文件数"><a href="#设置最大可打开文件数" class="headerlink" title="设置最大可打开文件数"></a>设置最大可打开文件数</h4><p>比如，可以临时设置进程的最大可打开文件数（<code>open files</code>）为 1048576。<strong>特别注意：当前是在哪个用户下进行设置。</strong></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -n 1048576</span><br></pre></td></tr></tbody></table></figure><p>若希望永久设置进程的最大可打开文件数（<code>open files</code>）可以参考以下教程：</p><ul><li><a href="/posts/88a10b.html">Centos 7 更改最大文件描述符数</a></li><li><a href="/posts/a29573a6.html">Debian 12 更改最大文件描述符数</a></li></ul><h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><h4 id="XXL-JOB-无法创建新线程"><a href="#XXL-JOB-无法创建新线程" class="headerlink" title="XXL-JOB 无法创建新线程"></a>XXL-JOB 无法创建新线程</h4><blockquote><p>错误描述</p></blockquote><ul><li>Java 应用（使用了 XXL-JOB 的客户端）使用的 XXL-JOB 阻塞处理策略是 <code>单机串行</code>。</li><li>Java 应用（使用了 XXL-JOB 的客户端）运行一段较长时间后，会抛出 <code>java.lang.OutOfMemoryError: unable to create native thread</code>。</li></ul><blockquote><p>错误分析</p></blockquote><ul><li><p>在 XXL-JOB 中，任务调度通常涉及线程池管理，而单机串行阻塞策略的特点是：</p><ul><li>同一时间只执行一个任务，后续任务必须等待前面的任务完成。</li><li>如果任务执行时间过长，调度中心不断触发新的任务，导致大量任务堆积在任务队列中。</li><li>任务堆积会导致线程池持续创建新线程，最终可能超过操作系统允许的最大线程数，触发 <code>java.lang.OutOfMemoryError: unable to create native thread</code>。</li></ul></li><li><p>导致 XXL-JOB 抛出 OOM 异常的核心因素：</p><ul><li>线程池溢出：<ul><li>由于新任务不断提交，但老任务未处理，线程池可能不断扩容，最终线程总数达到 <code>maxPoolSize</code>，无法再创建新的线程。</li></ul></li><li>系统线程数限制：<ul><li>Linux 系统默认限制单个进程最多创建 1024 个线程（<code>ulimit -u</code>）。</li><li>当任务积压时，XXL-JOB 可能会尝试创建更多线程，但超出系统限制后，就会抛出 OOM 异常。</li></ul></li><li>堆外内存耗尽：<ul><li>每个线程都会占用一定的堆外内存（Native Memory），如果线程数过多，可能会耗尽堆外内存（操作系统内存），导致 OOM 发生，即使 JVM 堆内存是足够的。</li></ul></li></ul></li></ul><blockquote><p>解决方案</p></blockquote><ul><li>根据 <a href="/posts/afffba.html#%E9%94%99%E8%AF%AF%E5%88%86%E6%9E%90">错误分析步骤</a>，排查一下是否因系统资源限制（比如：单个进程能打开的最大文件数），导致业务应用无法创建新的线程。</li><li>可参考的解决方案：<ul><li>(1) 提高操作系统的最大线程数限制，比如使用命令：<code>ulimit -n 1048576</code>。</li><li>(2) 使用 <code>-Xss</code> 参数降低 JVM 线程栈的大小，减少内存占用，比如：<code>java -Xss256k -jar app.jar</code>。</li><li>(3) 如果 XXL-JOB 客户端的线程池使用了 <code>LinkedBlockingQueue</code>（默认是无界队列），更改为使用有界队列（如 <code>ArrayBlockingQueue</code>），避免任务无限堆积导致抛出 OOM 异常。</li><li>(4) XXL-JOB 的阻塞处理策略主要有三种：单机串行、丢弃后续调度和覆盖之前调度‌，更改阻塞处理策略为 <code>丢弃后续调度</code>（适用于幂等任务），避免任务大量堆积。</li><li>(5) 优化任务处理逻辑，比如：(a) 拆分长任务，避免单个任务执行时间过长。(b) 使用分布式调度（利用分片广播的路由策略），减少单机压力。</li></ul></li></ul><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/GodGreat199383/article/details/122012594">Java 内存溢出导致无法创建新线程</a></li><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/qq_36488864/article/details/132097748">记录一次内存溢出异常的排查和处理</a></li></ul><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/afffba.html" title="Java 内存溢出异常的排查和处理">https://www.techgrow.cn/posts/afffba.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/Java/" rel="tag"><i class="fa fa-tag"></i> Java</a><a href="/tags/Linux%E8%BF%90%E7%BB%B4/" rel="tag"><i class="fa fa-tag"></i> Linux运维</a><a href="/tags/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" rel="tag"><i class="fa fa-tag"></i> 开发工具</a><a href="/tags/JVM-%E8%99%9A%E6%8B%9F%E6%9C%BA/" rel="tag"><i class="fa fa-tag"></i> JVM 虚拟机</a><a href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" rel="tag"><i class="fa fa-tag"></i> 并发编程</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/817c7d82.html" rel="prev" title="Linux 必要命令摘要"><i class="fa fa-angle-left"></i> Linux 必要命令摘要</a></div><div class="post-nav-item"> <a href="/posts/168c8788.html" rel="next" title="C 语言基础语法之一数据类型与运算符">C 语言基础语法之一数据类型与运算符<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">1.8m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">27:58</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"/lib/mermaid/dist/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/afffba.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>