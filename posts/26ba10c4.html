<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要记录 ElasticSearch 日常开发的笔记。"><meta property="og:type" content="article"><meta property="og:title" content="ElasticSearch 开发随笔"><meta property="og:url" content="https://www.techgrow.cn/posts/26ba10c4.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要记录 ElasticSearch 日常开发的笔记。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/07/es-filesystem-cache.png"><meta property="article:published_time" content="2022-12-20T13:12:35.000Z"><meta property="article:modified_time" content="2022-12-20T13:12:35.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="开发随笔"><meta property="article:tag" content="搜索引擎"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2025/07/es-filesystem-cache.png"><link rel="canonical" href="https://www.techgrow.cn/posts/26ba10c4.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/26ba10c4.html","path":"posts/26ba10c4.html","title":"ElasticSearch 开发随笔"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>ElasticSearch 开发随笔 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#ElasticSearch-%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%80%89%E6%8B%A9"><span class="nav-text">ElasticSearch 客户端选择</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E7%A7%8D%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text">第一种客户端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E7%A7%8D%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text">第二种客户端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8D%E5%90%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AF%B9%E6%AF%94"><span class="nav-text">不同客户端对比</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ElasticSearch-%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BD%BF%E7%94%A8"><span class="nav-text">ElasticSearch 客户端使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%95%E5%85%A5-Maven-%E5%9D%90%E6%A0%87"><span class="nav-text">引入 Maven 坐标</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Java-%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="nav-text">Java 配置类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Java-%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="nav-text">Java 测试代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ElasticSearch-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-text">ElasticSearch 性能优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%A0%E5%8D%81%E4%BA%BF%E6%95%B0%E6%8D%AE%E9%87%8F%E7%9A%84%E5%9C%BA%E6%99%AF%E4%B8%8B%E4%BC%98%E5%8C%96%E6%9F%A5%E8%AF%A2%E6%80%A7%E8%83%BD"><span class="nav-text">几十亿数据量的场景下优化查询性能</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">768</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">54</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/26ba10c4.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="ElasticSearch 开发随笔 | Clay 的技术空间"><meta itemprop="description" content="本文主要记录 ElasticSearch 日常开发的笔记。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> ElasticSearch 开发随笔</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-12-20 21:12:35" itemprop="dateCreated datePublished" datetime="2022-12-20T21:12:35+08:00">2022-12-20</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/26ba10c4.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/26ba10c4.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>6.9k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>6 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="ElasticSearch-客户端选择"><a href="#ElasticSearch-客户端选择" class="headerlink" title="ElasticSearch 客户端选择"></a>ElasticSearch 客户端选择</h2><h3 id="第一种客户端"><a href="#第一种客户端" class="headerlink" title="第一种客户端"></a>第一种客户端</h3><p>基于 TCP 协议（ES 的 9300 端口，用于集群通信），依赖 <code>spring-data-elasticsearch:transport-api.jar</code>，此方式的缺点如下：</p><ul><li>SpringBoot 版本不同， 依赖的 <code>transport-api.jar</code> 版本也就不同，不能适配不同版本的 ES</li><li> 从 ES <code>7.x</code> 版本开始，官方已经不建议使用 9300 端口来操作，而且 ES <code>8.x</code> 以后就要移除该操作方式</li></ul><h3 id="第二种客户端"><a href="#第二种客户端" class="headerlink" title="第二种客户端"></a>第二种客户端</h3><p>基于 HTTP 协议（ES 的 9200 端口，用于 RESTful API），可选的客户端如下：</p><ul><li>RestTemplate、HttpClient、OkHttp：直接发送 HTTP 请求，ES 的很多操作需要自己封装，使用起来比较麻烦</li><li> Elasticsearch-Rest-Client：官方的 Rest 客户端，分为 <code>Java Low Level REST Client</code> 和 <code>Java High Level REST Client</code>，API 层次分明，上手简单</li></ul><span id="more"></span><h3 id="不同客户端对比"><a href="#不同客户端对比" class="headerlink" title="不同客户端对比"></a>不同客户端对比</h3><table><thead><tr><th>客户端</th><th>优点</th><th>缺点</th><th>说明</th></tr></thead><tbody><tr><td> Java Low Level Rest Client</td><td> 与 ES 版本之间没有关系，适用于作为所有版本 ES 的客户端</td><td></td><td>可以看做是低级的 HTTP 客户端，没有封装过多的 ES 操作</td></tr><tr><td> Java High Level Rest Client</td><td> 使用最多</td><td>使用时必须与 ES 版本保持一致</td><td>基于 Low Level Rest Client，但在 ES <code>7.15.0</code> 版本之后被弃用</td></tr><tr><td> TransportClient</td><td> 使用 Transport 端口 (9300) 进行通信，能够使用 ES 集群中的一些特性，性能最好</td><td> JAR 包版本必须与 ES 集群版本一致，ES 集群升级，客户端也要跟着升级到相同版本</td><td>已过时，官方从 ES 7 版本开始不建议使用，ES 8 版本之后被移除</td></tr><tr><td> Elasticsearch Java API Client</td><td> 最新的 ES 客户端</td><td>文档较少</td><td></td></tr></tbody></table><div class="admonition note"><p class="admonition-title">提示</p><p>关于更多的 Elasticsearch 客户端说明，建议阅读 <a target="_blank" rel="external nofollow" href="https://www.elastic.co/guide/en/elasticsearch/client/index.html">官方文档</a>。</p></div><h2 id="ElasticSearch-客户端使用"><a href="#ElasticSearch-客户端使用" class="headerlink" title="ElasticSearch 客户端使用"></a>ElasticSearch 客户端使用</h2><p>下面将简单介绍 SpringBoot 项目如何引入 <code>Java High Level Rest Client</code>，由于 SpringBoot Starter 默认依赖了某版本的 Elasticsearch，因此需要在 <code>pom.xml</code> 配置文件中使用 <code>&lt;elasticsearch.version&gt;</code> 来指定（覆盖） Elasticsearch 的实际版本号，否则会出现兼容性问题。</p><h3 id="引入-Maven-坐标"><a href="#引入-Maven-坐标" class="headerlink" title="引入 Maven 坐标"></a>引入 Maven 坐标</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">elasticsearch.version</span>&gt;</span>7.4.2<span class="tag">&lt;/<span class="name">elasticsearch.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>${elasticsearch.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h3 id="Java-配置类"><a href="#Java-配置类" class="headerlink" title="Java 配置类"></a>Java 配置类</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClientBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticSearchConfig</span> </span>{</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> RequestOptions COMMON_OPTIONS;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> {</span><br><span class="line">        <span class="comment">// 基础配置信息</span></span><br><span class="line">        String token = <span class="string">""</span>;</span><br><span class="line">        RequestOptions.Builder builder = RequestOptions.DEFAULT.toBuilder();</span><br><span class="line">        <span class="comment">// builder.addHeader("Authorization", "Bearer " + token);</span></span><br><span class="line">        <span class="comment">// builder.setHttpAsyncResponseConsumerFactory(</span></span><br><span class="line">        <span class="comment">// new HttpAsyncResponseConsumerFactory.HeapBufferedResponseConsumerFactory(30 * 1024 * 1024 * 1024));</span></span><br><span class="line">        COMMON_OPTIONS = builder.build();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义 ES 客户端</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ES 客户端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestHighLevelClient <span class="title">restHighLevelClient</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// 指定ES的连接地址</span></span><br><span class="line">        RestClientBuilder builder = RestClient.builder(<span class="keyword">new</span> HttpHost(<span class="string">"127.0.0.1"</span>, <span class="number">9200</span>, <span class="string">"http"</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestHighLevelClient(builder);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="Java-测试代码"><a href="#Java-测试代码" class="headerlink" title="Java 测试代码"></a>Java 测试代码</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSON;</span><br><span class="line"><span class="keyword">import</span> com.clay.gulimall.search.config.ElasticSearchConfig;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.index.IndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.index.IndexResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHits;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.AggregationBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.Aggregations;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.bucket.terms.Terms;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.bucket.terms.TermsAggregationBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.metrics.Avg;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.metrics.AvgAggregationBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticSearchApiTest</span> </span>{</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient esClient;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建索引数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">indexData</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        IndexRequest request = <span class="keyword">new</span> IndexRequest(<span class="string">"posts"</span>).id(<span class="string">"1"</span>)</span><br><span class="line">                .source(<span class="string">"user"</span>, <span class="string">"Jim"</span>, <span class="string">"postDate"</span>, <span class="keyword">new</span> Date(), <span class="string">"message"</span>, <span class="string">"trying out ElasticSearch"</span>);</span><br><span class="line">        </span><br><span class="line">        IndexResponse indexResponse = esClient.index(request, ElasticSearchConfig.COMMON_OPTIONS);</span><br><span class="line">        log.info(JSON.toJSONString(indexResponse));</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 聚合查询</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; 查询 address 中包含 mill 的所有人的年龄分布以及平均薪资</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">searchData</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest();</span><br><span class="line">        <span class="comment">// 指定索引</span></span><br><span class="line">        searchRequest.indices(<span class="string">"bank"</span>);</span><br><span class="line">        <span class="comment">// 检索条件</span></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.matchQuery(<span class="string">"address"</span>, <span class="string">"mill"</span>));</span><br><span class="line">        <span class="comment">// 按照年龄的分布进行聚合</span></span><br><span class="line">        TermsAggregationBuilder ageAgg = AggregationBuilders.terms(<span class="string">"group_by_age"</span>).field(<span class="string">"age"</span>).size(<span class="number">100</span>);</span><br><span class="line">        searchSourceBuilder.aggregation(ageAgg);</span><br><span class="line">        <span class="comment">// 计算所有人的平均薪资</span></span><br><span class="line">        AvgAggregationBuilder avgBalance = AggregationBuilders.avg(<span class="string">"avgBalance"</span>).field(<span class="string">"balance"</span>);</span><br><span class="line">        searchSourceBuilder.aggregation(avgBalance);</span><br><span class="line">        <span class="comment">// 执行检索</span></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line">        SearchResponse searchResponse = esClient.search(searchRequest, ElasticSearchConfig.COMMON_OPTIONS);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取搜索结果</span></span><br><span class="line">        SearchHits searchHits = searchResponse.getHits();</span><br><span class="line">        SearchHit[] hitArray = searchHits.getHits();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hitArray) {</span><br><span class="line">            String recored = hit.getSourceAsString();</span><br><span class="line">            log.info(<span class="string">"id: {}, data: {}"</span>, hit.getId(), recored);</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取聚合结果 - 年龄的分布</span></span><br><span class="line">        Aggregations aggregations = searchResponse.getAggregations();</span><br><span class="line">        Terms terms = aggregations.get(<span class="string">"group_by_age"</span>);</span><br><span class="line">        <span class="keyword">for</span> (Terms.Bucket bucket : terms.getBuckets()) {</span><br><span class="line">            log.info(<span class="string">"age: {}, total: {}"</span>, bucket.getKeyAsString(), bucket.getDocCount());</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取聚合结果 - 平均薪资</span></span><br><span class="line">        Avg avg = aggregations.get(<span class="string">"avgBalance"</span>);</span><br><span class="line">        log.info(<span class="string">"avg balance: {}"</span>, avg.getValue());</span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">"search params: {}\n"</span>, searchSourceBuilder.toString());</span><br><span class="line">        log.info(<span class="string">"search result: {}\n"</span>, JSON.toJSONString(searchResponse));</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>上述的聚合查询代码，最终发出 HTTP 请求体内容如下：</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">{</span><br><span class="line">    <span class="attr">"query"</span>: {</span><br><span class="line">        <span class="attr">"match"</span>: {</span><br><span class="line">            <span class="attr">"address"</span>: <span class="string">"mill"</span></span><br><span class="line">        }</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"aggs"</span>: {</span><br><span class="line">        <span class="attr">"group_by_age"</span>: {</span><br><span class="line">            <span class="attr">"terms"</span>: {</span><br><span class="line">                <span class="attr">"field"</span>: <span class="string">"age"</span>,</span><br><span class="line">                <span class="attr">"size"</span>: <span class="number">100</span></span><br><span class="line">            }</span><br><span class="line">        },</span><br><span class="line">        <span class="attr">"avgBalance"</span>: {</span><br><span class="line">            <span class="attr">"avg"</span>: {</span><br><span class="line">                <span class="attr">"field"</span>: <span class="string">"balance"</span></span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="ElasticSearch-性能优化"><a href="#ElasticSearch-性能优化" class="headerlink" title="ElasticSearch 性能优化"></a>ElasticSearch 性能优化</h2><h3 id="几十亿数据量的场景下优化查询性能"><a href="#几十亿数据量的场景下优化查询性能" class="headerlink" title="几十亿数据量的场景下优化查询性能"></a>几十亿数据量的场景下优化查询性能</h3><p>这是一道高频的 BAT 面试题：”ES 在几十亿数据量的场景下如何优化查询性能”，详细的答题思路如下。</p><blockquote><p>面试官心理分析</p></blockquote><p>问这个问题，其实是个判断题 —— 说白了，就是看你有没有真正用过 ES 在线上项目中 “实际干过”。为什么这么说？因为 ES 的性能并没有你想象中那么强大。在数据量较小时，ES 确实很快，做个 Demo 也没啥问题。但一旦数据量上了规模，尤其是达到几亿条记录的时候，你可能就会懵了：怎么一个搜索请求突然耗时 5 到 10 秒，简直坑爹。第一次查询特别慢，甚至感觉系统卡住了；但同样的查询第二次、第三次却非常快，只需要几百毫秒。这就让人很困惑：难道每个用户第一次访问的时候都会特别慢、特别卡顿吗？如果你没在真实项目中用过 ES，或者只是自己本地跑跑 Demo，那么面对这个问题可能就会懵，甚至答不上来。这其实很容易暴露出你对 ES 的理解还停留在 “会用” 而不是 “精通” 的阶段。</p><blockquote><p>面试题剖析</p></blockquote><p>说实话，ES 在性能优化上是没有 “银弹” 的。什么意思呢？就是不要指望随手调一个参数，就能万能地解决所有性能瓶颈。有些场景下，确实可能通过调整参数或优化查询语法获得明显提升，但这绝对不是普遍适用的解决方案。所以，我们要分场景、分模块，一步步系统性地分析优化手段。以我们在生产环境中的实际经验来看，在海量数据（例如上亿级别）场景下，提升 ES 搜索性能最关键的一招，就是 —— <strong>充分利用操作系统的文件系统缓存（FileSystem Cache）</strong>。</p><ul><li>什么是 Filesystem Cache？<ul><li>ES 写入数据时，底层实际上是将索引数据写入磁盘上的 Segment File。操作系统会自动将这些磁盘文件的数据缓存在内存中，这部分缓存就叫 Page Cache（操作系统页缓存），也称为 FileSystem Cache。</li><li>ES 没有自己的独立缓存机制（除了 FieldData、Query Cache 等小部分），它非常依赖 Page Cache 来实现索引数据的快速访问。</li></ul></li><li>为什么 FileSystem Cache 对搜索性能至关重要？<ul><li>ES 搜索引擎在查询时并不会直接访问磁盘，而是尽可能从操作系统的 FileSystem Cache 中读取索引数据。如果你的服务器有足够的内存，能够容纳所有的 Segment File（也就是整个索引的元数据和倒排索引结构），那么搜索请求大多数都会命中内存，这时候性能就非常高了。</li></ul></li><li>ES 线上测试结果显示：<ul><li>ES 命中 FileSystem Cache 的查询，通常只需要耗时几毫秒到几百毫秒；</li><li>而 ES 未命中 FileSystem Cache，走磁盘 I/O 的查询，则可能耗时 1 秒、5 秒，甚至 10 秒以上。</li></ul></li></ul><p>这个性能差距是一个数量级的！因此，如果你发现 ES 查询慢，第一步要考虑的不是乱调参数，而是先排查 —— 你的服务器内存是否足够大？是否足以承载索引的全部 Segment File？是否频繁发生 Cache Miss（缓存未命中）？</p><blockquote><p>真实案例分析</p></blockquote><p>这里举一个线上真实案例：张三公司有一个 ES 集群，共有 3 台机器，每台机器配有 64GB 内存，那么总内存是 <code>64 * 3 = 192GB</code>。你为每台节点配置了 32GB 的 JVM Heap（这是官方推荐的上限），这样每台机器剩下的可用于 FileSystem Cache（也就是操作系统页缓存）的内存就是 <code>64GB - 32GB = 32GB</code>，整个集群加起来留给 FileSystem Cache 的总内存只有 <code>32GB * 3 = 96GB</code>。接着我问他：” 你们现在 ES 中到底存了多少数据？” 他们说 3 台机器总共存了大约 1TB 的索引数据，也就是说每台机器大概承载了 300 多 GB 的 Segment File，而每台机器只有 32GB 内存用于缓存这些索引数据，仅仅能容纳不到 10% 的索引数据，其余 90% 只能从磁盘读取。你觉得在这种情况下，搜索性能能好吗？显然，大多数搜索请求都会落到磁盘，性能自然就非常差。这就是他们在测试环境中发现搜索非常慢的根本原因：以为用了 64GB 内存的高配机器就能轻松撑住 1TB 的数据量，实际上远远不够。</p><p>要想让 ES 在大数据量场景下依然保持高性能，必须尽可能让内存承载尽量多的索引文件，也就是 Segment File 的数据。最佳实践是：集群中留给 FileSystem Cache 的总内存，至少应该达到实际索引数据量的一半甚至更多。比如你要在 ES 中存储 1TB 的索引数据，那你至少应该确保集群中用于 FileSystem Cache 的可用内存达到 512GB 或更多，这样大部分热数据都能命中内存，查询性能才能稳定在 2 秒、3 秒以内，甚至低于 1 秒。否则，如果大多数查询都落到磁盘上，哪怕你机器再多、JVM 配置再高，也优化不了搜索性能。</p><p><img data-src="../../../asset/2025/07/es-filesystem-cache.png"></p><blockquote><p>面试题答案</p></blockquote><p>ES 在几十亿数据量的场景下，优化查询性能的方案有以下几种：</p><ul><li><p><strong>ES + HBase/MySQL</strong></p><ul><li>根据在生产环境中的实践经验，<strong>想要让 ES 保持高性能，一个核心策略就是尽量减少写入 ES 的数据量，只保留用于检索的必要字段</strong>。比如说，如果每台 ES 机器为 FileSystem Cache 分配了 100GB 内存，那就应控制写入 ES 索引文件的总数据量在 100GB 以内，确保索引数据基本都能被缓存在内存中，这样搜索几乎都走内存，性能非常高，通常能做到 1 秒以内。</li><li>举个例子，如果现在有一行数据包含 30 个字段，比如 <code>id</code>、<code>name</code>、<code>age</code> 等，而你的搜索场景只涉及 <code>id</code>、<code>name</code>、<code>age</code> 这三个字段，那就没有必要把所有 30 个字段都写入 ES。否则，多余的字段不仅没用，反而白白占用了宝贵的 FileSystem Cache 空间，导致同样的内存能缓存的数据量变少，进而拉低整体查询性能。</li><li>正确做法是：只将用于检索的字段写入 ES，例如 <code>id</code>、<code>name</code>、<code>age</code>，其余字段（如明细信息、描述、历史记录等）可以存入其他数据库，推荐的架构是 ES + HBase 或 ES + MySQL。比如，如果有一份数据包含 100 个字段，但真正参与搜索的只有 10 个字段，那就只把这 10 个字段写入 ES，其余 90 个字段可以存 HBase 或 MySQL。这样 ES 中的数据结构更轻量，缓存命中率更高，搜索速度更快，同时也降低了集群资源消耗和维护成本。</li><li>具体流程如下：你在 ES 中根据 <code>name</code> 和 <code>age</code> 进行搜索，返回一批匹配的文档 ID（比如 20 条）；接着你再拿这些 ID 去 HBase 或 MySQL 中查询对应的完整数据，最终把这些完整信息返回给前端。这样的架构可以显著提高性能。比如搜索阶段仅耗时 20ms，HBase 查询阶段耗时 30ms，总体响应时间在 50ms 左右；而如果你把所有 1TB 的数据全放进 ES，每次查询可能都得耗费 5 到 10 秒。</li><li>因此，一贯的建议是：ES 中只存储关键的、用于搜索的字段，其数据量应尽量控制在 FileSystem Cache 能容纳的范围内；剩下不用于搜索的大量字段，可以存放在 HBase、MySQL 等系统中，按需查询。</li></ul></li><li><p><strong>ES 数据预热</strong></p><ul><li>即使已经按照 “只将用于搜索的字段写入 ES” 的最佳实践去做了，但在一些场景下，每台 ES 机器上写入的数据量仍可能超过 FileSystem Cache 的可承载范围。比如，一台机器上写入了 60GB 的索引数据，而用于 FileSystem Cache 的内存只有 30GB，意味着仍有一半数据只能依赖磁盘访问，性能依旧无法保证。</li><li>这时候就可以考虑引入一个非常有效的优化手段 —— <strong>热数据的缓存预热机制</strong>。简单来说，就是让系统提前把那些被频繁访问的数据 “主动读一遍”，让操作系统把它们预加载到 FileSystem Cache 中。这样，用户后续再访问这些数据时，ES 查询就可以直接命中内存，速度会非常快。</li><li>比如在微博场景下，你可以识别出一些大 V 用户的内容，这些内容访问频率高、用户关注度强。你可以在后台做一个定时任务系统，每隔一段时间（比如每分钟），由后台自动搜索一遍这些热数据，将它们 “刷” 进文件系统缓存。这样，当真实用户来访问这些热门微博内容时，查询就能直接从内存中命中，响应速度自然更快。</li><li>再比如电商系统，像 iPhone、热门折扣商品等，经常会被用户反复浏览，可以提前通过后台定时访问这些热商品的索引，让它们保持在 FileSystem Cache 中，提高搜索命中率和系统整体响应速度。</li><li>因此，建议针对热数据建立一个专门的 “缓存预热子系统”，定期主动触发对热点内容的查询或预加载操作，将热点索引数据尽可能保留在内存中。这种方式在大数据量场景下尤其有效，可以大幅度降低磁盘 I/O，提高系统的稳定性和搜索性能。</li></ul></li><li><p><strong>ES 数据冷热分离</strong></p><ul><li>在 ES 的性能优化中，数据拆分是一项非常关键的策略。前面提到过，可以将大量不用于搜索的字段剥离到其他存储系统中，比如 HBase 或 MySQL，这实际上对应的是类似于 MySQL 中 “分库分表” 里的垂直拆分：即将非核心字段从主索引中拆出去，减少 ES 中的存储压力，提高缓存命中率。</li><li>而在 ES 中，同样可以借鉴 MySQL 的水平拆分思路，也就是按照数据的访问频率来拆分索引。具体来说，就是将访问频率非常低的 “冷数据” 单独写入一个索引，将访问频率非常高的” 热数据” 单独写入另一个索引。这样做的目的是避免冷数据冲刷掉热数据在操作系统 FileSystem Cache 中的缓存空间，从而确保热数据的访问性能始终保持在较高水平。</li><li>举个例子，假设有一个 6 台机器组成的 ES 集群，数据被分为两个索引：一个用于冷数据，一个用于热数据，每个索引配置 3 个 Primary Shard。你可以将热数据的索引分配到其中 3 台机器，冷数据的索引分配到另外 3 台机器。这样，访问热数据时只会命中那 3 台负责热索引的机器，而热数据本身只占总数据量的 10%，内存压力小，Segment File 很容易被 FileSystem Cache 缓存住，查询几乎全在内存完成，性能自然非常高。</li><li>而冷数据则完全被隔离在另一个索引中，并分布在另外 3 台机器上。即使冷数据需要从磁盘读取、性能相对较差，也不会影响到主流用户的搜索体验。整体来看，90% 的请求命中热数据索引，享受高性能；只有 10% 的请求会访问冷数据，性能稍弱但可接受。通过这样的冷热分离和水平拆分策略，可以在确保整体系统性能的同时，有效应对大数据量场景下的资源冲突问题。</li></ul></li><li><p><strong>优化 Document 模型设计</strong></p><ul><li>在 ES 中，Document 模型设计是性能优化的关键环节之一<ul><li>假设在 MySQL 中有两张表 —— 订单表（<code>order</code>）和订单条目表（<code>order_item</code>），表结构如下：<ul><li><code>order</code> 表：<code>id, order_code, total_price</code></li><li><code>order_item</code> 表：<code>id, order_id, goods_id, purchase_count, price</code></li></ul></li><li>在 MySQL 中，通常使用以下 JOIN 查询：<ul><li>SQL 查询语句： <code>SELECT * FROM order JOIN order_item ON order.id = order_item.order_id WHERE order.id = 1;</code></li><li>返回结果会是两行，每条订单记录与其子条目连接在一起。</li></ul></li><li>但在 ES 中，这种复杂的关联查询、Join 操作、甚至 <code>parent-child</code>、<code>nested</code> 查询，不仅语法复杂，而且性能非常差。因此建议：尽量不要在 ES 查询阶段做这些复杂操作，而是将复杂操作转移到 ES 数据写入阶段执行。</li></ul></li><li>推荐的 ES 数据模型设计方式如下：<ul><li>在写入 ES 数据时，将数据预处理为两个索引：<ul><li>一个是 <code>order</code> 索引，仅包含订单主信息：<code>id, order_code, total_price</code></li><li>一个是 <code>order_item</code> 索引，在写入数据之前，就完成订单和订单条目的 Join，把订单字段和订单条目字段合并写进 ES，例如： <code>order_id, order_code, total_price, goods_id, purchase_count, price</code></li></ul></li><li>这个 Join 操作不是在 ES 查询时做，而是在 Java 系统中通过程序处理好，再将处理好的数据写入 ES，这样查询时就不需要依赖 ES 本身的 Join 功能，查询效率更高、逻辑更简单。</li></ul></li><li>ES 模型设计的核心建议：<ul><li>很多 ES 新手常犯的错误，就是在查询时试图执行各种复杂的业务逻辑、数据组合、字段匹配、嵌套结构解析等。但实际上，ES 本质上只是一个强大的全文搜索引擎，它并不擅长复杂的业务逻辑或关系型处理，所以不要强行把它当数据库用。</li><li>针对复杂查询场景，建议采用以下两种思路：<ul><li><code>在写入阶段设计好模型</code>：预先处理好关联关系、聚合信息、冗余字段等，写入时就将结果数据写好，避免查询时再做复杂处理。</li><li><code>在 Java 应用层封装业务逻辑</code>：让 ES 负责能高效完成的部分（如关键词搜索、过滤），然后由 Java 程序对返回结果进行进一步处理，完成复杂的业务逻辑。</li></ul></li><li>总之，ES 能做的就让它做，不能做的就别强求。把复杂逻辑尽可能提前转移到数据写入或业务系统层，才是高性能、高可维护性 ES 架构的关键。</li></ul></li></ul></li><li><p><strong>ES 分页性能优化</strong></p><ul><li>ES 的分页机制存在较大的性能隐患。举个例子，如果你每页展示 10 条数据，想查看第 100 页的内容，ES 实际上会从每个 Shard 上拉取前 1000 条数据到协调节点（因为 100 页 × 10 条 = 1000 条），假如有 5 个 Shard，总共就是 5000 条数据。当 ES 协调节点拿到这 5000 条数据后，还需要进行排序、筛选等操作，然后再从中取出最终的第 100 页的那 10 条结果。</li><li>这是因为 ES 是分布式的，是不可能说从 5 个 Shard，每个 Shard 就返回 2 条数据，最后到协调节点合并成 10 条数据。ES 必须得从每个 Shard 都查 1000 条数据过来，然后根据你的需求进行排序、筛选等等操作，最后再次分页，拿到里面第 100 页的数据。翻页越深，每个 Shard 拉取的数据越多，而且协调节点处理的时间越长。所以，<strong>使用 ES 做分页的时候，会发现分页越翻到后面，就越是慢</strong>。比如，使用 ES 做分页，前几页可能几十毫秒就返回了，翻到第 10 页之后，性能明显下滑，几十页时甚至可能需要 5~10 秒才能返回一页结果。</li><li>为了解决 ES 分页越翻到后面就越慢这个问题，一般建议不要使用深度分页（ES 默认的深度分页性能很差），产品设计上也要避免用户任意翻页。如果业务场景类似于微博、App 推荐商品那种 “下拉刷新、逐页加载” 的模式，建议使用 ES 提供的 Scroll API。因为 Scroll 的原理是生成一个数据快照，配合游标每次往后翻一页，性能非常好，即便翻很多页也能维持在毫秒级响应，但唯一的缺点就是它不支持跳页（如从第 1 页跳到第 100 页）。Scroll 更适合于只允许顺序翻页的场景，并且需要确保数据在一定时间窗口内保持一致。因此，如今很多 App 或网站的产品设计，都是不支持随意跳转页码的，而是采用 “无限下拉加载” 的形式，这就是为了避开 ES 分页性能的问题。</li></ul></li></ul><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/26ba10c4.html" title="ElasticSearch 开发随笔">https://www.techgrow.cn/posts/26ba10c4.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%BC%80%E5%8F%91%E9%9A%8F%E7%AC%94/" rel="tag"><i class="fa fa-tag"></i> 开发随笔</a><a href="/tags/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/" rel="tag"><i class="fa fa-tag"></i> 搜索引擎</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/aa402c78.html" rel="prev" title="Java 的五种代理实现方式"><i class="fa fa-angle-left"></i> Java 的五种代理实现方式</a></div><div class="post-nav-item"> <a href="/posts/3ccf5667.html" rel="next" title="国产数据库产品汇总">国产数据库产品汇总<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">2.2m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">34:02</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/26ba10c4.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>