<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","width":300,"display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍如何使用 Docker 安装并管理 Nacos 的镜像和容器，涉及到 Nacos 单机版与集群版的安装，并连接上 MySQL 数据库，同时还会介绍 Prometheus 与 Grafana 监控系统的使用。"><meta property="og:type" content="article"><meta property="og:title" content="Docker 安装 Nacos 单机和集群"><meta property="og:url" content="https://www.techgrow.cn/posts/961beae9.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍如何使用 Docker 安装并管理 Nacos 的镜像和容器，涉及到 Nacos 单机版与集群版的安装，并连接上 MySQL 数据库，同时还会介绍 Prometheus 与 Grafana 监控系统的使用。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/docker-nacos-single.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/docker-nacos-cluster.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/docker-nacos-single-prometheus.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/docker-nacos-grafana-bashboard.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/docker-nacos-grafana-datasource.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/docker-nacos-grafana-datasource-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/docker-nacos-grafana-datasource-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/docker-nacos-grafana-datasource-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/docker-nacos-grafana-datasource-4.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/docker-nacos-grafana-datasource-5.png"><meta property="article:published_time" content="2020-03-12T12:05:42.000Z"><meta property="article:modified_time" content="2020-11-22T13:43:32.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="容器化"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2020/12/docker-nacos-single.png"><link rel="canonical" href="https://www.techgrow.cn/posts/961beae9.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/961beae9.html","path":"posts/961beae9.html","title":"Docker 安装 Nacos 单机和集群"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Docker 安装 Nacos 单机和集群 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn:9360"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/app/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn:9360/ui/login?lng=zh-cn" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-0%E3%80%81%E8%BD%AF%E4%BB%B6%E7%8E%AF%E5%A2%83"><span class="nav-text">1.0、软件环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1%E3%80%81%E5%BF%AB%E9%80%9F%E5%90%AF%E5%8A%A8"><span class="nav-text">1.1、快速启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2%E3%80%81Clone-Nacos-%E9%A1%B9%E7%9B%AE"><span class="nav-text">1.2、Clone Nacos 项目</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3%E3%80%81Clone-Nacos-Docker-%E9%A1%B9%E7%9B%AE"><span class="nav-text">1.3、Clone Nacos Docker 项目</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nacos-%E5%8D%95%E6%9C%BA%E6%A8%A1%E5%BC%8F%E5%90%AF%E5%8A%A8"><span class="nav-text">Nacos 单机模式启动</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-0%E3%80%81Nacos-%E7%9B%91%E6%8E%A7%E5%85%B3%E9%97%AD"><span class="nav-text">2.0、Nacos 监控关闭</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1%E3%80%81Nacos-Derby"><span class="nav-text">2.1、Nacos + Derby</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2%E3%80%81Nacos-MySQL-5-7"><span class="nav-text">2.2、Nacos + MySQL 5.7</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3%E3%80%81Nacos-MySQL-8"><span class="nav-text">2.3、Nacos + MySQL 8</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4%E3%80%81Nacos-%E5%8D%95%E6%9C%BA%E6%A8%A1%E5%BC%8F%E6%B5%8B%E8%AF%95"><span class="nav-text">2.4、Nacos 单机模式测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-1%E3%80%81%E8%B0%83%E7%94%A8-OPEN-API"><span class="nav-text">2.4.1、调用 OPEN API</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-2%E3%80%81%E8%AE%BF%E9%97%AE-Nacos-%E7%9A%84%E6%8E%A7%E5%88%B6%E5%8F%B0"><span class="nav-text">2.4.2、访问 Nacos 的控制台</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nacos-%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F%E5%90%AF%E5%8A%A8"><span class="nav-text">Nacos 集群模式启动</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-0%E3%80%81Nacos-MySQL-5-7"><span class="nav-text">3.0、Nacos + MySQL 5.7</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1%E3%80%81Nacos-%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F%E6%B5%8B%E8%AF%95"><span class="nav-text">3.1、Nacos 集群模式测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-1%E3%80%81%E8%B0%83%E7%94%A8-OPEN-API"><span class="nav-text">3.1.1、调用 OPEN API</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-2%E3%80%81%E8%AE%BF%E9%97%AE-Nacos-%E7%9A%84%E6%8E%A7%E5%88%B6%E5%8F%B0"><span class="nav-text">3.1.2、访问 Nacos 的控制台</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Prometheus-%E4%B8%8E-Grafana-%E7%9B%91%E6%8E%A7"><span class="nav-text">Prometheus 与 Grafana 监控</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-0%E3%80%81%E5%88%9B%E5%BB%BA%E5%B9%B6%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8"><span class="nav-text">4.0、创建并启动容器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1%E3%80%81%E8%B0%83%E7%94%A8-OPEN-API"><span class="nav-text">4.1、调用 OPEN API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2%E3%80%81%E8%AE%BF%E9%97%AE-Prometheus-%E7%9A%84%E6%8E%A7%E5%88%B6%E5%8F%B0"><span class="nav-text">4.2、访问 Prometheus 的控制台</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3%E3%80%81%E8%AE%BF%E9%97%AE-Grafana-%E7%9A%84%E6%8E%A7%E5%88%B6%E5%8F%B0"><span class="nav-text">4.3、访问 Grafana 的控制台</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker-%E9%83%A8%E7%BD%B2%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB"><span class="nav-text">Docker 部署问题汇总</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-0%E3%80%81MySQL-%E5%90%AF%E5%8A%A8%E5%A4%B1%E8%B4%A5"><span class="nav-text">5.0、MySQL 启动失败</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1%E3%80%81Nacos-%E5%90%AF%E5%8A%A8%E5%A4%B1%E8%B4%A5"><span class="nav-text">5.1、Nacos 启动失败</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-1%E3%80%81%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90"><span class="nav-text">5.1.1、原因分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-2%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96-MySQL-%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">5.1.2、初始化 MySQL 数据库</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker-%E5%B1%9E%E6%80%A7%E9%85%8D%E7%BD%AE%E5%88%97%E8%A1%A8"><span class="nav-text">Docker 属性配置列表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">496</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">46</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/961beae9.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java、前端、移动端、微服务、分布式系统、数据库、系统架构、人工智能、大数据、云计算、物联网、虚拟化学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Docker 安装 Nacos 单机和集群 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍如何使用 Docker 安装并管理 Nacos 的镜像和容器，涉及到 Nacos 单机版与集群版的安装，并连接上 MySQL 数据库，同时还会介绍 Prometheus 与 Grafana 监控系统的使用。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Docker 安装 Nacos 单机和集群</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-03-12 20:05:42" itemprop="dateCreated datePublished" datetime="2020-03-12T20:05:42+08:00">2020-03-12</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2020-11-22 21:43:32" itemprop="dateModified" datetime="2020-11-22T21:43:32+08:00">2020-11-22</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/961beae9.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/961beae9.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>4.8k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>4 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文主要介绍如何使用 Docker 安装并管理 Nacos 的镜像和容器，涉及到 Nacos 单机版与集群版的安装，并连接上 MySQL 数据库，同时还会介绍 Prometheus 与 Grafana 监控系统的使用。</p><h3 id="1-0、软件环境"><a href="#1-0、软件环境" class="headerlink" title="1.0、软件环境"></a>1.0、软件环境</h3><ul><li>CentOS 7.9</li><li>Docker 20.10.1</li><li>Docker-Compose 1.24.0-rc1</li><li>Nacos 1.4.0（截止目前最新的版本）</li></ul><span id="more"></span><h3 id="1-1、快速启动"><a href="#1-1、快速启动" class="headerlink" title="1.1、快速启动"></a>1.1、快速启动</h3><p>单机模式快速启动 Nacos，使用嵌入式数据库</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword"># docker</span> run<span class="params"> --name</span> nacos-standalone-embedded<span class="params"> -e</span> MODE=standalone<span class="params"> -p</span> 8848:8848<span class="params"> -d</span> nacos/nacos-server:latest</span><br></pre></td></tr></tbody></table></figure><p>单机模式快速启动 Nacos，使用 MySQL 数据库</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword"># docker</span> run<span class="params"> -d</span> \<span class="params"></span></span><br><span class="line"><span class="params">-e</span> MODE=standalone \<span class="params"></span></span><br><span class="line"><span class="params">-e</span> SPRING_DATASOURCE_PLATFORM=mysql \<span class="params"></span></span><br><span class="line"><span class="params">-e</span> MYSQL_SERVICE_HOST=ip \<span class="params"></span></span><br><span class="line"><span class="params">-e</span> MYSQL_SERVICE_PORT=3306 \<span class="params"></span></span><br><span class="line"><span class="params">-e</span> MYSQL_SERVICE_USER=nacos \<span class="params"></span></span><br><span class="line"><span class="params">-e</span> MYSQL_SERVICE_PASSWORD=nacos \<span class="params"></span></span><br><span class="line"><span class="params">-e</span> MYSQL_SERVICE_DB_NAME=nacos_devtest \<span class="params"></span></span><br><span class="line"><span class="params">-p</span> 8848:8848 \<span class="params"></span></span><br><span class="line"><span class="params">--restart</span>=always \<span class="params"></span></span><br><span class="line"><span class="params">--name</span> nacos-standalone-mysql \</span><br><span class="line">nacos/nacos-server:latest</span><br><span class="line"></span><br><span class="line"><span class="comment">## 特别注意：</span></span><br><span class="line"><span class="comment">## 1) MySQL 数据库必须是已经初始化过的，即已经创建好 Nacos 运行所需的数据库表</span></span><br><span class="line"><span class="comment">## 2) MySQL 的 IP 必须是在 Nacos 容器内部可以直接访问到的 IP，一般情况下不能直接使用 `127.0.0.1`</span></span><br><span class="line"><span class="comment">## 3) 若 MySQL 不是运行在 Docker 容器内，而是直接安装在外网或者宿主机内，可以指定 `--net=host` 参数让 Nacos 容器共享宿主机的网络</span></span><br></pre></td></tr></tbody></table></figure><h3 id="1-2、Clone-Nacos-项目"><a href="#1-2、Clone-Nacos-项目" class="headerlink" title="1.2、Clone Nacos 项目"></a>1.2、Clone Nacos 项目</h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拉取Nacos项目的源码</span></span><br><span class="line"><span class="keyword">$ git</span> <span class="built_in">clone</span> https://github.com/alibaba/nacos</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后面会使用 nacos-mysql.sql 来初始化MySQL数据库</span></span><br><span class="line"><span class="keyword">$ tree</span> nacos/distribution/conf</span><br><span class="line">├── application.properties</span><br><span class="line">├── application.properties.example</span><br><span class="line">├── cluster.conf.example</span><br><span class="line">├── nacos-mysql.sql</span><br><span class="line">├── nacos-logback.xml</span><br><span class="line">└── schema.sql</span><br></pre></td></tr></tbody></table></figure><h3 id="1-3、Clone-Nacos-Docker-项目"><a href="#1-3、Clone-Nacos-Docker-项目" class="headerlink" title="1.3、Clone Nacos Docker 项目"></a>1.3、Clone Nacos Docker 项目</h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拉取Nacos Docker项目的源码</span></span><br><span class="line"><span class="keyword">$ git</span> <span class="built_in">clone</span> https://github.com/nacos-group/nacos-docker.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入项目目录</span></span><br><span class="line"><span class="keyword">$ cd</span> nacos-docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 目录结构</span></span><br><span class="line"><span class="keyword">$ tree</span></span><br><span class="line">├── build</span><br><span class="line">│&nbsp;&nbsp; ├── bin</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; └── docker-startup.sh</span><br><span class="line">│&nbsp;&nbsp; ├── conf</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; └── application.properties</span><br><span class="line">│&nbsp;&nbsp; ├── Dockerfile</span><br><span class="line">│&nbsp;&nbsp; └── init.d</span><br><span class="line">│&nbsp;&nbsp;     └── custom.properties</span><br><span class="line">├── changlog</span><br><span class="line">├── env</span><br><span class="line">│&nbsp;&nbsp; ├── mysql.env</span><br><span class="line">│&nbsp;&nbsp; ├── nacos-embedded.env</span><br><span class="line">│&nbsp;&nbsp; ├── nacos-hostname.env</span><br><span class="line">│&nbsp;&nbsp; ├── nacos-ip.env</span><br><span class="line">│&nbsp;&nbsp; └── nacos-standlone-mysql.env</span><br><span class="line">├── example</span><br><span class="line">│&nbsp;&nbsp; ├── cluster-embedded.yaml</span><br><span class="line">│&nbsp;&nbsp; ├── cluster-hostname.yaml</span><br><span class="line">│&nbsp;&nbsp; ├── cluster-ip.yaml</span><br><span class="line">│&nbsp;&nbsp; ├── init.d</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; └── custom.properties</span><br><span class="line">│&nbsp;&nbsp; ├── prometheus</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── prometheus-cluster.yaml</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; └── prometheus-standalone.yaml</span><br><span class="line">│&nbsp;&nbsp; ├── standalone-derby.yaml</span><br><span class="line">│&nbsp;&nbsp; ├── standalone-mysql-5.7.yaml</span><br><span class="line">│&nbsp;&nbsp; └── standalone-mysql-8.yaml</span><br><span class="line">├── README.md</span><br><span class="line">└── README_ZH.md</span><br></pre></td></tr></tbody></table></figure><p><strong>目录结构说明：</strong></p><ul><li><code>example</code>：Docker-Compose 编排示例</li><li><code>example/init.d</code>：启动 Nacos 容器时的自定义配置（应用级别），例如 Metrics 监控相关的内容</li><li><code>build</code>：用于构建 Nacos 镜像的源码，包括配置文件、Shell 脚本与 Dockerfile</li><li><code>env</code>：Docker-Compose 的环境变量文件，例如定义 MySQL 数据库的用户名、密码和端口号、Nacos 集群各节点的 IP</li></ul><h2 id="Nacos-单机模式启动"><a href="#Nacos-单机模式启动" class="headerlink" title="Nacos 单机模式启动"></a>Nacos 单机模式启动</h2><h3 id="2-0、Nacos-监控关闭"><a href="#2-0、Nacos-监控关闭" class="headerlink" title="2.0、Nacos 监控关闭"></a>2.0、Nacos 监控关闭</h3><p>在 Nacos 官方的 Docker 项目里，Nacos 单机版（Derby、MySQL 5.7）默认集成了 Prometheus 与 Grafana 监控。即在 <code>example/standalone-xxx.yaml</code> 配置文件里，除了已经配置了 Nacos 的镜像，还配置了 Prometheus、Grafana 作为监控系统。如果不需要监控 Nacos，可以删除对应的配置内容，具体操作如下：</p><ul><li>1）配置 Nacos 不暴露 Metrics 数据</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑Properties配置文件</span></span><br><span class="line"><span class="keyword">$ vim</span> example/init.d/custom.properties</span><br><span class="line">management.endpoints.web.exposure.include=*     <span class="comment">#注释掉这行内容，注释后访问"http://{ip}:8848/nacos/actuator/prometheus" 不会再看到Metrics数据</span></span><br></pre></td></tr></tbody></table></figure><ul><li>2）删除 Prometheus、Grafana 的 Docker-Compose 配置</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑YAML配置文件，删除以下内容</span></span><br><span class="line"><span class="keyword">$ vim</span> example standalone-derby.yaml</span><br><span class="line"></span><br><span class="line">prometheus:</span><br><span class="line">  container_name: prometheus</span><br><span class="line">  image: prom/prometheus:latest</span><br><span class="line">  volumes:</span><br><span class="line">    - ./prometheus/prometheus-standalone.yaml:/etc/prometheus/prometheus.yml</span><br><span class="line">  ports:</span><br><span class="line">    - <span class="string">"9090:9090"</span></span><br><span class="line">  depends_on:</span><br><span class="line">    - nacos</span><br><span class="line">  restart: on-failure</span><br><span class="line">grafana:</span><br><span class="line">  container_name: grafana</span><br><span class="line">  image: grafana/grafana:latest</span><br><span class="line">  ports:</span><br><span class="line">    - 3000:3000</span><br><span class="line">  restart: on-failure</span><br></pre></td></tr></tbody></table></figure><h3 id="2-1、Nacos-Derby"><a href="#2-1、Nacos-Derby" class="headerlink" title="2.1、Nacos + Derby"></a>2.1、Nacos + Derby</h3><p>单机模式启动 Nacos 容器，默认使用的是嵌入式数据库 Derby</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建并前台启动容器</span></span><br><span class="line"><span class="keyword"># docker</span>-compose<span class="params"> -f</span> example/standalone-derby.yaml up</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者创建并后台启动容器</span></span><br><span class="line"><span class="keyword"># docker</span>-compose<span class="params"> -f</span> example/standalone-derby.yaml up<span class="params"> -d</span></span><br></pre></td></tr></tbody></table></figure><p><strong>Docker-Compose 常用的容器管理命令，后面创建的所有容器都可以这样管理，不再累述。</strong></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看容器的运行状态</span></span><br><span class="line"><span class="keyword"># docker</span>-compose<span class="params"> -f</span> example/standalone-derby.yaml ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动容器</span></span><br><span class="line"><span class="keyword"># docker</span>-compose<span class="params"> -f</span> example/standalone-derby.yaml start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止容器</span></span><br><span class="line"><span class="keyword"># docker</span>-compose<span class="params"> -f</span> example/standalone-derby.yaml stop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止并删除容器，包括网络、数据卷（特别注意，此操作会删除所有容器的数据，且不可恢复）</span></span><br><span class="line"><span class="keyword"># docker</span>-compose<span class="params"> -f</span> example/standalone-derby.yaml down</span><br></pre></td></tr></tbody></table></figure><h3 id="2-2、Nacos-MySQL-5-7"><a href="#2-2、Nacos-MySQL-5-7" class="headerlink" title="2.2、Nacos + MySQL 5.7"></a>2.2、Nacos + MySQL 5.7</h3><p>单机模式启动 Nacos 容器，数据库使用的是 MySQL 5.7，这里需要手动执行 <a href="/posts/961beae9.html#5-1-2%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96-MySQL-%E6%95%B0%E6%8D%AE%E5%BA%93">MySQL 数据库初始化操作</a>，否则 Nacos 启动时会抛出 <code>No DataSource set</code> 异常，导致无法连接上 MySQL 数据库</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建并前台启动容器</span></span><br><span class="line"><span class="keyword"># docker</span>-compose<span class="params"> -f</span> example/standalone-mysql-5.7.yaml up</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者创建并后台启动容器</span></span><br><span class="line"><span class="keyword"># docker</span>-compose<span class="params"> -f</span> example/standalone-mysql-5.7.yaml up<span class="params"> -d</span></span><br></pre></td></tr></tbody></table></figure><h3 id="2-3、Nacos-MySQL-8"><a href="#2-3、Nacos-MySQL-8" class="headerlink" title="2.3、Nacos + MySQL 8"></a>2.3、Nacos + MySQL 8</h3><p>单机模式启动 Nacos 容器，数据库使用的是 MySQL 8，这里需要手动执行 <a href="/posts/961beae9.html#5-1-2%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96-MySQL-%E6%95%B0%E6%8D%AE%E5%BA%93">MySQL 数据库初始化操作</a>，否则 Nacos 启动时会抛出 <code>No DataSource set</code> 异常，导致无法连接上 MySQL 数据库</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建并前台启动容器</span></span><br><span class="line"><span class="keyword"># docker</span>-compose<span class="params"> -f</span> example/standalone-mysql-8.yaml up</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者创建并后台启动容器</span></span><br><span class="line"><span class="keyword"># docker</span>-compose<span class="params"> -f</span> example/standalone-mysql-8.yaml up<span class="params"> -d</span></span><br></pre></td></tr></tbody></table></figure><h3 id="2-4、Nacos-单机模式测试"><a href="#2-4、Nacos-单机模式测试" class="headerlink" title="2.4、Nacos 单机模式测试"></a>2.4、Nacos 单机模式测试</h3><h4 id="2-4-1、调用-OPEN-API"><a href="#2-4-1、调用-OPEN-API" class="headerlink" title="2.4.1、调用 OPEN API"></a>2.4.1、调用 OPEN API</h4><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 发布配置</span></span><br><span class="line"><span class="keyword">$ curl</span><span class="params"> -X</span> POST <span class="string">"http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test&amp;content=helloWorld"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取配置</span></span><br><span class="line"><span class="keyword">$ curl</span><span class="params"> -X</span> GET <span class="string">"http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务注册</span></span><br><span class="line"><span class="keyword">$ curl</span><span class="params"> -X</span> POST <span class="string">'http://127.0.0.1:8848/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&amp;ip=20.18.7.10&amp;port=8080'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务发现</span></span><br><span class="line"><span class="keyword">$ curl</span><span class="params"> -X</span> GET <span class="string">'http://127.0.0.1:8848/nacos/v1/ns/instance/list?serviceName=nacos.naming.serviceName'</span></span><br></pre></td></tr></tbody></table></figure><h4 id="2-4-2、访问-Nacos-的控制台"><a href="#2-4-2、访问-Nacos-的控制台" class="headerlink" title="2.4.2、访问 Nacos 的控制台"></a>2.4.2、访问 Nacos 的控制台</h4><p>浏览器访问 <code>http://127.0.0.1:8848/nacos</code>，打开 Nacos 的控制台</p><p><img data-src="../../../asset/2020/12/docker-nacos-single.png" alt="docker-nacos-single"></p><h2 id="Nacos-集群模式启动"><a href="#Nacos-集群模式启动" class="headerlink" title="Nacos 集群模式启动"></a>Nacos 集群模式启动</h2><p>Nacos 的集群模式需要依赖 MySQL 数据库（集中式存储），因此在集群模式下不能再使用 Nacos 自带的嵌入式数据库 Derby。在 Nacos 官方的 Docker 项目中，以集群模式启动 Nacos，默认使用的是单个 MySQL 数据库。值得一提的是，<strong>从 Nacos 1.1.4 镜像开始，后续所有镜像都已经移除了主从镜像相关属性的配置</strong>。由于在 Nacos 的生产环境中，MySQL 至少需要主备模式，或者采用高可用数据库；因此如果需要配置 MySQL 主从库，需要自行实现（如搭建 DB-Proxy）。</p><h3 id="3-0、Nacos-MySQL-5-7"><a href="#3-0、Nacos-MySQL-5-7" class="headerlink" title="3.0、Nacos + MySQL 5.7"></a>3.0、Nacos + MySQL 5.7</h3><p>基于 HostName，集群模式启动 Nacos 容器，数据库使用的是 MySQL 5.7（单机），这里需要手动执行 <a href="/posts/961beae9.html#5-1-2%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96-MySQL-%E6%95%B0%E6%8D%AE%E5%BA%93">MySQL 数据库初始化操作</a>，否则 Nacos 启动时会抛出 <code>No DataSource set</code> 异常，导致无法连接上 MySQL 数据库</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建并前台启动容器</span></span><br><span class="line"><span class="keyword"># docker</span>-compose<span class="params"> -f</span> example/cluster-hostname.yaml up</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者创建并后台启动容器</span></span><br><span class="line"><span class="keyword"># docker</span>-compose<span class="params"> -f</span> example/cluster-hostname.yaml up<span class="params"> -d</span></span><br></pre></td></tr></tbody></table></figure><p>基于 IP，集群模式启动 Nacos 容器，数据库使用的是 MySQL 5.7（单机），这里需要手动执行 <a href="/posts/961beae9.html#5-1-2%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96-MySQL-%E6%95%B0%E6%8D%AE%E5%BA%93">MySQL 数据库初始化操作</a>，否则 Nacos 启动时会抛出 <code>No DataSource set</code> 异常，导致无法连接上 MySQL 数据库</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建并前台启动容器</span></span><br><span class="line"><span class="keyword"># docker</span>-compose<span class="params"> -f</span> example/cluster-ip.yaml up</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者创建并后台启动容器</span></span><br><span class="line"><span class="keyword"># docker</span>-compose<span class="params"> -f</span> example/cluster-ip.yaml up<span class="params"> -d</span></span><br></pre></td></tr></tbody></table></figure><p>查看 Nacos 的日志文件，若日志信息如下显示，则说明 Nacos 是以集群模式启动的</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword"># tail</span><span class="params"> -n</span> 20 example/cluster-logs/nacos1/nacos.<span class="built_in">log</span></span><br><span class="line"><span class="keyword"># tail</span><span class="params"> -n</span> 20 example/cluster-logs/nacos2/nacos.<span class="built_in">log</span></span><br><span class="line"><span class="keyword"># tail</span><span class="params"> -n</span> 20 example/cluster-logs/nacos3/nacos.<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line">2020-03-12 21:20:17,866 INFO Nacos started successfully <span class="keyword">in</span> cluster mode. use external storage</span><br><span class="line">2020-03-12 21:20:18,117 INFO Initializing Spring DispatcherServlet <span class="string">'dispatcherServlet'</span></span><br><span class="line">2020-03-12 21:20:18,117 INFO Initializing Servlet <span class="string">'dispatcherServlet'</span></span><br><span class="line">2020-03-12 21:20:18,141 INFO Completed initialization <span class="keyword">in</span> 23 ms</span><br></pre></td></tr></tbody></table></figure><h3 id="3-1、Nacos-集群模式测试"><a href="#3-1、Nacos-集群模式测试" class="headerlink" title="3.1、Nacos 集群模式测试"></a>3.1、Nacos 集群模式测试</h3><h4 id="3-1-1、调用-OPEN-API"><a href="#3-1-1、调用-OPEN-API" class="headerlink" title="3.1.1、调用 OPEN API"></a>3.1.1、调用 OPEN API</h4><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 发布配置</span></span><br><span class="line"><span class="keyword">$ curl</span><span class="params"> -X</span> POST <span class="string">"http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test&amp;content=helloWorld"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取配置</span></span><br><span class="line"><span class="keyword">$ curl</span><span class="params"> -X</span> GET <span class="string">"http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务注册</span></span><br><span class="line"><span class="keyword">$ curl</span><span class="params"> -X</span> POST <span class="string">'http://127.0.0.1:8848/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&amp;ip=20.18.7.10&amp;port=8080'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务发现</span></span><br><span class="line"><span class="keyword">$ curl</span><span class="params"> -X</span> GET <span class="string">'http://127.0.0.1:8848/nacos/v1/ns/instance/list?serviceName=nacos.naming.serviceName'</span></span><br></pre></td></tr></tbody></table></figure><h4 id="3-1-2、访问-Nacos-的控制台"><a href="#3-1-2、访问-Nacos-的控制台" class="headerlink" title="3.1.2、访问 Nacos 的控制台"></a>3.1.2、访问 Nacos 的控制台</h4><p>浏览器访问 <code>http://127.0.0.1:8848/nacos</code>，打开 Nacos 的控制台；若 Nacos 集群启动成功，可以看到多个 Nacos 节点，Docker 的映射端口分别是 8848、8849、8850</p><p><img data-src="../../../asset/2020/12/docker-nacos-cluster.png" alt="docker-nacos-cluster"></p><h2 id="Prometheus-与-Grafana-监控"><a href="#Prometheus-与-Grafana-监控" class="headerlink" title="Prometheus 与 Grafana 监控"></a>Prometheus 与 Grafana 监控</h2><p>在 Nacos 官方的 Docker 项目里，Nacos 单机版（Derby、MySQL 5.7）默认集成了 Prometheus 与 Grafana 监控，一般情况下开箱即用。</p><h3 id="4-0、创建并启动容器"><a href="#4-0、创建并启动容器" class="headerlink" title="4.0、创建并启动容器"></a>4.0、创建并启动容器</h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建并后台启动容器</span></span><br><span class="line"><span class="keyword"># docker</span>-compose<span class="params"> -f</span> example/standalone-mysql-5.7.yaml up<span class="params"> -d</span></span><br></pre></td></tr></tbody></table></figure><h3 id="4-1、调用-OPEN-API"><a href="#4-1、调用-OPEN-API" class="headerlink" title="4.1、调用 OPEN API"></a>4.1、调用 OPEN API</h3><p>为了让 Prometheus 与 Grafana 的监控面板有数据可显示，调用 OPEN API 插入模拟数据</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 发布配置</span></span><br><span class="line"><span class="keyword">$ curl</span><span class="params"> -X</span> POST <span class="string">"http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test&amp;content=helloWorld"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务注册</span></span><br><span class="line"><span class="keyword">$ curl</span><span class="params"> -X</span> POST <span class="string">'http://127.0.0.1:8848/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&amp;ip=20.18.7.10&amp;port=8080'</span></span><br></pre></td></tr></tbody></table></figure><h3 id="4-2、访问-Prometheus-的控制台"><a href="#4-2、访问-Prometheus-的控制台" class="headerlink" title="4.2、访问 Prometheus 的控制台"></a>4.2、访问 Prometheus 的控制台</h3><ul><li>1）浏览器访问 <code>http://127.0.0.1:9090/graph</code>，打开 Prometheus 的控制台，查看 Prometheus 采集到的 Nacos Metrics 数据</li><li> 2）在搜索栏搜索 <code>nacos_monitor</code>，若可以搜索到 Nacos 的数据，则说明 Prometheus 采集数据成功</li><li> 3）若 Prometheus 采集不到数据，浏览器访问 <code>http://{ip}:8848/nacos/actuator/prometheus</code>，看能不能获取到 Nacos 的 Metrics 数据</li></ul><p><img data-src="../../../asset/2020/12/docker-nacos-single-prometheus.png" alt="docker-nacos-single-prometheus"></p><h3 id="4-3、访问-Grafana-的控制台"><a href="#4-3、访问-Grafana-的控制台" class="headerlink" title="4.3、访问 Grafana 的控制台"></a>4.3、访问 Grafana 的控制台</h3><ul><li>1）下载 Nacos 的 Grafana 监控模版文件</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拉取Nacos Template项目的源码</span></span><br><span class="line"><span class="keyword">$ git</span> <span class="built_in">clone</span> https://github.com/nacos-group/nacos-template</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后面要用到 nacos-grafana.json 监控模版文件</span></span><br><span class="line"><span class="keyword"># tree</span><span class="params"> -N</span></span><br><span class="line">├── nacos-grafana.json</span><br><span class="line">├── nacos-sync-grafana</span><br><span class="line">├── README.md</span><br><span class="line">├── 方案评审内容模板.md</span><br><span class="line">├── 模板-Nacos（微软黑体）.ppt</span><br><span class="line">└── 模板-Nacos（微软黑体）新版本.key</span><br></pre></td></tr></tbody></table></figure><ul><li>2）浏览器访问 <code>http://127.0.0.1:3000</code>，默认登录的用户名和密码为 <code>admin/admin</code>，首次登录会提示重新设置新密码</li></ul><p><img data-src="../../../asset/2020/12/docker-nacos-grafana-bashboard.png" alt="docker-nacos-grafana-bashboard"></p><ul><li> 3）创建 Prometheus 数据源</li></ul><p><img data-src="../../../asset/2020/12/docker-nacos-grafana-datasource.png" alt="docker-nacos-grafana-datasource"></p><p><img data-src="../../../asset/2020/12/docker-nacos-grafana-datasource-1.png" alt="docker-nacos-grafana-datasource-1"></p><p><strong>特别注意：Grafana 创建 Prometheus 新数据源时，数据源名称（区分英文大小写）必须是 <code>prometheus</code>，数据源地址必须是 <code>http://prometheus:9090</code>，否则会获取不到监控数据或者提示 Gateway 相关的错误信息</strong></p><p><img data-src="../../../asset/2020/12/docker-nacos-grafana-datasource-2.png" alt="docker-nacos-grafana-datasource-2"></p><ul><li>4）导入 Nacos 的 Grafana 监控模版文件 <code>nacos-grafana.json</code></li></ul><p><img data-src="../../../asset/2020/12/docker-nacos-grafana-datasource-3.png" alt="docker-nacos-grafana-datasource-3"></p><p><img data-src="../../../asset/2020/12/docker-nacos-grafana-datasource-4.png" alt="docker-nacos-grafana-datasource-4"></p><ul><li>5）Nacos Grafana 展示的核心监控项</li></ul><p><img data-src="../../../asset/2020/12/docker-nacos-grafana-datasource-5.png" alt="docker-nacos-grafana-datasource-5"></p><h2 id="Docker-部署问题汇总"><a href="#Docker-部署问题汇总" class="headerlink" title="Docker 部署问题汇总"></a>Docker 部署问题汇总</h2><h3 id="5-0、MySQL-启动失败"><a href="#5-0、MySQL-启动失败" class="headerlink" title="5.0、MySQL 启动失败"></a>5.0、MySQL 启动失败</h3><p>发现 MySQL 容器启动失败</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看容器的运行状态</span></span><br><span class="line"><span class="keyword">$ docker</span>-compose<span class="params"> -f</span> example/standalone-mysql-5.7.yaml ps</span><br><span class="line"></span><br><span class="line">grafana                  /run.sh                          Up       0.0.0.0:3000-&gt;3000/tcp</span><br><span class="line">mysql                    docker-entrypoint.sh mysqld      Exit 1</span><br><span class="line">nacos-standalone-mysql   bin/docker-startup.sh            Up       0.0.0.0:8848-&gt;8848/tcp, 0.0.0.0:9555-&gt;9555/tcp</span><br><span class="line">prometheus               /bin/prometheus<span class="params"> --config</span>.f ...   Up       0.0.0.0:9090-&gt;9090/tcp</span><br></pre></td></tr></tbody></table></figure><p>查看 MySQL 的日志信息，发现可能是 MySQL 首次启动时生成相关证书（登录）失败导致</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#　查看容器的运行状态</span></span><br><span class="line"><span class="keyword">$ docker</span>-compose<span class="params"> -f</span> example/standalone-mysql-5.7.yaml logs mysql</span><br><span class="line"></span><br><span class="line">mysql         | Database initialized</span><br><span class="line">mysql         | Initializing certificates</span><br><span class="line">mysql         | Generating a RSA private key</span><br><span class="line">mysql         | ..+++++</span><br><span class="line">mysql         | ..................................+++++</span><br><span class="line">mysql         | unable to write <span class="string">'random state'</span></span><br><span class="line">mysql         | writing new private key to <span class="string">'ca-key.pem'</span></span><br><span class="line">mysql         | -----</span><br><span class="line">mysql         | Generating a RSA private key</span><br><span class="line">mysql         | .......................+++++</span><br><span class="line">mysql         | ......+++++</span><br><span class="line">mysql         | unable to write <span class="string">'random state'</span></span><br><span class="line">mysql         | writing new private key to <span class="string">'server-key.pem'</span></span><br><span class="line">mysql         | -----</span><br><span class="line">mysql         | Generating a RSA private key</span><br><span class="line">mysql         | ..............................................................+++++</span><br><span class="line">mysql         | ...............+++++</span><br><span class="line">mysql         | unable to write <span class="string">'random state'</span></span><br><span class="line">mysql         | writing new private key to <span class="string">'client-key.pem'</span></span><br><span class="line">mysql         | -----</span><br><span class="line">mysql         | mysql_ssl_rsa_setup: Can<span class="string">'t change permissions of the file '</span>ca-key.pem<span class="string">' (Errcode: 1 - Operation not permitted)</span></span><br><span class="line"><span class="string">mysql         | 2020-03-12 22:13:39 [ERROR]   Error setting file permissions forca-key.pem and ca.pem</span></span><br><span class="line"><span class="string">mysql         | mysql_ssl_rsa_setup: Can'</span>t change permissions of the file <span class="string">'server-key.pem'</span> (Errcode: 1 - Operation not permitted)</span><br><span class="line">mysql         | 2020-03-12 22:13:39 [ERROR]   Error setting file permissions forserver-key.pem and server-cert.pem</span><br><span class="line">mysql         | mysql_ssl_rsa_setup: Can<span class="string">'t change permissions of the file '</span>client-key.pem<span class="string">' (Errcode: 1 - Operation not permitted)</span></span><br><span class="line"><span class="string">mysql         | 2020-03-12 22:13:39 [ERROR]   Error setting file permissions forclient-key.pem and client-cert.pem</span></span><br></pre></td></tr></tbody></table></figure><p>关闭所有容器，然后再重启所有容器，至此 MySQL 容器可以正常启动</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭所有容器</span></span><br><span class="line"><span class="keyword"># docker</span>-compose<span class="params"> -f</span> example/standalone-mysql-5.7.yaml stop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动所有容器</span></span><br><span class="line"><span class="keyword"># docker</span>-compose<span class="params"> -f</span> example/standalone-mysql-5.7.yaml start</span><br><span class="line"></span><br><span class="line"><span class="comment">#　查看容器的运行状态</span></span><br><span class="line"><span class="keyword">$ docker</span>-compose<span class="params"> -f</span> example/standalone-mysql-5.7.yaml ps</span><br><span class="line"></span><br><span class="line">grafana                  /run.sh                          Up      0.0.0.0:3000-&gt;3000/tcp</span><br><span class="line">mysql                    docker-entrypoint.sh mysqld      Up      0.0.0.0:3309-&gt;3306/tcp, 33060/tcp</span><br><span class="line">nacos-standalone-mysql   bin/docker-startup.sh            Up      0.0.0.0:8848-&gt;8848/tcp, 0.0.0.0:9555-&gt;9555/tcp</span><br><span class="line">prometheus               /bin/prometheus<span class="params"> --config</span>.f ...   Up      0.0.0.0:9090-&gt;9090/tcp</span><br></pre></td></tr></tbody></table></figure><h3 id="5-1、Nacos-启动失败"><a href="#5-1、Nacos-启动失败" class="headerlink" title="5.1、Nacos 启动失败"></a>5.1、Nacos 启动失败</h3><h4 id="5-1-1、原因分析"><a href="#5-1-1、原因分析" class="headerlink" title="5.1.1、原因分析"></a>5.1.1、原因分析</h4><p>容器虽然都启动成功了，但浏览器无法访问 <code>http://127.0.0.1:8848/nacos</code>，查看 Nacos 的日志文件，发现有 <code>No DataSource set</code> 相关的异常信息，也就是 Nacos Server 无法正常连接到 MySQL 数据库</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看Nacos的日志文件</span></span><br><span class="line"><span class="keyword">$ tail</span><span class="params"> -n</span> 20 example/standalone-logs/nacos.<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line">Caused by: java.lang.IllegalStateException: No DataSource <span class="built_in">set</span></span><br><span class="line">	at org.springframework.util.Assert.state(Assert.java:73)</span><br><span class="line">	at org.springframework.jdbc.support.JdbcAccessor.obtainDataSource(JdbcAccessor.java:77)</span><br><span class="line">	at org.springframework.jdbc.core.JdbcTemplate.execute(JdbcTemplate.java:371)</span><br><span class="line">	at org.springframework.jdbc.core.JdbcTemplate.query(JdbcTemplate.java:452)</span><br><span class="line">	at org.springframework.jdbc.core.JdbcTemplate.query(JdbcTemplate.java:462)</span><br><span class="line">	at org.springframework.jdbc.core.JdbcTemplate.queryForObject(JdbcTemplate.java:473)</span><br><span class="line">	at org.springframework.jdbc.core.JdbcTemplate.queryForObject(JdbcTemplate.java:480)</span><br></pre></td></tr></tbody></table></figure><p>经过排查，发现可能是以下几方面原因造成：</p><ul><li>1）开启系统防火墙导致</li><li> 2）在 MySQL 的配置文件 <code>/etc/mysql/mysql.conf.d/mysqld.cnf</code> 里，开启了 <code>bind 127.0.0.1</code> 配置项，导致外部无法连接</li><li> 3）在 MySQL 数据库里不存在 <code>nacos</code> 用户，这是因为在 <code>env</code> 目录下的 Docker-Compose 环境配置文件中，指定了 Nacos 默认连接 MySQL 时使用的用户名和密码为 <code>nacos/nacos</code></li><li>4）在 MySQL 数据库里不存在 <code>nacos_devtest</code> 数据库，这是因为在 <code>env</code> 目录下的 Docker-Compose 环境配置文件中，指定了 Nacos 默认连接的 MySQL 数据库为 <code>nacos_devtest</code></li></ul><p><strong>分析结果：</strong>各种假设经过逐一验证后，最终发现导致 Nacos 无法连接 MySQL 数据库的原因，是因为在 MySQL 数据库中，不存在 <code>nacos</code> 用户，同时也不存在 <code>nacos_devtest</code> 数据库，即 MySQL 数据库里没有被初始化过</p><h4 id="5-1-2、初始化-MySQL-数据库"><a href="#5-1-2、初始化-MySQL-数据库" class="headerlink" title="5.1.2、初始化 MySQL 数据库"></a>5.1.2、初始化 MySQL 数据库</h4><p><strong>温馨提示：</strong>以下数据库初始化操作适用于 MySQL 5.7、MySQL 8，同时适用于 Nacos 单机模式和集群模式。若使用了不同的 YAML 配置文件来管理 Nacos 的镜像和容器，此时只需要将下列命令中的 <code>example/xxx.yaml</code> 替换为自己所使用的 YAML 配置文件的路径即可。</p><hr><p>拷贝数据库初始化脚本 <a href="/posts/961beae9.html#1-2%E3%80%81Clone-Nacos-%E9%A1%B9%E7%9B%AE">nacos-mysql.sql</a> 到 MySQL 容器的根目录下，并在 MySQL 容器内通过命令行登录进 MySQL 数据库</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动所有容器</span></span><br><span class="line"><span class="keyword"># docker</span>-compose<span class="params"> -f</span> example/standalone-mysql-5.7.yaml start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝数据库初始化脚本到MySQL容器的根目录下</span></span><br><span class="line"><span class="keyword"># docker</span> cp nacos/distribution/conf/nacos-mysql.sql mysql:/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接MySQL容器</span></span><br><span class="line"><span class="keyword"># docker</span> <span class="built_in">exec</span><span class="params"> -it</span> mysql /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在MySQL容器内，通过命令行登录进MySQL数据库；在终端输入"mysql"后，直接按下回车键即可，不需要指定数据库的用户名和密码，默认是以root用户登录</span></span><br><span class="line"><span class="keyword"># mysql</span></span><br></pre></td></tr></tbody></table></figure><p>在 MySQL 的容器内登录进 MySQL 数据库后，执行数据库初始化操作</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"># 创建用户</span><br><span class="line">mysql&gt; CREATE USER 'nacos'@'%' IDENTIFIED BY 'nacos';</span><br><span class="line"></span><br><span class="line"># 创建数据库</span><br><span class="line">mysql&gt; create database nacos_devtest default character set utf8;</span><br><span class="line"></span><br><span class="line"># 用户授权访问</span><br><span class="line"># GRANT ALL ON nacos_devtest.* TO 'nacos'@'%';</span><br><span class="line"></span><br><span class="line"># 刷新权限</span><br><span class="line"># flush privileges;</span><br><span class="line"></span><br><span class="line"># 切换数据库</span><br><span class="line">mysql&gt; use nacos_devtest;</span><br><span class="line"></span><br><span class="line"># 执行数据库初始化脚本</span><br><span class="line">mysql&gt; source /nacos-mysql.sql;</span><br><span class="line"></span><br><span class="line"># 查看数据库表</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">+------------------------+</span><br><span class="line">| Tables_in_nacos_devtest |</span><br><span class="line">+------------------------+</span><br><span class="line">| config_info            |</span><br><span class="line">| config_info_aggr       |</span><br><span class="line">| config_info_beta       |</span><br><span class="line">| config_info_tag        |</span><br><span class="line">| config_tags_relation   |</span><br><span class="line">| group_capacity         |</span><br><span class="line">| his_config_info        |</span><br><span class="line">| permissions            |</span><br><span class="line">| roles                  |</span><br><span class="line">| tenant_capacity        |</span><br><span class="line">| tenant_info            |</span><br><span class="line">| users                  |</span><br><span class="line">+------------------------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"># 退出登录MySQL</span><br><span class="line">mysql&gt; exit</span><br><span class="line"></span><br><span class="line"># 断开MySQL容器的连接</span><br><span class="line"># exit</span><br><span class="line"></span><br><span class="line"># 重启所有容器</span><br><span class="line"># docker-compose -f example/standalone-mysql-5.7.yaml restart</span><br></pre></td></tr></tbody></table></figure><p>容器重启后，若在 Nacos 的日志文件里观察到以下内容，则说明 Nacos 可以正常启动</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword"># tail</span><span class="params"> -n</span> 20 example/standalone-logs/nacos.<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line">2020-03-12 23:01:50,062 INFO Initializing ExecutorService <span class="string">'taskScheduler'</span></span><br><span class="line">2020-03-12 23:01:50,092 INFO Exposing 16 endpoint(s) beneath base path <span class="string">'/actuator'</span></span><br><span class="line">2020-03-12 23:01:50,240 INFO Tomcat started on port(s): 8848 (http) with context path <span class="string">'/nacos'</span></span><br><span class="line">2020-03-12 23:01:50,245 INFO Started Nacos <span class="keyword">in</span> 12.964 seconds (JVM running <span class="keyword">for</span> 13.92)</span><br><span class="line">2020-03-12 23:01:50,246 INFO Nacos Log files: /home/nacos/logs</span><br><span class="line">2020-03-12 23:01:50,247 INFO Nacos Log files: /home/nacos/conf</span><br><span class="line">2020-03-12 23:01:50,247 INFO Nacos Log files: /home/nacos/data</span><br><span class="line">2020-03-12 23:01:50,248 INFO Nacos started successfully <span class="keyword">in</span> stand alone mode. use external storage</span><br><span class="line">2020-03-12 23:01:55,147 INFO Initializing Spring DispatcherServlet <span class="string">'dispatcherServlet'</span></span><br><span class="line">2020-03-12 23:01:55,147 INFO Initializing Servlet <span class="string">'dispatcherServlet'</span></span><br><span class="line">2020-03-12 23:01:55,169 INFO Completed initialization <span class="keyword">in</span> 22 ms</span><br></pre></td></tr></tbody></table></figure><h2 id="Docker-属性配置列表"><a href="#Docker-属性配置列表" class="headerlink" title="Docker 属性配置列表"></a>Docker 属性配置列表</h2><table><thead><tr><th>属性名称</th><th>描述</th><th>选项</th></tr></thead><tbody><tr><td> MODE</td><td> 系统启动方式：集群 / 单机</td><td> cluster/standalone 默认 <strong>cluster</strong></td></tr><tr><td>NACOS_SERVERS</td><td> 集群地址</td><td> p1:port1 空格 ip2:port2 空格 ip3:port3</td></tr><tr><td>PREFER_HOST_MODE</td><td> 支持 IP 还是域名模式</td><td> hostname/ip 默认 <strong>ip</strong></td></tr><tr><td>NACOS_SERVER_PORT</td><td>Nacos 运行端口</td><td>默认 <strong>8848</strong></td></tr><tr><td>NACOS_SERVER_IP</td><td> 多网卡模式下可以指定 IP</td><td></td></tr><tr><td>SPRING_DATASOURCE_PLATFORM</td><td> 单机模式下支持 MYSQL 数据库</td><td> mysql / 空 默认：空</td></tr><tr><td> MYSQL_SERVICE_HOST</td><td> 数据库连接地址</td><td></td></tr><tr><td> MYSQL_SERVICE_PORT</td><td> 数据库端口</td><td>默认 : <strong>3306</strong></td></tr><tr><td>MYSQL_SERVICE_DB_NAME</td><td> 数据库库名</td><td></td></tr><tr><td> MYSQL_SERVICE_USER</td><td> 数据库用户名</td><td></td></tr><tr><td> MYSQL_SERVICE_PASSWORD</td><td> 数据库用户密码</td><td></td></tr><tr><td> MYSQL_SERVICE_DB_PARAM</td><td> 数据库连接参数</td><td> default : <strong>characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true</strong></td></tr><tr><td>MYSQL_DATABASE_NUM</td><td>It indicates the number of database</td><td> 默认 :<strong>1</strong></td></tr><tr><td>JVM_XMS</td><td>-Xms</td><td> 默认 :2g</td></tr><tr><td>JVM_XMX</td><td>-Xmx</td><td> 默认 :2g</td></tr><tr><td>JVM_XMN</td><td>-Xmn</td><td> 默认 :1g</td></tr><tr><td>JVM_MS</td><td>-XX:MetaspaceSize</td><td> 默认 :128m</td></tr><tr><td>JVM_MMS</td><td>-XX:MaxMetaspaceSize</td><td> 默认 :320m</td></tr><tr><td>NACOS_DEBUG</td><td> 是否开启远程 DEBUG</td><td>y/n 默认 :n</td></tr><tr><td>TOMCAT_ACCESSLOG_ENABLED</td><td>server.tomcat.accesslog.enabled</td><td> 默认 :false</td></tr><tr><td>NACOS_AUTH_SYSTEM_TYPE</td><td> 权限系统类型选择，目前只支持 nacos 类型</td><td>默认 :nacos</td></tr><tr><td>NACOS_AUTH_ENABLE</td><td> 是否开启权限系统</td><td>默认 :false</td></tr><tr><td>NACOS_AUTH_TOKEN_EXPIRE_SECONDS</td><td>token 失效时间</td><td>默认 :18000</td></tr><tr><td>NACOS_AUTH_TOKEN</td><td>token</td><td> 默认 :SecretKey012345678901234567890123456789012345678901234567890123456789</td></tr><tr><td>NACOS_AUTH_CACHE_ENABLE</td><td> 权限缓存开关，开启后权限缓存的更新默认有 15 秒的延迟</td><td>默认 : false</td></tr><tr><td>MEMBER_LIST</td><td> 通过环境变量的方式设置集群地址</td><td>例子：192.168.16.101:8847?raft_port=8807,192.168.16.101?raft_port=8808,192.168.16.101:8849?raft_port=8809</td></tr><tr><td>EMBEDDED_STORAGE</td><td> 是否开启集群嵌入式存储模式</td><td><code>embedded</code> 默认 : none</td></tr></tbody></table><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a target="_blank" rel="external nofollow" href="https://nacos.io/zh-cn/docs/monitor-guide.html">Nacos 监控指南</a></li><li><a target="_blank" rel="external nofollow" href="https://github.com/nacos-group/nacos-docker">Nacos Docker 项目</a></li><li><a target="_blank" rel="external nofollow" href="https://github.com/nacos-group/nacos-docker/wiki/%E7%A7%BB%E9%99%A4%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%BB%E4%BB%8E%E9%95%9C%E5%83%8F%E9%85%8D%E7%BD%AE">Nacos Docker 移除主从镜像配置</a></li><li><a target="_blank" rel="external nofollow" href="https://github.com/nacos-group/nacos-docker/blob/ba41672f2f3db1b5e730f77a4b3cfedde1ae40f8/README_ZH.md">Nacos Docker 快速开始（属性配置的内容已过时）</a></li></ul><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/961beae9.html" title="Docker 安装 Nacos 单机和集群">https://www.techgrow.cn/posts/961beae9.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%AE%B9%E5%99%A8%E5%8C%96/" rel="tag"><i class="fa fa-tag"></i> 容器化</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/e44e61ed.html" rel="prev" title="中国象棋之三 Linux 平台的象棋软件 GMChess"><i class="fa fa-angle-left"></i> 中国象棋之三 Linux 平台的象棋软件 GMChess</a></div><div class="post-nav-item"> <a href="/posts/26ffa5e3.html" rel="next" title="中国象棋之一开源 AI 引擎介绍">中国象棋之一开源 AI 引擎介绍<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">1.1m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">16:20</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤 ICP 备 19024664 号</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035 号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-g2xji1rlE3KsGVClvuxTbcR0Kn2+wtQADSff2Tbb4zA="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"/lib/mermaid/dist/mermaid.min.js","integrity":"sha256-9y71g5Lz/KLsHjB8uXwnkuWDtAMDSzD/HdIbqhJfTAI="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://qiniu.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/app/api/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn:9360","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://qiniu.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/app/api/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/961beae9.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>