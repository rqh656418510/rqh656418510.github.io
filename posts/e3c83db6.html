<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.12.1","exturl":false,"sidebar":{"position":"left","width":300,"display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍如何使用Sentinel，包括流量控制规则、熔断降级规则、系统自适应保护规则、来源访问控制规则、动态规则扩展等的使用。"><meta property="og:type" content="article"><meta property="og:title" content="Sentinel 入门教程 - 中级篇"><meta property="og:url" content="https://www.techgrow.cn/posts/e3c83db6.html"><meta property="og:site_name" content="Clay 的技术博客"><meta property="og:description" content="本文主要介绍如何使用Sentinel，包括流量控制规则、熔断降级规则、系统自适应保护规则、来源访问控制规则、动态规则扩展等的使用。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/sentinel-add-flowrule.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/sentinel-breaker-configuration.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/sentinel-annotation-configuration.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/sentinel-dashboard-add-degrade-rule.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/sentinel-system-auto-protect.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/sentinel-add-system-rule.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/sentinel-add-origin-control-rule.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/12/sentinel-data-source.png"><meta property="article:published_time" content="2020-01-18T13:39:23.000Z"><meta property="article:modified_time" content="2020-01-18T13:39:23.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="微服务"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2020/12/sentinel-add-flowrule.png"><link rel="canonical" href="https://www.techgrow.cn/posts/e3c83db6.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/e3c83db6.html","path":"posts/e3c83db6.html","title":"Sentinel 入门教程 - 中级篇"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Sentinel 入门教程 - 中级篇 | Clay 的技术博客</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn:9360"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术博客" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax>!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><script data-ad-client="ca-pub-4014850419768221" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/app/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt></div><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术博客</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-openplatform"><a href="https://docs.techgrow.cn/v1/" rel="external nofollow" target="_blank"><i class="fa fa-toolbox fa-fw"></i>开放平台</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn:9360/ui/login?lng=zh-cn" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8A%E7%AF%87-Sentinel%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B%EF%BC%88%E5%9F%BA%E7%A1%80%E7%AF%87%EF%BC%89"><span class="nav-text">上篇 - Sentinel 入门教程（基础篇）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-0%E3%80%81%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="nav-text">1.0、版本说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1%E3%80%81Sentinel-%E7%9A%84%E6%8E%A7%E5%88%B6%E8%A7%84%E5%88%99"><span class="nav-text">1.1、Sentinel 的控制规则</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sentinel-%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E5%AE%9E%E7%8E%B0"><span class="nav-text">Sentinel 流量控制实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-0%E3%80%81%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E6%A6%82%E8%BF%B0"><span class="nav-text">2.0、流量控制概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1%E3%80%81%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E7%AD%96%E7%95%A5"><span class="nav-text">2.1、流量控制策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2%E3%80%81%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E8%A7%84%E5%88%99%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="nav-text">2.2、流量控制规则的属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3%E3%80%81%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E8%A7%84%E5%88%99%E7%9A%84%E8%AE%BE%E7%BD%AE"><span class="nav-text">2.3、流量控制规则的设置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-1%E3%80%81%E4%BB%A3%E7%A0%81%E8%AE%BE%E7%BD%AE"><span class="nav-text">2.3.1、代码设置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2%E3%80%81%E6%B3%A8%E8%A7%A3%E5%B1%9E%E6%80%A7%E8%AF%B4%E6%98%8E"><span class="nav-text">2.3.2、注解属性说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-3%E3%80%81Sentinel-%E6%8E%A7%E5%88%B6%E5%8F%B0%E5%8A%A8%E6%80%81%E8%AE%BE%E7%BD%AE"><span class="nav-text">2.3.3、Sentinel 控制台动态设置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sentinel-%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7%E5%AE%9E%E7%8E%B0"><span class="nav-text">Sentinel 熔断降级实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-0%E3%80%81%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7%E6%A6%82%E8%BF%B0"><span class="nav-text">3.0、熔断降级概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1%E3%80%81%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7%E7%AD%96%E7%95%A5"><span class="nav-text">3.1、熔断降级策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2%E3%80%81%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7%E8%A7%84%E5%88%99%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="nav-text">3.2、熔断降级规则的属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3%E3%80%81%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7%E8%A7%84%E5%88%99%E7%9A%84%E8%AE%BE%E7%BD%AE"><span class="nav-text">3.3、熔断降级规则的设置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-1%E3%80%81%E4%BB%A3%E7%A0%81%E8%AE%BE%E7%BD%AE"><span class="nav-text">3.3.1、代码设置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-2%E3%80%81%E6%B3%A8%E8%A7%A3%E5%B1%9E%E6%80%A7%E8%AF%B4%E6%98%8E"><span class="nav-text">3.3.2、注解属性说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-3%E3%80%81Sentinel-%E6%8E%A7%E5%88%B6%E5%8F%B0%E5%8A%A8%E6%80%81%E8%AE%BE%E7%BD%AE"><span class="nav-text">3.3.3、Sentinel 控制台动态设置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sentinel-%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E4%BF%9D%E6%8A%A4%E5%AE%9E%E7%8E%B0"><span class="nav-text">Sentinel 系统自适应保护实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-0%E3%80%81%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E4%BF%9D%E6%8A%A4%E6%A6%82%E8%BF%B0"><span class="nav-text">4.0、系统自适应保护概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1%E3%80%81%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E4%BF%9D%E6%8A%A4%E7%AD%96%E7%95%A5"><span class="nav-text">4.1、系统自适应保护策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2%E3%80%81%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E4%BF%9D%E6%8A%A4%E8%A7%84%E5%88%99%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="nav-text">4.2、系统自适应保护规则的属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3%E3%80%81%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E4%BF%9D%E6%8A%A4%E8%A7%84%E5%88%99%E7%9A%84%E8%AE%BE%E7%BD%AE"><span class="nav-text">4.3、系统自适应保护规则的设置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-1%E3%80%81%E4%BB%A3%E7%A0%81%E8%AE%BE%E7%BD%AE"><span class="nav-text">4.3.1、代码设置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-2%E3%80%81Sentinel-%E6%8E%A7%E5%88%B6%E5%8F%B0%E5%8A%A8%E6%80%81%E8%AE%BE%E7%BD%AE"><span class="nav-text">4.3.2、Sentinel 控制台动态设置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sentinel-%E6%9D%A5%E6%BA%90%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E5%AE%9E%E7%8E%B0"><span class="nav-text">Sentinel 来源访问控制实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-0%E3%80%81%E6%9D%A5%E6%BA%90%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E6%A6%82%E8%BF%B0"><span class="nav-text">5.0、来源访问控制概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1%E3%80%81%E6%9D%A5%E6%BA%90%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E8%A7%84%E5%88%99%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="nav-text">5.1、来源访问控制规则的属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2%E3%80%81%E6%9D%A5%E6%BA%90%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E8%A7%84%E5%88%99%E7%9A%84%E8%AE%BE%E7%BD%AE"><span class="nav-text">5.2、来源访问控制规则的设置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-1%E3%80%81%E4%BB%A3%E7%A0%81%E8%AE%BE%E7%BD%AE"><span class="nav-text">5.2.1、代码设置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-2%E3%80%81Sentinel-%E6%8E%A7%E5%88%B6%E5%8F%B0%E5%8A%A8%E6%80%81%E8%AE%BE%E7%BD%AE"><span class="nav-text">5.2.2、Sentinel 控制台动态设置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sentinel-%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%99%E6%89%A9%E5%B1%95%EF%BC%88%E6%8C%81%E4%B9%85%E5%8C%96%E8%A7%84%E5%88%99%EF%BC%89"><span class="nav-text">Sentinel 动态规则扩展（持久化规则）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-0%E3%80%81DataSource-%E6%89%A9%E5%B1%95"><span class="nav-text">6.0、DataSource 扩展</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1%E3%80%81%E4%BD%BF%E7%94%A8-ZooKeeper-%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE%EF%BC%88%E6%8E%A8%E6%A8%A1%E5%BC%8F%EF%BC%89"><span class="nav-text">6.1、使用 ZooKeeper 规则配置（推模式）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-1%E3%80%81%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="nav-text">6.1.1、代码示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-2%E3%80%81%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="nav-text">6.1.2、测试代码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2%E3%80%81%E6%9B%B4%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E6%89%A9%E5%B1%95%E6%94%AF%E6%8C%81"><span class="nav-text">6.2、更多数据源扩展支持</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">345</span> <span class="site-state-item-name">文章</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags"><span class="site-state-item-count">40</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → &#x2F;sitemap.xml"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="external nofollow" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/e3c83db6.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术博客"><meta itemprop="description" content="专注于 Java、前端、移动端、微服务、分布式系统、数据库、系统架构、人工智能、大数据、云计算、物联网、虚拟化学习的技术博客。"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Sentinel 入门教程 - 中级篇 | Clay 的技术博客"><meta itemprop="description" content="本文主要介绍如何使用Sentinel，包括流量控制规则、熔断降级规则、系统自适应保护规则、来源访问控制规则、动态规则扩展等的使用。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Sentinel 入门教程 - 中级篇</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-01-18 21:39:23" itemprop="dateCreated datePublished" datetime="2020-01-18T21:39:23+08:00">2020-01-18</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/e3c83db6.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/e3c83db6.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>7.3k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>7 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><div id="readmore-container"><h2 id="上篇-Sentinel入门教程（基础篇）"><a href="#上篇-Sentinel入门教程（基础篇）" class="headerlink" title="上篇 - Sentinel入门教程（基础篇）"></a>上篇 - Sentinel 入门教程（基础篇）</h2><ul><li><a href="/posts/8facd1ee.html">Sentinel 入门教程 - 基础篇</a></li></ul><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="1-0、版本说明"><a href="#1-0、版本说明" class="headerlink" title="1.0、版本说明"></a>1.0、版本说明</h3><p>本文针对 Sentinel 1.8.0 及以上版本编写，特别说明除外。由于 1.8.0 版本对熔断降级特性进行了全新的改进升级，建议使用最新版本以更好地利用熔断降级的能力。</p><h3 id="1-1、Sentinel-的控制规则"><a href="#1-1、Sentinel-的控制规则" class="headerlink" title="1.1、Sentinel 的控制规则"></a>1.1、Sentinel 的控制规则</h3><p>Sentinel 的所有规则都可以在内存态中动态地查询与修改，修改之后立即生效，同时 Sentinel 也提供了相关 API 供开发者来定制自己的规则策略。Sentinel 主要支持以下几种规则：</p><ul><li>流量控制规则</li><li>熔断降级规则</li><li>系统保护规则</li><li>来源访问控制规则</li><li>动态规则扩展</li></ul><span id="more"></span><h2 id="Sentinel-流量控制实现"><a href="#Sentinel-流量控制实现" class="headerlink" title="Sentinel 流量控制实现"></a>Sentinel 流量控制实现</h2><h3 id="2-0、流量控制概述"><a href="#2-0、流量控制概述" class="headerlink" title="2.0、流量控制概述"></a>2.0、流量控制概述</h3><p>流量控制（Flow Control），其原理是监控应用流量的 QPS 或者并发线程数等指标，当达到指定的阀值时对流量进行控制，以避免被瞬间的流量高峰冲垮，从而保障应用的高可用性。FlowSlot 会根据预设的规则，结合 NodeSelectorSlot、ClusterBuilderSlot、StatisticSlot 统计出来的实时信息进行流量控制。限流的直接表现是在执行 <code>Entry nodeA = SphU.entry(resourceName)</code> 的时候抛出 <code>FlowException</code> 异常。<code>FlowException</code> 是 <code>BlockException</code> 的子类，可以捕捉 <code>BlockException</code> 来自定义被限流之后的处理逻辑。</p><h3 id="2-1、流量控制策略"><a href="#2-1、流量控制策略" class="headerlink" title="2.1、流量控制策略"></a>2.1、流量控制策略</h3><p>Sentinel 的流量控制策略主要有两种实现方式：</p><ul><li><code>并发线程数</code>：并发线程数限流用于保护业务线程数不被耗尽</li><li><code>QPS</code>：当 QPS 超过某个阀值的时候，则采取措施进行流量控制</li></ul><h3 id="2-2、流量控制规则的属性"><a href="#2-2、流量控制规则的属性" class="headerlink" title="2.2、流量控制规则的属性"></a>2.2、流量控制规则的属性</h3><p>流量控制规则（FlowRule）包含下面几个重要的属性：</p><ul><li><p><code>count</code>：限流阀值</p></li><li><p><code>strategy</code>：调用关系限流策略</p></li><li><p><code>resource</code>：资源名，即流控规则的作用对象</p></li><li><p><code>grade</code>：限流阀值类型（QPS 或者并发线程数）</p></li><li><p><code>limitApp</code>：流控针对的调用来源，若为 <code>default</code> 则不区分调用来源</p></li><li><p><code>controlBehavior</code>：流量整形的控制效果（直接拒绝、Warm Up、匀速排队）</p><ul><li><p><code>直接拒绝（RuleConstant.CONTROL_BEHAVIOR_DEFAULT）</code>方式是默认的流量控制方式，当 QPS 超过任意规则的阈值后，新的请求就会被立即拒绝，拒绝方式为抛出 <code>FlowException</code>。这种方式适用于对系统处理能力确切已知的情况下，例如通过压测确定了系统的准确水位时。</p></li><li><p><code>Warm Up（RuleConstant.CONTROL_BEHAVIOR_WARM_UP）</code>方式，即预热 / 冷启动方式，在系统长期处于低水位的情况下，当流量突然增加时，会直接把系统拉升到高水位，这可能会瞬间把系统拉跨。通过” 冷启动”，让通过的流量缓慢增加，在一定时间内逐渐增加到阈值上限，给冷系统一个预热的时间，避免冷系统被压垮。</p></li><li><p><code>匀速排队（RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER）</code>方式会严格控制请求通过的间隔时间，也即是让请求以均匀的速度通过，对应的是漏桶算法，例如阈值 <code>QPS=2</code> 时，每个 500ms 处理一个请求，假设当前有 10 个请求则需要排队处理 5 秒。</p></li></ul></li></ul><p><strong>特别注意：</strong>同一个资源可以同时拥有多个流控规则，Sentinel 检查规则时会依次检查。</p><h3 id="2-3、流量控制规则的设置"><a href="#2-3、流量控制规则的设置" class="headerlink" title="2.3、流量控制规则的设置"></a>2.3、流量控制规则的设置</h3><p>流量控制规则设置有以下两种方式：</p><ul><li>本地代码设置</li><li>在 Sentinel 控制台动态设置</li></ul><h4 id="2-3-1、代码设置"><a href="#2-3-1、代码设置" class="headerlink" title="2.3.1、代码设置"></a>2.3.1、代码设置</h4><p>以下只给出流量控制的简单示例代码，若需要更详细的流量控制代码示例，可以点<a href="/posts/8facd1ee.html#gou-jian-sentinel-ben-di-ying-yong">这里</a></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DegradeController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 资源名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String RESOURCE_NAME = <span class="string">"Flow"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@SentinelResource</span> 定义资源</span></span><br><span class="line"><span class="comment">     * value：资源名称</span></span><br><span class="line"><span class="comment">     * blockHandler：限流处理的方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = RESOURCE_NAME, blockHandler = "exceptionHandler")</span></span><br><span class="line">    <span class="meta">@GetMapping("/hello")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// 被保护的资源</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello Sentinel!"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 原方法被限流的时候调用此方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">exceptionHandler</span><span class="params">(BlockException e)</span> </span>{</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"系统繁忙，请稍候 ..."</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前类的构造方法执行之后执行此方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initFlowRules</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// 创建存放流控规则的集合</span></span><br><span class="line">        List&lt;FlowRule&gt; rules = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// 创建流控规则</span></span><br><span class="line">        FlowRule rule = <span class="keyword">new</span> FlowRule();</span><br><span class="line">        <span class="comment">// 定义资源，表示Sentinel会对哪个资源生效</span></span><br><span class="line">        rule.setResource(RESOURCE_NAME);</span><br><span class="line">        <span class="comment">// 定义流控规则的类型</span></span><br><span class="line">        rule.setGrade(RuleConstant.FLOW_GRADE_QPS);</span><br><span class="line">        <span class="comment">// 定义QPS每秒能通过的请求数</span></span><br><span class="line">        rule.setCount(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// 将流控规则存放在集合中</span></span><br><span class="line">        rules.add(rule);</span><br><span class="line">        <span class="comment">// 加载流控规则</span></span><br><span class="line">        FlowRuleManager.loadRules(rules);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>程序运行后，通过浏览器访问 <code>http://127.0.0.1:8080/hello</code>，然后快速多次刷新页面，当每秒的请求数大于 2 时，接口的请求结果为 <code>系统繁忙，请稍候 ...</code>，则说明上面设置的流控规则生效了。</p><h4 id="2-3-2、注解属性说明"><a href="#2-3-2、注解属性说明" class="headerlink" title="2.3.2、注解属性说明"></a>2.3.2、注解属性说明</h4><ul><li>通过 <code>@SentinelResource</code> 注解的 <code>blockHandler</code> 属性制定具体的限流处理方法</li><li>实现处理方法，该方法的传参必须与资源点的传参一样，并且最后必须加上 <code>BlockException</code> 异常参数，同时返回类型也必须一样</li></ul><h4 id="2-3-3、Sentinel-控制台动态设置"><a href="#2-3-3、Sentinel-控制台动态设置" class="headerlink" title="2.3.3、Sentinel 控制台动态设置"></a>2.3.3、Sentinel 控制台动态设置</h4><p><img data-src="../../../asset/2020/12/sentinel-add-flowrule.png" alt="sentinel-add-flowrule"></p><h2 id="Sentinel-熔断降级实现"><a href="#Sentinel-熔断降级实现" class="headerlink" title="Sentinel 熔断降级实现"></a>Sentinel 熔断降级实现</h2><h3 id="3-0、熔断降级概述"><a href="#3-0、熔断降级概述" class="headerlink" title="3.0、熔断降级概述"></a>3.0、熔断降级概述</h3><p>除了流量控制以外，对调用链路中不稳定的资源进行熔断降级也是保障高可用的重要措施之一。一个服务常常会调用别的模块，可能是另外的一个远程服务、数据库，或者第三方 API 等。例如，支付的时候，可能需要远程调用银联提供的 API；查询某个商品的价格，可能需要进行数据库查询。然而，这个被依赖服务的稳定性是不能保证的。如果依赖的服务出现了不稳定的情况，请求的响应时间变长，那么调用服务的方法的响应时间也会变长，线程会产生堆积，最终可能耗尽业务自身的线程池，服务本身也变得不可用。</p><hr><p>现代微服务架构都是分布式的，由非常多的服务组成。不同服务之间相互调用，组成复杂的调用链路。以上的问题在链路调用中会产生放大的效果。复杂链路上的某一环不稳定，就可能会层层级联，最终导致整个链路都不可用。因此需要对不稳定的弱依赖服务调用进行熔断降级，暂时切断不稳定调用，避免局部不稳定因素导致整体的雪崩。<strong>熔断降级作为保护自身的手段，通常在客户端（调用端）进行配置</strong>。熔断降级会在调用链路中某个资源出现不稳定状态时（例如调用超时或者异常比例升高），对这个资源的调用进行限制，让请求快速多次失败，避免影响到其他的资源而导致级联故障（服务雪崩）。当资源被降级后，在接下来的降级时间窗口之内，对该资源的调用都自动熔断（默认行为是抛出 <code>DegradeException</code>）。</p><h3 id="3-1、熔断降级策略"><a href="#3-1、熔断降级策略" class="headerlink" title="3.1、熔断降级策略"></a>3.1、熔断降级策略</h3><ul><li><p><code>慢调用比例 (SLOW_REQUEST_RATIO）</code>：选择以慢调用比例作为阈值，需要设置允许的慢调用 RT（即最大的响应时间），请求的响应时间大于该值则统计为慢调用。当单位统计时长（statIntervalMs）内请求数目大于设置的最小请求数目，并且慢调用的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求响应时间小于设置的慢调用 RT 则结束熔断，若大于设置的慢调用 RT 则会再次被熔断。</p></li><li><p><code>异常比例 (ERROR_RATIO）</code>：当单位统计时长（statIntervalMs）内请求数目大于设置的最小请求数目，并且异常的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。异常比率的阈值范围是 [0.0, 1.0]，代表 0% - 100%。</p></li><li><p><code>异常数 (ERROR_COUNT）</code>：当单位统计时长内的异常数目超过阈值之后会自动进行熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。</p></li></ul><p><strong>特别注意：</strong>异常降级仅针对业务异常，对 Sentinel 限流降级本身的异常（<code>BlockException</code>）不生效。</p><h3 id="3-2、熔断降级规则的属性"><a href="#3-2、熔断降级规则的属性" class="headerlink" title="3.2、熔断降级规则的属性"></a>3.2、熔断降级规则的属性</h3><p>熔断降级规则（DegradeRule）包含下面几个重要的属性：</p><p><img data-src="../../../asset/2020/12/sentinel-breaker-configuration.png" alt="sentinel-breaker-configuration"></p><p><strong>特别注意：</strong>同一个资源可以同时拥有多个熔断降级规则。</p><h3 id="3-3、熔断降级规则的设置"><a href="#3-3、熔断降级规则的设置" class="headerlink" title="3.3、熔断降级规则的设置"></a>3.3、熔断降级规则的设置</h3><p>熔断降级规则设置有以下两种方式：</p><ul><li>本地代码设置</li><li>在 Sentinel 控制台动态设置</li></ul><h4 id="3-3-1、代码设置"><a href="#3-3-1、代码设置" class="headerlink" title="3.3.1、代码设置"></a>3.3.1、代码设置</h4><p>下面将演示如何使用慢调用比例 (SLOW_REQUEST_RATIO）熔断降级规则，<a href="/downloads/2020/12/sentinel-degrade-demo.zip">点击下载</a>完整的案例代码。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DegradeController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String RESOURCE_NAME = <span class="string">"Degrade"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger LOG = LoggerFactory.getLogger(DegradeController.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@SentinelResource</span> 定义资源</span></span><br><span class="line"><span class="comment">     * value：资源名称</span></span><br><span class="line"><span class="comment">     * blockHandler：熔断降级处理的方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = RESOURCE_NAME, fallback = "exceptionHandler")</span></span><br><span class="line">    <span class="meta">@GetMapping("/hello")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// 被保护的资源</span></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            Random random = <span class="keyword">new</span> Random();</span><br><span class="line">            <span class="keyword">int</span> millis = random.nextInt(<span class="number">10</span>);</span><br><span class="line">            LOG.info(<span class="string">"sleep time: "</span> + millis);</span><br><span class="line">            <span class="comment">// 随机休眠10毫秒以内，模拟接口慢调用</span></span><br><span class="line">            Thread.sleep(millis);</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 原方法被熔断降级的时候调用此方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">exceptionHandler</span><span class="params">()</span> </span>{</span><br><span class="line">        LOG.error(<span class="string">"fallback handler invoke"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"系统繁忙，请稍候 ..."</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义熔断降级规则</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initDegradeRule</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// 创建存放熔断降级规则的集合</span></span><br><span class="line">        List&lt;DegradeRule&gt; rules = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// 创建熔断降级规则</span></span><br><span class="line">        DegradeRule rule = <span class="keyword">new</span> DegradeRule();</span><br><span class="line">        <span class="comment">// 定义资源名称</span></span><br><span class="line">        rule.setResource(RESOURCE_NAME);</span><br><span class="line">        <span class="comment">// 定义熔断降级规则的类型</span></span><br><span class="line">        rule.setGrade(RuleConstant.DEGRADE_GRADE_RT);</span><br><span class="line">        <span class="comment">// 定义降级熔断时间（单位 s）</span></span><br><span class="line">        rule.setTimeWindow(<span class="number">5</span>);</span><br><span class="line">        <span class="comment">// 定义慢调用临界RT（超出该值计为慢调用，单位 s）</span></span><br><span class="line">        rule.setCount(<span class="number">0.005</span>);</span><br><span class="line">        <span class="comment">// 定义熔断触发的最小请求数</span></span><br><span class="line">        rule.setMinRequestAmount(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 定义统计时长（单位为 ms）</span></span><br><span class="line">        rule.setStatIntervalMs(<span class="number">1000</span>);</span><br><span class="line">        <span class="comment">// 定义慢调用比例阈值</span></span><br><span class="line">        rule.setSlowRatioThreshold(<span class="number">0.5</span>);</span><br><span class="line">        <span class="comment">// 将熔断降级规则添加到集合中</span></span><br><span class="line">        rules.add(rule);</span><br><span class="line">        <span class="comment">// 加载熔断降级规则</span></span><br><span class="line">        DegradeRuleManager.loadRules(rules);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>上述定义的慢调用比例熔断降级规则为：调用临界 RT（超出该值计为慢调用）值为 0.005 秒，当 1000 毫秒内请求数量大于 1，且慢调用的比例大于阈值大于 0.5，则熔断降级 5 秒。</p><hr><p>程序运行后，通过浏览器访问 <code>http://127.0.0.1:8080/hello</code>，然后快速多次刷新页面，若输出的日志信息类似下面的内容，则说明上面设置的熔断降级规则生效了。</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">2020-01-18 22:15:45.705  INFO 61206 --- [nio-8080-exec-1] c.s.study.controller.DegradeController   : sleep time: 8</span><br><span class="line">2020-01-18 22:15:46.585 ERROR 61206 --- [nio-8080-exec-3] c.s.study.controller.DegradeController   : fallback handler invoke</span><br><span class="line">2020-01-18 22:15:47.112 ERROR 61206 --- [nio-8080-exec-5] c.s.study.controller.DegradeController   : fallback handler invoke</span><br><span class="line">2020-01-18 22:15:48.911 ERROR 61206 --- [nio-8080-exec-7] c.s.study.controller.DegradeController   : fallback handler invoke</span><br><span class="line">2020-01-18 22:15:49.505 ERROR 61206 --- [nio-8080-exec-9] c.s.study.controller.DegradeController   : fallback handler invoke</span><br><span class="line">2020-01-18 22:15:49.809 ERROR 61206 --- [nio-8080-exec-1] c.s.study.controller.DegradeController   : fallback handler invoke</span><br><span class="line">2020-01-18 22:15:51.511  INFO 61206 --- [nio-8080-exec-3] c.s.study.controller.DegradeController   : sleep time: 1</span><br><span class="line">2020-01-18 22:15:51.834  INFO 61206 --- [nio-8080-exec-5] c.s.study.controller.DegradeController   : sleep time: 3</span><br><span class="line">2020-01-18 22:15:52.428 ERROR 61206 --- [nio-8080-exec-7] c.s.study.controller.DegradeController   : fallback handler invoke</span><br><span class="line">2020-01-18 22:15:52.846 ERROR 61206 --- [nio-8080-exec-9] c.s.study.controller.DegradeController   : fallback handler invoke</span><br></pre></td></tr></tbody></table></figure><h4 id="3-3-2、注解属性说明"><a href="#3-3-2、注解属性说明" class="headerlink" title="3.3.2、注解属性说明"></a>3.3.2、注解属性说明</h4><p><img data-src="../../../asset/2020/12/sentinel-annotation-configuration.png" alt="sentinel-annotation-configuration"></p><h4 id="3-3-3、Sentinel-控制台动态设置"><a href="#3-3-3、Sentinel-控制台动态设置" class="headerlink" title="3.3.3、Sentinel 控制台动态设置"></a>3.3.3、Sentinel 控制台动态设置</h4><p><img data-src="../../../asset/2020/12/sentinel-dashboard-add-degrade-rule.png" alt="sentinel-dashboard-add-degrade-rule"></p><h2 id="Sentinel-系统自适应保护实现"><a href="#Sentinel-系统自适应保护实现" class="headerlink" title="Sentinel 系统自适应保护实现"></a>Sentinel 系统自适应保护实现</h2><h3 id="4-0、系统自适应保护概述"><a href="#4-0、系统自适应保护概述" class="headerlink" title="4.0、系统自适应保护概述"></a>4.0、系统自适应保护概述</h3><p>在开始之前，先了解一下系统保护的目的：</p><ul><li>保证系统不被拖垮</li><li>在系统稳定的前提下，保持系统的吞吐量</li></ul><hr><p>长期以来，系统保护的思路是根据硬指标，即系统的负载 (load1) 来做系统过载保护。当系统负载高于某个阈值，就禁止或者减少流量的进入；当 load 开始好转，则恢复流量的进入。这个思路给我们带来了不可避免的两个问题：</p><ul><li><p>load 是一个 “结果”，如果根据 load 的情况来调节流量的通过率，那么就始终有延迟性。也就意味着通过率的任何调整，都会过一段时间才能看到效果。当前通过率是使 load 恶化的一个动作，那么也至少要过 1 秒之后才能观测到；同理，如果当前通过率调整是让 load 好转的一个动作，也需要 1 秒之后才能继续调整，这样就浪费了系统的处理能力。所以我们看到的曲线，总是会有抖动。</p></li><li><p>恢复慢。想象一下这样的一个场景（真实），出现了这样一个问题，下游应用不可靠，导致应用 RT 很高，从而 load 到了一个很高的点。过了一段时间之后下游应用恢复了，应用 RT 也相应减少。这个时候，其实应该大幅度增大流量的通过率；但是由于这个时候 load 仍然很高，通过率的恢复仍然不高。</p></li></ul><hr><p>TCP BBR 的思想给了我们一个很大的启发。我们应该根据系统能够处理的请求，和允许进来的请求，来做平衡，而不是根据一个间接的指标（系统 load）来做限流。最终我们追求的目标是在系统不被拖垮的情况下，提高系统的吞吐率，而不是 load 一定要到低于某个阈值。如果我们还是按照固有的思维，超过特定的 load 就禁止流量进入，系统 load 恢复就放开流量，这样做的结果是无论我们怎么调参数，调比例，都是按照果来调节因，都无法取得良好的效果。Sentinel 在系统自适应保护的做法是，用 load1 作为启动自适应保护的因子，而允许通过的流量由处理请求的能力，即请求的响应时间以及当前系统正在处理的请求速率来决定。</p><h3 id="4-1、系统自适应保护策略"><a href="#4-1、系统自适应保护策略" class="headerlink" title="4.1、系统自适应保护策略"></a>4.1、系统自适应保护策略</h3><p>系统保护规则是从应用级别的入口流量进行控制，从单台机器的 Load、CPU 使用率、平均 RT、入口 QPS 和并发线程数等几个维度监控应用指标，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。<strong>系统保护规则是应用整体维度的，而不是资源维度的，并且仅对入口流量生效。</strong>入口流量指的是进入应用的流量（EntryType.IN），比如 Web 服务或 Dubbo 服务端接收的请求，都属于入口流量。</p><hr><p>系统规则支持以策略：</p><ul><li><code>Load 自适应（仅对 Linux/Unix-like 机器生效）</code>：系统的 load1 作为启发指标，进行自适应系统保护。当系统 load1 超过设定的启发值，且系统当前的并发线程数超过估算的系统容量时才会触发系统保护（BBR 阶段）。系统容量由系统的 <code>maxQps * minRt</code> 估算得出。设定参考值一般是 <code>CPU cores * 2.5</code>。</li><li><code>CPU Usage（1.5.0+ 版本）</code>：当系统 CPU 使用率超过阈值即触发系统保护（取值范围 0.0-1.0），比较灵敏。</li><li><code>平均 RT</code>：当单台机器上所有入口流量的平均 RT 达到阈值即触发系统保护，单位是毫秒。</li><li><code>并发线程数</code>：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。</li><li><code>入口 QPS</code>：当单台机器上所有入口流量的 QPS 达到阈值即触发系统保护。</li></ul><h3 id="4-2、系统自适应保护规则的属性"><a href="#4-2、系统自适应保护规则的属性" class="headerlink" title="4.2、系统自适应保护规则的属性"></a>4.2、系统自适应保护规则的属性</h3><p><img data-src="../../../asset/2020/12/sentinel-system-auto-protect.png" alt="sentinel-system-auto-protect"></p><p><strong>特别注意：</strong>系统自适应保护规则只针对入口资源（EntryType.IN）有效</p><h3 id="4-3、系统自适应保护规则的设置"><a href="#4-3、系统自适应保护规则的设置" class="headerlink" title="4.3、系统自适应保护规则的设置"></a>4.3、系统自适应保护规则的设置</h3><p>系统自适应保护规则设置有以下两种方式：</p><ul><li>本地代码设置</li><li>在 Sentinel 控制台动态设置</li></ul><h4 id="4-3-1、代码设置"><a href="#4-3-1、代码设置" class="headerlink" title="4.3.1、代码设置"></a>4.3.1、代码设置</h4><p>以下演示的是如何使用 <code>入口 QPS</code> 系统自适应保护规则，<a href="/downloads/2020/12/sentinel-system-protect-demo.zip">点击下载</a>完整的案例代码。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SystemProtectController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义资源</span></span><br><span class="line"><span class="comment">     * EntryType.IN 表示入口资源</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SentinelResource(entryType = EntryType.IN)</span></span><br><span class="line">    <span class="meta">@GetMapping("/hello")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello Sentinel!"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义系统自适应保护规则</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initSystemRule</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// 创建存放系统自适应保护规则的集合</span></span><br><span class="line">        List&lt;SystemRule&gt; rules = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// 创建系统自适应保护规则</span></span><br><span class="line">        SystemRule rule = <span class="keyword">new</span> SystemRule();</span><br><span class="line">        <span class="comment">// 定义入口资源的QPS（每秒允许的最大请求数）</span></span><br><span class="line">        rule.setQps(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// 添加系统自适应保护规则到集合中</span></span><br><span class="line">        rules.add(rule);</span><br><span class="line">        <span class="comment">// 加载系统自适应保护规则</span></span><br><span class="line">        SystemRuleManager.loadRules(rules);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>程序运行后，当 <code>/hello</code> 接口每秒请求的次数大于 2，则会触发 Sentinel 的系统自适应保护规则，同时会返回 <code>Blocked by Sentinel (flow limiting)</code> 字符串给客户端。</p><h4 id="4-3-2、Sentinel-控制台动态设置"><a href="#4-3-2、Sentinel-控制台动态设置" class="headerlink" title="4.3.2、Sentinel 控制台动态设置"></a>4.3.2、Sentinel 控制台动态设置</h4><p><img data-src="../../../asset/2020/12/sentinel-add-system-rule.png" alt="sentinel-add-system-rule"></p><h2 id="Sentinel-来源访问控制实现"><a href="#Sentinel-来源访问控制实现" class="headerlink" title="Sentinel 来源访问控制实现"></a>Sentinel 来源访问控制实现</h2><h3 id="5-0、来源访问控制概述"><a href="#5-0、来源访问控制概述" class="headerlink" title="5.0、来源访问控制概述"></a>5.0、来源访问控制概述</h3><p>很多时候需要根据调用来源来判断该次请求是否允许放行，这时候可以使用 Sentinel 的来源访问控制（授权控制、黑白名单控制）的功能。来源访问控制根据资源的请求来源（origin）限制资源是否通过，若配置白名单则只有请求来源位于白名单内时才可通过；若配置黑名单则请求来源位于黑名单时不通过，其余的请求通过。调用方的信息通过 <code>ContextUtil.enter(resourceName, origin)</code> 方法中的 <code>origin</code> 参数传入。<strong>特别注意，白名单和黑名单不能同时使用。</strong></p><h3 id="5-1、来源访问控制规则的属性"><a href="#5-1、来源访问控制规则的属性" class="headerlink" title="5.1、来源访问控制规则的属性"></a>5.1、来源访问控制规则的属性</h3><p>来源访问控制规则（AuthorityRule）非常简单，主要有以下配置项：</p><ul><li>resource：资源名，即流控规则的作用对象。</li><li>limitApp：对应的黑名单 / 白名单，不同 origin 用 <code>,</code> 分隔，例如 <code>appA,appB</code>。</li><li>strategy：限制模式，<code>AUTHORITY_WHITE</code> 为白名单模式，<code>AUTHORITY_BLACK</code> 为黑名单模式，默认为白名单模式。</li></ul><h3 id="5-2、来源访问控制规则的设置"><a href="#5-2、来源访问控制规则的设置" class="headerlink" title="5.2、来源访问控制规则的设置"></a>5.2、来源访问控制规则的设置</h3><p>来源访问控制规则设置有以下两种方式：</p><ul><li>本地代码设置</li><li>在 Sentinel 控制台动态设置</li></ul><h4 id="5-2-1、代码设置"><a href="#5-2-1、代码设置" class="headerlink" title="5.2.1、代码设置"></a>5.2.1、代码设置</h4><p>下面将演示如何使用白名单来源访问控制规则，<a href="/downloads/2020/12/sentinel-origin-control-demo.zip">点击下载</a>完整的案例代码。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义来源解析器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Component</span></span><br><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestOriginParserDefinition</span> <span class="keyword">implements</span> <span class="title">RequestOriginParser</span> </span>{</span><br><span class="line"></span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> String <span class="title">parseOrigin</span><span class="params">(HttpServletRequest httpServletRequest)</span> </span>{</span><br><span class="line">         <span class="keyword">return</span> httpServletRequest.getRemoteAddr();</span><br><span class="line">     }</span><br><span class="line"> }</span><br></pre></td></tr></tbody></table></figure><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OriginControlController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String RESOURCE_NAME = <span class="string">"Origin"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@SentinelResource</span> 定义资源</span></span><br><span class="line"><span class="comment">     * value：资源名称</span></span><br><span class="line"><span class="comment">     * blockHandler：被限制访问时处理的方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = RESOURCE_NAME, blockHandler = "exceptionHandler")</span></span><br><span class="line">    <span class="meta">@GetMapping("/hello")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello Sentinel!"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 原方法被限制访问的时候调用此方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">exceptionHandler</span><span class="params">(BlockException e)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"系统繁忙，请稍候 ..."</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义来源访问控制规则（黑名单）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initBlackRule</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// 创建存放规则的集合</span></span><br><span class="line">        List&lt;AuthorityRule&gt; rules = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// 创建来源访问控制规则</span></span><br><span class="line">        AuthorityRule rule = <span class="keyword">new</span> AuthorityRule();</span><br><span class="line">        <span class="comment">// 定义资源名称</span></span><br><span class="line">        rule.setResource(RESOURCE_NAME);</span><br><span class="line">        <span class="comment">// 定义限制模式</span></span><br><span class="line">        rule.setStrategy(RuleConstant.AUTHORITY_BLACK);</span><br><span class="line">        <span class="comment">// 定义请求来源</span></span><br><span class="line">        rule.setLimitApp(<span class="string">"127.0.0.1"</span>);</span><br><span class="line">        <span class="comment">// 将规则保存到集合中</span></span><br><span class="line">        rules.add(rule);</span><br><span class="line">        <span class="comment">// 加载规则</span></span><br><span class="line">        AuthorityRuleManager.loadRules(rules);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>程序运行后，通过浏览器访问 <code>http://127.0.0.1:8080/hello</code>，若响应结果为 <code>系统繁忙，请稍候 ...</code>，则说明上面设置的黑名单来源控制规则生效了。</p><h4 id="5-2-2、Sentinel-控制台动态设置"><a href="#5-2-2、Sentinel-控制台动态设置" class="headerlink" title="5.2.2、Sentinel 控制台动态设置"></a>5.2.2、Sentinel 控制台动态设置</h4><p><img data-src="../../../asset/2020/12/sentinel-add-origin-control-rule.png" alt="sentinel-add-origin-control-rule"></p><h2 id="Sentinel-动态规则扩展（持久化规则）"><a href="#Sentinel-动态规则扩展（持久化规则）" class="headerlink" title="Sentinel 动态规则扩展（持久化规则）"></a>Sentinel 动态规则扩展（持久化规则）</h2><p>Sentinel 的理念是开发者只需要关注资源的定义，当资源定义成功后可以动态增加各种流控降级规则。Sentinel 提供以下几种方式设置规则：</p><ul><li>通过 API 直接设置 (loadRules)</li><li> 通过 DataSource 适配不同数据源修改</li></ul><p>手动通过 API 设置比较直观，可以通过以下几个 API 设置不同的规则：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FlowRuleManager.loadRules(List&lt;FlowRule&gt; rules); <span class="comment">// 设置流控规则</span></span><br><span class="line">DegradeRuleManager.loadRules(List&lt;DegradeRule&gt; rules); <span class="comment">// 设置熔断降级规则</span></span><br><span class="line">SystemRuleManager.loadRules(List&lt;SystemRule&gt; rules); <span class="comment">// 设置系统自适应保护规则</span></span><br><span class="line">AuthorityRuleManager.loadRules(List&lt;AuthorityRule&gt; rules); <span class="comment">// 设置来源访问控制规则</span></span><br></pre></td></tr></tbody></table></figure><h3 id="6-0、DataSource-扩展"><a href="#6-0、DataSource-扩展" class="headerlink" title="6.0、DataSource 扩展"></a>6.0、DataSource 扩展</h3><p>不管是通过 Java 代码还是通过 Sentinel 控制台的方式设置流控降级规则，都属于手动方式，不够灵活。这种方式一般仅用于测试和演示，生产环境一般通过动态规则源的方式来动态管理流控降级规则。<strong>上述 <code>loadRules()</code> 方法只接受内存态的规则对象，但更多时候规则存储在文件、数据库或者配置中心当中</strong>。Sentinel 的 <code>DataSource</code> 接口提供了对接任意数据源的能力。<a target="_blank" rel="external nofollow" href="https://github.com/alibaba/Sentinel/wiki/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%99%E6%89%A9%E5%B1%95">Sentinel 官方推荐</a>通过控制台设置规则后，将规则推送到统一的规则中心，客户端则实现 <code>ReadableDataSource</code> 接口监听规则中心来实时获取规则配置的变更，流程图如下：</p><p><img data-src="../../../asset/2020/12/sentinel-data-source.png" alt="sentinel-data-source"></p><p><strong>DataSource 扩展常见的实现方式有:</strong></p><ul><li><code>拉模式</code>：客户端主动向某个规则管理中心定期轮询拉取规则，这个规则中心可以是 RDBMS、文件，甚至是 VCS 等。这样做的方式是简单，缺点是无法及时获取变更</li><li><code>推模式</code>：规则中心统一推送，客户端通过注册监听器的方式时刻监听变化，比如使用 Nacos、Zookeeper 等配置中心，这种方式有更好的实时性和一致性保证</li></ul><p><strong>Sentinel 目前支持以下数据源扩展：</strong></p><ul><li><code>Pull-based（拉模式）</code>: 动态文件数据源、Consul、Eureka</li><li><code>Push-based（推模式）</code>: ZooKeeper、Apollo、Nacos, etcd、Redis</li></ul><h3 id="6-1、使用-ZooKeeper-规则配置（推模式）"><a href="#6-1、使用-ZooKeeper-规则配置（推模式）" class="headerlink" title="6.1、使用 ZooKeeper 规则配置（推模式）"></a>6.1、使用 ZooKeeper 规则配置（推模式）</h3><p>下面将演示如何使用 ZooKeeper 存放 Sentinel 的流控规则配置数据，使用的是 <code>推模式</code>，各组件的版本如下，<a href="/downloads/2020/12/sentinel-zookeeper-demo.zip">点击下载</a>完整的案例代码。</p><ul><li>Sentinel 1.8.0</li><li>ZooKeeper Server 3.5.5</li><li>Spring Boot 2.1.18.RELEASE</li><li>Sentinel Datasource Zookeeper 1.8.0</li><li>Spring Cloud Starter Sentinel 2.1.3.RELEASE</li></ul><hr><h4 id="6-1-1、代码示例"><a href="#6-1-1、代码示例" class="headerlink" title="6.1.1、代码示例"></a>6.1.1、代码示例</h4><p>引入 Maven 依赖，添加 <code>sentinel-datasource-zookeeper</code> 依赖</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;parent&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.1.18.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">&lt;properties&gt;</span><br><span class="line">    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">    &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;</span><br><span class="line">    &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;</span><br><span class="line">    &lt;spring-cloud-starter-sentinel&gt;2.1.3.RELEASE&lt;/spring-cloud-starter-sentinel&gt;</span><br><span class="line">    &lt;sentinel-datasource-zookeeper.version&gt;1.8.0&lt;/sentinel-datasource-zookeeper.version&gt;</span><br><span class="line">&lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">        &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;${spring-cloud-starter-sentinel}&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;sentinel-datasource-zookeeper&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;${sentinel-datasource-zookeeper.version}&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></tbody></table></figure><p>创建 Sentinel 的 配置类，让 Sentinel 使用 ZooKeeper 作为规则配置数据源</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SentinelZookeeperConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ZOOKEEPER_ADDRESS = <span class="string">"127.0.0.1:2181"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ZOOKEEPER_PATH = <span class="string">"/Sentinel/FlowRules"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sentinel从Zookeeper加载规则配置数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// 参数一：Zookeeper的地址</span></span><br><span class="line">        <span class="comment">// 参数二：Zookeeper中数据的路径</span></span><br><span class="line">        <span class="comment">// 参数三：Zookeeper中数据的解析器</span></span><br><span class="line">        ReadableDataSource&lt;String, List&lt;FlowRule&gt;&gt; flowRuleDataSource = <span class="keyword">new</span> ZookeeperDataSource&lt;&gt;(</span><br><span class="line">                ZOOKEEPER_ADDRESS,</span><br><span class="line">                ZOOKEEPER_PATH,</span><br><span class="line">                source -&gt; JSON.parseObject(source, <span class="keyword">new</span> TypeReference&lt;List&lt;FlowRule&gt;&gt;() {</span><br><span class="line">                }));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加载流控规则</span></span><br><span class="line">        FlowRuleManager.register2Property(flowRuleDataSource.getProperty());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>创建 Controller 测试类</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger LOG = LoggerFactory.getLogger(HelloController.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 资源名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String RESOURCE_NAME = <span class="string">"Hello"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@SentinelResource</span> 定义资源</span></span><br><span class="line"><span class="comment">     * value：资源名称</span></span><br><span class="line"><span class="comment">     * blockHandler：限流处理的方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = RESOURCE_NAME, blockHandler = "exceptionHandler")</span></span><br><span class="line">    <span class="meta">@GetMapping("/hello")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello Sentinel!"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 原方法被限流的时候调用此方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">exceptionHandler</span><span class="params">(BlockException e)</span> </span>{</span><br><span class="line">        LOG.info(<span class="string">"系统繁忙，请稍候 ..."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"系统繁忙，请稍候 ..."</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>创建主启动类</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SentinelApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        SpringApplication.run(SentinelApplication.class, args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>创建 <code>application.yml</code> 配置文件，其中 <code>sentinel.transport.dashboard</code> 为非必要配置项；<strong>若不需要通过 Sentinel 控制台监控应用，这里可以不配置 <code>sentinel.transport.dashboard</code>，无论是否配置都不会影响应用加载和动态感知 ZooKeeper Server 中的规则配置数据</strong></p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">sentinel-zookeeper-demo</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9000</span>       <span class="comment"># 非必要配置项</span></span><br></pre></td></tr></tbody></table></figure><p>创建 ZooKeeper 的数据测试类，作用是插入规则配置数据到 ZooKeeper</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZookeeperConfigSender</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RETRY_TIMES = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SLEEP_TIME = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendData</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="keyword">final</span> String remoteAddress = <span class="string">"127.0.0.1:2181"</span>;</span><br><span class="line">        <span class="keyword">final</span> String groupId = <span class="string">"Sentinel"</span>;</span><br><span class="line">        <span class="keyword">final</span> String dataId = <span class="string">"FlowRules"</span>;</span><br><span class="line">        <span class="keyword">final</span> String rule = <span class="string">"[\n"</span></span><br><span class="line">                + <span class="string">"  {\n"</span></span><br><span class="line">                + <span class="string">"    \"resource\": \"Hello\",\n"</span></span><br><span class="line">                + <span class="string">"    \"controlBehavior\": 0,\n"</span></span><br><span class="line">                + <span class="string">"    \"count\": 2.0,\n"</span></span><br><span class="line">                + <span class="string">"    \"grade\": 1,\n"</span></span><br><span class="line">                + <span class="string">"    \"limitApp\": \"default\",\n"</span></span><br><span class="line">                + <span class="string">"    \"strategy\": 0\n"</span></span><br><span class="line">                + <span class="string">"  }\n"</span></span><br><span class="line">                + <span class="string">"]"</span>;</span><br><span class="line"></span><br><span class="line">        CuratorFramework zkClient = CuratorFrameworkFactory.newClient(remoteAddress, <span class="keyword">new</span> ExponentialBackoffRetry(SLEEP_TIME, RETRY_TIMES));</span><br><span class="line">        zkClient.start();</span><br><span class="line">        String path = getPath(groupId, dataId);</span><br><span class="line">        Stat stat = zkClient.checkExists().forPath(path);</span><br><span class="line">        <span class="keyword">if</span> (stat == <span class="keyword">null</span>) {</span><br><span class="line">            zkClient.create().creatingParentContainersIfNeeded().withMode(CreateMode.PERSISTENT).forPath(path, <span class="keyword">null</span>);</span><br><span class="line">        }</span><br><span class="line">        zkClient.setData().forPath(path, rule.getBytes());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        zkClient.close();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getPath</span><span class="params">(String groupId, String dataId)</span> </span>{</span><br><span class="line">        String path = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">if</span> (groupId.startsWith(<span class="string">"/"</span>)) {</span><br><span class="line">            path += groupId;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            path += <span class="string">"/"</span> + groupId;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (dataId.startsWith(<span class="string">"/"</span>)) {</span><br><span class="line">            path += dataId;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            path += <span class="string">"/"</span> + dataId;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="6-1-2、测试代码"><a href="#6-1-2、测试代码" class="headerlink" title="6.1.2、测试代码"></a>6.1.2、测试代码</h4><ul><li>1）启动 ZooKeeper Server</li><li>2）启动 <code>sentinel-zookeeper-demo</code> 应用，若控制台输出如下日志信息，则说明应用已经成功连接上 ZooKeeper 服务器</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[localhost:2181)] org.apache.zookeeper.ClientCnxn          : Opening socket connection to server localhost/127.0.0.1:2181. Will not attempt to authenticate using SASL (unknown error)</span><br><span class="line">[localhost:2181)] org.apache.zookeeper.ClientCnxn          : Socket connection established to localhost/127.0.0.1:2181, initiating session</span><br><span class="line">[localhost:2181)] org.apache.zookeeper.ClientCnxn          : Session establishment complete on server localhost/127.0.0.1:2181, sessionid = 0x10000447be50007, negotiated timeout = 40000</span><br><span class="line">[ain-EventThread] o.a.c.f.state.ConnectionStateManager     : State change: CONNECTED</span><br></pre></td></tr></tbody></table></figure><ul><li>3）浏览器访问 <code>http://127.0.0.1:8080/hello</code>，快速多次刷新页面，可以发现响应结果会一直返回 <code>Hello Sentinel!</code> 字符串</li><li> 4）通过 Junit 执行 <code>ZookeeperConfigSender.sendData()</code> 方法，将规则配置数据插入到 ZooKeeper Server</li><li>5）通过命令行登录进 ZooKeeper Server 后，执行以下操作，可以观察到 ZooKeeper Server 中有对应的规则配置数据成功插入了</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 15] get /Sentinel/FlowRules</span><br><span class="line">[</span><br><span class="line">  {</span><br><span class="line">    "resource": "Hello",</span><br><span class="line">    "controlBehavior": 0,</span><br><span class="line">    "count": 2.0,</span><br><span class="line">    "grade": 1,</span><br><span class="line">    "limitApp": "default",</span><br><span class="line">    "strategy": 0</span><br><span class="line">  }</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure><ul><li>6）浏览器再次快速多次访问 <code>http://127.0.0.1:8080/hello</code>，若响应结果为 <code>系统繁忙，请稍候 ...</code>，则说明 Sentinel 成功加载到 ZooKeeper Server 里的规则配置数据，而且是基于 <code>推模式</code>，默认支持监听规则配置的变更</li></ul><h3 id="6-2、更多数据源扩展支持"><a href="#6-2、更多数据源扩展支持" class="headerlink" title="6.2、更多数据源扩展支持"></a>6.2、更多数据源扩展支持</h3><p>Sentinel 默认还支持文件、Nacos、Apollo、Redis 等作为数据源扩展，这里不再累述，具体可以阅读<a target="_blank" rel="external nofollow" href="https://github.com/alibaba/Sentinel/wiki/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%99%E6%89%A9%E5%B1%95">官方文档中的动态规则扩展</a>。</p></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script>var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if(!isMobile)try{var plugin=new ReadmorePlugin;plugin.init({id:"readmore-container",blogId:"96641-5333172926158-056",name:"全栈技术驿站",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",lockToc:"yes",type:"hexo",random:"0.9",interval:"30",expires:"365"})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>坚持原创技术分享，您的支持将鼓励我继续创作！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/e3c83db6.html" title="Sentinel 入门教程 - 中级篇">https://www.techgrow.cn/posts/e3c83db6.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎加入微信群</span><br> <img src="/img/wx-group-qr-technology.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="fa fa-tag"></i> 微服务</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/94326301.html" rel="prev" title="百度统计 API（Python 版）"><i class="fa fa-chevron-left"></i> 百度统计 API（Python 版）</a></div><div class="post-nav-item"> <a href="/posts/63e3926c.html" rel="next" title="Sentinel 入门教程 - 整合篇">Sentinel 入门教程 - 整合篇<i class="fa fa-chevron-right"></i></a></div></div><div style="text-align:center"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4014850419768221" data-ad-slot="7586134725" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright &copy; 2018 – <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">652k</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 &asymp;</span> <span title="站点阅读时长">9:53</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & NexT & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="beian"> <span><img src="/img/gonganbeian.png" alt></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备19024664号</a></span></div></div></footer><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-tu9j5pBilBQrWSDePOOajCUdz6hWsid/lBNzK4KgEPM="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"/lib/mermaid/dist/mermaid.min.js","integrity":"sha256-8L3O8tirFUa8Va4NSTAyIbHJeLd6OnlcxgupV9F77e0="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://unpkg.com/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '32px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://unpkg.com/qiniu-js@3.3.1/dist/qiniu.min.js"></script><script>
    var qiniu_domain = "https://qiniu.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/app/api/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn:9360","cssUrl":"https://unpkg.com/@waline/client@2.5.1/dist/waline.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://unpkg.com/@waline/client@2.5.1/dist/waline.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://unpkg.com/@waline/emojis@1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://qiniu.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/app/api/qiniu/token/upload","el":"#waline","comment":true,"path":"/posts/e3c83db6.html"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@2.5.1/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>