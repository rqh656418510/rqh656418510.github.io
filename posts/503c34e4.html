<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.13.0","exturl":false,"sidebar":{"position":"left","width":300,"display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍Nginx + Keepalived 实现双机主备高可用。"><meta property="og:type" content="article"><meta property="og:title" content="Nginx + Keepalived 实现双机主备高可用"><meta property="og:url" content="https://www.techgrow.cn/posts/503c34e4.html"><meta property="og:site_name" content="远方的思念"><meta property="og:description" content="本文主要介绍Nginx + Keepalived 实现双机主备高可用。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/03/nginx-keepalived-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/03/nginx-keepalived-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/03/nginx-keepalived-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/03/nginx-keepalived-4.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/03/nginx-keepalived-5.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/03/nginx-keepalived-6.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/03/nginx-keepalived-7.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/03/nginx-keepalived-model.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2021/03/nginx-keepalived-model-2.png"><meta property="article:published_time" content="2020-06-16T12:27:32.000Z"><meta property="article:modified_time" content="2020-06-16T12:27:32.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Web服务器"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2021/03/nginx-keepalived-1.png"><link rel="canonical" href="https://www.techgrow.cn/posts/503c34e4.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/503c34e4.html","path":"posts/503c34e4.html","title":"Nginx + Keepalived 实现双机主备高可用"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Nginx + Keepalived 实现双机主备高可用 | 远方的思念</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn:9360"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="远方的思念" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax>!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/app/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt></div><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">远方的思念</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-openplatform"><a href="https://open.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-toolbox fa-fw"></i>开放平台</a></li><li class="menu-item menu-item-readingnotes"><a href="https://docs.techgrow.cn/notes/" rel="external nofollow" target="_blank"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn:9360/ui/login?lng=zh-cn" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-text">负载均衡的实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Keepalived-%E6%A6%82%E8%BF%B0"><span class="nav-text">Keepalived 概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Keepalived-%E7%AE%80%E4%BB%8B"><span class="nav-text">Keepalived 简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VRRP-%E5%8D%8F%E8%AE%AE%E4%B8%8E%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-text">VRRP 协议与工作原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Keepalvied-%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-text">Keepalvied 的工作原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Keepalived-%E7%9A%84%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84"><span class="nav-text">Keepalived 的体系结构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-Keepalived-%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4"><span class="nav-text">Nginx + Keepalived 搭建高可用集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="nav-text">部署架构图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A7%84%E5%88%92"><span class="nav-text">服务器规划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-text">准备工作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="nav-text">软件安装</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Nginx-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"><span class="nav-text">Nginx 编译安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Keepalived-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"><span class="nav-text">Keepalived 编译安装</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Keepalived-%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE"><span class="nav-text">Keepalived 核心配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E8%99%9A%E6%8B%9F-IP"><span class="nav-text">测试虚拟 IP</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Master-%E8%8A%82%E7%82%B9%E6%9F%A5%E7%9C%8B%E8%99%9A%E6%8B%9F-IP"><span class="nav-text">Master 节点查看虚拟 IP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Backup-%E8%8A%82%E7%82%B9%E6%9F%A5%E7%9C%8B%E8%99%9A%E6%8B%9F-IP"><span class="nav-text">Backup 节点查看虚拟 IP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E8%99%9A%E6%8B%9F-IP-%E8%AE%BF%E9%97%AE-Nginx"><span class="nav-text">使用虚拟 IP 访问 Nginx</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BB%E5%A4%87%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%AB%98%E5%8F%AF%E7%94%A8%E5%88%87%E6%8D%A2"><span class="nav-text">主备服务器高可用切换</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Keepalived-%E8%84%91%E8%A3%82%EF%BC%88%E4%B8%BB%E5%A4%87%E8%8A%82%E7%82%B9%E5%9D%87%E6%9C%89-VIP%EF%BC%89"><span class="nav-text">Keepalived 脑裂（主备节点均有 VIP）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%91%E8%A3%82%E5%8E%9F%E5%9B%A0"><span class="nav-text">脑裂原因</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%91%E8%A3%82%E6%96%B9%E6%A1%88"><span class="nav-text">脑裂方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%91%E8%A3%82%E6%8A%A5%E8%AD%A6%E8%84%9A%E6%9C%AC"><span class="nav-text">脑裂报警脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-Keepalived-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2%E6%9E%B6%E6%9E%84%E6%96%B9%E6%A1%88"><span class="nav-text">Nginx + Keepalived 高可用部署架构方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FAQ"><span class="nav-text">FAQ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Master-%E8%8A%82%E7%82%B9%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE%E8%99%9A%E6%8B%9F-IP"><span class="nav-text">Master 节点无法访问虚拟 IP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Backup-%E8%8A%82%E7%82%B9%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE%E8%99%9A%E6%8B%9F-IP"><span class="nav-text">Backup 节点无法访问虚拟 IP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx-%E6%9C%8D%E5%8A%A1%E4%BD%BF%E7%94%A8%E9%9D%9E%E9%BB%98%E8%AE%A4%E7%9A%84-80-%E7%AB%AF%E5%8F%A3"><span class="nav-text">Nginx 服务使用非默认的 80 端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Master-%E8%8A%82%E7%82%B9%E4%B8%8E-Backup-%E8%8A%82%E7%82%B9%E5%90%8C%E6%97%B6%E7%94%9F%E6%88%90%E4%BA%86%E8%99%9A%E6%8B%9F-IP"><span class="nav-text">Master 节点与 Backup 节点同时生成了虚拟 IP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%95%86%E4%B8%9A%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AF%B9-Keepalived-%E7%9A%84%E6%94%AF%E6%8C%81"><span class="nav-text">商业云服务器对 Keepalived 的支持</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E5%8D%9A%E5%AE%A2"><span class="nav-text">参考博客</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">403</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">41</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → &#x2F;sitemap.xml"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="external nofollow" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/503c34e4.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="远方的思念"><meta itemprop="description" content="专注于 Java、前端、移动端、微服务、分布式系统、数据库、系统架构、人工智能、大数据、云计算、物联网、虚拟化学习的技术博客。"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Nginx + Keepalived 实现双机主备高可用 | 远方的思念"><meta itemprop="description" content="本文主要介绍Nginx + Keepalived 实现双机主备高可用。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Nginx + Keepalived 实现双机主备高可用</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-06-16 20:27:32" itemprop="dateCreated datePublished" datetime="2020-06-16T20:27:32+08:00">2020-06-16</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/503c34e4.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/503c34e4.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>7.3k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>7 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><div id="readmore-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="负载均衡的实现"><a href="#负载均衡的实现" class="headerlink" title="负载均衡的实现"></a>负载均衡的实现</h3><ul><li>TCP 层实现的负载均衡，例如：LVS（调度性能强悍）</li><li>应用层实现的负载均衡，例如：Nginx、Haproxy、Apache (mod_proxy)、Varnish、Squid、Ribbon</li></ul><h2 id="Keepalived-概述"><a href="#Keepalived-概述" class="headerlink" title="Keepalived 概述"></a>Keepalived 概述</h2><h3 id="Keepalived-简介"><a href="#Keepalived-简介" class="headerlink" title="Keepalived 简介"></a>Keepalived 简介</h3><p>  <a target="_blank" rel="external nofollow" href="https://www.keepalived.org/index.html">Keepalived</a> 是 Linux 下一个轻量级别的高可用开源解决方案，高可用 (High Avalilability)，其实两种不同的含义：广义来讲，是指整个系统的高可用行，狭义的来讲就是之主机的冗余和接管，它与 HeartBeat RoseHA 实现相同类似的功能，都可以实现服务或者网络的高可用；但是又有差别，HeartBeat 是一个专业的、功能完善的高可用软件，它提供了 HA 软件所需的基本功能，比如：心跳检测、资源接管、检测集群中的服务、在集群节点转移共享 IP 地址的所有者等等。HeartBeat 功能强大，但是部署和使用相对比较麻烦，与 HeartBeat 相比，Keepalived 主要是通过虚拟路由冗余来实现高可用功能，虽然它没有 HeartBeat 功能强大，但是 Keepalived 部署和使用非常的简单，所有配置只需要一个配置文件即可以完成。<strong>Keepalived 实现了轻量级的高可用，一般用于前端高可用，且不需要共享存储，一般常用于两个节点的高可用。而 Heartbeat 用于服务的高可用，且需要共享存储，一般用于多节点的高可用。</strong></p><p>  Keepalived 起初是专为 LVS 设计的，用来管理并监控 LVS 集群系统中各个服务节点的状态，后来又加入了可以实现高可用的 VRRP 功能。<strong>因此，Keepalived 除了能够管理 LVS 软件外，还可以实现任意两台主机之间，例如 Master 和 Backup 主机之间的故障转移和自动切换，这个主机可以是普通的不能停机的业务服务器，也可以是 LVS 负载均衡、Nginx 反向代理这样的服务器。</strong>Keepalived 软件主要是通过 VRRP 协议实现高可用功能的，VRRP 是 Virtual Router Redundancy Protocol（虚拟路由冗余协议）的缩写，VRRP 出现的目的就是为了解决静态路由的单点故障问题的，它能保证当个别节点宕机时，整个网络可以不间断、稳定地运行。所以，Keepalived 一方面具有配置管理 LVS 的功能，同时还具有对 LVS 下面节点进行健康检查的功能，另一方面也可以实现系统网络服务的高可用功能。</p><span id="more"></span><h3 id="VRRP-协议与工作原理"><a href="#VRRP-协议与工作原理" class="headerlink" title="VRRP 协议与工作原理"></a>VRRP 协议与工作原理</h3><p>  在现实的网络环境中，主机之间的通信都是通过配置静态路由或者 (默认网关) 来完成的，而主机之间的路由器一旦发生故障，通信就会失效，因此这种通信模式当中，路由器就成了一个单点瓶颈，为了解决这个问题，就引入了 VRRP 协议，它是一种主备模式的协议，通过 VRRP 可以在网络发生故障时透明的进行设备切换而不影响主机之间的数据通信，这其中涉及到两个概念：物理路由器和虚拟路由器。</p><p>  VRRP 可以将两台或者多台物理路由器设备虚拟成一个虚拟路由，这个虚拟路由器通过虚拟 IP（一个或者多个) 对外提供服务，而在虚拟路由器内部十多个物理路由器协同工作，同一时间只有一台物理路由器对外提供服务，这台物理路由设备被成为：主路由器（Master 角色)，一般情况下 Master 是由选举算法产生，它拥有对外服务的虚拟 IP，提供各种网络功能，如：ARP 请求，ICMP 数据转发等，而且其它的物理路由器不拥有对外的虚拟 IP，也不提供对外网络功能，仅仅接收 MASTER 的 VRRP 状态通告信息，这些路由器被统称为 “BACKUP 的角色”，当主路由器失败时，处于 BACKUP 角色的备份路由器将重新进行选举，产生一个新的主路由器进入 MASTER 角色，继续提供对外服务，整个切换对用户来说是完全透明的。</p><p>  每个虚拟路由器都有一个唯一的标识号，称为 VRID，一个 VRID 与一组 IP 地址构成一个虚拟路由器，在 VRRP 协议中，所有的报文都是通过 IP 多播方式发送的，而在一个虚拟路由器中，只有处于 Master 角色的路由器会一直发送 VRRP 数据包，处于 BACKUP 角色的路由器只会接受 Master 角色发送过来的报文信息，用来监控 Master 运行状态，一般不会发生 BACKUP 抢占的情况，除非它的优先级更高，而当 MASTER 不可用时，BACKUP 也就无法收到 Master 发过来的信息，于是就认定 Master 出现故障，接着多台 BAKCUP 就会进行选举，优先级最高的 BACKUP 将称为新的 MASTER，这种选举角色切换非常之快（&lt; 1s），因而保证了服务的持续可用性。</p><h3 id="Keepalvied-的工作原理"><a href="#Keepalvied-的工作原理" class="headerlink" title="Keepalvied 的工作原理"></a>Keepalvied 的工作原理</h3><p>  Keepalived 通过 VRRP 实现高可用，作为一个高性能集群软件，它还能实现对集群中服务器运行状态的监控以及故障隔离。Keepalived 工作在 TCP/IP 参考模型的 三层、四层、五层，也就是分别为：网络层，传输层和应用层，根据 TCP、IP 参数模型隔层所能实现的功能，Keepalived 运行机制如下：</p><ul><li><p><code>在网络层</code>： 运行 4 个重要的协议：互联网络 IP 协议，互联网络可控制报文协议 ICMP、地址转换协议 ARP、反向地址转换协议 RARP，Keepalived 在网络层采用最常见的工作方式是通过 ICMP 协议向服务器集群中的每一个节点发送一个 ICMP 数据包 (有点类似与 Ping 的功能)， 如果某个节点没有返回响应数据包，那么认为该节点发生了故障，Keepalived 将报告这个节点失效，并从服务器集群中剔除故障节点；</p></li><li><p><code>在传输层</code>： 提供了两个主要的协议：传输控制协议 TCP 和用户数据协议 UDP，传输控制协议 TCP 可以提供可靠的数据输出服务、 IP 地址和端口，代表 TCP 的一个连接端，要获得 TCP 服务，需要在发送机的一个端口和接收机的一个端口上建立连接，而 Keepalived 在传输层里利用了 TCP 协议的端口连接和扫描技术来判断集群节点的端口是否正常，比如对于常见的 WEB 服务器 80 端口。或者 SSH 服务 22 端口，Keepalived 一旦在传输层探测到这些端口号没有数据响应和数据返回，就认为这些端口发生异常，然后强制将这些端口所对应的节点从服务器集群中剔除掉；</p></li><li><p><code>在应用层</code>：可以运行 FTP，TELNET，SMTP，DNS 等各种不同类型的高层协议，Keepalived 的运行方式也更加全面化和复杂化，用户可以通过自定义 Keepalived 工作方式，例如：可以通过编写程序或者脚本来运行 Keepalived，而 Keepalived 将根据用户的设定参数检测各种程序或者服务是否允许正常，如果 Keepalived 的检测结果和用户设定的不一致时，Keepalived 将把对应的服务器从服务器集群中剔除；</p></li></ul><p>  Keepalived 高可用服务对之间的故障切换转移，是通过 VRRP 来实现的。在 Keepalived 服务工作时，主 Master 节点会不断地向备节点发送（多播的方式）心跳消息，用来告诉备 Backup 节点自己还活着。当主节点发生故障时，就无法发送心跳的消息了，备节点也因此无法继续检测到来自主节点的心跳了。于是就会调用自身的接管程序，接管主节点的 IP 资源和服务。当主节点恢复时，备节点又会释放主节点故障时自身接管的 IP 资源和服务，恢复到原来的备用角色。</p><h3 id="Keepalived-的体系结构"><a href="#Keepalived-的体系结构" class="headerlink" title="Keepalived 的体系结构"></a>Keepalived 的体系结构</h3><p><img data-src="../../../asset/2021/03/nginx-keepalived-1.png" alt="nginx-keepalived-1"></p><p>简单模块介绍：</p><ul><li>1）SchedulerI/OMultiplexer 是一个 I/O 复用分发调度器，它负载安排 Keepalived 所有内部的任务请求</li><li> 2）Memory Mngt 是一个内存管理机制，这个框架提供了访问内存的一些通用方法</li><li> 3）Control Plane 是 Keepalived 的控制版面，可以实现对配置文件编译和解析</li><li> 4）Core componets 这部分主要包含了 5 个部分<ul><li> a）看门狗 (Watchdog) ：是计算机可靠领域中极为简单又非常有效的检测工具，Keepalived 正是通过它监控 Checkers 和 VRRP 进程的</li><li> b）检查者 (Checkers) : 是 Keepalived 最基础、最主要的功能，可以实现对服务器运行状态检测和故障隔离</li><li> c）VRRP 模块 (VRRP Stack) : 是 Keepalived 引用 VRRP 功能，可以实现 HA 集群中失败切换功能，负责负载均衡器之间的失败切换 FailOver</li><li>d）IPVS 模块 (IPVS wrapper) : 是 IPVS 功能的一个实现，IPVSwarrper 模块将可以设置好的 IPVS 规则发送的内核空间并且提供给 IPVS 模块，最终实现 IPVS 模块的负载功能</li><li> e）VIP 切换 (Netlink Reflector) ：用来实现高可用集群 Failover 时虚拟 IP (VIP) 的设置和切换</li></ul></li></ul><p>由上图可知，两个子进程都被系统 WatchDog 看管，healthchecker 子进程实现检查各自服务器的健康程度，例如 HTTP、LVS 等等，如果 healthchecker 子进程检查到 MASTER 上服务不可用，就会通知本机上的兄弟 VRRP 子进程，让它删除通告，并且去掉虚拟 IP，转换为 BACKUP 状态</p><h2 id="Nginx-Keepalived-搭建高可用集群"><a href="#Nginx-Keepalived-搭建高可用集群" class="headerlink" title="Nginx + Keepalived 搭建高可用集群"></a>Nginx + Keepalived 搭建高可用集群</h2><h3 id="部署架构图"><a href="#部署架构图" class="headerlink" title="部署架构图"></a>部署架构图</h3><p>本文采用的是 Nginx + Keepalived 双机主备架构（主从模式），即使用一个 VIP 地址，Nginx 使用 2 台机器，一台做主节点（Master），一台做备节点（Backup），但同时只有一台机器工作，另一台备用机器在主机器不出现故障的时候，处于空闲状态，仅仅用于灾备。</p><p><img data-src="../../../asset/2021/03/nginx-keepalived-2.png" alt="nginx-keepalived-2"></p><h3 id="服务器规划"><a href="#服务器规划" class="headerlink" title="服务器规划"></a>服务器规划</h3><table><thead><tr><th>角色</th><th> IP</th><th> 软件</th><th>运行环境</th></tr></thead><tbody><tr><td> Master 节点</td><td> 192.168.1.163</td><td>CentOS 7、Nginx、Keepalived</td><td>Vbox 虚拟机</td></tr><tr><td> Backup 节点</td><td> 192.168.1.109</td><td>CentOS 7、Nginx、Keepalived</td><td>VBox 虚拟机</td></tr></tbody></table><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>关闭防火墙</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 临时关闭</span></span><br><span class="line"><span class="keyword"># systemctl</span> stop firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 永久关闭</span></span><br><span class="line"><span class="keyword"># systemctl</span> <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></tbody></table></figure><p>关闭 selinux</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 临时关闭</span></span><br><span class="line"><span class="keyword"># setenforce</span> 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 永久关闭</span></span><br><span class="line"><span class="keyword"># sed</span><span class="params"> -i</span> <span class="string">'s/enforcing/disabled/'</span> /etc/selinux/config</span><br></pre></td></tr></tbody></table></figure><h3 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h3><p>要求在 Master 与 Backup 节点上都安装好 Nginx 和 Keepalived，建议使用编译安装的方式。在生产环境中，Nginx 与 Keepalived 也可以安装在不用的物理机器上。</p><h4 id="Nginx-编译安装"><a href="#Nginx-编译安装" class="headerlink" title="Nginx 编译安装"></a>Nginx 编译安装</h4><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建nginx用户组</span></span><br><span class="line"><span class="keyword"># groupadd</span> nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建nginx用户（不允许远程登录）</span></span><br><span class="line"><span class="keyword"># useradd</span><span class="params"> -g</span> nginx nginx<span class="params"> -s</span> /bin/<span class="literal">false</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line"><span class="keyword"># yum</span> install<span class="params"> -y</span> gcc gdb strace gcc-c++ autoconf libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel libxml2 libxml2-devel zlib zlib-devel glibc glibc-devel glib2 glib2-devel bzip2 bzip2-devel ncurses ncurses-devel curl curl-devel e2fsprogs patch e2fsprogs-devel krb5-devel libidn libidn-devel openldap-devel nss_ldap openldap-clients openldap-servers libevent-devel libevent uuid-devel uuid openssl openssl-devel pcre pcre-devel</span><br></pre></td></tr></tbody></table></figure><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载</span></span><br><span class="line"><span class="keyword"># wget</span> http://nginx.org/download/nginx-1.17.1.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line"><span class="keyword"># tar</span><span class="params"> -xvf</span> nginx-1.17.1.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入解压目录</span></span><br><span class="line"><span class="keyword"># cd</span> nginx-1.17.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置</span></span><br><span class="line">./configure \<span class="params"></span></span><br><span class="line"><span class="params">  --user</span>=nginx \<span class="params"></span></span><br><span class="line"><span class="params">  --group</span>=nginx \<span class="params"></span></span><br><span class="line"><span class="params">  --prefix</span>=/usr/<span class="built_in">local</span>/nginx \<span class="params"></span></span><br><span class="line"><span class="params">  --with</span>-pcre \<span class="params"></span></span><br><span class="line"><span class="params">  --with</span>-http_v2_module \<span class="params"></span></span><br><span class="line"><span class="params">  --with</span>-http_ssl_module \<span class="params"></span></span><br><span class="line"><span class="params">  --with</span>-http_realip_module \<span class="params"></span></span><br><span class="line"><span class="params">  --with</span>-http_gzip_static_module \<span class="params"></span></span><br><span class="line"><span class="params">  --with</span>-http_stub_status_module</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译安装</span></span><br><span class="line"><span class="keyword"># make</span> &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后台启动Nginx</span></span><br><span class="line"><span class="comment"># /usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证访问Nginx</span></span><br><span class="line"><span class="keyword"># curl</span><span class="params"> -X</span> GET 127.0.0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Nginx的运行状态</span></span><br><span class="line"><span class="keyword"># ps</span><span class="params"> -aux</span>|grep nginx</span><br></pre></td></tr></tbody></table></figure><h4 id="Keepalived-编译安装"><a href="#Keepalived-编译安装" class="headerlink" title="Keepalived 编译安装"></a>Keepalived 编译安装</h4><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line"><span class="keyword"># yum</span><span class="params"> -y</span> install curl gcc libnl3-devel net-snmp-devel libnl libnl-devel libnfnetlink-devel openssl openssl-devel</span><br></pre></td></tr></tbody></table></figure><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Keepalived官网下载地址：https://www.keepalived.org/download.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载</span></span><br><span class="line"><span class="keyword"># wget</span> http://keepalived.org/software/keepalived-2.0.18.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line"><span class="keyword"># tar</span><span class="params"> -xvf</span> keepalived-2.0.18.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入解压目录</span></span><br><span class="line"><span class="keyword"># cd</span> keepalived-2.0.18</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/keepalived</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 确保 "./configure" 命令执行完后，输出的以下支持项都为Yes</span></span><br><span class="line">fwmark socket support    : Yes</span><br><span class="line">Use VRRP Framework       : Yes</span><br><span class="line">Use VRRP VMAC            : Yes</span><br><span class="line">Use VRRP authentication  : Yes</span><br><span class="line">With ip rules/routes     : Yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译安装</span></span><br><span class="line"><span class="keyword"># make</span> &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建存放Keepalived配置文件的目录</span></span><br><span class="line"><span class="keyword"># mkdir</span><span class="params"> -p</span> /etc/keepalived</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝Keepalived默认的配置文件</span></span><br><span class="line"><span class="keyword"># cp</span> /usr/<span class="built_in">local</span>/keepalived/etc/keepalived/keepalived.conf /etc/keepalived</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置Keepalived开机自启动</span></span><br><span class="line"><span class="keyword"># systemctl</span> <span class="built_in">enable</span> keepalived.service</span><br></pre></td></tr></tbody></table></figure><h3 id="Keepalived-核心配置"><a href="#Keepalived-核心配置" class="headerlink" title="Keepalived 核心配置"></a>Keepalived 核心配置</h3><p>在 Makster 和 Backup 节点分别创建检查 Nginx 健康状态的脚本 <code>/etc/keepalived/nginx_check.sh</code></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">A=`ps<span class="params"> -C</span> nginx<span class="params"> --no</span>-header | wc<span class="params"> -l</span>`</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$A</span><span class="params"> -eq</span> 0 ];<span class="keyword">then</span></span><br><span class="line">    /usr/<span class="built_in">local</span>/nginx/sbin/nginx<span class="params"> -c</span> /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span><br><span class="line">    sleep 2</span><br><span class="line">    <span class="keyword">if</span> [ `ps<span class="params"> -C</span> nginx<span class="params"> --no</span>-header | wc<span class="params"> -l</span>`<span class="params"> -eq</span> 0 ];<span class="keyword">then</span></span><br><span class="line">        killall keepalived</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 脚本授权执行</span></span><br><span class="line"><span class="keyword"># chmod</span> +x /etc/keepalived/nginx_check.sh</span><br></pre></td></tr></tbody></table></figure><p>Keepalived 是服务器级别的，只监控服务器，Nginx 宕机了，是没有办法接管的。比如，这里是用 Nginx 做负载均衡分发请求的数据包的，如果 Master 节点的 Keepalived 服务正常运行，而 Nginx 运行异常，那么将会出现 Nginx 负载均衡服务失灵，无法切换到 Nginx 备用的负载均衡器上，后端的 Web 服务器无法收到请求。所以，应该要检测 Nginx 的服务是否正常运行，如果不是正常运行，首先尝试启动 Nginx 的服务；若 Nginx 重启失败，就应该关闭掉该节点上的 Keepalived 的服务，这样才能自动切换到 Keepalived 的 Backup 节点上。</p><hr><p>Keepalived 的配置示例如下：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">global_defs {</span><br><span class="line">   notification_email {</span><br><span class="line">     # acassen@firewall.loc                                         # 指定收件人</span><br><span class="line">   }</span><br><span class="line">   # notification_email_from Alexandre.Cassen@firewall.loc          # 指定发件人</span><br><span class="line">   # smtp_server 192.168.200.1                                      # SMTP服务器地址</span><br><span class="line">   # smtp_connect_timeout 30                                        # SMTP服务器连接超时时间</span><br><span class="line"></span><br><span class="line">   router_id LVS_1                                                  # 必填，标识本节点的字符串，在不同的Keepalived服务器里唯一，通常为hostname，但不一定非得是hostname，故障发生时，发邮件通知时会用到</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vrrp_script chk_nginx {</span><br><span class="line">    script "/etc/keepalived/nginx_check.sh"         # 检测服务健康状态的Shell脚本</span><br><span class="line">    interval 2                                      # 每隔多长时间探测一次</span><br><span class="line">    weight -20                                      # 如果条件成立的话，则权重-20</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 {                     # 定义虚拟路由，VI_1为虚拟路由的标示符，可以是自定义名称，允许定义多个虚拟路由</span><br><span class="line">    state MASTER                         # 必填，可以是MASTER或BACKUP，不过当其他节点Keepalived启动时会将Priority比较大的节点选举为MASTER</span><br><span class="line">    interface enp0s3                     # 必填，节点固有IP（非VIP）的网卡，用来发VRRP包做心跳检测</span><br><span class="line">    mcast_src_ip 192.168.1.109           # 本机的IP</span><br><span class="line">    virtual_router_id 51                 # 必填，虚拟路由ID，取值在0-255之间，用来区分多个Instance的VRRP组播，同一网段内ID不能重复，主备机器的该值必须为一样</span><br><span class="line">    priority 100                         # 必填，用来选举Master的，要成为Master那么这个选项的值最好高于其他机器50个点，该项取值范围是1-255(在此范围之外会被识别成默认值100)</span><br><span class="line">    advert_int 1                         # 必填，检查间隔默认为1秒，即1秒进行一次Master选举（可以认为是健康查检时间间隔）</span><br><span class="line">    authentication {                     # 必填，认证区域，认证类型有PASS和HA（IPSEC），推荐使用PASS（密码只识别前8位），主备配置必须一样</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    }</span><br><span class="line">    virtual_ipaddress {</span><br><span class="line">        192.168.1.186/24                  # 必填，虚拟VIP地址，建议后缀加上"/24"，允许有多个</span><br><span class="line">    }</span><br><span class="line">    track_script {                       # 检测服务健康状态的Shell脚本</span><br><span class="line">        chk_nginx</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>在 Makster 节点创建 Keepalived 的主配置文件 <code>/etc/keepalived/keepalived.conf</code>，配置文件的内容如下：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">global_defs {</span><br><span class="line">   notification_email {</span><br><span class="line">     # acassen@firewall.loc</span><br><span class="line">   }</span><br><span class="line">   # notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   # smtp_server 192.168.200.1</span><br><span class="line">   # smtp_connect_timeout 30</span><br><span class="line"></span><br><span class="line">   router_id LVS_1</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vrrp_script chk_nginx {</span><br><span class="line">    script "/etc/keepalived/nginx_check.sh"</span><br><span class="line">    interval 2</span><br><span class="line">    weight -20</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 {</span><br><span class="line">    state MASTER</span><br><span class="line">    interface enp0s3</span><br><span class="line">    mcast_src_ip 192.168.1.163</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication {</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    }</span><br><span class="line">    virtual_ipaddress {</span><br><span class="line">        192.168.1.186/24</span><br><span class="line">    }</span><br><span class="line">    track_script {</span><br><span class="line">        chk_nginx</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>在 Backup 节点创建 Keepalived 的主配置文件 <code>/etc/keepalived/keepalived.conf</code>，配置文件的内容如下，与 Master 节点的最大参数区别是：<code>router_id LVS_2</code>、<code>state BACKUP</code>、<code>mcast_src_ip 192.168.1.109</code></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">global_defs {</span><br><span class="line">   notification_email {</span><br><span class="line">     # acassen@firewall.loc</span><br><span class="line">   }</span><br><span class="line">   # notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   # smtp_server 192.168.200.1</span><br><span class="line">   # smtp_connect_timeout 30</span><br><span class="line"></span><br><span class="line">   router_id LVS_2</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vrrp_script chk_nginx {</span><br><span class="line">    script "/etc/keepalived/nginx_check.sh"</span><br><span class="line">    interval 2</span><br><span class="line">    weight -20</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 {</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface enp0s3</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    mcast_src_ip 192.168.1.109</span><br><span class="line">    priority 90</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication {</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    }</span><br><span class="line">    virtual_ipaddress {</span><br><span class="line">        192.168.1.186/24</span><br><span class="line">    }</span><br><span class="line">    track_script{</span><br><span class="line">        chk_nginx</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>分别在 Master 节点和 Backup 节点启动 Keepalived 的服务</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动Keepalived</span></span><br><span class="line"><span class="keyword"># service</span> keepalived start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看运行状态</span></span><br><span class="line"><span class="keyword"># service</span> keepalived status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看启动的日志信息</span></span><br><span class="line"><span class="keyword"># more</span> /var/<span class="built_in">log</span>/messages</span><br><span class="line"><span class="keyword"># journalctl</span><span class="params"> -u</span> keepalived</span><br></pre></td></tr></tbody></table></figure><h3 id="测试虚拟-IP"><a href="#测试虚拟-IP" class="headerlink" title="测试虚拟 IP"></a>测试虚拟 IP</h3><h4 id="Master-节点查看虚拟-IP"><a href="#Master-节点查看虚拟-IP" class="headerlink" title="Master 节点查看虚拟 IP"></a>Master 节点查看虚拟 IP</h4><p>在 Master 节点执行以下命令，查看节点的 IP 状态</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword"># ip</span> addr</span><br></pre></td></tr></tbody></table></figure><p>在 Master 节点可以看到已经生成了虚拟 IP <code>192.168.1.186</code></p><p><img data-src="../../../asset/2021/03/nginx-keepalived-3.png" alt="nginx-keepalived-3"></p><h4 id="Backup-节点查看虚拟-IP"><a href="#Backup-节点查看虚拟-IP" class="headerlink" title="Backup 节点查看虚拟 IP"></a>Backup 节点查看虚拟 IP</h4><p>在 Backup 节点执行以下命令，查看节点的 IP 状态</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword"># ip</span> addr</span><br></pre></td></tr></tbody></table></figure><p>在 Backup 节点默认不会看到生成的虚拟 IP，如果生成那就是 Keepalived 的配置文件出现了错误，即备节点和主节点争用 IP 资源，这个现象叫做 <code>脑裂</code></p><p><img data-src="../../../asset/2021/03/nginx-keepalived-4.png" alt="nginx-keepalived-4"></p><h4 id="使用虚拟-IP-访问-Nginx"><a href="#使用虚拟-IP-访问-Nginx" class="headerlink" title="使用虚拟 IP 访问 Nginx"></a>使用虚拟 IP 访问 Nginx</h4><p>分别在 Master 节点和 Backup 节点上，验证是否可通过虚拟 IP 访问本地的 Nginx 服务</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 确保可以Ping得通虚拟IP</span></span><br><span class="line"><span class="keyword"># ping</span> 192.168.1.186</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问Nginx</span></span><br><span class="line"><span class="keyword"># curl</span><span class="params"> -X</span> GET 192.168.1.186</span><br></pre></td></tr></tbody></table></figure><p>值得一提的是，建议额外在宿主机上测试是否可以访问 VIP</p><h4 id="主备服务器高可用切换"><a href="#主备服务器高可用切换" class="headerlink" title="主备服务器高可用切换"></a>主备服务器高可用切换</h4><p>关闭 Master 节点的 Keepalived 服务</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword"># service</span> keepalived stop</span><br></pre></td></tr></tbody></table></figure><p>查看 Backup 节点是否会生成虚拟 IP <code>192.168.1.186</code></p><p><img data-src="../../../asset/2021/03/nginx-keepalived-5.png" alt="nginx-keepalived-5"></p><p>重新启动 Master 的 Keepalived 服务，然后查看 Master 和 Backup 的虚拟 IP，此时主节点应该会将虚拟 IP 抢夺回来</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword"># service</span> keepalived restar</span><br></pre></td></tr></tbody></table></figure><p><img data-src="../../../asset/2021/03/nginx-keepalived-6.png" alt="nginx-keepalived-6"></p><p><img data-src="../../../asset/2021/03/nginx-keepalived-7.png" alt="nginx-keepalived-7"></p><h2 id="Keepalived-脑裂（主备节点均有-VIP）"><a href="#Keepalived-脑裂（主备节点均有-VIP）" class="headerlink" title="Keepalived 脑裂（主备节点均有 VIP）"></a>Keepalived 脑裂（主备节点均有 VIP）</h2><p>脑裂（split-brain）指在一个高可用（HA）系统中，当联系着的两个节点断开联系时，本来为一个整体的系统，分裂为两个独立节点，这时两个节点开始争抢共享资源，结果会导致系统混乱，数据损坏。对于无状态服务的 HA，无所谓脑裂不脑裂；但对有状态服务（比如 MySQL）的 HA，必须要严格防止脑裂。</p><h3 id="脑裂原因"><a href="#脑裂原因" class="headerlink" title="脑裂原因"></a>脑裂原因</h3><p>一般来说脑裂问题有以下这几种原因：</p><ul><li>高可用服务器上开启了 iptables 防火墙，阻止了心跳传消息输</li><li>高可用服务器上心跳网卡地址等信息配置不正确，导致发送心跳失败</li><li>其他服务配置不当的原因，如心跳方式不同，心跳广播冲突，软件 Bug 等</li><li>高可用服务器对之间心跳线链路发生故障，导致无法正常通信，例如：心跳线坏了（包括断了或者老化）、网卡及相关驱动损坏、IP 配置及冲突问题（网卡直连）、心跳线之间的设备故障（网卡及交换机）、仲裁的机器出现问题（采用仲裁的方案）</li></ul><p>提示：Keepalived 配置里的同一个 VRRP 实例，如果 <code>virtual_router_id</code> 参数在主备节点上的配置不一致，也会导致出现脑裂现象</p><h3 id="脑裂方案"><a href="#脑裂方案" class="headerlink" title="脑裂方案"></a>脑裂方案</h3><p>在实际生产环境中，可以从以下方面防止脑裂：</p><ul><li>同时使用串行电缆和以太网电缆连接、同时使用两条心跳线路，这样一条线路断了，另外一条还是好的，依然能传送心跳消息</li><li>当检查脑裂时强行关闭一个心跳节点（这个功能需要特殊设备支持，如 stonith、fence）相当于备节点接收不到心跳消息，通过单独的线路发送关机命令关闭主节点的电源</li><li>做好对脑裂的监控报警</li></ul><p>解决常见方案：</p><ul><li>如果开启防火墙，一定要让心跳消息通过，一般通过允许 IP 段的形式解决</li><li>可以拉一条以太网网线或者串口线作为主被节点心跳线路的冗余</li><li>开发检测程序通过监控软件检测脑裂</li></ul><h3 id="脑裂报警脚本"><a href="#脑裂报警脚本" class="headerlink" title="脑裂报警脚本"></a>脑裂报警脚本</h3><p>监控报警思路，正常情况下 Keepalived 的 VIP 是挂载在 Master 节点上的，如果在 Backup 节点发现了 VIP，同时还可以 Ping 得通 Master 节点，就触发脑裂报警。这种监控思路是假设在 Keepalived 服务自身不会宕机的基础上的，若 Master 节点上的 Keepalived 服务宕机了，VIP 会正常挂载到 Backup 节点上，同时还是可以 Ping 得通 Master 节点，这种极端情况下就会错误触发脑裂警报。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查脑裂的脚本，在Backup节点上进行部署</span></span><br><span class="line">VIP=192.168.1.186</span><br><span class="line">MASTER_IP=192.168.1.163</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    ping<span class="params"> -c</span> 2<span class="params"> -W</span> 3 <span class="variable">$MASTER_IP</span> &amp;&gt;/dev/null</span><br><span class="line">    <span class="keyword">if</span> [ $?<span class="params"> -eq</span> 0<span class="params"> -a</span> `ip add|grep <span class="string">"<span class="variable">$VIP</span>"</span>|wc<span class="params"> -l</span>`<span class="params"> -eq</span> 1 ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"ha is brain."</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"ha is ok"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    sleep 5</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></tbody></table></figure><h2 id="Nginx-Keepalived-高可用部署架构方案"><a href="#Nginx-Keepalived-高可用部署架构方案" class="headerlink" title="Nginx + Keepalived 高可用部署架构方案"></a>Nginx + Keepalived 高可用部署架构方案</h2><p><img data-src="../../../asset/2021/03/nginx-keepalived-model.png" alt="nginx-keepalived-model"></p><ul><li><code>双机主备方案</code>：就是上文介绍过的，使用一个 VIP 地址，前端使用 2 台机器，一台做主节点（Master），一台做备节点（Backup），但同时只有一台机器工作，另一台备用机器在主机器不出现故障的时候，永远处于浪费状态，仅仅用于灾备，平时都是空闲着的。</li></ul><p><img data-src="../../../asset/2021/03/nginx-keepalived-model-2.png" alt="nginx-keepalived-model-2"></p><ul><li><code>双主热备方案</code>：弥补了双机主备的缺点，使用 2 个 VIP 地址，前端使用 2 台机器，彼此互为主备，同时有两台机器工作。用户访问之后，DNS 轮询选择访问哪个 VIP，当其中一台机器出现故障，两台机器的请求会转移到同一台机器负载。</li></ul><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><h3 id="Master-节点无法访问虚拟-IP"><a href="#Master-节点无法访问虚拟-IP" class="headerlink" title="Master 节点无法访问虚拟 IP"></a>Master 节点无法访问虚拟 IP</h3><p>Master 节点里的 Keepalived 服务配置好 VIP 后，通过 <code>ip addr</code> 可以看到 VIP 已经顺利挂载，但是在 Master 节点内部无法 Ping 通。原因是 <code>keepalived.conf</code> 文件中默认配置了 <code>vrrp_strict</code>，需要把它注释掉，重启 Keepalived 的服务后即可以 Ping 得通。<code>vrrp_strict</code> 参数表示严格遵守 VRRP 协议，下列情况将会阻止 Keepalived 的虚拟 IP 功能：</p><ul><li>1）单播邻居</li><li> 2）没有 VIP 地址</li><li> 3）在 VRRP 版本 2 中有 IPv6 地址</li></ul><h3 id="Backup-节点无法访问虚拟-IP"><a href="#Backup-节点无法访问虚拟-IP" class="headerlink" title="Backup 节点无法访问虚拟 IP"></a>Backup 节点无法访问虚拟 IP</h3><p>虚拟 IP 的网段要和 Real Server 真实 IP 的网段地址一致，比如 Master 节点与 Backup 节点的 IP 网段为 <code>192.168.171</code>，那么虚拟 IP 必须是 <code>192.168.171.*</code>，否则 Backup 节点无法访问虚拟 IP。</p><h3 id="Nginx-服务使用非默认的-80-端口"><a href="#Nginx-服务使用非默认的-80-端口" class="headerlink" title="Nginx 服务使用非默认的 80 端口"></a>Nginx 服务使用非默认的 80 端口</h3><p>若 Nginx 服务使用非默认的 80 端口，那么在 Keepalived 的配置文件 <code>keepalived.conf</code> 里，只需要正常配置 <code>virtual_ipaddress</code> 参数即可，不需要关心 Nginx 具体使用的是哪个端口，因为默认可以通过 <code>http://vip:port</code> 的地址格式访问 Nginx。</p><h3 id="Master-节点与-Backup-节点同时生成了虚拟-IP"><a href="#Master-节点与-Backup-节点同时生成了虚拟-IP" class="headerlink" title="Master 节点与 Backup 节点同时生成了虚拟 IP"></a>Master 节点与 Backup 节点同时生成了虚拟 IP</h3><p>关闭系统防火墙，让 Master 节点和 Backup 节点可以互相通信，否则会导致主备节点都生成了两个 VIP（脑裂现象）。也可以配置主备节点之间的防火墙协议（如下），开启其他需要通信的 IP 即可：</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启VRRP协议</span></span><br><span class="line"><span class="keyword"># firewall</span>-cmd<span class="params"> --direct</span><span class="params"> --permanent</span><span class="params"> --add</span>-rule ipv4 filter INPUT 0<span class="params">  --protocol</span> vrrp<span class="params"> -j</span> ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line"><span class="keyword"># firewall</span>-cmd<span class="params"> --direct</span><span class="params"> --permanent</span><span class="params"> --add</span>-rule ipv4 filter INPUT 0<span class="params"> --in</span>-interface em1<span class="params"> --destination</span> 192.168.1.163<span class="params"> --protocol</span> vrrp<span class="params"> -j</span> ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重载配置生效</span></span><br><span class="line"><span class="keyword"># firewall</span>-cmd<span class="params"> --reload</span></span><br></pre></td></tr></tbody></table></figure><h3 id="商业云服务器对-Keepalived-的支持"><a href="#商业云服务器对-Keepalived-的支持" class="headerlink" title="商业云服务器对 Keepalived 的支持"></a>商业云服务器对 Keepalived 的支持</h3><p>以阿里云服务器举例，可以使用 HAVIP + VPC（Virtual Private Cloud，虚拟私有云） 来实现 Keepalived，但是普通的 ECS 是不适用的，要求必须使用 VPC 类型的 ECS，而且虚拟 IP 需要另外申请（不支持自建 VIP）。阿里云目前不支持自建 LVS 高可用负载均衡，但有现成的商业产品–负载均衡 SLB 可以选择。值得一提的是，云服务器 ECS 不支持组播和广播，这点需要注意一下。</p><h2 id="参考博客"><a href="#参考博客" class="headerlink" title="参考博客"></a>参考博客</h2><ul><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/mofiu/article/details/76644012">Keepalived 配置文件参数详解</a></li><li><a target="_blank" rel="external nofollow" href="https://my.oschina.net/u/4376386/blog/3606008">Keepalived 虚拟 VIP 无法访问的问题</a></li><li><a target="_blank" rel="external nofollow" href="https://www.freesion.com/article/2518421015/">Centos 8 开启防火墙后，脑裂的问题解决</a></li><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/xinfuxuan4/article/details/99471428">基于华为云搭建 Keepalived + Nginx 实验</a></li><li><a target="_blank" rel="external nofollow" href="https://zhuanlan.zhihu.com/p/108577218">Nginx 高可用集群解决方案 Nginx + Keepalived</a></li><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/xiaoxin0630/article/details/104180574">Keepalived + Nginx 实现搭建双机主备 + 双主热备</a></li></ul></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script>var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if(!isMobile)try{var plugin=new ReadmorePlugin;plugin.init({id:"readmore-container",blogId:"96641-5333172926158-056",name:"全栈技术驿站",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",lockToc:"yes",type:"hexo",random:"0.9",interval:"30",expires:"365",height:"auto"})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>坚持原创技术分享，您的支持将鼓励我继续创作！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/503c34e4.html" title="Nginx + Keepalived 实现双机主备高可用">https://www.techgrow.cn/posts/503c34e4.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎加入微信群</span><br> <img src="/img/wx-group-qr-technology.png"></div></div></div><div class="post-tags"><a href="/tags/Linux/" rel="tag"><i class="fa fa-tag"></i> Linux</a><a href="/tags/Web%E6%9C%8D%E5%8A%A1%E5%99%A8/" rel="tag"><i class="fa fa-tag"></i> Web服务器</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/ee7f1a35.html" rel="prev" title="OpenWrt 设置 IP 地址"><i class="fa fa-chevron-left"></i> OpenWrt 设置 IP 地址</a></div><div class="post-nav-item"> <a href="/posts/fea85f3.html" rel="next" title="Redis 入门教程之一五大数据类型">Redis 入门教程之一五大数据类型<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright &copy; 2018 – <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">798k</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 &asymp;</span> <span title="站点阅读时长">12:05</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="beian"> <span><img src="/img/gonganbeian.png" alt></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备19024664号</a></span></div></div></footer><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-tu9j5pBilBQrWSDePOOajCUdz6hWsid/lBNzK4KgEPM="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"/lib/mermaid/dist/mermaid.min.js","integrity":"sha256-ZfzwelSToHk5YAcr9wbXAmWgyn9Jyq08fSLrLhZE89w="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://unpkg.com/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://unpkg.com/qiniu-js@3.3.1/dist/qiniu.min.js"></script><script>
    var qiniu_domain = "https://qiniu.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/app/api/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn:9360","cssUrl":"https://unpkg.com/@waline/client@2.5.1/dist/waline.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://unpkg.com/@waline/client@2.5.1/dist/waline.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://unpkg.com/@waline/emojis@1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://qiniu.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/app/api/qiniu/token/upload","el":"#waline","comment":true,"path":"/posts/503c34e4.html"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@2.5.1/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>