<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍 Sentinel 的进阶使用教程。"><meta property="og:type" content="article"><meta property="og:title" content="Sentinel 进阶教程 - 中级篇（2024 年）"><meta property="og:url" content="https://www.techgrow.cn/posts/4fd0a683.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍 Sentinel 的进阶使用教程。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-annotation-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-annotation-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-annotation-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-hot-rule.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-hot-rule-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-hot-rule-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-rule-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-autority-rule.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-autority-rule-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-store-nacos-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-store-nacos-5.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-store-nacos-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-store-nacos-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-store-nacos-4.png"><meta property="article:published_time" content="2024-02-06T14:33:05.000Z"><meta property="article:modified_time" content="2024-10-29T14:33:05.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="微服务"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-annotation-1.png"><link rel="canonical" href="https://www.techgrow.cn/posts/4fd0a683.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/4fd0a683.html","path":"posts/4fd0a683.html","title":"Sentinel 进阶教程 - 中级篇（2024 年）"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Sentinel 进阶教程 - 中级篇（2024 年） | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%98%E6%96%B9%E8%B5%84%E6%BA%90"><span class="nav-text">官方资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="nav-text">版本说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E4%B8%8B%E8%BD%BD"><span class="nav-text">代码下载</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sentinel-%E6%B3%A8%E8%A7%A3%E6%94%AF%E6%8C%81"><span class="nav-text">Sentinel 注解支持</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SentiinelResource-%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="nav-text">@SentiinelResource 的概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SentiinelResource-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">@SentiinelResource 的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4%E4%B8%8D%E4%BD%BF%E7%94%A8%E6%B3%A8%E8%A7%A3%E7%9A%84%E8%A1%8C%E4%B8%BA%E8%A1%A8%E7%8E%B0"><span class="nav-text">默认不使用注解的行为表现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%B3%A8%E8%A7%A3%E8%87%AA%E5%AE%9A%E4%B9%89%E9%99%90%E6%B5%81%E7%9A%84%E6%8F%90%E7%A4%BA"><span class="nav-text">使用注解自定义限流的提示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%B3%A8%E8%A7%A3%E8%87%AA%E5%AE%9A%E4%B9%89%E9%99%8D%E7%BA%A7%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91"><span class="nav-text">使用注解自定义降级处理逻辑</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sentinel-%E7%83%AD%E7%82%B9%E8%A7%84%E5%88%99"><span class="nav-text">Sentinel 热点规则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%83%AD%E7%82%B9%E8%A7%84%E5%88%99"><span class="nav-text">热点规则</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%83%AD%E7%82%B9%E8%A7%84%E5%88%99%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="nav-text">热点规则的概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%83%AD%E7%82%B9%E8%A7%84%E5%88%99%E7%9A%84%E6%B7%BB%E5%8A%A0"><span class="nav-text">热点规则的添加</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%83%AD%E7%82%B9%E8%A7%84%E5%88%99%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">热点规则的使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E4%BE%8B%E5%A4%96%E9%A1%B9%E9%85%8D%E7%BD%AE"><span class="nav-text">参数例外项配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E4%BE%8B%E5%A4%96%E9%A1%B9%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="nav-text">参数例外项的概述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E4%BE%8B%E5%A4%96%E9%A1%B9%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">参数例外项的使用</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sentinel-%E6%8E%88%E6%9D%83%E8%A7%84%E5%88%99"><span class="nav-text">Sentinel 授权规则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%88%E6%9D%83%E8%A7%84%E5%88%99%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="nav-text">授权规则的概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%88%E6%9D%83%E8%A7%84%E5%88%99%E7%9A%84%E6%B7%BB%E5%8A%A0"><span class="nav-text">授权规则的添加</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%88%E6%9D%83%E8%A7%84%E5%88%99%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">授权规则的使用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sentinel-%E9%85%8D%E7%BD%AE%E8%A7%84%E5%88%99%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-text">Sentinel 配置规则持久化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E6%96%B9%E6%A1%88%E4%B8%80"><span class="nav-text">持久化方案一</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%A1%88%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D"><span class="nav-text">方案使用介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96%E5%9D%90%E6%A0%87"><span class="nav-text">引入依赖坐标</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="nav-text">添加测试代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0-YML-%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF"><span class="nav-text">添加 YML 配置信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Nacos-%E6%B7%BB%E5%8A%A0%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99"><span class="nav-text">Nacos 添加流控规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%E4%BB%A3%E7%A0%81%E6%B5%8B%E8%AF%95"><span class="nav-text">案例代码测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E6%96%B9%E6%A1%88%E4%BA%8C"><span class="nav-text">持久化方案二</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%A1%88%E4%BB%8B%E7%BB%8D"><span class="nav-text">方案介绍</span></a></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">759</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">54</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/4fd0a683.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Sentinel 进阶教程 - 中级篇（2024 年） | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍 Sentinel 的进阶使用教程。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Sentinel 进阶教程 - 中级篇（2024 年）</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-02-06 22:33:05" itemprop="dateCreated datePublished" datetime="2024-02-06T22:33:05+08:00">2024-02-06</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2024-10-29 22:33:05" itemprop="dateModified" datetime="2024-10-29T22:33:05+08:00">2024-10-29</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/4fd0a683.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/4fd0a683.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>6.9k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>6 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/8facd1ee.html">Sentinel 入门教程 - 基础篇（2020 年）</a></li><li><a href="/posts/e3c83db6.html">Sentinel 入门教程 - 中级篇（2020 年）</a></li><li><a href="/posts/63e3926c.html">Sentinel 入门教程 - 整合篇（2020 年）</a></li><li><a href="/posts/23b44adb.html">Sentinel 进阶教程 - 基础篇（2024 年）</a></li><li><a href="/posts/4fd0a683.html">Sentinel 进阶教程 - 中级篇（2024 年）</a></li><li><a href="/posts/cffb0959.html">Sentinel 进阶教程 - 整合篇（2024 年）</a></li></ul><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="官方资源"><a href="#官方资源" class="headerlink" title="官方资源"></a>官方资源</h3><ul><li><a target="_blank" rel="external nofollow" href="https://github.com/alibaba/Sentinel/wiki">Sentinel 官方文档</a></li><li><a target="_blank" rel="external nofollow" href="https://github.com/alibaba/Sentinel/tree/master/sentinel-demo">Sentinel 官方示例代码</a></li></ul><h3 id="版本说明"><a href="#版本说明" class="headerlink" title="版本说明"></a>版本说明</h3><p>在本文的所有案例中，各个组件统一使用以下版本：</p><table><thead><tr><th>组件</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td> Spring Boot</td><td>3.2.0</td><td></td></tr><tr><td>Spring Cloud</td><td>2023.0.0</td><td></td></tr><tr><td>Spring Cloud Alibaba</td><td>2022.0.0.0</td><td></td></tr><tr><td>Sentinel Dashboard</td><td>1.8.7</td><td></td></tr></tbody></table><span id="more"></span><h3 id="代码下载"><a href="#代码下载" class="headerlink" title="代码下载"></a>代码下载</h3><ul><li>本文完整的案例代码可以从 <a href="/downloads/2024/02/sentinel-features-demo.zip">这里</a> 下载得到。</li></ul><h2 id="Sentinel-注解支持"><a href="#Sentinel-注解支持" class="headerlink" title="Sentinel 注解支持"></a>Sentinel 注解支持</h2><div class="admonition note"><p class="admonition-title">官方文档</p><ul><li><a target="_blank" rel="external nofollow" href="https://github.com/alibaba/Sentinel/wiki/%E6%B3%A8%E8%A7%A3%E6%94%AF%E6%8C%81">Sentinel 注解支持</a></li></ul></div><h3 id="SentiinelResource-的概述"><a href="#SentiinelResource-的概述" class="headerlink" title="@SentiinelResource 的概述"></a>@SentiinelResource 的概述</h3><p><code>@SentiinelResource</code> 是 Sentinel 官方提供的一个流量防卫防护组件注解，用于指定防护资源，对配置的资源进行流量控制、熔断降级等功能。<code>@SentiinelResource</code> 注解的底层源码和注释如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target({ElementType.METHOD, ElementType.TYPE})</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SentinelResource {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 资源名称</span></span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Entry 类型，标记流量的方向，取值 IN/OUT，默认是 OUT</span></span><br><span class="line">    <span class="function">EntryType <span class="title">entryType</span><span class="params">()</span> <span class="keyword">default</span> EntryType.OUT</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 资源分类</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">resourceType</span><span class="params">()</span> <span class="keyword">default</span> 0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理 BlockException 的函数名称，函数要求：</span></span><br><span class="line">    <span class="comment">// 1. 必须是 public 修饰</span></span><br><span class="line">    <span class="comment">// 2. 返回类型、函数参数与原函数一致</span></span><br><span class="line">    <span class="comment">// 3. 函数参数列表中可以多一个 BlockException 类型的参数</span></span><br><span class="line">    <span class="comment">// 4. 默认需要和原函数处于同一个类中。若希望使用其他类的函数，可配置 blockHandlerClass，并指定 blockHandlerClass 里面的方法</span></span><br><span class="line">    <span class="function">String <span class="title">blockHandler</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存放 blockHandler 的类，对应的处理函数必须使用 static 修饰</span></span><br><span class="line">    Class&lt;?&gt;[] blockHandlerClass() <span class="keyword">default</span> {};</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于在抛出异常的时候提供 fallback 处理逻辑。fallback 函数可以针对所有类型的异常（除了 exceptionsToIgnore 里面排除掉的异常类型）进行处理。函数要求：</span></span><br><span class="line">    <span class="comment">// 1. 返回类型与原函数一致</span></span><br><span class="line">    <span class="comment">// 2. 参数类型需要和原函数相匹配</span></span><br><span class="line">    <span class="comment">// 3. 默认需要和原函数处于同一个类中。若希望使用其他类的函数，可配置 fallbackClass ，并指定 fallbackClass 里面的方法</span></span><br><span class="line">    <span class="function">String <span class="title">fallback</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认存放 fallback 的类。对应的处理函数必须使用 static 修饰</span></span><br><span class="line">    <span class="function">String <span class="title">defaultFallback</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于通用的 fallback 逻辑。默认 fallback 函数可以针对所有类型的异常进行处理。若同时配置了 fallback 和 defaultFallback，以 fallback 为准。函数要求：</span></span><br><span class="line">    <span class="comment">// 1. 返回类型与原函数一致</span></span><br><span class="line">    <span class="comment">// 2. 函数参数列表为空，或者有一个 Throwable 类型的参数</span></span><br><span class="line">    Class&lt;?&gt;[] fallbackClass() <span class="keyword">default</span> {};</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 需要 Trace 的异常</span></span><br><span class="line">    Class&lt;? extends Throwable&gt;[] exceptionsToTrace() <span class="keyword">default</span> {Throwable.class};</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指定排除忽略掉哪些异常。排除的异常不会计入异常统计，也不会进入 fallback 逻辑，而是原样抛出异常</span></span><br><span class="line">    Class&lt;? extends Throwable&gt;[] exceptionsToIgnore() <span class="keyword">default</span> {};</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="SentiinelResource-的使用"><a href="#SentiinelResource-的使用" class="headerlink" title="@SentiinelResource 的使用"></a>@SentiinelResource 的使用</h3><h4 id="默认不使用注解的行为表现"><a href="#默认不使用注解的行为表现" class="headerlink" title="默认不使用注解的行为表现"></a>默认不使用注解的行为表现</h4><div class="admonition note"><p class="admonition-title">案例目标</p><p>Sentinel 使用接口的 URL 地址作为资源名进行限流 + 返回默认的限流提示。</p></div><ul><li>Java 接口代码</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RateLimitController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/rateLimit/byUrl")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">byUrl</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"按照 URL 地址进行限流测试"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Sentinel 控制台添加流控规则</li></ul><p><img data-src="../../../asset/2024/10/sentinel-annotation-1.png"></p><ul><li>通过浏览器快速多次访问 <code>/rateLimit/byUrl</code> 接口时，会返回默认提示信息 <code>Blocked by Sentinel (flow limiting)</code>，说明接口被限流了。</li></ul><div class="admonition note"><p class="admonition-title">提示</p><p>在 Sentinel 控制台添加流控规则时，资源名默认就可以是请求的接口路径（URL），可以自行修改。同一微服务应用内，资源名必须唯一。不同微服务应用之间，资源名可以重复。</p></div><h4 id="使用注解自定义限流的提示"><a href="#使用注解自定义限流的提示" class="headerlink" title="使用注解自定义限流的提示"></a>使用注解自定义限流的提示</h4><div class="admonition note"><p class="admonition-title">案例目标</p><p>Sentinel 按照资源名称进行限流 + 返回自定义的限流提示。</p></div><p>若不希望 Sentinel 使用默认的限流提示 <code>Blocked by Sentinel (flow limiting)</code>，而是想返回自定义限流的提示，可以使用 <code>@SentiinelResource</code> 注解 的 <code>blockHandler</code> 属性来实现。</p><ul><li>Java 接口代码</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RateLimitController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@SentinelResource</span> 注解的 blockHandler 属性用于指定处理 BlockException 异常的函数名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping("/rateLimit/byResource")</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = "bySentinelResource", blockHandler = "handlerException")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">byResource</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"按照资源名称进行限流测试"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">handlerException</span><span class="params">(BlockException exception)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"目前访问人数较多，请稍后再试!"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Sentinel 控制台添加流控规则</li></ul><p><img data-src="../../../asset/2024/10/sentinel-annotation-2.png"></p><ul><li>通过浏览器快速多次访问 <code>/rateLimit/byResource</code> 接口时，会返回自定义提示信息 <code>目前访问人数较多，请稍后再试!</code>，说明接口被限流了。</li></ul><h4 id="使用注解自定义降级处理逻辑"><a href="#使用注解自定义降级处理逻辑" class="headerlink" title="使用注解自定义降级处理逻辑"></a>使用注解自定义降级处理逻辑</h4><div class="admonition note"><p class="admonition-title">案例目标</p><p>Sentinel 按照资源名称进行限流 + 返回自定义的限流提示 + 服务降级处理（Fallback）。</p></div><p>使用 Sentinel 的时候，若希望在接口调用抛出业务异常（不包括 BlockException 异常）时，执行指定的降级处理逻辑，可以使用 <code>@SentiinelResource</code> 注解 的 <code>fallback</code> 属性来实现。<strong>特别注意，这里的降级处理只是在接口调用抛出业务异常时，简单执行指定的降级处理逻辑（比如返回兜底数据），并没有实现熔断的功能。若需要使用熔断功能，可以使用 Sentinel 提供的 <a href="/posts/23b44adb.html#%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7%E4%BD%BF%E7%94%A8">熔断规则</a>。</strong></p><ul><li>Java 接口代码</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RateLimitController</span> </span>{</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@SentinelResource</span> 注解的 blockHandler 属性用于指定处理 BlockException 异常的函数名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@SentinelResource</span> 注解的 fallback 属性用于在接口抛出业务异常（不包括 BlockException）的时候提供 fallback 处理逻辑</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping("/rateLimit/doAction/{p1}")</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = "doActionSentinelResource", blockHandler = "doActionBlockHandler", fallback = "doActionFallback")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doAction</span><span class="params">(<span class="meta">@PathVariable("p1")</span> Integer p1)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (p1 == <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"非法参数异常"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doActionBlockHandler</span><span class="params">(<span class="meta">@PathVariable("p1")</span> Integer p1, BlockException e)</span> </span>{</span><br><span class="line">        log.error(<span class="string">"接口触发了限流: {}"</span>, e);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"目前访问人数较多，请稍后再试!"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doActionFallback</span><span class="params">(<span class="meta">@PathVariable("p1")</span> Integer p1, Throwable e)</span> </span>{</span><br><span class="line">        log.error(<span class="string">"程序抛出了异常: {}"</span>, e);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"服务出错啦，请稍后再试!"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Sentinel 控制台添加流控规则</li></ul><p><img data-src="../../../asset/2024/10/sentinel-annotation-3.png"></p><ul><li>通过浏览器快速多次访问 <code>/rateLimit/doAction/1</code> 接口时，会返回自定义提示信息 <code>目前访问人数较多，请稍后再试!</code>，说明接口频繁调用时，成功被限流了。</li><li>通过浏览器单次访问 <code>/rateLimit/doAction/0</code> 接口时，会返回自定义的降级处理结果 <code>服务出错啦，请稍后再试！</code>，说明调用接口抛出业务异常（不包括 BlockException）时，成功被降级处理了。</li></ul><div class="admonition note"><p class="admonition-title">使用总结</p><ul><li><code>@SentinelResource</code> 注解的 <code>blockHandler</code> 属性，主要针对 Sentinel 配置了规则后出现的违规情况（比如触发了流控规则、熔断规则、热点规则等）进行处理。</li><li><code>@SentinelResource</code> 注解的 <code>fallback</code> 属性，主要针对程序在运行时抛出了业务异常（不包括 BlockException 异常），需要进行降级处理的情况。</li><li><code>@SentinelResource</code> 注解的 <code>blockHandler</code> 和 <code>fallback</code> 属性可以共存，也就是可以互相配合使用。</li></ul></div><h2 id="Sentinel-热点规则"><a href="#Sentinel-热点规则" class="headerlink" title="Sentinel 热点规则"></a>Sentinel 热点规则</h2><div class="admonition note"><p class="admonition-title">官方文档</p><ul><li><a target="_blank" rel="external nofollow" href="https://github.com/alibaba/Sentinel/wiki/%E7%83%AD%E7%82%B9%E5%8F%82%E6%95%B0%E9%99%90%E6%B5%81">Sentinel 热点参数限流</a></li></ul></div><h3 id="热点规则"><a href="#热点规则" class="headerlink" title="热点规则"></a>热点规则</h3><h4 id="热点规则的概述"><a href="#热点规则的概述" class="headerlink" title="热点规则的概述"></a>热点规则的概述</h4><p>何为热点？热点即经常访问的数据。在很多时候，我们希望统计某些热点数据中访问频次最高的 Top K 数据，并对其访问进行限制。比如：</p><ul><li>使用商品 ID 作为参数，统计一段时间内最常购买的商品 ID，并进行限制。</li><li>使用用户 ID 作为参数，针对一段时间内频繁访问的用户 ID，进行限制。</li></ul><p>热点参数限流会统计传入参数中的热点参数，并根据配置的限流阈值与模式，对包含热点参数的资源调用进行限流。热点参数限流可以看做是一种特殊的流量控制方式，仅对包含热点参数的资源调用生效。</p><p><img data-src="../../../asset/2024/10/sentinel-hot-rule.png"></p><p>Sentinel 利用 LRU（最长时间未使用）策略统计最近最常访问的热点参数，结合令牌桶算法来进行参数级别的流控。值得一提的是，热点参数限流支持集群模式。</p><div class="admonition note"><p class="admonition-title">LRU 算法与 LFU 算法</p><ul><li><code>LRU (Least Recently Used)</code>：根据最近使用的顺序来淘汰数据，即<strong>淘汰最长时间未被访问的数据</strong>。</li><li><code>LFU (Least Frequently Used)</code>：根据数据被访问的频率来淘汰数据，即<strong>淘汰访问频率最低的数据</strong>。</li></ul></div><h4 id="热点规则的添加"><a href="#热点规则的添加" class="headerlink" title="热点规则的添加"></a>热点规则的添加</h4><p>在 Sentinel 控制台里，添加热点规则的步骤如下：</p><p><img data-src="../../../asset/2024/10/sentinel-hot-rule-1.png"></p><p>热点参数规则（ParamFlowRule）类似于流量控制规则（FlowRule），主要有以下配置项：</p><table><thead><tr><th>属性</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td> resource</td><td> 资源名，必填</td><td></td></tr><tr><td> count</td><td> 限流阈值，必填</td><td></td></tr><tr><td> grade</td><td> 限流模式</td><td> QPS 模式</td></tr><tr><td> durationInSec</td><td> 统计窗口时间长度（单位为秒），从 <code>1.6.0</code> 版本开始支持</td><td> 1s</td></tr><tr><td>controlBehavior</td><td> 流控效果（支持快速失败和匀速排队模式），从 <code>1.6.0</code> 版本开始支持</td><td>快速失败</td></tr><tr><td> maxQueueingTimeMs</td><td> 最大排队等待时长（仅在匀速排队模式生效），从 <code>1.6.0</code> 版本开始支持</td><td> 0ms</td></tr><tr><td>paramIdx</td><td> 热点参数的索引，必填，对应 <code>SphU.entry(xxx, args)</code> 中的参数索引位置</td><td></td></tr><tr><td> paramFlowItemList</td><td> 参数例外项，可以针对指定的参数值单独设置限流阈值，不受前面 <code>count</code> 阈值的限制。<strong>仅支持基本类型和字符串类型</strong></td><td></td></tr><tr><td> clusterMode</td><td> 是否是集群参数流控规则</td><td> false</td></tr><tr><td>clusterConfig</td><td> 集群流控相关配置</td><td></td></tr></tbody></table><h4 id="热点规则的使用"><a href="#热点规则的使用" class="headerlink" title="热点规则的使用"></a>热点规则的使用</h4><ul><li>Java 接口代码</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RateLimitController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/rateLimit/hotKey")</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = "testHotKey", blockHandler = "hotKeyHandler")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testHotKey</span><span class="params">(<span class="meta">@RequestParam(value = "p1", required = false)</span> String p1,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="meta">@RequestParam(value = "p2", required = false)</span> String p2)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hotKeyHandler</span><span class="params">(String p1, String p2, BlockException exception)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hot key rate limit"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Sentinel 控制台添加热点规则</li></ul><p><img data-src="../../../asset/2024/10/sentinel-hot-rule-2.png"></p><div class="admonition warning"><p class="admonition-title">特别注意</p><p>在 Sentinel 控制台添加热点规则时，资源名必须是 <code>@SentinelResource</code> 注解的 <code>value</code> 属性的值，不能是接口的 URL 地址，否则热点参数限流不会生效。</p></div><ul><li>测试案例代码<ul><li> (1) 通过浏览器快速多次访问 <code>/testHotKey?p1=abc</code> 接口，发现会返回自定义的限流提示信息 <code>hot key rate limit</code>，说明热点参数限流生效。</li><li>(2) 通过浏览器快速多次访问 <code>/testHotKey?p1=abc&amp;p2=efg</code> 接口，发现也会返回自定义的限流提示信息 <code>hot key rate limit</code>，说明只要请求含有指定的参数，热点参数限流都会生效。</li><li>(3) 通过浏览器快速多次访问 <code>/testHotKey?p2=efg</code> 接口，发现返回的结果都是 <code>success</code>，说明只要请求不含有指定的参数，即使不断访问接口也不会触发热点参数限流。</li></ul></li></ul><h4 id="参数例外项配置"><a href="#参数例外项配置" class="headerlink" title="参数例外项配置"></a>参数例外项配置</h4><h5 id="参数例外项的概述"><a href="#参数例外项的概述" class="headerlink" title="参数例外项的概述"></a>参数例外项的概述</h5><p>在上述案例中，演示了接口携带第一个参数 <code>p1</code>，当 QPS 超过 1 秒 1 次时，接口马上被限流。但是，面对复杂易变的业务需求，往往会有特殊情况需要额外处理。</p><ul><li>正常限流<ul><li>接口携带第一个参数 <code>p1</code>，当 QPS 达到预设阀值时立刻被限流。</li></ul></li><li>特殊限流<ul><li>希望当 <code>p1</code> 参数是某个特殊值时，QPS 到达预设阀值后热点规则突然例外（失效），它的限流阀值跟平时不一样。</li><li>比如：当 <code>p1</code> 参数的值等于 5 时，QPS 阀值可以允许达到 200 或者其他值。</li></ul></li></ul><h5 id="参数例外项的使用"><a href="#参数例外项的使用" class="headerlink" title="参数例外项的使用"></a>参数例外项的使用</h5><ul><li>Java 接口代码</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RateLimitController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/rateLimit/hotKey")</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = "testHotKey", blockHandler = "hotKeyHandler")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testHotKey</span><span class="params">(<span class="meta">@RequestParam(value = "p1", required = false)</span> String p1,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="meta">@RequestParam(value = "p2", required = false)</span> String p2)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hotKeyHandler</span><span class="params">(String p1, String p2, BlockException exception)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hot key rate limit"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Sentinel 控制台添加热点规则 + 参数例外项</li></ul><p><img data-src="../../../asset/2024/10/sentinel-rule-3.png"></p><ul><li>测试案例代码<ul><li> (1) 通过浏览器快速多次访问 <code>/testHotKey?p1=abc</code> 接口，当 QPS 达到超过 1 秒 1 次时，发现会返回自定义的限流提示信息 <code>hot key rate limit</code>，说明普通的热点参数限流生效。</li><li>(2) 通过浏览器快速多次访问 <code>/testHotKey?p1=mnt</code> 接口，当 QPS 达到超过 1 秒 5 次时，才会返回自定义的限流提示信息 <code>hot key rate limit</code>，说明参数例外项的热点参数限流生效。</li></ul></li></ul><div class="admonition warning"><p class="admonition-title">特别注意</p><p>使用参数例外项时，参数必须是基本类型或者 String 类型。</p></div><h2 id="Sentinel-授权规则"><a href="#Sentinel-授权规则" class="headerlink" title="Sentinel 授权规则"></a>Sentinel 授权规则</h2><div class="admonition note"><p class="admonition-title">官方文档</p><ul><li><a target="_blank" rel="external nofollow" href="https://github.com/alibaba/Sentinel/wiki/%E9%BB%91%E7%99%BD%E5%90%8D%E5%8D%95%E6%8E%A7%E5%88%B6">Sentinel 黑白名单控制</a></li></ul></div><h3 id="授权规则的概述"><a href="#授权规则的概述" class="headerlink" title="授权规则的概述"></a>授权规则的概述</h3><p>在很多时候，往往需要根据调用来源来判断该次请求是否允许放行，这时候可以使用 Sentinel 提供的授权规则（也叫黑白名单控制）来实现。授权规则根据资源的请求来源（Origin）限制资源是否通过，若配置白名单则只有请求来源位于白名单内时才可通过；若配置黑名单则请求来源位于黑名单时不通过，其余的请求都通过。</p><div class="admonition note"><p class="admonition-title">提示</p><p>调用方信息是通过 <code>ContextUtil.enter(resourceName, origin)</code> 方法中的 <code>origin</code> 参数传入。</p></div><h3 id="授权规则的添加"><a href="#授权规则的添加" class="headerlink" title="授权规则的添加"></a>授权规则的添加</h3><p>在 Sentinel 控制台里，添加热点规则的步骤如下：</p><p><img data-src="../../../asset/2024/10/sentinel-autority-rule.png"></p><p>授权规则（AuthorityRule）非常简单，主要有以下配置项：</p><table><thead><tr><th>属性</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td> resource</td><td> 资源名，即限流规则的作用对象。</td><td></td></tr><tr><td>limitApp</td><td> 对应的黑名单 / 白名单，不同 origin 用 <code>,</code> 分隔，如 <code>appA,appB</code>。</td><td></td></tr><tr><td>strategy</td><td> 限制模式，<code>AUTHORITY_WHITE</code> 为白名单模式，<code>AUTHORITY_BLACK</code> 为黑名单模式，默认为白名单模式。</td><td><code>AUTHORITY_WHITE</code></td></tr></tbody></table><h3 id="授权规则的使用"><a href="#授权规则的使用" class="headerlink" title="授权规则的使用"></a>授权规则的使用</h3><ul><li>Java 接口的代码</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmpowerController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/empower")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">empower</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>自定义请求来源转换器，需要实现 <code>RequestOriginParser</code> 接口，目的是告知 Sentinel 从哪里获取请求来源</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRequestOriginParser</span> <span class="keyword">implements</span> <span class="title">RequestOriginParser</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">parseOrigin</span><span class="params">(HttpServletRequest httpServletRequest)</span> </span>{</span><br><span class="line">        <span class="comment">// 指定从哪里获取请求来源，比如可以从 HTTP 请求的参数、Header 获取</span></span><br><span class="line">        <span class="keyword">return</span> httpServletRequest.getParameter(<span class="string">"serverName"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Sentinel 控制台添加授权规则</li></ul><p><img data-src="../../../asset/2024/10/sentinel-autority-rule-2.png"></p><ul><li>测试案例代码<ul><li> (1) 通过浏览器访问 <code>/empower?serverName=appC</code> 接口，会返回正确结果 <code>success</code>。</li><li>(2) 通过浏览器访问 <code>/empower?serverName=appA</code> 接口，发现会返回 <code>Blocked by Sentinel (flow limiting)</code>，说明授权规则生效了。</li><li>(3) 通过浏览器访问 <code>/empower?serverName=appB</code> 接口，发现会返回 <code>Blocked by Sentinel (flow limiting)</code>，说明授权规则生效了。</li></ul></li></ul><h2 id="Sentinel-配置规则持久化"><a href="#Sentinel-配置规则持久化" class="headerlink" title="Sentinel 配置规则持久化"></a>Sentinel 配置规则持久化</h2><p>由于 Sentinel 控制台重启后，已配置的规则就会丢失（默认存储在内存中），因此生产环境需要将配置规则持久化。比如，将流控规则持久化进 Nacos 保存后，只要 Nacos 里面的配置信息不删除，Sentinel 的流控规则就会持续有效。Sentinel 官方推荐注册动态规则源（如 Nacos 配置中心）来实现动态推送，比如 <code>GatewayRuleManager.register2Property (property)</code>。Sentinel 配置规则持久化有以下几种方案：</p><ul><li>(1) 持久化方案一：在业务模块（包含 Sentinel 客户端）中引入 <code>sentinel-datasource-nacos</code> 依赖，并将 Sentinel 配置规则添加到 Nacos 配置中心。</li><li>(2) 持久化方案二：改造 Sentinel Dashboard 项目，使其支持通过 Sentinel Dashboard 界面将流量控制配置规则存储到 Nacos。</li><li>(3) 持久化方案三：使用 Sentinel 提供的 API 来自定义配置规则，也就是说通过代码的方式定义（写死）Sentinel 配置规则，比如 <code>GatewayRuleManager.loadRules (rules)</code>，缺点是配置规则不支持实时更新。由于此方案的灵活性较差，因此使用得比较较少。</li></ul><div class="admonition note"><p class="admonition-title">官方文档</p><ul><li><a target="_blank" rel="external nofollow" href="https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel#%E5%8A%A8%E6%80%81%E6%95%B0%E6%8D%AE%E6%BA%90%E6%94%AF%E6%8C%81">Sentinel 动态数据源支持</a></li><li><a target="_blank" rel="external nofollow" href="https://github.com/alibaba/Sentinel/wiki/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%99%E6%89%A9%E5%B1%95">Sentinel 动态规则扩展使用</a></li></ul></div><h3 id="持久化方案一"><a href="#持久化方案一" class="headerlink" title="持久化方案一"></a>持久化方案一</h3><h4 id="方案使用介绍"><a href="#方案使用介绍" class="headerlink" title="方案使用介绍"></a>方案使用介绍</h4><ul><li>根据 Sentinel 官方文档，当业务应用（包含 Sentinel 客户端）使用 Nacos 作为配置规则的数据源时，通常的工作流程是业务应用启动时从 Nacos 读取规则，同时 Sentinel 控制台也可以展示配置规则。如果在 Sentinel 控制台中修改了规则，默认情况下，Sentinel 控制台会将配置规则保存在自己的内存中，而不是回写到 Nacos。因此，这些修改不会持久化到 Nacos，当业务应用重启后会再次从 Nacos 读取原始配置，导致 Sentinel 控制台的配置规则修改丢失。</li><li>正确的做法应该是，在 Nacos 中修改配置规则，这样 Sentinel 客户端会监听 Nacos 的配置变化，自动更新本地规则，实现实时更新。同时，Sentinel 控制台也能展示最新的规则，但配置规则的修改仍需通过 Nacos 进行，以确保持久化和同步。</li><li>特别注意，Sentinel 与 Nacos 是否支持双向同步取决于具体的实现。有些情况下，可能通过改造代码（定制开发），让 Sentinel 控制台将修改的规则写回 Nacos 中，但这并不是默认的行为。</li></ul><h4 id="引入依赖坐标"><a href="#引入依赖坐标" class="headerlink" title="引入依赖坐标"></a>引入依赖坐标</h4><p>在需要使用 Sentinel 进行流量控制的业务模块中，添加以下依赖：</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Sentinel --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Sentinel 的 Nacos 数据源 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">提示</p><p>如果在业务系统中，已经使用了 Nacos 作为服务注册中心或者配置中心，则项目无需做任何改动，只需要正常引用上面的 Maven 依赖和添加下面的 YML 配置信息即可实现 Sentinel 配置规则持久化。</p></div><h4 id="添加测试代码"><a href="#添加测试代码" class="headerlink" title="添加测试代码"></a>添加测试代码</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RateLimitController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/rateLimit/byUrl")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">byUrl</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"按 URL 地址进行限流测试"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="添加-YML-配置信息"><a href="#添加-YML-配置信息" class="headerlink" title="添加 YML 配置信息"></a>添加 YML 配置信息</h4><div class="admonition warning"><p class="admonition-title">特别注意</p><ul><li>Sentinel 网关流控规则的数据源类型是 <code>gw-flow</code>，若将网关流控规则的数据源类型指定为 <code>flow</code> 则不会生效，这定义在 <code>com.alibaba.cloud.sentinel.datasource.RuleType</code> 枚举类中。</li></ul></div><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">sentinel-demo-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="comment"># Sentinel</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.112</span><span class="string">:8858</span>   <span class="comment"># 配置 Sentinel Dashboard 控制台的访问地址</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8719</span>                       <span class="comment"># 默认 8719 端口，假如被占用会自动从 8719 开始依次 + 1 扫描，直至找到未被占用的端口</span></span><br><span class="line">        <span class="attr">client-ip:</span> <span class="number">192.168</span><span class="number">.2</span><span class="number">.140</span>         <span class="comment"># 指定客户端的 IP</span></span><br><span class="line">      <span class="attr">datasource:</span></span><br><span class="line">        <span class="attr">ds1:</span></span><br><span class="line">          <span class="comment"># Nacos 数据源（配置中心）</span></span><br><span class="line">          <span class="attr">nacos:</span></span><br><span class="line">            <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.112</span><span class="string">:8848</span></span><br><span class="line">            <span class="attr">dataId:</span> <span class="string">${spring.application.name}</span></span><br><span class="line">            <span class="attr">groupId:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line">            <span class="attr">data-type:</span> <span class="string">json</span></span><br><span class="line">            <span class="attr">rule-type:</span> <span class="string">flow</span>   <span class="comment"># com.alibaba.cloud.sentinel.datasource.RuleType</span></span><br></pre></td></tr></tbody></table></figure><p>上面配置的 <code>rule-type</code> 参数的值来自 <code>com.alibaba.cloud.sentinel.datasource.RuleType</code> 枚举类，常用的值有以下几个：</p><p><img data-src="../../../asset/2024/10/sentinel-store-nacos-1.png"></p><p>上面配置的 <code>datasource</code> 可以有多个，可以理解为允许有多个不同类型的控制规则（如流量规则、熔断规则、热点规则等），如下图所示：</p><p><img data-src="../../../asset/2024/10/sentinel-store-nacos-5.png"></p><h4 id="Nacos-添加流控规则"><a href="#Nacos-添加流控规则" class="headerlink" title="Nacos 添加流控规则"></a>Nacos 添加流控规则</h4><div class="admonition note"><p class="admonition-title">提示</p><ul><li>这里只简单演示如何将 Sentinel 的流控规则配置信息持久化到 Nacos 中，如果是持久化熔断规则或者热点规则等其他配置信息，具体的 JSON 配置内容请自行查阅官方文档。</li></ul></div><p>首先将 Sentinel 流控规则的配置信息转换为 JSON 配置内容：</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    {</span><br><span class="line">        <span class="attr">"resource"</span>: <span class="string">"/rateLimit/byUrl"</span>,</span><br><span class="line">        <span class="attr">"limitApp"</span>: <span class="string">"default"</span>,</span><br><span class="line">        <span class="attr">"grade"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"count"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"strategy"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"controlBehavior"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"clusterMode"</span>: <span class="literal">false</span></span><br><span class="line">    }</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure><p>Sentinel 流控规则的 JSON 配置内容说明：</p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td> resource</td><td> 资源名称</td></tr><tr><td> limitApp</td><td> 来源应用</td></tr><tr><td> grade</td><td> 阈值类型，0 表示并发线程数，1 表示 QPS</td></tr><tr><td>count</td><td> 单机阈值</td></tr><tr><td> strategy</td><td> 流控模式，0 表示直接，1 表示关联，2 表示链路</td></tr><tr><td> controlBehavior</td><td> 流控效果，0 表示快速失败，1 表示 Warm Up，2 表示排队等待</td></tr><tr><td> clusterMode</td><td> 是否集群</td></tr></tbody></table><p>然后将 Sentinel 流控规则的 JSON 配置内容添加到 Nacos 中：</p><p><img data-src="../../../asset/2024/10/sentinel-store-nacos-2.png"></p><p>最后在 Nacos 中 Sentinel 流控规则的配置信息如下：</p><p><img data-src="../../../asset/2024/10/sentinel-store-nacos-3.png"></p><h4 id="案例代码测试"><a href="#案例代码测试" class="headerlink" title="案例代码测试"></a>案例代码测试</h4><ul><li>(1) 启动微服务应用。</li><li>(2) 通过浏览器访问微服务应用的 <code>/rateLimit/byUrl</code> 接口，等待几秒中，让 Sentinel 控制台发现微服务应用的存在。</li><li>(3) 通过浏览器访问 Sentinel 控制台的管理页面，点击 <code>流控规则</code> 菜单项，即可以看到在 Nacos 中添加的流控规则配置信息（如下图所示）。如果看不到对应的配置信息，可以多刷新几次页面试试。</li></ul><p><img data-src="../../../asset/2024/10/sentinel-store-nacos-4.png"></p><ul><li>(4) 通过浏览器快速多次访问 <code>/rateLimit/byUrl</code> 接口，当 QPS 达到超过 1 秒 1 次时，接口会返回默认提示信息 <code>Blocked by Sentinel (flow limiting)</code>，说明 Sentinel 的流控规则生效了。</li><li>(5) 重启微服务应用，再次通过浏览器快速多次访问 <code>/rateLimit/byUrl</code> 接口，当 QPS 达到超过 1 秒 1 次时，接口仍然会被限流。</li></ul><h3 id="持久化方案二"><a href="#持久化方案二" class="headerlink" title="持久化方案二"></a>持久化方案二</h3><h4 id="方案介绍"><a href="#方案介绍" class="headerlink" title="方案介绍"></a>方案介绍</h4><p>在企业级生产环境中，往往需要改造 Sentinel Dashboard 项目，使其支持通过 Sentinel Dashboard 界面将流量控制配置规则存储到 Nacos，改造步骤可以参考以下教程：</p><ul><li><a target="_blank" rel="external nofollow" href="https://github.com/modongning/sentinel-dashboard-nacos">基于 Sentinel 1.8.6，实现限流规则双向持久化到 Nacos</a></li><li><a target="_blank" rel="external nofollow" href="https://developer.aliyun.com/article/1167388">Sentinel Dashboard 改造支持规则配置持久化至 Nacos</a></li><li><a target="_blank" rel="external nofollow" href="https://juejin.cn/post/6952506909270212622">Sentinel Dashboard 改造实现规则持久化到 Nacos</a></li><li><a target="_blank" rel="external nofollow" href="https://juejin.cn/post/6844903848025260046">Sentinel Dashboard 中修改规则同步到 Nacos</a></li></ul><p>值得一提的是，还可以直接使用 Dante Cloud 改造后发布的 <a target="_blank" rel="external nofollow" href="https://hub.docker.com/r/herodotus/sentinel-dashboard">Sentinel Dashboard 镜像</a>，它基于最新版的 Spring Cloud Alibaba Sentinel Dashboard 扩展改造而来，支持微服务流量监控数据持久化存储到 Influxdb 时序数据库，还支持通过 Sentinel Dashboard 界面将流量控制配置规则存储到 Nacos 中。Dante Cloud 改造后发布的 Sentinel Dashboard 镜像，时序数据存储支持 Influxdb <code>1.x</code> 版本，Nacos 目前仅支持 <code>2.x</code> 版本。默认使用 Sentinel Dashboard 原有内存方式存储，可通过配置参数动态开启或者关闭 Influxdb 和 Nacos 存储机制。</p><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/4fd0a683.html" title="Sentinel 进阶教程 - 中级篇（2024 年）">https://www.techgrow.cn/posts/4fd0a683.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="fa fa-tag"></i> 微服务</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/23b44adb.html" rel="prev" title="Sentinel 进阶教程 - 基础篇（2024 年）"><i class="fa fa-angle-left"></i> Sentinel 进阶教程 - 基础篇（2024 年）</a></div><div class="post-nav-item"> <a href="/posts/e86e9dbd.html" rel="next" title="ElasticSearch 性能优化教程">ElasticSearch 性能优化教程<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">2.2m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">33:26</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/4fd0a683.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>