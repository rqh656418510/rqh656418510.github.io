<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍 C++ 如何实现 MySQL 数据库连接池。"><meta property="og:type" content="article"><meta property="og:title" content="基于 C++ 实现 MySQL 数据库连接池"><meta property="og:url" content="https://www.techgrow.cn/posts/993ae2e0.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍 C++ 如何实现 MySQL 数据库连接池。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/02/cxx-mysql-connection-pool-arch.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/02/cxx-mysql-debug.png"><meta property="article:published_time" content="2024-12-23T13:55:33.000Z"><meta property="article:modified_time" content="2024-12-23T13:55:33.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="Linux系统编程"><meta property="article:tag" content="数据库"><meta property="article:tag" content="并发编程"><meta property="article:tag" content="C++"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2025/02/cxx-mysql-connection-pool-arch.png"><link rel="canonical" href="https://www.techgrow.cn/posts/993ae2e0.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/993ae2e0.html","path":"posts/993ae2e0.html","title":"基于 C++ 实现 MySQL 数据库连接池"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>基于 C++ 实现 MySQL 数据库连接池 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E8%83%8C%E6%99%AF"><span class="nav-text">项目背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E6%8A%80%E6%9C%AF"><span class="nav-text">关键技术</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="nav-text">版本说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%BC%E5%AE%B9%E5%B9%B3%E5%8F%B0"><span class="nav-text">兼容平台</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-text">准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-Boost"><span class="nav-text">安装 Boost</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-MySQL-Connector-C"><span class="nav-text">安装 MySQL Connector/C++</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%9A%84%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D"><span class="nav-text">连接池的功能介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%9A%84%E5%8A%9F%E8%83%BD%E8%AE%BE%E8%AE%A1"><span class="nav-text">连接池的功能设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%9A%84%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="nav-text">连接池的代码实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%9A%84%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-text">连接池的项目结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%9A%84%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0"><span class="nav-text">连接池的配置参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%9A%84-CMake-%E9%85%8D%E7%BD%AE"><span class="nav-text">连接池的 CMake 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%9A%84-C-%E5%A4%B4%E6%96%87%E4%BB%B6"><span class="nav-text">连接池的 C++ 头文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%9A%84-C-%E6%BA%90%E6%96%87%E4%BB%B6"><span class="nav-text">连接池的 C++ 源文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%9A%84%E4%BB%A3%E7%A0%81%E6%B5%8B%E8%AF%95"><span class="nav-text">连接池的代码测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%9A%84%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7"><span class="nav-text">连接池的调试技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL-C-API-%E8%B0%83%E8%AF%95"><span class="nav-text">MySQL C API 调试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL-Connector-C-%E8%B0%83%E8%AF%95"><span class="nav-text">MySQL Connector/C++ 调试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL-%E7%9A%84%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4"><span class="nav-text">MySQL 的参数调整</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%9A%84%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95"><span class="nav-text">连接池的压力测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%9A%84%E4%BB%A3%E7%A0%81%E4%B8%8B%E8%BD%BD"><span class="nav-text">连接池的代码下载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">744</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">53</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/993ae2e0.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="基于 C++ 实现 MySQL 数据库连接池 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍 C++ 如何实现 MySQL 数据库连接池。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 基于 C++ 实现 MySQL 数据库连接池</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-12-23 21:55:33" itemprop="dateCreated datePublished" datetime="2024-12-23T21:55:33+08:00">2024-12-23</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/993ae2e0.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/993ae2e0.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>4.6k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>4 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/c942e1de.html">C++ 使用 API 连接 MySQL 数据库</a></li><li><a href="/posts/993ae2e0.html">基于 C++ 实现 MySQL 数据库连接池</a></li></ul><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在 C/C++ 项目中，为了提高 MySQL Server 的访问效率，基于 C++ 11 实现数据库连接池，并使用 MySQL Connector/C++ 库。</p><h3 id="项目背景"><a href="#项目背景" class="headerlink" title="项目背景"></a>项目背景</h3><p>为了解决 MySQL 数据库（基于 C/S 设计）的访问瓶颈，除了在服务器端增加缓存服务器缓存常用的数据之外（例如 Redis），还可以增加连接池，来提高 MySQL Server 的访问效率。在高并发情况下，大量的 TCP 三次握手、MySQL Server 连接认证、MySQL Server 关闭连接回收资源和 TCP 四次挥手所耗费的性能时间也是很明显的，增加连接池就是为了减少这一部分的性能损耗。在市场上比较流行的连接池包括 C3P0、Apache DBCP、HikariCP、阿里巴巴的 Druid 连接池，它们对于短时间内大量的数据库增删改查操作性能的提升是很明显的，但是它们有一个共同点就是，全部都是由 Java 实现的。</p><span id="more"></span><h3 id="关键技术"><a href="#关键技术" class="headerlink" title="关键技术"></a>关键技术</h3><p>基于 C++ 11 实现数据库连接池时，使用到的技术栈如下：</p><ul><li>单例模式</li><li> Lambda 表达式</li><li>队列容器 <code>queue</code></li><li>智能指针 <code>shared_ptr</code></li><li>基于 CAS 的原子基础类型</li><li> MySQL 数据库编程（基于 MySQL Connector/C++ 库）</li><li>C++ 11 的多线程编程，包括线程互斥、线程同步通信等</li><li>生产者 - 消费者线程模型的实现，基于 <code>mutex</code>、<code>unique_lock</code>、<code>condition_variable</code></li></ul><h3 id="版本说明"><a href="#版本说明" class="headerlink" title="版本说明"></a>版本说明</h3><p>本文使用的各软件版本如下所示：</p><table><thead><tr><th>软件</th><th>版本</th></tr></thead><tbody><tr><td> C++</td><td><code>11</code></td></tr><tr><td>Boost</td><td><code>1_78_0</code></td></tr><tr><td>MySQL Connector/C++</td><td><code>1.1.13</code></td></tr><tr><td>G++（GCC）</td><td><code>4.8.5</code></td></tr><tr><td>CMake</td><td><code>3.25.1</code></td></tr><tr><td>MySQL</td><td><code>5.7.33</code></td></tr><tr><td>Clion</td><td><code>2019.3</code></td></tr><tr><td>Linux</td><td><code>CentOS 7.9</code></td></tr></tbody></table><h3 id="兼容平台"><a href="#兼容平台" class="headerlink" title="兼容平台"></a>兼容平台</h3><ul><li>(1) 有关 MySQL 数据库编程、多线程编程、线程互斥、线程同步通信、智能指针、设计模式、容器等等技术在 C++ 语言层面都可以直接实现；<strong>因此，数据库连接池代码是同时兼容 Windows 和 Linux 平台的，只是不同平台的 CMake 配置稍微有一点区别。</strong></li><li><strong>(2) 由于 MySQL 在 Linux 平台上使用得比较多，因此默认选择在 Linux 平台上进行开发，并使用 CMake 和 GCC 直接编译运行项目。</strong></li></ul><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="安装-Boost"><a href="#安装-Boost" class="headerlink" title="安装 Boost"></a>安装 Boost</h3><ul><li>由于 MySQL Connector/C++ 依赖了 Boost，因此本地 Linux 系统需要安装 Boost。建议从 <a target="_blank" rel="external nofollow" href="https://www.boost.org/users/download/">Boost 官网</a> 下载 Boost 的源码压缩包，然后使用 <code>root</code> 用户手动编译安装 Boost，此方式适用于绝大多数 Linux 系统，如下所示：</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载文件</span></span><br><span class="line">$ wget https://boostorg.jfrog.io/artifactory/main/release/1.78.0/<span class="built_in">source</span>/boost_1_78_0.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压文件</span></span><br><span class="line">$ tar -xvf boost_1_78_0.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入解压目录</span></span><br><span class="line">$ <span class="built_in">cd</span> boost_1_78_0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建</span></span><br><span class="line">$ sudo ./bootstrap.sh --prefix=/usr/<span class="built_in">local</span>/boost</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装（耗时非常长）</span></span><br><span class="line">$ sudo ./b2 install --prefix=/usr/<span class="built_in">local</span>/boost --with=all</span><br></pre></td></tr></tbody></table></figure><h3 id="安装-MySQL-Connector-C"><a href="#安装-MySQL-Connector-C" class="headerlink" title="安装 MySQL Connector/C++"></a>安装 MySQL Connector/C++</h3><ul><li>(1) Linux 平台上，可以在 <a target="_blank" rel="external nofollow" href="https://dev.mysql.com/downloads/connector/cpp/">MySQL 官网</a> 直接下载 <code>1.1.13</code> 版本的 MySQL Connector/C++，下载完成后直接解压文件。</li><li>(2) 将解压得到的 <code>include</code> 和 <code>lib</code> 目录拷贝到数据库连接池项目中，然后配置 CMake 加载 MySQL Connector/C++ 的头文件和动态链接库即可。</li></ul><h2 id="连接池的功能介绍"><a href="#连接池的功能介绍" class="headerlink" title="连接池的功能介绍"></a>连接池的功能介绍</h2><p>连接池一般包含了数据库连接所用的 IP 地址、Port 端口号、用户名和密码以及其它的性能参数，例如初始连接数、最大连接数、最大空闲时间、连接超时时间等。本项目是基于 C++ 语言实现的连接池，主要也是实现以上几个所有连接池都支持的通用基础功能，其余连接池更多的扩展功能，可以自行实现。</p><ul><li><p>初始连接数（initSize）：</p><ul><li>表示连接池事先会和 MySQL Server 创建 initSize 个数的 connection 连接，当应用发起 MySQL 访问时，不用再创建和 MySQL Server 新的连接，直接从连接池中获取一个可用的连接就可以，使用完成后，并不去释放 connection，而是把当前 connection 再归还到连接池当中。</li></ul></li><li><p>最大连接数（maxSize）:</p><ul><li>当并发访问 MySQL Server 的请求增多时，初始连接数已经不够使用了，此时会根据新的请求数量去创建更多的连接给应用去使用，但是新创建的连接数量上限是 maxSize，不能无限制地创建连接，因为每一个连接都会占用一个 socket 资源。一般连接池和服务器程序是部署在一台主机上的，如果连接池占用过多的 socket 资源，那么服务器就不能接收太多的客户端请求了。当这些连接使用完成后，再次归还到连接池当中来维护。</li></ul></li><li><p>最大空闲时间（maxIdleTime）：</p><ul><li>当访问 MySQL 的并发请求多了以后，连接池里面的连接数量会动态增加，上限是 maxSize 个，当这些连接用完再次归还到连接池当中。如果在指定的 maxIdleTime 里面，这些新增加的连接都没有被再次使用过，那么新增加的这些连接资源就要被回收掉，只需要保持初始连接数 initSize 个连接就可以了。</li></ul></li><li><p>连接超时时间（connectionTimeout）:</p><ul><li>当 MySQL 的并发请求量过大，连接池中的连接数量已经到达 maxSize 了，而此时没有空闲的连接可供使用，那么此时应用无法从连接池获取连接，它通过阻塞的方式获取连接的等待时间如果超过 connectionTimeout 时间，则获取连接失败，无法访问数据库。</li></ul></li></ul><h2 id="连接池的功能设计"><a href="#连接池的功能设计" class="headerlink" title="连接池的功能设计"></a>连接池的功能设计</h2><ul><li><p>C++ 源文件的功能划分</p><ul><li><code>MysqlConnection.h</code> 和 <code>MysqlConnection.cpp</code>：数据库增删改查的代码实现</li><li><code>MysqlConnectionPool.h</code> 和 <code>MysqlConnectionPool.cpp</code>：连接池的代码实现</li></ul></li><li><p>连接池的实现主要包含了以下功能</p><ul><li>(1) 连接池只需要一个实例，所以 ConnectionPool 以单例模式进行设计。</li><li>(2) 应用可以从 ConnectionPool 中获取 MySQL 的连接 Connection。</li><li>(3) 空闲连接 Connection 全部存储在一个线程安全的 Connection 队列中，使用互斥锁来保证队列的线程安全。</li><li>(4) 如果 Connection 队列为空，应用还需要再获取连接，此时需要动态创建连接，最大的连接数量是 maxSize。</li><li>(5) 当队列中空闲连接的存活时间超过 maxIdleTime 后，连接就要被释放掉，只保留初始的 initSize 个连接就可以，这个功能需要放在独立的线程中去完成（定时扫描连接）。</li><li>(6) 如果 Connection 队列为空，而且当前已创建的连接的数量已达到上限 maxSize，则应用需要等待 connectionTimeout 时间。如果应用还是获取不到空闲的连接，则获取连接失败；此处从 Connection 队列获取空闲连接时，可以使用带超时时间的 <code>mutex</code> 互斥锁来实现连接超时时间。</li><li>(7) 应用获取的连接用 <code>shared_ptr</code> 智能指针来管理，并用 Lambda 表达式定制连接释放的功能（不真正释放连接，而是将连接归还到 Connection 队列中）。</li><li>(8) 连接的生产和连接的消费采用生产者 - 消费者线程模型来设计，使用了线程间的同步通信机制、条件变量和互斥锁。</li></ul></li></ul><h2 id="连接池的代码实现"><a href="#连接池的代码实现" class="headerlink" title="连接池的代码实现"></a>连接池的代码实现</h2><h3 id="连接池的项目结构"><a href="#连接池的项目结构" class="headerlink" title="连接池的项目结构"></a>连接池的项目结构</h3><p><img data-src="../../../asset/2025/02/cxx-mysql-connection-pool-arch.png"></p><table><thead><tr><th>目录名称</th><th>说明</th></tr></thead><tbody><tr><td><code>bin</code></td><td>存放 CMake 编译生成的可执行文件</td></tr><tr><td><code>config</code></td><td>存放数据库连接池的配置文件</td></tr><tr><td><code>include</code></td><td>存放数据库连接池的 C++ 头文件</td></tr><tr><td><code>src</code></td><td>存放数据库连接池的 C++ 源文件</td></tr><tr><td><code>sql</code></td><td>存放 MySQL 数据库初始化的 SQL 脚本</td></tr><tr><td><code>script</code></td><td>存放 Linux 平台自动编译构建项目的 Shell 脚本</td></tr><tr><td><code>libs</code></td><td>存放项目依赖的第三方静态库和动态链接库</td></tr><tr><td><code>mysql-connector</code></td><td>存放 MySQL Connector/C++ 库的头文件和动态链接库（适用于 Linux 平台）</td></tr></tbody></table><p>MySQL Connector/C++ 库的头文件和动态链接库（Linux 平台）如下所示：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">mysql-connector</span><br><span class="line">├── include</span><br><span class="line">│&nbsp;&nbsp; ├── cppconn</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── build_config.h</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── config.h</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── connection.h</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── datatype.h</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── driver.h</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── exception.h</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── metadata.h</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── parameter_metadata.h</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── prepared_statement.h</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── resultset.h</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── resultset_metadata.h</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── sqlstring.h</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── statement.h</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── variant.h</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── version_info.h</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; └── warning.h</span><br><span class="line">│&nbsp;&nbsp; ├── mysql_connection.h</span><br><span class="line">│&nbsp;&nbsp; ├── mysql_driver.h</span><br><span class="line">│&nbsp;&nbsp; └── mysql_error.h</span><br><span class="line">└── lib</span><br><span class="line">    ├── libcrypto.so -&gt; libcrypto.so.1.1</span><br><span class="line">    ├── libcrypto.so.1.1</span><br><span class="line">    ├── libmysqlcppconn.so -&gt; libmysqlcppconn.so.7</span><br><span class="line">    ├── libmysqlcppconn.so.7 -&gt; libmysqlcppconn.so.7.1.1.13</span><br><span class="line">    ├── libmysqlcppconn.so.7.1.1.13</span><br><span class="line">    ├── libssl.so -&gt; libssl.so.1.1</span><br><span class="line">    └── libssl.so.1.1</span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">提示</p><ul><li>MySQL Connector/C++ 库的使用教程请看 <a href="/posts/c942e1de.html">这里</a>。</li></ul></div><h3 id="连接池的配置参数"><a href="#连接池的配置参数" class="headerlink" title="连接池的配置参数"></a>连接池的配置参数</h3><p>数据库连接池的配置参数格式是 <code>key=value</code>，默认存放在 <code>config</code> 目录下的 <code>mysql.ini</code> 文件中，其配置内容如下所示：</p><figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 连接地址</span></span><br><span class="line"><span class="attr">host</span>=<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">3306</span></span><br><span class="line"><span class="comment"># 用户名</span></span><br><span class="line"><span class="attr">username</span>=root</span><br><span class="line"><span class="comment"># 密码</span></span><br><span class="line"><span class="attr">password</span>=<span class="number">123456</span></span><br><span class="line"><span class="comment"># 数据库</span></span><br><span class="line"><span class="attr">dbname</span>=cxx_study</span><br><span class="line"><span class="comment"># 初始连接数</span></span><br><span class="line"><span class="attr">initSize</span>=<span class="number">10</span></span><br><span class="line"><span class="comment"># 最大连接数</span></span><br><span class="line"><span class="attr">maxSize</span>=<span class="number">100</span></span><br><span class="line"><span class="comment"># 最大空闲时间（单位秒）</span></span><br><span class="line"><span class="attr">maxIdleTime</span>=<span class="number">5</span></span><br><span class="line"><span class="comment"># 连接超时时间（单位毫秒）</span></span><br><span class="line"><span class="attr">connectionTimeout</span>=<span class="number">500</span></span><br></pre></td></tr></tbody></table></figure><h3 id="连接池的-CMake-配置"><a href="#连接池的-CMake-配置" class="headerlink" title="连接池的 CMake 配置"></a>连接池的 CMake 配置</h3><figure class="highlight cmake"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义 CMake 的版本</span></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.15</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义第三方库的目录路径</span></span><br><span class="line"><span class="keyword">set</span>(PATH_TO_BOOST /usr/local/boost)</span><br><span class="line"><span class="keyword">set</span>(PATH_TO_MYSQL_CONNECTOR ./libs/mysql-connector)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义项目信息</span></span><br><span class="line"><span class="keyword">project</span>(db_connection_pool)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义 C++ 的版本</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定构建输出的目录</span></span><br><span class="line"><span class="keyword">set</span>(PROJECT_BINARY_DIR <span class="variable">${PROJECT_SOURCE_DIR}</span>/build)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定可执行文件的输出目录</span></span><br><span class="line"><span class="keyword">set</span>(EXECUTABLE_OUTPUT_PATH <span class="variable">${PROJECT_SOURCE_DIR}</span>/bin)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义目标，每次编译之前清理可执行文件的输出目录</span></span><br><span class="line"><span class="keyword">add_custom_target</span>(clean_bin ALL</span><br><span class="line">        <span class="keyword">COMMAND</span> <span class="variable">${CMAKE_COMMAND}</span> -E remove_directory <span class="variable">${EXECUTABLE_OUTPUT_PATH}</span></span><br><span class="line">        <span class="keyword">COMMAND</span> <span class="variable">${CMAKE_COMMAND}</span> -E <span class="keyword">make_directory</span> <span class="variable">${EXECUTABLE_OUTPUT_PATH}</span></span><br><span class="line">        COMMENT <span class="string">"Cleaning bin directory before build"</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义命令，每次编译之前拷贝 MySQL 配置文件到可执行文件的输出目录</span></span><br><span class="line"><span class="keyword">add_custom_command</span>(</span><br><span class="line">        <span class="keyword">TARGET</span> clean_bin</span><br><span class="line">        POST_BUILD</span><br><span class="line">        <span class="keyword">COMMAND</span> <span class="variable">${CMAKE_COMMAND}</span> -E copy_if_different</span><br><span class="line">        <span class="variable">${CMAKE_SOURCE_DIR}</span>/config/mysql.ini</span><br><span class="line">        <span class="variable">${EXECUTABLE_OUTPUT_PATH}</span>/mysql.ini</span><br><span class="line">        COMMENT <span class="string">"Copying mysql.ini to bin directory before build"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 引入项目里的头文件</span></span><br><span class="line"><span class="keyword">include_directories</span>(<span class="variable">${PROJECT_SOURCE_DIR}</span>/<span class="keyword">include</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索项目里的源文件，并将文件名保存到 MAIN_SOURCES 变量</span></span><br><span class="line"><span class="keyword">aux_source_directory</span>(<span class="variable">${PROJECT_SOURCE_DIR}</span>/src MAIN_SOURCES)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 引入第三方库的头文件</span></span><br><span class="line"><span class="keyword">include_directories</span>(<span class="variable">${PATH_TO_BOOST}</span>/<span class="keyword">include</span> <span class="variable">${PATH_TO_MYSQL_CONNECTOR}</span>/<span class="keyword">include</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定项目里静态库和动态链接库的目录</span></span><br><span class="line"><span class="keyword">link_directories</span>(<span class="variable">${PATH_TO_BOOST}</span>/lib <span class="variable">${PATH_TO_MYSQL_CONNECTOR}</span>/lib)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定可执行文件的名称和项目里的所有源文件</span></span><br><span class="line"><span class="keyword">add_executable</span>(<span class="variable">${PROJECT_NAME}</span>_test <span class="variable">${MAIN_SOURCES}</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定编译参数，比如包括链接库文件：pthread、ssl、crypto、boost</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_FLAGS <span class="string">"-lpthread -lssl -lcrypto -lboost_system -lboost_filesystem"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 链接项目里的静态库和动态链接库</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(<span class="variable">${PROJECT_NAME}</span>_test ssl.so crypto.so mysqlcppconn.so)</span><br></pre></td></tr></tbody></table></figure><h3 id="连接池的-C-头文件"><a href="#连接池的-C-头文件" class="headerlink" title="连接池的 C++ 头文件"></a>连接池的 C++ 头文件</h3><ul><li><code>public.h</code></li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> WIN32</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> LOG(format, ...) printf(format, __VA_ARGS__);</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> LOG(format, ...) printf(format, ##__VA_ARGS__);</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></tbody></table></figure><ul><li><code>MysqlConnection.h</code></li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MySQL 增删改查操作的定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mysql_connection.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cppconn/driver.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cppconn/exception.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cppconn/resultset.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cppconn/statement.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cppconn/prepared_statement.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"public.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> sql;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> chrono::system_clock::time_point time_point;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MySQL 数据库操作类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MysqlConnection</span> {</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MysqlConnection</span>();</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">MysqlConnection</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">execute</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *sql)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">executeUpdate</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *sql)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">unique_ptr&lt;ResultSet&gt; <span class="title">query</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *query, <span class="keyword">const</span> vector&lt;string&gt; parameters)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">connect</span><span class="params">(<span class="keyword">const</span> string host, <span class="keyword">const</span> string username, <span class="keyword">const</span> string password, <span class="keyword">const</span> string dbname)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">refreshAliveTime</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getAliveTime</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    string _host;                           <span class="comment">// MySQL 连接地址</span></span><br><span class="line">    string _username;                       <span class="comment">// MySQL 用户名</span></span><br><span class="line">    string _password;                       <span class="comment">// MySQL 密码</span></span><br><span class="line">    string _dbname;                         <span class="comment">// MySQL 数据库</span></span><br><span class="line">    Driver *_driver;                        <span class="comment">// MySQL 驱动</span></span><br><span class="line">    Connection *_connection;                <span class="comment">// MySQL 连接</span></span><br><span class="line">    time_point _aliveTime;                  <span class="comment">// 记录连接进入空闲状态后的起始存活时间点</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><ul><li><code>MysqlConnectionPool.h</code></li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MySQL 连接池的定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;condition_variable&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"public.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"MysqlConnection.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MySQL 连接池类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MysqlConnectionPool</span> {</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 析构函数</span></span><br><span class="line">    ~<span class="built_in">MysqlConnectionPool</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭连接池</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断连接池是否已关闭</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isClosed</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取连接池中的连接数量</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getSize</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取连接池单例</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> MysqlConnectionPool *<span class="title">getInstance</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 MySQL 连接</span></span><br><span class="line">    <span class="function">shared_ptr&lt;MysqlConnection&gt; <span class="title">getConnection</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// 私有化构造函数</span></span><br><span class="line">    <span class="built_in">MysqlConnectionPool</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除拷贝构造函数</span></span><br><span class="line">    <span class="built_in">MysqlConnectionPool</span>(<span class="keyword">const</span> MysqlConnectionPool &amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除赋值运算符</span></span><br><span class="line">    MysqlConnectionPool &amp;<span class="keyword">operator</span>=(<span class="keyword">const</span> MysqlConnectionPool &amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载配置文件</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">loadConfigFile</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生产 MySQL 连接</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">produceConnection</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 扫描多余的空闲连接，并释放连接</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scanIdleConnection</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 单例对象</span></span><br><span class="line">    <span class="keyword">static</span> MysqlConnectionPool *INSTANCE;</span><br><span class="line"></span><br><span class="line">    string _host;             <span class="comment">// MySQL 连接地址</span></span><br><span class="line">    string _username;         <span class="comment">// MySQL 用户名</span></span><br><span class="line">    string _password;         <span class="comment">// MySQL 密码</span></span><br><span class="line">    string _dbname;           <span class="comment">// MySQL 数据库</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> _initSize;            <span class="comment">// 初始连接数</span></span><br><span class="line">    <span class="keyword">int</span> _maxSize;             <span class="comment">// 最大连接数</span></span><br><span class="line">    <span class="keyword">int</span> _maxIdleTime;         <span class="comment">// 最大空闲时间（单位秒）</span></span><br><span class="line">    <span class="keyword">int</span> _connectionTimeout;   <span class="comment">// 连接超时时间（单位毫秒）</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">atomic_int</span> _connectionCount;                 <span class="comment">// MySQL 连接的总数量</span></span><br><span class="line">    queue&lt;MysqlConnection *&gt; _connectionQueue;   <span class="comment">// 存储 MySQL 连接的队列</span></span><br><span class="line">    mutex _queueMutex;                           <span class="comment">// 维护 MySQL 连接队列线程安全的互斥锁</span></span><br><span class="line">    condition_variable _cv;                      <span class="comment">// 条件变量，用于连接生产者线程和连接消费者线程之间的通信</span></span><br><span class="line">    <span class="keyword">atomic_bool</span> _closed;                         <span class="comment">// 连接池是否已关闭</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><h3 id="连接池的-C-源文件"><a href="#连接池的-C-源文件" class="headerlink" title="连接池的 C++ 源文件"></a>连接池的 C++ 源文件</h3><ul><li><code>MysqlConnection.cpp</code></li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"MysqlConnection.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造函数</span></span><br><span class="line">MysqlConnection::<span class="built_in">MysqlConnection</span>() {</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 析构函数</span></span><br><span class="line">MysqlConnection::~<span class="built_in">MysqlConnection</span>() {</span><br><span class="line">    <span class="comment">// 关闭数据连接</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;_connection &amp;&amp; !<span class="keyword">this</span>-&gt;_connection-&gt;<span class="built_in">isClosed</span>()) {</span><br><span class="line">        <span class="keyword">this</span>-&gt;_connection-&gt;<span class="built_in">close</span>();</span><br><span class="line">        <span class="keyword">this</span>-&gt;_connection = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="comment">// LOG("# DE<span class="doctag">BUG:</span> %s\n", "Closed mysql connection");</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于执行任何 SQL 语句，返回一个 bool 值，表明执行该 SQL 语句是否返回了 ResultSet</span></span><br><span class="line"><span class="comment">// 如果执行后第一个结果是 ResultSet，则返回 true，否则返回 false</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">MysqlConnection::execute</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *sql)</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;_connection) {</span><br><span class="line">            <span class="function">unique_ptr&lt;Statement&gt; <span class="title">statement</span><span class="params">(<span class="keyword">this</span>-&gt;_connection-&gt;createStatement())</span></span>;</span><br><span class="line">            <span class="keyword">if</span> (statement) {</span><br><span class="line">                <span class="keyword">return</span> statement-&gt;<span class="built_in">execute</span>(sql);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in"><span class="keyword">catch</span></span> (SQLException &amp;e) {</span><br><span class="line">        <span class="built_in">LOG</span>(<span class="string">"# ERR: SQLException in %s(%s) on line %d \n"</span>, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">        <span class="built_in">LOG</span>(<span class="string">"# ERR: MySQL Error Code %d\n"</span>, e.<span class="built_in">getErrorCode</span>());</span><br><span class="line">        <span class="built_in">LOG</span>(<span class="string">"# ERR: %s\n"</span>, e.<span class="built_in">what</span>());</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于执行 INSERT、UPDATE 或 DELETE 语句以及 SQL DDL（数据定义语言）语句，例如 CREATE TABLE 和 DROP TABLE</span></span><br><span class="line"><span class="comment">// 函数的返回值是一个整数，指示受影响的行数，对于 CREATE TABLE 或 DROP TABLE 等不操作行的语句，返回值总为零</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MysqlConnection::executeUpdate</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *sql)</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;_connection) {</span><br><span class="line">            <span class="function">unique_ptr&lt;Statement&gt; <span class="title">statement</span><span class="params">(<span class="keyword">this</span>-&gt;_connection-&gt;createStatement())</span></span>;</span><br><span class="line">            <span class="keyword">if</span> (statement) {</span><br><span class="line">                <span class="keyword">return</span> statement-&gt;<span class="built_in">executeUpdate</span>(sql);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in"><span class="keyword">catch</span></span> (SQLException &amp;e) {</span><br><span class="line">        <span class="built_in">LOG</span>(<span class="string">"# ERR: SQLException in %s(%s) on line %d \n"</span>, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">        <span class="built_in">LOG</span>(<span class="string">"# ERR: MySQL Error Code %d\n"</span>, e.<span class="built_in">getErrorCode</span>());</span><br><span class="line">        <span class="built_in">LOG</span>(<span class="string">"# ERR: %s\n"</span>, e.<span class="built_in">what</span>());</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基于 SQL 的预编译机制，执行查询单个结果集（ResultSet）的 SQL 语句，例如 SELECT 语句</span></span><br><span class="line"><span class="function">unique_ptr&lt;ResultSet&gt; <span class="title">MysqlConnection::query</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *sql, <span class="keyword">const</span> vector&lt;string&gt; parameters)</span> </span>{</span><br><span class="line">    unique_ptr&lt;ResultSet&gt; resultSet = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;_connection) {</span><br><span class="line">            <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">            <span class="function">unique_ptr&lt;PreparedStatement&gt; <span class="title">statement</span><span class="params">(<span class="keyword">this</span>-&gt;_connection-&gt;prepareStatement(sql))</span></span>;</span><br><span class="line">            <span class="keyword">if</span> (statement) {</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">auto</span> iterator = parameters.<span class="built_in">cbegin</span>(); iterator != parameters.<span class="built_in">cend</span>(); iterator++) {</span><br><span class="line">                    index++;</span><br><span class="line">                    statement-&gt;<span class="built_in">setString</span>(index, (*iterator).<span class="built_in">c_str</span>());</span><br><span class="line">                }</span><br><span class="line">                resultSet.<span class="built_in">reset</span>(statement-&gt;<span class="built_in">executeQuery</span>());</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in"><span class="keyword">catch</span></span> (SQLException &amp;e) {</span><br><span class="line">        <span class="built_in">LOG</span>(<span class="string">"# ERR: SQLException in %s(%s) on line %d \n"</span>, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">        <span class="built_in">LOG</span>(<span class="string">"# ERR: MySQL Error Code %d\n"</span>, e.<span class="built_in">getErrorCode</span>());</span><br><span class="line">        <span class="built_in">LOG</span>(<span class="string">"# ERR: %s\n"</span>, e.<span class="built_in">what</span>());</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> resultSet;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接 MySQL 数据库</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">MysqlConnection::connect</span><span class="params">(<span class="keyword">const</span> string host, <span class="keyword">const</span> string username, <span class="keyword">const</span> string password, <span class="keyword">const</span> string dbname)</span> </span>{</span><br><span class="line">    <span class="comment">// 初始化MySQL的连接信息</span></span><br><span class="line">    <span class="keyword">this</span>-&gt;_host = <span class="string">"tcp://"</span> + host;</span><br><span class="line">    <span class="keyword">this</span>-&gt;_username = username;</span><br><span class="line">    <span class="keyword">this</span>-&gt;_password = password;</span><br><span class="line">    <span class="keyword">this</span>-&gt;_dbname = dbname;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 获取数据库驱动，返回的是单例对象，由 MySQL Connector/C++ 管理，不需要手动释放资源（delete）</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;_driver = <span class="built_in">get_driver_instance</span>();</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>-&gt;_driver) {</span><br><span class="line">            <span class="built_in">LOG</span>(<span class="string">"# ERR: %s\n"</span>, <span class="string">"Failed to load mysql _driver"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 连接MySQL实例</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;_connection = _driver-&gt;<span class="built_in">connect</span>(<span class="keyword">this</span>-&gt;_host.<span class="built_in">c_str</span>(), <span class="keyword">this</span>-&gt;_username.<span class="built_in">c_str</span>(), <span class="keyword">this</span>-&gt;_password.<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>-&gt;_connection) {</span><br><span class="line">            <span class="built_in">LOG</span>(<span class="string">"# ERR: %s\n"</span>, <span class="string">"Failed to connect mysql server"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 设置默认数据库</span></span><br><span class="line">            <span class="keyword">this</span>-&gt;_connection-&gt;<span class="built_in">setSchema</span>(<span class="keyword">this</span>-&gt;_dbname.<span class="built_in">c_str</span>());</span><br><span class="line">            <span class="comment">// LOG("# DE<span class="doctag">BUG:</span> %s\n", "Inited mysql connection");</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in"><span class="keyword">catch</span></span> (SQLException &amp;e) {</span><br><span class="line">        <span class="built_in">LOG</span>(<span class="string">"# ERR: SQLException in %s(%s) on line %d \n"</span>, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">        <span class="built_in">LOG</span>(<span class="string">"# ERR: MySQL Error Code %d\n"</span>, e.<span class="built_in">getErrorCode</span>());</span><br><span class="line">        <span class="built_in">LOG</span>(<span class="string">"# ERR: %s\n"</span>, e.<span class="built_in">what</span>());</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 刷新连接进入空闲状态后的起始存活时间点</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MysqlConnection::refreshAliveTime</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>-&gt;_aliveTime = chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取连接的空闲存活时间（单位毫秒）</span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">MysqlConnection::getAliveTime</span><span class="params">()</span> <span class="keyword">const</span> </span>{</span><br><span class="line">    chrono::milliseconds active_timestamp_ms = chrono::duration_cast&lt;chrono::milliseconds&gt;(<span class="keyword">this</span>-&gt;_aliveTime.<span class="built_in">time_since_epoch</span>());</span><br><span class="line">    chrono::milliseconds now_timestamp_ms = chrono::duration_cast&lt;chrono::milliseconds&gt;(chrono::system_clock::<span class="built_in">now</span>().<span class="built_in">time_since_epoch</span>());</span><br><span class="line">    <span class="keyword">return</span> now_timestamp_ms.<span class="built_in">count</span>() - active_timestamp_ms.<span class="built_in">count</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>MysqlConnectionPool.cpp</code></li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;boost/filesystem.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"MysqlConnectionPool.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> fs = boost::filesystem;</span><br><span class="line"></span><br><span class="line">MysqlConnectionPool::<span class="built_in">MysqlConnectionPool</span>() : _connectionCount(<span class="number">0</span>), _closed(<span class="literal">false</span>) {</span><br><span class="line">    <span class="comment">// 加载配置文件</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">loadConfigFile</span>()) {</span><br><span class="line">        <span class="built_in">LOG</span>(<span class="string">"# ERR: %s\n"</span>, <span class="string">"Failed to load config file mysql.ini"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建初始化数量的 MySQL 连接</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>-&gt;_initSize; i++) {</span><br><span class="line">        MysqlConnection *connection = <span class="keyword">new</span> <span class="built_in">MysqlConnection</span>();</span><br><span class="line">        <span class="comment">// 连接数据库</span></span><br><span class="line">        <span class="keyword">bool</span> connected = connection-&gt;<span class="built_in">connect</span>(<span class="keyword">this</span>-&gt;_host, <span class="keyword">this</span>-&gt;_username, <span class="keyword">this</span>-&gt;_password, <span class="keyword">this</span>-&gt;_dbname);</span><br><span class="line">        <span class="comment">// 判断是否连接成功</span></span><br><span class="line">        <span class="keyword">if</span> (connected) {</span><br><span class="line">            <span class="comment">// 刷新连接进入空闲状态后的起始存活时间点</span></span><br><span class="line">            connection-&gt;<span class="built_in">refreshAliveTime</span>();</span><br><span class="line">            <span class="comment">// 入队操作</span></span><br><span class="line">            <span class="keyword">this</span>-&gt;_connectionQueue.<span class="built_in">push</span>(connection);</span><br><span class="line">            <span class="comment">// 计数器加一</span></span><br><span class="line">            <span class="keyword">this</span>-&gt;_connectionCount++;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 后台启动 MySQL 连接的生产者线程</span></span><br><span class="line">    <span class="function">thread <span class="title">produce</span><span class="params">(bind(&amp;MysqlConnectionPool::produceConnection, <span class="keyword">this</span>))</span></span>;</span><br><span class="line">    produce.<span class="built_in">detach</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 后台启动一个扫描线程，定时扫描多余的空闲连接，并释放连接</span></span><br><span class="line">    <span class="function">thread <span class="title">scan</span><span class="params">(bind(&amp;MysqlConnectionPool::scanIdleConnection, <span class="keyword">this</span>))</span></span>;</span><br><span class="line">    scan.<span class="built_in">detach</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">MysqlConnectionPool::~<span class="built_in">MysqlConnectionPool</span>() {</span><br><span class="line">    <span class="comment">// 关闭连接池，释放所有连接</span></span><br><span class="line">    <span class="keyword">this</span>-&gt;<span class="built_in">close</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function">MysqlConnectionPool *<span class="title">MysqlConnectionPool::getInstance</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> INSTANCE;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">MysqlConnectionPool::loadConfigFile</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// 配置文件的路径</span></span><br><span class="line">    fs::path configPath = fs::<span class="built_in">current_path</span>().<span class="built_in">concat</span>(<span class="string">"/mysql.ini"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取配置文件</span></span><br><span class="line">    FILE *file = <span class="built_in">fopen</span>(configPath.<span class="built_in">c_str</span>(), <span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">nullptr</span>) {</span><br><span class="line">        <span class="built_in">LOG</span>(<span class="string">"# ERR: %s %s\n"</span>, configPath.<span class="built_in">c_str</span>(), <span class="string">"file is not exist"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="built_in">LOG</span>(<span class="string">"======== mysql.ini ========\n"</span>)</span><br><span class="line">    <span class="keyword">while</span> (!<span class="built_in">feof</span>(file)) {</span><br><span class="line">        <span class="keyword">char</span> buffer[<span class="number">1024</span>] = {<span class="number">0</span>};</span><br><span class="line">        <span class="built_in">fgets</span>(buffer, <span class="number">1024</span>, file);</span><br><span class="line">        string line = buffer;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 配置格式：username=root</span></span><br><span class="line">        <span class="keyword">int</span> index = line.<span class="built_in">find</span>(<span class="string">'='</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 无效配置项</span></span><br><span class="line">        <span class="keyword">if</span> (index == <span class="number">-1</span>) {</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> endIndex = line.<span class="built_in">find</span>(<span class="string">'\n'</span>, index);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理配置项</span></span><br><span class="line">        string key = line.<span class="built_in">substr</span>(<span class="number">0</span>, index);</span><br><span class="line">        string value = line.<span class="built_in">substr</span>(index + <span class="number">1</span>, endIndex - index - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="string">"host"</span>) {</span><br><span class="line">            <span class="keyword">this</span>-&gt;_host = value;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (key == <span class="string">"username"</span>) {</span><br><span class="line">            <span class="keyword">this</span>-&gt;_username = value;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (key == <span class="string">"password"</span>) {</span><br><span class="line">            <span class="keyword">this</span>-&gt;_password = value;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (key == <span class="string">"dbname"</span>) {</span><br><span class="line">            <span class="keyword">this</span>-&gt;_dbname = value;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (key == <span class="string">"initSize"</span>) {</span><br><span class="line">            <span class="keyword">this</span>-&gt;_initSize = <span class="built_in">stoi</span>(value);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (key == <span class="string">"maxSize"</span>) {</span><br><span class="line">            <span class="keyword">this</span>-&gt;_maxSize = <span class="built_in">stoi</span>(value);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (key == <span class="string">"maxIdleTime"</span>) {</span><br><span class="line">            <span class="keyword">this</span>-&gt;_maxIdleTime = <span class="built_in">stoi</span>(value);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (key == <span class="string">"connectionTimeout"</span>) {</span><br><span class="line">            <span class="keyword">this</span>-&gt;_connectionTimeout = <span class="built_in">stoi</span>(value);</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">LOG</span>(<span class="string">"%s=%s\n"</span>, key.<span class="built_in">c_str</span>(), value.<span class="built_in">c_str</span>());</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">LOG</span>(<span class="string">"======== mysql.ini ========\n\n"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fclose</span>(file);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MysqlConnectionPool::close</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// 判断连接池是否已关闭</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;_closed) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置关闭状态</span></span><br><span class="line">    <span class="keyword">this</span>-&gt;_closed = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取互斥锁</span></span><br><span class="line">    <span class="function">unique_lock&lt;mutex&gt; <span class="title">lock</span><span class="params">(<span class="keyword">this</span>-&gt;_queueMutex)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!(<span class="keyword">this</span>-&gt;_connectionQueue.<span class="built_in">empty</span>())) {</span><br><span class="line">        <span class="comment">// 获取队头的连接</span></span><br><span class="line">        MysqlConnection *phead = <span class="keyword">this</span>-&gt;_connectionQueue.<span class="built_in">front</span>();</span><br><span class="line">        <span class="comment">// 出队操作</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;_connectionQueue.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="comment">// 计数器减一</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;_connectionCount--;</span><br><span class="line">        <span class="comment">// 释放连接占用的内存空间</span></span><br><span class="line">        <span class="keyword">delete</span> phead;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">MysqlConnectionPool::isClosed</span><span class="params">()</span> <span class="keyword">const</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>-&gt;_closed;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MysqlConnectionPool::getSize</span><span class="params">()</span> <span class="keyword">const</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>-&gt;_connectionCount;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function">shared_ptr&lt;MysqlConnection&gt; <span class="title">MysqlConnectionPool::getConnection</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;_closed) {</span><br><span class="line">        <span class="built_in">LOG</span>(<span class="string">"# ERR: %s\n"</span>, <span class="string">"Connection pool has closed"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取互斥锁</span></span><br><span class="line">    <span class="function">unique_lock&lt;mutex&gt; <span class="title">lock</span><span class="params">(<span class="keyword">this</span>-&gt;_queueMutex)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 While 循环来避免线程虚假唤醒</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">this</span>-&gt;_connectionQueue.<span class="built_in">empty</span>()) {</span><br><span class="line">        <span class="comment">// 如果连接队列为空，则等待指定的时间</span></span><br><span class="line">        cv_status status = <span class="keyword">this</span>-&gt;_cv.<span class="built_in">wait_for</span>(lock, chrono::<span class="built_in">milliseconds</span>(<span class="keyword">this</span>-&gt;_connectionTimeout));</span><br><span class="line">        <span class="keyword">if</span> (cv_status::timeout == status) {</span><br><span class="line">            <span class="comment">// 如果等待超时，再次判断连接队列是否为空</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;_connectionQueue.<span class="built_in">empty</span>()) {</span><br><span class="line">                <span class="built_in">LOG</span>(<span class="string">"# ERR: %s\n"</span>, <span class="string">"Failed to get connection, queue is empty"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取队头的连接，并返回智能指针，同时自定义智能指针释放资源的方式，将连接归还到队列中</span></span><br><span class="line">    <span class="function">shared_ptr&lt;MysqlConnection&gt; <span class="title">sp</span><span class="params">(<span class="keyword">this</span>-&gt;_connectionQueue.front(), [&amp;](MysqlConnection *pcon) -&gt; <span class="keyword">void</span> {</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="comment">// 获取互斥锁</span></span></span></span><br><span class="line"><span class="params"><span class="function">        unique_lock&lt;mutex&gt; lock(<span class="keyword">this</span>-&gt;_queueMutex);</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="comment">// 刷新连接进入空闲状态后的起始存活时间点</span></span></span></span><br><span class="line"><span class="params"><span class="function">        pcon-&gt;refreshAliveTime();</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="comment">// 入队操作（将连接归还到队列中）</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">this</span>-&gt;_connectionQueue.push(pcon);</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="comment">// 计数器加一</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">this</span>-&gt;_connectionCount++;</span></span></span><br><span class="line"><span class="params"><span class="function">    })</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 出队操作</span></span><br><span class="line">    <span class="keyword">this</span>-&gt;_connectionQueue.<span class="built_in">pop</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计数器减一</span></span><br><span class="line">    <span class="keyword">this</span>-&gt;_connectionCount--;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;_connectionQueue.<span class="built_in">empty</span>()) {</span><br><span class="line">        <span class="comment">// 如果连接队列为空，则通知生产线程生产连接</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;_cv.<span class="built_in">notify_all</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MysqlConnectionPool::produceConnection</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">while</span> (!<span class="keyword">this</span>-&gt;_closed) {</span><br><span class="line">        <span class="comment">// 获取互斥锁</span></span><br><span class="line">        <span class="function">unique_lock&lt;mutex&gt; <span class="title">lock</span><span class="params">(<span class="keyword">this</span>-&gt;_queueMutex)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用 While 循环来避免线程虚假唤醒</span></span><br><span class="line">        <span class="keyword">while</span> (!(<span class="keyword">this</span>-&gt;_connectionQueue.<span class="built_in">empty</span>())) {</span><br><span class="line">            <span class="comment">// 如果连接队列不为空，生产者线程进入等待状态</span></span><br><span class="line">            <span class="keyword">this</span>-&gt;_cv.<span class="built_in">wait</span>(lock);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当连接数量没有达到上限，继续创建新的连接</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;_connectionCount &lt; <span class="keyword">this</span>-&gt;_maxSize) {</span><br><span class="line">            MysqlConnection *connection = <span class="keyword">new</span> <span class="built_in">MysqlConnection</span>();</span><br><span class="line">            <span class="comment">// 连接数据库</span></span><br><span class="line">            <span class="keyword">bool</span> connected = connection-&gt;<span class="built_in">connect</span>(<span class="keyword">this</span>-&gt;_host, <span class="keyword">this</span>-&gt;_username, <span class="keyword">this</span>-&gt;_password, <span class="keyword">this</span>-&gt;_dbname);</span><br><span class="line">            <span class="comment">// 判断是否连接成功</span></span><br><span class="line">            <span class="keyword">if</span> (connected) {</span><br><span class="line">                <span class="comment">// 刷新连接进入空闲状态后的起始存活时间点</span></span><br><span class="line">                connection-&gt;<span class="built_in">refreshAliveTime</span>();</span><br><span class="line">                <span class="comment">// 入队操作</span></span><br><span class="line">                <span class="keyword">this</span>-&gt;_connectionQueue.<span class="built_in">push</span>(connection);</span><br><span class="line">                <span class="comment">// 计数器加一</span></span><br><span class="line">                <span class="keyword">this</span>-&gt;_connectionCount++;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通知消费者线程可以消费连接了</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;_cv.<span class="built_in">notify_all</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MysqlConnectionPool::scanIdleConnection</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">while</span> (!<span class="keyword">this</span>-&gt;_closed) {</span><br><span class="line">        <span class="comment">// 模拟定时扫描连接的效果</span></span><br><span class="line">        this_thread::<span class="built_in">sleep_for</span>(chrono::<span class="built_in">seconds</span>(<span class="keyword">this</span>-&gt;_maxIdleTime));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取互斥锁</span></span><br><span class="line">        <span class="function">unique_lock&lt;mutex&gt; <span class="title">lock</span><span class="params">(<span class="keyword">this</span>-&gt;_queueMutex)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用 While 循环来避免线程虚假唤醒</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">this</span>-&gt;_connectionCount &lt;= <span class="keyword">this</span>-&gt;_initSize) {</span><br><span class="line">            <span class="comment">// 如果当前的连接总数量小于等于初始连接数量，扫描线程进入等待状态</span></span><br><span class="line">            <span class="keyword">this</span>-&gt;_cv.<span class="built_in">wait</span>(lock);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断当前的连接总数量是否大于初始连接数量</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">this</span>-&gt;_connectionCount &gt; <span class="keyword">this</span>-&gt;_initSize) {</span><br><span class="line">            <span class="comment">// 扫描队头的连接是否超过最大空闲时间</span></span><br><span class="line">            MysqlConnection *phead = <span class="keyword">this</span>-&gt;_connectionQueue.<span class="built_in">front</span>();</span><br><span class="line">            <span class="keyword">if</span> (phead-&gt;<span class="built_in">getAliveTime</span>() &gt;= <span class="keyword">this</span>-&gt;_maxIdleTime) {</span><br><span class="line">                <span class="comment">// 出队操作</span></span><br><span class="line">                <span class="keyword">this</span>-&gt;_connectionQueue.<span class="built_in">pop</span>();</span><br><span class="line">                <span class="comment">// 计数器减一</span></span><br><span class="line">                <span class="keyword">this</span>-&gt;_connectionCount--;</span><br><span class="line">                <span class="comment">// 释放连接占用的内存空间</span></span><br><span class="line">                <span class="keyword">delete</span> phead;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// 如果队头的连接没有超过最大空闲时间，那么其他连接肯定也没有超过</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化单例对象</span></span><br><span class="line">MysqlConnectionPool *MysqlConnectionPool::INSTANCE = <span class="keyword">new</span> <span class="built_in">MysqlConnectionPool</span>();</span><br></pre></td></tr></tbody></table></figure><h2 id="连接池的代码测试"><a href="#连接池的代码测试" class="headerlink" title="连接池的代码测试"></a>连接池的代码测试</h2><div class="admonition note"><p class="admonition-title">提示</p><p>本文的所有 C++ 代码都已经在 Linux 平台下编译并测试通过（基于 Clion 与 G++ 编译器），由于笔者的技术水平有限，暂时无法保证代码没有潜在的 Bug，因此所有 C++ 代码仅供学习参考。</p></div><ul><li>用于创建测试数据库的 SQL 语句</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- 创建数据库</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> DATABASE IF <span class="keyword">EXISTS</span> `cxx_study`;</span><br><span class="line"><span class="keyword">CREATE</span> DATABASE `cxx_study` <span class="keyword">DEFAULT</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> UTF8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- 切换数据库</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line">USE `cxx_study`;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- 创建数据库表</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `properties`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `properties` (</span><br><span class="line">  `ID` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `KEY` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `<span class="keyword">VALUE</span>` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `REMARK` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`ID`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">27</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>UTF8 ROW_FORMAT<span class="operator">=</span><span class="keyword">DYNAMIC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- 往数据库表插入数据</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `properties` (`KEY`, `<span class="keyword">VALUE</span>`, `REMARK`) <span class="keyword">VALUES</span> (<span class="string">'test_limit_number'</span>, <span class="string">'430'</span>, <span class="string">'Limit Number'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `properties` (`KEY`, `<span class="keyword">VALUE</span>`, `REMARK`) <span class="keyword">VALUES</span> (<span class="string">'test_limit_balance'</span>, <span class="string">'929.32'</span>, <span class="string">'Limit Balance'</span>);</span><br></pre></td></tr></tbody></table></figure><ul><li>用于测试的 C++ 代码（<code>test.cpp</code>）</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"MysqlConnection.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"MysqlConnectionPool.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testQuerySingleThread</span><span class="params">()</span> </span>{</span><br><span class="line">    MysqlConnection *connection = <span class="keyword">new</span> <span class="built_in">MysqlConnection</span>();</span><br><span class="line">    connection-&gt;<span class="built_in">connect</span>(<span class="string">"192.168.56.112:3307"</span>, <span class="string">"root"</span>, <span class="string">"123456"</span>, <span class="string">"cxx_study"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 单个线程查询记录</span></span><br><span class="line">    <span class="keyword">const</span> string querySql = <span class="string">"select * from properties where `KEY` = ?"</span>;</span><br><span class="line">    unique_ptr&lt;ResultSet&gt; result = connection-&gt;<span class="built_in">query</span>(querySql.<span class="built_in">c_str</span>(), {<span class="string">"test_limit_number"</span>});</span><br><span class="line">    <span class="keyword">if</span> (result) {</span><br><span class="line">        cout &lt;&lt; <span class="string">"Query: "</span> &lt;&lt; querySql &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">while</span> (result-&gt;<span class="built_in">next</span>()) {</span><br><span class="line">            cout &lt;&lt; result-&gt;<span class="built_in">getInt</span>(<span class="string">"ID"</span>) &lt;&lt; <span class="string">" | "</span>;</span><br><span class="line">            cout &lt;&lt; result-&gt;<span class="built_in">getString</span>(<span class="string">"KEY"</span>).<span class="built_in">c_str</span>() &lt;&lt; <span class="string">" | "</span>;</span><br><span class="line">            cout &lt;&lt; result-&gt;<span class="built_in">getString</span>(<span class="string">"VALUE"</span>).<span class="built_in">c_str</span>() &lt;&lt; <span class="string">" | "</span>;</span><br><span class="line">            cout &lt;&lt; result-&gt;<span class="built_in">getString</span>(<span class="string">"REMARK"</span>).<span class="built_in">c_str</span>() &lt;&lt; <span class="string">" | "</span>;</span><br><span class="line">            cout &lt;&lt; endl;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span> connection;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testConnectionPoolSingleThread</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">const</span> string insertSql = <span class="string">"INSERT INTO `properties` (`KEY`, `VALUE`, `REMARK`) VALUES ('test_limit_price', '30.5', 'Limit Price')"</span>;</span><br><span class="line">    MysqlConnectionPool *pool = MysqlConnectionPool::<span class="built_in">getInstance</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> start_time = chrono::high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 单个线程插入多条记录</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1500</span>; i++) {</span><br><span class="line">        shared_ptr&lt;MysqlConnection&gt; connection = pool-&gt;<span class="built_in">getConnection</span>();</span><br><span class="line">        connection-&gt;<span class="built_in">executeUpdate</span>(insertSql.<span class="built_in">c_str</span>());</span><br><span class="line">        cout &lt;&lt; <span class="string">"Insert "</span> &lt;&lt; i &lt;&lt; <span class="string">" record, current pool size: "</span> &lt;&lt; pool-&gt;<span class="built_in">getSize</span>() &lt;&lt; endl;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> end_time = chrono::high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 统计执行耗时</span></span><br><span class="line">    chrono::duration&lt;<span class="keyword">double</span>, milli&gt; elapsed_time = end_time - start_time;</span><br><span class="line">    cout &lt;&lt; <span class="string">"Total Times: "</span> &lt;&lt; elapsed_time.<span class="built_in">count</span>() &lt;&lt; <span class="string">"ms"</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span> pool;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testConnectionPoolMultiThread</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> num_threads = <span class="number">15</span>;</span><br><span class="line">    thread threads[num_threads];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> string insertSql = <span class="string">"INSERT INTO `properties` (`KEY`, `VALUE`, `REMARK`) VALUES ('test_limit_price', '30.5', 'Limit Price')"</span>;</span><br><span class="line">    MysqlConnectionPool *pool = MysqlConnectionPool::<span class="built_in">getInstance</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> start_time = chrono::high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 多个线程插入多条记录</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num_threads; i++) {</span><br><span class="line">        threads[i] = <span class="built_in">thread</span>([&amp;, i]() {</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> n = <span class="number">0</span>; n &lt; <span class="number">100</span>; n++) {</span><br><span class="line">                shared_ptr&lt;MysqlConnection&gt; connection = pool-&gt;<span class="built_in">getConnection</span>();</span><br><span class="line">                connection-&gt;<span class="built_in">executeUpdate</span>(insertSql.<span class="built_in">c_str</span>());</span><br><span class="line">                cout &lt;&lt; <span class="string">"Thread "</span> &lt;&lt; i &lt;&lt; <span class="string">", current pool size: "</span> &lt;&lt; pool-&gt;<span class="built_in">getSize</span>() &lt;&lt; endl;</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待所有线程完成</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num_threads; ++i) {</span><br><span class="line">        threads[i].<span class="built_in">join</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> end_time = chrono::high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 统计执行耗时</span></span><br><span class="line">    chrono::duration&lt;<span class="keyword">double</span>, milli&gt; elapsed_time = end_time - start_time;</span><br><span class="line">    cout &lt;&lt; <span class="string">"Total Times: "</span> &lt;&lt; elapsed_time.<span class="built_in">count</span>() &lt;&lt; <span class="string">"ms"</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待一段时间，触发数据库连接池回收空闲连接</span></span><br><span class="line">    cout &lt;&lt; <span class="string">"Waiting to collect idle connection..."</span> &lt;&lt; endl;</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">15</span>);</span><br><span class="line">    cout &lt;&lt; <span class="string">"Pool final size: "</span> &lt;&lt; pool-&gt;<span class="built_in">getSize</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span> pool;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// 不使用数据库连接池，单个线程查询记录</span></span><br><span class="line">    <span class="comment">// testQuerySingleThread();</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用数据库连接池，单个线程插入多条记录</span></span><br><span class="line">    <span class="comment">// testConnectionPoolSingleThread();</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用数据库连接池，多个线程插入多条记录</span></span><br><span class="line">    <span class="built_in">testConnectionPoolMultiThread</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阻塞主线程，直到用户按下任意键才结束程序</span></span><br><span class="line">    <span class="keyword">char</span> c = <span class="built_in">getchar</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>编译测试代码，生成并运行可执行测试程序</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入项目的根目录</span></span><br><span class="line"><span class="built_in">cd</span> c++-project-db-connection-pool</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译构建生成可执行测试程序</span></span><br><span class="line">cmake -S . -B build &amp;&amp; cmake --build build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行可执行测试程序</span></span><br><span class="line">./bin/db_connection_pool_test</span><br></pre></td></tr></tbody></table></figure><h2 id="连接池的调试技巧"><a href="#连接池的调试技巧" class="headerlink" title="连接池的调试技巧"></a>连接池的调试技巧</h2><p>在开发数据库连接池项目的时候，会经常出现问题，也就是 MySQL API 调用出错，提示 Insert、Delete、Update 等操作执行失败，或者连接 MySQL Server 失败等，很多人不知道遇到这个问题该怎么办？</p><h3 id="MySQL-C-API-调试"><a href="#MySQL-C-API-调试" class="headerlink" title="MySQL C API 调试"></a>MySQL C API 调试</h3><p>当使用的是 <a href="/posts/c942e1de.html#MySQL-C-API-%E4%BB%8B%E7%BB%8D">MySQL C API</a>（Connector/C）库，可以使用以下两个函数打印出错时的提示信息：</p><table><thead><tr><th>函数</th><th>说明</th></tr></thead><tbody><tr><td><code>int mysql_errno(MYSQL *)</code></td><td>返回上次调用的 MySQL 函数的错误编号。</td></tr><tr><td><code>const char* mysql_error(MYSQL *)</code></td><td>返回上次调用的 MySQL 函数的错误消息。</td></tr></tbody></table><p>无论是 Insert 错误还是其它错误，都可以在代码上通过添加 <code>mysql_error</code> 函数打印错误提示信息（如下所示）。一般通过查看提示就可以知道是什么错误了，例如权限问题，但大部分都是细节错误，比如字段不对、类型不对、表名不对等。</p><p><img data-src="../../../asset/2025/02/cxx-mysql-debug.png"></p><h3 id="MySQL-Connector-C-调试"><a href="#MySQL-Connector-C-调试" class="headerlink" title="MySQL Connector/C++ 调试"></a>MySQL Connector/C++ 调试</h3><p>当使用的是 <a href="/posts/c942e1de.html#MySQL-Connector-C-%E4%BB%8B%E7%BB%8D">MySQL Connector/C++</a>（JDBC-Style API）库，可以通过异常来获取错误信息：</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> {</span><br><span class="line">    <span class="function">unique_ptr&lt;sql::Connection&gt; <span class="title">conn</span><span class="params">(driver-&gt;connect(<span class="string">"tcp://127.0.0.1:3306"</span>, <span class="string">"user"</span>, <span class="string">"password"</span>))</span></span>;</span><br><span class="line">    conn-&gt;<span class="built_in">setSchema</span>(<span class="string">"test_db"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function">unique_ptr&lt;sql::Statement&gt; <span class="title">stmt</span><span class="params">(conn-&gt;createStatement())</span></span>;</span><br><span class="line">    stmt-&gt;<span class="built_in">execute</span>(<span class="string">"INVALID SQL STATEMENT"</span>); <span class="comment">// 故意执行错误的 SQL</span></span><br><span class="line">} <span class="built_in"><span class="keyword">catch</span></span> (sql::SQLException &amp;e) {</span><br><span class="line">    cout &lt;&lt; <span class="string">"Error Code: "</span> &lt;&lt; e.<span class="built_in">getErrorCode</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">"SQL State: "</span> &lt;&lt; e.<span class="built_in">getSQLState</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">"Message: "</span> &lt;&lt; e.<span class="built_in">what</span>() &lt;&lt; endl;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>通过 <code>e.getErrorCode()</code> 获取错误码，<code>e.getSQLState()</code> 获取 SQL 状态码，而 <code>e.what()</code> 获取详细的错误信息。</p><div class="admonition note"><p class="admonition-title">提示</p><p>如果使用的是 MySQL X DevAPI，错误提示信息同样可以通过异常处理来获取得到。</p></div><h2 id="MySQL-的参数调整"><a href="#MySQL-的参数调整" class="headerlink" title="MySQL 的参数调整"></a>MySQL 的参数调整</h2><p>以下命令可以查看和设置 MySQL Server 所支持的最大连接数，当超过 <code>max_connections</code> 数量的连接，MySQL Server 会直接拒绝。因此，在使用数据库连接池增加 MySQL 连接数量的时候，MySQL Server 的 <code>max_connections</code> 参数也要适当地进行调整，以适配数据库连接池的最大连接数（<code>maxSize</code>），否则会大大影响数据库连接池的运行效果。</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询MySQL的最大连接数</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">'max_connections'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 全局设置MySQL的最大连接数（立即生效，但数据库重启后失效）</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> max_connections <span class="operator">=</span> <span class="number">200</span>;</span><br></pre></td></tr></tbody></table></figure><h2 id="连接池的压力测试"><a href="#连接池的压力测试" class="headerlink" title="连接池的压力测试"></a>连接池的压力测试</h2><p>验证数据库的插入操作所花费的时间，第一次测试使用普通的数据库访问操作，第二次测试使用带连接池的数据库访问操作，对比两次操作同样数据量所花费的时间，性能压力测试结果如下：</p><table><thead><tr><th>数据量</th><th>未使用连接池所花费时间</th><th>使用连接池所花费时间</th></tr></thead><tbody><tr><td> 1000</td><td> 单线程：1891ms，四线程：497ms</td><td> 单线程：1079ms，四线程：408ms</td></tr><tr><td>5000</td><td> 单线程：10033ms，四线程：2361ms</td><td> 单线程: 5380ms，四线程：2041ms</td></tr><tr><td>10000</td><td> 单线程：19403ms，四线程：4589ms</td><td> 单线程：10522ms，四线程：4034ms</td></tr></tbody></table><h2 id="连接池的代码下载"><a href="#连接池的代码下载" class="headerlink" title="连接池的代码下载"></a>连接池的代码下载</h2><ul><li>数据库连接池项目的完整代码（包括 MySQL Connector/C++ 的头文件和动态链接库）可以从 <a target="_blank" rel="external nofollow" href="https://github.com/rqh656418510/c-cplusplus-study/tree/main/c%2B%2B-projects/c%2B%2B-project-db-connection-pool">这里</a> 下载得到，由于笔者的技术水平有限，暂时无法保证代码没有潜在的 Bug，因此所有 C++ 代码仅供学习参考。</li></ul><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="/posts/a2a7ad9b.html">C++ 多线程编程之一</a></li><li><a href="/posts/841eca80.html">Linux 系统编程之四多线程编程</a></li></ul><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/993ae2e0.html" title="基于 C++ 实现 MySQL 数据库连接池">https://www.techgrow.cn/posts/993ae2e0.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/" rel="tag"><i class="fa fa-tag"></i> Linux系统编程</a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag"><i class="fa fa-tag"></i> 数据库</a><a href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" rel="tag"><i class="fa fa-tag"></i> 并发编程</a><a href="/tags/C/" rel="tag"><i class="fa fa-tag"></i> C++</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/52e74a26.html" rel="prev" title="C++ 巩固基础之五"><i class="fa fa-angle-left"></i> C++ 巩固基础之五</a></div><div class="post-nav-item"> <a href="/posts/a4fe8225.html" rel="next" title="C++ 巩固基础之六">C++ 巩固基础之六<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">2.1m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">31:43</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/993ae2e0.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>