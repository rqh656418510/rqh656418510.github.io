<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","width":300,"display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍 Spring Cloud 的容器化，包括 Java 服务的 Docker 化。"><meta property="og:type" content="article"><meta property="og:title" content="SpringCloud 容器化"><meta property="og:url" content="https://www.techgrow.cn/posts/fe094f6c.html"><meta property="og:site_name" content="Clay 的技术博客"><meta property="og:description" content="本文主要介绍 Spring Cloud 的容器化，包括 Java 服务的 Docker 化。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/05/maven-docker-plugin.png"><meta property="article:published_time" content="2019-10-11T13:15:44.000Z"><meta property="article:modified_time" content="2019-10-11T13:15:44.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="微服务"><meta property="article:tag" content="容器化"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2020/05/maven-docker-plugin.png"><link rel="canonical" href="https://www.techgrow.cn/posts/fe094f6c.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/fe094f6c.html","path":"posts/fe094f6c.html","title":"SpringCloud 容器化"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>SpringCloud 容器化 | Clay 的技术博客</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn:9360"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术博客" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax>!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><script data-ad-client="ca-pub-4014850419768221" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/app/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt></div><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术博客</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-openplatform"><a href="https://open.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-boxes fa-fw"></i>开放平台</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn:9360/ui/login?lng=zh-cn" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Java-%E6%9C%8D%E5%8A%A1-Docker-%E5%8C%96"><span class="nav-text">Java 服务 Docker 化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F%E9%80%89%E6%8B%A9"><span class="nav-text">基础镜像选择</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DockerFile-%E7%BC%96%E5%86%99"><span class="nav-text">DockerFile 编写</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Alpine-glibc"><span class="nav-text">Alpine + glibc</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Alpine-glibc-JDK8"><span class="nav-text">Alpine + glibc + JDK8</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Alpine-glibc-JDK9"><span class="nav-text">Alpine + glibc + JDK9</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Alpine-glibc-JDK10"><span class="nav-text">Alpine + glibc + JDK10</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Alpine-glibc-JDK11"><span class="nav-text">Alpine + glibc + JDK11</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Maven-%E6%9E%84%E5%BB%BA%E4%B8%8E%E5%8F%91%E5%B8%83%E9%95%9C%E5%83%8F"><span class="nav-text">Maven 构建与发布镜像</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F%E7%9A%84-Maven-%E6%8F%92%E4%BB%B6"><span class="nav-text">构建镜像的 Maven 插件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Maven-%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F%E7%9A%84-DockFile"><span class="nav-text">Maven 构建镜像的 DockFile</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Maven-%E6%89%93%E5%8C%85%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F"><span class="nav-text">Maven 打包构建镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Maven-Push-%E9%95%9C%E5%83%8F"><span class="nav-text">Maven Push 镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Maven-%E8%BF%90%E8%A1%8C%E9%95%9C%E5%83%8F"><span class="nav-text">Maven 运行镜像</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JDK-8-%E7%9A%84-Docker-%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6%E6%94%AF%E6%8C%81"><span class="nav-text">JDK 8+ 的 Docker 资源限制支持</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#JDK-8-amp-amp-JDK-9"><span class="nav-text">JDK 8 &amp;&amp; JDK 9</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JDK-10"><span class="nav-text">JDK 10</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JDK-11"><span class="nav-text">JDK 11</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JDK-9-%E9%95%9C%E5%83%8F%E4%BC%98%E5%8C%96"><span class="nav-text">JDK 9+ 镜像优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Jlink-%E5%B7%A5%E5%85%B7"><span class="nav-text">Jlink 工具</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Jlink-%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="nav-text">Jlink 使用案例</span></a></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">341</span> <span class="site-state-item-name">文章</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags"><span class="site-state-item-count">40</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → &#x2F;sitemap.xml"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="external nofollow" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/fe094f6c.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术博客"><meta itemprop="description" content="专注于 Java、前端、移动端、微服务、分布式系统、数据库、系统架构、人工智能、大数据、云计算、物联网、虚拟化学习的技术博客。"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="SpringCloud 容器化 | Clay 的技术博客"><meta itemprop="description" content="本文主要介绍 Spring Cloud 的容器化，包括 Java 服务的 Docker 化。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> SpringCloud 容器化</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-10-11 21:15:44" itemprop="dateCreated datePublished" datetime="2019-10-11T21:15:44+08:00">2019-10-11</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/fe094f6c.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/fe094f6c.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>3.8k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>3 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><div id="readmore-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>容器化技术的出现标准化了服务的基础设施，统一了应用的打包分发、部署及操作系统相关类库等，解决了测试及生产部署时环境差异的问题，更方便分析排查问题。对运维来说，由于镜像的不可变性，更容易进行服务部署升级及回滚。另外利用诸如 Kubemetes 之类的容器管理平台，更容易实现一键部署、扩容、缩容等操作，更能将微服务架构、DevOps、不可变基础设施的思想落地下来。本文重点讲述 Spring Cloud 如何使用 Docker 实现容器化。</p><h2 id="Java-服务-Docker-化"><a href="#Java-服务-Docker-化" class="headerlink" title="Java 服务 Docker 化"></a>Java 服务 Docker 化</h2><h3 id="基础镜像选择"><a href="#基础镜像选择" class="headerlink" title="基础镜像选择"></a>基础镜像选择</h3><p>操作系统层面，可以选择传统的 Centos、Ubuntu 或者轻量级的 Alpine。其中 Ubuntu 16.04 版本的镜像大小约为 113M，压缩后大约 43M；Centos 7 版本的镜像大小约为 199M，压缩后大约为 73M；而 Alpine 3.7 版本镜像大小约为 4.15M，压缩后约为 2M。关于基础镜像的选择，一个是考虑镜像大小，一个是只提供最小的依赖包。关于第二点，不同的服务应用依赖包是不同的，这里不再展开，只从镜像大小角度考虑的话，Alpine 是首选，镜像小，远程推拉镜像的速度快，更为方便，这里建议釆用 Alpine 镜像作为基础镜像。从 Docker 镜像分层缓存的机制来考虑，如果选择了比较大的基础镜像，DockerFile 编写时可以适当分层，然后集中在几台镜像打包机上处理镜像打包及上传，这样可以充分利用打包机镜像分层缓存的机制，减少上传镜像的耗时。但是对于分布式服务的 Docker 部署，目标服务实例部署的机器比较多而且是随机的，就没办法利用这个机制来加快镜像下载速度。</p><span id="more"></span><h3 id="DockerFile-编写"><a href="#DockerFile-编写" class="headerlink" title="DockerFile 编写"></a>DockerFile 编写</h3><p>选择 Alpine 有个麻烦的地方就是 Alpine 采用的是 musl libc 的 C 标准库，而 Oracle JDK 或 OpenJDK 提供的版本则主要是以 glibc 为主，虽然 OpenJDK 在一些早期版本会放出使用 musl libc 编译好的版本，不过在正式发布的时候，并没有单独的 musl libc 编译版本可以下载，需要自己单独编译，稍微有些不便。因此可以考虑在 Alpine 里加上 glibc，然后添加 glibc 的 JDK 编译版本作为基础镜像。</p><h4 id="Alpine-glibc"><a href="#Alpine-glibc" class="headerlink" title="Alpine + glibc"></a>Alpine + glibc</h4><p>下述的 DockerFile 中，选择 Alpine 3.7 版本，glibc 釆用 Sgerrand 开源的 glibc <a target="_blank" rel="external nofollow" href="https://github.com/sgerrand/alpine-pkg-glibc">安装包</a>，版本为 2.27-r0，该镜像可以作为后面的 JDK 镜像 的基础镜像。</p><figure class="highlight docker"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine:<span class="number">3.7</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> example &lt;example@gmail.com&gt;</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apk add --no-cache ca-certificates curl openssl binutils xz tzdata \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"Asia/Shanghai"</span> &gt; /etc/timezone \</span></span><br><span class="line"><span class="bash">    &amp;&amp; GLIBC_VER=<span class="string">"2.27-r0"</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ALPINE_GLIBC_REPO=<span class="string">"https://github.com/sgerrand/alpine-pkg-glibc/releases/download"</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -Ls <span class="variable">${ALPINE_GLIBC_REPO}</span>/<span class="variable">${GLIBC_VER}</span>/glibc-<span class="variable">${GLIBC_VER}</span>.apk &gt; /tmp/<span class="variable">${GLIBC_VER}</span>.apk \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk add --allow-untrusted /tmp/<span class="variable">${GLIBC_VER}</span>.apk \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -Ls https://www.archlinux.org/packages/core/x86_64/gcc-libs/download &gt; /tmp/gcc-libs.tar.xz \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mkdir /tmp/gcc \</span></span><br><span class="line"><span class="bash">    &amp;&amp; tar -xf /tmp/gcc-libs.tar.xz -C /tmp/gcc \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mv /tmp/gcc/usr/lib/libgcc* /tmp/gcc/usr/lib/libstdc++* /usr/glibc-compat/lib \</span></span><br><span class="line"><span class="bash">    &amp;&amp; strip /usr/glibc-compat/lib/libgcc_s.so.* /usr/glibc-compat/lib/libstdc++.so* \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -Ls https://www.archlinux.org/packages/core/x86_64/zlib/download &gt; /tmp/libz.tar.xz \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mkdir /tmp/libz \</span></span><br><span class="line"><span class="bash">    &amp;&amp; tar -xf /tmp/libz.tar.xz -C /tmp/libz \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mv /tmp/libz/usr/lib/libz.so* /usr/glibc-compat/lib \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk del binutils \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /tmp/<span class="variable">${GLIBC_VER}</span>.apk /tmp/gcc /tmp/gcc-libs.tar.xz /tmp/libz /tmp/libz.tar.xz /var/cache/apk/*</span></span><br></pre></td></tr></tbody></table></figure><p>这里有几点需要注意：</p><ul><li>由于 Docker 镜像采用的是分层机制，因此安全类库或软件的命令最好在同一行命令中，减少分层，以降低最后镜像的大小</li><li>命令中间安装了类库或软件包，需要在同一行命令中删除 apk 的 cache，这样才能有效删除 apk，以减少镜像大小</li><li>这里安装了 openssl、curl、xz、tzdata 库，同时把 timezone 改为了 Asia/Shanghai</li><li> 构建镜像的命令为：<code>docker build -f /usr/local/DockerFile-Alpine-Glibc -t alpine-3.7:glibc-2.27-r0 .</code>，其中 <code>/usr/local/DockerFile-Alpine-Glibc</code> 是 DockerFile 的文件路径</li><li>由于构建镜像的过程比较慢，这里给出阿里云上已构建好的镜像（alpine + glibc），可以直接拉取到本地来使用，命令如下：</li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 拉取镜像</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> docker pull registry.cn-hangzhou.aliyuncs.com/springcloud-cn/alpine-3.7:glibc-2.27-r0</span></span><br></pre></td></tr></tbody></table></figure><h4 id="Alpine-glibc-JDK8"><a href="#Alpine-glibc-JDK8" class="headerlink" title="Alpine + glibc + JDK8"></a>Alpine + glibc + JDK8</h4><p>对于 JDK 版本的选择，有 Oracle 的 Hotspot JDK，也有 OpenJDK。对于 Oracle 的 JDK，个人使用及非商业使用是免费的，而对于商业使用来说，需进行企业订阅，在 2019 年 1 月之后才能继续获得 Java SE8 更新。Oracle 已经建议选择不订阅或不继续订阅的公司在订阅结束之前，把 JDK 版本迁移到 OpenJDK，以确保相关应用程序不受影响。下述的 JDK 8 版本釆用 Oracle 的 server-jre-8ul72 版本，而对于 JDK 9、10 及 11 版本，则釆取 OpenJDK 来构建。附上 OpenJDK 的<a target="_blank" rel="external nofollow" href="https://jdk.java.net/java-se-ri/11">官方下载地址</a>。</p><figure class="highlight docker"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> registry.cn-hangzhou.aliyuncs.com/springcloud-cn/alpine-<span class="number">3.7</span>:glibc-<span class="number">2.27</span>-r0</span><br><span class="line"><span class="keyword">MAINTAINER</span> example &lt;example@gmail.com&gt;</span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> server-jre-8u172-linux-x64.tar.gz /opt/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chmod +x /opt/jdk1.8.0_172</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME=/opt/jdk1.<span class="number">8.0</span>_172</span><br><span class="line"><span class="keyword">ENV</span> PATH=<span class="string">"$JAVA_HOME/bin:${PATH}"</span></span><br></pre></td></tr></tbody></table></figure><h4 id="Alpine-glibc-JDK9"><a href="#Alpine-glibc-JDK9" class="headerlink" title="Alpine + glibc + JDK9"></a>Alpine + glibc + JDK9</h4><figure class="highlight docker"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> registry.cn-hangzhou.aliyuncs.com/springcloud-cn/alpine-<span class="number">3.7</span>:glibc-<span class="number">2.27</span>-r0</span><br><span class="line"><span class="keyword">MAINTAINER</span> example &lt;example@gmail.com&gt;</span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> openjdk-9u181_linux-x64_bin.tar.gz /opt/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chmod +x /opt/jdk-9</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME=/opt/jdk-<span class="number">9</span></span><br><span class="line"><span class="keyword">ENV</span> PATH=<span class="string">"$JAVA_HOME/bin:${PATH}"</span></span><br></pre></td></tr></tbody></table></figure><h4 id="Alpine-glibc-JDK10"><a href="#Alpine-glibc-JDK10" class="headerlink" title="Alpine + glibc + JDK10"></a>Alpine + glibc + JDK10</h4><figure class="highlight docker"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> registry.cn-hangzhou.aliyuncs.com/springcloud-cn/alpine-<span class="number">3.7</span>:glibc-<span class="number">2.27</span>-r0</span><br><span class="line"><span class="keyword">MAINTAINER</span> example &lt;example@gmail.com&gt;</span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> openjdk-10.0.1_linux-x64_bin.tar.gz /opt/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chmod +x /opt/jdk-10.0.1</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME=/opt/jdk-<span class="number">10.0</span>.<span class="number">1</span></span><br><span class="line"><span class="keyword">ENV</span> PATH=<span class="string">"$JAVA_HOME/bin:${PATH}"</span></span><br></pre></td></tr></tbody></table></figure><h4 id="Alpine-glibc-JDK11"><a href="#Alpine-glibc-JDK11" class="headerlink" title="Alpine + glibc + JDK11"></a>Alpine + glibc + JDK11</h4><figure class="highlight docker"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> registry.cn-hangzhou.aliyuncs.com/springcloud-cn/alpine-<span class="number">3.7</span>:glibc-<span class="number">2.27</span>-r0</span><br><span class="line"><span class="keyword">MAINTAINER</span> example &lt;example@gmail.com&gt;</span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> openjdk-11+28_linux-x64_bin.tar.gz /opt/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chmod +x /opt/jdk-11</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME=/opt/jdk-<span class="number">11</span></span><br><span class="line"><span class="keyword">ENV</span> PATH=<span class="string">"$JAVA_HOME/bin:${PATH}"</span></span><br></pre></td></tr></tbody></table></figure><p>阿里云上有已构建好的不同版本的 JDK 镜像，拉取到本地就可以直接使用：</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 基于 Oracle JDK 8 构建的镜像</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> docker pull registry.cn-hangzhou.aliyuncs.com/springcloud-cn/java:8u172-jre-alpine</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 基于 OpenJDK 9 构建的镜像</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> docker pull registry.cn-hangzhou.aliyuncs.com/springcloud-cn/java:openjdk-9u181-alpine</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 基于 OpenJDK 10 构建的镜像</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> docker pull registry.cn-hangzhou.aliyuncs.com/springcloud-cn/java:openjdk-10.0.1-alpine</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 基于 OpenJDK 11 构建的镜像</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> docker pull registry.cn-hangzhou.aliyuncs.com/springcloud-cn/java:openjdk-11-ea19-alpine</span></span><br></pre></td></tr></tbody></table></figure><h3 id="Maven-构建与发布镜像"><a href="#Maven-构建与发布镜像" class="headerlink" title="Maven 构建与发布镜像"></a>Maven 构建与发布镜像</h3><h4 id="构建镜像的-Maven-插件"><a href="#构建镜像的-Maven-插件" class="headerlink" title="构建镜像的 Maven 插件"></a>构建镜像的 Maven 插件</h4><p>主流的几款 Docker 的 Maven 插件：</p><p><img data-src="../../../asset/2020/05/maven-docker-plugin.png" alt="maven-docker-plugin"></p><p>这里以 Maven 构建为例，选用的是 com.spotify 的插件，其 Maven 的 POM 配置如下。使用 spring-boot-maven-plugin 的 1.4.3 版本，另外设置的镜像前缀为 <code>registry.cn-hangzhou.aliyuncs.com/springcloud-cn</code>，tag 为 <code>$(project.version)</code>， repository（私有仓库地址）为 <code>${docker.image.prefix}/${project.artifactId}</code>，另外这里还传递了一个 Docker 的 <code>buildArg</code> 为 <code>JAR_FILE</code>，其值为 <code>$(project.build.finalName) .jar</code>。<code>username</code> 与 <code>password</code> 标签是指访问私有仓库的用户名和密码，若不需要身份认证，则可以注释这两个标签。<a href="/downloads/2020/05/micro-service-docker.zip">点击下载</a>完整的示例代码。</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dockerfile.maven.version</span>&gt;</span>1.4.3<span class="tag">&lt;/<span class="name">dockerfile.maven.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">docker.image.prefix</span>&gt;</span>registry.cn-hangzhou.aliyuncs.com/springcloud-cn<span class="tag">&lt;/<span class="name">docker.image.prefix</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>Finchley.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/libs-milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spotify<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dockerfile-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>${dockerfile.maven.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>default<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>build<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>push<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">skipPush</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skipPush</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- &lt;username&gt;admin&lt;/username&gt; --&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- &lt;password&gt;123456&lt;/password&gt; --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">repository</span>&gt;</span>${docker.image.prefix}/${project.artifactId}<span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tag</span>&gt;</span>${project.version}<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">buildArgs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">JAR_FILE</span>&gt;</span>${project.build.finalName}.jar<span class="tag">&lt;/<span class="name">JAR_FILE</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">buildArgs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h4 id="Maven-构建镜像的-DockFile"><a href="#Maven-构建镜像的-DockFile" class="headerlink" title="Maven 构建镜像的 DockFile"></a>Maven 构建镜像的 DockFile</h4><p>Maven 项目的 DockerFile 内容如下，<strong>特别注意，DockerFile 需要放在 IDEA 里的某个应用（模块）的根目录下</strong>。例如 gateway-server 模块需要打包，并发布构建到 Docker 镜像里，那么 DockerFile 此时应该放在 gateway-server 模块的根目录下，不同的应用（模块）可以拥有自己的 DockerFile。下面的 <code>registry.cn-hangzhou.aliyuncs.com/springcloud-cn/java:8u172-jre-alpine</code> 是指私有仓库里已构建好的 JDK 镜像。</p><figure class="highlight docker"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> registry.cn-hangzhou.aliyuncs.com/springcloud-cn/java:<span class="number">8</span>u172-jre-alpine</span><br><span class="line"><span class="keyword">ARG</span> JAR_FILE</span><br><span class="line"><span class="keyword">ENV</span> PROFILE default</span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> target/<span class="variable">${JAR_FILE}</span> /opt/app.jar</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> java <span class="variable">${JAVA_OPTS}</span> -Djava.security.egd=file:/dev/./urandom -Duser.timezone=Asia/Shanghai -Dfile.encoding=UTF-8 -Dspring.profiles.active=<span class="variable">${PROFILE}</span> -jar /opt/app.jar</span></span><br></pre></td></tr></tbody></table></figure><h4 id="Maven-打包构建镜像"><a href="#Maven-打包构建镜像" class="headerlink" title="Maven 打包构建镜像"></a>Maven 打包构建镜像</h4><p>执行下述的 Maven 打包构建命令（跳过单元测试），成功后会在本地构建生成新的 Docker 镜像，如果上面的 POM 配置了 <code>&lt;skipPush&gt;false&lt;/skipPush&gt;</code>，会自动将新的镜像 Push 到私有仓库。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mvn clean package -Dmaven.test.skip=<span class="literal">true</span></span></span><br></pre></td></tr></tbody></table></figure><h4 id="Maven-Push-镜像"><a href="#Maven-Push-镜像" class="headerlink" title="Maven Push 镜像"></a>Maven Push 镜像</h4><p>Maven 手动 Push 镜像到 私有仓库：</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 第一种方式：不使用身份认证或者使用POM配置里的私有仓库账号进行Push</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mvn dockerfile:push</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 第二种方式：使用指定的私有仓库账号进行Push</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mvn dockerfile:push -Ddockerfile.username=xxx -Ddockerfile.password=xxx</span></span><br></pre></td></tr></tbody></table></figure><h4 id="Maven-运行镜像"><a href="#Maven-运行镜像" class="headerlink" title="Maven 运行镜像"></a>Maven 运行镜像</h4><p>执行以下命令运行镜像，实际项目中可以根据项目需要调整对应的 JVM 参数：</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> docker run -p 8080:8080 --rm \</span></span><br><span class="line"><span class="bash">-e JAVA_OPTS=<span class="string">'-server -Xmx1g -Xms1g -XX:MetaspaceSize=64m -verbose:gc -verbose:sizes -XX:+UseG1GC -XX:MaxGCPauseMillis=50 -XX:+UnlockDiagnosticVMOptions -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/ -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -XX:+PrintTenuringDistribution -Xloggc:/opt/gc.log -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=20M -Djava.io.tmpdir=/tmp'</span> \</span></span><br><span class="line"><span class="bash">-e PROFILE=<span class="string">'default'</span> \</span></span><br><span class="line"><span class="bash">registry.cn-hangzhou.aliyuncs.com/springcloud-cn/gateway:1.0-SNAPSHOT</span></span><br></pre></td></tr></tbody></table></figure><h3 id="JDK-8-的-Docker-资源限制支持"><a href="#JDK-8-的-Docker-资源限制支持" class="headerlink" title="JDK 8+ 的 Docker 资源限制支持"></a>JDK 8+ 的 Docker 资源限制支持</h3><h4 id="JDK-8-amp-amp-JDK-9"><a href="#JDK-8-amp-amp-JDK-9" class="headerlink" title="JDK 8 &amp;&amp; JDK 9"></a>JDK 8 &amp;&amp; JDK 9</h4><p>Java 8ul31 及以上版本开始支持了 Docker 的 CPU 和 Memory 限制。对于 CPU 的限制，如果 JVM 没有显式指定 <code>-XX： ParalllelGCThreads</code> 或者 <code>-XX： CICompilerCount</code>，那么 JVM 会使用 Docker 的 CPU 限制。如果 Docker 有指定 CPU Limit，JVM 参数也有指定 <code>-XX： ParalllelGCThreads</code> 或者 <code>-XX： CICompilerCount</code>，那么最终以指定的 JVM 参数为准。对于 Memory 限制，需要加上 <code>-XX： +UnlockExperimentalVMOptions</code> 和 <code>-XX： +UseCGroupMemoryLimitForHeap</code> 才能使得 Xmx 感知 Docker 的 Memory Limit。</p><h4 id="JDK-10"><a href="#JDK-10" class="headerlink" title="JDK 10"></a>JDK 10</h4><p>JDK 10 版本废弃了 UseCGroupMemoryLimitForHeap，同时新引入了新配置 ActiveProcessorCount，可以用来强制指定 CPU 的个数。</p><h4 id="JDK-11"><a href="#JDK-11" class="headerlink" title="JDK 11"></a>JDK 11</h4><p>JDK 11 正式移除 UseCGroupMemoryLimitForHeap，同时新引入 UseContainerSupport 配置，默认为 ture，即默认支持 Docker 的 CPU 及 Memory 限制，也可以设置为 false 来禁用容器支持。</p><h3 id="JDK-9-镜像优化"><a href="#JDK-9-镜像优化" class="headerlink" title="JDK 9+ 镜像优化"></a>JDK 9+ 镜像优化</h3><p>JDK9 及以上的版本与之前的版本有一个比较大的变动，就是 JDK9 及以上的版本支持模块系统 JPMS，同时 JDK 自身也模块化了，里面的 Modular Run-Time Images 功能特性以及 jlink 工具对于镜像的优化非常有帮助，可根据所需模块来精简 JDK。</p><h4 id="Jlink-工具"><a href="#Jlink-工具" class="headerlink" title="Jlink 工具"></a>Jlink 工具</h4><p>Jlink 工具可以用来将已有的 JDK 按所需模块进行优化，并重新组装成一个自定义的 runtime image，其基本语法如下：</p><p><code>jlink [options] --module-path modulepath --add-modules module [,module...]</code></p><p>其中 module-path 参数用于指定需要 Jlink 的 JDK 的 jmods 路径，options 的部分参数说明如下：</p><ul><li>add-mobules，用来指定所需要的模块名称，比如 java.xml</li><li>compress，用来指定压缩级别，0 为不压缩，1 为常量字符串共享，2 为 Zip 压缩</li><li> no-hreader-files，表示排除掉 header 文件</li><li> output，指定输出精简后的 JDK 的文件夹路径</li></ul><h4 id="Jlink-使用案例"><a href="#Jlink-使用案例" class="headerlink" title="Jlink 使用案例"></a>Jlink 使用案例</h4><p>创建对应 Dockerfile，配置内容如下，其中指定了需要依赖的 JDK 模块，目的是通过 Jlink 生成精简的 JDK，<a href="/downloads/2020/05/micro-service-docker-jlink.zip">点击下载</a>完整的示例代码。</p><figure class="highlight docker"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> registry.cn-hangzhou.aliyuncs.com/springcloud-cn/java:openjdk-<span class="number">10.0</span>.<span class="number">1</span>-alpine as packager</span><br><span class="line"></span><br><span class="line"><span class="comment"># jlink tool</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> /opt/jdk-10.0.1/bin/jlink \</span></span><br><span class="line"><span class="bash">    --module-path /opt/jdk-10.0.1/jmods \</span></span><br><span class="line"><span class="bash">    --verbose \</span></span><br><span class="line"><span class="bash">    --add-modules java.base,java.logging,java.xml,jdk.unsupported,java.sql,java.desktop,java.management,java.naming,java.instrument,jdk.jstatd,jdk.jcmd,jdk.management \</span></span><br><span class="line"><span class="bash">    --compress 2 \</span></span><br><span class="line"><span class="bash">    --no-header-files \</span></span><br><span class="line"><span class="bash">    --output /opt/jdk-10-jlinked</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># copy jdk after jlink</span></span><br><span class="line"><span class="keyword">FROM</span> registry.cn-hangzhou.aliyuncs.com/springcloud-cn/alpine-<span class="number">3.7</span>:glibc-<span class="number">2.27</span>-r0</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=packager /opt/jdk-10-jlinked /opt/jdk-10.0.1</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME=/opt/jdk-<span class="number">10.0</span>.<span class="number">1</span></span><br><span class="line"><span class="keyword">ENV</span> PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line"></span><br><span class="line"><span class="comment"># add application jar</span></span><br><span class="line"><span class="keyword">ARG</span> JAR_FILE</span><br><span class="line"><span class="keyword">ENV</span> PROFILE default</span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> target/<span class="variable">${JAR_FILE}</span> /opt/app.jar</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> java <span class="variable">${JAVA_OPTS}</span> -Djava.security.egd=file:/dev/./urandom -Duser.timezone=Asia/Shanghai -Dfile.encoding=UTF-8 -Dspring.profiles.active=<span class="variable">${PROFILE}</span> -jar /opt/app.jar</span></span><br></pre></td></tr></tbody></table></figure><p>通过 Maven 打包构建镜像：</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mvn clean package -Dmaven.test.skip=<span class="literal">true</span></span></span><br></pre></td></tr></tbody></table></figure><p>查看镜像的大小，可以发现精简后的 JDK 包括 app.jar，总大小在 100M 以内：</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> docker images |grep gatewaydocker images |grep gateway</span></span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/springcloud-cn/gateway      1.0-SNAPSHOT            8f0c327e65a4        2 minutes ago       96MB</span><br></pre></td></tr></tbody></table></figure><p>运行镜像：</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> docker run -p 8080:8080 --rm \</span></span><br><span class="line"><span class="bash">-e JAVA_OPTS=<span class="string">'-server -XX:+UseG1GC -XX:MaxGCPauseMillis=50 -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -XX:ActiveProcessorCount=1 -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/ -Xlog:age*,gc*=info:file=gc-%p-%t.log:time,tid,tags:filecount=5,filesize=10m -Djava.io.tmpdir=/tmp'</span> \</span></span><br><span class="line"><span class="bash">-e PROFILE=<span class="string">'default'</span> \</span></span><br><span class="line"><span class="bash">registry.cn-hangzhou.aliyuncs.com/springcloud-cn/gateway:1.0-SNAPSHOT</span></span><br></pre></td></tr></tbody></table></figure><p>查看精简后的 JDK 大小：</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 连接容器</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> docker <span class="built_in">exec</span> -it dreamy_golick /bin/sh</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看精简后的JDK大小</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> du -sh /opt/jdk-10.0.1/</span></span><br><span class="line">53.5M	/opt/jdk-10.0.1/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看应用Jar包的大小</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> du -sh /opt/app.jar</span></span><br><span class="line">22.2M	/opt/app.jar</span><br></pre></td></tr></tbody></table></figure></div><script src="https://qiniu.techgrow.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if(!isMobile)try{var plugin=new ReadmorePlugin;plugin.init({id:"readmore-container",blogId:"96641-5333172926158-056",name:"全栈技术驿站",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",lockToc:"yes",random:"0.9"})}catch(e){console.warn(e.name+" : "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>坚持原创技术分享，您的支持将鼓励我继续创作！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/fe094f6c.html" title="SpringCloud 容器化">https://www.techgrow.cn/posts/fe094f6c.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎加入微信群</span><br> <img src="/img/wx-group-qr-technology.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="fa fa-tag"></i> 微服务</a><a href="/tags/%E5%AE%B9%E5%99%A8%E5%8C%96/" rel="tag"><i class="fa fa-tag"></i> 容器化</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/e460e49c.html" rel="prev" title="Centos8 新特性介绍"><i class="fa fa-chevron-left"></i> Centos8 新特性介绍</a></div><div class="post-nav-item"> <a href="/posts/6bd46e8d.html" rel="next" title="Python 入门教程 - Python 介绍">Python 入门教程 - Python 介绍<i class="fa fa-chevron-right"></i></a></div></div><div style="text-align:center"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4014850419768221" data-ad-slot="7586134725" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright &copy; 2018 – <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">647k</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 &asymp;</span> <span title="站点阅读时长">9:48</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo | Theme NexT | Docker： "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="beian"> <span><img src="/img/gonganbeian.png" alt></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备19024664号</a></span></div></div></footer><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-ph3Dk89VmuTVXG6x/RDzk53SU9LPdAh1tpv0UvnDZ2I="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"/lib/mermaid/dist/mermaid.min.js","integrity":"sha256-CemUs9ITT7liCZpVMktcEw0BpAOZ1+mujlMB3UyuImU="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://unpkg.com/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '32px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://unpkg.com/qiniu-js@3.3.1/dist/qiniu.min.js"></script><script>
    var qiniu_domain = "https://qiniu.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/app/api/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn:9360","cssUrl":"https://unpkg.com/@waline/client@2.3.2/dist/waline.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://unpkg.com/@waline/client@2.3.2/dist/waline.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://unpkg.com/@waline/emojis@1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://qiniu.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/app/api/qiniu/token/upload","el":"#waline","comment":true,"path":"/posts/fe094f6c.html"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@2.3.2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>