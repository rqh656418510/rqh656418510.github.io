<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍 Java 的 Fork-Join 框架使用。"><meta property="og:type" content="article"><meta property="og:title" content="Java 多线程编程之八 Fork/Join 框架使用"><meta property="og:url" content="https://www.techgrow.cn/posts/4a0f41c0.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍 Java 的 Fork-Join 框架使用。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/08/fork-join-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/08/fork-join-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/08/fork-join-1.png"><meta property="article:published_time" content="2023-03-25T14:34:42.000Z"><meta property="article:modified_time" content="2023-03-25T14:34:42.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="Java"><meta property="article:tag" content="并发编程"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2024/08/fork-join-2.png"><link rel="canonical" href="https://www.techgrow.cn/posts/4a0f41c0.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/4a0f41c0.html","path":"posts/4a0f41c0.html","title":"Java 多线程编程之八 Fork/Join 框架使用"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Java 多线程编程之八 Fork/Join 框架使用 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/app/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Fork-Join-%E6%A1%86%E6%9E%B6%E7%9A%84%E4%BB%8B%E7%BB%8D"><span class="nav-text">Fork/Join 框架的介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Fork-Join-%E6%A1%86%E6%9E%B6%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="nav-text">Fork/Join 框架的定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fork-Join-%E6%A1%86%E6%9E%B6%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-text">Fork/Join 框架的工作流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fork-Join-%E6%A1%86%E6%9E%B6%E7%9A%84%E5%B7%A5%E4%BD%9C%E7%AA%83%E5%8F%96"><span class="nav-text">Fork/Join 框架的工作窃取</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E7%AA%83%E5%8F%96%E7%AE%97%E6%B3%95%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-text">工作窃取算法的实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E7%AA%83%E5%8F%96%E7%AE%97%E6%B3%95%E7%9A%84%E4%BC%98%E7%82%B9"><span class="nav-text">工作窃取算法的优点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E7%AA%83%E5%8F%96%E7%AE%97%E6%B3%95%E7%9A%84%E8%AE%BE%E8%AE%A1"><span class="nav-text">工作窃取算法的设计</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fork-Join-%E6%A1%86%E6%9E%B6%E7%9A%84%E7%B1%BB%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB"><span class="nav-text">Fork/Join 框架的类继承关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fork-Join-%E6%A1%86%E6%9E%B6%E7%9A%84%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-text">Fork/Join 框架的使用注意事项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fork-Join-%E6%A1%86%E6%9E%B6%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-text">Fork/Join 框架与线程池的区别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Fork-Join-%E6%A1%86%E6%9E%B6%E7%9A%84%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="nav-text">Fork/Join 框架的使用案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B%E4%B8%80"><span class="nav-text">使用案例一</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Fork-Join-%E6%A1%86%E6%9E%B6%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-text">Fork/Join 框架的工作原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ForkJoinPool-%E5%89%96%E6%9E%90"><span class="nav-text">ForkJoinPool 剖析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">601</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">52</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/4a0f41c0.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Java 多线程编程之八 Fork/Join 框架使用 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍 Java 的 Fork-Join 框架使用。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Java 多线程编程之八 Fork/Join 框架使用</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-03-25 22:34:42" itemprop="dateCreated datePublished" datetime="2023-03-25T22:34:42+08:00">2023-03-25</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/4a0f41c0.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/4a0f41c0.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>5.2k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>5 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/5bbede3c.html">Java 多线程编程之一 Java 内存模型浅析</a></li><li><a href="/posts/f7ed7888.html">Java 多线程编程之二 synchronize 锁对象竞争</a></li><li><a href="/posts/ed2e098d.html">Java 多线程编程之三 volatile 与 JMM 内存模型</a></li><li><a href="/posts/3b82844a.html">Java 多线程编程之四 CAS、ABA 问题、锁</a></li><li><a href="/posts/d9aa9f1f.html">Java 多线程编程之五 AQS 底层源码深度剖析</a></li><li><a href="/posts/1f270e10.html">Java 多线程编程之六集合类的线程安全问题</a></li><li><a href="/posts/f7fd0987.html">Java 多线程编程之七队列、线程池、线程通信</a></li><li><a href="/posts/4a0f41c0.html">Java 多线程编程之八 Fork/Join 框架使用</a></li><li><a href="/posts/d016a303.html">Java 多线程编程之九 ThreadLocal 使用</a></li></ul><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在 Java 中，Fork/Join 框架（分支合并框架）是一种用于并行处理任务的强大工具，特别适用于那些可以递归地分解成更小任务的场景（如下图所示）。Fork/Join 框架基于 “工作窃取” 算法，允许空闲的线程从那些繁忙的线程那里窃取任务，以提高 CPU 的使用效率和程序的执行性能。</p><span id="more"></span><h2 id="Fork-Join-框架的介绍"><a href="#Fork-Join-框架的介绍" class="headerlink" title="Fork/Join 框架的介绍"></a>Fork/Join 框架的介绍</h2><h3 id="Fork-Join-框架的定义"><a href="#Fork-Join-框架的定义" class="headerlink" title="Fork/Join 框架的定义"></a>Fork/Join 框架的定义</h3><p>Fork/Join 框架的基本思想是 “分而治之”，将大任务拆分（Fork）为若干个小任务（拆到不可再拆为止），这些小任务可以并行执行，然后再将一个个小任务的执行结果合并（Join）起来得到最终结果。</p><p><img data-src="../../../asset/2024/08/fork-join-2.png"></p><h3 id="Fork-Join-框架的工作流程"><a href="#Fork-Join-框架的工作流程" class="headerlink" title="Fork/Join 框架的工作流程"></a>Fork/Join 框架的工作流程</h3><p>Fork/Join 框架的工作流程如下：</p><ul><li>(1) 任务被分解成更小的子任务。</li><li>(2) 子任务提交到 ForkJoinPool 中执行。</li><li>(3) ForkJoinPool 中的工作线程（ForkJoinWorkerThread）负责执行子任务。</li><li>(4) 子任务的结果合并成最终结果。</li></ul><h3 id="Fork-Join-框架的工作窃取"><a href="#Fork-Join-框架的工作窃取" class="headerlink" title="Fork/Join 框架的工作窃取"></a>Fork/Join 框架的工作窃取</h3><p>工作窃取（Work-Stealing）是一种负载均衡算法，用于在多线程环境下高效地利用系统资源。其基本思想是：如果某个线程完成了它的任务并且变得空闲，而其他线程仍然有未完成的任务，那么空闲的线程会从其他忙碌的线程那里窃取任务来执行。这样可以避免某些线程闲置而其他线程繁忙的情况，从而提高整个系统的吞吐量。</p><h4 id="工作窃取算法的实现"><a href="#工作窃取算法的实现" class="headerlink" title="工作窃取算法的实现"></a>工作窃取算法的实现</h4><p>在 Fork/Join 框架中，每个线程都有一个双端队列（Deque）来存储需要执行的任务：</p><ul><li>(1) <strong>任务分解</strong>：当一个任务需要被执行时，它首先会被分解成若干子任务（通过调用 <code>fork()</code> 方法），这些子任务会被压入当前线程的任务队列的头部。</li><li>(2) <strong>任务执行</strong>：线程会不断地从自己队列的尾部弹出任务并执行（通过调用 <code>join()</code> 方法）。如果一个线程完成了自己队列中的所有任务，它就会去 “窃取” 其他线程队列头部的任务来执行。</li><li>(3) <strong>任务窃取</strong>：窃取任务时，线程通常会从其他线程的队列头部取任务，而非从尾部取任务。这种设计是工作窃取算法的一部分，它有助于最大限度地减少线程之间的锁竞争，可以提升并行任务处理的效率。</li></ul><h4 id="工作窃取算法的优点"><a href="#工作窃取算法的优点" class="headerlink" title="工作窃取算法的优点"></a>工作窃取算法的优点</h4><ul><li>(1) <strong>负载均衡</strong>：通过让空闲线程窃取任务，工作窃取算法实现了任务的负载均衡，避免某些线程长时间空闲。</li><li>(2) <strong>局部性</strong>：线程通常优先执行自己队列中的任务，这有助于提高数据局部性，减少缓存失效。</li><li>(3) <strong>弹性和灵活性</strong>：线程数可以动态调整，系统可以自动适应当前的任务负载。</li></ul><h4 id="工作窃取算法的设计"><a href="#工作窃取算法的设计" class="headerlink" title="工作窃取算法的设计"></a>工作窃取算法的设计</h4><p>为什么工作线程（ForkJoinWorkerThread）正常获取任务时会从工作队列（WorkQueue）的尾部取，而窃取任务时则从工作队列的头部取呢？这样的设计主要是出于以下几点考虑：</p><ul><li><strong>减少锁争用</strong>：在 Fork/Join 框架中，工作线程会频繁地添加和取出任务。为了提高效率，队列通常是双端队列（Deque）。从尾部添加和取出任务通常不需要加锁，因为通常只有一个线程在操作自己的工作队列。然而，如果线程从队列头部取任务，可能会导致与其他窃取线程的竞争，从而增加锁争用和同步开销。</li><li><strong>任务执行的局部性</strong>：Fork/Join 框架鼓励对任务进行分解，并让产生任务的线程尽快执行这些任务。这种局部性策略通过让线程处理它自己刚生成的任务（即尾部的任务），这样可以更好地利用 CPU 缓存，从而提高执行效率。这是因为新生成的任务往往与生成它们的任务共享数据或资源，保持这些任务的局部性可以提高缓存命中率。</li><li><strong>工作窃取算法的有效性</strong>：工作窃取算法允许线程从其他线程的工作队列中窃取任务，以保持系统的负载均衡。窃取线程从头部窃取任务，工作线程从尾部取任务，这种方式可以最大化任务的处理并减少同步开销。因为通常窃取的任务是队列中最早生成的任务，这些任务可能更耗时，这也有助于保持负载的均衡。</li></ul><h3 id="Fork-Join-框架的类继承关系"><a href="#Fork-Join-框架的类继承关系" class="headerlink" title="Fork/Join 框架的类继承关系"></a>Fork/Join 框架的类继承关系</h3><blockquote><p>Fork/Join 框架的类结构</p></blockquote><p><img data-src="../../../asset/2024/08/fork-join-3.png"></p><p>Fork/Join 框架主要包含两个核心部分：</p><ul><li>ForkJoinPool：一个特殊的线程池，用于管理 ForkJoinTask 的执行。</li><li>ForkJoinTask：一个抽象类，表示可以并行执行的任务。ForkJoinTask 有两个子抽象类：<ul><li>RecursiveAction：用于没有返回结果的任务（类似 Runnable），可以实现递归调用任务。</li><li>RecursiveTask：用于有返回结果的任务（类似 Callable），可以实现递归调用任务。</li></ul></li></ul><blockquote><p>Fork/Join 框架的类关系</p></blockquote><p><img data-src="../../../asset/2024/08/fork-join-1.png"></p><ul><li><p>ForkJoinPool 是一个特殊的线程池，实现了 Executor 接口，其构造方法中常用参数的介绍如下：</p><ul><li><code>parallelism</code>：并行的线程数，也就是在没有额外任务提交的情况下，最大的并行级别。表示要维护的并行操作的目标数量，对于默认值（等于可用处理器的数量）可以通过 <code>Runtime.getRuntime().availableProcessors()</code> 获取到。</li><li><code>factory</code>：生成 ForkJoinWorkerThread 线程的工厂类，此工厂在创建新线程时会使用到。</li><li><code>handler</code>：处理未捕获的异常的处理器，它允许在任何 Worker 线程意外终止时进行处理。</li><li><code>asyncMode</code>：此选项的默认值为 <code>false</code>，可以设置为 <code>true</code>，以便采用 “工作窃取（Work-Stealing）” 模式。在这种模式下，当线程的待执行任务队列为空时，该线程会尝试窃取其他线程的任务来执行。如果设置为 <code>false</code>，则会使用 “FIFO（先进先出）” 模式，这也被称为 “队列模式”。在 FIFO 模式下，任务是以提交的顺序执行的，也就是比较早提交的任务会被比较早地执行。通常情况下，为了获取更好的性能一般都使用 “工作窃取” 模式。</li></ul></li><li><p>ForkJoinTask 本身是个抽象类，实现了 Future 和 Serializable 接口，核心方法有：</p><ul><li><code>fork()</code>：安排异步执行此任务。</li><li><code>join()</code>：返回执行结果或者抛出一个异常（如果任务没有正常完成）。</li><li><code>invoke()</code>：开始执行任务，并等待任务完成。</li><li><code>isCompletedAbnormally()</code>：返回任务是否异常结束。</li><li><code>getException()</code>：返回任务抛出的异常。</li><li><code>cancel()</code>：取消任务。</li></ul></li><li><p>RecursiveAction：这是没有返回结果的任务类，支持递归执行任务，使用它需要实现其抽象方法 <code>compute()</code> 来执行具体的任务，但不返回任何结果。</p></li><li><p>RecursiveTask：这是带有返回结果的任务类，支持递归执行任务，使用它需要实现其抽象方法 <code>compute()</code> 来执行具体的任务，会返回执行结果。</p></li></ul><h3 id="Fork-Join-框架的使用注意事项"><a href="#Fork-Join-框架的使用注意事项" class="headerlink" title="Fork/Join 框架的使用注意事项"></a>Fork/Join 框架的使用注意事项</h3><ul><li>避免任务之间的相互依赖，以防止线程死锁。</li><li>任务的分解粒度需要合理考虑，分解粒度过大或过小都会影响性能。</li><li>合理配置 ForkJoinPool 的线程数量，以充分利用多核 CPU 的计算能力。</li></ul><h3 id="Fork-Join-框架与线程池的区别"><a href="#Fork-Join-框架与线程池的区别" class="headerlink" title="Fork/Join 框架与线程池的区别"></a>Fork/Join 框架与线程池的区别</h3><ul><li>Fork/Join 框架采用了 “工作窃取（Work-Stealing）” 算法，也就是当执行新的任务时，它可以将其拆分成更小的任务，并将小任务添加到线程自己的队列中。当线程执行完自己队列中的所有任务后，它就会去 “窃取” 其他线程队列尾部的任务并放在自己的队列中，然后再执行 “窃取” 得到的任务。</li><li>相对于传统的线程池实现，Fork/Join 框架的优势体现在对其中包含的任务的处理方式上。在传统的线程池中，如果一个线程正在执行的任务由于某些原因无法继续运行（比如等待锁资源），那么该线程会处于等待状态；而在 ForF/Join 框架的实现中，如果某个子任务由于等待另外一个子任务的完成而无法继续运行，那么处理该子任务的线程会主动寻找其他尚未执行的子任务来执行。这种方式减少了线程的等待时间，提高了整体的性能。</li></ul><h2 id="Fork-Join-框架的使用案例"><a href="#Fork-Join-框架的使用案例" class="headerlink" title="Fork/Join 框架的使用案例"></a>Fork/Join 框架的使用案例</h2><p>使用 Fork/Join 框架，首先需要创建一个 ForkJoinTask 任务，该类提供了在任务中执行 Fork 和 Join 的机制。在一般情况下，不需要直接继承 ForkJoinTask 类，只需要继承它的子类 <code>RecursiveAction</code> 或者 <code>RecursiveTask</code> 即可。</p><h3 id="使用案例一"><a href="#使用案例一" class="headerlink" title="使用案例一"></a>使用案例一</h3><p>利用 Fork/Join 框架计算 1 + 2 + 3 + … + 100000000 的和。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForkJoinTest</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        ForkJoinPool pool = <span class="keyword">new</span> ForkJoinPool();</span><br><span class="line">        ForkJoinTask&lt;Long&gt; task = <span class="keyword">new</span> ForkJoinSumCalculate(<span class="number">0</span>, <span class="number">100000000L</span>);</span><br><span class="line">        <span class="comment">// 调用 invoke 方法将任务提交到线程池，会阻塞直到任务完成</span></span><br><span class="line">        Long sum = pool.invoke(task);</span><br><span class="line">        System.out.println(<span class="string">"sum = "</span> + sum);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ForkJoinSumCalculate</span> <span class="keyword">extends</span> <span class="title">RecursiveTask</span>&lt;<span class="title">Long</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> start;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> end;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> THURSHOLD = <span class="number">100000L</span>;   <span class="comment">// 阀值</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ForkJoinSumCalculate</span><span class="params">(<span class="keyword">long</span> start, <span class="keyword">long</span> end)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.start = start;</span><br><span class="line">        <span class="keyword">this</span>.end = end;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Long <span class="title">compute</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">long</span> length = end - start;</span><br><span class="line">        <span class="comment">// 当任务的大小小于或等于阈值时，直接执行计算，否则将任务一分为二，递归地创建子任务并进行计算</span></span><br><span class="line">        <span class="keyword">if</span> (length &lt;= THURSHOLD) {</span><br><span class="line">            <span class="comment">// 执行小任务</span></span><br><span class="line">            <span class="keyword">long</span> sum = <span class="number">0L</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">long</span> i = start; i &lt;= end; i++) {</span><br><span class="line">                sum += i;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> sum;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">long</span> middle = (start + end) / <span class="number">2</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 拆分大任务为小任务，并将小任务压入线程队列，等待异步执行</span></span><br><span class="line">            ForkJoinSumCalculate left = <span class="keyword">new</span> ForkJoinSumCalculate(start, middle);</span><br><span class="line">            left.fork();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 拆分大任务为小任务，并将小任务压入线程队列，等待异步执行</span></span><br><span class="line">            ForkJoinSumCalculate right = <span class="keyword">new</span> ForkJoinSumCalculate(middle + <span class="number">1</span>, end);</span><br><span class="line">            right.fork();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 合并多个小任务的执行结果</span></span><br><span class="line">            <span class="keyword">return</span> left.join() + right.join();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>程序执行的结果：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum = 5000000050000000</span><br></pre></td></tr></tbody></table></figure><blockquote><p>JDK 1.8 提供了并行流（Stream），下面代码的运行效果等价于上述代码，但运行效率更高。</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamTest</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        Long sum = (LongStream.rangeClosed(<span class="number">0L</span>, <span class="number">100000000L</span>)).parallel().reduce(<span class="number">0L</span>, Long::sum);</span><br><span class="line">        System.out.println(<span class="string">"sum = "</span> + sum);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>程序执行的结果：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum = 5000000050000000</span><br></pre></td></tr></tbody></table></figure><h2 id="Fork-Join-框架的工作原理"><a href="#Fork-Join-框架的工作原理" class="headerlink" title="Fork/Join 框架的工作原理"></a>Fork/Join 框架的工作原理</h2><h3 id="ForkJoinPool-剖析"><a href="#ForkJoinPool-剖析" class="headerlink" title="ForkJoinPool 剖析"></a>ForkJoinPool 剖析</h3><ul><li><p>ForkJoinPool 的组成：</p><ul><li>ForkJoinPool 的核心组件是 ForkJoinWorkerThread 和 WorkQueue。其中 ForkJoinWorkerThread 代表了 ForkJoinPool 中的工作线程，而 WorkQueue 则用于存储线程内的待执行任务。</li><li>ForkJoinPool 内部有一个 <code>ctl</code> 的原子整型字段，用来控制和调度工作线程的数量。它包括了状态、工作线程的数量，以及提交任务数量等信息。</li><li>任务会被直接提交到 ForkJoinPool 的工作队列（WorkQueue）中，每个工作线程（WorkThread）都有自己的工作队列，这些队列分别存储各自线程内的待执行任务，包括来自外部线程的提交任务。</li></ul></li><li><p>ForkJoinPool 的执行过程：</p><ul><li>当一个 ForkJoinTask 被提交到 ForkJoinPool 时，线程池会首先检查提交任务的线程是否为 ForkJoinWorkerThread。如果是，任务会被直接放置在该线程的 WorkQueue 中；如果不是，线程池会为此任务选择一个 WorkQueue 并将任务放入其中。</li><li>当 ForkJoinWorkerThread 执行时，它首先会尝试从自己的 WorkQueue 中取出任务来执行。如果队列为空，它会尝试去其他线程的 WorkQueue 中窃取任务来执行。</li><li>当 ForkJoinTask 执行 Fork 操作（即进行任务分解）时，新拆分出来的任务会被放入当前 ForkJoinWorkerThread 的 WorkQueue 的尾部。</li><li>WorkQueue 是一个双端队列，它允许 ForkJoinWorkerThread 以 LIFO 的方式（即后进先出）从队列尾部获取任务来执行，也允许其他线程从队列头部窃取任务来执行。</li><li>使用这种方式，ForkJoinPool 能够充分利用所有可用的处理器核心，并且能够将大任务适当地拆分成多个小任务来进行并行处理，从而最大化并行处理的效率。</li></ul></li><li><p>ForkJoinPool 中的 <code>workQueues</code> 属性和 ForkJoinWorkerThread 中的 <code>workQueue</code> 属性关联关系：</p><ul><li><code>ForkJoinPool</code>：它管理一组 ForkJoinWorkerThread。每一个 ForkJoinWorkerThread 都有一个对应的 WorkQueue，用于存储待处理的任务。</li><li><code>ForkJoinPool 和 workQueues</code>：这是 ForkJoinPool 内部的一个数据结构，通常表现为一个数组，负责存储与每个 ForkJoinWorkerThread 对应的 WorkQueue。在 ForkJoinWorkerThread 创建时，也会为其创建一个新的 WorkQueue，并添加到 workQueues 中。</li><li><code>ForkJoinWorkerThread 和 WorkQueue</code>：每个 ForkJoinWorkerThread 一开始会尝试从与其关联的 WorkQueue 中获取任务执行。如果该 WorkQueue 已空，即没有可执行的任务，那么 ForkJoinWorkerThread 会尝试从其他 ForkJoinWorkerThread 的 WorkQueue 中窃取任务来执行。</li><li>总的来说，ForkJoinPool 通过 workQueues 管理所有的 ForkJoinWorkerThread 及其对应的 WorkQueue，而 ForkJoinWorkerThread 则通过与其关联的 WorkQueue 来获取并执行任务。这是一种典型的工作窃取并发模型，它使得 ForkJoinPool 能够有效地并行处理共享任务负载，并提高处理效率。</li></ul></li></ul><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a target="_blank" rel="external nofollow" href="https://www.cnblogs.com/csguo/p/7588982.html">Java 的 Fork/Join 框架使用</a></li><li><a target="_blank" rel="external nofollow" href="https://www.jb51.net/program/290141vp2.htm">Java 并发工具 Fork/Join 原理</a></li><li><a target="_blank" rel="external nofollow" href="https://zhuanlan.zhihu.com/p/695819727">Fork/Join 框架与工作窃取算法详解</a></li><li><a target="_blank" rel="external nofollow" href="https://www.jb51.net/article/217991.htm">轻轻松松吃透 Java 并发 Fork/Join 框架</a></li><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/qq_26664043/article/details/135981628">深入理解 Java 中的 Fork/Join 框架原理</a></li></ul><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/4a0f41c0.html" title="Java 多线程编程之八 Fork/Join 框架使用">https://www.techgrow.cn/posts/4a0f41c0.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/Java/" rel="tag"><i class="fa fa-tag"></i> Java</a><a href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" rel="tag"><i class="fa fa-tag"></i> 并发编程</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/82a430bf.html" rel="prev" title="Maven 激活 SpringBoot 配置文件"><i class="fa fa-angle-left"></i> Maven 激活 SpringBoot 配置文件</a></div><div class="post-nav-item"> <a href="/posts/acac3139.html" rel="next" title="XXL-JOB 入门教程之一">XXL-JOB 入门教程之一<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">1.4m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">21:20</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤 ICP 备 19024664 号</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035 号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"/lib/mermaid/dist/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/app/api/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/app/api/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/4a0f41c0.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>