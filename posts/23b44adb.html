<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍 Sentinel 的进阶使用教程。"><meta property="og:type" content="article"><meta property="og:title" content="Sentinel 进阶教程 - 基础篇（2024 年）"><meta property="og:url" content="https://www.techgrow.cn/posts/23b44adb.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍 Sentinel 的进阶使用教程。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-4.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-5.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-6.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-9.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-8.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-7.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-10.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-11.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-12.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-13.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-14.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-16.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-15.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-17.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-18.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-19.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-21.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-22.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-23.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-24.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-25.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-26.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-27.png"><meta property="article:published_time" content="2024-02-03T14:33:05.000Z"><meta property="article:modified_time" content="2024-10-25T14:33:05.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="微服务"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2024/10/sentinel-1.png"><link rel="canonical" href="https://www.techgrow.cn/posts/23b44adb.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/23b44adb.html","path":"posts/23b44adb.html","title":"Sentinel 进阶教程 - 基础篇（2024 年）"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Sentinel 进阶教程 - 基础篇（2024 年） | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/app/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%98%E6%96%B9%E8%B5%84%E6%BA%90"><span class="nav-text">官方资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="nav-text">版本说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E4%B8%8B%E8%BD%BD"><span class="nav-text">代码下载</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="nav-text">流量控制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E4%BB%8B%E7%BB%8D"><span class="nav-text">流量控制介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="nav-text">流量控制的概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="nav-text">流量控制的类型</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#QPS-%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="nav-text">QPS 流量控制</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%B9%B6%E5%8F%91%E7%BA%BF%E7%A8%8B%E6%95%B0%E6%8E%A7%E5%88%B6"><span class="nav-text">并发线程数控制</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99%E4%BB%8B%E7%BB%8D"><span class="nav-text">流控规则介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E7%A7%8D%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F"><span class="nav-text">三种流控模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E6%B5%81%E6%8E%A7"><span class="nav-text">直接流控</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E6%B5%81%E6%8E%A7%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="nav-text">直接流控的概述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E6%B5%81%E6%8E%A7%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">直接流控的使用</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E8%81%94%E6%B5%81%E6%8E%A7"><span class="nav-text">关联流控</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%B3%E8%81%94%E6%B5%81%E6%8E%A7%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="nav-text">关联流控的概述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%B3%E8%81%94%E6%B5%81%E6%8E%A7%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">关联流控的使用</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%93%BE%E8%B7%AF%E6%B5%81%E6%8E%A7"><span class="nav-text">链路流控</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%93%BE%E8%B7%AF%E6%B5%81%E6%8E%A7%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="nav-text">链路流控的概述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%93%BE%E8%B7%AF%E6%B5%81%E6%8E%A7%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">链路流控的使用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E7%A7%8D%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C"><span class="nav-text">三种流控效果</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E5%A4%B1%E8%B4%A5"><span class="nav-text">快速失败</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E5%A4%B1%E8%B4%A5%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="nav-text">快速失败的概述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E5%A4%B1%E8%B4%A5%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">快速失败的使用</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Warm-Up"><span class="nav-text">Warm Up</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Warm-Up-%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="nav-text">Warm Up 的概述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Warm-Up-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">Warm Up 的使用</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%92%E9%98%9F%E7%AD%89%E5%BE%85"><span class="nav-text">排队等待</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8E%92%E9%98%9F%E7%AD%89%E5%BE%85%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="nav-text">排队等待的概述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8E%92%E9%98%9F%E7%AD%89%E5%BE%85%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">排队等待的使用</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C%E4%B8%8E%E5%B9%B6%E5%8F%91%E7%BA%BF%E7%A8%8B%E6%95%B0"><span class="nav-text">流控效果与并发线程数</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7"><span class="nav-text">熔断降级</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7%E4%BB%8B%E7%BB%8D"><span class="nav-text">熔断降级介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%86%94%E6%96%AD%E7%AD%96%E7%95%A5%E4%BB%8B%E7%BB%8D"><span class="nav-text">熔断策略介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%86%94%E6%96%AD%E8%A7%84%E5%88%99%E4%BB%8B%E7%BB%8D"><span class="nav-text">熔断规则介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E7%A7%8D%E7%86%94%E6%96%AD%E7%AD%96%E7%95%A5"><span class="nav-text">三种熔断策略</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%85%A2%E8%B0%83%E7%94%A8%E6%AF%94%E4%BE%8B"><span class="nav-text">慢调用比例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%85%A2%E8%B0%83%E7%94%A8%E6%AF%94%E4%BE%8B%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="nav-text">慢调用比例的概述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%85%A2%E8%B0%83%E7%94%A8%E6%AF%94%E4%BE%8B%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">慢调用比例的使用</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E6%AF%94%E4%BE%8B"><span class="nav-text">异常比例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E6%AF%94%E4%BE%8B%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="nav-text">异常比例的概述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E6%AF%94%E4%BE%8B%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">异常比例的使用</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E6%95%B0"><span class="nav-text">异常数</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E6%95%B0%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="nav-text">异常数的概述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E6%95%B0%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">异常数的使用</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">649</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">54</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/23b44adb.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Sentinel 进阶教程 - 基础篇（2024 年） | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍 Sentinel 的进阶使用教程。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Sentinel 进阶教程 - 基础篇（2024 年）</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-02-03 22:33:05" itemprop="dateCreated datePublished" datetime="2024-02-03T22:33:05+08:00">2024-02-03</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2024-10-25 22:33:05" itemprop="dateModified" datetime="2024-10-25T22:33:05+08:00">2024-10-25</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/23b44adb.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/23b44adb.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>9.6k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>9 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/8facd1ee.html">Sentinel 入门教程 - 基础篇（2020 年）</a></li><li><a href="/posts/e3c83db6.html">Sentinel 入门教程 - 中级篇（2020 年）</a></li><li><a href="/posts/63e3926c.html">Sentinel 入门教程 - 整合篇（2020 年）</a></li><li><a href="/posts/23b44adb.html">Sentinel 进阶教程 - 基础篇（2024 年）</a></li><li><a href="/posts/4fd0a683.html">Sentinel 进阶教程 - 中级篇（2024 年）</a></li><li><a href="/posts/cffb0959.html">Sentinel 进阶教程 - 整合篇（2024 年）</a></li></ul><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="官方资源"><a href="#官方资源" class="headerlink" title="官方资源"></a>官方资源</h3><ul><li><a target="_blank" rel="external nofollow" href="https://github.com/alibaba/Sentinel/wiki">Sentinel 官方文档</a></li><li><a target="_blank" rel="external nofollow" href="https://github.com/alibaba/Sentinel/tree/master/sentinel-demo">Sentinel 官方示例代码</a></li></ul><h3 id="版本说明"><a href="#版本说明" class="headerlink" title="版本说明"></a>版本说明</h3><p>在本文的所有案例中，各个组件统一使用以下版本：</p><table><thead><tr><th>组件</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td> Spring Boot</td><td>3.2.0</td><td></td></tr><tr><td>Spring Cloud</td><td>2023.0.0</td><td></td></tr><tr><td>Spring Cloud Alibaba</td><td>2022.0.0.0</td><td></td></tr><tr><td>Sentinel Dashboard</td><td>1.8.7</td><td></td></tr></tbody></table><span id="more"></span><h3 id="代码下载"><a href="#代码下载" class="headerlink" title="代码下载"></a>代码下载</h3><ul><li>本文完整的案例代码可以从 <a href="/downloads/2024/02/sentinel-common-demo.zip">这里</a> 下载得到。</li></ul><h2 id="流量控制"><a href="#流量控制" class="headerlink" title="流量控制"></a>流量控制</h2><div class="admonition note"><p class="admonition-title">官方文档</p><ul><li><a target="_blank" rel="external nofollow" href="https://github.com/alibaba/Sentinel/wiki/%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6">Sentinel - 流量控制</a></li></ul></div><h3 id="流量控制介绍"><a href="#流量控制介绍" class="headerlink" title="流量控制介绍"></a>流量控制介绍</h3><h4 id="流量控制的概述"><a href="#流量控制的概述" class="headerlink" title="流量控制的概述"></a>流量控制的概述</h4><p><strong>Sentinel 能够对流量进行控制，其原理是监控应用流量的 QPS 或并发线程数等指标，当达到指定的阈值时对流量进行控制，以避免被瞬时的流量高峰冲垮，从而保障应用的高可用性。</strong>FlowSlot 会根据预设的规则，结合 NodeSelectorSlot、ClusterBuilderSlot、StatisticSlot 统计出来的实时信息进行流量控制。限流的直接表现是在执行 <code>Entry nodeA = SphU.entry(resourceName)</code> 的时候抛出 FlowException 异常。FlowException 是 BlockException 的子类，开发者可以捕捉 BlockException 来自定义被限流之后的处理逻辑。</p><h4 id="流量控制的类型"><a href="#流量控制的类型" class="headerlink" title="流量控制的类型"></a>流量控制的类型</h4><p>Sentinel 的流量控制主要有两种统计类型，一种是统计 QPS，另外一种则是统计并发线程数。类型由 FlowRule 类的 <code>grade</code> 字段来定义。其中，<code>0</code> 代表根据并发线程数来限流，<code>1</code> 代表根据 QPS 来进行流量控制。其中并发线程数、QPS 值，都是由 StatisticSlot 类实时统计获取的。</p><ul><li>可以通过下面的命令查看某个资源的实时统计信息：</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:8719/cnode?id=resourceName</span><br></pre></td></tr></tbody></table></figure><ul><li>输出内容的格式如下：</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">idx id     thread  pass  blocked   success  total Rt   1m-pass   1m-block   1m-all   exception</span><br><span class="line">2   abc647    0     46      0         46      46   1     2763       0         2763     0</span><br></pre></td></tr></tbody></table></figure><ul><li><code>thread</code>： 代表当前处理该资源的并发数；</li><li><code>pass</code>： 代表一秒内到来到的请求；</li><li><code>blocked</code>： 代表一秒内被流量控制的请求数量；</li><li><code>success</code>： 代表一秒内成功处理完的请求；</li><li><code>total</code>： 代表到一秒内到来的请求以及被阻止的请求总和；</li><li><code>RT</code>： 代表一秒内该资源的平均响应时间；</li><li><code>1m-pass</code>： 则是一分钟内到来的请求；</li><li><code>1m-block</code>： 则是一分钟内被阻止的请求；</li><li><code>1m-all</code>： 则是一分钟内到来的请求和被阻止的请求的总和；</li><li><code>exception</code>： 则是一秒内业务本身异常的总和。</li></ul><h5 id="QPS-流量控制"><a href="#QPS-流量控制" class="headerlink" title="QPS 流量控制"></a>QPS 流量控制</h5><p>当 QPS 超过某个阈值的时候，则采取措施进行流量控制。流量控制的效果包括以下几种：快速失败、Warm Up、排队等待，对应 FlowRule 类中的 <code>controlBehavior</code> 字段。</p><div class="admonition note"><p class="admonition-title">特别注意</p><p>若使用除了直接拒绝之外的流量控制效果，则调用关系限流策略（Strategy）会被忽略（失效）。</p></div><h5 id="并发线程数控制"><a href="#并发线程数控制" class="headerlink" title="并发线程数控制"></a>并发线程数控制</h5><p>并发线程数控制用于保护业务线程池不被慢调用耗尽。例如，当应用所依赖的下游应用（服务提供者）由于某种原因导致服务不稳定、响应延迟增加，对于调用者来说，意味着吞吐量下降和更多的线程数占用，极端情况下甚至导致线程池耗尽。为应对太多线程占用的情况，业内有使用隔离的方案，比如通过不同业务逻辑使用不同线程池来隔离业务自身之间的资源争抢（线程池隔离）。这种隔离方案虽然隔离性比较好，但是代价就是线程数目太多，线程上下文切换的开销比较大，特别是对低延时的调用有比较大的影响。Sentinel 并发控制不负责创建和管理线程池，而是简单统计当前请求上下文的线程数目（正在执行的调用数目），如果超出阈值，新的请求会被立即拒绝，效果类似于信号量隔离。并发线程数控制通常在调用端（服务消费者）进行配置。</p><h3 id="流控规则介绍"><a href="#流控规则介绍" class="headerlink" title="流控规则介绍"></a>流控规则介绍</h3><p><strong>同一个资源可以创建多条限流规则，FlowSlot 会对该资源的所有限流规则依次遍历，直到有规则触发限流或者所有规则遍历完毕。</strong>一条限流规则主要由下面几个因素组成，开发者可以组合这些元素来实现不同的限流效果：</p><ul><li><code>resource</code>：资源名，即限流规则的作用对象</li><li><code>count</code>: 限流阈值</li><li><code>grade</code>: 限流阈值类型（QPS 或者并发线程数）</li><li><code>limitApp</code>: 流控针对的调用来源，若为 <code>default</code> 则不区分调用来源</li><li><code>strategy</code>: 调用关系限流策略</li><li><code>controlBehavior</code>: 流量控制效果（快速失败、Warm Up、排队等待）</li></ul><p>在 Sentinel 的控制台中，添加流控规则的步骤如下：</p><p><img data-src="../../../asset/2024/10/sentinel-1.png"></p><table><thead><tr><th>配置参数</th><th>配置说明</th></tr></thead><tbody><tr><td>资源名</td><td>资源的唯一名称，默认就可以是请求的接口路径（URL），可以自行修改。同一微服务应用内，资源名必须唯一。不同微服务应用之间，资源名可以重复。</td></tr><tr><td>针对来源</td><td>具体针对某个微服务进行限流，默认值为 <code>default</code>，表示不区分来源，全部限流。</td></tr><tr><td>阈值类型</td><td> QPS 表示通过 QPS 进行限流，并发线程数表示通过并发线程数限流。</td></tr><tr><td>单机阈值</td><td>与阈值类型组合使用。如果阈值类型选择的是 QPS，表示当调用接口的 QPS 达到阈值时，进行限流操作。如果阈值类型选择的是并发线程数，则表示当调用接口的并发线程数达到阈值时，进行限流操作。</td></tr><tr><td>是否集群</td><td>选中则表示集群环境，不选中则表示非集群环境。</td></tr></tbody></table><h3 id="三种流控模式"><a href="#三种流控模式" class="headerlink" title="三种流控模式"></a>三种流控模式</h3><p>Sentinel 提供三种流控模式，包括直接、关联、链路。</p><p><img data-src="../../../asset/2024/10/sentinel-2.png"></p><h4 id="直接流控"><a href="#直接流控" class="headerlink" title="直接流控"></a>直接流控</h4><h5 id="直接流控的概述"><a href="#直接流控的概述" class="headerlink" title="直接流控的概述"></a>直接流控的概述</h5><p>当接口达到限流条件时，直接开启限流功能，这是 Sentinel 默认的流控模式。</p><h5 id="直接流控的使用"><a href="#直接流控的使用" class="headerlink" title="直接流控的使用"></a>直接流控的使用</h5><ul><li>Java 接口代码</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示直接流控模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowLimitController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/testA")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultData&lt;String&gt; <span class="title">testA</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> ResultData.success(<span class="string">"----&gt; testA"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Sentinel 添加流控规则</li></ul><p><img data-src="../../../asset/2024/10/sentinel-3.png"></p><ul><li>当快速多次调用 <code>/testA</code> 接口时，会触发限流，并默认返回 <code>Blocked by Sentinel (flow limiting)</code> 的提示信息。</li></ul><h4 id="关联流控"><a href="#关联流控" class="headerlink" title="关联流控"></a>关联流控</h4><h5 id="关联流控的概述"><a href="#关联流控的概述" class="headerlink" title="关联流控的概述"></a>关联流控的概述</h5><p>当关联的资源达到访问阀值时，就限流当前接口。比如，当与 A 接口关联的 B 接口达到访问阀值后，就限流 A 接口自己。</p><div class="admonition note"><p class="admonition-title">具有关系的资源流量控制</p><p>当两个资源之间具有资源争抢或者依赖关系的时候，这两个资源便具有了关联。比如对数据库同一个字段的读操作和写操作存在争抢，读的速度过高会影响写得速度，写的速度过高会影响读的速度。如果放任读写操作争抢资源，则争抢本身带来的开销会降低整体的吞吐量。可使用关联限流来避免具有关联关系的资源之间过度的争抢，举例来说，<code>read_db</code> 和 <code>write_db</code> 这两个资源分别代表数据库读写，我们可以给 <code>read_db</code> 设置限流规则来达到写优先的目的：设置 <code>strategy</code> 为 <code>RuleConstant.STRATEGY_RELATE</code> 同时设置 <code>refResource</code> 为 <code>write_db</code>。这样当写库操作过于频繁时，读数据的请求会被限流。</p></div><h5 id="关联流控的使用"><a href="#关联流控的使用" class="headerlink" title="关联流控的使用"></a>关联流控的使用</h5><ul><li>Java 接口代码</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示关联流控模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowLimitController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/testA")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultData&lt;String&gt; <span class="title">testA</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> ResultData.success(<span class="string">"----&gt; testA"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/testB")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultData&lt;String&gt; <span class="title">testB</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> ResultData.success(<span class="string">"----&gt; testB"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Sentinel 添加流控规则</li></ul><p><img data-src="../../../asset/2024/10/sentinel-4.png"></p><ul><li>通过 JMeter 让多个线程并发调用 <code>/testB</code> 接口，然后再简单调用一次 <code>/testA</code> 接口，发现 <code>/testA</code> 接口会返回 <code>Blocked by Sentinel (flow limiting)</code> 的提示信息。这说明大量线程高并发访问 <code>/testB</code> 接口时，导致 <code>/testA</code> 接口也触发了限流。</li></ul><h4 id="链路流控"><a href="#链路流控" class="headerlink" title="链路流控"></a>链路流控</h4><h5 id="链路流控的概述"><a href="#链路流控的概述" class="headerlink" title="链路流控的概述"></a>链路流控的概述</h5><p>当来自不同链路的请求对同一个资源（目标接口）进行访问时，实施针对性的不同限流措施。比如，针对指定的 A 资源，C 请求来访问就限流，D 请求来访问就放行。</p><div class="admonition note"><p class="admonition-title">根据调用链路入口限流</p><p>NodeSelectorSlot 类中记录了资源之间的调用链路，这些资源通过调用关系，相互之间构成一棵调用树。这棵树的根节点是一个名字为 <code>machine-root</code> 的虚拟节点，调用链的入口都是这个虚拟节点的子节点。一棵典型的调用树如下图所示：</p></div><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">            machine-root</span><br><span class="line">              /       \</span><br><span class="line">             /         \</span><br><span class="line">       Entrance1     Entrance2</span><br><span class="line">          /             \</span><br><span class="line">         /               \</span><br><span class="line">DefaultNode(nodeA)   DefaultNode(nodeA)</span><br></pre></td></tr></tbody></table></figure><p>上图中来自入口 Entrance1 和 Entrance2 的请求都调用到了资源 NodeA，Sentinel 允许只根据某个入口的统计信息对资源限流。比如，可以设置 <code>strategy</code> 为 <code>RuleConstant.STRATEGY_CHAIN</code>，同时设置 <code>refResource</code> 为 Entrance1 来控制只有从入口 Entrance1 的调用才会记录到 NodeA 的限流统计当中，而不关心经 Entrance2 到来的调用。Sentinel 调用链的入口（上下文）是通过 API 方法 <code>ContextUtil.enter(contextName)</code> 定义的，其中 <code>contextName</code> 即对应调用链路入口名称。</p><h5 id="链路流控的使用"><a href="#链路流控的使用" class="headerlink" title="链路流控的使用"></a>链路流控的使用</h5><ul><li>Java 测试代码</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示链路流控模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowLimitController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FlowLimitService flowLimitService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/testC")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultData&lt;String&gt; <span class="title">testC</span><span class="params">()</span> </span>{</span><br><span class="line">        flowLimitService.common();</span><br><span class="line">        <span class="keyword">return</span> ResultData.success(<span class="string">"------testC"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/testD")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultData&lt;String&gt; <span class="title">testD</span><span class="params">()</span> </span>{</span><br><span class="line">        flowLimitService.common();</span><br><span class="line">        <span class="keyword">return</span> ResultData.success(<span class="string">"------testD"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示链路流控模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowLimitService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用注解定义 Sentinel 资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = "common")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">common</span><span class="params">()</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"------FlowLimitService come in"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>YML 配置内容，这里需要将 <code>web-context-unify</code> 参数为 <code>false</code></li></ul><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8858</span>       <span class="comment"># 配置 Sentinel Dashboard 控制台的访问地址</span></span><br><span class="line">      <span class="attr">web-context-unify:</span> <span class="literal">false</span>          <span class="comment"># 设置 Controller 层的方法对 Service 层的方法调用不认为是同一个根链路</span></span><br></pre></td></tr></tbody></table></figure><ul><li>Sentinel 添加流控规则</li></ul><p><img data-src="../../../asset/2024/10/sentinel-5.png"></p><ul><li>通过 JMeter 让多个线程并发调用 <code>/testC</code> 接口，发现 <code>/testC</code> 接口会返回 <code>Blocked by Sentinel (flow limiting)</code> 的提示信息，即 <code>/testC</code> 接口被 Sentinel 限流了。但是，同样让多个线程并发调用 <code>/testD</code> 接口，发现所有请求都可以被正常处理。简而言之，<code>/testC</code> 请求来访问 <code>common</code> 资源就限流，<code>/testD</code> 请求来访问 <code>common</code> 资源就放行。</li></ul><h3 id="三种流控效果"><a href="#三种流控效果" class="headerlink" title="三种流控效果"></a>三种流控效果</h3><p>Sentinel 有三种流控效果，包括快速失败、Warm Up、排队等待。</p><p><img data-src="../../../asset/2024/10/sentinel-6.png"></p><h4 id="快速失败"><a href="#快速失败" class="headerlink" title="快速失败"></a>快速失败</h4><h5 id="快速失败的概述"><a href="#快速失败的概述" class="headerlink" title="快速失败的概述"></a>快速失败的概述</h5><p>快速失败（直接拒绝）是默认的流量控制方式，当 QPS 超过任意规则的阈值后，新的请求就会被立即拒绝，拒绝方式为抛出 FlowException，并返回 <code>Blocked by Sentinel (flow limiting)</code> 提示信息。这种方式适用于对系统处理能力确切已知的情况下，比如通过压测确定了系统的准确水位时。</p><h5 id="快速失败的使用"><a href="#快速失败的使用" class="headerlink" title="快速失败的使用"></a>快速失败的使用</h5><ul><li>Java 接口代码</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示快速失败流控效果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowLimitController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/testA")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultData&lt;String&gt; <span class="title">testA</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> ResultData.success(<span class="string">"----&gt; testA"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Sentinel 添加流控规则</li></ul><p><img data-src="../../../asset/2024/10/sentinel-9.png"></p><ul><li>当多次调用 <code>/testA</code> 接口，发现 <code>/testA</code> 接口会返回 <code>Blocked by Sentinel (flow limiting)</code> 的提示信息，即 <code>/testA</code> 接口被 Sentinel 直接限流了。</li></ul><h4 id="Warm-Up"><a href="#Warm-Up" class="headerlink" title="Warm Up"></a>Warm Up</h4><h5 id="Warm-Up-的概述"><a href="#Warm-Up-的概述" class="headerlink" title="Warm Up 的概述"></a>Warm Up 的概述</h5><p>Warm Up 方式，即预热 / 冷启动方式。当系统长期处于低水位的情况下，如果流量突然增加，很可能直接把系统拉升到高水位，导致系统瞬间被压垮。通过 “冷启动”，让通过的流量缓慢增加，在一定时间内逐渐增加到阈值上限，给冷系统一个预热的时间，避免冷系统被压垮。这种方式适用于突发流量较大的场景，比如：秒杀系统在开启的瞬间，会有很多流量涌进来，很有可能把系统压垮，预热方式就是为了保护系统，慢慢地将流量放进来，慢慢地将阈值增长到预先设置的单机阈值。详细文档可以参考 <a target="_blank" rel="external nofollow" href="https://github.com/alibaba/Sentinel/wiki/%E9%99%90%E6%B5%81---%E5%86%B7%E5%90%AF%E5%8A%A8">流量控制 - Warm Up 官方文档</a>。</p><p><img data-src="../../../asset/2024/10/sentinel-8.png"></p><p>通常冷启动的过程系统允许通过的 QPS 曲线如上图所示。Sentinel 默认的冷却因子 <code>coldFactor</code> 为 3，即请求 QPS 从 <code>threshold / 3</code> 开始，经预热时长逐渐升至设定的 QPS 阈值。</p><div class="admonition note"><p class="admonition-title">限流 - 冷启动</p><p>当流量突然增大的时候，我们常常会希望系统从空闲状态到繁忙状态的切换的时间长一些。即如果系统在此之前长期处于空闲的状态，我们希望处理请求的数量是缓步的增多，经过预期的时间以后，到达系统处理请求个数的最大值。Warm Up（冷启动，预热）模式就是为了实现这个目的。这个场景主要用于启动需要额外开销的场景，比如建立数据库连接等。它的底层是在 <a target="_blank" rel="external nofollow" href="https://github.com/google/guava">Guava</a> 的算法的基础上实现的。然而，和 Guava 的场景不同，Guava 的场景主要用于调节请求的间隔，即 Leaky Bucket（漏桶），而 Sentinel 则主要用于控制每秒的 QPS，即满足每秒通过的 QPS 即可，不需要关注每个请求的间隔，换言之，Sentinel 更像一个 Token Bucket（令牌桶）。更详细的介绍，请参考 <a target="_blank" rel="external nofollow" href="https://github.com/alibaba/Sentinel/wiki/%E9%99%90%E6%B5%81---%E5%86%B7%E5%90%AF%E5%8A%A8">流量控制 - Warm Up 官方文档</a>。</p></div><h5 id="Warm-Up-的使用"><a href="#Warm-Up-的使用" class="headerlink" title="Warm Up 的使用"></a>Warm Up 的使用</h5><p>这里演示的案例为：单机阈值为 10，预热时长设置 5 秒。系统初始化的阈值为 <code>10 / 3</code> 约等于 3，即单机阈值刚开始为 3（人工设置的单机阈值是 10，Sentinel 计算后 QPS 判定为从 3 开始）；然后过了 5 秒后，阀值才慢慢升高并恢复到人工设置的单机阈值 10。</p><ul><li>Java 接口代码</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示 Warm Up 流控效果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowLimitController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/testA")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultData&lt;String&gt; <span class="title">testA</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> ResultData.success(<span class="string">"----&gt; testA"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Sentinel 添加流控规则</li></ul><p><img data-src="../../../asset/2024/10/sentinel-7.png"></p><ul><li>刚开始多次调用 <code>/testA</code> 接口，发现 <code>/testA</code> 接口会返回 <code>Blocked by Sentinel (flow limiting)</code> 的提示信息，即 <code>/testA</code> 接口被 Sentinel 限流了。过了 5 秒后，接口慢慢可以被更多的请求正常调用，直到达到单机阀值 10。</li></ul><h4 id="排队等待"><a href="#排队等待" class="headerlink" title="排队等待"></a>排队等待</h4><h5 id="排队等待的概述"><a href="#排队等待的概述" class="headerlink" title="排队等待的概述"></a>排队等待的概述</h5><p>排队等待（匀速排队）方式会严格控制请求通过的间隔时间，也即是让请求以均匀的速度通过，对应的是漏桶算法，详细文档可以参考 <a target="_blank" rel="external nofollow" href="https://github.com/alibaba/Sentinel/wiki/%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6-%E5%8C%80%E9%80%9F%E6%8E%92%E9%98%9F%E6%A8%A1%E5%BC%8F">流量控制 - 匀速器模式</a>。这种方式主要用于处理间隔性突发的流量，比如消息队列。想象一下这样的场景，在某一秒有大量的请求到来，而接下来的几秒则处于空闲状态，我们希望系统能够在接下来的空闲期间逐渐处理这些请求，而不是在第一秒直接拒绝多余的请求。Sentinel 匀速排队等待策略是漏桶算法结合虚拟队列等待机制实现的。<strong>特别注意，匀速排队模式暂时不支持 QPS 大于 1000 的场景。</strong></p><p><img data-src="../../../asset/2024/10/sentinel-10.png"></p><h5 id="排队等待的使用"><a href="#排队等待的使用" class="headerlink" title="排队等待的使用"></a>排队等待的使用</h5><p>这里演示的案例为：设置单机阀值为 1，即一秒钟只允许通过一个请求；设置超时时间为 10 秒，即 10 秒内还可以有 <code>10 * threshold</code> 个（这里也就是 10 个）请求排队等待被处理，而 10 秒后所有未被处理的请求都作为超时处理（放弃处理）。</p><ul><li>Java 接口代码</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示排队等待流控效果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowLimitController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/testE")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultData&lt;String&gt; <span class="title">testE</span><span class="params">()</span> </span>{</span><br><span class="line">        System.out.println(System.currentTimeMillis() + <span class="string">" testE 成功调用"</span>);</span><br><span class="line">        <span class="keyword">return</span> ResultData.success(<span class="string">"------testE"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Sentinel 添加流控规则</li></ul><p><img data-src="../../../asset/2024/10/sentinel-11.png"></p><ul><li>通过 JMeter 在 1 秒内启动 20 个线程（请求）来调用 <code>/testE</code> 接口</li></ul><p><img data-src="../../../asset/2024/10/sentinel-12.png"></p><ul><li>控制台打印日志显示有 11 个请求调用成功</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1729762031993 testE 成功调用</span><br><span class="line">1729762032994 testE 成功调用</span><br><span class="line">1729762033993 testE 成功调用</span><br><span class="line">1729762034993 testE 成功调用</span><br><span class="line">1729762035993 testE 成功调用</span><br><span class="line">1729762036993 testE 成功调用</span><br><span class="line">1729762037993 testE 成功调用</span><br><span class="line">1729762038993 testE 成功调用</span><br><span class="line">1729762039993 testE 成功调用</span><br><span class="line">1729762040994 testE 成功调用</span><br><span class="line">1729762041993 testE 成功调用</span><br></pre></td></tr></tbody></table></figure><ul><li>JMeter 显示有 9 个请求未被处理</li></ul><p><img data-src="../../../asset/2024/10/sentinel-13.png"></p><h4 id="流控效果与并发线程数"><a href="#流控效果与并发线程数" class="headerlink" title="流控效果与并发线程数"></a>流控效果与并发线程数</h4><p>特别注意，在添加流控规则时，如果选择的 <code>阀值类型</code> 是 “并发线程数”，那么默认的 <code>流控效果</code> 就是 “快速失败”，而且不能选择 “Warm Up” 和 “排队等待” 这两种流控效果。</p><p><img data-src="../../../asset/2024/10/sentinel-14.png"></p><div class="admonition note"><p class="admonition-title">提示</p><p>使用 JMeter 模拟多个线程 + 循环来调用接口时，JMeter 会将接口打满，我们自己手动发送的大部分请求都无法被处理；但是偶尔会因 JMeter 发生线程切换，导致系统判断为没访问量，这时候我们自己手动发送的请求才可以得到正常处理。简而言之，在添加流控规则的时候，通常会选择 <code>阀值类型</code> 为 "QPS"，而不是选择 "并发线程数"，因为基于 <code>QPS</code> 的流量控制更精准。</p></div><h2 id="熔断降级"><a href="#熔断降级" class="headerlink" title="熔断降级"></a>熔断降级</h2><div class="admonition note"><p class="admonition-title">官方文档</p><ul><li><a target="_blank" rel="external nofollow" href="https://github.com/alibaba/Sentinel/wiki/%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7">Sentinel - 熔断降级</a></li></ul></div><h3 id="熔断降级介绍"><a href="#熔断降级介绍" class="headerlink" title="熔断降级介绍"></a>熔断降级介绍</h3><p>除了流量控制以外，对调用链路中不稳定的资源进行熔断降级也是保障高可用的重要措施之一。一个服务常常会调用别的模块，可能是另外的一个远程服务、数据库，或者第三方 API 等。例如，支付的时候，可能需要远程调用银联提供的 API；查询某个商品的价格，可能需要进行数据库查询。然而，这个被依赖服务的稳定性是不能保证的。如果依赖的服务出现了不稳定的情况，请求的响应时间变长，那么调用服务的方法的响应时间也会变长，线程会产生堆积，最终可能耗尽业务自身的线程池，服务本身也变得不可用。</p><p><img data-src="../../../asset/2024/10/sentinel-16.png"></p><p>现代微服务架构都是分布式的，由非常多的服务组成。不同服务之间相互调用，组成复杂的调用链路。以上的问题在链路调用中会产生放大的效果，复杂链路上的某一环不稳定，就可能会层层级联，最终导致整个链路都不可用。因此需要对不稳定的弱依赖服务调用进行熔断降级，暂时切断不稳定调用，避免局部不稳定因素导致整体的服务雪崩。<strong>值得一提的是，熔断降级作为保护自身的手段，通常在调用端（服务消费者）进行配置或实现。</strong></p><div class="admonition warning"><p class="admonition-title">特别注意</p><p>本文针对 Sentinel <code>1.8.0</code> 及以上版本进行编写。由于 Sentinel <code>1.8.0</code> 版本对熔断降级特性进行了全新的改进升级，请使用最新版本以更好地利用熔断降级的能力。</p></div><h3 id="熔断策略介绍"><a href="#熔断策略介绍" class="headerlink" title="熔断策略介绍"></a>熔断策略介绍</h3><p>Sentinel 熔断降级会在调用链路中某个资源出现不稳定状态时（比如调用超时、异常比例升高），对这个资源的调用进行限制，目的是让请求快速失败，避免影响到其它的资源而导致级联故障。当资源被降级后，在接下来的降级时间窗口内，对该资源的调用都自动熔断（默认行为是抛出 DegradeException）。Sentinel 提供以下几种熔断策略：</p><ul><li><p><strong>慢调用比例（SLOW_REQUEST_RATIO）</strong>：选择以慢调用比例作为阈值，需要设置允许的慢调用 RT（即最大的响应时间），请求的响应时间大于该值则统计为慢调用。当单位统计时长（<code>statIntervalMs</code>）内请求数目大于设置的最小请求数目，并且慢调用的比例大于阈值，则在接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求响应时间小于设置的慢调用 RT 则结束熔断状态（恢复正常），若大于设置的慢调用 RT 则会再次被熔断。</p></li><li><p><strong>异常比例（ERROR_RATIO）</strong>：当单位统计时长（<code>statIntervalMs</code>）内请求数目大于设置的最小请求数目，并且异常的比例大于阈值，则在接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断状态（恢复正常），否则会再次进入熔断状态。异常比率的阈值范围是 <code>[0.0, 1.0]</code>，代表 <code>0% - 100%</code>。</p></li><li><p><strong>异常数（ERROR_COUNT）</strong>：当单位统计时长（<code>statIntervalMs</code>）内请求数目大于设置的最小请求数目，并且异常数量大于阈值，则在接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断状态（恢复正常），否则会再次进入熔断状态。</p></li></ul><div class="admonition warning"><p class="admonition-title">特别注意</p><ul><li>异常降级仅针对业务异常，对 Sentinel 限流降级本身的异常（BlockException）不生效。为了统计异常比例或异常数，需要调用 <code>Tracer.trace(ex)</code> 记录业务异常。</li><li>对于开源整合模块，如 Sentinel Dubbo Adapter、Sentinel Web Servlet Filter 或者 <code>@SentinelResource</code> 注解会自动统计业务异常，无需手动调用 <code>Tracer.trace(ex)</code> 记录业务异常。</li></ul></div><h3 id="熔断规则介绍"><a href="#熔断规则介绍" class="headerlink" title="熔断规则介绍"></a>熔断规则介绍</h3><p>熔断规则（DegradeRule）包含下面几个重要的属性：</p><table><thead><tr><th>属性</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td> resource</td><td> 资源名，即规则的作用对象</td><td></td></tr><tr><td> grade</td><td> 熔断策略，支持慢调用比例 / 异常比例 / 异常数策略</td><td>慢调用比例</td></tr><tr><td> count</td><td> 慢调用比例模式下为慢调用临界 RT（超出该阀值则认为是慢调用）；异常比例 / 异常数模式下为对应的阈值</td><td></td></tr><tr><td> timeWindow</td><td> 熔断时长，单位为秒</td><td></td></tr><tr><td> minRequestAmount</td><td> 熔断触发的最小请求数，请求数小于该值时即使异常比率超出阈值也不会熔断（从 1.7.0 版本开始引入）</td><td>5</td></tr><tr><td>statIntervalMs</td><td> 统计时长（单位为 ms），如 <code>60 * 1000</code> 代表分钟级（从 1.8.0 版本开始引入）</td><td>1000 ms</td></tr><tr><td>slowRatioThreshold</td><td> 慢调用比例阈值，仅慢调用比例模式有效（从 1.8.0 版本开始引入）</td><td></td></tr></tbody></table><p>在 Sentinel 的控制台中，添加熔断规则的步骤如下：</p><p><img data-src="../../../asset/2024/10/sentinel-15.png"></p><h3 id="三种熔断策略"><a href="#三种熔断策略" class="headerlink" title="三种熔断策略"></a>三种熔断策略</h3><h4 id="慢调用比例"><a href="#慢调用比例" class="headerlink" title="慢调用比例"></a>慢调用比例</h4><h5 id="慢调用比例的概述"><a href="#慢调用比例的概述" class="headerlink" title="慢调用比例的概述"></a>慢调用比例的概述</h5><p>选择以慢调用比例作为阈值，需要设置允许的慢调用 RT（即最大的响应时间），请求的响应时间大于该值则统计为慢调用。当单位统计时长（<code>statIntervalMs</code>）内请求数目大于设置的最小请求数目，并且慢调用的比例大于阈值，则在接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求响应时间小于设置的慢调用 RT 则结束熔断状态（恢复正常），若大于设置的慢调用 RT 则会再次被熔断。</p><blockquote><p>Sentinel 进入熔断状态的判断依据：在统计时长内，实际请求数目 &gt; 设定的最小请求数，且实际慢调用比例 &gt; 比例阈值，开始进入熔断状态。</p></blockquote><p><img data-src="../../../asset/2024/10/sentinel-17.png"></p><p>术语说明：</p><ul><li><code>调用</code>：一个请求发送到服务器，服务器返回响应，一个响应就是一个调用。</li><li><code>最大 RT</code>：即请求的最大响应时间，指系统对请求作出响应的最大业务处理时间。</li><li><code>慢调用</code>：处理业务逻辑的实际时间 &gt; 设置的最大 RT 时间，这个调用就叫做慢调用。</li><li><code>比例阈值</code>：即慢调用比例阀值，慢调用占有实际的比例 = 慢调用次数 ➗ 总调用次数</li><li><code>熔断时长</code>：触发熔断后，控制多长时间内都处于熔断状态</li><li><code>统计时长</code>：采集统计样本数据的时间</li><li><code>最小请求数</code>：熔断触发的最小请求数，请求数小于该值时即使慢调用比例超出阈值也不会熔断</li></ul><p>状态切换：</p><ul><li>熔断状态（类似保险丝跳闸断电，不可访问）：在指定的熔断时长内，请求会自动被熔断。</li><li>探测恢复状态（HALF-OPEN 状态）：在熔断时长结束后，会进入探测恢复状态。</li><li>结束熔断（类似保险丝闭合恢复，可以访问）：在探测恢复状态下，如果接下来的一个请求响应时间小于设置的慢调用 RT，则结束熔断状态，否则继续熔断。</li></ul><h5 id="慢调用比例的使用"><a href="#慢调用比例的使用" class="headerlink" title="慢调用比例的使用"></a>慢调用比例的使用</h5><ul><li>Java 接口代码</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示熔断规则-慢调用比例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowLimitController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/testF")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultData&lt;String&gt; <span class="title">testF</span><span class="params">()</span> </span>{</span><br><span class="line">         <span class="comment">// 暂停1秒，模拟业务处理耗时</span></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> ResultData.success(<span class="string">"------testF 新增熔断规则-慢调用比例"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Sentinel 添加熔断规则</li></ul><p><img data-src="../../../asset/2024/10/sentinel-18.png"></p><ul><li>通过 JMeter 在 1 秒内启动 10 个线程（请求）来调用 <code>/testF</code> 接口，按照上面的 Java 代码和 Sentinel 熔断规则配置，会触发熔断</li></ul><p><img data-src="../../../asset/2024/10/sentinel-19.png"></p><ul><li>当进入熔断状态期间（5 秒内），单独用浏览器访问 <code>/testF</code> 接口，发现接口会返回 <code>Blocked by Sentinel (flow limiting)</code> 提示信息，说明接口被熔断了</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Blocked by Sentinel (flow limiting)</span><br></pre></td></tr></tbody></table></figure><ul><li>当结束熔断状态后（5 秒后），再次通过 JMeter 在 1 秒内启动 10 个线程（请求）来调用 <code>/testF</code> 接口，由于熔断器处于探测恢复状态（允许放行一个请求来探测服务是否恢复正常），只有 1 个请求可以正常调用 <code>/testF</code> 接口，剩余的 9 个请求都调用失败</li></ul><p><img data-src="../../../asset/2024/10/sentinel-21.png"></p><h4 id="异常比例"><a href="#异常比例" class="headerlink" title="异常比例"></a>异常比例</h4><h5 id="异常比例的概述"><a href="#异常比例的概述" class="headerlink" title="异常比例的概述"></a>异常比例的概述</h5><p>当单位统计时长（<code>statIntervalMs</code>）内请求数目大于设置的最小请求数目，并且异常的比例大于阈值，则在接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断状态（恢复正常），否则会再次进入熔断状态。异常比率的阈值范围是 <code>[0.0, 1.0]</code>，代表 <code>0% - 100%</code>。</p><div class="admonition warning"><p class="admonition-title">特别注意</p><p>在使用异常比例熔断规则时，要检查一下项目中是否有全局异常处理器，如果业务异常被全局异常处理器捕获处理了，那么即使 Sentinel 配置了熔断规则，接口也不会有熔断效果。</p></div><h5 id="异常比例的使用"><a href="#异常比例的使用" class="headerlink" title="异常比例的使用"></a>异常比例的使用</h5><ul><li>Java 接口代码</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示熔断规则-异常比例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowLimitController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/testG")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testG</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">int</span> age = <span class="number">10</span> / <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"------testG 新增熔断规则-异常比例"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Sentinel 添加熔断规则</li></ul><p><img data-src="../../../asset/2024/10/sentinel-22.png"></p><ul><li>通过 JMeter 在 1 秒内启动 10 个线程（请求）来调用 <code>/testG</code> 接口，按照上面的 Java 代码和 Sentinel 熔断规则配置，会触发熔断</li></ul><p><img data-src="../../../asset/2024/10/sentinel-23.png"></p><ul><li>当进入熔断状态期间（5 秒内），单独用浏览器访问 <code>/testG</code> 接口，发现接口会返回 <code>Blocked by Sentinel (flow limiting)</code> 提示信息，说明接口被熔断了</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Blocked by Sentinel (flow limiting)</span><br></pre></td></tr></tbody></table></figure><ul><li>当结束熔断状态后（5 秒后），单独用浏览器访问 <code>/testG</code> 接口，由于熔断器处于探测恢复状态（允许放行一个请求来探测服务是否恢复正常），所以该请求可以正常调用 <code>/testG</code> 接口，同时接口会返回错误页面内容（如下图所示），这是因为在调用 <code>/testG</code> 接口时抛出了异常</li></ul><p><img data-src="../../../asset/2024/10/sentinel-24.png"></p><h4 id="异常数"><a href="#异常数" class="headerlink" title="异常数"></a>异常数</h4><h5 id="异常数的概述"><a href="#异常数的概述" class="headerlink" title="异常数的概述"></a>异常数的概述</h5><p>当单位统计时长（<code>statIntervalMs</code>）内请求数目大于设置的最小请求数目，并且异常数量大于阈值，则在接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断状态（恢复正常），否则会再次进入熔断状态。</p><h5 id="异常数的使用"><a href="#异常数的使用" class="headerlink" title="异常数的使用"></a>异常数的使用</h5><ul><li>Java 接口代码</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示熔断规则-异常数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowLimitController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/testH")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testH</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">int</span> age = <span class="number">10</span> / <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"------testH 新增熔断规则-异常数 "</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>Sentinel 添加熔断规则</li></ul><p><img data-src="../../../asset/2024/10/sentinel-25.png"></p><ul><li>通过 JMeter 在 1 秒内启动 10 个线程（请求）来调用 <code>/testH</code> 接口，按照上面的 Java 代码和 Sentinel 熔断规则配置，会触发熔断</li></ul><p><img data-src="../../../asset/2024/10/sentinel-26.png"></p><ul><li>当进入熔断状态期间（5 秒内），单独用浏览器访问 <code>/testH</code> 接口，发现接口会返回 <code>Blocked by Sentinel (flow limiting)</code> 提示信息，说明接口被熔断了</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Blocked by Sentinel (flow limiting)</span><br></pre></td></tr></tbody></table></figure><ul><li>当结束熔断状态后（5 秒后），单独用浏览器访问 <code>/testH</code> 接口，由于熔断器处于探测恢复状态（允许放行一个请求来探测服务是否恢复正常），所以该请求可以正常调用 <code>/testH</code> 接口，同时接口会返回错误页面内容（如下图所示），这是因为在调用 <code>/testH</code> 接口时抛出了异常</li></ul><p><img data-src="../../../asset/2024/10/sentinel-27.png"></p><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/23b44adb.html" title="Sentinel 进阶教程 - 基础篇（2024 年）">https://www.techgrow.cn/posts/23b44adb.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="fa fa-tag"></i> 微服务</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/905c65b7.html" rel="prev" title="Micrometer 入门教程 - 基础篇"><i class="fa fa-angle-left"></i> Micrometer 入门教程 - 基础篇</a></div><div class="post-nav-item"> <a href="/posts/4fd0a683.html" rel="next" title="Sentinel 进阶教程 - 中级篇（2024 年）">Sentinel 进阶教程 - 中级篇（2024 年）<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">1.6m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">24:18</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤 ICP 备 19024664 号</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035 号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"/lib/mermaid/dist/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/app/api/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/app/api/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/23b44adb.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>