<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍 Muduo 网络编程使用，包括 TCP 客户端和服务端的使用、线程池、日志级别等。"><meta property="og:type" content="article"><meta property="og:title" content="C++ 网络编程 Muduo 库使用"><meta property="og:url" content="https://www.techgrow.cn/posts/def1afc3.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍 Muduo 网络编程使用，包括 TCP 客户端和服务端的使用、线程池、日志级别等。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/05/cxxx-muduo-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/06/muduo-arch-1.png"><meta property="article:published_time" content="2025-02-03T13:55:33.000Z"><meta property="article:modified_time" content="2025-02-03T13:55:33.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="Linux系统编程"><meta property="article:tag" content="C++"><meta property="article:tag" content="网络编程"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2025/05/cxxx-muduo-1.png"><link rel="canonical" href="https://www.techgrow.cn/posts/def1afc3.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/def1afc3.html","path":"posts/def1afc3.html","title":"C++ 网络编程 Muduo 库使用"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>C++ 网络编程 Muduo 库使用 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%BA%90"><span class="nav-text">学习资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="nav-text">版本说明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Muduo-%E7%9A%84%E4%BB%8B%E7%BB%8D"><span class="nav-text">Muduo 的介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C-I-O-%E6%A8%A1%E5%9E%8B"><span class="nav-text">网络 I/O 模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Muduo-%E7%9A%84%E7%AE%80%E4%BB%8B"><span class="nav-text">Muduo 的简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Muduo-%E7%9A%84-Reactor-%E6%A8%A1%E5%9E%8B"><span class="nav-text">Muduo 的 Reactor 模型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Muduo-%E7%9A%84%E5%AE%89%E8%A3%85"><span class="nav-text">Muduo 的安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-Boost-%E5%BA%93"><span class="nav-text">安装 Boost 库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-Muduo-%E5%BA%93"><span class="nav-text">安装 Muduo 库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Muduo-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">Muduo 的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Muduo-%E7%9A%84%E9%93%BE%E6%8E%A5%E6%AD%A5%E9%AA%A4%E8%AF%B4%E6%98%8E"><span class="nav-text">Muduo 的链接步骤说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-Muduo-%E7%9A%84%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F"><span class="nav-text">使用 Muduo 的日志系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-TCP-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="nav-text">实现 TCP 客户端和服务端</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#TCP-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="nav-text">TCP 服务端代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TCP-%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="nav-text">TCP 客户端代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TCP-%E8%BF%9E%E6%8E%A5%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="nav-text">TCP 连接测试代码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-Muduo-%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1"><span class="nav-text">使用 Muduo 的线程池执行任务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Muduo-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E4%BB%8B%E7%BB%8D"><span class="nav-text">Muduo 线程池的介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Muduo-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">Muduo 线程池的使用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Muduo-%E7%9A%84%E5%8E%9F%E7%90%86"><span class="nav-text">Muduo 的原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E7%B1%BB%E5%9B%BE"><span class="nav-text">整体类图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="nav-text">整体架构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#base-%E6%A8%A1%E5%9D%97"><span class="nav-text">base 模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#net-%E6%A8%A1%E5%9D%97"><span class="nav-text">net 模块</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E8%AE%BE%E8%AE%A1"><span class="nav-text">整体设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#EventLoop"><span class="nav-text">EventLoop</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#TimerQueue"><span class="nav-text">TimerQueue</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Poller-%E6%8A%BD%E8%B1%A1%E7%B1%BB"><span class="nav-text">Poller 抽象类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97"><span class="nav-text">任务队列</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Channel-%E4%BA%8B%E4%BB%B6%E5%8C%85%E8%A3%85%E5%99%A8"><span class="nav-text">Channel 事件包装器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Socket-%E5%B0%81%E8%A3%85%E7%B1%BB"><span class="nav-text">Socket 封装类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TcpConnection-%E6%8A%BD%E8%B1%A1%E7%B1%BB"><span class="nav-text">TcpConnection 抽象类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Acceptor-%E8%BF%9E%E6%8E%A5%E6%8E%A5%E6%94%B6%E5%99%A8"><span class="nav-text">Acceptor 连接接收器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Connector-%E5%92%8C-TcpClient"><span class="nav-text">Connector 和 TcpClient</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">711</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">53</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/def1afc3.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="C++ 网络编程 Muduo 库使用 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍 Muduo 网络编程使用，包括 TCP 客户端和服务端的使用、线程池、日志级别等。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> C++ 网络编程 Muduo 库使用</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2025-02-03 21:55:33" itemprop="dateCreated datePublished" datetime="2025-02-03T21:55:33+08:00">2025-02-03</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/def1afc3.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/def1afc3.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>7.1k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>6 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/def1afc3.html">C++ 网络编程 Muduo 库使用</a></li><li><a href="/posts/e635f0aa.html">基于 C++ 开发集群聊天服务器</a></li><li><a href="/posts/5e6aa28a.html">C++ 实现 RPC 分布式网络通信框架</a></li><li><a href="/posts/dbb10768.html">基于 C++ 手写高性能网络库（Muduo）</a></li></ul><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文将介绍 Muduo 网络库的使用，在使用 Muduo 之前，建议先熟悉并掌握以下技术内容：</p><ul><li>熟悉 C++ 11 语法</li><li>掌握事件驱动模型（Reactor 模式）</li><li>熟悉 C/C++ 多线程并发和线程安全设计</li><li>熟悉 Linux 网络编程（如使用 <code>epoll</code>、<code>socket</code>）</li></ul><span id="more"></span><h3 id="学习资源"><a href="#学习资源" class="headerlink" title="学习资源"></a>学习资源</h3><ul><li><a target="_blank" rel="external nofollow" href="https://github.com/chenshuo/muduo">Muduo 的 GitHub 项目</a></li><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/Solstice">Muduo 作者的 CSDN 博客</a></li></ul><h3 id="版本说明"><a href="#版本说明" class="headerlink" title="版本说明"></a>版本说明</h3><p>本文使用的各软件版本如下：</p><table><thead><tr><th>软件</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td> C++</td><td><code>11</code></td><td></td></tr><tr><td>Muduo</td><td><code>2.0.2</code></td><td></td></tr><tr><td>Linux</td><td><code>Debian 12</code></td><td>Muduo 只支持 Linux 平台，不支持 Windows 平台</td></tr></tbody></table><h2 id="Muduo-的介绍"><a href="#Muduo-的介绍" class="headerlink" title="Muduo 的介绍"></a>Muduo 的介绍</h2><h3 id="网络-I-O-模型"><a href="#网络-I-O-模型" class="headerlink" title="网络 I/O 模型"></a>网络 I/O 模型</h3><p>主流的网络 I/O 模型有以下几种，Muduo 采用的是第四种（<code>reactors in threads - one loop per thread</code>）。</p><ul><li><p>(1) <code>accept + read/write</code></p><ul><li>不适用于并发服务器</li></ul></li><li><p> (2) <code>accept + fork - process-pre-connection</code></p><ul><li>适合并发连接数不大，计算任务工作量大于 Fork 的开销。</li></ul></li><li><p>(3) <code>accept + thread - thread-pre-connection</code></p><ul><li>比第二种网络 I/O 模型的开销小了一点，但是并发造成的线程堆积过多。</li></ul></li><li><p>(4) <code>reactors in threads - one loop per thread</code></p><ul><li>这是 Muduo 库的网络设计方案，底层实质上是基于 Linux 的 <code>epoll</code> + <code>pthread</code> 线程池实现，且依赖了 Boost 库，适用于并发连接数较大的场景。</li><li>有一个 Main Reactor 负载 Accept 连接，然后将连接分发给某个 SubReactor（采用轮询的方式来选择 SubReactor），该连接的所用操作都在那个 SubReactor 所处的线程中完成。多个连接可能被分派到多个线程中被处理，以充分利用 CPU。</li><li>有一个 Base I/O Thread 负责 Accept 新的连接，接收到新的连接以后，使用轮询的方式在 Reactor Pool 中找到合适的 SubReactor 将这个连接挂载上去，这个连接上的所有任务都在这个 SubReactor 所处的线程中完成。</li><li>Reactor Poll 的大小是固定的，根据 CPU 的核心数量来确定。如果有过多的耗费 CPU 资源的计算任务，可以提交到 ThreadPool 线程池中专门处理耗时的计算任务。</li></ul></li><li><p>(5) <code>reactors in process - one loop pre process</code></p><ul><li>这是 Nginx 服务器的网络设计方案，基于进程设计，采用多个 Reactors 充当 I/O 进程和工作进程，通过一个 <code>accept</code> 锁，完美解决多个 Reactors 之间的 “惊群现象”。</li></ul></li></ul><h3 id="Muduo-的简介"><a href="#Muduo-的简介" class="headerlink" title="Muduo 的简介"></a>Muduo 的简介</h3><p>Muduo 是一个用 C++ 编写的高性能、基于事件驱动的网络库，专门设计用于构建 Linux 下高并发、低延迟的网络服务，特别适合开发分布式系统、微服务、消息中间件、网络游戏服务器等后端程序。</p><ul><li><p>核心特性</p><ul><li>基于事件驱动模型：使用 Reactor 模式，即单线程 I/O + 多线程计算。</li><li>高性能：使用 <code>epoll</code> I/O 多路复用技术、非阻塞 I/O、零内存拷贝技术。</li><li>线程安全：网络部分是线程安全的，使用线程池和回调。</li><li>C++ 11 标准：需要使用支持 C++ 11 的编译器。</li><li>仅支持 Linux 平台：利用 Linux 特性优化性能，不支持跨平台。</li><li>可组合性强：解耦的模块设计，便于扩展和组合。</li></ul></li><li><p>核心模块</p><ul><li><code>base</code>（基础模块）<ul><li>非网络相关的通用工具</li><li>如线程池、时间戳、日志系统、原子操作等</li></ul></li><li><code>net</code>（网络模块）<ul><li>TCP 服务器 / 客户端模型</li><li> Reactor 事件分发器</li><li> Buffer、Channel、EventLoop、TcpConnection 等核心组件</li></ul></li></ul></li><li><p>核心组件</p><ul><li>EventLoop<ul><li> 事件循环，是每个线程的核心对象</li><li>封装了 <code>epoll</code> 库，处理文件描述符的读写事件</li></ul></li><li> Channel<ul><li> 表示一个 <code>fd</code>（文件描述符）及其感兴趣的事件（如读写）</li><li>是 EventLoop 与具体 I/O 事件之间的桥梁</li></ul></li><li> Poller<ul><li> 封装 <code>epoll</code> 或 <code>poll</code> 的接口（Muduo 默认用 <code>epoll</code>）</li></ul></li><li>TcpServer / TcpClient<ul><li> 高层封装，简化服务端和客户端的使用</li><li>支持多线程连接处理</li></ul></li><li> Callback 机制<ul><li>所有 I/O 事件都通过用户注册的回调函数处理（高扩展性）</li></ul></li></ul></li><li><p>性能优势</p><ul><li>完全采用非阻塞、异步 I/O 模型</li><li>使用智能指针管理资源（如 <code>std::shared_ptr&lt;TcpConnection&gt;</code>）</li><li>零内存拷贝的数据缓冲机制（Buffer）</li><li>合理利用多线程资源（EventLoopThreadPool）</li></ul></li><li><p>适用场景</p><ul><li>高并发 TCP 服务器（如 Redis、MQTT、游戏网关）</li><li>微服务通信框架（可自定义通信协议）</li><li>高性能 HTTP 服务（支持 HTTP 1.0/1.1）</li><li>自研 RPC 系统</li></ul></li></ul><div class="admonition warning"><p class="admonition-title">平台兼容性</p><ul><li>Muduo 库只支持 Linux 平台，不兼容 Windows 平台，因为其底层使用了 Linux 平台的 <code>pthread</code> 和 <code>epoll</code>。</li></ul></div><h3 id="Muduo-的-Reactor-模型"><a href="#Muduo-的-Reactor-模型" class="headerlink" title="Muduo 的 Reactor 模型"></a>Muduo 的 Reactor 模型</h3><blockquote><p>The reactor design pattern is an event handling pattern for handling service requests delivered concurrently to a service handler by one or more inputs.<br>The service handler then demultiplexes the incoming requests and dispatches them synchronously to the associated request handlers.</p></blockquote><p>从上面的描述，可以看出以下关键点：</p><ul><li>事件驱动处理</li><li>可以处理一个或多个输入源</li><li>通过 Service Handler 同步地将输入事件（Event）采用多路复用分发给相应的 RequestHandler（多个）来处理</li></ul><p><img data-src="../../../asset/2025/05/cxxx-muduo-1.png"></p><div class="admonition note"><p class="admonition-title">学习建议</p><p>建议阅读 Muduo 的源码，从 <code>TcpServer</code> 的 <code>start()</code> 方法开始，阅读一下 Muduo 的底层源码实现，理解 MainReactor 和 SubReactor 的工作原理，这样有利于应付 Muduo 相关的面试问题，也能更深入的去表达 Muduo 相关的内容。</p></div><h2 id="Muduo-的安装"><a href="#Muduo-的安装" class="headerlink" title="Muduo 的安装"></a>Muduo 的安装</h2><h3 id="安装-Boost-库"><a href="#安装-Boost-库" class="headerlink" title="安装 Boost 库"></a>安装 Boost 库</h3><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 Boost 的所有组件和头文件</span></span><br><span class="line">sudo apt-get install -y libboost-all-dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Bootst 版本</span></span><br><span class="line">sudo dpkg -s libboost-all-dev | grep Version</span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">提示</p><p>由于 Muduo 使用了 Boost 库（如 <code>boost::any</code>），因此需要安装 Boost 库。</p></div><h3 id="安装-Muduo-库"><a href="#安装-Muduo-库" class="headerlink" title="安装 Muduo 库"></a>安装 Muduo 库</h3><ul><li>编译安装</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Git 克隆代码</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/chenshuo/muduo.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入代码目录</span></span><br><span class="line"><span class="built_in">cd</span> muduo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建构建目录</span></span><br><span class="line">mkdir -p build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入构建目录</span></span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成构建文件</span></span><br><span class="line">cmake ..</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译代码</span></span><br><span class="line">make -j$(nproc)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行安装</span></span><br><span class="line">sudo make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新系统的共享库缓存</span></span><br><span class="line">sudo ldconfig /usr/<span class="built_in">local</span>/lib/</span><br></pre></td></tr></tbody></table></figure><ul><li>验证安装</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 Muduo 库的头文件</span></span><br><span class="line">ls -al /usr/<span class="built_in">local</span>/include/muduo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Muduo 库的静态库</span></span><br><span class="line">ls -al /usr/<span class="built_in">local</span>/lib | grep muduo</span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">提示</p><ul><li>Muduo 的编译依赖 CMake 和 Boost 库，默认编译生成的是静态库（<code>.a</code>），如果需要编译生成共享库（<code>.so</code>），可以自行修改 <code>CMakeLists.txt</code> 中的配置。</li><li>Muduo 支持 C++ 11，仅支持 Linux 平台，不支持 Windows 平台，建议使用 <code>7.x</code> 及以后版本的 <code>g++</code> 编译器。</li></ul></div><h2 id="Muduo-的使用"><a href="#Muduo-的使用" class="headerlink" title="Muduo 的使用"></a>Muduo 的使用</h2><h3 id="Muduo-的链接步骤说明"><a href="#Muduo-的链接步骤说明" class="headerlink" title="Muduo 的链接步骤说明"></a>Muduo 的链接步骤说明</h3><ul><li>Muduo 编译安装之后，生成的常用静态库有以下几个：</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">muduo_net.a</span><br><span class="line">muduo_base.a</span><br><span class="line">muduo_http.a</span><br><span class="line">muduo_inspect.a</span><br></pre></td></tr></tbody></table></figure><ul><li>当 C++ 项目使用 Muduo 库后，在编译 C++ 项目时，需要链接指定的 Muduo 库（必须注意链接的顺序，从左到右链接），比如：</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ chat.cpp -o chat -lmuduo_http -lmuduo_inspect -lmuduo_net -lmuduo_base -lpthread</span><br></pre></td></tr></tbody></table></figure><ul><li><strong>由于 Muduo 库使用 <code>pthread</code> 库来实现多线程编程，因此必须链接 <code>pthread</code> 库</strong></li></ul><h3 id="使用-Muduo-的日志系统"><a href="#使用-Muduo-的日志系统" class="headerlink" title="使用 Muduo 的日志系统"></a>使用 Muduo 的日志系统</h3><p>在开发软件产品过程中，日志的输出非常重要，可以记录很多软件运行过程中的信息，方便定位调试问题和跟踪统计信息等等。</p><ul><li>Muduo 提供的日志级别</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_TRACE <span class="meta-keyword">if</span> (muduo::Logger::logLevel() &lt;= muduo::Logger::TRACE) muduo::Logger(__FILE__, __LINE__, muduo::Logger::TRACE, __func__).stream()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_DEBUG <span class="meta-keyword">if</span> (muduo::Logger::logLevel() &lt;= muduo::Logger::DEBUG) muduo::Logger(__FILE__, __LINE__, muduo::Logger::DEBUG, __func__).stream()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_INFO <span class="meta-keyword">if</span> (muduo::Logger::logLevel() &lt;= muduo::Logger::INFO) muduo::Logger(__FILE__, __LINE__).stream()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_WARN muduo::Logger(__FILE__, __LINE__, muduo::Logger::WARN).stream()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_ERROR muduo::Logger(__FILE__, __LINE__, muduo::Logger::ERROR).stream()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_FATAL muduo::Logger(__FILE__, __LINE__, muduo::Logger::FATAL).stream()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_SYSERR muduo::Logger(__FILE__, __LINE__, false).stream()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_SYSFATAL muduo::Logger(__FILE__, __LINE__, true).stream()</span></span><br></pre></td></tr></tbody></table></figure><ul><li>Muduo 日志级别的使用</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;muduo/base/Logging.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    LOG_INFO &lt;&lt; <span class="string">"这是一个 info 日志"</span>;</span><br><span class="line">    LOG_WARN &lt;&lt; <span class="string">"这是一个 warn 日志"</span>;</span><br><span class="line">    LOG_ERROR &lt;&lt; <span class="string">"这是一个 error 日志"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>程序运行输出的结果：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">20250522 22:34:32.067870Z 22233 INFO  这是一个 info 日志 - main.cpp:45</span><br><span class="line">20250522 22:34:32.067995Z 22233 WARN  这是一个 warn 日志 - main.cpp:46</span><br><span class="line">20250522 22:34:32.068365Z 22233 ERROR 这是一个 error 日志 - main.cpp:47</span><br></pre></td></tr></tbody></table></figure><h3 id="实现-TCP-客户端和服务端"><a href="#实现-TCP-客户端和服务端" class="headerlink" title="实现 TCP 客户端和服务端"></a>实现 TCP 客户端和服务端</h3><p>实现基于 Muduo 网络库的 TCP 客户端和服务端程序，只需要简单地组合使用 <code>TcpServer</code> 和 <code>TcpClient</code> 就可以。</p><h4 id="TCP-服务端代码"><a href="#TCP-服务端代码" class="headerlink" title="TCP 服务端代码"></a>TCP 服务端代码</h4><ul><li><code>muduo_server.h</code> 源文件</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;muduo/net/EventLoop.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;muduo/net/TcpServer.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 基于Muduo开发服务端程序</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChatServer</span> {</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 构造函数</span></span><br><span class="line">    <span class="built_in">ChatServer</span>(muduo::net::EventLoop *loop, <span class="keyword">const</span> muduo::net::InetAddress &amp;listenAddr, <span class="keyword">const</span> std::string &amp;nameArg)</span><br><span class="line">        : _server(loop, listenAddr, nameArg), _loop(loop) {</span><br><span class="line">        <span class="comment">// 设置服务端注册用户连接的创建和断开回调</span></span><br><span class="line">        _server.<span class="built_in">setConnectionCallback</span>(std::<span class="built_in">bind</span>(&amp;ChatServer::onConnection, <span class="keyword">this</span>, std::placeholders::_1));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置服务端注册用户读写事件的回调</span></span><br><span class="line">        _server.<span class="built_in">setMessageCallback</span>(std::<span class="built_in">bind</span>(&amp;ChatServer::onMessage, <span class="keyword">this</span>, std::placeholders::_1, std::placeholders::_2,</span><br><span class="line">                                             std::placeholders::_3));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置EventLoop的线程数量（比如：1个I/O线程，3个Worker线程）</span></span><br><span class="line">        _server.<span class="built_in">setThreadNum</span>(<span class="number">4</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 析构函数</span></span><br><span class="line">    ~<span class="built_in">ChatServer</span>() {</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动服务端</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// 开启事件循环处理</span></span><br><span class="line">        _server.<span class="built_in">start</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// 处理用户的连接创建和断开</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onConnection</span><span class="params">(<span class="keyword">const</span> muduo::net::TcpConnectionPtr &amp;conn)</span> </span>{</span><br><span class="line">        <span class="comment">// 连接创建</span></span><br><span class="line">        <span class="keyword">if</span> (conn-&gt;<span class="built_in">connected</span>()) {</span><br><span class="line">            std::cout &lt;&lt; <span class="string">"==&gt; server "</span> &lt;&lt; conn-&gt;<span class="built_in">peerAddress</span>().<span class="built_in">toIpPort</span>() &lt;&lt; <span class="string">" -&gt; "</span> &lt;&lt; conn-&gt;<span class="built_in">localAddress</span>().<span class="built_in">toIpPort</span>()</span><br><span class="line">                      &lt;&lt; <span class="string">" state: online"</span> &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 连接断开</span></span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            std::cout &lt;&lt; <span class="string">"==&gt; server "</span> &lt;&lt; conn-&gt;<span class="built_in">peerAddress</span>().<span class="built_in">toIpPort</span>() &lt;&lt; <span class="string">" -&gt; "</span> &lt;&lt; conn-&gt;<span class="built_in">localAddress</span>().<span class="built_in">toIpPort</span>()</span><br><span class="line">                      &lt;&lt; <span class="string">" state: offline"</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="comment">// 断开连接（释放资源）</span></span><br><span class="line">            conn-&gt;<span class="built_in">shutdown</span>();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理用户读写事件（比如接收客户端发送的数据）</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(<span class="keyword">const</span> muduo::net::TcpConnectionPtr &amp;conn, muduo::net::Buffer *buffer, muduo::Timestamp time)</span> </span>{</span><br><span class="line">        std::string message = buffer-&gt;<span class="built_in">retrieveAllAsString</span>();</span><br><span class="line">        std::cout &lt;&lt; <span class="string">"==&gt; server receive message: "</span> &lt;&lt; message &lt;&lt; <span class="string">", time: "</span> &lt;&lt; time.<span class="built_in">toFormattedString</span>(<span class="literal">false</span>)</span><br><span class="line">                  &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    muduo::net::TcpServer _server;</span><br><span class="line">    muduo::net::EventLoop *_loop;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><ul><li>当需要测试 TCP 服务端代码时，可以执行 <code>telnet 127.0.0.1 6000</code> 命令启动一个 TCP 客户端，然后输入要发送的内容，最后按下回车键即可发送数据给 TCP 服务端。</li><li>当需要断开 Telnet 连接（TCP 客户端连接）时，可以使用快捷键 <code>ctrl + ]</code> 切换到一个特殊的 Telnet 命令行界面；然后在这个界面输入 <code>quit</code> 命令，就可以退出 Telnet 命令行界面。</li><li>或者，推荐直接使用 Linux 的 <code>nc 127.0.0.1 6000</code> 命令来启动一个 TCP 客户端，然后再发送数据给 TCP 服务端，断开 TCP 客户端连接只需要使用快捷键 <code>ctrl + c</code> 关闭 <code>nc</code> 命令的进程即可。</li></ul><h4 id="TCP-客户端代码"><a href="#TCP-客户端代码" class="headerlink" title="TCP 客户端代码"></a>TCP 客户端代码</h4><ul><li><code>muduo_client.h</code> 源文件</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;muduo/net/EventLoop.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;muduo/net/TcpClient.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChatClient</span> {</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 构造函数</span></span><br><span class="line">    <span class="built_in">ChatClient</span>(muduo::net::EventLoop* loop, <span class="keyword">const</span> muduo::net::InetAddress&amp; serverAddr, <span class="keyword">const</span> std::string&amp; nameArg)</span><br><span class="line">        : _client(loop, serverAddr, nameArg), _loop(loop) {</span><br><span class="line">        <span class="comment">// 设置客户端TCP连接的回调</span></span><br><span class="line">        _client.<span class="built_in">setConnectionCallback</span>(std::<span class="built_in">bind</span>(&amp;ChatClient::onConnection, <span class="keyword">this</span>, std::placeholders::_1));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置客户端接收数据的回调</span></span><br><span class="line">        _client.<span class="built_in">setMessageCallback</span>(std::<span class="built_in">bind</span>(&amp;ChatClient::onMessage, <span class="keyword">this</span>, std::placeholders::_1, std::placeholders::_2,</span><br><span class="line">                                             std::placeholders::_3));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 析构函数</span></span><br><span class="line">    ~<span class="built_in">ChatClient</span>() {</span><br><span class="line">        <span class="comment">// 发起断开连接</span></span><br><span class="line">        _client.<span class="built_in">disconnect</span>();</span><br><span class="line">        <span class="comment">// 停止内部 Connector 的重连机制，避免异步行为</span></span><br><span class="line">        _client.<span class="built_in">stop</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接服务端</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">connect</span><span class="params">()</span> </span>{</span><br><span class="line">        _client.<span class="built_in">connect</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// 客户端绑定连接回调函数，当连接或者断开服务端时调用</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onConnection</span><span class="params">(<span class="keyword">const</span> muduo::net::TcpConnectionPtr&amp; conn)</span> </span>{</span><br><span class="line">        <span class="comment">// 连接创建</span></span><br><span class="line">        <span class="keyword">if</span> (conn-&gt;<span class="built_in">connected</span>()) {</span><br><span class="line">            std::cout &lt;&lt; <span class="string">"==&gt; client "</span> &lt;&lt; conn-&gt;<span class="built_in">localAddress</span>().<span class="built_in">toIpPort</span>() &lt;&lt; <span class="string">" -&gt; "</span> &lt;&lt; conn-&gt;<span class="built_in">peerAddress</span>().<span class="built_in">toIpPort</span>()</span><br><span class="line">                      &lt;&lt; <span class="string">" state: connected"</span> &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 连接断开</span></span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            std::cout &lt;&lt; <span class="string">"==&gt; client "</span> &lt;&lt; conn-&gt;<span class="built_in">localAddress</span>().<span class="built_in">toIpPort</span>() &lt;&lt; <span class="string">" -&gt; "</span> &lt;&lt; conn-&gt;<span class="built_in">peerAddress</span>().<span class="built_in">toIpPort</span>()</span><br><span class="line">                      &lt;&lt; <span class="string">" state: disconnected"</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="comment">// 断开连接（释放资源）</span></span><br><span class="line">            conn-&gt;<span class="built_in">shutdown</span>();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 客户端绑定消息回调函数，当有数据接收时调用</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(<span class="keyword">const</span> muduo::net::TcpConnectionPtr&amp; conn, muduo::net::Buffer* buf, muduo::Timestamp time)</span> </span>{</span><br><span class="line">        std::string message = buf-&gt;<span class="built_in">retrieveAllAsString</span>();</span><br><span class="line">        std::cout &lt;&lt; <span class="string">"==&gt; client receive message: "</span> &lt;&lt; message &lt;&lt; <span class="string">", time: "</span> &lt;&lt; time.<span class="built_in">toFormattedString</span>(<span class="literal">false</span>)</span><br><span class="line">                  &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    muduo::net::TcpClient _client;</span><br><span class="line">    muduo::net::EventLoop* _loop;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><ul><li>当需要测试 TCP 客户端代码时，可以执行 Linux 的 <code>nc -l 127.0.0.1 6000</code> 命令启动一个 TCP 服务端，然后输入要发送的内容，最后按下回车键即可发送数据给 TCP 客户端。</li><li>当需要关闭 TCP 服务端（断开 TCP 客户端连接）时，只需要使用快捷键 <code>ctrl + c</code> 关闭 <code>nc</code> 命令的进程即可。</li></ul><h4 id="TCP-连接测试代码"><a href="#TCP-连接测试代码" class="headerlink" title="TCP 连接测试代码"></a>TCP 连接测试代码</h4><ul><li><code>test.cpp</code> 源文件</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;muduo/net/EventLoop.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;muduo/net/TcpServer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"muduo_server.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"muduo_client.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化服务端</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initServer</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// 创建服务端</span></span><br><span class="line">    muduo::net::EventLoop loop;</span><br><span class="line">    muduo::<span class="function">net::InetAddress <span class="title">addr</span><span class="params">(<span class="string">"127.0.0.1"</span>, <span class="number">6000</span>)</span></span>;</span><br><span class="line">    <span class="function">ChatServer <span class="title">server</span><span class="params">(&amp;loop, addr, <span class="string">"ChatServer"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动服务端</span></span><br><span class="line">    server.<span class="built_in">start</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 以阻塞方式等待新客户端的连接、已连接客户端的读写事件等</span></span><br><span class="line">    loop.<span class="built_in">loop</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化客户端</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initClient</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// 创建客户端</span></span><br><span class="line">    muduo::net::EventLoop loop;</span><br><span class="line">    muduo::<span class="function">net::InetAddress <span class="title">addr</span><span class="params">(<span class="string">"127.0.0.1"</span>, <span class="number">6000</span>)</span></span>;</span><br><span class="line">    <span class="function">ChatClient <span class="title">client</span><span class="params">(&amp;loop, addr, <span class="string">"ChatClient"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接服务端</span></span><br><span class="line">    client.<span class="built_in">connect</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 以阻塞方式等待服务端发送的数据</span></span><br><span class="line">    loop.<span class="built_in">loop</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// 启动服务端线程</span></span><br><span class="line">    <span class="function">std::thread <span class="title">serverThread</span><span class="params">(initServer)</span></span>;</span><br><span class="line">    serverThread.<span class="built_in">detach</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待一会，让服务端线程先启动</span></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">5</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动客户端线程</span></span><br><span class="line">    <span class="function">std::thread <span class="title">clientThread</span><span class="params">(initClient)</span></span>;</span><br><span class="line">    clientThread.<span class="built_in">detach</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阻塞等待用户按下任意键，然后结束程序运行</span></span><br><span class="line">    <span class="keyword">char</span> c = <span class="built_in">getchar</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>程序运行后输出的结果：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">==&gt; client 127.0.0.1:45636 -&gt; 127.0.0.1:6000 state: connected</span><br><span class="line">==&gt; server 127.0.0.1:45636 -&gt; 127.0.0.1:6000 state: online</span><br></pre></td></tr></tbody></table></figure><h3 id="使用-Muduo-的线程池执行任务"><a href="#使用-Muduo-的线程池执行任务" class="headerlink" title="使用 Muduo 的线程池执行任务"></a>使用 Muduo 的线程池执行任务</h3><h4 id="Muduo-线程池的介绍"><a href="#Muduo-线程池的介绍" class="headerlink" title="Muduo 线程池的介绍"></a>Muduo 线程池的介绍</h4><p>采用 Muduo 进行服务器编程时，如果遇到需要开辟多个线程来单独处理复杂的计算任务或者其它阻塞任务，那么就不需要手动调用 <code>pthread_create()</code> 来创建线程了；因为 Muduo 提供的 <code>ThreadPool</code> 线程池管理类已经将 Linux 的线程创建完全封装起来了。如果想研究 Muduo 线程池的底层源码，可以剖析 Muduo 项目中的 <code>ThreadPool.cc</code> 和 <code>Thread.cc</code> 源文件。ThreadPool 的使用示例如下：</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 线程池</span></span><br><span class="line">muduo::ThreadPool _pool;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在单独的线程中接收客户端的连接，并执行相应的操作</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">userClient</span><span class="params">(<span class="keyword">const</span> muduo::net::TcpConnectionPtr &amp;con)</span></span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 客户端与服务器连接成功</span></span><br><span class="line"><span class="keyword">if</span> (con-&gt;<span class="built_in">connected</span>()) {</span><br><span class="line">    LOG_INFO &lt;&lt; <span class="string">"connection opened!"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 让线程池分配线程专门处理客户端连接</span></span><br><span class="line">    _pool.<span class="built_in">run</span>(<span class="built_in">bind</span>(&amp;ChatClient::userClient, <span class="keyword">this</span>, conn));</span><br><span class="line">}</span><br><span class="line"><span class="comment">// 客户端与服务器断开连接</span></span><br><span class="line"><span class="keyword">else</span>  {</span><br><span class="line">    LOG_INFO &lt;&lt; <span class="string">"connection closed!"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="Muduo-线程池的使用"><a href="#Muduo-线程池的使用" class="headerlink" title="Muduo 线程池的使用"></a>Muduo 线程池的使用</h4><p>这里将介绍如何使用 Muduo 的线程池来执行多个计算任务（并行计算）。</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;muduo/base/CountDownLatch.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;muduo/base/ThreadPool.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> ULong = <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> threadNumber = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">const</span> ULong kRange = <span class="number">100000000</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建并启动 Muduo 线程池</span></span><br><span class="line">    muduo::ThreadPool pool;</span><br><span class="line">    pool.<span class="built_in">setMaxQueueSize</span>(<span class="number">100</span>);</span><br><span class="line">    pool.<span class="built_in">start</span>(threadNumber);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于汇总所有线程的计算结果</span></span><br><span class="line">    <span class="function">std::atomic&lt;ULong&gt; <span class="title">totalSum</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于等待所有任务执行完成</span></span><br><span class="line">    <span class="function">muduo::CountDownLatch <span class="title">latch</span><span class="params">(threadNumber)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将 [1, kRange] 平均分成 N 段，每段提交一个任务</span></span><br><span class="line">    ULong blockSize = kRange / threadNumber;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; threadNumber; ++i) {</span><br><span class="line">        ULong start = i * blockSize + <span class="number">1</span>;</span><br><span class="line">        ULong end = (i == threadNumber - <span class="number">1</span>) ? kRange : (i + <span class="number">1</span>) * blockSize;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加任务到线程池</span></span><br><span class="line">        pool.<span class="built_in">run</span>([start, end, &amp;totalSum, &amp;latch]() {</span><br><span class="line">            <span class="comment">// 执行累加计算</span></span><br><span class="line">            ULong localSum = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (ULong x = start; x &lt;= end; ++x) {</span><br><span class="line">                localSum += x;</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 原子地累加到总和</span></span><br><span class="line">            totalSum.<span class="built_in">fetch_add</span>(localSum, std::memory_order_relaxed);</span><br><span class="line">            <span class="comment">// 标记此任务完成</span></span><br><span class="line">            latch.<span class="built_in">countDown</span>();</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阻塞等待所有线程完成计算</span></span><br><span class="line">    latch.<span class="built_in">wait</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出计算结果</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">"1 + 2 + ... + "</span> &lt;&lt; kRange &lt;&lt; <span class="string">" = "</span> &lt;&lt; totalSum.<span class="built_in">load</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭线程池</span></span><br><span class="line">    pool.<span class="built_in">stop</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>程序运行后输出的结果：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 + 2 + ... + 100000000 = 5000000050000000</span><br></pre></td></tr></tbody></table></figure><h2 id="Muduo-的原理"><a href="#Muduo-的原理" class="headerlink" title="Muduo 的原理"></a>Muduo 的原理</h2><p>Muduo 是一个高性能的 Reactor 模式网络库，采用 <code>one loop per thread + thread pool</code> 的架构实现，其代码简洁、逻辑清晰，是学习高性能网络编程的优秀范例。</p><h3 id="整体类图"><a href="#整体类图" class="headerlink" title="整体类图"></a>整体类图</h3><p>下面这张图是陈硕提供的 Muduo 网络库的类图（图中灰色的类是内部类，白色的是外部类）。</p><p><img data-src="../../../asset/2025/06/muduo-arch-1.png"></p><h3 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h3><p>Muduo 的代码结构主要分为两个模块：<code>base</code> 和 <code>net</code>，其中 <code>base</code> 模块实现了一些通用的基础功能，而 <code>net</code> 模块基于 <code>base</code> 提供的工具类，构建了更高层次的网络编程抽象。</p><h4 id="base-模块"><a href="#base-模块" class="headerlink" title="base 模块"></a>base 模块</h4><p><code>base</code> 模块实现了一些通用的基础功能，例如日志系统（<code>log</code>）、线程（<code>thread</code>）、线程池（<code>threadpool</code>）、互斥锁（<code>mutex</code>）、队列（<code>queue</code>）等。这些组件不仅在网络模块中被广泛复用，也为构建高性能程序提供了良好的基础。<code>base</code> 模块的设计强调高内聚、低耦合，模块之间依赖关系清晰，职责划分明确，代码风格一致，逻辑简单直接。因此，即使是初学者，在阅读 <code>base</code> 源码时也能较容易理解其实现思路和设计意图。由于 <code>base</code> 模块本身并不涉及复杂的网络细节，这里不做深入探讨，重点将放在更具挑战性的 <code>net</code> 模块上，分析其在事件驱动、连接管理及多线程调度等方面的实现细节。</p><h4 id="net-模块"><a href="#net-模块" class="headerlink" title="net 模块"></a>net 模块</h4><p><code>net</code> 模块基于 <code>base</code> 提供的工具类，构建了更高层次的网络编程抽象。网络编程的本质在于对底层 <code>socket</code> 接口以及 I/O 多路复用机制（如 <code>poll</code>、<code>epoll</code>）的封装，目的在于提升易用性、可维护性，同时屏蔽掉底层 API 中存在的一些坑。在实现了基本的网络 I/O 能力后，系统性能与并发处理能力便成为网络库设计的关键。Muduo 使用基于 <code>poll</code> / <code>epoll</code> 的 I/O 多路复用模型构建事件驱动系统，并采用 <code>one loop per thread</code> 的架构设计，即每个 I/O 线程拥有一个独立的事件循环 <code>EventLoop</code>。这种设计结合线程池机制，使得多个线程可以并行处理不同连接或任务，从而充分发挥多核硬件的性能优势，实现高性能、高并发的网络处理能力。<code>net</code> 模块的封装较为彻底，向上层应用提供了简洁易用的接口，隐藏了复杂的内部实现逻辑。得益于这种设计，开发者在使用 Muduo 进行网络编程时，能够专注于业务逻辑本身，而无需深入底层处理细节。</p><h3 id="整体设计"><a href="#整体设计" class="headerlink" title="整体设计"></a>整体设计</h3><h4 id="EventLoop"><a href="#EventLoop" class="headerlink" title="EventLoop"></a>EventLoop</h4><p><code>EventLoop</code> 事件循环（即 Reactor 反应器），负责 I/O 事件和定时器事件的分派，每个线程只能有一个 <code>EventLoop</code> 实体。</p><ul><li>使用 <code>TimerQueue</code> 作为计时器管理。</li><li>使用 <code>Poller</code> 作为 I/O 多路复用机制。</li></ul><h5 id="TimerQueue"><a href="#TimerQueue" class="headerlink" title="TimerQueue"></a>TimerQueue</h5><p><code>TimerQueue</code> 底层使用 <code>timerfd_*</code> 系列函数将定时器转换为 <code>fd</code>，并添加到事件循环中。</p><ul><li>当时间到达后，这些 <code>fd</code> 会自动触发事件。</li><li>内部使用 <code>std::set</code> 管理所有注册的 <code>Timer</code>。</li><li>由于 <code>set</code> 有自动排序功能，所以事件循环中总是优先处理最早到期的 Timer。</li></ul><h5 id="Poller-抽象类"><a href="#Poller-抽象类" class="headerlink" title="Poller 抽象类"></a>Poller 抽象类</h5><p><code>Poller</code> 是 I/O 多路复用的抽象类。</p><ul><li>其具体实现由子类 <code>PollPoller</code>（封装了 <code>poll</code>）和 <code>EpollPoller</code>（封装了 <code>epoll</code>）完成。</li><li><code>Pooler</code> 是 Muduo 中唯一使用面向对象（虚函数）实现的模块，提供了回调功能。</li><li><code>Poller</code> 中的 <code>updateChannel()</code> 函数用于注册和更新 <code>fd</code> 的事件，所有的 <code>fd</code> 都必须通过它添加到事件循环中。</li></ul><h5 id="任务队列"><a href="#任务队列" class="headerlink" title="任务队列"></a>任务队列</h5><p>除了管理定时器和 I/O 事件外，<code>EventLoop</code> 还包含一个任务队列。</p><ul><li>任务队列用于执行一些计算任务，可由其他线程添加到任务进队列中。</li><li><code>EventLoop</code> 在处理完 I/O 事件后，会依次执行队列中的任务。</li><li>多线程处理共享资源时，可以通过将操作提交到某个 <code>EventLoop</code> 的任务队列中，让该线程负责资源管理，其他线程无需加锁，只需加锁队列即可，从而简化并发模型，减少锁的使用。</li></ul><p>异步唤醒线程：</p><ul><li>如果 <code>EventLoop</code> 阻塞在 <code>epoll_wait</code> 中，则会无法及时处理队列中的任务。</li><li>因此需要一种通信机制来唤醒 <code>EventLoop</code> 所在线程，被唤醒后就取出队列中的任务进行执行。</li><li>Muduo 使用 <code>eventfd(2)</code> 来实现异步唤醒。</li></ul><h4 id="Channel-事件包装器"><a href="#Channel-事件包装器" class="headerlink" title="Channel 事件包装器"></a>Channel 事件包装器</h4><p>在 Muduo 中，通过 <code>Channel</code> 对 <code>fd</code> 进行封装。更准确地说，是对 <code>fd</code> 的事件相关方法的封装。</p><ul><li>它负责注册 <code>fd</code> 的可读或者可写事件到 <code>EventLoop</code>。</li><li>以及事件产生时，定义事件如何响应。</li><li>每个 <code>fd</code> 对应一个 <code>Channel</code>（聚合关系）。</li><li><code>Channel</code> 析构时不会 <code>close</code> 掉这个 <code>fd</code>。</li><li>提供 <code>handleEvent()</code> 函数，当 <code>fd</code> 有事件产生时，<code>EventLoop</code> 会调用它进行处理。</li><li><code>handleEvent()</code> 的内部会根据可读或者可写事件分别调用已注册的回调函数。</li></ul><p>通常 <code>Channel</code> 被作为其他类的成员来使用，例如：</p><ul><li><code>EventLoop</code> 内部通过 <code>std::vector&lt;Channel*&gt;</code> 管理多个注册的 <code>fd</code>。</li><li><code>EventLoop</code> 与多个 <code>Channel</code> 形成一对多的关系。</li></ul><h4 id="Socket-封装类"><a href="#Socket-封装类" class="headerlink" title="Socket 封装类"></a>Socket 封装类</h4><p><code>Socket</code> 也是对 <code>fd</code> 的封装，但不同于 <code>Channel</code>：</p><ul><li><code>Socket</code> 仅封装由 <code>::socket</code> 系统调用产生的 <code>fd</code>。</li><li>提供获取 / 设置网络连接属性的方法（如地址复用、关闭 Nagle 算法等）。</li><li>与 <code>fd</code> 是组合关系，<code>Socket</code> 析构时会自动 <code>close</code> 这个 <code>fd</code>。</li></ul><blockquote><p>尽管有 <code>Socket</code> 和 <code>Channel</code> 的封装，某些系统调用仍然需要直接传递原始 <code>fd</code>，因此实际代码中常见同时持有 <code>fd</code>、<code>Socket</code> 和 <code>Channel</code> 的情况。</p></blockquote><h4 id="TcpConnection-抽象类"><a href="#TcpConnection-抽象类" class="headerlink" title="TcpConnection 抽象类"></a>TcpConnection 抽象类</h4><p><code>TcpConnection</code> 是对一个 TCP 连接的抽象。</p><ul><li>一个 <code>TcpConnection</code> 包含一个 <code>Socket</code> 和一个 <code>Channel</code>。</li><li>在构造时就为 <code>Channel</code> 注册好了事件回调：<ul><li><code>handleRead()</code>：处理可读事件</li><li><code>handleWrite()</code>：处理可写事件</li></ul></li></ul><p>当有事件触发后：</p><ul><li><code>handleRead()</code> 会先处理接收数据。</li><li>然后转交给上层逻辑（调用上层注册的回调函数）。</li><li>回调函数由用户通过 <code>TcpConnection</code> 注册，内部会传递给 <code>Channel</code>。</li><li>因为 <code>Channel</code> 是个内部类，所以回调函数的注册只能由 <code>TcpConnection</code> 负责，上层无需接触 <code>Channel</code>，只需将回调函数注册到 <code>TcpConnection</code> 即可。</li></ul><p>为什么需要 TcpConnection？</p><ul><li>为了解决 TCP 协议下收发数据的阻塞问题</li><li>比如调用 <code>::write</code> 时，若内核缓冲区已满，则写操作会阻塞。</li><li>一个优秀的网络库应允许上层调用一次 <code>sendMessage()</code> 就能完成数据发送，而非频繁判断是否可写。</li><li><code>TcpConnection</code> 内部维护了 <code>inputBuffer</code> 和 <code>outputBuffer</code>：<ul><li>支持数据缓存和分批发送。</li><li>保证在连接断开前，数据能够全部发送完成。</li></ul></li></ul><h4 id="Acceptor-连接接收器"><a href="#Acceptor-连接接收器" class="headerlink" title="Acceptor 连接接收器"></a>Acceptor 连接接收器</h4><p><code>Acceptor</code> 用来接受新连接。</p><ul><li>内部维护一个 <code>listenfd</code> 和对应的 <code>Channel</code>。</li><li>初始化时执行：<ul><li><code>::bind</code></li><li><code>::listen</code></li><li>并将 <code>listenfd</code> 注册到事件循环。</li></ul></li></ul><p>当有新连接到来：</p><ul><li>触发 <code>Channel</code> 的 <code>handleRead()</code>，调用 <code>accept()</code> 接收连接。</li><li>再调用上层注册的 <code>newConnectionCallback</code>。</li><li><code>Acceptor</code> 是 <code>TcpServer</code> 的内部类，回调由 <code>TcpServer</code> 注册。</li><li><code>TcpServer</code> 会为每个新连接创建一个 <code>TcpConnection</code>，并设置相应的回调函数。</li><li>所有连接通过一个 <code>map</code> 被 <code>TcpServer</code> 管理。</li></ul><p>并发连接的处理：</p><ul><li><code>TcpServer</code> 使用线程池处理并发请求。</li><li>线程池包含多个 I/O 线程（即多个 <code>EventLoop</code>）。</li><li>每个连接会自动分配给某个线程的 <code>EventLoop</code>，在其上创建 <code>TcpConnection</code>。</li><li>大幅提高了服务器的并发处理能力。</li></ul><h4 id="Connector-和-TcpClient"><a href="#Connector-和-TcpClient" class="headerlink" title="Connector 和 TcpClient"></a>Connector 和 TcpClient</h4><ul><li><code>Connector</code> 与 <code>TcpClient</code> 的关系类似于 <code>Acceptor</code> 与 <code>TcpServer</code>。</li><li>区别在于 <code>Connector</code> 用于主动发起连接。</li><li>负责连接重试、超时等连接建立相关逻辑。</li></ul><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/2301_79881188/article/details/146237900">Muduo 库的简介与使用</a></li><li><a target="_blank" rel="external nofollow" href="https://www.cnblogs.com/gaorong/p/6476757.html">Muduo 网络库整体架构简析</a></li><li><a target="_blank" rel="external nofollow" href="https://www.cnblogs.com/itxt/p/18606993">Muduo 网络库解析 - 架构设计</a></li><li><a target="_blank" rel="external nofollow" href="https://youjiali1995.github.io/network/muduo">Muduo 网络库源码分析</a></li><li><a target="_blank" rel="external nofollow" href="https://zhuanlan.zhihu.com/p/85101271">Muduo 底层源码剖析</a></li><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/weixin_74066883/article/details/146767305">C++ 重构 Muduo 网络库</a></li></ul><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/def1afc3.html" title="C++ 网络编程 Muduo 库使用">https://www.techgrow.cn/posts/def1afc3.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/" rel="tag"><i class="fa fa-tag"></i> Linux系统编程</a><a href="/tags/C/" rel="tag"><i class="fa fa-tag"></i> C++</a><a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" rel="tag"><i class="fa fa-tag"></i> 网络编程</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/380adca4.html" rel="prev" title="Docker 安装 Dubbo Admin 单机教程"><i class="fa fa-angle-left"></i> Docker 安装 Dubbo Admin 单机教程</a></div><div class="post-nav-item"> <a href="/posts/a2a7ad9b.html" rel="next" title="C++ 多线程编程之一">C++ 多线程编程之一<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">1.9m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">28:57</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"/lib/mermaid/dist/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/def1afc3.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>