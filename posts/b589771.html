<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍 ZooKeeper 的使用教程。"><meta property="og:type" content="article"><meta property="og:title" content="ZooKeeper 入门教程之五"><meta property="og:url" content="https://www.techgrow.cn/posts/b589771.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍 ZooKeeper 的使用教程。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/01/zookeeper-source-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/01/zookeeper-source-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/01/zookeeper-source-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/01/zookeeper-source-4.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/01/zookeeper-source-5.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/01/zookeeper-source-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/12/zookeeper-15.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/12/zookeeper-16.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/01/zookeeper-source-7.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/01/zookeeper-source-8.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2025/01/zookeeper-source-6.png"><meta property="article:published_time" content="2021-07-06T14:13:45.000Z"><meta property="article:modified_time" content="2021-07-06T14:13:45.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="分布式"><meta property="article:tag" content="大数据"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2025/01/zookeeper-source-1.png"><link rel="canonical" href="https://www.techgrow.cn/posts/b589771.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/b589771.html","path":"posts/b589771.html","title":"ZooKeeper 入门教程之五"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>ZooKeeper 入门教程之五 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%BA%90"><span class="nav-text">学习资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="nav-text">版本说明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ZK-%E8%BE%85%E5%8A%A9%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">ZK 辅助源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ZK-%E6%8C%81%E4%B9%85%E5%8C%96%E6%BA%90%E7%A0%81"><span class="nav-text">ZK 持久化源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ZK-%E5%BA%8F%E5%88%97%E5%8C%96%E6%BA%90%E7%A0%81"><span class="nav-text">ZK 序列化源码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ZK-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%88%9D%E5%A7%8B%E5%8C%96%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">ZK 服务端初始化源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ZK-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC"><span class="nav-text">ZK 服务端启动脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ZK-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8%E5%85%A5%E5%8F%A3"><span class="nav-text">ZK 服务端启动入口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E6%9E%90%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0"><span class="nav-text">解析配置参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%87%E6%9C%9F%E5%BF%AB%E7%85%A7%E5%88%A0%E9%99%A4"><span class="nav-text">过期快照删除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%80%9A%E4%BF%A1%E7%BB%84%E4%BB%B6"><span class="nav-text">初始化通信组件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#I-O-%E6%A8%A1%E5%9E%8B%E9%BB%98%E8%AE%A4%E4%B8%BA-NIO-%E9%80%9A%E4%BF%A1"><span class="nav-text">I/O 模型默认为 NIO 通信</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96-NIO-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84-Socket"><span class="nav-text">初始化 NIO 服务端的 Socket</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ZK-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">ZK 服务端加载数据源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ZK-%E7%9A%84%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B"><span class="nav-text">ZK 的数据存储模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ZK-%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E7%9A%84%E5%90%AF%E5%8A%A8"><span class="nav-text">ZK 集群节点的启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%B7%E5%90%AF%E5%8A%A8%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D%E5%BF%AB%E7%85%A7%E6%95%B0%E6%8D%AE"><span class="nav-text">冷启动数据恢复快照数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%B7%E5%90%AF%E5%8A%A8%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D%E7%BC%96%E8%BE%91%E6%97%A5%E5%BF%97"><span class="nav-text">冷启动数据恢复编辑日志</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ZK-%E9%9B%86%E7%BE%A4%E9%80%89%E4%B8%BE%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">ZK 集群选举源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E9%80%89%E4%B8%BE%E6%9C%BA%E5%88%B6"><span class="nav-text">集群选举机制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%90%AF%E5%8A%A8"><span class="nav-text">集群第一次启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E9%9D%9E%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%90%AF%E5%8A%A8"><span class="nav-text">集群非第一次启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E9%80%89%E4%B8%BE%E6%9C%BA%E5%88%B6%E6%80%BB%E7%BB%93"><span class="nav-text">集群选举机制总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E9%80%89%E4%B8%BE%E5%87%86%E5%A4%87"><span class="nav-text">集群选举准备</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E7%BB%84%E4%BB%B6%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">网络通信组件初始化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%91%E5%90%AC%E7%BA%BF%E7%A8%8B%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">监听线程初始化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%89%E4%B8%BE%E5%87%86%E5%A4%87"><span class="nav-text">选举准备</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E9%80%89%E4%B8%BE%E6%89%A7%E8%A1%8C"><span class="nav-text">集群选举执行</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%89%E4%B8%BE%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B"><span class="nav-text">选举整体流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E4%BB%A3%E7%A0%81"><span class="nav-text">第一部分代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%E4%BB%A3%E7%A0%81"><span class="nav-text">第二部分代码</span></a></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">760</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">54</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/b589771.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="ZooKeeper 入门教程之五 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍 ZooKeeper 的使用教程。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> ZooKeeper 入门教程之五</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-07-06 22:13:45" itemprop="dateCreated datePublished" datetime="2021-07-06T22:13:45+08:00">2021-07-06</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/b589771.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/b589771.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>5.2k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>5 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/23b4218e.html">ZooKeeper 入门教程之一</a></li><li><a href="/posts/18340f27.html">ZooKeeper 入门教程之二</a></li><li><a href="/posts/5a68992a.html">ZooKeeper 入门教程之三</a></li><li><a href="/posts/16baf534.html">ZooKeeper 入门教程之四</a></li><li><a href="/posts/b589771.html">ZooKeeper 入门教程之五</a></li><li><a href="/posts/d415f72.html">ZooKeeper 入门教程之六</a></li></ul><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="学习资源"><a href="#学习资源" class="headerlink" title="学习资源"></a>学习资源</h3><ul><li><a href="/posts/ecc33bf4.html">ZooKeeper 学习路线</a></li><li><a target="_blank" rel="external nofollow" href="https://zookeeper.apache.org/documentation.html">ZooKeeper 官方英文文档</a></li><li><a target="_blank" rel="external nofollow" href="https://zookeeper.net.cn/doc/r3.9.2/index.html">ZooKeeper 官方中文文档</a></li></ul><span id="more"></span><h3 id="版本说明"><a href="#版本说明" class="headerlink" title="版本说明"></a>版本说明</h3><table><thead><tr><th>软件</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td> ZooKeeper 的源码</td><td><code>3.5.7</code></td><td>本文给出的 ZooKeeper 源码分析，都是基于 ZooKeeper 的 <code>3.5.7</code> 版本进行讲解。</td></tr></tbody></table><h2 id="ZK-辅助源码分析"><a href="#ZK-辅助源码分析" class="headerlink" title="ZK 辅助源码分析"></a>ZK 辅助源码分析</h2><h3 id="ZK-持久化源码"><a href="#ZK-持久化源码" class="headerlink" title="ZK 持久化源码"></a>ZK 持久化源码</h3><p>Leader 和 Follower 中的数据会在内存和磁盘中各保存一份，所以需要将内存中的数据持久化到磁盘中（如下图所示）。在 <code>org.apache.zookeeper.server.persistence</code> 包下的相关类都是持久化相关的代码。</p><ul><li>(1) ZooKeeper 中的数据模型是一棵树（DataTree），每个节点叫做 DataNode。</li><li>(2) ZooKeeper 集群中的 DataTree 时刻都保持状态同步。</li><li>(3) Zookeeper 集群中每个节点的数据在内存和磁盘中都有一份完整的数据。<ul><li>内存数据：DataTree</li><li> 磁盘数据：快照文件 + 编辑日志</li></ul></li></ul><p><img data-src="../../../asset/2025/01/zookeeper-source-1.png"></p><ul><li>快照接口</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SnapShot</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 反序列化方法</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">deserialize</span><span class="params">(DataTree dt, Map&lt;Long, Integer&gt; sessions)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 序列化方法</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">serialize</span><span class="params">(DataTree dt, Map&lt;Long, Integer&gt; sessions, File name)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查找最近的快照文件</span></span><br><span class="line">    <span class="function">File <span class="title">findMostRecentSnapshot</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放资源</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>日志接口</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TxnLog</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置服务状态</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setServerStats</span><span class="params">(ServerStats serverStats)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 滚动日志</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rollLog</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 追加日志</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">append</span><span class="params">(TxnHeader hdr, Record r)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取数据</span></span><br><span class="line">    <span class="function">TxnIterator <span class="title">read</span><span class="params">(<span class="keyword">long</span> zxid)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取最后一个 zxid</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getLastLoggedZxid</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除日志</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">truncate</span><span class="params">(<span class="keyword">long</span> zxid)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 DbId</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getDbId</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 提交</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 日志同步时间</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getTxnLogSyncElapsedTime</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭日志</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取日志的接口</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TxnIterator</span> </span>{</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取头信息</span></span><br><span class="line">        <span class="function">TxnHeader <span class="title">getHeader</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取传输的内容</span></span><br><span class="line">        <span class="function">Record <span class="title">getTxn</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 下一条记录</span></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">next</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭资源</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取存储的大小</span></span><br><span class="line">        <span class="function"><span class="keyword">long</span> <span class="title">getStorageSize</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>处理持久化的核心类</li></ul><p><img data-src="../../../asset/2025/01/zookeeper-source-2.png"></p><h3 id="ZK-序列化源码"><a href="#ZK-序列化源码" class="headerlink" title="ZK 序列化源码"></a>ZK 序列化源码</h3><p><code>zookeeper-jute</code> 模块是 ZooKeeper 序列化相关的源码。</p><p><img data-src="../../../asset/2025/01/zookeeper-source-3.png"></p><ul><li>序列化和反序列化方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Record</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 序列化方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(OutputArchive archive, String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 反序列化方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deserialize</span><span class="params">(InputArchive archive, String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>迭代接口</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Index</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 结束</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">done</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 下一个</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">incr</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>序列化支持的数据类型</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OutputArchive</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeByte</span><span class="params">(<span class="keyword">byte</span> b, String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeBool</span><span class="params">(<span class="keyword">boolean</span> b, String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeInt</span><span class="params">(<span class="keyword">int</span> i, String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeLong</span><span class="params">(<span class="keyword">long</span> l, String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeFloat</span><span class="params">(<span class="keyword">float</span> f, String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeDouble</span><span class="params">(<span class="keyword">double</span> d, String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeString</span><span class="params">(String s, String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeBuffer</span><span class="params">(<span class="keyword">byte</span> buf[], String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeRecord</span><span class="params">(Record r, String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startRecord</span><span class="params">(Record r, String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endRecord</span><span class="params">(Record r, String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startVector</span><span class="params">(List&lt;?&gt; v, String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endVector</span><span class="params">(List&lt;?&gt; v, String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startMap</span><span class="params">(TreeMap&lt;?,?&gt; v, String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endMap</span><span class="params">(TreeMap&lt;?,?&gt; v, String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>反序列化支持的数据类型</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InputArchive</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">byte</span> <span class="title">readByte</span><span class="params">(String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">readBool</span><span class="params">(String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">readInt</span><span class="params">(String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">readLong</span><span class="params">(String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">readFloat</span><span class="params">(String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">readDouble</span><span class="params">(String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">readString</span><span class="params">(String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] readBuffer(String tag) <span class="keyword">throws</span> IOException;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readRecord</span><span class="params">(Record r, String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startRecord</span><span class="params">(String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endRecord</span><span class="params">(String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Index <span class="title">startVector</span><span class="params">(String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endVector</span><span class="params">(String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Index <span class="title">startMap</span><span class="params">(String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endMap</span><span class="params">(String tag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="ZK-服务端初始化源码分析"><a href="#ZK-服务端初始化源码分析" class="headerlink" title="ZK 服务端初始化源码分析"></a>ZK 服务端初始化源码分析</h2><p><img data-src="../../../asset/2025/01/zookeeper-source-4.png"></p><h3 id="ZK-服务端启动脚本"><a href="#ZK-服务端启动脚本" class="headerlink" title="ZK 服务端启动脚本"></a>ZK 服务端启动脚本</h3><p>ZooKeeper 服务端的启动命令是 <code>zkServer.sh start</code>，其中 <code>zkServer.sh</code> 服务端脚本的核心源码如下：</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># use POSTIX interface, symlink is followed automatically</span></span><br><span class="line">ZOOBIN=<span class="string">"<span class="variable">${BASH_SOURCE-$0}</span>"</span></span><br><span class="line">ZOOBIN=<span class="string">"<span class="subst">$(dirname <span class="string">"<span class="variable">${ZOOBIN}</span>"</span>)</span>"</span></span><br><span class="line">ZOOBINDIR=<span class="string">"<span class="subst">$(cd <span class="string">"<span class="variable">${ZOOBIN}</span>"</span>; pwd)</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -e <span class="string">"<span class="variable">$ZOOBIN</span>/../libexec/zkEnv.sh"</span> ]; <span class="keyword">then</span></span><br><span class="line">  . <span class="string">"<span class="variable">$ZOOBINDIR</span>"</span>/../libexec/zkEnv.sh</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  . <span class="string">"<span class="variable">$ZOOBINDIR</span>"</span>/zkEnv.sh   <span class="comment"># 相当于获取 zkEnv.sh 中的环境变量（ZOOCFG="zoo.cfg"）</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># See the following page for extensive details on setting</span></span><br><span class="line"><span class="comment"># up the JVM to accept JMX remote management:</span></span><br><span class="line"><span class="comment"># http://java.sun.com/javase/6/docs/technotes/guides/management/agent.html</span></span><br><span class="line"><span class="comment"># by default we allow local JMX connections</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"x<span class="variable">$JMXLOCALONLY</span>"</span> = <span class="string">"x"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    JMXLOCALONLY=<span class="literal">false</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"x<span class="variable">$JMXDISABLE</span>"</span> = <span class="string">"x"</span> ] || [ <span class="string">"<span class="variable">$JMXDISABLE</span>"</span> = <span class="string">'false'</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"ZooKeeper JMX enabled by default"</span> &gt;&amp;2</span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">"x<span class="variable">$JMXPORT</span>"</span> = <span class="string">"x"</span> ]</span><br><span class="line">  <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># for some reason these two options are necessary on jdk6 on Ubuntu</span></span><br><span class="line">    <span class="comment">#   accord to the docs they are not necessary, but otw jconsole cannot</span></span><br><span class="line">    <span class="comment">#   do a local attach</span></span><br><span class="line">    ZOOMAIN=<span class="string">"-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.local.only=<span class="variable">$JMXLOCALONLY</span> org.apache.zookeeper.server.quorum.QuorumPeerMain"</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"x<span class="variable">$JMXAUTH</span>"</span> = <span class="string">"x"</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">      JMXAUTH=<span class="literal">false</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"x<span class="variable">$JMXSSL</span>"</span> = <span class="string">"x"</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">      JMXSSL=<span class="literal">false</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"x<span class="variable">$JMXLOG4J</span>"</span> = <span class="string">"x"</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">      JMXLOG4J=<span class="literal">true</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"ZooKeeper remote JMX Port set to <span class="variable">$JMXPORT</span>"</span> &gt;&amp;2</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"ZooKeeper remote JMX authenticate set to <span class="variable">$JMXAUTH</span>"</span> &gt;&amp;2</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"ZooKeeper remote JMX ssl set to <span class="variable">$JMXSSL</span>"</span> &gt;&amp;2</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"ZooKeeper remote JMX log4j set to <span class="variable">$JMXLOG4J</span>"</span> &gt;&amp;2</span><br><span class="line">    ZOOMAIN=<span class="string">"-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=<span class="variable">$JMXPORT</span> -Dcom.sun.management.jmxremote.authenticate=<span class="variable">$JMXAUTH</span> -Dcom.sun.management.jmxremote.ssl=<span class="variable">$JMXSSL</span> -Dzookeeper.jmx.log4j.disable=<span class="variable">$JMXLOG4J</span> org.apache.zookeeper.server.quorum.QuorumPeerMain"</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"JMX disabled by user request"</span> &gt;&amp;2</span><br><span class="line">    ZOOMAIN=<span class="string">"org.apache.zookeeper.server.quorum.QuorumPeerMain"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"x<span class="variable">$SERVER_JVMFLAGS</span>"</span> != <span class="string">"x"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    JVMFLAGS=<span class="string">"<span class="variable">$SERVER_JVMFLAGS</span> <span class="variable">$JVMFLAGS</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">    <span class="built_in">echo</span>  -n <span class="string">"Starting zookeeper ... "</span></span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="string">"<span class="variable">$ZOOPIDFILE</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">if</span> <span class="built_in">kill</span> -0 `cat <span class="string">"<span class="variable">$ZOOPIDFILE</span>"</span>` &gt; /dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">         <span class="built_in">echo</span> <span class="variable">$command</span> already running as process `cat <span class="string">"<span class="variable">$ZOOPIDFILE</span>"</span>`.</span><br><span class="line">         <span class="built_in">exit</span> 1</span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    nohup <span class="string">"<span class="variable">$JAVA</span>"</span> <span class="variable">$ZOO_DATADIR_AUTOCREATE</span> <span class="string">"-Dzookeeper.log.dir=<span class="variable">${ZOO_LOG_DIR}</span>"</span> \</span><br><span class="line">    <span class="string">"-Dzookeeper.log.file=<span class="variable">${ZOO_LOG_FILE}</span>"</span> <span class="string">"-Dzookeeper.root.logger=<span class="variable">${ZOO_LOG4J_PROP}</span>"</span> \</span><br><span class="line">    -XX:+HeapDumpOnOutOfMemoryError -XX:OnOutOfMemoryError=<span class="string">'kill -9 %p'</span> \</span><br><span class="line">    -cp <span class="string">"<span class="variable">$CLASSPATH</span>"</span> <span class="variable">$JVMFLAGS</span> <span class="variable">$ZOOMAIN</span> <span class="string">"<span class="variable">$ZOOCFG</span>"</span> &gt; <span class="string">"<span class="variable">$_ZOO_DAEMON_OUT</span>"</span> 2&gt;&amp;1 &lt; /dev/null &amp;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">    ;;</span><br><span class="line">stop)</span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"Stopping zookeeper ... "</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -f <span class="string">"<span class="variable">$ZOOPIDFILE</span>"</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"no zookeeper to stop (could not find file <span class="variable">$ZOOPIDFILE</span>)"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="variable">$KILL</span> $(cat <span class="string">"<span class="variable">$ZOOPIDFILE</span>"</span>)</span><br><span class="line">      rm <span class="string">"<span class="variable">$ZOOPIDFILE</span>"</span></span><br><span class="line">      sleep 1</span><br><span class="line">      <span class="built_in">echo</span> STOPPED</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line">    ;;</span><br><span class="line">restart)</span><br><span class="line">    <span class="built_in">shift</span></span><br><span class="line">    <span class="string">"<span class="variable">$0</span>"</span> stop <span class="variable">${@}</span></span><br><span class="line">    sleep 3</span><br><span class="line">    <span class="string">"<span class="variable">$0</span>"</span> start <span class="variable">${@}</span></span><br><span class="line">    ;;</span><br><span class="line">status)</span><br><span class="line"></span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line">    ;;</span><br><span class="line">*)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Usage: <span class="variable">$0</span> [--config &lt;conf-dir&gt;] {start|start-foreground|stop|restart|status|print-cmd}"</span> &gt;&amp;2</span><br><span class="line"></span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></tbody></table></figure><p>由于 <code>zkServer.sh start</code> 命令在底层实际执行内容如下：</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nohup <span class="string">"<span class="variable">$JAVA</span>"</span></span><br><span class="line">+ 一堆提交参数</span><br><span class="line">+ <span class="variable">$ZOOMAIN</span> (org.apache.zookeeper.server.quorum.QuorumPeerMain)</span><br><span class="line">+ <span class="string">"<span class="variable">$ZOOCFG</span>"</span> (zkEnv.sh 文件中 ZOOCFG=<span class="string">"zoo.cfg"</span>)</span><br></pre></td></tr></tbody></table></figure><p>所以 ZooKeeper 服务端的启动入口是 <code>QuorumPeerMain</code> 类。</p><h3 id="ZK-服务端启动入口"><a href="#ZK-服务端启动入口" class="headerlink" title="ZK 服务端启动入口"></a>ZK 服务端启动入口</h3><ul><li>服务端的启动入口类 <code>QuorumPeerMain</code></li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.zookeeper.server.quorum;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuorumPeerMain</span> </span>{ </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        <span class="comment">// 创建一个 ZK 节点</span></span><br><span class="line">        QuorumPeerMain main = <span class="keyword">new</span> QuorumPeerMain();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 初始化节点并运行，args 相当于提交参数中的 zoo.cfg</span></span><br><span class="line">            main.initializeAndRun(args);</span><br><span class="line">        } <span class="keyword">catch</span> (IllegalArgumentException e)</span><br><span class="line">        {</span><br><span class="line">            ......</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        LOG.info(<span class="string">"Exiting normally"</span>);</span><br><span class="line">        System.exit(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumPeerMain.initializeAndRun()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initializeAndRun</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ConfigException, IOException, AdminServerException</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// 管理 ZK 的配置信息</span></span><br><span class="line">    QuorumPeerConfig config = <span class="keyword">new</span> QuorumPeerConfig();</span><br><span class="line">    <span class="keyword">if</span> (args.length == <span class="number">1</span>) {</span><br><span class="line">        <span class="comment">// 解析参数，包括 zoo.cfg 和 myid 文件</span></span><br><span class="line">        config.parse(args[<span class="number">0</span>]);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动定时任务，对过期的快照执行删除（该功能默认关闭）</span></span><br><span class="line">    DatadirCleanupManager purgeMgr = <span class="keyword">new</span> DatadirCleanupManager(config</span><br><span class="line">            .getDataDir(), config.getDataLogDir(), config</span><br><span class="line">            .getSnapRetainCount(), config.getPurgeInterval());</span><br><span class="line">    purgeMgr.start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (args.length == <span class="number">1</span> &amp;&amp; config.isDistributed()) {</span><br><span class="line">        <span class="comment">// 集群模式启动</span></span><br><span class="line">        runFromConfig(config);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        LOG.warn(<span class="string">"Either no config or no quorum defined in config, running "</span></span><br><span class="line">                + <span class="string">" in standalone mode"</span>);</span><br><span class="line">        <span class="comment">// 单机模式启动</span></span><br><span class="line">        ZooKeeperServerMain.main(args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="解析配置参数"><a href="#解析配置参数" class="headerlink" title="解析配置参数"></a>解析配置参数</h3><div class="admonition note"><p class="admonition-title">提示</p><ul><li>ZooKeeper 在启动时，会解析 <code>zoo.cfg</code> 和 <code>myid</code> 配置文件（集群模式才需要有 <code>myid</code> 文件），从而获取配置参数。</li><li><code>zoo.cfg</code> 配置文件，定义了整个 ZooKeeper 集群的配置参数，比如端口号、数据存储路径和服务器列表。</li><li><code>myid</code> 节点标识文件，存放了当前节点的唯一编号，用于区分集群中的各个节点。</li></ul></div><ul><li><code>QuorumPeerConfig.parse()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">(String path)</span> <span class="keyword">throws</span> ConfigException </span>{</span><br><span class="line">    LOG.info(<span class="string">"Reading configuration from: "</span> + path);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        File configFile = (<span class="keyword">new</span> VerifyingFileFactory.Builder(LOG)</span><br><span class="line">            .warnForRelativePath()</span><br><span class="line">            .failForNonExistingPath()</span><br><span class="line">            .build()).create(path);</span><br><span class="line">            </span><br><span class="line">        Properties cfg = <span class="keyword">new</span> Properties();</span><br><span class="line">        FileInputStream in = <span class="keyword">new</span> FileInputStream(configFile);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 加载配置文件</span></span><br><span class="line">            cfg.load(in);</span><br><span class="line">            configFileStr = path;</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            in.close();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析配置文件</span></span><br><span class="line">        parseProperties(cfg);</span><br><span class="line">    } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConfigException(<span class="string">"Error processing "</span> + path, e);</span><br><span class="line">    } <span class="keyword">catch</span> (IllegalArgumentException e) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConfigException(<span class="string">"Error processing "</span> + path, e);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumPeerConfig.parseProperties()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseProperties</span><span class="params">(Properties zkProp)</span> <span class="keyword">throws</span> IOException, ConfigException </span>{</span><br><span class="line">    <span class="keyword">int</span> clientPort = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> secureClientPort = <span class="number">0</span>;</span><br><span class="line">    String clientPortAddress = <span class="keyword">null</span>;</span><br><span class="line">    String secureClientPortAddress = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取 zoo.cfg 文件中的配置参数，并赋值给 QuorumPeerConfig 的类对象</span></span><br><span class="line">    VerifyingFileFactory vff = <span class="keyword">new</span> VerifyingFileFactory.Builder(LOG).warnForRelativePath().build();</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;Object, Object&gt; entry : zkProp.entrySet()) {</span><br><span class="line">        String key = entry.getKey().toString().trim();</span><br><span class="line">        String value = entry.getValue().toString().trim();</span><br><span class="line">        <span class="keyword">if</span> (key.equals(<span class="string">"dataDir"</span>)) {</span><br><span class="line">            dataDir = vff.create(value);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (key.equals(<span class="string">"dataLogDir"</span>)) {</span><br><span class="line">            dataLogDir = vff.create(value);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (key.equals(<span class="string">"clientPort"</span>)) {</span><br><span class="line">            clientPort = Integer.parseInt(value);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (key.equals(<span class="string">"localSessionsEnabled"</span>)) {</span><br><span class="line">            localSessionsEnabled = Boolean.parseBoolean(value);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (key.equals(<span class="string">"localSessionsUpgradingEnabled"</span>)) {</span><br><span class="line">            localSessionsUpgradingEnabled = Boolean.parseBoolean(value);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (key.equals(<span class="string">"clientPortAddress"</span>)) {</span><br><span class="line">            clientPortAddress = value.trim();</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (key.equals(<span class="string">"secureClientPort"</span>)) {</span><br><span class="line">            secureClientPort = Integer.parseInt(value);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (key.equals(<span class="string">"secureClientPortAddress"</span>)){</span><br><span class="line">            secureClientPortAddress = value.trim();</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (key.equals(<span class="string">"tickTime"</span>)) {</span><br><span class="line">            tickTime = Integer.parseInt(value);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (key.equals(<span class="string">"maxClientCnxns"</span>)) {</span><br><span class="line">            maxClientCnxns = Integer.parseInt(value);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (key.equals(<span class="string">"minSessionTimeout"</span>)) {</span><br><span class="line">            minSessionTimeout = Integer.parseInt(value);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (key.equals(<span class="string">"maxSessionTimeout"</span>)) {</span><br><span class="line">            maxSessionTimeout = Integer.parseInt(value);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (key.equals(<span class="string">"initLimit"</span>)) {</span><br><span class="line">            initLimit = Integer.parseInt(value);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (key.equals(<span class="string">"syncLimit"</span>)) {</span><br><span class="line">            syncLimit = Integer.parseInt(value);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dynamicConfigFileStr == <span class="keyword">null</span>) {</span><br><span class="line">        setupQuorumPeerConfig(zkProp, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (isDistributed() &amp;&amp; isReconfigEnabled()) {</span><br><span class="line">            backupOldConfig();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumPeerConfig.setupQuorumPeerConfig()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setupQuorumPeerConfig</span><span class="params">(Properties prop, <span class="keyword">boolean</span> configBackwardCompatibilityMode)</span> <span class="keyword">throws</span> IOException, ConfigException </span>{</span><br><span class="line">    quorumVerifier = parseDynamicConfig(prop, electionAlg, <span class="keyword">true</span>, configBackwardCompatibilityMode);</span><br><span class="line">    <span class="comment">// 初始化 myid</span></span><br><span class="line">    setupMyId();</span><br><span class="line">    setupClientPort();</span><br><span class="line">    setupPeerType();</span><br><span class="line">    checkValidity();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumPeerConfig.setupMyId()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupMyId</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    File myIdFile = <span class="keyword">new</span> File(dataDir, <span class="string">"myid"</span>);</span><br><span class="line">    <span class="comment">// standalone server doesn't need myid file.</span></span><br><span class="line">    <span class="keyword">if</span> (!myIdFile.isFile()) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(myIdFile));</span><br><span class="line">    String myIdString;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        myIdString = br.readLine();</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        br.close();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 解析 myid 文件中的 id，并赋值给 serverId</span></span><br><span class="line">        serverId = Long.parseLong(myIdString);</span><br><span class="line">        MDC.put(<span class="string">"myid"</span>, myIdString);</span><br><span class="line">    } <span class="keyword">catch</span> (NumberFormatException e) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"serverid "</span> + myIdString</span><br><span class="line">                + <span class="string">" is not a number"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="过期快照删除"><a href="#过期快照删除" class="headerlink" title="过期快照删除"></a>过期快照删除</h3><ul><li><code>QuorumPeerMain.initializeAndRun()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initializeAndRun</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ConfigException, IOException, AdminServerException</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// 管理 ZK 的配置信息</span></span><br><span class="line">    QuorumPeerConfig config = <span class="keyword">new</span> QuorumPeerConfig();</span><br><span class="line">    <span class="keyword">if</span> (args.length == <span class="number">1</span>) {</span><br><span class="line">        <span class="comment">// 解析参数，包括 zoo.cfg 和 myid 文件</span></span><br><span class="line">        config.parse(args[<span class="number">0</span>]);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动定时任务，对过期的快照执行删除（该功能默认关闭）</span></span><br><span class="line">    <span class="comment">// snapRetainCount = 3，最少保留的快照数量</span></span><br><span class="line">    <span class="comment">// purgeInterval = 0，默认值为 0，表示默认关闭快照清除任务</span></span><br><span class="line">    DatadirCleanupManager purgeMgr = <span class="keyword">new</span> DatadirCleanupManager(config</span><br><span class="line">            .getDataDir(), config.getDataLogDir(), config</span><br><span class="line">            .getSnapRetainCount(), config.getPurgeInterval());</span><br><span class="line">    purgeMgr.start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (args.length == <span class="number">1</span> &amp;&amp; config.isDistributed()) {</span><br><span class="line">        <span class="comment">// 集群模式启动</span></span><br><span class="line">        runFromConfig(config);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        LOG.warn(<span class="string">"Either no config or no quorum defined in config, running "</span></span><br><span class="line">                + <span class="string">" in standalone mode"</span>);</span><br><span class="line">        <span class="comment">// 单机模式启动</span></span><br><span class="line">        ZooKeeperServerMain.main(args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>DatadirCleanupManager.start()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (PurgeTaskStatus.STARTED == purgeTaskStatus) {</span><br><span class="line">        LOG.warn(<span class="string">"Purge task is already running."</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 默认情况 purgeInterval 的值为 0，也就是删除任务默认会关闭，直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (purgeInterval &lt;= <span class="number">0</span>) {</span><br><span class="line">        LOG.info(<span class="string">"Purge task is not scheduled."</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个定时器</span></span><br><span class="line">    timer = <span class="keyword">new</span> Timer(<span class="string">"PurgeTask"</span>, <span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// 创建一个清理快照的任务</span></span><br><span class="line">    TimerTask task = <span class="keyword">new</span> PurgeTask(dataLogDir, snapDir, snapRetainCount);</span><br><span class="line">    <span class="comment">// 如果 purgeInterval 的值设置为 1，则表示 1 小时检查一次是否有快照过期，有则删除快照</span></span><br><span class="line">    timer.scheduleAtFixedRate(task, <span class="number">0</span>, TimeUnit.HOURS.toMillis(purgeInterval));</span><br><span class="line"></span><br><span class="line">    purgeTaskStatus = PurgeTaskStatus.STARTED;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>PurgeTask</code> 任务类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PurgeTask</span> <span class="keyword">extends</span> <span class="title">TimerTask</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> File logsDir;</span><br><span class="line">    <span class="keyword">private</span> File snapsDir;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> snapRetainCount;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PurgeTask</span><span class="params">(File dataDir, File snapDir, <span class="keyword">int</span> count)</span> </span>{</span><br><span class="line">        logsDir = dataDir;</span><br><span class="line">        snapsDir = snapDir;</span><br><span class="line">        snapRetainCount = count;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">        LOG.info(<span class="string">"Purge task started."</span>);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 清理过期快照</span></span><br><span class="line">            PurgeTxnLog.purge(logsDir, snapsDir, snapRetainCount);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            LOG.error(<span class="string">"Error occurred while purging."</span>, e);</span><br><span class="line">        }</span><br><span class="line">        LOG.info(<span class="string">"Purge task completed."</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>PurgeTxnLog.purge()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">purge</span><span class="params">(File dataDir, File snapDir, <span class="keyword">int</span> num)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    <span class="keyword">if</span> (num &lt; <span class="number">3</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(COUNT_ERR_MSG);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    FileTxnSnapLog txnLog = <span class="keyword">new</span> FileTxnSnapLog(dataDir, snapDir);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取最近的快照</span></span><br><span class="line">    List&lt;File&gt; snaps = txnLog.findNRecentSnapshots(num);</span><br><span class="line">    <span class="keyword">int</span> numSnaps = snaps.size();</span><br><span class="line">    <span class="keyword">if</span> (numSnaps &gt; <span class="number">0</span>) {</span><br><span class="line">        <span class="comment">// 清理旧快照</span></span><br><span class="line">        purgeOlderSnapshots(txnLog, snaps.get(numSnaps - <span class="number">1</span>));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="初始化通信组件"><a href="#初始化通信组件" class="headerlink" title="初始化通信组件"></a>初始化通信组件</h3><h4 id="I-O-模型默认为-NIO-通信"><a href="#I-O-模型默认为-NIO-通信" class="headerlink" title="I/O 模型默认为 NIO 通信"></a>I/O 模型默认为 NIO 通信</h4><ul><li><code>QuorumPeerMain.initializeAndRun()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initializeAndRun</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ConfigException, IOException, AdminServerException</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// 管理 ZK 的配置信息</span></span><br><span class="line">    QuorumPeerConfig config = <span class="keyword">new</span> QuorumPeerConfig();</span><br><span class="line">    <span class="keyword">if</span> (args.length == <span class="number">1</span>) {</span><br><span class="line">        <span class="comment">// 解析参数，包括 zoo.cfg 和 myid 文件</span></span><br><span class="line">        config.parse(args[<span class="number">0</span>]);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动定时任务，对过期的快照执行删除（该功能默认关闭）</span></span><br><span class="line">    DatadirCleanupManager purgeMgr = <span class="keyword">new</span> DatadirCleanupManager(config</span><br><span class="line">            .getDataDir(), config.getDataLogDir(), config</span><br><span class="line">            .getSnapRetainCount(), config.getPurgeInterval());</span><br><span class="line">    purgeMgr.start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (args.length == <span class="number">1</span> &amp;&amp; config.isDistributed()) {</span><br><span class="line">        <span class="comment">// 集群模式启动</span></span><br><span class="line">        runFromConfig(config);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        LOG.warn(<span class="string">"Either no config or no quorum defined in config, running "</span></span><br><span class="line">                + <span class="string">" in standalone mode"</span>);</span><br><span class="line">        <span class="comment">// 单机模式启动</span></span><br><span class="line">        ZooKeeperServerMain.main(args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumPeerMain.runFromConfig()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runFromConfig</span><span class="params">(QuorumPeerConfig config)</span> <span class="keyword">throws</span> IOException, AdminServerException</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        ManagedUtil.registerLog4jMBeans();</span><br><span class="line">    } <span class="keyword">catch</span> (JMException e) {</span><br><span class="line">        LOG.warn(<span class="string">"Unable to register log4j JMX control"</span>, e);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    LOG.info(<span class="string">"Starting quorum peer"</span>);</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        ServerCnxnFactory cnxnFactory = <span class="keyword">null</span>;</span><br><span class="line">        ServerCnxnFactory secureCnxnFactory = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通信组件初始化，默认是使用 NIO 通信（可以支持 Netty）</span></span><br><span class="line">        <span class="keyword">if</span> (config.getClientPortAddress() != <span class="keyword">null</span>) {</span><br><span class="line">            cnxnFactory = ServerCnxnFactory.createFactory();</span><br><span class="line">            cnxnFactory.configure(config.getClientPortAddress(),</span><br><span class="line">                    config.getMaxClientCnxns(),</span><br><span class="line">                    <span class="keyword">false</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (config.getSecureClientPortAddress() != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">// 初始化 NIO 服务端的 Socket，绑定 2181 端口</span></span><br><span class="line">            secureCnxnFactory = ServerCnxnFactory.createFactory();</span><br><span class="line">            secureCnxnFactory.configure(config.getSecureClientPortAddress(),</span><br><span class="line">                    config.getMaxClientCnxns(),</span><br><span class="line">                    <span class="keyword">true</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将解析到的参数赋值给该 ZK 集群节点</span></span><br><span class="line">        quorumPeer = getQuorumPeer();</span><br><span class="line">        quorumPeer.setTxnFactory(<span class="keyword">new</span> FileTxnSnapLog(</span><br><span class="line">                    config.getDataLogDir(),</span><br><span class="line">                    config.getDataDir()));</span><br><span class="line">        quorumPeer.enableLocalSessions(config.areLocalSessionsEnabled());</span><br><span class="line">        quorumPeer.enableLocalSessionsUpgrading(</span><br><span class="line">            config.isLocalSessionsUpgradingEnabled());</span><br><span class="line">        <span class="comment">//quorumPeer.setQuorumPeers(config.getAllMembers());</span></span><br><span class="line">        quorumPeer.setElectionType(config.getElectionAlg());</span><br><span class="line">        quorumPeer.setMyid(config.getServerId());</span><br><span class="line">        quorumPeer.setTickTime(config.getTickTime());</span><br><span class="line">        quorumPeer.setMinSessionTimeout(config.getMinSessionTimeout());</span><br><span class="line">        quorumPeer.setMaxSessionTimeout(config.getMaxSessionTimeout());</span><br><span class="line">        quorumPeer.setInitLimit(config.getInitLimit());</span><br><span class="line">        quorumPeer.setSyncLimit(config.getSyncLimit());</span><br><span class="line">        quorumPeer.setConfigFileName(config.getConfigFilename());</span><br><span class="line">        <span class="comment">// 管理 ZK 数据的存储</span></span><br><span class="line">        quorumPeer.setZKDatabase(<span class="keyword">new</span> ZKDatabase(quorumPeer.getTxnFactory()));</span><br><span class="line">        quorumPeer.setQuorumVerifier(config.getQuorumVerifier(), <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (config.getLastSeenQuorumVerifier()!=<span class="keyword">null</span>) {</span><br><span class="line">            quorumPeer.setLastSeenQuorumVerifier(config.getLastSeenQuorumVerifier(), <span class="keyword">false</span>);</span><br><span class="line">        }</span><br><span class="line">        quorumPeer.initConfigInZKDatabase();</span><br><span class="line">        <span class="comment">// 管理 ZK 的网络通信</span></span><br><span class="line">        quorumPeer.setCnxnFactory(cnxnFactory);</span><br><span class="line">        quorumPeer.setSecureCnxnFactory(secureCnxnFactory);</span><br><span class="line">        quorumPeer.setSslQuorum(config.isSslQuorum());</span><br><span class="line">        quorumPeer.setUsePortUnification(config.shouldUsePortUnification());</span><br><span class="line">        quorumPeer.setLearnerType(config.getPeerType());</span><br><span class="line">        quorumPeer.setSyncEnabled(config.getSyncEnabled());</span><br><span class="line">        quorumPeer.setQuorumListenOnAllIPs(config.getQuorumListenOnAllIPs());</span><br><span class="line">        <span class="keyword">if</span> (config.sslQuorumReloadCertFiles) {</span><br><span class="line">            quorumPeer.getX509Util().enableCertFileReloading();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sets quorum sasl authentication configurations</span></span><br><span class="line">        quorumPeer.setQuorumSaslEnabled(config.quorumEnableSasl);</span><br><span class="line">        <span class="keyword">if</span>(quorumPeer.isQuorumSaslAuthEnabled()){</span><br><span class="line">            quorumPeer.setQuorumServerSaslRequired(config.quorumServerRequireSasl);</span><br><span class="line">            quorumPeer.setQuorumLearnerSaslRequired(config.quorumLearnerRequireSasl);</span><br><span class="line">            quorumPeer.setQuorumServicePrincipal(config.quorumServicePrincipal);</span><br><span class="line">            quorumPeer.setQuorumServerLoginContext(config.quorumServerLoginContext);</span><br><span class="line">            quorumPeer.setQuorumLearnerLoginContext(config.quorumLearnerLoginContext);</span><br><span class="line">        }</span><br><span class="line">        quorumPeer.setQuorumCnxnThreadsSize(config.quorumCnxnThreadsSize);</span><br><span class="line">        quorumPeer.initialize();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 启动 ZK 集群节点</span></span><br><span class="line">        quorumPeer.start();</span><br><span class="line">        quorumPeer.join();</span><br><span class="line">    } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">        <span class="comment">// warn, but generally this is ok</span></span><br><span class="line">        LOG.warn(<span class="string">"Quorum Peer interrupted"</span>, e);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>ServerCnxnFactory.createFactory()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ZOOKEEPER_SERVER_CNXN_FACTORY = <span class="string">"zookeeper.serverCnxnFactory"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> ServerCnxnFactory <span class="title">createFactory</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    String serverCnxnFactoryName =</span><br><span class="line">        System.getProperty(ZOOKEEPER_SERVER_CNXN_FACTORY);</span><br><span class="line">    <span class="keyword">if</span> (serverCnxnFactoryName == <span class="keyword">null</span>) {</span><br><span class="line">        serverCnxnFactoryName = NIOServerCnxnFactory.class.getName();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        ServerCnxnFactory serverCnxnFactory = (ServerCnxnFactory) Class.forName(serverCnxnFactoryName)</span><br><span class="line">                .getDeclaredConstructor().newInstance();</span><br><span class="line">        LOG.info(<span class="string">"Using {} as server connection factory"</span>, serverCnxnFactoryName);</span><br><span class="line">        <span class="keyword">return</span> serverCnxnFactory;</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        IOException ioe = <span class="keyword">new</span> IOException(<span class="string">"Couldn't instantiate "</span></span><br><span class="line">                + serverCnxnFactoryName);</span><br><span class="line">        ioe.initCause(e);</span><br><span class="line">        <span class="keyword">throw</span> ioe;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>在 <code>zookeeper-docs</code> 模块的 <code>zookeeperAdmin.md</code> 文件中，有以下这么一段说明：</p><figure class="highlight markdown"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">serverCnxnFactory :</span><br><span class="line"><span class="code">    (Java system property: zookeeper.serverCnxnFactory)</span></span><br><span class="line"><span class="code">    Specifies ServerCnxnFactory implementation. </span></span><br><span class="line"><span class="code">    This should be set to `NettyServerCnxnFactory` in order to use TLS based server communication.</span></span><br><span class="line"><span class="code">    Default is `NIOServerCnxnFactory`.</span></span><br></pre></td></tr></tbody></table></figure><h4 id="初始化-NIO-服务端的-Socket"><a href="#初始化-NIO-服务端的-Socket" class="headerlink" title="初始化 NIO 服务端的 Socket"></a>初始化 NIO 服务端的 Socket</h4><div class="admonition note"><p class="admonition-title">提示</p><p>这里初始化 NIO 服务端的 Socket 时，ZooKeeper 并未启动。</p></div><ul><li><code>NIOServerCnxnFactory.configure()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(InetSocketAddress addr, <span class="keyword">int</span> maxcc, <span class="keyword">boolean</span> secure)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    <span class="keyword">if</span> (secure) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"SSL isn't supported in NIOServerCnxn"</span>);</span><br><span class="line">    }</span><br><span class="line">    configureSaslLogin();</span><br><span class="line"></span><br><span class="line">    maxClientCnxns = maxcc;</span><br><span class="line">    sessionlessCnxnTimeout = Integer.getInteger(</span><br><span class="line">        ZOOKEEPER_NIO_SESSIONLESS_CNXN_TIMEOUT, <span class="number">10000</span>);</span><br><span class="line">    <span class="comment">// We also use the sessionlessCnxnTimeout as expiring interval for</span></span><br><span class="line">    <span class="comment">// cnxnExpiryQueue. These don't need to be the same, but the expiring</span></span><br><span class="line">    <span class="comment">// interval passed into the ExpiryQueue() constructor below should be</span></span><br><span class="line">    <span class="comment">// less than or equal to the timeout.</span></span><br><span class="line">    cnxnExpiryQueue =</span><br><span class="line">        <span class="keyword">new</span> ExpiryQueue&lt;NIOServerCnxn&gt;(sessionlessCnxnTimeout);</span><br><span class="line">    expirerThread = <span class="keyword">new</span> ConnectionExpirerThread();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> numCores = Runtime.getRuntime().availableProcessors();</span><br><span class="line">    <span class="comment">// 32 cores sweet spot seems to be 4 selector threads</span></span><br><span class="line">    numSelectorThreads = Integer.getInteger(</span><br><span class="line">        ZOOKEEPER_NIO_NUM_SELECTOR_THREADS,</span><br><span class="line">        Math.max((<span class="keyword">int</span>) Math.sqrt((<span class="keyword">float</span>) numCores/<span class="number">2</span>), <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">if</span> (numSelectorThreads &lt; <span class="number">1</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"numSelectorThreads must be at least 1"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    numWorkerThreads = Integer.getInteger(</span><br><span class="line">        ZOOKEEPER_NIO_NUM_WORKER_THREADS, <span class="number">2</span> * numCores);</span><br><span class="line">    workerShutdownTimeoutMS = Long.getLong(</span><br><span class="line">        ZOOKEEPER_NIO_SHUTDOWN_TIMEOUT, <span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line">    LOG.info(<span class="string">"Configuring NIO connection handler with "</span></span><br><span class="line">                + (sessionlessCnxnTimeout/<span class="number">1000</span>) + <span class="string">"s sessionless connection"</span></span><br><span class="line">                + <span class="string">" timeout, "</span> + numSelectorThreads + <span class="string">" selector thread(s), "</span></span><br><span class="line">                + (numWorkerThreads &gt; <span class="number">0</span> ? numWorkerThreads : <span class="string">"no"</span>)</span><br><span class="line">                + <span class="string">" worker threads, and "</span></span><br><span class="line">                + (directBufferBytes == <span class="number">0</span> ? <span class="string">"gathered writes."</span> :</span><br><span class="line">                (<span class="string">""</span> + (directBufferBytes/<span class="number">1024</span>) + <span class="string">" kB direct buffers."</span>)));</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;numSelectorThreads; ++i) {</span><br><span class="line">        selectorThreads.add(<span class="keyword">new</span> SelectorThread(i));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 NIO 服务端的 Socket，绑定 2181 端口，可以接收客户端请求</span></span><br><span class="line">    <span class="keyword">this</span>.ss = ServerSocketChannel.open();</span><br><span class="line">    ss.socket().setReuseAddress(<span class="keyword">true</span>);</span><br><span class="line">    LOG.info(<span class="string">"binding to port "</span> + addr);</span><br><span class="line">    <span class="comment">// 绑定 2181 端口</span></span><br><span class="line">    ss.socket().bind(addr);</span><br><span class="line">    ss.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">    acceptThread = <span class="keyword">new</span> AcceptThread(ss, addr, selectorThreads);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="ZK-服务端加载数据源码分析"><a href="#ZK-服务端加载数据源码分析" class="headerlink" title="ZK 服务端加载数据源码分析"></a>ZK 服务端加载数据源码分析</h2><p><img data-src="../../../asset/2025/01/zookeeper-source-5.png"></p><h3 id="ZK-的数据存储模型"><a href="#ZK-的数据存储模型" class="headerlink" title="ZK 的数据存储模型"></a>ZK 的数据存储模型</h3><p>Leader 和 Follower 中的数据会在内存和磁盘中各保存一份，所以需要将内存中的数据持久化到磁盘中（如下图所示）。</p><ul><li>(1) ZooKeeper 中的数据模型是一棵树（DataTree），每个节点叫做 DataNode。</li><li>(2) ZooKeeper 集群中的 DataTree 时刻都保持状态同步。</li><li>(3) Zookeeper 集群中每个节点的数据在内存和磁盘中都有一份完整的数据。<ul><li>内存数据：DataTree</li><li> 磁盘数据：快照文件 + 编辑日志</li></ul></li></ul><p><img data-src="../../../asset/2025/01/zookeeper-source-1.png"></p><h3 id="ZK-集群节点的启动"><a href="#ZK-集群节点的启动" class="headerlink" title="ZK 集群节点的启动"></a>ZK 集群节点的启动</h3><ul><li><code>QuorumPeerMain.initializeAndRun()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initializeAndRun</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ConfigException, IOException, AdminServerException</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// 管理 ZK 的配置信息</span></span><br><span class="line">    QuorumPeerConfig config = <span class="keyword">new</span> QuorumPeerConfig();</span><br><span class="line">    <span class="keyword">if</span> (args.length == <span class="number">1</span>) {</span><br><span class="line">        <span class="comment">// 解析参数，包括 zoo.cfg 和 myid 文件</span></span><br><span class="line">        config.parse(args[<span class="number">0</span>]);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动定时任务，对过期的快照执行删除（该功能默认关闭）</span></span><br><span class="line">    DatadirCleanupManager purgeMgr = <span class="keyword">new</span> DatadirCleanupManager(config</span><br><span class="line">            .getDataDir(), config.getDataLogDir(), config</span><br><span class="line">            .getSnapRetainCount(), config.getPurgeInterval());</span><br><span class="line">    purgeMgr.start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (args.length == <span class="number">1</span> &amp;&amp; config.isDistributed()) {</span><br><span class="line">        <span class="comment">// 集群模式启动</span></span><br><span class="line">        runFromConfig(config);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        LOG.warn(<span class="string">"Either no config or no quorum defined in config, running "</span></span><br><span class="line">                + <span class="string">" in standalone mode"</span>);</span><br><span class="line">        <span class="comment">// 单机模式启动</span></span><br><span class="line">        ZooKeeperServerMain.main(args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumPeerMain.runFromConfig()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runFromConfig</span><span class="params">(QuorumPeerConfig config)</span> <span class="keyword">throws</span> IOException, AdminServerException</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        ManagedUtil.registerLog4jMBeans();</span><br><span class="line">    } <span class="keyword">catch</span> (JMException e) {</span><br><span class="line">        LOG.warn(<span class="string">"Unable to register log4j JMX control"</span>, e);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    LOG.info(<span class="string">"Starting quorum peer"</span>);</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        ServerCnxnFactory cnxnFactory = <span class="keyword">null</span>;</span><br><span class="line">        ServerCnxnFactory secureCnxnFactory = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通信组件初始化，默认是使用 NIO 通信（可以支持 Netty）</span></span><br><span class="line">        <span class="keyword">if</span> (config.getClientPortAddress() != <span class="keyword">null</span>) {</span><br><span class="line">            cnxnFactory = ServerCnxnFactory.createFactory();</span><br><span class="line">            cnxnFactory.configure(config.getClientPortAddress(),</span><br><span class="line">                    config.getMaxClientCnxns(),</span><br><span class="line">                    <span class="keyword">false</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (config.getSecureClientPortAddress() != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">// 初始化 NIO 服务端的 Socket，绑定 2181 端口</span></span><br><span class="line">            secureCnxnFactory = ServerCnxnFactory.createFactory();</span><br><span class="line">            secureCnxnFactory.configure(config.getSecureClientPortAddress(),</span><br><span class="line">                    config.getMaxClientCnxns(),</span><br><span class="line">                    <span class="keyword">true</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将解析到的参数赋值给该 ZK 集群节点</span></span><br><span class="line">        quorumPeer = getQuorumPeer();</span><br><span class="line">        quorumPeer.setTxnFactory(<span class="keyword">new</span> FileTxnSnapLog(</span><br><span class="line">                    config.getDataLogDir(),</span><br><span class="line">                    config.getDataDir()));</span><br><span class="line">        quorumPeer.enableLocalSessions(config.areLocalSessionsEnabled());</span><br><span class="line">        quorumPeer.enableLocalSessionsUpgrading(</span><br><span class="line">            config.isLocalSessionsUpgradingEnabled());</span><br><span class="line">        <span class="comment">//quorumPeer.setQuorumPeers(config.getAllMembers());</span></span><br><span class="line">        quorumPeer.setElectionType(config.getElectionAlg());</span><br><span class="line">        quorumPeer.setMyid(config.getServerId());</span><br><span class="line">        quorumPeer.setTickTime(config.getTickTime());</span><br><span class="line">        quorumPeer.setMinSessionTimeout(config.getMinSessionTimeout());</span><br><span class="line">        quorumPeer.setMaxSessionTimeout(config.getMaxSessionTimeout());</span><br><span class="line">        quorumPeer.setInitLimit(config.getInitLimit());</span><br><span class="line">        quorumPeer.setSyncLimit(config.getSyncLimit());</span><br><span class="line">        quorumPeer.setConfigFileName(config.getConfigFilename());</span><br><span class="line">        <span class="comment">// 管理 ZK 数据的存储</span></span><br><span class="line">        quorumPeer.setZKDatabase(<span class="keyword">new</span> ZKDatabase(quorumPeer.getTxnFactory()));</span><br><span class="line">        quorumPeer.setQuorumVerifier(config.getQuorumVerifier(), <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (config.getLastSeenQuorumVerifier()!=<span class="keyword">null</span>) {</span><br><span class="line">            quorumPeer.setLastSeenQuorumVerifier(config.getLastSeenQuorumVerifier(), <span class="keyword">false</span>);</span><br><span class="line">        }</span><br><span class="line">        quorumPeer.initConfigInZKDatabase();</span><br><span class="line">        <span class="comment">// 管理 ZK 的网络通信</span></span><br><span class="line">        quorumPeer.setCnxnFactory(cnxnFactory);</span><br><span class="line">        quorumPeer.setSecureCnxnFactory(secureCnxnFactory);</span><br><span class="line">        quorumPeer.setSslQuorum(config.isSslQuorum());</span><br><span class="line">        quorumPeer.setUsePortUnification(config.shouldUsePortUnification());</span><br><span class="line">        quorumPeer.setLearnerType(config.getPeerType());</span><br><span class="line">        quorumPeer.setSyncEnabled(config.getSyncEnabled());</span><br><span class="line">        quorumPeer.setQuorumListenOnAllIPs(config.getQuorumListenOnAllIPs());</span><br><span class="line">        <span class="keyword">if</span> (config.sslQuorumReloadCertFiles) {</span><br><span class="line">            quorumPeer.getX509Util().enableCertFileReloading();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sets quorum sasl authentication configurations</span></span><br><span class="line">        quorumPeer.setQuorumSaslEnabled(config.quorumEnableSasl);</span><br><span class="line">        <span class="keyword">if</span>(quorumPeer.isQuorumSaslAuthEnabled()){</span><br><span class="line">            quorumPeer.setQuorumServerSaslRequired(config.quorumServerRequireSasl);</span><br><span class="line">            quorumPeer.setQuorumLearnerSaslRequired(config.quorumLearnerRequireSasl);</span><br><span class="line">            quorumPeer.setQuorumServicePrincipal(config.quorumServicePrincipal);</span><br><span class="line">            quorumPeer.setQuorumServerLoginContext(config.quorumServerLoginContext);</span><br><span class="line">            quorumPeer.setQuorumLearnerLoginContext(config.quorumLearnerLoginContext);</span><br><span class="line">        }</span><br><span class="line">        quorumPeer.setQuorumCnxnThreadsSize(config.quorumCnxnThreadsSize);</span><br><span class="line">        quorumPeer.initialize();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 启动 ZK 集群节点</span></span><br><span class="line">        quorumPeer.start();</span><br><span class="line">        quorumPeer.join();</span><br><span class="line">    } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">        <span class="comment">// warn, but generally this is ok</span></span><br><span class="line">        LOG.warn(<span class="string">"Quorum Peer interrupted"</span>, e);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="冷启动数据恢复快照数据"><a href="#冷启动数据恢复快照数据" class="headerlink" title="冷启动数据恢复快照数据"></a>冷启动数据恢复快照数据</h3><ul><li><code>QuorumPeer.start()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (!getView().containsKey(myid)) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"My id "</span> + myid + <span class="string">" not in the peer list"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 冷启动恢复数据</span></span><br><span class="line">    loadDataBase();</span><br><span class="line">    startServerCnxnFactory();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 启动通信工厂实例对象</span></span><br><span class="line">        adminServer.start();</span><br><span class="line">    } <span class="keyword">catch</span> (AdminServerException e) {</span><br><span class="line">        LOG.warn(<span class="string">"Problem starting AdminServer"</span>, e);</span><br><span class="line">        System.out.println(e);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 准备选举环境</span></span><br><span class="line">    startLeaderElection();</span><br><span class="line">    <span class="comment">// 执行选举</span></span><br><span class="line">    <span class="keyword">super</span>.start();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumPeer.loadDataBase()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadDataBase</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// ZK 的操作分两种：事务操作和非事务操作</span></span><br><span class="line">        <span class="comment">// 事务操作：zk.cteate()，都会被分配一个全局唯一的 zxid。这里 zxid 的组成：64 位（前 32 位：epoch 每个 Leader 任期的代号；后 32 位：txid 为事务 ID）</span></span><br><span class="line">        <span class="comment">// 非事务操作：zk.getData()</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加载磁盘数据到内存，恢复 DataTree，数据恢复过程：</span></span><br><span class="line">        <span class="comment">// (1) 从快照文件中恢复大部分数据，并得到一个 lastProcessZXid</span></span><br><span class="line">        <span class="comment">// (2) 再从编辑日志中执行 replay，执行到最后一条日志并更新 lastProcessZXid</span></span><br><span class="line">        <span class="comment">// (3) 最终得到 DataTree 和 lastProcessZXid，表示数据恢复完成</span></span><br><span class="line">        zkDb.loadDataBase();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// load the epochs</span></span><br><span class="line">        <span class="keyword">long</span> lastProcessedZxid = zkDb.getDataTree().lastProcessedZxid;</span><br><span class="line">        <span class="keyword">long</span> epochOfZxid = ZxidUtils.getEpochFromZxid(lastProcessedZxid);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            currentEpoch = readLongFromFile(CURRENT_EPOCH_FILENAME);</span><br><span class="line">        } <span class="keyword">catch</span>(FileNotFoundException e) {</span><br><span class="line">            <span class="comment">// pick a reasonable epoch number</span></span><br><span class="line">            <span class="comment">// this should only happen once when moving to a</span></span><br><span class="line">            <span class="comment">// new code version</span></span><br><span class="line">            currentEpoch = epochOfZxid;</span><br><span class="line">            LOG.info(CURRENT_EPOCH_FILENAME</span><br><span class="line">                    + <span class="string">" not found! Creating with a reasonable default of {}. This should only happen when you are upgrading your installation"</span>,</span><br><span class="line">                    currentEpoch);</span><br><span class="line">            writeLongToFile(CURRENT_EPOCH_FILENAME, currentEpoch);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (epochOfZxid &gt; currentEpoch) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"The current epoch, "</span> + ZxidUtils.zxidToString(currentEpoch) + <span class="string">", is older than the last zxid, "</span> + lastProcessedZxid);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            acceptedEpoch = readLongFromFile(ACCEPTED_EPOCH_FILENAME);</span><br><span class="line">        } <span class="keyword">catch</span>(FileNotFoundException e) {</span><br><span class="line">            <span class="comment">// pick a reasonable epoch number</span></span><br><span class="line">            <span class="comment">// this should only happen once when moving to a</span></span><br><span class="line">            <span class="comment">// new code version</span></span><br><span class="line">            acceptedEpoch = epochOfZxid;</span><br><span class="line">            LOG.info(ACCEPTED_EPOCH_FILENAME</span><br><span class="line">                    + <span class="string">" not found! Creating with a reasonable default of {}. This should only happen when you are upgrading your installation"</span>,</span><br><span class="line">                    acceptedEpoch);</span><br><span class="line">            writeLongToFile(ACCEPTED_EPOCH_FILENAME, acceptedEpoch);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (acceptedEpoch &lt; currentEpoch) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"The accepted epoch, "</span> + ZxidUtils.zxidToString(acceptedEpoch) + <span class="string">" is less than the current epoch, "</span> + ZxidUtils.zxidToString(currentEpoch));</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span>(IOException ie) {</span><br><span class="line">        LOG.error(<span class="string">"Unable to load database on disk"</span>, ie);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to run quorum server "</span>, ie);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>ZKDatabase.loadDataBase()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">loadDataBase</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    <span class="keyword">long</span> zxid = snapLog.restore(dataTree, sessionsWithTimeouts, commitProposalPlaybackListener);</span><br><span class="line">    initialized = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">return</span> zxid;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>FileTxnSnapLog.restore()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">restore</span><span class="params">(DataTree dt, Map&lt;Long, Integer&gt; sessions, PlayBackListener listener)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    <span class="comment">// 恢复快照文件数据到内存（DataTree）</span></span><br><span class="line">    <span class="keyword">long</span> deserializeResult = snapLog.deserialize(dt, sessions);</span><br><span class="line">    FileTxnLog txnLog = <span class="keyword">new</span> FileTxnLog(dataDir);</span><br><span class="line"></span><br><span class="line">    RestoreFinalizer finalizer = () -&gt; {</span><br><span class="line">        <span class="comment">// 恢复编辑日志数据到内存（DataTree）</span></span><br><span class="line">        <span class="keyword">long</span> highestZxid = fastForwardFromEdits(dt, sessions, listener);</span><br><span class="line">        <span class="keyword">return</span> highestZxid;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (-<span class="number">1L</span> == deserializeResult) {</span><br><span class="line">        <span class="comment">/* this means that we couldn't find any snapshot, so we need to</span></span><br><span class="line"><span class="comment">            * initialize an empty database (reported in ZOOKEEPER-2325) */</span></span><br><span class="line">        <span class="keyword">if</span> (txnLog.getLastLoggedZxid() != -<span class="number">1</span>) {</span><br><span class="line">            <span class="comment">// ZOOKEEPER-3056: provides an escape hatch for users upgrading</span></span><br><span class="line">            <span class="comment">// from old versions of zookeeper (3.4.x, pre 3.5.3).</span></span><br><span class="line">            <span class="keyword">if</span> (!trustEmptySnapshot) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(EMPTY_SNAPSHOT_WARNING + <span class="string">"Something is broken!"</span>);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                LOG.warn(<span class="string">"{}This should only be allowed during upgrading."</span>, EMPTY_SNAPSHOT_WARNING);</span><br><span class="line">                <span class="keyword">return</span> finalizer.run();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">/* <span class="doctag">TODO:</span> (br33d) we should either put a ConcurrentHashMap on restore()</span></span><br><span class="line"><span class="comment">            *       or use Map on save() */</span></span><br><span class="line">        save(dt, (ConcurrentHashMap&lt;Long, Integer&gt;)sessions);</span><br><span class="line">        <span class="comment">/* return a zxid of zero, since we the database is empty */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> finalizer.run();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>FileSnap.deserialize()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">deserialize</span><span class="params">(DataTree dt, Map&lt;Long, Integer&gt; sessions)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    <span class="comment">// we run through 100 snapshots (not all of them)</span></span><br><span class="line">    <span class="comment">// if we cannot get it running within 100 snapshots</span></span><br><span class="line">    <span class="comment">// we should  give up</span></span><br><span class="line">    List&lt;File&gt; snapList = findNValidSnapshots(<span class="number">100</span>);</span><br><span class="line">    <span class="keyword">if</span> (snapList.size() == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1L</span>;</span><br><span class="line">    }</span><br><span class="line">    File snap = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> foundValid = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// 依次遍历每一个快照的数据</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, snapListSize = snapList.size(); i &lt; snapListSize; i++) {</span><br><span class="line">        snap = snapList.get(i);</span><br><span class="line">        LOG.info(<span class="string">"Reading snapshot "</span> + snap);</span><br><span class="line">        <span class="comment">// 反序列化环境准备</span></span><br><span class="line">        <span class="keyword">try</span> (InputStream snapIS = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(snap));</span><br><span class="line">                CheckedInputStream crcIn = <span class="keyword">new</span> CheckedInputStream(snapIS, <span class="keyword">new</span> Adler32())) {</span><br><span class="line">            InputArchive ia = BinaryInputArchive.getArchive(crcIn);</span><br><span class="line">            <span class="comment">// 反序列化，恢复快照文件数据到内存中的 DataTree</span></span><br><span class="line">            deserialize(dt, sessions, ia);</span><br><span class="line">            <span class="keyword">long</span> checkSum = crcIn.getChecksum().getValue();</span><br><span class="line">            <span class="keyword">long</span> val = ia.readLong(<span class="string">"val"</span>);</span><br><span class="line">            <span class="keyword">if</span> (val != checkSum) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"CRC corruption in snapshot :  "</span> + snap);</span><br><span class="line">            }</span><br><span class="line">            foundValid = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            LOG.warn(<span class="string">"problem reading snap file "</span> + snap, e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (!foundValid) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Not able to find valid snapshots in "</span> + snapDir);</span><br><span class="line">    }</span><br><span class="line">    dt.lastProcessedZxid = Util.getZxidFromName(snap.getName(), SNAPSHOT_FILE_PREFIX);</span><br><span class="line">    <span class="keyword">return</span> dt.lastProcessedZxid;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>FileSnap.deserialize()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deserialize</span><span class="params">(DataTree dt, Map&lt;Long, Integer&gt; sessions, InputArchive ia)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    FileHeader header = <span class="keyword">new</span> FileHeader();</span><br><span class="line">    header.deserialize(ia, <span class="string">"fileheader"</span>);</span><br><span class="line">    <span class="keyword">if</span> (header.getMagic() != SNAP_MAGIC) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"mismatching magic headers "</span></span><br><span class="line">                + header.getMagic() +</span><br><span class="line">                <span class="string">" !=  "</span> + FileSnap.SNAP_MAGIC);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 反序列化，恢复快照文件数据到内存中的 DataTree</span></span><br><span class="line">    SerializeUtils.deserializeSnapshot(dt,ia,sessions);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>SerializeUtils.deserializeSnapshot()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deserializeSnapshot</span><span class="params">(DataTree dt, InputArchive ia, Map&lt;Long, Integer&gt; sessions)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    <span class="keyword">int</span> count = ia.readInt(<span class="string">"count"</span>);</span><br><span class="line">    <span class="keyword">while</span> (count &gt; <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">long</span> id = ia.readLong(<span class="string">"id"</span>);</span><br><span class="line">        <span class="keyword">int</span> to = ia.readInt(<span class="string">"timeout"</span>);</span><br><span class="line">        sessions.put(id, to);</span><br><span class="line">        <span class="keyword">if</span> (LOG.isTraceEnabled()) {</span><br><span class="line">            ZooTrace.logTraceMessage(LOG, ZooTrace.SESSION_TRACE_MASK,</span><br><span class="line">                    <span class="string">"loadData --- session in archive: "</span> + id</span><br><span class="line">                    + <span class="string">" with timeout: "</span> + to);</span><br><span class="line">        }</span><br><span class="line">        count--;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 反序列化，恢复快照文件数据到内存中的 DataTree</span></span><br><span class="line">    dt.deserialize(ia, <span class="string">"tree"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>DataTree.deserialize()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deserialize</span><span class="params">(InputArchive ia, String tag)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    aclCache.deserialize(ia);</span><br><span class="line">    nodes.clear();</span><br><span class="line">    pTrie.clear();</span><br><span class="line">    String path = ia.readString(<span class="string">"path"</span>);</span><br><span class="line">    <span class="keyword">while</span> (!<span class="string">"/"</span>.equals(path)) {</span><br><span class="line">        <span class="comment">// 每次循环创建一个 DataNode 对象</span></span><br><span class="line">        DataNode node = <span class="keyword">new</span> DataNode();</span><br><span class="line">        ia.readRecord(node, <span class="string">"node"</span>);</span><br><span class="line">        <span class="comment">// 将 DataNode 恢复到 DataTree</span></span><br><span class="line">        nodes.put(path, node);</span><br><span class="line">        <span class="keyword">synchronized</span> (node) {</span><br><span class="line">            aclCache.addUsage(node.acl);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">int</span> lastSlash = path.lastIndexOf(<span class="string">'/'</span>);</span><br><span class="line">        <span class="keyword">if</span> (lastSlash == -<span class="number">1</span>) {</span><br><span class="line">            root = node;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 处理父节点</span></span><br><span class="line">            String parentPath = path.substring(<span class="number">0</span>, lastSlash);</span><br><span class="line">            DataNode parent = nodes.get(parentPath);</span><br><span class="line">            <span class="keyword">if</span> (parent == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Invalid Datatree, unable to find "</span> +</span><br><span class="line">                        <span class="string">"parent "</span> + parentPath + <span class="string">" of path "</span> + path);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理子节点</span></span><br><span class="line">            parent.addChild(path.substring(lastSlash + <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理临时节点和持久节点</span></span><br><span class="line">            <span class="keyword">long</span> eowner = node.stat.getEphemeralOwner();</span><br><span class="line">            EphemeralType ephemeralType = EphemeralType.get(eowner);</span><br><span class="line">            <span class="keyword">if</span> (ephemeralType == EphemeralType.CONTAINER) {</span><br><span class="line">                containers.add(path);</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (ephemeralType == EphemeralType.TTL) {</span><br><span class="line">                ttls.add(path);</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (eowner != <span class="number">0</span>) {</span><br><span class="line">                HashSet&lt;String&gt; list = ephemerals.get(eowner);</span><br><span class="line">                <span class="keyword">if</span> (list == <span class="keyword">null</span>) {</span><br><span class="line">                    list = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">                    ephemerals.put(eowner, list);</span><br><span class="line">                }</span><br><span class="line">                list.add(path);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        path = ia.readString(<span class="string">"path"</span>);</span><br><span class="line">    }</span><br><span class="line">    nodes.put(<span class="string">"/"</span>, root);</span><br><span class="line">    <span class="comment">// we are done with deserializing the</span></span><br><span class="line">    <span class="comment">// the datatree</span></span><br><span class="line">    <span class="comment">// update the quotas - create path trie</span></span><br><span class="line">    <span class="comment">// and also update the stat nodes</span></span><br><span class="line">    setupQuota();</span><br><span class="line"></span><br><span class="line">    aclCache.purgeUnused();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="冷启动数据恢复编辑日志"><a href="#冷启动数据恢复编辑日志" class="headerlink" title="冷启动数据恢复编辑日志"></a>冷启动数据恢复编辑日志</h3><ul><li><code>QuorumPeer.start()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (!getView().containsKey(myid)) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"My id "</span> + myid + <span class="string">" not in the peer list"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 冷启动恢复数据</span></span><br><span class="line">    loadDataBase();</span><br><span class="line">    startServerCnxnFactory();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 启动通信工厂实例对象</span></span><br><span class="line">        adminServer.start();</span><br><span class="line">    } <span class="keyword">catch</span> (AdminServerException e) {</span><br><span class="line">        LOG.warn(<span class="string">"Problem starting AdminServer"</span>, e);</span><br><span class="line">        System.out.println(e);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 准备选举环境</span></span><br><span class="line">    startLeaderElection();</span><br><span class="line">    <span class="comment">// 执行选举</span></span><br><span class="line">    <span class="keyword">super</span>.start();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumPeer.loadDataBase()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadDataBase</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// ZK 的操作分两种：事务操作和非事务操作</span></span><br><span class="line">        <span class="comment">// 事务操作：zk.cteate()，都会被分配一个全局唯一的 zxid。这里 zxid 的组成：64 位（前 32 位：epoch 每个 Leader 任期的代号；后 32 位：txid 为事务 ID）</span></span><br><span class="line">        <span class="comment">// 非事务操作：zk.getData()</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加载磁盘数据到内存，恢复 DataTree，数据恢复过程：</span></span><br><span class="line">        <span class="comment">// (1) 从快照文件中恢复大部分数据，并得到一个 lastProcessZXid</span></span><br><span class="line">        <span class="comment">// (2) 再从编辑日志中执行 replay，执行到最后一条日志并更新 lastProcessZXid</span></span><br><span class="line">        <span class="comment">// (3) 最终得到 DataTree 和 lastProcessZXid，表示数据恢复完成</span></span><br><span class="line">        zkDb.loadDataBase();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// load the epochs</span></span><br><span class="line">        <span class="keyword">long</span> lastProcessedZxid = zkDb.getDataTree().lastProcessedZxid;</span><br><span class="line">        <span class="keyword">long</span> epochOfZxid = ZxidUtils.getEpochFromZxid(lastProcessedZxid);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            currentEpoch = readLongFromFile(CURRENT_EPOCH_FILENAME);</span><br><span class="line">        } <span class="keyword">catch</span>(FileNotFoundException e) {</span><br><span class="line">            <span class="comment">// pick a reasonable epoch number</span></span><br><span class="line">            <span class="comment">// this should only happen once when moving to a</span></span><br><span class="line">            <span class="comment">// new code version</span></span><br><span class="line">            currentEpoch = epochOfZxid;</span><br><span class="line">            LOG.info(CURRENT_EPOCH_FILENAME</span><br><span class="line">                    + <span class="string">" not found! Creating with a reasonable default of {}. This should only happen when you are upgrading your installation"</span>,</span><br><span class="line">                    currentEpoch);</span><br><span class="line">            writeLongToFile(CURRENT_EPOCH_FILENAME, currentEpoch);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (epochOfZxid &gt; currentEpoch) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"The current epoch, "</span> + ZxidUtils.zxidToString(currentEpoch) + <span class="string">", is older than the last zxid, "</span> + lastProcessedZxid);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            acceptedEpoch = readLongFromFile(ACCEPTED_EPOCH_FILENAME);</span><br><span class="line">        } <span class="keyword">catch</span>(FileNotFoundException e) {</span><br><span class="line">            <span class="comment">// pick a reasonable epoch number</span></span><br><span class="line">            <span class="comment">// this should only happen once when moving to a</span></span><br><span class="line">            <span class="comment">// new code version</span></span><br><span class="line">            acceptedEpoch = epochOfZxid;</span><br><span class="line">            LOG.info(ACCEPTED_EPOCH_FILENAME</span><br><span class="line">                    + <span class="string">" not found! Creating with a reasonable default of {}. This should only happen when you are upgrading your installation"</span>,</span><br><span class="line">                    acceptedEpoch);</span><br><span class="line">            writeLongToFile(ACCEPTED_EPOCH_FILENAME, acceptedEpoch);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (acceptedEpoch &lt; currentEpoch) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"The accepted epoch, "</span> + ZxidUtils.zxidToString(acceptedEpoch) + <span class="string">" is less than the current epoch, "</span> + ZxidUtils.zxidToString(currentEpoch));</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span>(IOException ie) {</span><br><span class="line">        LOG.error(<span class="string">"Unable to load database on disk"</span>, ie);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to run quorum server "</span>, ie);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>ZKDatabase.loadDataBase()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">loadDataBase</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    <span class="keyword">long</span> zxid = snapLog.restore(dataTree, sessionsWithTimeouts, commitProposalPlaybackListener);</span><br><span class="line">    initialized = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">return</span> zxid;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>FileTxnSnapLog.restore()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">restore</span><span class="params">(DataTree dt, Map&lt;Long, Integer&gt; sessions, PlayBackListener listener)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    <span class="comment">// 恢复快照文件数据到内存（DataTree）</span></span><br><span class="line">    <span class="keyword">long</span> deserializeResult = snapLog.deserialize(dt, sessions);</span><br><span class="line">    FileTxnLog txnLog = <span class="keyword">new</span> FileTxnLog(dataDir);</span><br><span class="line"></span><br><span class="line">    RestoreFinalizer finalizer = () -&gt; {</span><br><span class="line">        <span class="comment">// 恢复编辑日志数据到内存（DataTree）</span></span><br><span class="line">        <span class="keyword">long</span> highestZxid = fastForwardFromEdits(dt, sessions, listener);</span><br><span class="line">        <span class="keyword">return</span> highestZxid;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (-<span class="number">1L</span> == deserializeResult) {</span><br><span class="line">        <span class="comment">/* this means that we couldn't find any snapshot, so we need to</span></span><br><span class="line"><span class="comment">            * initialize an empty database (reported in ZOOKEEPER-2325) */</span></span><br><span class="line">        <span class="keyword">if</span> (txnLog.getLastLoggedZxid() != -<span class="number">1</span>) {</span><br><span class="line">            <span class="comment">// ZOOKEEPER-3056: provides an escape hatch for users upgrading</span></span><br><span class="line">            <span class="comment">// from old versions of zookeeper (3.4.x, pre 3.5.3).</span></span><br><span class="line">            <span class="keyword">if</span> (!trustEmptySnapshot) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(EMPTY_SNAPSHOT_WARNING + <span class="string">"Something is broken!"</span>);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                LOG.warn(<span class="string">"{}This should only be allowed during upgrading."</span>, EMPTY_SNAPSHOT_WARNING);</span><br><span class="line">                <span class="keyword">return</span> finalizer.run();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">/* <span class="doctag">TODO:</span> (br33d) we should either put a ConcurrentHashMap on restore()</span></span><br><span class="line"><span class="comment">            *       or use Map on save() */</span></span><br><span class="line">        save(dt, (ConcurrentHashMap&lt;Long, Integer&gt;)sessions);</span><br><span class="line">        <span class="comment">/* return a zxid of zero, since we the database is empty */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> finalizer.run();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>FileTxnSnapLog.fastForwardFromEdits()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">fastForwardFromEdits</span><span class="params">(DataTree dt, Map&lt;Long, Integer&gt; sessions, PlayBackListener listener)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    <span class="comment">// 在此之前，已经从快照文件中恢复了大部分数据，接下来只需要从快照的 zxid + 1 位置开始恢复</span></span><br><span class="line">    TxnIterator itr = txnLog.read(dt.lastProcessedZxid+<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 快照中最大的 zxid，在执行编辑日志时，这个值会不断更新，直到所有恢复操作执行完成</span></span><br><span class="line">    <span class="keyword">long</span> highestZxid = dt.lastProcessedZxid;</span><br><span class="line">    TxnHeader hdr;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 从 lastProcessedZxid 事务编号器开始，不断地从编辑日志中恢复剩下的还没有恢复的数据</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) {</span><br><span class="line">            <span class="comment">// iterator points to</span></span><br><span class="line">            <span class="comment">// the first valid txn when initialized</span></span><br><span class="line">            <span class="comment">// 获取事务头信息（含有 zxid）</span></span><br><span class="line">            hdr = itr.getHeader();</span><br><span class="line">            <span class="keyword">if</span> (hdr == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="comment">//empty logs</span></span><br><span class="line">                <span class="keyword">return</span> dt.lastProcessedZxid;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (hdr.getZxid() &lt; highestZxid &amp;&amp; highestZxid != <span class="number">0</span>) {</span><br><span class="line">                LOG.error(<span class="string">"{}(highestZxid) &gt; {}(next log) for type {}"</span>,</span><br><span class="line">                        highestZxid, hdr.getZxid(), hdr.getType());</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                highestZxid = hdr.getZxid();</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">// 根据编辑日志恢复数据到内存（DataTree）</span></span><br><span class="line">                processTransaction(hdr,dt,sessions, itr.getTxn());</span><br><span class="line">            } <span class="keyword">catch</span>(KeeperException.NoNodeException e) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Failed to process transaction type: "</span> +</span><br><span class="line">                        hdr.getType() + <span class="string">" error: "</span> + e.getMessage(), e);</span><br><span class="line">            }</span><br><span class="line">            listener.onTxnLoaded(hdr, itr.getTxn());</span><br><span class="line">            <span class="keyword">if</span> (!itr.next())</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        <span class="keyword">if</span> (itr != <span class="keyword">null</span>) {</span><br><span class="line">            itr.close();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> highestZxid;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>FileTxnSnapLog.processTransaction()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processTransaction</span><span class="params">(TxnHeader hdr, DataTree dt, Map&lt;Long, Integer&gt; sessions, Record txn)</span> <span class="keyword">throws</span> KeeperException.NoNodeException </span>{</span><br><span class="line">    ProcessTxnResult rc;</span><br><span class="line">    <span class="keyword">switch</span> (hdr.getType()) {</span><br><span class="line">    <span class="keyword">case</span> OpCode.createSession:</span><br><span class="line">        sessions.put(hdr.getClientId(),</span><br><span class="line">                ((CreateSessionTxn) txn).getTimeOut());</span><br><span class="line">        <span class="keyword">if</span> (LOG.isTraceEnabled()) {</span><br><span class="line">            ZooTrace.logTraceMessage(LOG,ZooTrace.SESSION_TRACE_MASK,</span><br><span class="line">                    <span class="string">"playLog --- create session in log: 0x"</span></span><br><span class="line">                            + Long.toHexString(hdr.getClientId())</span><br><span class="line">                            + <span class="string">" with timeout: "</span></span><br><span class="line">                            + ((CreateSessionTxn) txn).getTimeOut());</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// give dataTree a chance to sync its lastProcessedZxid</span></span><br><span class="line">        rc = dt.processTxn(hdr, txn);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> OpCode.closeSession:</span><br><span class="line">        sessions.remove(hdr.getClientId());</span><br><span class="line">        <span class="keyword">if</span> (LOG.isTraceEnabled()) {</span><br><span class="line">            ZooTrace.logTraceMessage(LOG,ZooTrace.SESSION_TRACE_MASK,</span><br><span class="line">                    <span class="string">"playLog --- close session in log: 0x"</span></span><br><span class="line">                            + Long.toHexString(hdr.getClientId()));</span><br><span class="line">        }</span><br><span class="line">        rc = dt.processTxn(hdr, txn);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">// 创建节点、删除节点和其他的各种事务操作</span></span><br><span class="line">        rc = dt.processTxn(hdr, txn);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Snapshots are lazily created. So when a snapshot is in progress,</span></span><br><span class="line"><span class="comment">     * there is a chance for later transactions to make into the</span></span><br><span class="line"><span class="comment">     * snapshot. Then when the snapshot is restored, NONODE/NODEEXISTS</span></span><br><span class="line"><span class="comment">     * errors could occur. It should be safe to ignore these.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (rc.err != Code.OK.intValue()) {</span><br><span class="line">        LOG.debug(</span><br><span class="line">                <span class="string">"Ignoring processTxn failure hdr: {}, error: {}, path: {}"</span>,</span><br><span class="line">                hdr.getType(), rc.err, rc.path);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>FileTxnSnapLog.processTxn()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ProcessTxnResult <span class="title">processTxn</span><span class="params">(TxnHeader header, Record txn, <span class="keyword">boolean</span> isSubTxn)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    ProcessTxnResult rc = <span class="keyword">new</span> ProcessTxnResult();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        rc.clientId = header.getClientId();</span><br><span class="line">        rc.cxid = header.getCxid();</span><br><span class="line">        rc.zxid = header.getZxid();</span><br><span class="line">        rc.type = header.getType();</span><br><span class="line">        rc.err = <span class="number">0</span>;</span><br><span class="line">        rc.multiResult = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">switch</span> (header.getType()) {</span><br><span class="line">            <span class="keyword">case</span> OpCode.create:</span><br><span class="line">                CreateTxn createTxn = (CreateTxn) txn;</span><br><span class="line">                rc.path = createTxn.getPath();</span><br><span class="line">                createNode(</span><br><span class="line">                        createTxn.getPath(),</span><br><span class="line">                        createTxn.getData(),</span><br><span class="line">                        createTxn.getAcl(),</span><br><span class="line">                        createTxn.getEphemeral() ? header.getClientId() : <span class="number">0</span>,</span><br><span class="line">                        createTxn.getParentCVersion(),</span><br><span class="line">                        header.getZxid(), header.getTime(), <span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OpCode.create2:</span><br><span class="line">                CreateTxn create2Txn = (CreateTxn) txn;</span><br><span class="line">                rc.path = create2Txn.getPath();</span><br><span class="line">                Stat stat = <span class="keyword">new</span> Stat();</span><br><span class="line">                createNode(</span><br><span class="line">                        create2Txn.getPath(),</span><br><span class="line">                        create2Txn.getData(),</span><br><span class="line">                        create2Txn.getAcl(),</span><br><span class="line">                        create2Txn.getEphemeral() ? header.getClientId() : <span class="number">0</span>,</span><br><span class="line">                        create2Txn.getParentCVersion(),</span><br><span class="line">                        header.getZxid(), header.getTime(), stat);</span><br><span class="line">                rc.stat = stat;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OpCode.createTTL:</span><br><span class="line">                CreateTTLTxn createTtlTxn = (CreateTTLTxn) txn;</span><br><span class="line">                rc.path = createTtlTxn.getPath();</span><br><span class="line">                stat = <span class="keyword">new</span> Stat();</span><br><span class="line">                createNode(</span><br><span class="line">                        createTtlTxn.getPath(),</span><br><span class="line">                        createTtlTxn.getData(),</span><br><span class="line">                        createTtlTxn.getAcl(),</span><br><span class="line">                        EphemeralType.TTL.toEphemeralOwner(createTtlTxn.getTtl()),</span><br><span class="line">                        createTtlTxn.getParentCVersion(),</span><br><span class="line">                        header.getZxid(), header.getTime(), stat);</span><br><span class="line">                rc.stat = stat;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OpCode.createContainer:</span><br><span class="line">                CreateContainerTxn createContainerTxn = (CreateContainerTxn) txn;</span><br><span class="line">                rc.path = createContainerTxn.getPath();</span><br><span class="line">                stat = <span class="keyword">new</span> Stat();</span><br><span class="line">                createNode(</span><br><span class="line">                        createContainerTxn.getPath(),</span><br><span class="line">                        createContainerTxn.getData(),</span><br><span class="line">                        createContainerTxn.getAcl(),</span><br><span class="line">                        EphemeralType.CONTAINER_EPHEMERAL_OWNER,</span><br><span class="line">                        createContainerTxn.getParentCVersion(),</span><br><span class="line">                        header.getZxid(), header.getTime(), stat);</span><br><span class="line">                rc.stat = stat;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OpCode.delete:</span><br><span class="line">            <span class="keyword">case</span> OpCode.deleteContainer:</span><br><span class="line">                DeleteTxn deleteTxn = (DeleteTxn) txn;</span><br><span class="line">                rc.path = deleteTxn.getPath();</span><br><span class="line">                deleteNode(deleteTxn.getPath(), header.getZxid());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OpCode.reconfig:</span><br><span class="line">            <span class="keyword">case</span> OpCode.setData:</span><br><span class="line">                SetDataTxn setDataTxn = (SetDataTxn) txn;</span><br><span class="line">                rc.path = setDataTxn.getPath();</span><br><span class="line">                rc.stat = setData(setDataTxn.getPath(), setDataTxn</span><br><span class="line">                        .getData(), setDataTxn.getVersion(), header</span><br><span class="line">                        .getZxid(), header.getTime());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OpCode.setACL:</span><br><span class="line">                SetACLTxn setACLTxn = (SetACLTxn) txn;</span><br><span class="line">                rc.path = setACLTxn.getPath();</span><br><span class="line">                rc.stat = setACL(setACLTxn.getPath(), setACLTxn.getAcl(),</span><br><span class="line">                        setACLTxn.getVersion());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OpCode.closeSession:</span><br><span class="line">                killSession(header.getClientId(), header.getZxid());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OpCode.error:</span><br><span class="line">                ErrorTxn errTxn = (ErrorTxn) txn;</span><br><span class="line">                rc.err = errTxn.getErr();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OpCode.check:</span><br><span class="line">                CheckVersionTxn checkTxn = (CheckVersionTxn) txn;</span><br><span class="line">                rc.path = checkTxn.getPath();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OpCode.multi:</span><br><span class="line">                MultiTxn multiTxn = (MultiTxn) txn ;</span><br><span class="line">                List&lt;Txn&gt; txns = multiTxn.getTxns();</span><br><span class="line">                rc.multiResult = <span class="keyword">new</span> ArrayList&lt;ProcessTxnResult&gt;();</span><br><span class="line">                <span class="keyword">boolean</span> failed = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">for</span> (Txn subtxn : txns) {</span><br><span class="line">                    <span class="keyword">if</span> (subtxn.getType() == OpCode.error) {</span><br><span class="line">                        failed = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                ......</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (KeeperException e) {</span><br><span class="line">        <span class="keyword">if</span> (LOG.isDebugEnabled()) {</span><br><span class="line">            LOG.debug(<span class="string">"Failed: "</span> + header + <span class="string">":"</span> + txn, e);</span><br><span class="line">        }</span><br><span class="line">        rc.err = e.code().intValue();</span><br><span class="line">    } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">        <span class="keyword">if</span> (LOG.isDebugEnabled()) {</span><br><span class="line">            LOG.debug(<span class="string">"Failed: "</span> + header + <span class="string">":"</span> + txn, e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="ZK-集群选举源码分析"><a href="#ZK-集群选举源码分析" class="headerlink" title="ZK 集群选举源码分析"></a>ZK 集群选举源码分析</h2><h3 id="集群选举机制"><a href="#集群选举机制" class="headerlink" title="集群选举机制"></a>集群选举机制</h3><p>ZooKeeper 集群的选举机制是高频面试题，其中分为第一次启动和非第一次启动两种情况。</p><h4 id="集群第一次启动"><a href="#集群第一次启动" class="headerlink" title="集群第一次启动"></a>集群第一次启动</h4><p><img data-src="../../../asset/2024/12/zookeeper-15.png"></p><ul><li><p>(1) 服务器 1 启动，发起一次选举。服务器 1 投自己一票，此时服务器 1 的票数是一票，不够半数以上（一共有 5 票），选举无法完成，服务器 1 的状态保持为 LOOKING。</p></li><li><p>(2) 服务器 2 启动，再发起一次选举。服务器 1 和 2 分别投自己一票并交换选票信息，<strong>此时服务器 1 发现服务器 2 的 <code>myid</code> 比自己目前投票推举的（服务器 1）大，更改选票为推举服务器 2</strong>。此时服务器 1 的票数是 0 票，服务器 2 的票数是 2 票，两者都没有半数以上的票数，选举无法完成，服务器 1 和 服务器 2 的状态保持 LOOKING。</p></li><li><p>(3) 服务器 3 启动，发起一次选举。此时服务器 1 和 2 都会更改选票为服务器 3。此次投票结果：服务器 1 有 0 票，服务器 2 有 0 票，服务器 3 有 3 票。此时服务器 3 的票数已经超过半数，服务器 3 当选 Leader。服务器 3 将状态更改为 LEADING，服务器 1 和 服务器 2 将状态更改为 FOLLOWING。</p></li><li><p>(4) 服务器 4 启动，发起一次选举。此时服务器 1、2、3 已经不是 LOOKING 状态，不会再更改选票信息。交换选票信息后的结果：服务器 3 有 3 票，服务器 4 有 1 票。此时服务器 4 少数服从多数，更改选票信息为服务器 3，并将自己的状态更改为 FOLLOWING。</p></li><li><p>(5) 服务器 5 启动，跟服务器 4 一样更改选票信息为服务器 3，并将自己的状态更改为 FOLLOWING。</p></li></ul><div class="admonition warning"><p class="admonition-title">特别注意</p><p><strong>一旦 ZooKeeper 集群中已经存在 Leader 节点，那么后面加入集群的节点都只会成为 Follower 节点。</strong></p></div><h4 id="集群非第一次启动"><a href="#集群非第一次启动" class="headerlink" title="集群非第一次启动"></a>集群非第一次启动</h4><p><img data-src="../../../asset/2024/12/zookeeper-16.png"></p><ul><li><p>(1) 当 ZooKeeper 集群中的任意一台服务器出现以下两种情况之一时，就会开始进入 Leader 选举：</p><ul><li>服务器初始化启动。</li><li>服务器运行期间无法和 Leader 保持连接。</li></ul></li><li><p>(2) 当一台服务器进入 Leader 选举流程时，当前集群也可能会处于以下两种状态之一：</p><ul><li><p>集群中本来就已经存在一个 Leader</p><ul><li>对于集群已经存在 Leader 的情况，当服务器试图去选举 Leader 时，会被告知当前服务器的 Leader 信息；对于该服务器来说，仅仅需要和 Leader 服务器建立连接，并进行状态同步即可。</li></ul></li><li><p>集群中确实不存在 Leader</p><ul><li>对于集群不存在 Leader 的情况，整个集群会进入选举流程。</li><li>假设 ZooKeeper 集群由 5 台服务器组成，SID 分别为 1、2、3、4、5，ZXID 分别为 8、8、8、7、7， 并且此时 SID 为 3 的服务器是 Leader。在某一时刻，SID 为 3 和 5 的服务器出现故障，由于 Leader 挂掉了，因此开始进行 Leader 选举。SID 为 1、2、4 的服务器的最终投票情况如下：<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(EPOCH, ZXID, SID ) (EPOCH, ZXID, SID ) (EPOCH, ZXID, SID )</span><br><span class="line">(1, 8, 1)           (1, 8, 2)           (1, 7, 4)</span><br></pre></td></tr></tbody></table></figure></li><li><strong>选举 Leader 的规则</strong>：①EPOCH 大的直接胜出&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;②EPOCH 相同，ZXID（事务 ID）大的胜出&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;③ZXID（事务 ID） 相同，SID（服务器 ID，即 myid） 大的胜出</li><li>选举 Leader 的结果：SID 为 2 的服务器会被选举 Leader，SID 为 1 和 4 的服务器作为 Follower。</li></ul></li></ul></li></ul><h4 id="集群选举机制总结"><a href="#集群选举机制总结" class="headerlink" title="集群选举机制总结"></a>集群选举机制总结</h4><p>ZooKeeper 使用半数投票机制来实现选举，超过半数的投票通过，即通过。</p><ul><li><p>集群第一次启动时的选举规则</p><ul><li>投票过半数时，服务器 ID 大的胜出</li></ul></li><li><p>集群非第一次启动时的选举规则</p><ul><li>(1) EPOCH 大的直接胜出</li><li> (2) EPOCH 相同，事务 ID（ZXID）大的胜出</li><li> (3) 事务 ID（ZXID）相同，服务器 ID（SID）大的胜出</li></ul></li></ul><h3 id="集群选举准备"><a href="#集群选举准备" class="headerlink" title="集群选举准备"></a>集群选举准备</h3><p><img data-src="../../../asset/2025/01/zookeeper-source-7.png"></p><ul><li><code>QuorumPeerMain.initializeAndRun()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initializeAndRun</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ConfigException, IOException, AdminServerException</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// 管理 ZK 的配置信息</span></span><br><span class="line">    QuorumPeerConfig config = <span class="keyword">new</span> QuorumPeerConfig();</span><br><span class="line">    <span class="keyword">if</span> (args.length == <span class="number">1</span>) {</span><br><span class="line">        <span class="comment">// 解析参数，包括 zoo.cfg 和 myid 文件</span></span><br><span class="line">        config.parse(args[<span class="number">0</span>]);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动定时任务，对过期的快照执行删除（该功能默认关闭）</span></span><br><span class="line">    DatadirCleanupManager purgeMgr = <span class="keyword">new</span> DatadirCleanupManager(config</span><br><span class="line">            .getDataDir(), config.getDataLogDir(), config</span><br><span class="line">            .getSnapRetainCount(), config.getPurgeInterval());</span><br><span class="line">    purgeMgr.start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (args.length == <span class="number">1</span> &amp;&amp; config.isDistributed()) {</span><br><span class="line">        <span class="comment">// 集群模式启动</span></span><br><span class="line">        runFromConfig(config);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        LOG.warn(<span class="string">"Either no config or no quorum defined in config, running "</span></span><br><span class="line">                + <span class="string">" in standalone mode"</span>);</span><br><span class="line">        <span class="comment">// 单机模式启动</span></span><br><span class="line">        ZooKeeperServerMain.main(args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumPeerMain.runFromConfig()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runFromConfig</span><span class="params">(QuorumPeerConfig config)</span> <span class="keyword">throws</span> IOException, AdminServerException</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        ManagedUtil.registerLog4jMBeans();</span><br><span class="line">    } <span class="keyword">catch</span> (JMException e) {</span><br><span class="line">        LOG.warn(<span class="string">"Unable to register log4j JMX control"</span>, e);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    LOG.info(<span class="string">"Starting quorum peer"</span>);</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        ServerCnxnFactory cnxnFactory = <span class="keyword">null</span>;</span><br><span class="line">        ServerCnxnFactory secureCnxnFactory = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通信组件初始化，默认是使用 NIO 通信（可以支持 Netty）</span></span><br><span class="line">        <span class="keyword">if</span> (config.getClientPortAddress() != <span class="keyword">null</span>) {</span><br><span class="line">            cnxnFactory = ServerCnxnFactory.createFactory();</span><br><span class="line">            cnxnFactory.configure(config.getClientPortAddress(),</span><br><span class="line">                    config.getMaxClientCnxns(),</span><br><span class="line">                    <span class="keyword">false</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (config.getSecureClientPortAddress() != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">// 初始化 NIO 服务端的 Socket，绑定 2181 端口</span></span><br><span class="line">            secureCnxnFactory = ServerCnxnFactory.createFactory();</span><br><span class="line">            secureCnxnFactory.configure(config.getSecureClientPortAddress(),</span><br><span class="line">                    config.getMaxClientCnxns(),</span><br><span class="line">                    <span class="keyword">true</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将解析到的参数赋值给该 ZK 集群节点</span></span><br><span class="line">        quorumPeer = getQuorumPeer();</span><br><span class="line">        quorumPeer.setTxnFactory(<span class="keyword">new</span> FileTxnSnapLog(</span><br><span class="line">                    config.getDataLogDir(),</span><br><span class="line">                    config.getDataDir()));</span><br><span class="line">        quorumPeer.enableLocalSessions(config.areLocalSessionsEnabled());</span><br><span class="line">        quorumPeer.enableLocalSessionsUpgrading(</span><br><span class="line">            config.isLocalSessionsUpgradingEnabled());</span><br><span class="line">        <span class="comment">//quorumPeer.setQuorumPeers(config.getAllMembers());</span></span><br><span class="line">        quorumPeer.setElectionType(config.getElectionAlg());</span><br><span class="line">        quorumPeer.setMyid(config.getServerId());</span><br><span class="line">		</span><br><span class="line">        ......</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 启动 ZK 集群节点</span></span><br><span class="line">        quorumPeer.start();</span><br><span class="line">        quorumPeer.join();</span><br><span class="line">    } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">        <span class="comment">// warn, but generally this is ok</span></span><br><span class="line">        LOG.warn(<span class="string">"Quorum Peer interrupted"</span>, e);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumPeer.start()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (!getView().containsKey(myid)) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"My id "</span> + myid + <span class="string">" not in the peer list"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 冷启动恢复数据</span></span><br><span class="line">    loadDataBase();</span><br><span class="line">    startServerCnxnFactory();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 启动通信工厂实例对象</span></span><br><span class="line">        adminServer.start();</span><br><span class="line">    } <span class="keyword">catch</span> (AdminServerException e) {</span><br><span class="line">        LOG.warn(<span class="string">"Problem starting AdminServer"</span>, e);</span><br><span class="line">        System.out.println(e);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 选举准备</span></span><br><span class="line">    startLeaderElection();</span><br><span class="line">    <span class="comment">// 执行选举</span></span><br><span class="line">    <span class="keyword">super</span>.start();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumPeer.startLeaderElection()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startLeaderElection</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">if</span> (getPeerState() == ServerState.LOOKING) {</span><br><span class="line">            <span class="comment">// 创建选票</span></span><br><span class="line">            <span class="comment">// (1) 选票组件：epoch（Leader 的任期代号）、zxid（某个 Leader 当选期间执行的事务编号）、myid（ServerID）</span></span><br><span class="line">            <span class="comment">// (2) 开始投票时，每个节点都是先投自己一票</span></span><br><span class="line">            currentVote = <span class="keyword">new</span> Vote(myid, getLastLoggedZxid(), getCurrentEpoch());</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span>(IOException e) {</span><br><span class="line">        RuntimeException re = <span class="keyword">new</span> RuntimeException(e.getMessage());</span><br><span class="line">        re.setStackTrace(e.getStackTrace());</span><br><span class="line">        <span class="keyword">throw</span> re;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if (!getView().containsKey(myid)) {</span></span><br><span class="line">    <span class="comment">//      throw new RuntimeException("My id " + myid + " not in the peer list");</span></span><br><span class="line">    <span class="comment">//}</span></span><br><span class="line">    <span class="keyword">if</span> (electionType == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            udpSocket = <span class="keyword">new</span> DatagramSocket(getQuorumAddress().getPort());</span><br><span class="line">            responder = <span class="keyword">new</span> ResponderThread();</span><br><span class="line">            responder.start();</span><br><span class="line">        } <span class="keyword">catch</span> (SocketException e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 创建选举算法实例</span></span><br><span class="line">    <span class="keyword">this</span>.electionAlg = createElectionAlgorithm(electionType);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumPeer.createElectionAlgorithm()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Election <span class="title">createElectionAlgorithm</span><span class="params">(<span class="keyword">int</span> electionAlgorithm)</span> </span>{</span><br><span class="line">    Election le=<span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//<span class="doctag">TODO:</span> use a factory rather than a switch</span></span><br><span class="line">    <span class="keyword">switch</span> (electionAlgorithm) {</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        le = <span class="keyword">new</span> LeaderElection(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        le = <span class="keyword">new</span> AuthFastLeaderElection(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        le = <span class="keyword">new</span> AuthFastLeaderElection(<span class="keyword">this</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="comment">// (1) 创建 QuorumCnxnManager，负责选举过程中的所有网络通信</span></span><br><span class="line">        QuorumCnxManager qcm = createCnxnManager();</span><br><span class="line">        QuorumCnxManager oldQcm = qcmRef.getAndSet(qcm);</span><br><span class="line">        <span class="keyword">if</span> (oldQcm != <span class="keyword">null</span>) {</span><br><span class="line">            LOG.warn(<span class="string">"Clobbering already-set QuorumCnxManager (restarting leader election?)"</span>);</span><br><span class="line">            oldQcm.halt();</span><br><span class="line">        }</span><br><span class="line">        QuorumCnxManager.Listener listener = qcm.listener;</span><br><span class="line">        <span class="keyword">if</span>(listener != <span class="keyword">null</span>){</span><br><span class="line">            <span class="comment">// (2) 启动监听线程</span></span><br><span class="line">            listener.start();</span><br><span class="line">            <span class="comment">// (3) 准备开始选举</span></span><br><span class="line">            FastLeaderElection fle = <span class="keyword">new</span> FastLeaderElection(<span class="keyword">this</span>, qcm);</span><br><span class="line">            fle.start();</span><br><span class="line">            le = fle;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            LOG.error(<span class="string">"Null listener when initializing cnx manager"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">assert</span> <span class="keyword">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> le;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="网络通信组件初始化"><a href="#网络通信组件初始化" class="headerlink" title="网络通信组件初始化"></a>网络通信组件初始化</h4><ul><li><code>QuorumPeer.createCnxnManager()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> QuorumCnxManager <span class="title">createCnxnManager</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> QuorumCnxManager(<span class="keyword">this</span>,</span><br><span class="line">            <span class="keyword">this</span>.getId(),</span><br><span class="line">            <span class="keyword">this</span>.getView(),</span><br><span class="line">            <span class="keyword">this</span>.authServer,</span><br><span class="line">            <span class="keyword">this</span>.authLearner,</span><br><span class="line">            <span class="keyword">this</span>.tickTime * <span class="keyword">this</span>.syncLimit,</span><br><span class="line">            <span class="keyword">this</span>.getQuorumListenOnAllIPs(),</span><br><span class="line">            <span class="keyword">this</span>.quorumCnxnThreadsSize,</span><br><span class="line">            <span class="keyword">this</span>.isQuorumSaslAuthEnabled());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumCnxManager.QuorumCnxManager()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">QuorumCnxManager</span><span class="params">(QuorumPeer self,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">final</span> <span class="keyword">long</span> mySid,</span></span></span><br><span class="line"><span class="params"><span class="function">                        Map&lt;Long,QuorumPeer.QuorumServer&gt; view,</span></span></span><br><span class="line"><span class="params"><span class="function">                        QuorumAuthServer authServer,</span></span></span><br><span class="line"><span class="params"><span class="function">                        QuorumAuthLearner authLearner,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">int</span> socketTimeout,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">boolean</span> listenOnAllIPs,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">int</span> quorumCnxnThreadsSize,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">boolean</span> quorumSaslAuthEnabled)</span> </span>{</span><br><span class="line">    <span class="comment">// 创建各种队列</span></span><br><span class="line">    <span class="keyword">this</span>.recvQueue = <span class="keyword">new</span> ArrayBlockingQueue&lt;Message&gt;(RECV_CAPACITY);</span><br><span class="line">    <span class="keyword">this</span>.queueSendMap = <span class="keyword">new</span> ConcurrentHashMap&lt;Long, ArrayBlockingQueue&lt;ByteBuffer&gt;&gt;();</span><br><span class="line">    <span class="keyword">this</span>.senderWorkerMap = <span class="keyword">new</span> ConcurrentHashMap&lt;Long, SendWorker&gt;();</span><br><span class="line">    <span class="keyword">this</span>.lastMessageSent = <span class="keyword">new</span> ConcurrentHashMap&lt;Long, ByteBuffer&gt;();</span><br><span class="line"></span><br><span class="line">    String cnxToValue = System.getProperty(<span class="string">"zookeeper.cnxTimeout"</span>);</span><br><span class="line">    <span class="keyword">if</span>(cnxToValue != <span class="keyword">null</span>){</span><br><span class="line">        <span class="keyword">this</span>.cnxTO = Integer.parseInt(cnxToValue);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.self = self;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.mySid = mySid;</span><br><span class="line">    <span class="keyword">this</span>.socketTimeout = socketTimeout;</span><br><span class="line">    <span class="keyword">this</span>.view = view;</span><br><span class="line">    <span class="keyword">this</span>.listenOnAllIPs = listenOnAllIPs;</span><br><span class="line"></span><br><span class="line">    initializeAuth(mySid, authServer, authLearner, quorumCnxnThreadsSize,</span><br><span class="line">            quorumSaslAuthEnabled);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Starts listener thread that waits for connection requests</span></span><br><span class="line">    listener = <span class="keyword">new</span> Listener();</span><br><span class="line">    listener.setName(<span class="string">"QuorumPeerListener"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="监听线程初始化"><a href="#监听线程初始化" class="headerlink" title="监听线程初始化"></a>监听线程初始化</h4><ul><li><code>QuorumCnxManager.Listener.run()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">int</span> numRetries = <span class="number">0</span>;</span><br><span class="line">    InetSocketAddress addr;</span><br><span class="line">    Socket client = <span class="keyword">null</span>;</span><br><span class="line">    Exception exitException = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">while</span> ((!shutdown) &amp;&amp; (portBindMaxRetry == <span class="number">0</span> || numRetries &lt; portBindMaxRetry)) {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">if</span> (self.shouldUsePortUnification()) {</span><br><span class="line">                LOG.info(<span class="string">"Creating TLS-enabled quorum server socket"</span>);</span><br><span class="line">                ss = <span class="keyword">new</span> UnifiedServerSocket(self.getX509Util(), <span class="keyword">true</span>);</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (self.isSslQuorum()) {</span><br><span class="line">                LOG.info(<span class="string">"Creating TLS-only quorum server socket"</span>);</span><br><span class="line">                ss = <span class="keyword">new</span> UnifiedServerSocket(self.getX509Util(), <span class="keyword">false</span>);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                ss = <span class="keyword">new</span> ServerSocket();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            ss.setReuseAddress(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (self.getQuorumListenOnAllIPs()) {</span><br><span class="line">                <span class="keyword">int</span> port = self.getElectionAddress().getPort();</span><br><span class="line">                addr = <span class="keyword">new</span> InetSocketAddress(port);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// Resolve hostname for this server in case the</span></span><br><span class="line">                <span class="comment">// underlying ip address has changed.</span></span><br><span class="line">                self.recreateSocketAddresses(self.getId());</span><br><span class="line">                addr = self.getElectionAddress();</span><br><span class="line">            }</span><br><span class="line">            LOG.info(<span class="string">"My election bind port: "</span> + addr.toString());</span><br><span class="line">            setName(addr.toString());</span><br><span class="line">            <span class="comment">// 绑定服务器地址</span></span><br><span class="line">            ss.bind(addr);</span><br><span class="line">            <span class="comment">// 死循环</span></span><br><span class="line">            <span class="keyword">while</span> (!shutdown) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="comment">// 阻塞等待处理请求</span></span><br><span class="line">                    client = ss.accept();</span><br><span class="line">                    setSockOpts(client);</span><br><span class="line">                    LOG.info(<span class="string">"Received connection request "</span></span><br><span class="line">                            + formatInetAddr((InetSocketAddress)client.getRemoteSocketAddress()));</span><br><span class="line">                    <span class="comment">// Receive and handle the connection request</span></span><br><span class="line">                    <span class="comment">// asynchronously if the quorum sasl authentication is</span></span><br><span class="line">                    <span class="comment">// enabled. This is required because sasl server</span></span><br><span class="line">                    <span class="comment">// authentication process may take few seconds to finish,</span></span><br><span class="line">                    <span class="comment">// this may delay next peer connection requests.</span></span><br><span class="line">                    <span class="keyword">if</span> (quorumSaslAuthEnabled) {</span><br><span class="line">                        receiveConnectionAsync(client);</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        receiveConnection(client);</span><br><span class="line">                    }</span><br><span class="line">                    numRetries = <span class="number">0</span>;</span><br><span class="line">                } <span class="keyword">catch</span> (SocketTimeoutException e) {</span><br><span class="line">                    LOG.warn(<span class="string">"The socket is listening for the election accepted "</span></span><br><span class="line">                                + <span class="string">"and it timed out unexpectedly, but will retry."</span></span><br><span class="line">                                + <span class="string">"see ZOOKEEPER-2836"</span>);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            <span class="keyword">if</span> (shutdown) {</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">            LOG.error(<span class="string">"Exception while listening"</span>, e);</span><br><span class="line">            exitException = e;</span><br><span class="line">            numRetries++;</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                ss.close();</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            } <span class="keyword">catch</span> (IOException ie) {</span><br><span class="line">                LOG.error(<span class="string">"Error closing server socket"</span>, ie);</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException ie) {</span><br><span class="line">                LOG.error(<span class="string">"Interrupted while sleeping. "</span> +</span><br><span class="line">                    <span class="string">"Ignoring exception"</span>, ie);</span><br><span class="line">            }</span><br><span class="line">            closeSocket(client);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="选举准备"><a href="#选举准备" class="headerlink" title="选举准备"></a>选举准备</h4><ul><li><code>FastLeaderElection.FastLeaderElection()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FastLeaderElection</span><span class="params">(QuorumPeer self, QuorumCnxManager manager)</span></span>{</span><br><span class="line">    <span class="keyword">this</span>.stop = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">this</span>.manager = manager;</span><br><span class="line">    starter(self, manager);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>FastLeaderElection.starter()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">starter</span><span class="params">(QuorumPeer self, QuorumCnxManager manager)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.self = self;</span><br><span class="line">    proposedLeader = -<span class="number">1</span>;</span><br><span class="line">    proposedZxid = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化队列和信息</span></span><br><span class="line">    sendqueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;ToSend&gt;();</span><br><span class="line">    recvqueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;Notification&gt;();</span><br><span class="line">    <span class="keyword">this</span>.messenger = <span class="keyword">new</span> Messenger(manager);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="集群选举执行"><a href="#集群选举执行" class="headerlink" title="集群选举执行"></a>集群选举执行</h3><p><img data-src="../../../asset/2025/01/zookeeper-source-8.png"></p><h4 id="选举整体流程"><a href="#选举整体流程" class="headerlink" title="选举整体流程"></a>选举整体流程</h4><p><img data-src="../../../asset/2025/01/zookeeper-source-6.png"></p><div class="admonition note"><p class="admonition-title">提示</p><ul><li><code>FastLeaderElection</code> 类专门用于管理集群选举的。它有两个核心的内部线程类，包括 <code>WorkerSender（发送选举投票消息）</code> 和 <code>WorkerReceiver（接收选举投票消息）</code>。</li><li><code>QuorumCnxManager</code> 类专门用于管理集群之间的通信，比如集群节点之间的消息发送与消息接收。它有两个核心的内部线程类，包括 <code>SendWorker（发送消息）</code>、<code>RecvWorker（接收消息）</code>。</li></ul></div><h4 id="第一部分代码"><a href="#第一部分代码" class="headerlink" title="第一部分代码"></a>第一部分代码</h4><ul><li><code>QuorumPeerMain.initializeAndRun()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initializeAndRun</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ConfigException, IOException, AdminServerException</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// 管理 ZK 的配置信息</span></span><br><span class="line">    QuorumPeerConfig config = <span class="keyword">new</span> QuorumPeerConfig();</span><br><span class="line">    <span class="keyword">if</span> (args.length == <span class="number">1</span>) {</span><br><span class="line">        <span class="comment">// 解析参数，包括 zoo.cfg 和 myid 文件</span></span><br><span class="line">        config.parse(args[<span class="number">0</span>]);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动定时任务，对过期的快照执行删除（该功能默认关闭）</span></span><br><span class="line">    DatadirCleanupManager purgeMgr = <span class="keyword">new</span> DatadirCleanupManager(config</span><br><span class="line">            .getDataDir(), config.getDataLogDir(), config</span><br><span class="line">            .getSnapRetainCount(), config.getPurgeInterval());</span><br><span class="line">    purgeMgr.start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (args.length == <span class="number">1</span> &amp;&amp; config.isDistributed()) {</span><br><span class="line">        <span class="comment">// 集群模式启动</span></span><br><span class="line">        runFromConfig(config);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        LOG.warn(<span class="string">"Either no config or no quorum defined in config, running "</span></span><br><span class="line">                + <span class="string">" in standalone mode"</span>);</span><br><span class="line">        <span class="comment">// 单机模式启动</span></span><br><span class="line">        ZooKeeperServerMain.main(args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumPeerMain.runFromConfig()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runFromConfig</span><span class="params">(QuorumPeerConfig config)</span> <span class="keyword">throws</span> IOException, AdminServerException</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        ManagedUtil.registerLog4jMBeans();</span><br><span class="line">    } <span class="keyword">catch</span> (JMException e) {</span><br><span class="line">        LOG.warn(<span class="string">"Unable to register log4j JMX control"</span>, e);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    LOG.info(<span class="string">"Starting quorum peer"</span>);</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        ServerCnxnFactory cnxnFactory = <span class="keyword">null</span>;</span><br><span class="line">        ServerCnxnFactory secureCnxnFactory = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通信组件初始化，默认是使用 NIO 通信（可以支持 Netty）</span></span><br><span class="line">        <span class="keyword">if</span> (config.getClientPortAddress() != <span class="keyword">null</span>) {</span><br><span class="line">            cnxnFactory = ServerCnxnFactory.createFactory();</span><br><span class="line">            cnxnFactory.configure(config.getClientPortAddress(),</span><br><span class="line">                    config.getMaxClientCnxns(),</span><br><span class="line">                    <span class="keyword">false</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (config.getSecureClientPortAddress() != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">// 初始化 NIO 服务端的 Socket，绑定 2181 端口</span></span><br><span class="line">            secureCnxnFactory = ServerCnxnFactory.createFactory();</span><br><span class="line">            secureCnxnFactory.configure(config.getSecureClientPortAddress(),</span><br><span class="line">                    config.getMaxClientCnxns(),</span><br><span class="line">                    <span class="keyword">true</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将解析到的参数赋值给该 ZK 集群节点</span></span><br><span class="line">        quorumPeer = getQuorumPeer();</span><br><span class="line">        quorumPeer.setTxnFactory(<span class="keyword">new</span> FileTxnSnapLog(</span><br><span class="line">                    config.getDataLogDir(),</span><br><span class="line">                    config.getDataDir()));</span><br><span class="line">        quorumPeer.enableLocalSessions(config.areLocalSessionsEnabled());</span><br><span class="line">        quorumPeer.enableLocalSessionsUpgrading(</span><br><span class="line">            config.isLocalSessionsUpgradingEnabled());</span><br><span class="line">        <span class="comment">//quorumPeer.setQuorumPeers(config.getAllMembers());</span></span><br><span class="line">        quorumPeer.setElectionType(config.getElectionAlg());</span><br><span class="line">        quorumPeer.setMyid(config.getServerId());</span><br><span class="line">		</span><br><span class="line">        ......</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 启动 ZK 集群节点</span></span><br><span class="line">        quorumPeer.start();</span><br><span class="line">        quorumPeer.join();</span><br><span class="line">    } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">        <span class="comment">// warn, but generally this is ok</span></span><br><span class="line">        LOG.warn(<span class="string">"Quorum Peer interrupted"</span>, e);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumPeer.start()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (!getView().containsKey(myid)) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"My id "</span> + myid + <span class="string">" not in the peer list"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 冷启动恢复数据</span></span><br><span class="line">    loadDataBase();</span><br><span class="line">    startServerCnxnFactory();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 启动通信工厂实例对象</span></span><br><span class="line">        adminServer.start();</span><br><span class="line">    } <span class="keyword">catch</span> (AdminServerException e) {</span><br><span class="line">        LOG.warn(<span class="string">"Problem starting AdminServer"</span>, e);</span><br><span class="line">        System.out.println(e);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 准备选举环境</span></span><br><span class="line">    startLeaderElection();</span><br><span class="line">    <span class="comment">// 执行选举</span></span><br><span class="line">    <span class="keyword">super</span>.start();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumPeer.run()</code> 方法。值得一提的是，上面执行 <code>super.start()</code> 就相当于执行 <code>QuorumPeer</code> 类中的 <code>run()</code> 方法，表示开始执行选举。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">    updateThreadName();</span><br><span class="line"></span><br><span class="line">    LOG.debug(<span class="string">"Starting quorum peer"</span>);</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        jmxQuorumBean = <span class="keyword">new</span> QuorumBean(<span class="keyword">this</span>);</span><br><span class="line">        MBeanRegistry.getInstance().register(jmxQuorumBean, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">for</span>(QuorumServer s: getView().values()){</span><br><span class="line">            ZKMBeanInfo p;</span><br><span class="line">            <span class="keyword">if</span> (getId() == s.id) {</span><br><span class="line">                p = jmxLocalPeerBean = <span class="keyword">new</span> LocalPeerBean(<span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    MBeanRegistry.getInstance().register(p, jmxQuorumBean);</span><br><span class="line">                } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                    LOG.warn(<span class="string">"Failed to register with JMX"</span>, e);</span><br><span class="line">                    jmxLocalPeerBean = <span class="keyword">null</span>;</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                RemotePeerBean rBean = <span class="keyword">new</span> RemotePeerBean(<span class="keyword">this</span>, s);</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    MBeanRegistry.getInstance().register(rBean, jmxQuorumBean);</span><br><span class="line">                    jmxRemotePeerBean.put(s.id, rBean);</span><br><span class="line">                } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                    LOG.warn(<span class="string">"Failed to register with JMX"</span>, e);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        LOG.warn(<span class="string">"Failed to register with JMX"</span>, e);</span><br><span class="line">        jmxQuorumBean = <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            * Main loop</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">        <span class="keyword">while</span> (running) {</span><br><span class="line">            <span class="keyword">switch</span> (getPeerState()) {</span><br><span class="line">            <span class="keyword">case</span> LOOKING:</span><br><span class="line">                LOG.info(<span class="string">"LOOKING"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (Boolean.getBoolean(<span class="string">"readonlymode.enabled"</span>)) {</span><br><span class="line">                    LOG.info(<span class="string">"Attempting to start ReadOnlyZooKeeperServer"</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Create read-only server but don't start it immediately</span></span><br><span class="line">                    <span class="keyword">final</span> ReadOnlyZooKeeperServer roZk =</span><br><span class="line">                        <span class="keyword">new</span> ReadOnlyZooKeeperServer(logFactory, <span class="keyword">this</span>, <span class="keyword">this</span>.zkDb);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Instead of starting roZk immediately, wait some grace</span></span><br><span class="line">                    <span class="comment">// period before we decide we're partitioned.</span></span><br><span class="line">                    <span class="comment">//</span></span><br><span class="line">                    <span class="comment">// Thread is used here because otherwise it would require</span></span><br><span class="line">                    <span class="comment">// changes in each of election strategy classes which is</span></span><br><span class="line">                    <span class="comment">// unnecessary code coupling.</span></span><br><span class="line">                    Thread roZkMgr = <span class="keyword">new</span> Thread() {</span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">                            <span class="keyword">try</span> {</span><br><span class="line">                                <span class="comment">// lower-bound grace period to 2 secs</span></span><br><span class="line">                                sleep(Math.max(<span class="number">2000</span>, tickTime));</span><br><span class="line">                                <span class="keyword">if</span> (ServerState.LOOKING.equals(getPeerState())) {</span><br><span class="line">                                    roZk.startup();</span><br><span class="line">                                }</span><br><span class="line">                            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                                LOG.info(<span class="string">"Interrupted while attempting to start ReadOnlyZooKeeperServer, not started"</span>);</span><br><span class="line">                            } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                                LOG.error(<span class="string">"FAILED to start ReadOnlyZooKeeperServer"</span>, e);</span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line">                    };</span><br><span class="line">                    <span class="keyword">try</span> {</span><br><span class="line">                        roZkMgr.start();</span><br><span class="line">                        reconfigFlagClear();</span><br><span class="line">                        <span class="keyword">if</span> (shuttingDownLE) {</span><br><span class="line">                            shuttingDownLE = <span class="keyword">false</span>;</span><br><span class="line">                            startLeaderElection();</span><br><span class="line">                        }</span><br><span class="line">                        <span class="comment">// 进行选举，选举结束后返回最终成为 Leader 胜选的那张选票</span></span><br><span class="line">                        setCurrentVote(makeLEStrategy().lookForLeader());</span><br><span class="line">                    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                        LOG.warn(<span class="string">"Unexpected exception"</span>, e);</span><br><span class="line">                        setPeerState(ServerState.LOOKING);</span><br><span class="line">                    } <span class="keyword">finally</span> {</span><br><span class="line">                        <span class="comment">// If the thread is in the the grace period, interrupt</span></span><br><span class="line">                        <span class="comment">// to come out of waiting.</span></span><br><span class="line">                        roZkMgr.interrupt();</span><br><span class="line">                        roZk.shutdown();</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="keyword">try</span> {</span><br><span class="line">                        reconfigFlagClear();</span><br><span class="line">                        <span class="keyword">if</span> (shuttingDownLE) {</span><br><span class="line">                            shuttingDownLE = <span class="keyword">false</span>;</span><br><span class="line">                            startLeaderElection();</span><br><span class="line">                            }</span><br><span class="line">                        setCurrentVote(makeLEStrategy().lookForLeader());</span><br><span class="line">                    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                        LOG.warn(<span class="string">"Unexpected exception"</span>, e);</span><br><span class="line">                        setPeerState(ServerState.LOOKING);</span><br><span class="line">                    }                        </span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OBSERVING:</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    LOG.info(<span class="string">"OBSERVING"</span>);</span><br><span class="line">                    setObserver(makeObserver(logFactory));</span><br><span class="line">                    observer.observeLeader();</span><br><span class="line">                } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                    LOG.warn(<span class="string">"Unexpected exception"</span>,e );</span><br><span class="line">                } <span class="keyword">finally</span> {</span><br><span class="line">                    observer.shutdown();</span><br><span class="line">                    setObserver(<span class="keyword">null</span>);  </span><br><span class="line">                    updateServerState();</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FOLLOWING:</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    LOG.info(<span class="string">"FOLLOWING"</span>);</span><br><span class="line">                    setFollower(makeFollower(logFactory));</span><br><span class="line">                    follower.followLeader();</span><br><span class="line">                } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                    LOG.warn(<span class="string">"Unexpected exception"</span>,e);</span><br><span class="line">                } <span class="keyword">finally</span> {</span><br><span class="line">                    follower.shutdown();</span><br><span class="line">                    setFollower(<span class="keyword">null</span>);</span><br><span class="line">                    updateServerState();</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> LEADING:</span><br><span class="line">                LOG.info(<span class="string">"LEADING"</span>);</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    setLeader(makeLeader(logFactory));</span><br><span class="line">                    leader.lead();</span><br><span class="line">                    setLeader(<span class="keyword">null</span>);</span><br><span class="line">                } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                    LOG.warn(<span class="string">"Unexpected exception"</span>,e);</span><br><span class="line">                } <span class="keyword">finally</span> {</span><br><span class="line">                    <span class="keyword">if</span> (leader != <span class="keyword">null</span>) {</span><br><span class="line">                        leader.shutdown(<span class="string">"Forcing shutdown"</span>);</span><br><span class="line">                        setLeader(<span class="keyword">null</span>);</span><br><span class="line">                    }</span><br><span class="line">                    updateServerState();</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">            start_fle = Time.currentElapsedTime();</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        LOG.warn(<span class="string">"QuorumPeer main thread exited"</span>);</span><br><span class="line">        MBeanRegistry instance = MBeanRegistry.getInstance();</span><br><span class="line">        instance.unregister(jmxQuorumBean);</span><br><span class="line">        instance.unregister(jmxLocalPeerBean);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (RemotePeerBean remotePeerBean : jmxRemotePeerBean.values()) {</span><br><span class="line">            instance.unregister(remotePeerBean);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        jmxQuorumBean = <span class="keyword">null</span>;</span><br><span class="line">        jmxLocalPeerBean = <span class="keyword">null</span>;</span><br><span class="line">        jmxRemotePeerBean = <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>FastLeaderElection.lookForLeader()</code> 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Vote <span class="title">lookForLeader</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        self.jmxLeaderElectionBean = <span class="keyword">new</span> LeaderElectionBean();</span><br><span class="line">        MBeanRegistry.getInstance().register(</span><br><span class="line">                self.jmxLeaderElectionBean, self.jmxLocalPeerBean);</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        LOG.warn(<span class="string">"Failed to register with JMX"</span>, e);</span><br><span class="line">        self.jmxLeaderElectionBean = <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (self.start_fle == <span class="number">0</span>) {</span><br><span class="line">        self.start_fle = Time.currentElapsedTime();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 节点正在启动时，所有其他集群节点都会给我发送一个投票</span></span><br><span class="line">        <span class="comment">// 保存每一个集群节点的最新合法有效的投票结果</span></span><br><span class="line">        HashMap&lt;Long, Vote&gt; recvset = <span class="keyword">new</span> HashMap&lt;Long, Vote&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 存储合法选举之外的投票结果</span></span><br><span class="line">        HashMap&lt;Long, Vote&gt; outofelection = <span class="keyword">new</span> HashMap&lt;Long, Vote&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 一次选举的最大等待时间，默认值是 0.2s</span></span><br><span class="line">        <span class="keyword">int</span> notTimeout = finalizeWait;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 每发起一轮选举，logicalclock++</span></span><br><span class="line">        <span class="comment">// 在没有合法的 epoch 数据之前，都使用逻辑时钟代替</span></span><br><span class="line">        <span class="comment">// 选举 Leader 的规则：依次比较 epoch（任期的代号）、zxid（事务 ID）、ServerID（myid），谁大谁当选 Leader</span></span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>){</span><br><span class="line">            <span class="comment">// 更新逻辑时钟，每进行一次选举，都需要更新逻辑时钟</span></span><br><span class="line">            logicalclock.incrementAndGet();</span><br><span class="line">            <span class="comment">// 更新选票（serverid、zxid、epoch）</span></span><br><span class="line">            updateProposal(getInitId(), getInitLastLoggedZxid(), getPeerEpoch());</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        LOG.info(<span class="string">"New election. My id =  "</span> + self.getId() +</span><br><span class="line">                <span class="string">", proposed zxid=0x"</span> + Long.toHexString(proposedZxid));</span><br><span class="line">        <span class="comment">// 广播选票，将自己的选票发给其他集群节点</span></span><br><span class="line">        sendNotifications();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * Loop in which we exchange notifications until we find a leader</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="comment">// 一轮一轮地选举，直到选举成功</span></span><br><span class="line">        <span class="keyword">while</span> ((self.getPeerState() == ServerState.LOOKING) &amp;&amp; (!stop)){</span><br><span class="line">            ......        </span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        ......</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>FastLeaderElection.sendNotifications()</code> 方法，负责广播选票，将自己的选票发送给其他集群节点。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendNotifications</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// 遍历投票参与者，给每个集群节点发送选票</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">long</span> sid : self.getCurrentAndNextConfigVoters()) {</span><br><span class="line">        <span class="comment">// 创建需要发送的选票</span></span><br><span class="line">        QuorumVerifier qv = self.getQuorumVerifier();</span><br><span class="line">        ToSend notmsg = <span class="keyword">new</span> ToSend(ToSend.mType.notification,</span><br><span class="line">                proposedLeader,</span><br><span class="line">                proposedZxid,</span><br><span class="line">                logicalclock.get(),</span><br><span class="line">                QuorumPeer.ServerState.LOOKING,</span><br><span class="line">                sid,</span><br><span class="line">                proposedEpoch, qv.toString().getBytes());</span><br><span class="line">        <span class="keyword">if</span>(LOG.isDebugEnabled()){</span><br><span class="line">            LOG.debug(<span class="string">"Sending Notification: "</span> + proposedLeader + <span class="string">" (n.leader), 0x"</span>  +</span><br><span class="line">                    Long.toHexString(proposedZxid) + <span class="string">" (n.zxid), 0x"</span> + Long.toHexString(logicalclock.get())  +</span><br><span class="line">                    <span class="string">" (n.round), "</span> + sid + <span class="string">" (recipient), "</span> + self.getId() +</span><br><span class="line">                    <span class="string">" (myid), 0x"</span> + Long.toHexString(proposedEpoch) + <span class="string">" (n.peerEpoch)"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 将需要发送的选票放入发送队列</span></span><br><span class="line">        sendqueue.offer(notmsg);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>FastLeaderElection.Messenger.WorkerSender</code> 线程类，负责将选举投票消息发送给其他集群节点。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WorkerSender</span> <span class="keyword">extends</span> <span class="title">ZooKeeperThread</span> </span>{</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">boolean</span> stop;</span><br><span class="line">    QuorumCnxManager manager;</span><br><span class="line"></span><br><span class="line">    WorkerSender(QuorumCnxManager manager){</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">"WorkerSender"</span>);</span><br><span class="line">        <span class="keyword">this</span>.stop = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.manager = manager;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">while</span> (!stop) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">// 队列阻塞，时刻准备接收要发送的选票</span></span><br><span class="line">                ToSend m = sendqueue.poll(<span class="number">3000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">                <span class="keyword">if</span>(m == <span class="keyword">null</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 处理需要发送的选票</span></span><br><span class="line">                process(m);</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        LOG.info(<span class="string">"WorkerSender is down"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Called by run() once there is a new message to send.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> m     message to send</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">process</span><span class="params">(ToSend m)</span> </span>{</span><br><span class="line">        ByteBuffer requestBuffer = buildMsg(m.state.ordinal(),</span><br><span class="line">                                            m.leader,</span><br><span class="line">                                            m.zxid,</span><br><span class="line">                                            m.electionEpoch,</span><br><span class="line">                                            m.peerEpoch,</span><br><span class="line">                                            m.configData);</span><br><span class="line">        <span class="comment">// 发送选票</span></span><br><span class="line">        manager.toSend(m.sid, requestBuffer);</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumCnxManager.toSend()</code> 方法，发送消息给其他集群节点。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toSend</span><span class="params">(Long sid, ByteBuffer b)</span> </span>{</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * If sending message to myself, then simply enqueue it (loopback).</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">// 如果是发给自己的消息，则直接进入自己的 RecvQueue 队列</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.mySid == sid) {</span><br><span class="line">            b.position(<span class="number">0</span>);</span><br><span class="line">            addToRecvQueue(<span class="keyword">new</span> Message(b.duplicate(), sid));</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            * Otherwise send to the corresponding thread to send.</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            * Start a new connection if doesn't have one already.</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="comment">// 如果是发给其他集群节点的消息，则获取已经存在的发送队列或者创建对应的发送队列，并将需要发送的消息放入该队列中</span></span><br><span class="line">            ArrayBlockingQueue&lt;ByteBuffer&gt; bq = <span class="keyword">new</span> ArrayBlockingQueue&lt;ByteBuffer&gt;(</span><br><span class="line">            SEND_CAPACITY);</span><br><span class="line">            ArrayBlockingQueue&lt;ByteBuffer&gt; oldq = queueSendMap.putIfAbsent(sid, bq);</span><br><span class="line">            <span class="keyword">if</span> (oldq != <span class="keyword">null</span>) {</span><br><span class="line">                addToSendQueue(oldq, b);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                addToSendQueue(bq, b);</span><br><span class="line">            }</span><br><span class="line">            connectOne(sid);</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="第二部分代码"><a href="#第二部分代码" class="headerlink" title="第二部分代码"></a>第二部分代码</h4><ul><li><code>QuorumCnxManager.addToRecvQueue()</code> 方法，将接收到的消息添加到接收队列。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addToRecvQueue</span><span class="params">(Message msg)</span> </span>{</span><br><span class="line">    <span class="keyword">synchronized</span>(recvQLock) {</span><br><span class="line">        <span class="keyword">if</span> (recvQueue.remainingCapacity() == <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                recvQueue.remove();</span><br><span class="line">            } <span class="keyword">catch</span> (NoSuchElementException ne) {</span><br><span class="line">                <span class="comment">// element could be removed by poll()</span></span><br><span class="line">                    LOG.debug(<span class="string">"Trying to remove from an empty "</span> +</span><br><span class="line">                        <span class="string">"recvQueue. Ignoring exception "</span> + ne);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 将发送给自己的消息添加到 recvQueue 队列</span></span><br><span class="line">            recvQueue.add(msg);</span><br><span class="line">        } <span class="keyword">catch</span> (IllegalStateException ie) {</span><br><span class="line">            <span class="comment">// This should never happen</span></span><br><span class="line">            LOG.error(<span class="string">"Unable to insert element in the recvQueue "</span> + ie);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumCnxManager.addToSendQueue()</code> 方法，将需要发送的消息添加到发送队列。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addToSendQueue</span><span class="params">(ArrayBlockingQueue&lt;ByteBuffer&gt; queue,</span></span></span><br><span class="line"><span class="params"><span class="function">        ByteBuffer buffer)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (queue.remainingCapacity() == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            queue.remove();</span><br><span class="line">        } <span class="keyword">catch</span> (NoSuchElementException ne) {</span><br><span class="line">            <span class="comment">// element could be removed by poll()</span></span><br><span class="line">            LOG.debug(<span class="string">"Trying to remove from an empty "</span> +</span><br><span class="line">                    <span class="string">"Queue. Ignoring exception "</span> + ne);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 将需要发送的消息添加到发送队列</span></span><br><span class="line">        queue.add(buffer);</span><br><span class="line">    } <span class="keyword">catch</span> (IllegalStateException ie) {</span><br><span class="line">        <span class="comment">// This should never happen</span></span><br><span class="line">        LOG.error(<span class="string">"Unable to insert an element in the queue "</span> + ie);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumCnxManager.connectOne()</code> 方法，与要发送消息的集群节点建立通信连接。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">connectOne</span><span class="params">(<span class="keyword">long</span> sid)</span></span>{</span><br><span class="line">    <span class="keyword">if</span> (senderWorkerMap.get(sid) != <span class="keyword">null</span>) {</span><br><span class="line">        LOG.debug(<span class="string">"There is a connection already for server "</span> + sid);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">synchronized</span> (self.QV_LOCK) {</span><br><span class="line">        <span class="keyword">boolean</span> knownId = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// Resolve hostname for the remote server before attempting to</span></span><br><span class="line">        <span class="comment">// connect in case the underlying ip address has changed.</span></span><br><span class="line">        self.recreateSocketAddresses(sid);</span><br><span class="line">        Map&lt;Long, QuorumPeer.QuorumServer&gt; lastCommittedView = self.getView();</span><br><span class="line">        QuorumVerifier lastSeenQV = self.getLastSeenQuorumVerifier();</span><br><span class="line">        Map&lt;Long, QuorumPeer.QuorumServer&gt; lastProposedView = lastSeenQV.getAllMembers();</span><br><span class="line">        <span class="keyword">if</span> (lastCommittedView.containsKey(sid)) {</span><br><span class="line">            knownId = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (connectOne(sid, lastCommittedView.get(sid).electionAddr))</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (lastSeenQV != <span class="keyword">null</span> &amp;&amp; lastProposedView.containsKey(sid)</span><br><span class="line">                &amp;&amp; (!knownId || (lastProposedView.get(sid).electionAddr !=</span><br><span class="line">                lastCommittedView.get(sid).electionAddr))) {</span><br><span class="line">            knownId = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (connectOne(sid, lastProposedView.get(sid).electionAddr))</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (!knownId) {</span><br><span class="line">            LOG.warn(<span class="string">"Invalid server id: "</span> + sid);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumCnxManager.connectOne()</code> 方法，与要发送消息的集群节点建立通信连接。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">connectOne</span><span class="params">(<span class="keyword">long</span> sid, InetSocketAddress electionAddr)</span></span>{</span><br><span class="line">    <span class="keyword">if</span> (senderWorkerMap.get(sid) != <span class="keyword">null</span>) {</span><br><span class="line">        LOG.debug(<span class="string">"There is a connection already for server "</span> + sid);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    Socket sock = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        LOG.debug(<span class="string">"Opening channel to server "</span> + sid);</span><br><span class="line">        <span class="keyword">if</span> (self.isSslQuorum()) {</span><br><span class="line">                SSLSocket sslSock = self.getX509Util().createSSLSocket();</span><br><span class="line">                setSockOpts(sslSock);</span><br><span class="line">                sslSock.connect(electionAddr, cnxTO);</span><br><span class="line">                sslSock.startHandshake();</span><br><span class="line">                sock = sslSock;</span><br><span class="line">                LOG.info(<span class="string">"SSL handshake complete with {} - {} - {}"</span>, sslSock.getRemoteSocketAddress(), sslSock.getSession().getProtocol(), sslSock.getSession().getCipherSuite());</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                sock = <span class="keyword">new</span> Socket();</span><br><span class="line">                setSockOpts(sock);</span><br><span class="line">                sock.connect(electionAddr, cnxTO);</span><br><span class="line"></span><br><span class="line">            }</span><br><span class="line">            LOG.debug(<span class="string">"Connected to server "</span> + sid);</span><br><span class="line">        <span class="comment">// Sends connection request asynchronously if the quorum</span></span><br><span class="line">        <span class="comment">// sasl authentication is enabled. This is required because</span></span><br><span class="line">        <span class="comment">// sasl server authentication process may take few seconds to</span></span><br><span class="line">        <span class="comment">// finish, this may delay next peer connection requests.</span></span><br><span class="line">        <span class="keyword">if</span> (quorumSaslAuthEnabled) {</span><br><span class="line">            initiateConnectionAsync(sock, sid);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 建立连接</span></span><br><span class="line">            initiateConnection(sock, sid);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    } <span class="keyword">catch</span> (UnresolvedAddressException e) {</span><br><span class="line">        ......</span><br><span class="line">    }</span><br><span class="line">    ......</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumCnxManager.initiateConnection()</code> 方法，建立通信连接</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initiateConnection</span><span class="params">(<span class="keyword">final</span> Socket sock, <span class="keyword">final</span> Long sid)</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        startConnection(sock, sid);</span><br><span class="line">    } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">        LOG.error(<span class="string">"Exception while connecting, id: {}, addr: {}, closing learner connection"</span>,</span><br><span class="line">                <span class="keyword">new</span> Object[] { sid, sock.getRemoteSocketAddress() }, e);</span><br><span class="line">        closeSocket(sock);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumCnxManager.startConnection()</code> 方法，创建并启动发送器线程和接收器线程。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">startConnection</span><span class="params">(Socket sock, Long sid)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    DataOutputStream dout = <span class="keyword">null</span>;</span><br><span class="line">    DataInputStream din = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// Use BufferedOutputStream to reduce the number of IP packets. This is</span></span><br><span class="line">        <span class="comment">// important for x-DC scenarios.</span></span><br><span class="line">        <span class="comment">// 通过输出流，向对方发送数据</span></span><br><span class="line">        BufferedOutputStream buf = <span class="keyword">new</span> BufferedOutputStream(sock.getOutputStream());</span><br><span class="line">        dout = <span class="keyword">new</span> DataOutputStream(buf);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Sending id and challenge</span></span><br><span class="line">        <span class="comment">// represents protocol version (in other words - message type)</span></span><br><span class="line">        dout.writeLong(PROTOCOL_VERSION);</span><br><span class="line">        dout.writeLong(self.getId());</span><br><span class="line">        String addr = formatInetAddr(self.getElectionAddress());</span><br><span class="line">        <span class="keyword">byte</span>[] addr_bytes = addr.getBytes();</span><br><span class="line">        dout.writeInt(addr_bytes.length);</span><br><span class="line">        dout.write(addr_bytes);</span><br><span class="line">        dout.flush();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过输入流，读取对方发送过来的消息</span></span><br><span class="line">        din = <span class="keyword">new</span> DataInputStream(</span><br><span class="line">                <span class="keyword">new</span> BufferedInputStream(sock.getInputStream()));</span><br><span class="line">    } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">        LOG.warn(<span class="string">"Ignoring exception reading or writing challenge: "</span>, e);</span><br><span class="line">        closeSocket(sock);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// authenticate learner</span></span><br><span class="line">    QuorumPeer.QuorumServer qps = self.getVotingView().get(sid);</span><br><span class="line">    <span class="keyword">if</span> (qps != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">// TODO - investigate why reconfig makes qps null.</span></span><br><span class="line">        authLearner.authenticate(sock, qps.hostname);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If lost the challenge, then drop the new connection</span></span><br><span class="line">    <span class="comment">// 如果对方的 myid 比我的大，我是没有资格给对方发送连接请求的，直接关闭自己的 Socket 客户端</span></span><br><span class="line">    <span class="keyword">if</span> (sid &gt; self.getId()) {</span><br><span class="line">        LOG.info(<span class="string">"Have smaller server identifier, so dropping the "</span> +</span><br><span class="line">                <span class="string">"connection: ("</span> + sid + <span class="string">", "</span> + self.getId() + <span class="string">")"</span>);</span><br><span class="line">        closeSocket(sock);</span><br><span class="line">        <span class="comment">// Otherwise proceed with the connection</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// 初始化发送器和接收器</span></span><br><span class="line">        SendWorker sw = <span class="keyword">new</span> SendWorker(sock, sid);</span><br><span class="line">        RecvWorker rw = <span class="keyword">new</span> RecvWorker(sock, din, sid, sw);</span><br><span class="line">        sw.setRecv(rw);</span><br><span class="line"></span><br><span class="line">        SendWorker vsw = senderWorkerMap.get(sid);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(vsw != <span class="keyword">null</span>)</span><br><span class="line">            vsw.finish();</span><br><span class="line"></span><br><span class="line">        senderWorkerMap.put(sid, sw);</span><br><span class="line">        queueSendMap.putIfAbsent(sid, <span class="keyword">new</span> ArrayBlockingQueue&lt;ByteBuffer&gt;(</span><br><span class="line">                SEND_CAPACITY));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动发送器线程和接收器线程</span></span><br><span class="line">        sw.start();</span><br><span class="line">        rw.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumCnxManager.SendWorker.run()</code> 方法，发送器线程的核心处理逻辑。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">    threadCnt.incrementAndGet();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * If there is nothing in the queue to send, then we</span></span><br><span class="line"><span class="comment">         * send the lastMessage to ensure that the last message</span></span><br><span class="line"><span class="comment">         * was received by the peer. The message could be dropped</span></span><br><span class="line"><span class="comment">         * in case self or the peer shutdown their connection</span></span><br><span class="line"><span class="comment">         * (and exit the thread) prior to reading/processing</span></span><br><span class="line"><span class="comment">         * the last message. Duplicate messages are handled correctly</span></span><br><span class="line"><span class="comment">         * by the peer.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * If the send queue is non-empty, then we have a recent</span></span><br><span class="line"><span class="comment">         * message than that stored in lastMessage. To avoid sending</span></span><br><span class="line"><span class="comment">         * stale message, we should send the message in the send queue.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ArrayBlockingQueue&lt;ByteBuffer&gt; bq = queueSendMap.get(sid);</span><br><span class="line">        <span class="keyword">if</span> (bq == <span class="keyword">null</span> || isSendQueueEmpty(bq)) {</span><br><span class="line">            ByteBuffer b = lastMessageSent.get(sid);</span><br><span class="line">            <span class="keyword">if</span> (b != <span class="keyword">null</span>) {</span><br><span class="line">                LOG.debug(<span class="string">"Attempting to send lastMessage to sid="</span> + sid);</span><br><span class="line">                send(b);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">        LOG.error(<span class="string">"Failed to send last message. Shutting down thread."</span>, e);</span><br><span class="line">        <span class="keyword">this</span>.finish();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 只要连接没有断开</span></span><br><span class="line">        <span class="keyword">while</span> (running &amp;&amp; !shutdown &amp;&amp; sock != <span class="keyword">null</span>) {</span><br><span class="line"></span><br><span class="line">            ByteBuffer b = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                ArrayBlockingQueue&lt;ByteBuffer&gt; bq = queueSendMap</span><br><span class="line">                        .get(sid);</span><br><span class="line">                <span class="keyword">if</span> (bq != <span class="keyword">null</span>) {</span><br><span class="line">                    <span class="comment">// 不断从发送队列 SendQueue 中获取需要发送的消息</span></span><br><span class="line">                    b = pollSendQueue(bq, <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    LOG.error(<span class="string">"No queue of incoming messages for "</span> +</span><br><span class="line">                                <span class="string">"server "</span> + sid);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(b != <span class="keyword">null</span>){</span><br><span class="line">                    <span class="comment">// 更新对于 sid 这个集群节点的最近一条消息</span></span><br><span class="line">                    lastMessageSent.put(sid, b);</span><br><span class="line">                    <span class="comment">// 将消息发送出去</span></span><br><span class="line">                    send(b);</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                LOG.warn(<span class="string">"Interrupted while waiting for message on queue"</span>,</span><br><span class="line">                        e);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        LOG.warn(<span class="string">"Exception when using channel: for id "</span> + sid</span><br><span class="line">                    + <span class="string">" my id = "</span> + QuorumCnxManager.<span class="keyword">this</span>.mySid</span><br><span class="line">                    + <span class="string">" error = "</span> + e);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">this</span>.finish();</span><br><span class="line">    LOG.warn(<span class="string">"Send worker leaving thread "</span> + <span class="string">" id "</span> + sid + <span class="string">" my id = "</span> + self.getId());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumCnxManager.SendWorker.send()</code> 方法，将消息发送出去。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(ByteBuffer b)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    <span class="keyword">byte</span>[] msgBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[b.capacity()];</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        b.position(<span class="number">0</span>);</span><br><span class="line">        b.get(msgBytes);</span><br><span class="line">    } <span class="keyword">catch</span> (BufferUnderflowException be) {</span><br><span class="line">        LOG.error(<span class="string">"BufferUnderflowException "</span>, be);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 通过输出流，向外发送消息</span></span><br><span class="line">    dout.writeInt(b.capacity());</span><br><span class="line">    dout.write(b.array());</span><br><span class="line">    dout.flush();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumCnxManager.RecvWorker.run()</code> 方法，接收器线程的核心处理逻辑。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">    threadCnt.incrementAndGet();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 只要连接没有断开</span></span><br><span class="line">        <span class="keyword">while</span> (running &amp;&amp; !shutdown &amp;&amp; sock != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * Reads the first int to determine the length of the</span></span><br><span class="line"><span class="comment">             * message</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">int</span> length = din.readInt();</span><br><span class="line">            <span class="keyword">if</span> (length &lt;= <span class="number">0</span> || length &gt; PACKETMAXSIZE) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(</span><br><span class="line">                        <span class="string">"Received packet with invalid packet: "</span></span><br><span class="line">                                + length);</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * Allocates a new ByteBuffer to receive the message</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">byte</span>[] msgArray = <span class="keyword">new</span> <span class="keyword">byte</span>[length];</span><br><span class="line">            <span class="comment">// 通过输入流，接收发送过来的消息</span></span><br><span class="line">            din.readFully(msgArray, <span class="number">0</span>, length);</span><br><span class="line">            ByteBuffer message = ByteBuffer.wrap(msgArray);</span><br><span class="line">            <span class="comment">// 将接收到的消息放入接收队列中</span></span><br><span class="line">            addToRecvQueue(<span class="keyword">new</span> Message(message.duplicate(), sid));</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        LOG.warn(<span class="string">"Connection broken for id "</span> + sid + <span class="string">", my id = "</span></span><br><span class="line">                    + QuorumCnxManager.<span class="keyword">this</span>.mySid + <span class="string">", error = "</span> , e);</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        LOG.warn(<span class="string">"Interrupting SendWorker"</span>);</span><br><span class="line">        sw.finish();</span><br><span class="line">        closeSocket(sock);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>QuorumCnxManager.addToRecvQueue()</code> 方法，将接收到的消息添加到接收队列中。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addToRecvQueue</span><span class="params">(Message msg)</span> </span>{</span><br><span class="line">    <span class="keyword">synchronized</span>(recvQLock) {</span><br><span class="line">        <span class="keyword">if</span> (recvQueue.remainingCapacity() == <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                recvQueue.remove();</span><br><span class="line">            } <span class="keyword">catch</span> (NoSuchElementException ne) {</span><br><span class="line">                <span class="comment">// element could be removed by poll()</span></span><br><span class="line">                    LOG.debug(<span class="string">"Trying to remove from an empty "</span> +</span><br><span class="line">                        <span class="string">"recvQueue. Ignoring exception "</span> + ne);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 将接收到的消息，放入接收队列中</span></span><br><span class="line">            recvQueue.add(msg);</span><br><span class="line">        } <span class="keyword">catch</span> (IllegalStateException ie) {</span><br><span class="line">            <span class="comment">// This should never happen</span></span><br><span class="line">            LOG.error(<span class="string">"Unable to insert element in the recvQueue "</span> + ie);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><code>FastLeaderElection.Messenger.WorkerReceiver</code> 线程类，负责接收其他集群节点发送过来的选举投票消息。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WorkerReceiver</span> <span class="keyword">extends</span> <span class="title">ZooKeeperThread</span>  </span>{</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">boolean</span> stop;</span><br><span class="line">    QuorumCnxManager manager;</span><br><span class="line"></span><br><span class="line">    WorkerReceiver(QuorumCnxManager manager) {</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">"WorkerReceiver"</span>);</span><br><span class="line">        <span class="keyword">this</span>.stop = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.manager = manager;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line"></span><br><span class="line">        Message response;</span><br><span class="line">        <span class="keyword">while</span> (!stop) {</span><br><span class="line">            <span class="comment">// Sleeps on receive</span></span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">// 从接收队列中，取出其他集群节点发送过来的选举投票消息</span></span><br><span class="line">                response = manager.pollRecvQueue(<span class="number">3000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">                ......</span><br><span class="line"></span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                LOG.warn(<span class="string">"Interrupted Exception while waiting for new message"</span> +</span><br><span class="line">                        e.toString());</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        LOG.info(<span class="string">"WorkerReceiver is down"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/b589771.html" title="ZooKeeper 入门教程之五">https://www.techgrow.cn/posts/b589771.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag"><i class="fa fa-tag"></i> 分布式</a><a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" rel="tag"><i class="fa fa-tag"></i> 大数据</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/16baf534.html" rel="prev" title="ZooKeeper 入门教程之四"><i class="fa fa-angle-left"></i> ZooKeeper 入门教程之四</a></div><div class="post-nav-item"> <a href="/posts/d415f72.html" rel="next" title="ZooKeeper 入门教程之六">ZooKeeper 入门教程之六<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">2.2m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">33:28</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/b589771.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>