<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍 ShardingSphere-Proxy 的入门教程。"><meta property="og:type" content="article"><meta property="og:title" content="ShardingSphere-Proxy 入门教程之三"><meta property="og:url" content="https://www.techgrow.cn/posts/dc701860.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍 ShardingSphere-Proxy 的入门教程。"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2022-10-06T15:12:41.000Z"><meta property="article:modified_time" content="2022-10-06T15:12:41.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="分布式"><meta property="article:tag" content="微服务"><meta property="article:tag" content="数据库"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.techgrow.cn/posts/dc701860.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/dc701860.html","path":"posts/dc701860.html","title":"ShardingSphere-Proxy 入门教程之三"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>ShardingSphere-Proxy 入门教程之三 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script>
  (function () {

  // 防止 Pjax 重复绑定事件
  if (window.__moonMenuCodeExpandBound) {
    return;
  }
  window.__moonMenuCodeExpandBound = true;

  const STORAGE_KEY = 'moon_menu_code_fold';

  /* ===============================
   * 1. 设置 moon-menu 按钮的 title
   * =============================== */
  (function bindMoonMenuTitles() {
    const items = [
      { selector: '#moon-menu-item-code',        title: '展开 / 折叠代码块' },
      { selector: '#moon-menu-item-back2top',    title: '回到页面顶部' },
      { selector: '#moon-menu-item-back2bottom', title: '回到页面底部' }
    ];

    let allReady = true;

    items.forEach(item => {
      const el = document.querySelector(item.selector);
      if (!el) {
        allReady = false;
        return;
      }
      el.setAttribute('title', item.title);
    });

    if (!allReady) {
      setTimeout(bindMoonMenuTitles, 100);
    }
  })();

  /* =================================
   * 2. 页面首次加载：代码块恢复展开或折叠状态
   * ================================= */
  function applyStoredCodeState() {
    const containers = document.querySelectorAll('.code-container');
    if (!containers.length) {
      return;
    }

    const state = localStorage.getItem(STORAGE_KEY);
    if (!state) {
      return;
    }

    containers.forEach(container => {
      if (state === 'expanded') {
        // 展开代码块
        container.classList.remove('highlight-fold');
      } else if (state === 'folded') {
        // 折叠代码块
        container.classList.add('highlight-fold');
      }
    });
  }

  // 等代码块出现后，再恢复展开或折叠状态
  function waitAndApplyState() {
    const containers = document.querySelectorAll('.code-container');

    if (!containers.length) {
      setTimeout(waitAndApplyState, 100);
      return;
    }

    applyStoredCodeState();
  }

  // 页面首次加载时恢复状态
  waitAndApplyState();
  
  // Pjax 切换页面后，必须重新恢复状态
  document.addEventListener('pjax:complete', function () {
    waitAndApplyState();
  });

  /* ===============================
   * 3. 点击按钮：切换状态并保存
   * =============================== */
  document.addEventListener('click', function (e) {
    const codeMenu = e.target.closest('#moon-menu-item-code');
    if (!codeMenu) {
      return;
    }

    toggleAllCodeBlocks();
  });

  // 展开或折叠代码块
  function toggleAllCodeBlocks() {
    const containers = document.querySelectorAll('.code-container');
    if (!containers.length) {
      return;
    }

    // 只要存在折叠的代码块，就认为当前是折叠状态
    const hasFolded = Array.from(containers).some(c => {
      return c.classList.contains('highlight-fold');
    });

    containers.forEach(container => {
      if (hasFolded) {
        // 展开代码块
        container.classList.remove('highlight-fold');
      } else {
        // 折叠代码块
        container.classList.add('highlight-fold');
      }
    });

    // 记录展开或折叠状态
    localStorage.setItem(
      STORAGE_KEY,
      hasFolded ? 'expanded' : 'folded'
    );
  }

})();
</script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%BA%90"><span class="nav-text">学习资源</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ShardingSphere-Proxy-%E5%88%86%E5%B8%83%E5%BC%8F%E5%BA%8F%E5%88%97%E7%AE%97%E6%B3%95"><span class="nav-text">ShardingSphere-Proxy 分布式序列算法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MyBatis-Plus-%E7%9A%84-ID-%E7%94%9F%E6%88%90%E7%AD%96%E7%95%A5"><span class="nav-text">MyBatis-Plus 的 ID 生成策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ShardingSphere-%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E5%BA%8F%E5%88%97"><span class="nav-text">ShardingSphere 的分布式序列</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SNOWFLAKE-%E7%AE%97%E6%B3%95"><span class="nav-text">SNOWFLAKE 算法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UUID-%E7%AE%97%E6%B3%95"><span class="nav-text">UUID 算法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ShardingSphere-Proxy-%E5%88%86%E7%89%87%E7%AE%97%E6%B3%95"><span class="nav-text">ShardingSphere-Proxy 分片算法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E7%89%87%E7%AE%97%E6%B3%95%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="nav-text">分片算法的类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E7%89%87%E7%AE%97%E6%B3%95%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">分片算法的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B0%B4%E5%B9%B3%E5%88%86%E5%BA%93"><span class="nav-text">水平分库</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A1%8C%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%88%86%E7%89%87%E7%AE%97%E6%B3%95"><span class="nav-text">行表达式分片算法</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#YAML-%E9%85%8D%E7%BD%AE%E6%A8%A1%E5%BC%8F"><span class="nav-text">YAML 配置模式</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#DistSQL-%E9%85%8D%E7%BD%AE%E6%A8%A1%E5%BC%8F"><span class="nav-text">DistSQL 配置模式</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%96%E6%A8%A1%E5%88%86%E7%89%87%E7%AE%97%E6%B3%95"><span class="nav-text">取模分片算法</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#YAML-%E9%85%8D%E7%BD%AE%E6%A8%A1%E5%BC%8F-1"><span class="nav-text">YAML 配置模式</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#DistSQL-%E9%85%8D%E7%BD%AE%E6%A8%A1%E5%BC%8F-1"><span class="nav-text">DistSQL 配置模式</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%93%88%E5%B8%8C%E5%8F%96%E6%A8%A1%E5%88%86%E7%89%87%E7%AE%97%E6%B3%95"><span class="nav-text">哈希取模分片算法</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#YAML-%E9%85%8D%E7%BD%AE%E6%A8%A1%E5%BC%8F-2"><span class="nav-text">YAML 配置模式</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#DistSQL-%E9%85%8D%E7%BD%AE%E6%A8%A1%E5%BC%8F-2"><span class="nav-text">DistSQL 配置模式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B0%B4%E5%B9%B3%E5%88%86%E8%A1%A8"><span class="nav-text">水平分表</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%93%88%E5%B8%8C%E5%8F%96%E6%A8%A1%E5%88%86%E7%89%87%E7%AE%97%E6%B3%95-1"><span class="nav-text">哈希取模分片算法</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#YAML-%E9%85%8D%E7%BD%AE%E6%A8%A1%E5%BC%8F-3"><span class="nav-text">YAML 配置模式</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#DistSQL-%E9%85%8D%E7%BD%AE%E6%A8%A1%E5%BC%8F-3"><span class="nav-text">DistSQL 配置模式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B0%B4%E5%B9%B3%E5%88%86%E5%BA%93%E4%B8%8E%E6%B0%B4%E5%B9%B3%E5%88%86%E8%A1%A8"><span class="nav-text">水平分库与水平分表</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#YAML-%E9%85%8D%E7%BD%AE%E6%A8%A1%E5%BC%8F-4"><span class="nav-text">YAML 配置模式</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#DistSQL-%E9%85%8D%E7%BD%AE%E6%A8%A1%E5%BC%8F-4"><span class="nav-text">DistSQL 配置模式</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">794</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">56</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/dc701860.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="ShardingSphere-Proxy 入门教程之三 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍 ShardingSphere-Proxy 的入门教程。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> ShardingSphere-Proxy 入门教程之三</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-10-06 23:12:41" itemprop="dateCreated datePublished" datetime="2022-10-06T23:12:41+08:00">2022-10-06</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/dc701860.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/dc701860.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>4.4k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>4 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/f1aa7409.html">ShardingSphere-Proxy 入门教程之一</a>、<a href="/posts/d1af7n03.html">ShardingSphere-Proxy 入门教程之二</a>、<a href="/posts/dc701860.html">ShardingSphere-Proxy 入门教程之三</a></li><li><a href="/posts/90a2747e.html">ShardingSphere-Proxy 入门教程之四</a>、<a href="/posts/8d40163b.html">ShardingSphere-Proxy 入门教程之五</a>、<a href="/posts/8b59de38.html">ShardingSphere-Proxy 入门教程之六</a></li><li><a href="/posts/3ca5f17e.html">ShardingSphere-Proxy 入门教程之七</a></li></ul><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="学习资源"><a href="#学习资源" class="headerlink" title="学习资源"></a>学习资源</h3><ul><li><a target="_blank" rel="external nofollow" href="https://github.com/apache/shardingsphere">ShardingSphere 官方项目（GitHub）</a></li><li><a target="_blank" rel="external nofollow" href="https://shardingsphere.apache.org/index_zh.html">ShardingSphere 官方网站（中文站点）</a></li><li><a target="_blank" rel="external nofollow" href="https://shardingsphere.apache.org/document/current/cn/overview/">ShardingSphere 官方文档（最新版本）</a></li><li><a target="_blank" rel="external nofollow" href="https://shardingsphere.apache.org/document/5.1.1/cn/overview/">ShardingSphere 官方文档（5.1.1 版本）</a></li></ul><span id="more"></span><h2 id="ShardingSphere-Proxy-分布式序列算法"><a href="#ShardingSphere-Proxy-分布式序列算法" class="headerlink" title="ShardingSphere-Proxy 分布式序列算法"></a>ShardingSphere-Proxy 分布式序列算法</h2><p>水平分片（包括水平分库和水平分表）需要关注分布式序列（即分布式全局唯一 ID），因为不能简单的使用基于数据库的自增主键，否则不同库不同表之间会发生主键冲突。通常主键冲突有两种解决方案：一种是使用 MyBatis-Plus 的 ID 生成策略；一种是使用 ShardingSphere-Proxy 的分布式序列配置。</p><h3 id="MyBatis-Plus-的-ID-生成策略"><a href="#MyBatis-Plus-的-ID-生成策略" class="headerlink" title="MyBatis-Plus 的 ID 生成策略"></a>MyBatis-Plus 的 ID 生成策略</h3><div class="admonition note"><p class="admonition-title">参考资料</p><ul><li><a href="/posts/c5f15a9c.html#MyBatis-Plus-%E4%B8%BB%E9%94%AE%E7%94%9F%E6%88%90%E7%AD%96%E7%95%A5">MyBatis-Plus 入门教程 - 主键生成策略</a></li><li><a href="/posts/ed44d201.html">MyBatis-Plus 使用雪花算法生成分布式 ID</a></li></ul></div><ul><li> 使用 MyBatis-Plus 的 ID 生成策略 <code>ASSIGN_ID</code>（默认是基于 Snowflake 算法实现）</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TableName("t_order")</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 不依赖数据库自增主键，插入数据时由 MyBatis-Plus 自动生成主键</span></span><br><span class="line"><span class="comment">     * 默认使用雪花算法（Snowflake）生成 64 位的长整型 ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableId(type = IdType.ASSIGN_ID)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>在 MyBatis-Plus 中，Snowflake 算法生成的 ID 是一个 64 位长整型（<code>| 1 bit 符号位 | 41 bit 时间戳 | 5 bit 数据中心 ID | 5 bit 工作机器 ID | 12 bit 序列号 |</code>），其默认的 Snowflake 参数为：</li></ul><table><thead><tr><th>参数</th><th></th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>dataCenterId</code></td><td></td><td><code>1</code></td><td>数据中心 ID（0 ~ 31）</td></tr><tr><td><code>workerId</code></td><td></td><td><code>1</code></td><td>工作机器 ID（0 ~ 31）</td></tr></tbody></table><ul><li>在 MyBatis-Plus 中，Snowflake 参数的默认值在分布式部署时可能会出现 ID 冲突，因此通常需要自定义 Snowflake 参数（包括 <code>dataCenterId</code> 和 <code>workerId</code>），避免 ID 冲突的发生</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.incrementer.IdentifierGenerator;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.toolkit.Sequence;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.NetworkInterface;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SnowflakeConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义一个 Bean 来覆盖 MyBatis-Plus 默认的 IdentifierGenerator</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IdentifierGenerator <span class="title">identifierGenerator</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IdentifierGenerator() {</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 动态获取 Snowflake 参数</span></span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> Sequence sequence = <span class="keyword">new</span> Sequence(getWorkerId(), getDatacenterId());</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Number <span class="title">nextId</span><span class="params">(Object entity)</span> </span>{</span><br><span class="line">                <span class="keyword">return</span> sequence.nextId();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取工作机器 ID（0~31）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">getWorkerId</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">//  根据 IP 或容器主机名计算工作机器 ID（0 ~ 31）</span></span><br><span class="line">            String hostAddress = InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">            <span class="keyword">return</span> (hostAddress.hashCode() &amp; <span class="number">31</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="comment">// 异常情况返回默认值 0</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取数据中心 ID（0~31）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">getDatacenterId</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            InetAddress inetAddress = InetAddress.getLocalHost();</span><br><span class="line">            NetworkInterface ni = NetworkInterface.getByInetAddress(inetAddress);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ni == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="comment">// 返回默认值 0</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">byte</span>[] mac = ni.getHardwareAddress();</span><br><span class="line">            <span class="keyword">if</span> (mac == <span class="keyword">null</span> || mac.length == <span class="number">0</span>) {</span><br><span class="line">                <span class="comment">// 返回默认值 0</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据 MAC 地址计算数据中心ID（0 ~ 31）</span></span><br><span class="line">            <span class="keyword">return</span> (mac[mac.length - <span class="number">1</span>] &amp; <span class="number">31</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="comment">// 异常情况返回默认值 0</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="ShardingSphere-的分布式序列"><a href="#ShardingSphere-的分布式序列" class="headerlink" title="ShardingSphere 的分布式序列"></a>ShardingSphere 的分布式序列</h3><div class="admonition note"><p class="admonition-title">官方文档</p><ul><li><a target="_blank" rel="external nofollow" href="https://shardingsphere.apache.org/document/5.1.1/cn/features/sharding/concept/key-generator/">官方文档（5.1.1 版本）- 分布式主键</a>，<a href="../../../asset/2025/12/shardingsphere-docs-10.png">附文档截图</a></li><li><a target="_blank" rel="external nofollow" href="https://shardingsphere.apache.org/document/5.1.1/cn/user-manual/shardingsphere-jdbc/builtin-algorithm/keygen/">官方文档（5.1.1 版本）- 分布式序列算法</a>，<a href="../../../asset/2025/12/shardingsphere-docs-9.png">附文档截图</a></li><li><a target="_blank" rel="external nofollow" href="https://shardingsphere.apache.org/document/5.1.1/cn/user-manual/shardingsphere-proxy/distsql/syntax/rdl/rule-definition/sharding/">官方文档（5.1.1 版本）- 数据分片的配置</a>，<a href="../../../asset/2025/12/shardingsphere-docs-16.png">附文档截图</a></li></ul></div><p>ShardingSphere-Proxy 内置了两种分布式序列算法（即分布式 ID 生成算法），包括 <code>SNOWFLAKE</code> 和 <code>UUID</code>，可用于生成分布式全局唯一 ID。</p><h4 id="SNOWFLAKE-算法"><a href="#SNOWFLAKE-算法" class="headerlink" title="SNOWFLAKE 算法"></a>SNOWFLAKE 算法</h4><ul><li>这里以单库分表举例，演示如何配置 ShardingSphere-Proxy 使用 <code>SNOWFLAKE</code> 分布式序列算法（有 DistSQL 和 YAML 两种配置方式，任选一种方式即可）</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-------------------------------------------- DistSQL 配置方式 --------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建逻辑数据库（Schema）</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE sharding_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 切换到逻辑数据库（Schema）</span></span><br><span class="line">USE sharding_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建数据源</span></span><br><span class="line"><span class="keyword">ADD</span> RESOURCE server_order0 (</span><br><span class="line">  URL<span class="operator">=</span>"jdbc:mysql://192.168.2.191:3310/db_order?serverTimezone=UTC&amp;useSSL=false",</span><br><span class="line">  <span class="keyword">USER</span><span class="operator">=</span>root,</span><br><span class="line">  PASSWORD<span class="operator">=</span><span class="number">123456</span>,</span><br><span class="line">  PROPERTIES(</span><br><span class="line">    "connectionTimeoutMilliseconds"<span class="operator">=</span>"30000",</span><br><span class="line">    "idleTimeoutMilliseconds"<span class="operator">=</span>"60000",</span><br><span class="line">    "maxLifetimeMilliseconds"<span class="operator">=</span>"1800000",</span><br><span class="line">    "maxPoolSize"<span class="operator">=</span>"50",</span><br><span class="line">    "minPoolSize"<span class="operator">=</span>"1"</span><br><span class="line">  )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建分片算法</span></span><br><span class="line"><span class="keyword">CREATE</span> SHARDING ALGORITHM alg_inline_order (</span><br><span class="line">  TYPE(NAME<span class="operator">=</span>INLINE, PROPERTIES(</span><br><span class="line">    "algorithm-expression"<span class="operator">=</span>"t_order${order_id % 2}"</span><br><span class="line">  ))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建分布式序列算法</span></span><br><span class="line"><span class="keyword">CREATE</span> SHARDING KEY GENERATOR alg_snowflake (</span><br><span class="line">  TYPE(NAME<span class="operator">=</span>SNOWFLAKE, PROPERTIES(</span><br><span class="line">    "max-vibration-offset"<span class="operator">=</span>"1",</span><br><span class="line">    "max-tolerate-time-difference-milliseconds"<span class="operator">=</span>"10"</span><br><span class="line">  ))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建分片规则</span></span><br><span class="line"><span class="keyword">CREATE</span> SHARDING <span class="keyword">TABLE</span> RULE t_order (</span><br><span class="line">  <span class="comment">-- 数据节点</span></span><br><span class="line">  DATANODES("server_order0.t_order${0..1}"),</span><br><span class="line">  <span class="comment">-- 分表策略</span></span><br><span class="line">  TABLE_STRATEGY (</span><br><span class="line">    TYPE<span class="operator">=</span>STANDARD,</span><br><span class="line">    SHARDING_COLUMN<span class="operator">=</span>order_id,</span><br><span class="line">    SHARDING_ALGORITHM<span class="operator">=</span>alg_inline_order</span><br><span class="line">  ),</span><br><span class="line">  <span class="comment">-- 分布式序列策略</span></span><br><span class="line">  KEY_GENERATE_STRATEGY (</span><br><span class="line">    <span class="keyword">COLUMN</span><span class="operator">=</span>id,</span><br><span class="line">    KEY_GENERATOR<span class="operator">=</span>alg_snowflake</span><br><span class="line">  )</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -------------------------------------------- YAML 配置方式 --------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 逻辑数据库（Schema）的名称</span></span><br><span class="line"><span class="attr">schemaName:</span> <span class="string">sharding_db</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据源</span></span><br><span class="line"><span class="attr">dataSources:</span></span><br><span class="line">  <span class="comment"># 配置第 1 个数据源</span></span><br><span class="line">  <span class="attr">server_order0:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.2.191:3310/db_order?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">maxLifetimeMilliseconds:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">maxPoolSize:</span> <span class="number">50</span></span><br><span class="line">    <span class="attr">minPoolSize:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置分片规则</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="type">!SHARDING</span></span><br><span class="line">  <span class="comment"># 配置分片表规则</span></span><br><span class="line">  <span class="attr">tables:</span></span><br><span class="line">    <span class="attr">t_order:</span></span><br><span class="line">      <span class="comment"># 配置数据节点</span></span><br><span class="line">      <span class="attr">actualDataNodes:</span> <span class="string">server_order0.t_order${0..1}</span></span><br><span class="line">      <span class="comment"># 配置分表策略</span></span><br><span class="line">      <span class="attr">tableStrategy:</span></span><br><span class="line">        <span class="attr">standard:</span></span><br><span class="line">          <span class="attr">shardingColumn:</span> <span class="string">order_id</span></span><br><span class="line">          <span class="attr">shardingAlgorithmName:</span> <span class="string">alg_inline_order</span></span><br><span class="line">      <span class="comment"># 配置分布式序列策略</span></span><br><span class="line">      <span class="attr">keyGenerateStrategy:</span></span><br><span class="line">        <span class="attr">column:</span> <span class="string">id</span></span><br><span class="line">        <span class="attr">keyGeneratorName:</span> <span class="string">alg_snowflake</span></span><br><span class="line">  <span class="comment"># 配置分片算法</span></span><br><span class="line">  <span class="attr">shardingAlgorithms:</span></span><br><span class="line">    <span class="attr">alg_inline_order:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">INLINE</span></span><br><span class="line">      <span class="attr">props:</span></span><br><span class="line">        <span class="attr">algorithm-expression:</span> <span class="string">t_order${order_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">}</span></span><br><span class="line">  <span class="comment"># 配置分布式序列算法</span></span><br><span class="line">  <span class="attr">keyGenerators:</span></span><br><span class="line">    <span class="attr">alg_snowflake:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">SNOWFLAKE</span></span><br><span class="line">      <span class="attr">props:</span></span><br><span class="line">        <span class="attr">max-vibration-offset:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">max-tolerate-time-difference-milliseconds:</span> <span class="number">10</span></span><br></pre></td></tr></tbody></table></figure><ul><li>此时，需要将实体类中的 MyBatis-Plus 的 ID 生成策略修改为 <code>NONE</code>：</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TableName("t_order")</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * MyBatis-Plus 不自动生成 ID &lt;br&gt;</span></span><br><span class="line"><span class="comment">     * 当 ShardingSphere-Proxy 配置了分布式序列策略，会自动注入 ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableId(type = IdType.NONE)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>ShardingSphere-Proxy 的 <code>SNOWFLAKE</code> 分布式序列算法支持配置以下属性：</li></ul><table><thead><tr><th>属性名称</th><th>数据类型</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td><code>max-vibration-offset</code></td><td><code>int</code></td><td>最大抖动上限值，范围是 <code>[0, 4096)</code>。<br> <strong>注意</strong>：若使用此算法生成值作分片值（分片列的值），建议配置此属性。此算法在不同毫秒内所生成的 Key 取模 <code>2^n</code>（这里的 <code>2^n</code> 一般为分库或分表数量）之后结果总为 0 或 1。<br> 该属性的作用是为了让同一毫秒生成的 ID，最终的分片取模结果不总是落在同一个库 / 表上，用于避免分片倾斜（热点分片）问题。<br> 为防止上述分片问题，建议将此属性值配置为 <code>(2^n) - 1</code>。</td><td>1</td></tr><tr><td><code>max-tolerate-time-difference-milliseconds</code></td><td><code>long</code></td><td>最大容忍时钟回退时间，单位：毫秒</td><td> 10</td></tr></tbody></table><ul><li><code>SNOWFLAKE</code> 分布式序列算法中，<code>max-vibration-offset</code> 属性的配置示例：</li></ul><table><thead><tr><th>分库数量</th><th> 2^n</th><th><code>max-vibration-offset</code> 的建议值 <code>(2^n) - 1</code></th></tr></thead><tbody><tr><td>2 库</td><td> 2¹=2</td><td>1</td></tr><tr><td>4 库</td><td> 2²=4</td><td>3</td></tr><tr><td>8 库</td><td> 2³=8</td><td>7</td></tr><tr><td>16 库</td><td> 2⁴=16</td><td>15</td></tr><tr><td>32 库</td><td> 2⁵=32</td><td>31</td></tr></tbody></table><div class="admonition note"><p class="admonition-title">总结</p><p>在 ShardingSphere-Proxy 的 <code>SNOWFLAKE</code> 分布式序列算法中，<code>max-vibration-offset</code> 属性用来给 Snowflake ID 在同一毫秒内增加随机性，避免分片时总落到某几个库 / 表，防止热点库 / 表的出现。</p></div><h4 id="UUID-算法"><a href="#UUID-算法" class="headerlink" title="UUID 算法"></a>UUID 算法</h4><ul><li>这里以单库分表举例，演示如何配置 ShardingSphere-Proxy 使用 <code>UUID</code> 分布式序列算法（有 DistSQL 和 YAML 两种配置方式，任选一种方式即可）</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-------------------------------------------- DistSQL 配置方式 --------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建逻辑数据库（Schema）</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE sharding_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 切换到逻辑数据库（Schema）</span></span><br><span class="line">USE sharding_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建数据源</span></span><br><span class="line"><span class="keyword">ADD</span> RESOURCE server_order0 (</span><br><span class="line">  URL<span class="operator">=</span>"jdbc:mysql://192.168.2.191:3310/db_order?serverTimezone=UTC&amp;useSSL=false",</span><br><span class="line">  <span class="keyword">USER</span><span class="operator">=</span>root,</span><br><span class="line">  PASSWORD<span class="operator">=</span><span class="number">123456</span>,</span><br><span class="line">  PROPERTIES(</span><br><span class="line">    "connectionTimeoutMilliseconds"<span class="operator">=</span>"30000",</span><br><span class="line">    "idleTimeoutMilliseconds"<span class="operator">=</span>"60000",</span><br><span class="line">    "maxLifetimeMilliseconds"<span class="operator">=</span>"1800000",</span><br><span class="line">    "maxPoolSize"<span class="operator">=</span>"50",</span><br><span class="line">    "minPoolSize"<span class="operator">=</span>"1"</span><br><span class="line">  )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建分片算法</span></span><br><span class="line"><span class="keyword">CREATE</span> SHARDING ALGORITHM alg_inline_order (</span><br><span class="line">  TYPE(NAME<span class="operator">=</span>INLINE, PROPERTIES(</span><br><span class="line">    "algorithm-expression"<span class="operator">=</span>"t_order${order_id % 2}"</span><br><span class="line">  ))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建分布式序列算法</span></span><br><span class="line"><span class="keyword">CREATE</span> SHARDING KEY GENERATOR alg_uuid (</span><br><span class="line">  TYPE(NAME<span class="operator">=</span>UUID)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建分片规则</span></span><br><span class="line"><span class="keyword">CREATE</span> SHARDING <span class="keyword">TABLE</span> RULE t_order (</span><br><span class="line">  <span class="comment">-- 数据节点</span></span><br><span class="line">  DATANODES("server_order0.t_order${0..1}"),</span><br><span class="line">  <span class="comment">-- 分表策略</span></span><br><span class="line">  TABLE_STRATEGY (</span><br><span class="line">    TYPE<span class="operator">=</span>STANDARD,</span><br><span class="line">    SHARDING_COLUMN<span class="operator">=</span>order_id,</span><br><span class="line">    SHARDING_ALGORITHM<span class="operator">=</span>alg_inline_order</span><br><span class="line">  ),</span><br><span class="line">  <span class="comment">-- 分布式序列策略</span></span><br><span class="line">  KEY_GENERATE_STRATEGY (</span><br><span class="line">    <span class="keyword">COLUMN</span><span class="operator">=</span>id,</span><br><span class="line">    KEY_GENERATOR<span class="operator">=</span>alg_uuid</span><br><span class="line">  )</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -------------------------------------------- YAML 配置方式 --------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 逻辑数据库（Schema）的名称</span></span><br><span class="line"><span class="attr">schemaName:</span> <span class="string">sharding_db</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据源</span></span><br><span class="line"><span class="attr">dataSources:</span></span><br><span class="line">  <span class="comment"># 配置第 1 个数据源</span></span><br><span class="line">  <span class="attr">server_order0:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.2.191:3310/db_order?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">maxLifetimeMilliseconds:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">maxPoolSize:</span> <span class="number">50</span></span><br><span class="line">    <span class="attr">minPoolSize:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置分片规则</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="type">!SHARDING</span></span><br><span class="line">  <span class="comment"># 配置分片表规则</span></span><br><span class="line">  <span class="attr">tables:</span></span><br><span class="line">    <span class="attr">t_order:</span></span><br><span class="line">      <span class="comment"># 配置数据节点</span></span><br><span class="line">      <span class="attr">actualDataNodes:</span> <span class="string">server_order0.t_order${0..1}</span></span><br><span class="line">      <span class="comment"># 配置分表策略</span></span><br><span class="line">      <span class="attr">tableStrategy:</span></span><br><span class="line">        <span class="attr">standard:</span></span><br><span class="line">          <span class="attr">shardingColumn:</span> <span class="string">order_id</span></span><br><span class="line">          <span class="attr">shardingAlgorithmName:</span> <span class="string">alg_inline_order</span></span><br><span class="line">      <span class="comment"># 配置分布式序列策略</span></span><br><span class="line">      <span class="attr">keyGenerateStrategy:</span></span><br><span class="line">        <span class="attr">column:</span> <span class="string">id</span></span><br><span class="line">        <span class="attr">keyGeneratorName:</span> <span class="string">alg_uuid</span></span><br><span class="line">  <span class="comment"># 配置分片算法</span></span><br><span class="line">  <span class="attr">shardingAlgorithms:</span></span><br><span class="line">    <span class="attr">alg_inline_order:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">INLINE</span></span><br><span class="line">      <span class="attr">props:</span></span><br><span class="line">        <span class="attr">algorithm-expression:</span> <span class="string">t_order${order_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">}</span></span><br><span class="line">  <span class="comment"># 配置分布式序列算法</span></span><br><span class="line">  <span class="attr">keyGenerators:</span></span><br><span class="line">    <span class="attr">alg_uuid:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">UUID</span></span><br></pre></td></tr></tbody></table></figure><ul><li>此时，需要将实体类中的 MyBatis-Plus 的 ID 生成策略修改为 <code>NONE</code>：</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TableName("t_order")</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * MyBatis-Plus 不自动生成 ID &lt;br&gt;</span></span><br><span class="line"><span class="comment">     * 当 ShardingSphere-Proxy 配置了分布式序列策略，会自动注入 ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableId(type = IdType.NONE)</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="ShardingSphere-Proxy-分片算法"><a href="#ShardingSphere-Proxy-分片算法" class="headerlink" title="ShardingSphere-Proxy 分片算法"></a>ShardingSphere-Proxy 分片算法</h2><div class="admonition note"><p class="admonition-title">官方文档</p><ul><li><a target="_blank" rel="external nofollow" href="https://shardingsphere.apache.org/document/5.1.1/cn/user-manual/shardingsphere-jdbc/builtin-algorithm/sharding/">官方文档（5.1.1 版本）- 分片算法介绍</a>，<a href="../../../asset/2025/12/shardingsphere-docs-8.png">附文档截图</a></li><li><a target="_blank" rel="external nofollow" href="https://shardingsphere.apache.org/document/5.1.1/cn/user-manual/shardingsphere-proxy/distsql/syntax/rdl/rule-definition/sharding/">官方文档（5.1.1 版本）- 数据分片配置</a>，<a href="../../../asset/2025/12/shardingsphere-docs-16.png">附文档截图</a></li></ul></div><h3 id="分片算法的类型"><a href="#分片算法的类型" class="headerlink" title="分片算法的类型"></a>分片算法的类型</h3><p>ShardingSphere-Proxy 与 ShardingSphere-JDBC 在底层实现上使用同一套分布式序列算法实现，只是两者在配置与管理能力上并不完全一致，其中内置的分片算法如下所示：</p><ul><li><p>自动分片算法</p><ul><li>取模分片算法（<code>MOD</code>）<ul><li>概述：对分片键取模，决定路由的库 / 表序号。</li><li>特点：算法简单、性能高、均匀分布。</li><li>适用场景：用户 ID、订单 ID 等数值型字段且写请求均匀分布的场景。</li></ul></li><li>哈希取模分片算法（<code>HASH_MOD</code>）<ul><li>概述：对分片键先做哈希，再取模。</li><li>特点：分布更均匀，避免 ID 递增导致热点。</li><li>适用场景：字符串类型分片键（如手机号、Email、UUID）。</li></ul></li><li>基于分片容量的范围分片算法（<code>VOLUME_RANGE</code>）<ul><li>概述：按单分片最大承载容量进行范围分片。</li><li>特点：按数据量增长自动落到不同库 / 表。</li><li>适用场景：数据量随时间增长、按容量控制每个分片大小（如日志类业务）。</li></ul></li><li>基于分片边界的范围分片算法（<code>BOUNDARY_RANGE</code>）<ul><li>概述：在配置中预先定义各分片的边界范围。</li><li>特点：控制精确，可与业务范围区间对应。</li><li>适用场景：省份编码、分等级、金额区间等明确范围的业务。</li></ul></li><li>自动时间段分片算法（<code>AUTO_INTERVAL</code>）<ul><li>概述：按时间自动生成分片，比如每天 / 每月自动建表。</li><li>特点：避免手动扩容，时间分片自动推进。</li><li>适用场景：日志表、订单表、流水表的按时间分表。</li></ul></li></ul></li><li><p>标准分片算法</p><ul><li>行表达式分片算法（<code>INLINE</code>）<ul><li>概述：使用 Groovy 表达式生成路由，如 <code>t_order_$-&gt;{user_id % 4}</code>。</li><li>特点：灵活、配置简单、可自定义表达式。</li><li>适用场景：分片条件规则清晰，可用简单表达式定义的场景。</li></ul></li><li>时间范围分片算法（<code>INTERVAL</code>）<ul><li>概述：通过时间区间计算应该路由到哪个时间分片。</li><li>特点：支持 “时间 → 表名” 的表达式映射。</li><li>适用场景：按年 / 月 / 天的时间序列数据分表（如日志、订单流水）。</li></ul></li></ul></li><li><p>复合分片算法</p><ul><li>复合行表达式分片算法（<code>COMPLEX_INLINE</code>）<ul><li>概述：支持多个分片键，通过表达式组合路由。</li><li>特点：多维条件路由，灵活性高。</li><li>适用场景：订单场景：需按 <code>user_id</code>、<code>order_time</code> 等联合多个键决定路由。</li></ul></li></ul></li><li><p>Hint 分片算法</p><ul><li>Hint 行表达式分片算法（<code>HINT_INLINE</code>）<ul><li>概述：基于 Hint（SQL 注入式强制路由值）的表达式算法。</li><li>特点：程序员通过代码显式指定分片，不依赖 SQL 条件。</li><li>适用场景：<ul><li>SQL 本身没有分片字段（例如跨库 JOIN 时强制路由）</li><li>使用中间件或服务层统一指定分片键</li><li>灰度 / 运营类特殊请求</li></ul></li></ul></li></ul></li></ul><div class="admonition note"><p class="admonition-title">自定义类分片算法</p><p>ShardingSphere-Proxy 除了提供内置的分片算法，还支持开发者自定义类分片算法（<code>CLASS_BASED</code>），可通过配置分片策略类型和算法类名，实现自定义扩展。</p></div><h3 id="分片算法的使用"><a href="#分片算法的使用" class="headerlink" title="分片算法的使用"></a>分片算法的使用</h3><div class="admonition warning"><p class="admonition-title">特别注意</p><p><strong>ShardingSphere-Proxy 内置的分片算法同时适用于垂直分片（垂直分库、垂直分表）和水平分片（水平分库、水平分表）</strong>。由于篇幅限制，下面仅给出部分分片算法的配置示例。无论 ShardingSphere-Proxy 是使用 YAML 配置 还是 DistSQL 配置，都必须注意 ShardingSphere-Proxy 的版本差异。不同版本之间支持的 DistSQL 命令、YAML 配置语法以及参数格式可能存在较大差异，同一份配置在不同版本下可能无法直接执行或行为不一致，因此在编写和迁移配置时必须结合 ShardingSphere-Proxy 具体版本进行验证。</p></div><h4 id="水平分库"><a href="#水平分库" class="headerlink" title="水平分库"></a>水平分库</h4><p>这里以水平分库为例子，演示如何使用 ShardingSphere-Proxy 提供的分片算法进行分库。</p><ul><li><p>分库规则：</p><ul><li><code>t_order</code> 逻辑表中 <code>user_id</code> 为偶数时，数据插入到订单数据库服务器一（<code>server_order0</code>）；<code>user_id</code> 为奇数时，数据插入到订单数据库服务器二（<code>server_order1</code>）。</li><li>这样分库的好处是，同一个用户的订单数据，一定会被插入到同一台数据库服务器上，这样查询某个用户的所有订单时效率较高。</li><li>值得一提的，由于这里每个库只有一张表，所以只需要配置分库策略（<code>DATABASE_STRATEGY</code>），不需要配置分表策略（<code>TABLE_STRATEGY</code>）。</li></ul></li><li><p>数据结构：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server_order0</span><br><span class="line">    └── t_order</span><br><span class="line">server_order1</span><br><span class="line">    └── t_order</span><br></pre></td></tr></tbody></table></figure></li></ul><h5 id="行表达式分片算法"><a href="#行表达式分片算法" class="headerlink" title="行表达式分片算法"></a>行表达式分片算法</h5><h6 id="YAML-配置模式"><a href="#YAML-配置模式" class="headerlink" title="YAML 配置模式"></a>YAML 配置模式</h6><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 逻辑数据库（Schema）的名称</span></span><br><span class="line"><span class="attr">schemaName:</span> <span class="string">sharding_db</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据源</span></span><br><span class="line"><span class="attr">dataSources:</span></span><br><span class="line">  <span class="comment"># 配置第 1 个数据源</span></span><br><span class="line">  <span class="attr">server_order0:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.2.191:3310/db_order?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">maxLifetimeMilliseconds:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">maxPoolSize:</span> <span class="number">50</span></span><br><span class="line">    <span class="attr">minPoolSize:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 配置第 2 个数据源</span></span><br><span class="line">  <span class="attr">server_order1:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.2.191:3310/db_order?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">maxLifetimeMilliseconds:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">maxPoolSize:</span> <span class="number">50</span></span><br><span class="line">    <span class="attr">minPoolSize:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置分片规则</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="type">!SHARDING</span></span><br><span class="line">  <span class="comment"># 配置分片表规则</span></span><br><span class="line">  <span class="attr">tables:</span></span><br><span class="line">    <span class="attr">t_order:</span></span><br><span class="line">      <span class="comment"># 配置数据节点</span></span><br><span class="line">      <span class="attr">actualDataNodes:</span> <span class="string">server_order${0..1}.t_order</span></span><br><span class="line">      <span class="comment"># 配置分库策略</span></span><br><span class="line">      <span class="attr">databaseStrategy:</span></span><br><span class="line">        <span class="attr">standard:</span></span><br><span class="line">          <span class="attr">shardingColumn:</span> <span class="string">user_id</span></span><br><span class="line">          <span class="attr">shardingAlgorithmName:</span> <span class="string">alg_inline_userid</span></span><br><span class="line">  <span class="comment"># 配置分片算法</span></span><br><span class="line">  <span class="attr">shardingAlgorithms:</span></span><br><span class="line">    <span class="attr">alg_inline_userid:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">INLINE</span></span><br><span class="line">      <span class="attr">props:</span></span><br><span class="line">        <span class="attr">algorithm-expression:</span> <span class="string">server_order${user_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">}</span></span><br></pre></td></tr></tbody></table></figure><h6 id="DistSQL-配置模式"><a href="#DistSQL-配置模式" class="headerlink" title="DistSQL 配置模式"></a>DistSQL 配置模式</h6><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建逻辑数据库（Schema）</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE sharding_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 切换到逻辑数据库（Schema）</span></span><br><span class="line">USE sharding_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建第 1 个数据源</span></span><br><span class="line"><span class="keyword">ADD</span> RESOURCE server_order0 (</span><br><span class="line">  URL<span class="operator">=</span>"jdbc:mysql://192.168.2.191:3310/db_order?serverTimezone=UTC&amp;useSSL=false",</span><br><span class="line">  <span class="keyword">USER</span><span class="operator">=</span>root,</span><br><span class="line">  PASSWORD<span class="operator">=</span><span class="number">123456</span>,</span><br><span class="line">  PROPERTIES(</span><br><span class="line">    "connectionTimeoutMilliseconds"<span class="operator">=</span>"30000",</span><br><span class="line">    "idleTimeoutMilliseconds"<span class="operator">=</span>"60000",</span><br><span class="line">    "maxLifetimeMilliseconds"<span class="operator">=</span>"1800000",</span><br><span class="line">    "maxPoolSize"<span class="operator">=</span>"50",</span><br><span class="line">    "minPoolSize"<span class="operator">=</span>"1"</span><br><span class="line">  )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建第 2 个数据源</span></span><br><span class="line"><span class="keyword">ADD</span> RESOURCE server_order1 (</span><br><span class="line">  URL<span class="operator">=</span>"jdbc:mysql://192.168.2.191:3311/db_order?serverTimezone=UTC&amp;useSSL=false",</span><br><span class="line">  <span class="keyword">USER</span><span class="operator">=</span>root,</span><br><span class="line">  PASSWORD<span class="operator">=</span><span class="number">123456</span>,</span><br><span class="line">  PROPERTIES(</span><br><span class="line">    "connectionTimeoutMilliseconds"<span class="operator">=</span>"30000",</span><br><span class="line">    "idleTimeoutMilliseconds"<span class="operator">=</span>"60000",</span><br><span class="line">    "maxLifetimeMilliseconds"<span class="operator">=</span>"1800000",</span><br><span class="line">    "maxPoolSize"<span class="operator">=</span>"50",</span><br><span class="line">    "minPoolSize"<span class="operator">=</span>"1"</span><br><span class="line">  )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建分片算法</span></span><br><span class="line"><span class="keyword">CREATE</span> SHARDING ALGORITHM alg_inline_userid (</span><br><span class="line">  TYPE(NAME<span class="operator">=</span>INLINE, PROPERTIES(</span><br><span class="line">    <span class="string">'algorithm-expression'</span><span class="operator">=</span><span class="string">'server_order${user_id % 2}'</span></span><br><span class="line">  ))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建分片表规则</span></span><br><span class="line"><span class="keyword">CREATE</span> SHARDING <span class="keyword">TABLE</span> RULE t_order (</span><br><span class="line">  <span class="comment">-- 数据节点</span></span><br><span class="line">  DATANODES(<span class="string">'server_order${0..1}.t_order'</span>),</span><br><span class="line">  <span class="comment">-- 分库策略</span></span><br><span class="line">  DATABASE_STRATEGY (</span><br><span class="line">    TYPE<span class="operator">=</span>STANDARD,</span><br><span class="line">    SHARDING_COLUMN<span class="operator">=</span>user_id,</span><br><span class="line">    SHARDING_ALGORITHM<span class="operator">=</span>alg_inline_userid</span><br><span class="line">  )</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure><h5 id="取模分片算法"><a href="#取模分片算法" class="headerlink" title="取模分片算法"></a>取模分片算法</h5><h6 id="YAML-配置模式-1"><a href="#YAML-配置模式-1" class="headerlink" title="YAML 配置模式"></a>YAML 配置模式</h6><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 逻辑数据库（Schema）的名称</span></span><br><span class="line"><span class="attr">schemaName:</span> <span class="string">sharding_db</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据源</span></span><br><span class="line"><span class="attr">dataSources:</span></span><br><span class="line">  <span class="comment"># 配置第 1 个数据源</span></span><br><span class="line">  <span class="attr">server_order0:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.2.191:3310/db_order?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">maxLifetimeMilliseconds:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">maxPoolSize:</span> <span class="number">50</span></span><br><span class="line">    <span class="attr">minPoolSize:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 配置第 2 个数据源</span></span><br><span class="line">  <span class="attr">server_order1:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.2.191:3311/db_order?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">maxLifetimeMilliseconds:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">maxPoolSize:</span> <span class="number">50</span></span><br><span class="line">    <span class="attr">minPoolSize:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置分片规则</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="type">!SHARDING</span></span><br><span class="line">  <span class="comment"># 配置分片表规则</span></span><br><span class="line">  <span class="attr">tables:</span></span><br><span class="line">    <span class="attr">t_order:</span></span><br><span class="line">      <span class="comment"># 配置数据节点</span></span><br><span class="line">      <span class="attr">actualDataNodes:</span> <span class="string">server_order${0..1}.t_order</span></span><br><span class="line">      <span class="comment"># 配置分库策略</span></span><br><span class="line">      <span class="attr">databaseStrategy:</span></span><br><span class="line">        <span class="attr">standard:</span></span><br><span class="line">          <span class="attr">shardingColumn:</span> <span class="string">user_id</span></span><br><span class="line">          <span class="attr">shardingAlgorithmName:</span> <span class="string">alg_mod</span></span><br><span class="line">  <span class="comment"># 配置分片算法</span></span><br><span class="line">  <span class="attr">shardingAlgorithms:</span></span><br><span class="line">    <span class="attr">alg_mod:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">MOD</span></span><br><span class="line">      <span class="attr">props:</span></span><br><span class="line">        <span class="attr">sharding-count:</span> <span class="number">2</span></span><br></pre></td></tr></tbody></table></figure><h6 id="DistSQL-配置模式-1"><a href="#DistSQL-配置模式-1" class="headerlink" title="DistSQL 配置模式"></a>DistSQL 配置模式</h6><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建逻辑数据库（Schema）</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE sharding_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 切换到逻辑数据库（Schema）</span></span><br><span class="line">USE sharding_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建第 1 个数据源</span></span><br><span class="line"><span class="keyword">ADD</span> RESOURCE server_order0 (</span><br><span class="line">  URL<span class="operator">=</span>"jdbc:mysql://192.168.2.191:3310/db_order?serverTimezone=UTC&amp;useSSL=false",</span><br><span class="line">  <span class="keyword">USER</span><span class="operator">=</span>root,</span><br><span class="line">  PASSWORD<span class="operator">=</span><span class="number">123456</span>,</span><br><span class="line">  PROPERTIES(</span><br><span class="line">    "connectionTimeoutMilliseconds"<span class="operator">=</span>"30000",</span><br><span class="line">    "idleTimeoutMilliseconds"<span class="operator">=</span>"60000",</span><br><span class="line">    "maxLifetimeMilliseconds"<span class="operator">=</span>"1800000",</span><br><span class="line">    "maxPoolSize"<span class="operator">=</span>"50",</span><br><span class="line">    "minPoolSize"<span class="operator">=</span>"1"</span><br><span class="line">  )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建第 2 个数据源</span></span><br><span class="line"><span class="keyword">ADD</span> RESOURCE server_order1 (</span><br><span class="line">  URL<span class="operator">=</span>"jdbc:mysql://192.168.2.191:3311/db_order?serverTimezone=UTC&amp;useSSL=false",</span><br><span class="line">  <span class="keyword">USER</span><span class="operator">=</span>root,</span><br><span class="line">  PASSWORD<span class="operator">=</span><span class="number">123456</span>,</span><br><span class="line">  PROPERTIES(</span><br><span class="line">    "connectionTimeoutMilliseconds"<span class="operator">=</span>"30000",</span><br><span class="line">    "idleTimeoutMilliseconds"<span class="operator">=</span>"60000",</span><br><span class="line">    "maxLifetimeMilliseconds"<span class="operator">=</span>"1800000",</span><br><span class="line">    "maxPoolSize"<span class="operator">=</span>"50",</span><br><span class="line">    "minPoolSize"<span class="operator">=</span>"1"</span><br><span class="line">  )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建分片算法</span></span><br><span class="line"><span class="keyword">CREATE</span> SHARDING ALGORITHM alg_mod (</span><br><span class="line">  TYPE(NAME<span class="operator">=</span>MOD,PROPERTIES(</span><br><span class="line">    "sharding-count"<span class="operator">=</span>"2"</span><br><span class="line">  ))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建分片表规则</span></span><br><span class="line"><span class="keyword">CREATE</span> SHARDING <span class="keyword">TABLE</span> RULE t_order (</span><br><span class="line">  <span class="comment">-- 数据节点</span></span><br><span class="line">  DATANODES("server_order${0..1}.t_order"),</span><br><span class="line">  <span class="comment">-- 分库策略</span></span><br><span class="line">  DATABASE_STRATEGY(</span><br><span class="line">    TYPE<span class="operator">=</span>STANDARD,</span><br><span class="line">    SHARDING_COLUMN<span class="operator">=</span>user_id,</span><br><span class="line">    SHARDING_ALGORITHM<span class="operator">=</span>alg_mod</span><br><span class="line">  )</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure><h5 id="哈希取模分片算法"><a href="#哈希取模分片算法" class="headerlink" title="哈希取模分片算法"></a>哈希取模分片算法</h5><h6 id="YAML-配置模式-2"><a href="#YAML-配置模式-2" class="headerlink" title="YAML 配置模式"></a>YAML 配置模式</h6><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 逻辑数据库（Schema）的名称</span></span><br><span class="line"><span class="attr">schemaName:</span> <span class="string">sharding_db</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据源</span></span><br><span class="line"><span class="attr">dataSources:</span></span><br><span class="line">  <span class="comment"># 配置第 1 个数据源</span></span><br><span class="line">  <span class="attr">server_order0:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.2.191:3310/db_order?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">maxLifetimeMilliseconds:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">maxPoolSize:</span> <span class="number">50</span></span><br><span class="line">    <span class="attr">minPoolSize:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 配置第 2 个数据源</span></span><br><span class="line">  <span class="attr">server_order1:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.2.191:3311/db_order?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">maxLifetimeMilliseconds:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">maxPoolSize:</span> <span class="number">50</span></span><br><span class="line">    <span class="attr">minPoolSize:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置分片规则</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="type">!SHARDING</span></span><br><span class="line">  <span class="comment"># 配置分片表规则</span></span><br><span class="line">  <span class="attr">tables:</span></span><br><span class="line">    <span class="attr">t_order:</span></span><br><span class="line">      <span class="comment"># 配置数据节点</span></span><br><span class="line">      <span class="attr">actualDataNodes:</span> <span class="string">server_order${0..1}.t_order</span></span><br><span class="line">      <span class="comment"># 配置分库策略</span></span><br><span class="line">      <span class="attr">databaseStrategy:</span></span><br><span class="line">        <span class="attr">standard:</span></span><br><span class="line">          <span class="attr">shardingColumn:</span> <span class="string">user_id</span></span><br><span class="line">          <span class="attr">shardingAlgorithmName:</span> <span class="string">alg_hash_mod</span></span><br><span class="line">  <span class="comment"># 配置分片算法</span></span><br><span class="line">  <span class="attr">shardingAlgorithms:</span></span><br><span class="line">    <span class="attr">alg_hash_mod:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">HASH_MOD</span></span><br><span class="line">      <span class="attr">props:</span></span><br><span class="line">        <span class="attr">sharding-count:</span> <span class="number">2</span></span><br></pre></td></tr></tbody></table></figure><h6 id="DistSQL-配置模式-2"><a href="#DistSQL-配置模式-2" class="headerlink" title="DistSQL 配置模式"></a>DistSQL 配置模式</h6><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建逻辑数据库（Schema）</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE sharding_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 切换到逻辑数据库（Schema）</span></span><br><span class="line">USE sharding_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建第 1 个数据源</span></span><br><span class="line"><span class="keyword">ADD</span> RESOURCE server_order0 (</span><br><span class="line">  URL<span class="operator">=</span>"jdbc:mysql://192.168.2.191:3310/db_order?serverTimezone=UTC&amp;useSSL=false",</span><br><span class="line">  <span class="keyword">USER</span><span class="operator">=</span>root,</span><br><span class="line">  PASSWORD<span class="operator">=</span><span class="number">123456</span>,</span><br><span class="line">  PROPERTIES(</span><br><span class="line">    "connectionTimeoutMilliseconds"<span class="operator">=</span>"30000",</span><br><span class="line">    "idleTimeoutMilliseconds"<span class="operator">=</span>"60000",</span><br><span class="line">    "maxLifetimeMilliseconds"<span class="operator">=</span>"1800000",</span><br><span class="line">    "maxPoolSize"<span class="operator">=</span>"50",</span><br><span class="line">    "minPoolSize"<span class="operator">=</span>"1"</span><br><span class="line">  )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建第 2 个数据源</span></span><br><span class="line"><span class="keyword">ADD</span> RESOURCE server_order1 (</span><br><span class="line">  URL<span class="operator">=</span>"jdbc:mysql://192.168.2.191:3311/db_order?serverTimezone=UTC&amp;useSSL=false",</span><br><span class="line">  <span class="keyword">USER</span><span class="operator">=</span>root,</span><br><span class="line">  PASSWORD<span class="operator">=</span><span class="number">123456</span>,</span><br><span class="line">  PROPERTIES(</span><br><span class="line">    "connectionTimeoutMilliseconds"<span class="operator">=</span>"30000",</span><br><span class="line">    "idleTimeoutMilliseconds"<span class="operator">=</span>"60000",</span><br><span class="line">    "maxLifetimeMilliseconds"<span class="operator">=</span>"1800000",</span><br><span class="line">    "maxPoolSize"<span class="operator">=</span>"50",</span><br><span class="line">    "minPoolSize"<span class="operator">=</span>"1"</span><br><span class="line">  )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建分片算法</span></span><br><span class="line"><span class="keyword">CREATE</span> SHARDING ALGORITHM alg_hash_mod (</span><br><span class="line">  TYPE(NAME<span class="operator">=</span>HASH_MOD,PROPERTIES(</span><br><span class="line">    "sharding-count"<span class="operator">=</span>"2"</span><br><span class="line">  ))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建分片表规则</span></span><br><span class="line"><span class="keyword">CREATE</span> SHARDING <span class="keyword">TABLE</span> RULE t_order (</span><br><span class="line">  <span class="comment">-- 数据节点</span></span><br><span class="line">  DATANODES("server_order${0..1}.t_order"),</span><br><span class="line">  <span class="comment">-- 分库策略</span></span><br><span class="line">  DATABASE_STRATEGY(</span><br><span class="line">    TYPE<span class="operator">=</span>STANDARD,</span><br><span class="line">    SHARDING_COLUMN<span class="operator">=</span>user_id,</span><br><span class="line">    SHARDING_ALGORITHM<span class="operator">=</span>alg_hash_mod</span><br><span class="line">  )</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure><h4 id="水平分表"><a href="#水平分表" class="headerlink" title="水平分表"></a>水平分表</h4><p>这里以水平分表为例子，演示如何使用 ShardingSphere-Proxy 提供的分片算法进行分表。由于篇幅有限，这里仅介绍哈希取模分片算法的使用，其他分片算法可以参考上面 <a href="/posts/90a2747e.html#%E6%B0%B4%E5%B9%B3%E5%88%86%E5%BA%93">水平分库</a> 的使用。</p><ul><li><p>分表规则：</p><ul><li><code>t_order</code> 逻辑表中 <code>order_no</code> 的哈希值为偶数时，数据插入对应数据库服务器的 <code>t_order0</code> 表；<code>order_no</code> 的哈希值为奇数时，数据插入对应数据库服务器的 <code>t_order1</code> 表。</li><li>值得一提的是，由于这里只有一个数据库（即单库分表），所以只需要配置分表策略（<code>TABLE_STRATEGY</code>），不需要配置分库策略（<code>DATABASE_STRATEGY</code>）。</li><li>因为 <code>order_no</code> 是字符串类型，所以不能直接取模，需要对其进行哈希计算再取模。</li></ul></li><li><p>数据结构：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server_order0</span><br><span class="line">    ├── t_order0</span><br><span class="line">    └── t_order1</span><br></pre></td></tr></tbody></table></figure></li></ul><h5 id="哈希取模分片算法-1"><a href="#哈希取模分片算法-1" class="headerlink" title="哈希取模分片算法"></a>哈希取模分片算法</h5><h6 id="YAML-配置模式-3"><a href="#YAML-配置模式-3" class="headerlink" title="YAML 配置模式"></a>YAML 配置模式</h6><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 逻辑数据库（Schema）的名称</span></span><br><span class="line"><span class="attr">schemaName:</span> <span class="string">sharding_db</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据源</span></span><br><span class="line"><span class="attr">dataSources:</span></span><br><span class="line">  <span class="comment"># 配置第 1 个数据源</span></span><br><span class="line">  <span class="attr">server_order0:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.2.191:3310/db_order?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">maxLifetimeMilliseconds:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">maxPoolSize:</span> <span class="number">50</span></span><br><span class="line">    <span class="attr">minPoolSize:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置分片规则</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="type">!SHARDING</span></span><br><span class="line">  <span class="comment"># 配置分片表规则</span></span><br><span class="line">  <span class="attr">tables:</span></span><br><span class="line">    <span class="attr">t_order:</span></span><br><span class="line">      <span class="comment"># 配置数据节点</span></span><br><span class="line">      <span class="attr">actualDataNodes:</span> <span class="string">server_order0.t_order${0..1}</span></span><br><span class="line">      <span class="comment"># 配置分表策略</span></span><br><span class="line">      <span class="attr">tableStrategy:</span></span><br><span class="line">        <span class="attr">standard:</span></span><br><span class="line">          <span class="attr">shardingColumn:</span> <span class="string">order_no</span></span><br><span class="line">          <span class="attr">shardingAlgorithmName:</span> <span class="string">alg_hash_mod</span></span><br><span class="line">  <span class="comment"># 配置分片算法</span></span><br><span class="line">  <span class="attr">shardingAlgorithms:</span></span><br><span class="line">    <span class="attr">alg_hash_mod:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">HASH_MOD</span></span><br><span class="line">      <span class="attr">props:</span></span><br><span class="line">        <span class="attr">sharding-count:</span> <span class="number">2</span></span><br></pre></td></tr></tbody></table></figure><h6 id="DistSQL-配置模式-3"><a href="#DistSQL-配置模式-3" class="headerlink" title="DistSQL 配置模式"></a>DistSQL 配置模式</h6><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建逻辑数据库（Schema）</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE sharding_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 切换到逻辑数据库（Schema）</span></span><br><span class="line">USE sharding_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建第 1 个数据源</span></span><br><span class="line"><span class="keyword">ADD</span> RESOURCE server_order0 (</span><br><span class="line">  URL<span class="operator">=</span>"jdbc:mysql://192.168.2.191:3310/db_order?serverTimezone=UTC&amp;useSSL=false",</span><br><span class="line">  <span class="keyword">USER</span><span class="operator">=</span>root,</span><br><span class="line">  PASSWORD<span class="operator">=</span><span class="number">123456</span>,</span><br><span class="line">  PROPERTIES(</span><br><span class="line">    "connectionTimeoutMilliseconds"<span class="operator">=</span>"30000",</span><br><span class="line">    "idleTimeoutMilliseconds"<span class="operator">=</span>"60000",</span><br><span class="line">    "maxLifetimeMilliseconds"<span class="operator">=</span>"1800000",</span><br><span class="line">    "maxPoolSize"<span class="operator">=</span>"50",</span><br><span class="line">    "minPoolSize"<span class="operator">=</span>"1"</span><br><span class="line">  )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建分片算法</span></span><br><span class="line"><span class="keyword">CREATE</span> SHARDING ALGORITHM alg_hash_mod (</span><br><span class="line">  TYPE(NAME<span class="operator">=</span>HASH_MOD,PROPERTIES(</span><br><span class="line">    "sharding-count"<span class="operator">=</span>"2"</span><br><span class="line">  ))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建分片表规则</span></span><br><span class="line"><span class="keyword">CREATE</span> SHARDING <span class="keyword">TABLE</span> RULE t_order (</span><br><span class="line">  DATANODES("server_order0.t_order${0..1}"),</span><br><span class="line">  TABLE_STRATEGY(</span><br><span class="line">    TYPE<span class="operator">=</span>"STANDARD",</span><br><span class="line">    SHARDING_COLUMN<span class="operator">=</span>"order_no",</span><br><span class="line">    SHARDING_ALGORITHM<span class="operator">=</span>"alg_hash_mod"</span><br><span class="line">  )</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure><h4 id="水平分库与水平分表"><a href="#水平分库与水平分表" class="headerlink" title="水平分库与水平分表"></a>水平分库与水平分表</h4><p>这里以水平分库 + 水平分表为例子，演示如何使用 ShardingSphere-Proxy 提供的分片算法。</p><ul><li><p>分库规则：</p><ul><li><code>t_order</code> 逻辑表中 <code>user_id</code> 为偶数时，数据插入到订单数据库服务器一（<code>server_order0</code>）；<code>user_id</code> 为奇数时，数据插入到订单数据库服务器二（<code>server_order1</code>）。</li><li>这样分库的好处是，同一个用户的订单数据，一定会被插入到同一台数据库服务器上，这样查询某个用户的所有订单时效率较高。</li></ul></li><li><p>分表规则：</p><ul><li><code>t_order</code> 逻辑表中 <code>order_no</code> 的哈希值为偶数时，数据插入对应数据库服务器的 <code>t_order0</code> 表；<code>order_no</code> 的哈希值为奇数时，数据插入对应数据库服务器的 <code>t_order1</code> 表。</li><li>因为 <code>order_no</code> 是字符串类型，所以不能直接取模，需要对其进行哈希计算再取模。</li></ul></li><li><p>数据结构：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server_order0</span><br><span class="line">    ├── t_order0</span><br><span class="line">    └── t_order1</span><br><span class="line">server_order1</span><br><span class="line">    ├── t_order0</span><br><span class="line">    └── t_order1</span><br></pre></td></tr></tbody></table></figure></li></ul><h6 id="YAML-配置模式-4"><a href="#YAML-配置模式-4" class="headerlink" title="YAML 配置模式"></a>YAML 配置模式</h6><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 逻辑数据库（Schema）的名称</span></span><br><span class="line"><span class="attr">schemaName:</span> <span class="string">sharding_db</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据源</span></span><br><span class="line"><span class="attr">dataSources:</span></span><br><span class="line">  <span class="comment"># 配置第 1 个数据源</span></span><br><span class="line">  <span class="attr">server_order0:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.2.191:3310/db_order?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">maxLifetimeMilliseconds:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">maxPoolSize:</span> <span class="number">50</span></span><br><span class="line">    <span class="attr">minPoolSize:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 配置第 2 个数据源</span></span><br><span class="line">  <span class="attr">server_order1:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.2.191:3311/db_order?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">maxLifetimeMilliseconds:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">maxPoolSize:</span> <span class="number">50</span></span><br><span class="line">    <span class="attr">minPoolSize:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置分片规则</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="type">!SHARDING</span></span><br><span class="line">  <span class="comment"># 配置分片表规则</span></span><br><span class="line">  <span class="attr">tables:</span></span><br><span class="line">    <span class="attr">t_order:</span></span><br><span class="line">      <span class="comment"># 配置数据节点</span></span><br><span class="line">      <span class="attr">actualDataNodes:</span> <span class="string">server_order${0..1}.t_order${0..1}</span></span><br><span class="line">      <span class="comment"># 配置分库策略</span></span><br><span class="line">      <span class="attr">databaseStrategy:</span></span><br><span class="line">        <span class="attr">standard:</span></span><br><span class="line">          <span class="attr">shardingColumn:</span> <span class="string">user_id</span></span><br><span class="line">          <span class="attr">shardingAlgorithmName:</span> <span class="string">alg_mod</span></span><br><span class="line">      <span class="comment"># 配置分表策略</span></span><br><span class="line">      <span class="attr">tableStrategy:</span></span><br><span class="line">        <span class="attr">standard:</span></span><br><span class="line">          <span class="attr">shardingColumn:</span> <span class="string">order_no</span></span><br><span class="line">          <span class="attr">shardingAlgorithmName:</span> <span class="string">alg_hash_mod</span></span><br><span class="line">  <span class="comment"># 配置分片算法</span></span><br><span class="line">  <span class="attr">shardingAlgorithms:</span></span><br><span class="line">    <span class="attr">alg_mod:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">MOD</span></span><br><span class="line">      <span class="attr">props:</span></span><br><span class="line">        <span class="attr">sharding-count:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">alg_hash_mod:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">HASH_MOD</span></span><br><span class="line">      <span class="attr">props:</span></span><br><span class="line">        <span class="attr">sharding-count:</span> <span class="number">2</span></span><br></pre></td></tr></tbody></table></figure><h6 id="DistSQL-配置模式-4"><a href="#DistSQL-配置模式-4" class="headerlink" title="DistSQL 配置模式"></a>DistSQL 配置模式</h6><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建逻辑数据库（Schema）</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE sharding_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 切换到逻辑数据库（Schema）</span></span><br><span class="line">USE sharding_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建第 1 个数据源</span></span><br><span class="line"><span class="keyword">ADD</span> RESOURCE server_order0 (</span><br><span class="line">  URL<span class="operator">=</span>"jdbc:mysql://192.168.2.191:3310/db_order?serverTimezone=UTC&amp;useSSL=false",</span><br><span class="line">  <span class="keyword">USER</span><span class="operator">=</span>root,</span><br><span class="line">  PASSWORD<span class="operator">=</span><span class="number">123456</span>,</span><br><span class="line">  PROPERTIES(</span><br><span class="line">    "connectionTimeoutMilliseconds"<span class="operator">=</span>"30000",</span><br><span class="line">    "idleTimeoutMilliseconds"<span class="operator">=</span>"60000",</span><br><span class="line">    "maxLifetimeMilliseconds"<span class="operator">=</span>"1800000",</span><br><span class="line">    "maxPoolSize"<span class="operator">=</span>"50",</span><br><span class="line">    "minPoolSize"<span class="operator">=</span>"1"</span><br><span class="line">  )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建第 2 个数据源</span></span><br><span class="line"><span class="keyword">ADD</span> RESOURCE server_order1 (</span><br><span class="line">  URL<span class="operator">=</span>"jdbc:mysql://192.168.2.191:3311/db_order?serverTimezone=UTC&amp;useSSL=false",</span><br><span class="line">  <span class="keyword">USER</span><span class="operator">=</span>root,</span><br><span class="line">  PASSWORD<span class="operator">=</span><span class="number">123456</span>,</span><br><span class="line">  PROPERTIES(</span><br><span class="line">    "connectionTimeoutMilliseconds"<span class="operator">=</span>"30000",</span><br><span class="line">    "idleTimeoutMilliseconds"<span class="operator">=</span>"60000",</span><br><span class="line">    "maxLifetimeMilliseconds"<span class="operator">=</span>"1800000",</span><br><span class="line">    "maxPoolSize"<span class="operator">=</span>"50",</span><br><span class="line">    "minPoolSize"<span class="operator">=</span>"1"</span><br><span class="line">  )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建分片算法</span></span><br><span class="line"><span class="keyword">CREATE</span> SHARDING ALGORITHM alg_mod (</span><br><span class="line">  TYPE(NAME<span class="operator">=</span>MOD,PROPERTIES(</span><br><span class="line">      "sharding-count"<span class="operator">=</span>"2"</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建分片算法</span></span><br><span class="line"><span class="keyword">CREATE</span> SHARDING ALGORITHM alg_hash_mod (</span><br><span class="line">  TYPE(NAME<span class="operator">=</span>HASH_MOD,PROPERTIES(</span><br><span class="line">      "sharding-count"<span class="operator">=</span>"2"</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建分片规则</span></span><br><span class="line"><span class="keyword">CREATE</span> SHARDING <span class="keyword">TABLE</span> RULE t_order (</span><br><span class="line">  <span class="comment">-- 数据节点</span></span><br><span class="line">  DATANODES("server_order${0..1}.t_order${0..1}"),</span><br><span class="line">  <span class="comment">-- 分库策略</span></span><br><span class="line">  DATABASE_STRATEGY(</span><br><span class="line">    TYPE<span class="operator">=</span>STANDARD,</span><br><span class="line">    SHARDING_COLUMN<span class="operator">=</span>user_id,</span><br><span class="line">    SHARDING_ALGORITHM<span class="operator">=</span>alg_mod</span><br><span class="line">  ),</span><br><span class="line">  <span class="comment">-- 分表策略</span></span><br><span class="line">  TABLE_STRATEGY(</span><br><span class="line">    TYPE<span class="operator">=</span>STANDARD,</span><br><span class="line">    SHARDING_COLUMN<span class="operator">=</span>order_no,</span><br><span class="line">    SHARDING_ALGORITHM<span class="operator">=</span>alg_hash_mod</span><br><span class="line">  )</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/dc701860.html" title="ShardingSphere-Proxy 入门教程之三">https://www.techgrow.cn/posts/dc701860.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag"><i class="fa fa-tag"></i> 分布式</a><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="fa fa-tag"></i> 微服务</a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag"><i class="fa fa-tag"></i> 数据库</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/bc19d204.html" rel="prev" title="VuePress 渲染 Mermaid 绘图"><i class="fa fa-angle-left"></i> VuePress 渲染 Mermaid 绘图</a></div><div class="post-nav-item"> <a href="/posts/a2880619.html" rel="next" title="Kafka 源码阅读环境搭建">Kafka 源码阅读环境搭建<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2026</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">2.3m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">35:24</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/dc701860.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div><div id="moon-menu-item-code" class="moon-menu-item"><i class="fa-solid fa-code"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>