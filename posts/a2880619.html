<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍 Kafka 源码阅读环境的搭建，包括 OpenJDK、Scala、Gradle 的安装。"><meta property="og:type" content="article"><meta property="og:title" content="Kafka 源码阅读环境搭建"><meta property="og:url" content="https://www.techgrow.cn/posts/a2880619.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍 Kafka 源码阅读环境的搭建，包括 OpenJDK、Scala、Gradle 的安装。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/12/kafka-source-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/12/kafka-source-7.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/12/kafka-source-9.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/12/kafka-source-6.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/12/kafka-source-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/12/kafka-source-10.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/12/kafka-source-4.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/12/kafka-source-5.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/12/kafka-source-8.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/12/kafka-source-11.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/12/kafka-source-12.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/12/kafka-source-13.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/12/kafka-source-14.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/12/kafka-source-15.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/12/kafka-source-12.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/12/kafka-source-7.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/12/kafka-source-12.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/12/kafka-source-16.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/12/kafka-source-17.png"><meta property="article:published_time" content="2022-10-07T14:13:45.000Z"><meta property="article:modified_time" content="2022-10-07T14:13:45.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="Linux运维"><meta property="article:tag" content="消息队列"><meta property="article:tag" content="大数据"><meta property="article:tag" content="源码剖析"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2024/12/kafka-source-2.png"><link rel="canonical" href="https://www.techgrow.cn/posts/a2880619.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/a2880619.html","path":"posts/a2880619.html","title":"Kafka 源码阅读环境搭建"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Kafka 源码阅读环境搭建 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%BA%90"><span class="nav-text">学习资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="nav-text">版本说明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E6%BA%90%E7%A0%81"><span class="nav-text">下载源码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0%E5%AE%89%E8%A3%85-JDK"><span class="nav-text">本地安装 JDK</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0%E5%AE%89%E8%A3%85-Scala"><span class="nav-text">本地安装 Scala</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0%E5%AE%89%E8%A3%85-Gradle"><span class="nav-text">本地安装 Gradle</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IDE-%E5%B7%A5%E5%85%B7%E5%AF%BC%E5%85%A5%E6%BA%90%E7%A0%81"><span class="nav-text">IDE 工具导入源码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#IDE-%E5%AF%BC%E5%85%A5%E6%BA%90%E7%A0%81"><span class="nav-text">IDE 导入源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E9%98%BF%E9%87%8C%E9%95%9C%E5%83%8F"><span class="nav-text">添加阿里镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E6%94%B9%E4%BE%9D%E8%B5%96%E7%9A%84%E7%89%88%E6%9C%AC"><span class="nav-text">更改依赖的版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%9C%AC%E5%9C%B0%E7%9A%84-JDK"><span class="nav-text">使用本地的 JDK</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%9C%AC%E5%9C%B0%E7%9A%84-Scala"><span class="nav-text">使用本地的 Scala</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%9C%AC%E5%9C%B0%E7%9A%84-Gradle"><span class="nav-text">使用本地的 Gradle</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IDE-%E9%87%8D%E6%96%B0%E6%9E%84%E5%BB%BA%E6%BA%90%E7%A0%81"><span class="nav-text">IDE 重新构建源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%BC%96%E8%AF%91%E6%BA%90%E7%A0%81"><span class="nav-text">命令行编译源码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IDE-%E5%B7%A5%E5%85%B7%E5%90%AF%E5%8A%A8%E6%BA%90%E7%A0%81"><span class="nav-text">IDE 工具启动源码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-text">准备工作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%BA%90%E7%A0%81"><span class="nav-text">启动源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E6%BA%90%E7%A0%81"><span class="nav-text">测试源码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E8%A7%A3%E5%86%B3"><span class="nav-text">常见错误解决</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Kafka-%E6%BA%90%E7%A0%81%E5%90%AF%E5%8A%A8%E5%A4%B1%E8%B4%A5"><span class="nav-text">Kafka 源码启动失败</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%BE%E4%B8%8D%E5%88%B0-grgit-core-%E4%BE%9D%E8%B5%96"><span class="nav-text">找不到 grgit-core 依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E5%A4%B1%E8%B4%A5%E6%B2%A1%E6%9C%89%E8%BE%93%E5%87%BA%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97"><span class="nav-text">启动失败没有输出错误日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4-ID-%E4%B8%8D%E5%8C%B9%E9%85%8D%E5%AF%BC%E8%87%B4%E5%90%AF%E5%8A%A8%E5%A4%B1%E8%B4%A5"><span class="nav-text">集群 ID 不匹配导致启动失败</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">712</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">53</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/a2880619.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Kafka 源码阅读环境搭建 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍 Kafka 源码阅读环境的搭建，包括 OpenJDK、Scala、Gradle 的安装。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Kafka 源码阅读环境搭建</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-10-07 22:13:45" itemprop="dateCreated datePublished" datetime="2022-10-07T22:13:45+08:00">2022-10-07</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/a2880619.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/a2880619.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>4.8k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>4 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>验证 Kafka 源码阅读成果的两个标志：第一个是能够自行调试源码，第二个是能够在源码上独立开发高阶功能。</p><h3 id="学习资源"><a href="#学习资源" class="headerlink" title="学习资源"></a>学习资源</h3><ul><li><a target="_blank" rel="external nofollow" href="https://kafka.apache.org/documentation/">Kafka 官方文档</a></li><li><a href="/posts/ac64f898.html">Kafka 学习路线</a></li></ul><span id="more"></span><h3 id="版本说明"><a href="#版本说明" class="headerlink" title="版本说明"></a>版本说明</h3><table><thead><tr><th>软件</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td> OpenJDK</td><td><code>1.8</code></td><td></td></tr><tr><td>Gradle</td><td><code>7.1.1</code></td><td></td></tr><tr><td>Scala</td><td><code>2.13.6</code></td><td></td></tr><tr><td>Kafka</td><td><code>3.0.0</code></td><td></td></tr></tbody></table><div class="admonition warning"><p class="admonition-title">特别注意</p><p>上述各软件的版本必须互相匹配，比如当 Kafka 的版本升级为 <code>3.8.0</code>，那么 Scala、Gradle、OpenJDK 的版本可能也要跟着升级，具体的版本要求请查阅 <a target="_blank" rel="external nofollow" href="https://kafka.apache.org/downloads">Kafka 的下载说明</a>。</p></div><h2 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h2><ul><li>在 <a target="_blank" rel="external nofollow" href="http://kafka.apache.org/downloads">Kafka 官网</a> 下载 Kafka 源码的压缩包，并解压</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载源码</span></span><br><span class="line">$ wget https://archive.apache.org/dist/kafka/3.0.0/kafka-3.0.0-src.tgz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压源码</span></span><br><span class="line">$ tar -xvf kafka-3.0.0-src.tgz</span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">提示</p><ul><li>若希望学习 Kafka 最新版本的代码，可以通过 Git 将 Kafka 的 <a target="_blank" rel="external nofollow" href="https://github.com/apache/kafka">GitHub 仓库</a> 的 <code>trunk</code> 分支拉取下来，这里的 <code>trunk</code> 分支是 Kafka 的主干分支。</li><li>特别注意，如果学习的是 Kafka 最新版本的代码，那么 Scala、Gradle、OpenJDK 的版本可能要升级，具体的版本要求请查阅 <a target="_blank" rel="external nofollow" href="https://kafka.apache.org/downloads">Kafka 的下载说明</a>。</li></ul></div><h2 id="本地安装-JDK"><a href="#本地安装-JDK" class="headerlink" title="本地安装 JDK"></a>本地安装 JDK</h2><div class="admonition note"><p class="admonition-title">提示</p><ul><li>Kafka 源码的编译需要依赖 JDK 8 或更高版本（比如 JDK 11）。</li><li>值得一提的是，Kafka 的 Broker 是基于 Scala 开发的，而 Producer 和 Consumer 是基于 Java 开发的。</li><li><strong>特别注意，JDK 的版本和 Kafka 源码的版本必须相匹配（<a href="../../../asset/2024/12/kafka-source-1.png">如图所示</a>），否则可能会导致无法正常编译 Kafka 源码。</strong></li></ul></div><ul><li>在 <a target="_blank" rel="external nofollow" href="https://jdk.java.net/archive/">OpenJDK 官网</a> 下载 OpenJDK 的压缩包，并解压文件</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载文件</span></span><br><span class="line">$ wget https://download.java.net/openjdk/jdk8u44/ri/openjdk-8u44-linux-x64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建解压目录</span></span><br><span class="line">$ sudo mkdir -p /usr/lib/jvm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压文件</span></span><br><span class="line">$ sudo tar -xvf openjdk-8u44-linux-x64.tar.gz -C /usr/lib/jvm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重命名文件</span></span><br><span class="line">$ sudo mv /usr/lib/jvm/java-se-8u44-ri /usr/lib/jvm/openjdk-8u44</span><br></pre></td></tr></tbody></table></figure><ul><li>添加系统环境变量</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑配置文件，添加环境变量</span></span><br><span class="line">$ vi ~/.bashrc</span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/lib/jvm/openjdk-8u44</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使环境变量生效</span></span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></tbody></table></figure><ul><li>验证安装</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 JDK 的版本号</span></span><br><span class="line">$ java -version</span><br></pre></td></tr></tbody></table></figure><h2 id="本地安装-Scala"><a href="#本地安装-Scala" class="headerlink" title="本地安装 Scala"></a>本地安装 Scala</h2><div class="admonition note"><p class="admonition-title">提示</p><ul><li>Kafka 源码的编译需要依赖 Scala。</li><li>值得一提的是，Kafka 的 Broker 是基于 Scala 开发的，而 Producer 和 Consumer 是基于 Java 开发的。</li><li><strong>特别注意，Scala 的版本和 Kafka 源码的版本必须相匹配（<a href="../../../asset/2024/12/kafka-source-1.png">如图所示</a>），否则可能会导致无法正常编译 Kafka 源码。</strong></li></ul></div><ul><li>在 <a target="_blank" rel="external nofollow" href="https://www.scala-lang.org/download/">Scala 官网</a> 下载 Scala 的压缩包，并解压文件</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载文件</span></span><br><span class="line">$ wget https://downloads.lightbend.com/scala/2.13.6/scala-2.13.6.tgz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压文件</span></span><br><span class="line">$ tar -xvf scala-2.13.6.tgz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 移动文件</span></span><br><span class="line">$ sudo mv scala-2.13.6 /usr/<span class="built_in">local</span></span><br></pre></td></tr></tbody></table></figure><ul><li>添加系统环境变量</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑配置文件，添加环境变量</span></span><br><span class="line">$ vi ~/.bashrc</span><br><span class="line"><span class="built_in">export</span> SCALA_HOME=/usr/<span class="built_in">local</span>/scala-2.13.6</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$SCALA_HOME</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使环境变量生效</span></span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></tbody></table></figure><ul><li>验证安装</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 Scala 的版本号</span></span><br><span class="line">$ scala -version</span><br></pre></td></tr></tbody></table></figure><h2 id="本地安装-Gradle"><a href="#本地安装-Gradle" class="headerlink" title="本地安装 Gradle"></a>本地安装 Gradle</h2><div class="admonition note"><p class="admonition-title">提示</p><ul><li>Kafka 使用 Gradle 作为构建工具，如果想避免在本地安装 Gradle，可以直接使用 Gradle Wrapper（Kafka 源码目录下的 <code>gradlew</code> 脚本）。</li><li>在 Kafka 的源码目录下，打开 <code>gradle/wrapper/gradle-wrapper.properties</code> 配置文件，就可以知道当前的 Kafka 源码依赖哪个版本的 Gradle。</li><li><strong>特别注意，Gradle 的版本和 JDK 的版本必须相匹配，否则可能会导致无法正常编译 Kafka 源码。</strong></li></ul></div><ul><li>在 <a target="_blank" rel="external nofollow" href="https://gradle.org/releases/">Gradle 官网</a> 下载 Gradle 的压缩包，并解压文件</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载文件</span></span><br><span class="line">$ wget https://services.gradle.org/distributions/gradle-7.1.1-bin.zip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建解压目录</span></span><br><span class="line">$ sudo mkdir /usr/<span class="built_in">local</span>/gradle</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压文件</span></span><br><span class="line">$ sudo unzip -d /usr/<span class="built_in">local</span>/gradle gradle-7.1.1-bin.zip</span><br></pre></td></tr></tbody></table></figure><ul><li>添加系统环境变量</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑配置文件，添加环境变量</span></span><br><span class="line">$ vi ~/.bashrc</span><br><span class="line"><span class="built_in">export</span> GRADLE_HOME=/usr/<span class="built_in">local</span>/gradle/gradle-7.1.1</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$GRADLE_HOME</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使环境变量生效</span></span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></tbody></table></figure><ul><li>验证安装</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 Gradle 的版本号</span></span><br><span class="line">$ gradle -version</span><br></pre></td></tr></tbody></table></figure><h2 id="IDE-工具导入源码"><a href="#IDE-工具导入源码" class="headerlink" title="IDE 工具导入源码"></a>IDE 工具导入源码</h2><p>为了 Kafka 开发和调试方便，这里使用 IntelliJ IDEA + Scala Plugin 作为 Scala 的 IDE 工具。</p><h3 id="IDE-导入源码"><a href="#IDE-导入源码" class="headerlink" title="IDE 导入源码"></a>IDE 导入源码</h3><p>Scala 没有专门的 IDE 开发工具，可以使用以下任意一种 IDE 工具组合导入 Kafka 的源码目录。</p><ul><li><a target="_blank" rel="external nofollow" href="https://www.jetbrains.com/pages/scala/">IntelliJ IDEA</a> + <a target="_blank" rel="external nofollow" href="https://plugins.jetbrains.com/plugin/1347-scala/">Scala Plugin</a></li><li><a target="_blank" rel="external nofollow" href="https://code.visualstudio.com/">Visual Studio Code</a> + <a target="_blank" rel="external nofollow" href="https://scalameta.org/metals/">Metals</a></li></ul><p>若使用 IntelliJ IDEA + Scala Plugin 作为 IDE 工具，那么在导入 Kafka 源码时，直接选中 Kafka 源码目录下的 <code>build.gradle</code> 文件即可。</p><h3 id="添加阿里镜像"><a href="#添加阿里镜像" class="headerlink" title="添加阿里镜像"></a>添加阿里镜像</h3><p>在 IntelliJ IDEA 导入 Kafka 源码后，由于 Gradle 支持使用 Maven 依赖，为了加快 Gradle 拉取依赖的速度，建议编辑 Kafka 源码目录中的 <code>build.gradle</code> 配置文件，然后添加阿里云的 Maven 镜像地址 <code>https://maven.aliyun.com/nexus/content/groups/public/</code>，如下图所示：</p><figure class="highlight gradle"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">repositories</span> {</span><br><span class="line">  maven { url <span class="string">'https://maven.aliyun.com/nexus/content/groups/public/'</span> }</span><br><span class="line">  mavenCentral()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img data-src="../../../asset/2024/12/kafka-source-2.png"></p><h3 id="更改依赖的版本"><a href="#更改依赖的版本" class="headerlink" title="更改依赖的版本"></a>更改依赖的版本</h3><p>在 Kafka <code>3.0.0</code> 版本的源码中，依赖了 <code>4.1.0</code> 版本的 <code>grgit-core</code>。但是，在 Maven 中央仓库中只有 <code>4.1.1</code> 版本的 <code>grgit-core</code>，因此在默认情况下 Gradle 将无法正常构建 Kafka 的源码，会出现以下错误信息：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A problem occurred configuring root project 'kafka-3.0.0-src'.</span><br><span class="line">&gt; Could not resolve all artifacts for configuration ':classpath'.</span><br><span class="line">   &gt; Could not find org.ajoberstar.grgit:grgit-core:4.1.0.</span><br></pre></td></tr></tbody></table></figure><p>解决办法是，更改 Kafka 源码目录下的 <code>gradle/dependencies.gradle</code> 配置文件，将 <code>grgit:"4.1.0"</code> 更改为 <code>grgit: "4.1.1"</code>，如下图所示：</p><p><img data-src="../../../asset/2024/12/kafka-source-7.png"></p><h3 id="使用本地的-JDK"><a href="#使用本地的-JDK" class="headerlink" title="使用本地的 JDK"></a>使用本地的 JDK</h3><p>在 IntelliJ IDEA 导入 Kafka 源码后，菜单栏导航到 <code>File &gt; Project Structure -&gt; Project Settings</code>，然后设置本地已安装的 JDK 版本，如下图所示：</p><p><img data-src="../../../asset/2024/12/kafka-source-9.png"></p><p><img data-src="../../../asset/2024/12/kafka-source-6.png"></p><h3 id="使用本地的-Scala"><a href="#使用本地的-Scala" class="headerlink" title="使用本地的 Scala"></a>使用本地的 Scala</h3><p>在 IntelliJ IDEA 导入 Kafka 源码后，编辑 Kafka 源码目录中的 <code>gradle.properties</code> 配置文件，然后将 Scala 的版本号更改为本地已安装的 Scala 版本，如下图所示：</p><p><img data-src="../../../asset/2024/12/kafka-source-3.png"></p><p>在 IntelliJ IDEA 的主界面中，菜单栏导航到 <code>File &gt; Project Structure -&gt; Platform Settings</code>，然后添加本地已安装的 Scala 版本，如下图所示：</p><p><img data-src="../../../asset/2024/12/kafka-source-10.png"></p><h3 id="使用本地的-Gradle"><a href="#使用本地的-Gradle" class="headerlink" title="使用本地的 Gradle"></a>使用本地的 Gradle</h3><p>在 IntelliJ IDEA 导入 Kafka 源码后，IDEA 可能会自动下载 Gradle 的压缩包。这是因为 Kafka 使用了 Gradle Wrapper，并且 IDEA 默认会优先使用 Gradle Wrapper 来管理构建工具的版本。Gradle Wrapper 是 Gradle 提供的一种机制，用于确保构建环境的一致性，它包含一个 <code>gradlew</code> 可执行脚本和 <code>gradle/wrapper/gradle-wrapper.properties</code> 配置文件，并且在 <code>gradle-wrapper.properties</code> 配置文件中指定了 Gradle 的精确版本（如下图所示）。在 IntelliJ IDEA 导入 Gradle 项目时，Gradle 的使用优先级如下：</p><ul><li><code>Gradle Wrapper（默认使用）</code>：IDEA 会优先使用项目中已配置的 Gradle Wrapper，以确保构建工具版本与项目的要求一致。</li><li><code>本地已安装的 Gradle</code>：当选择不使用 Gradle Wrapper 时，IntelliJ IDEA 才会使用本地已安装的 Gradle 版本。</li></ul><p><img data-src="../../../asset/2024/12/kafka-source-4.png"></p><p>为了让 IntelliJ IDEA 默认使用本地已安装的 Gradle 版本，菜单栏导航到 <code>File &gt; Settings &gt; Build， Execution， Deployment &gt; Build Tools &gt; Gradle</code>，然后在 <code>Use Gradle from</code> 下拉列表中选择 <code>Specified location</code>，最后手动选择本地已安装的 Gradle 版本，如下图所示：</p><p><img data-src="../../../asset/2024/12/kafka-source-5.png"></p><h3 id="IDE-重新构建源码"><a href="#IDE-重新构建源码" class="headerlink" title="IDE 重新构建源码"></a>IDE 重新构建源码</h3><p>在完成上述配置步骤后，重启 IntelliJ IDEA，然后 IDEA 就会自动构建 Kafka 项目的源码。另外，还可以在 IDEA 主界面的右侧工具栏中，点击 Gradle 的 <code>重载</code> 按钮，将整个项目重新构建一次，如下图所示：</p><p><img data-src="../../../asset/2024/12/kafka-source-8.png"></p><p>当 IntelliJ IDEA 成功构建 Kafka 项目的源码后，会输出如下的日志信息：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Starting Gradle Daemon...</span><br><span class="line">Gradle Daemon started in 1 s 8 ms</span><br><span class="line"></span><br><span class="line">&gt; Configure project :</span><br><span class="line">Starting build with version 3.0.0 using Gradle 7.1.1, Java 1.8 and Scala 2.13.6</span><br><span class="line"></span><br><span class="line">Deprecated Gradle features were used in this build, making it incompatible with Gradle 8.0.</span><br><span class="line"></span><br><span class="line">You can use '--warning-mode all' to show the individual deprecation warnings and determine if they come from your own scripts or plugins.</span><br><span class="line"></span><br><span class="line">See https://docs.gradle.org/7.1.1/userguide/command_line_interface.html#sec:command_line_warnings</span><br><span class="line"></span><br><span class="line">BUILD SUCCESSFUL in 13s</span><br></pre></td></tr></tbody></table></figure><div class="admonition warning"><p class="admonition-title">特别注意</p><p>在 IntelliJ IDEA 中构建源码的操作，只是为了让 IntelliJ IDEA 可以正常导入 / 加载 Gradle 项目（Kafka），并不代表项目的源码可以正常编译。</p></div><h3 id="命令行编译源码"><a href="#命令行编译源码" class="headerlink" title="命令行编译源码"></a>命令行编译源码</h3><p>在终端可以执行 <code>gradlew</code> 命令直接编译 Kafka 的源码（如下所示），这里的 <code>gradlew</code> 是 Kafka 提供的 Gradle Wrapper 脚本。当 Kafka 源码编译成功后，所有生成的 JAR 文件和分发包一般都会位于 <code>build</code> 目录下。</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编译源码</span></span><br><span class="line">./gradlew build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译源码，先执行清理</span></span><br><span class="line">./gradlew clean build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译源码，并跳过测试</span></span><br><span class="line">./gradlew build -x <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 仅编译 core 模块的源码</span></span><br><span class="line">./gradlew core:build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译生成二进制包</span></span><br><span class="line">./gradlew kafka-dist:assemble</span><br></pre></td></tr></tbody></table></figure><p>或者使用本地已安装的 Gradle 来编译 Kafka 的源码。</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编译源码</span></span><br><span class="line">gradle build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译源码，并跳过测试</span></span><br><span class="line">gradle build -x <span class="built_in">test</span></span><br></pre></td></tr></tbody></table></figure><h2 id="IDE-工具启动源码"><a href="#IDE-工具启动源码" class="headerlink" title="IDE 工具启动源码"></a>IDE 工具启动源码</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ul><li><p>(1) 在默认情况下，Kafka Broker 的运行需要依赖于 ZooKeeper，因此需要提前安装并启动 ZooKeeper，这里不再累述。</p></li><li><p>(2) 编辑 Kafka 源码目录下的 <code>config/server.properties</code> 配置文件，更改 ZooKeeper 的连接地址，如下所示：</p></li></ul><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ZooKeeper 连接地址（单个节点）</span></span><br><span class="line"><span class="meta">zookeeper.connect</span>=<span class="string">127.0.0.1:2181</span></span><br></pre></td></tr></tbody></table></figure><p>或者指定多个 ZooKeeper 集群节点，使用逗号分割</p><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ZooKeeper 连接地址（多个节点）</span></span><br><span class="line"><span class="meta">zookeeper.connect</span>=<span class="string">127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183/kafka</span></span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">提示</p><p>值得一提的是，从 Kafka <code>2.8.0</code> 版本开始，Kafka 自身实现了 <code>Raft</code> 分布式一致性机制，这意味着 Kafka（包括集群）是可以脱离 ZooKeeper 独立运行的。</p></div><h3 id="启动源码"><a href="#启动源码" class="headerlink" title="启动源码"></a>启动源码</h3><p>Kafka Broker 的主启动类是 <code>core/src/main/scala/kafka/Kafka.scala</code>，在 IntelliJ IDEA 中打开该主启动类，并启动 <code>main</code> 方法即可，如下图所示：</p><p><img data-src="../../../asset/2024/12/kafka-source-11.png"></p><p>在默认情况下，Kafka Broker 会启动失败，因为在启动的时候没有指定 <code>server.properties</code> 配置文件，IntelliJ IDEA 会输出如下的错误信息：</p><p><img data-src="../../../asset/2024/12/kafka-source-12.png"></p><p>因此，在 IntelliJ IDEA 中需要修改 Kafka Broker 的启动配置，也就是在 <code>Program arguments</code> 中添加 <code>server.properties</code> 配置文件的相对路径（或者绝对路径），如下图所示：</p><p><img data-src="../../../asset/2024/12/kafka-source-13.png"></p><p>获取 <code>server.properties</code> 配置文件的相对路径（或者绝对路径），然后在添加到 <code>Program arguments</code> 里面，如下图所示：</p><p><img data-src="../../../asset/2024/12/kafka-source-14.png"></p><p>这样 Kafka Broker 就可以正常启动了，如果控制台输出的 SL4J 的警告信息，那么可以忽略掉那些警告信息，或者根据 <a href="/posts/a2880619.html#%E5%90%AF%E5%8A%A8%E5%A4%B1%E8%B4%A5%E6%B2%A1%E6%9C%89%E8%BE%93%E5%87%BA%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97">这里</a> 的教程配置 Kafka 的日志输出，如下图所示：</p><p><img data-src="../../../asset/2024/12/kafka-source-15.png"></p><h3 id="测试源码"><a href="#测试源码" class="headerlink" title="测试源码"></a>测试源码</h3><ul><li>创建主题</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-topics.sh --create --bootstrap-server 127.0.0.1:9092 --topic <span class="built_in">test</span> --partitions 1 --replication-factor 1</span><br></pre></td></tr></tbody></table></figure><ul><li>查看主题列表</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-topics.sh --list --bootstrap-server 127.0.0.1:9092</span><br></pre></td></tr></tbody></table></figure><ul><li>查看主题详情</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-topics.sh --describe --bootstrap-server 127.0.0.1:9092 --topic <span class="built_in">test</span></span><br></pre></td></tr></tbody></table></figure><ul><li>发送消息</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-console-producer.sh --topic <span class="built_in">test</span> --broker-list 127.0.0.1:9092</span><br></pre></td></tr></tbody></table></figure><ul><li>接收消息</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-console-consumer.sh --topic <span class="built_in">test</span> --from-beginning --bootstrap-server 127.0.0.1:9092</span><br></pre></td></tr></tbody></table></figure><h2 id="常见错误解决"><a href="#常见错误解决" class="headerlink" title="常见错误解决"></a>常见错误解决</h2><h3 id="Kafka-源码启动失败"><a href="#Kafka-源码启动失败" class="headerlink" title="Kafka 源码启动失败"></a>Kafka 源码启动失败</h3><ul><li>在 IntelliJ IDEA 中，通过主启动类 <code>core/src/main/scala/kafka/Kafka.scala</code> 启动 Kafka Broker，出现以下错误信息：</li></ul><p><img data-src="../../../asset/2024/12/kafka-source-12.png"></p><ul><li>这可能是因为在启动 Kafka Broker 时，没有通过环境变量指定 <code>server.properties</code> 配置文件导致的，解决方案请看 <a href="/posts/a2880619.html#%E5%90%AF%E5%8A%A8%E6%BA%90%E7%A0%81">这里</a>。</li></ul><div class="admonition warning"><p class="admonition-title">特别注意</p><p>如果在 Broker 启动时指定了 <code>server.properties</code> 配置文件也还是启动失败，那么建议根据 <a href="/posts/a2880619.html#%E5%90%AF%E5%8A%A8%E5%A4%B1%E8%B4%A5%E6%B2%A1%E6%9C%89%E8%BE%93%E5%87%BA%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97">这里</a> 的教程，打印 Kafka Broker 启动时的详细错误日志信息，以此定位问题。</p></div><h3 id="找不到-grgit-core-依赖"><a href="#找不到-grgit-core-依赖" class="headerlink" title="找不到 grgit-core 依赖"></a>找不到 grgit-core 依赖</h3><ul><li>在 Kafka <code>3.0.0</code> 版本的源码中，依赖了 <code>4.1.0</code> 版本的 <code>grgit-core</code>。但是，在 Maven 仓库中只有 <code>4.1.1</code> 版本的 <code>grgit-core</code>，因此在默认情况下 Gradle 将无法正常构建 Kafka 的源码，会出现以下错误信息：</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A problem occurred configuring root project 'kafka-3.0.0-src'.</span><br><span class="line">&gt; Could not resolve all artifacts for configuration ':classpath'.</span><br><span class="line">   &gt; Could not find org.ajoberstar.grgit:grgit-core:4.1.0.</span><br></pre></td></tr></tbody></table></figure><ul><li>解决办法是，更改 Kafka 源码目录下的 <code>gradle/dependencies.gradle</code> 配置文件，将 <code>grgit:"4.1.0"</code> 更改为 <code>grgit: "4.1.1"</code>，然后重新构建项目，如下图所示：</li></ul><p><img data-src="../../../asset/2024/12/kafka-source-7.png"></p><h3 id="启动失败没有输出错误日志"><a href="#启动失败没有输出错误日志" class="headerlink" title="启动失败没有输出错误日志"></a>启动失败没有输出错误日志</h3><p>在 IntelliJ IDEA 中启动 Kafka Broker 失败后，控制台没有输出具体的错误日志，只简单显示以下错误信息（如下图所示），导致很难定位问题</p><p><img data-src="../../../asset/2024/12/kafka-source-12.png"></p><p>解决办法是在 Kafka 源码目录下，拷贝 <code>config/log4j.properties</code> 配置文件到 <code>core/src/main/resources</code> 目录下，如下图所示：</p><p><img data-src="../../../asset/2024/12/kafka-source-16.png"></p><p>然后，编辑 Kafka 源码目录下的 <code>build.gradle</code> 配置文件，找到 <code>project(':core')</code>，然后在里面添加以下依赖，如下图所示：</p><figure class="highlight gradle"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">implementation libs.slf4jApi</span><br><span class="line">implementation libs.slf4jlog4j</span><br><span class="line">implementation libs.log4j</span><br></pre></td></tr></tbody></table></figure><p><img data-src="../../../asset/2024/12/kafka-source-17.png"></p><h3 id="集群-ID-不匹配导致启动失败"><a href="#集群-ID-不匹配导致启动失败" class="headerlink" title="集群 ID 不匹配导致启动失败"></a>集群 ID 不匹配导致启动失败</h3><p>在 IntelliJ IDEA 中启动 Kafka Broker 时，出现以下错误信息：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[2022-10-23 21:05:39,738] ERROR Fatal error during KafkaServer startup. Prepare to shutdown (kafka.server.KafkaServer)</span><br><span class="line">kafka.common.InconsistentClusterIdException: The Cluster ID pvKvK1WTSeGJyE0w6qUvrQ doesn't match stored clusterId Some(gvucjXWLQxqChk_mvH7DAQ) in meta.properties. The broker is trying to join the wrong cluster. Configured zookeeper.connect may be wrong.</span><br><span class="line">	at kafka.server.KafkaServer.startup(KafkaServer.scala:223)</span><br><span class="line">	at kafka.Kafka$.main(Kafka.scala:109)</span><br><span class="line">	at kafka.Kafka.main(Kafka.scala)</span><br><span class="line">[2022-10-23 21:05:39,741] INFO shutting down (kafka.server.KafkaServer)</span><br><span class="line">[2022-10-23 21:05:39,744] INFO [feature-zk-node-event-process-thread]: Shutting down (kafka.server</span><br></pre></td></tr></tbody></table></figure><p>这个错误是由于 Kafka Broker 的集群 ID 与其日志目录下存储的 <code>meta.properties</code> 文件中的集群 ID 不匹配导致的。解决方案是，删除 Kafka 日志目录 <code>/tmp/kafka-logs</code> 下的所有文件，然后重新启动 Kafka Broker。</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rm -rf /tmp/kafka-logs</span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">提示</p><p>在使用 IntelliJ IDEA 启动 Kafka 源码时，默认日志目录（即 Kafka 的 <code>log.dirs</code> 配置）可以在 <code>server.properties</code> 配置文件中查看到。如果未明确设置，则 Kafka 会使用 <code>/tmp/kafka-logs</code> 作为默认日志路径。</p></div><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/LNF568611/article/details/124920139">启动 Kafka 项目的源码</a></li><li><a target="_blank" rel="external nofollow" href="https://www.cnblogs.com/kendoziyu/p/15235405.html">IDEA 运行 Kafka 源码踩坑</a></li><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/l___ping/article/details/124967916">Kafka 2.7 源码编译踩坑记录</a></li><li><a target="_blank" rel="external nofollow" href="https://blog.csdn.net/CSDNedu/article/details/143510754">构建 Kafka 工程和源码阅读环境</a></li></ul><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/a2880619.html" title="Kafka 源码阅读环境搭建">https://www.techgrow.cn/posts/a2880619.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/Linux%E8%BF%90%E7%BB%B4/" rel="tag"><i class="fa fa-tag"></i> Linux运维</a><a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" rel="tag"><i class="fa fa-tag"></i> 消息队列</a><a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" rel="tag"><i class="fa fa-tag"></i> 大数据</a><a href="/tags/%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" rel="tag"><i class="fa fa-tag"></i> 源码剖析</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/bc19d204.html" rel="prev" title="VuePress 渲染 Mermaid 绘图"><i class="fa fa-angle-left"></i> VuePress 渲染 Mermaid 绘图</a></div><div class="post-nav-item"> <a href="/posts/eb1b1f3.html" rel="next" title="Java 代码规范检测与格式化（超详细）">Java 代码规范检测与格式化（超详细）<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">1.9m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">29:09</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"/lib/mermaid/dist/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/a2880619.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>