<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍 Java 如何通过 Hmily 实现 TCC 分布式事务。"><meta property="og:type" content="article"><meta property="og:title" content="基于 Hmily 实战 TCC 分布式事务之一"><meta property="og:url" content="https://www.techgrow.cn/posts/1625c614.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍 Java 如何通过 Hmily 实现 TCC 分布式事务。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/database-transaction-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/database-transaction-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/database-transaction-4.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/database-transaction-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-7.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-8.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-9.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-10.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-12.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-11.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-13.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-14.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-15.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-16.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-17.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-18.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/db-isolate-level.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2026/01/tcc-transaction-19.png"><meta property="article:published_time" content="2022-03-05T13:12:19.000Z"><meta property="article:modified_time" content="2022-03-05T13:12:19.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="微服务"><meta property="article:tag" content="数据库"><meta property="article:tag" content="分布式"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2026/01/database-transaction-1.png"><link rel="canonical" href="https://www.techgrow.cn/posts/1625c614.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/1625c614.html","path":"posts/1625c614.html","title":"基于 Hmily 实战 TCC 分布式事务之一"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>基于 Hmily 实战 TCC 分布式事务之一 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script>
  (function () {

  // 防止 Pjax 重复绑定事件
  if (window.__moonMenuCodeExpandBound) {
    return;
  }
  window.__moonMenuCodeExpandBound = true;

  const STORAGE_KEY = 'moon_menu_code_fold';

  /* ===============================
   * 1. 设置 moon-menu 按钮的 title
   * =============================== */
  (function bindMoonMenuTitles() {
    const items = [
      { selector: '#moon-menu-item-code',        title: '展开 / 折叠代码块' },
      { selector: '#moon-menu-item-back2top',    title: '回到页面顶部' },
      { selector: '#moon-menu-item-back2bottom', title: '回到页面底部' }
    ];

    let allReady = true;

    items.forEach(item => {
      const el = document.querySelector(item.selector);
      if (!el) {
        allReady = false;
        return;
      }
      el.setAttribute('title', item.title);
    });

    if (!allReady) {
      setTimeout(bindMoonMenuTitles, 100);
    }
  })();

  /* =================================
   * 2. 页面首次加载：代码块恢复展开或折叠状态
   * ================================= */
  function applyStoredCodeState() {
    const containers = document.querySelectorAll('.code-container');
    if (!containers.length) {
      return;
    }

    const state = localStorage.getItem(STORAGE_KEY);
    if (!state) {
      return;
    }

    containers.forEach(container => {
      if (state === 'expanded') {
        // 展开代码块
        container.classList.remove('highlight-fold');
      } else if (state === 'folded') {
        // 折叠代码块
        container.classList.add('highlight-fold');
      }
    });
  }

  // 等代码块出现后，再恢复展开或折叠状态
  function waitAndApplyState() {
    const containers = document.querySelectorAll('.code-container');

    if (!containers.length) {
      setTimeout(waitAndApplyState, 100);
      return;
    }

    applyStoredCodeState();
  }

  // 页面首次加载时恢复状态
  waitAndApplyState();
  
  // Pjax 切换页面后，必须重新恢复状态
  document.addEventListener('pjax:complete', function () {
    waitAndApplyState();
  });

  /* ===============================
   * 3. 点击按钮：切换状态并保存
   * =============================== */
  document.addEventListener('click', function (e) {
    const codeMenu = e.target.closest('#moon-menu-item-code');
    if (!codeMenu) {
      return;
    }

    toggleAllCodeBlocks();
  });

  // 展开或折叠代码块
  function toggleAllCodeBlocks() {
    const containers = document.querySelectorAll('.code-container');
    if (!containers.length) {
      return;
    }

    // 只要存在折叠的代码块，就认为当前是折叠状态
    const hasFolded = Array.from(containers).some(c => {
      return c.classList.contains('highlight-fold');
    });

    containers.forEach(container => {
      if (hasFolded) {
        // 展开代码块
        container.classList.remove('highlight-fold');
      } else {
        // 折叠代码块
        container.classList.add('highlight-fold');
      }
    });

    // 记录展开或折叠状态
    localStorage.setItem(
      STORAGE_KEY,
      hasFolded ? 'expanded' : 'folded'
    );
  }

})();
</script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="nav-text">基础概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E7%A7%8D%E4%BA%8B%E5%8A%A1%E5%9C%BA%E6%99%AF"><span class="nav-text">多种事务场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCC-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="nav-text">TCC 分布式事务的定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCC-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%9E%B6%E6%9E%84"><span class="nav-text">TCC 分布式事务的架构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TCC-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%AE%9E%E6%88%98%EF%BC%88%E7%90%86%E8%AE%BA%EF%BC%89"><span class="nav-text">TCC 分布式事务实战（理论）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="nav-text">账户系统的整体架构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%8F%E5%9E%8B%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F"><span class="nav-text">小型账户系统</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%BF%E7%BA%A7%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F"><span class="nav-text">亿级账户系统</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%93%E7%B3%BB%E5%86%85%E9%83%A8%E8%BD%AC%E8%B4%A6"><span class="nav-text">体系内部转账</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%86%85%E9%83%A8%E8%BD%AC%E8%B4%A6%E7%BB%99%E5%A4%96%E9%83%A8"><span class="nav-text">内部转账给外部</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A4%96%E9%83%A8%E8%BD%AC%E8%B4%A6%E7%BB%99%E5%86%85%E9%83%A8"><span class="nav-text">外部转账给内部</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E7%9A%84-TCC-%E6%A8%A1%E5%9E%8B"><span class="nav-text">账户系统的 TCC 模型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#TCC-%E6%A8%A1%E5%9E%8B%E4%B9%8B%E4%B8%80%EF%BC%88%E9%94%99%E8%AF%AF%EF%BC%89"><span class="nav-text">TCC 模型之一（错误）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TCC-%E6%A8%A1%E5%9E%8B%E4%B9%8B%E4%BA%8C%EF%BC%88%E9%94%99%E8%AF%AF%EF%BC%89"><span class="nav-text">TCC 模型之二（错误）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TCC-%E6%A8%A1%E5%9E%8B%E4%B9%8B%E4%B8%89%EF%BC%88%E9%94%99%E8%AF%AF%EF%BC%89"><span class="nav-text">TCC 模型之三（错误）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TCC-%E6%A8%A1%E5%9E%8B%E4%B9%8B%E5%9B%9B%EF%BC%88%E6%AD%A3%E7%A1%AE%EF%BC%89"><span class="nav-text">TCC 模型之四（正确）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TCC-%E6%A8%A1%E5%9E%8B%E4%B9%8B%E4%BA%94%EF%BC%88%E6%AD%A3%E7%A1%AE%EF%BC%89"><span class="nav-text">TCC 模型之五（正确）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TCC-%E6%A8%A1%E5%9E%8B%E6%80%BB%E7%BB%93%E8%AF%B4%E6%98%8E"><span class="nav-text">TCC 模型总结说明</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E7%9A%84-TCC-%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="nav-text">账户系统的 TCC 事务隔离级别</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="nav-text">事务隔离级别的基础概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TCC-%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E7%9A%84%E6%8E%A8%E6%BC%94"><span class="nav-text">TCC 事务隔离级别的推演</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">795</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">56</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/1625c614.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="基于 Hmily 实战 TCC 分布式事务之一 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍 Java 如何通过 Hmily 实现 TCC 分布式事务。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 基于 Hmily 实战 TCC 分布式事务之一</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-03-05 21:12:19" itemprop="dateCreated datePublished" datetime="2022-03-05T21:12:19+08:00">2022-03-05</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/1625c614.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/1625c614.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>4.3k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>4 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/1625c614.html">基于 Hmily 实战 TCC 分布式事务之一</a></li><li><a href="/posts/3e028f15.html">基于 Hmily 实战 TCC 分布式事务之二</a></li></ul><span id="more"></span><h2 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h2><div class="admonition note"><p class="admonition-title">推荐阅读</p><ul><li><a href="/posts/726e9aff.html">《分布式事务解决方案介绍》</a></li></ul></div><h3 id="多种事务场景"><a href="#多种事务场景" class="headerlink" title="多种事务场景"></a>多种事务场景</h3><ul><li>本地事务：一个服务只需要调用一个数据库实例完成数据的增删改查操作</li></ul><p><img data-src="../../../asset/2026/01/database-transaction-1.png"></p><hr><ul><li>多库事务：一个服务需要调用多个数据库实例完成数据的增删改查操作</li></ul><p><img data-src="../../../asset/2026/01/database-transaction-2.png"></p><hr><ul><li>跨服务事务：多个服务需要调用同一个数据库实例完成数据的增删改查操作</li></ul><p><img data-src="../../../asset/2026/01/database-transaction-4.png"></p><hr><ul><li>跨服务事务：多个服务需要调用多个数据库实例完成数据的增删改查操作</li></ul><p><img data-src="../../../asset/2026/01/database-transaction-3.png"></p><h3 id="TCC-分布式事务的定义"><a href="#TCC-分布式事务的定义" class="headerlink" title="TCC 分布式事务的定义"></a>TCC 分布式事务的定义</h3><p>TCC（Try-Confirm-Cancel） 是一种分布式事务模式，它将一个大的事务拆分为两个阶段（Try 阶段与 Confirm / Cancel 阶段），并由多个相互独立的子事务组成。第一阶段（Try）用于预留 / 冻结资源，需要同步完成；第二阶段（Confirm / Cancel）用于提交或回滚资源，可以异步执行而不影响整体事务结果的一致性。<strong>特别注意的是，在极端情况下，TCC 可能需要人工介入处理，例如 Confirm 或 Cancel 一直执行失败或超过最大重试次数时；若处理不当，可能会导致系统出现不一致问题。因此，在对一致性要求极高的金融系统中，通常需要建立独立、完善的事务补偿、监控与人工干预机制，以保障系统的一致性与可恢复性。</strong></p><p><img data-src="../../../asset/2026/01/tcc-transaction-7.png"></p><p>TCC（Try Confirm Cancel）属于补偿型分布式事务（又被称为补偿事务），类似 2PC（两阶段提交）的柔性分布式解决方案，属于 2PC 的改良版。</p><ul><li><p>TCC 实现分布式事务一共有三个步骤：</p><ul><li>Try（尝试待执行的业务）：这个过程并未执行业务，只是完成所有业务的一致性检查，并预留好执行所需的全部资源。</li><li>Confirm（确认执行业务）：确认执行业务操作，不做任何业务检查，只使用 Try 阶段预留的业务资源。通常情况下，采用 TCC 则认为 Confirm 阶段是不会出错的。即只要 Try 成功，Confirm 就一定成功。若 Confirm 真的出错了，需引入 Confirm 重试机制或人工处理。</li><li>Cancel（取消待执行的业务）：取消 Try 阶段预留的业务资源。通常情况下，采用 TCC 则认为 Cancel 阶段是不会出错的。即只要 Try 失败，Cancel 就一定成功。若 Cancel 阶段真的出错了，需引入 Cancel 重试机制或人工处理。</li></ul></li><li><p>基于 TCC 实现跨银行转账为例：</p><ul><li>Try 阶段：先冻结两个银行账户中的资金，防止被其他操作使用。</li><li>Confirm 阶段：执行实际转账，A 银行账户资金扣减，B 银行账户资金增加。</li><li>Cancel 阶段：若任一操作执行失败，则进行补偿回滚，例如 A 已经扣款但 B 增加资金失败时，就需要将 A 的资金加回去。</li></ul></li></ul><div class="admonition warning"><p class="admonition-title">Cancel 执行的时机</p><p>在 TCC 事务中，只要有任意一个 Try 阶段执行失败，整体事务即被判定为失败，此时需要对所有已成功执行 Try 的分支事务执行 Cancel 以释放已冻结的资源。Cancel 仅在 Try 阶段失败或整体事务被判定失败时触发；一旦进入 Confirm 阶段，事务结果已经确定（因为所有 Try 执行成功），即使 Confirm 执行失败，也只能通过重试 Confirm 来完成事务，而不应再执行 Cancel。简而言之，<strong>Cancel 是 Try 的反向操作，不是 Confirm 的补偿操作。</strong></p></div><p><img data-src="../../../asset/2026/01/tcc-transaction-1.png"></p><ul><li><p><strong>TCC 事务的优点：</strong></p><ul><li>将数据库层的两阶段提交上提到了应用层来实现，规避了数据库层的 2PC 性能低下的问题</li><li>可以严格保证事务的最终一致性，尤其适合对最终一致性要求极高的核心业务场景（如支付、交易、资金结算等），并且通常要求各个步骤的执行时间较短</li></ul></li><li><p> <strong>TCC 事务的缺点：</strong></p><ul><li>TCC 的 Try、Confirm 和 Cancel 操作功能需要由业务提供，开发成本高</li><li>严重依赖人工编写的补偿逻辑，导致业务代码庞杂、难以维护，因此在实际项目中应用相对较少</li></ul></li><li><p> <strong>TCC 事务的适用场景：</strong></p><ul><li>对最终一致性要求极高、允许短暂中间状态、但希望不一致窗口尽可能小的核心业务场景，如金融转账、交易、支付结算等</li><li>业务链路相对较短、各个业务步骤执行时间可控，能够在较短时间内完成 Try / Confirm / Cancel 的场景</li><li>系统能够接受较高的开发与维护成本，且团队具备实现完善的幂等控制、补偿逻辑和异常兜底能力的情况下</li></ul></li><li><p> <strong>TCC 两阶段提交与 2PC / XA 的区别：</strong></p><ul><li>2PC / XA 是资源层面的分布式事务，强一致性，在两阶段提交的整个过程中，会一直持有资源的锁</li><li> TCC 是业务层面的分布式事务，满足最终一致性，不会一直持有资源的锁</li></ul></li><li><p><strong>为什么 TCC 属于最终一致性方案，但可以用于如金融转账、交易、支付等场景：</strong></p><ul><li>金融转账、交易、支付系统真正要求的是 “结果零容错”，而不是 “过程零中间状态”。只要中间状态对用户是可理解、可控且可恢复的，系统就能够满足金融级一致性要求。TCC 通过冻结资源与快速补偿机制，将不一致性严格限制在系统内部，并通过业务语义对外提供一致的用户视图，因此在不依赖强一致性事务的前提下，仍然能够保证最终结果绝对正确。</li><li>从本质上看，TCC 是一种 “用业务语义模拟强一致性体验” 的最终一致性方案。以银行转账为例，真实的金融系统通常会维护多种账户余额维度（如可用余额、冻结余额、在途金额、已清算 / 未清算金额），总账始终守恒，对用户展示的是业务一致视图。在 TCC 中，Try 阶段只是冻结余额，并不改变最终账务归属；Confirm 阶段才真正完成扣减；Cancel 阶段则会完整回滚冻结。因此，用户看到的是 “处理中” 或 “冻结” 状态，而不是资金凭空消失或异常增加。</li><li>在工程实践上，TCC 通过冻结而非直接扣减、同步编排而非纯异步、秒级补偿而非长时间不一致，实现了高可用、可解释且账务绝对正确的交易流程。相比之下，2PC / XA 在金融高并发场景下往往存在资源锁定时间长、对数据库和中间件侵入强、协调者异常容易导致长时间阻塞等问题，极易放大故障风险。而金融系统真正忌讳的是卡死、雪崩和不可恢复的阻塞，而不是短暂且可控的 “处理中” 状态。</li></ul></li></ul><div class="admonition note"><p class="admonition-title">提示</p><p>分布式系统需要遵循一致性相关的 CAP 理论与 BASE 理论，TCC 分布式事务并不违背这些理论。分布式系统中的最终一致性原则同样适用于 TCC。TCC 通过第二阶段（Confirm / Cancel）的补偿机制，在保证业务语义正确的前提下实现最终一致性。<strong>从工程实践角度看，所有分布式事务解决方案都必须具备补偿机制，因此本质上都属于最终一致性方案</strong>。在选择具体的分布式事务解决方案时，需要重点评估补偿机制的实现复杂度与执行效率。</p></div><div class="admonition warning"><p class="admonition-title">特别注意</p><p><strong>TCC 属于最终一致性方案，而不是强一致性方案。TCC 适合的不是 "必须强一致" 的场景，而是 "结果绝不能错，但过程可以短暂不一致" 的场景</strong>。虽然 TCC 通过 Try-Confirm-Cancel 的同步编排流程，在 Try 阶段预留资源，并在任一参与方失败时立即进入 Cancel，通常可以在秒级内完成一致性恢复，从效果上看 TCC 被认为是最终一致性中 "最接近强一致性" 的方案；但其一致性仍依赖业务层的补偿、重试和幂等机制，允许中间状态短暂存在，无法提供真正意义上的原子提交和瞬时一致性。因此 "接近强一致性" 并不等同于 "强一致性"，TCC 其本质仍然是最终一致性解决方案。</p></div><h3 id="TCC-分布式事务的架构"><a href="#TCC-分布式事务的架构" class="headerlink" title="TCC 分布式事务的架构"></a>TCC 分布式事务的架构</h3><ul><li>TCC 分布式事务的整体架构图如下：</li></ul><p><img data-src="../../../asset/2026/01/tcc-transaction-8.png"></p><h2 id="TCC-分布式事务实战（理论）"><a href="#TCC-分布式事务实战（理论）" class="headerlink" title="TCC 分布式事务实战（理论）"></a>TCC 分布式事务实战（理论）</h2><h3 id="账户系统的整体架构"><a href="#账户系统的整体架构" class="headerlink" title="账户系统的整体架构"></a>账户系统的整体架构</h3><h4 id="小型账户系统"><a href="#小型账户系统" class="headerlink" title="小型账户系统"></a>小型账户系统</h4><p><img data-src="../../../asset/2026/01/tcc-transaction-9.png"></p><hr><h4 id="亿级账户系统"><a href="#亿级账户系统" class="headerlink" title="亿级账户系统"></a>亿级账户系统</h4><h5 id="体系内部转账"><a href="#体系内部转账" class="headerlink" title="体系内部转账"></a>体系内部转账</h5><p><img data-src="../../../asset/2026/01/tcc-transaction-10.png"></p><hr><h5 id="内部转账给外部"><a href="#内部转账给外部" class="headerlink" title="内部转账给外部"></a>内部转账给外部</h5><p><img data-src="../../../asset/2026/01/tcc-transaction-12.png"></p><hr><h5 id="外部转账给内部"><a href="#外部转账给内部" class="headerlink" title="外部转账给内部"></a>外部转账给内部</h5><p><img data-src="../../../asset/2026/01/tcc-transaction-11.png"></p><hr><h3 id="账户系统的-TCC-模型"><a href="#账户系统的-TCC-模型" class="headerlink" title="账户系统的 TCC 模型"></a>账户系统的 TCC 模型</h3><h4 id="TCC-模型之一（错误）"><a href="#TCC-模型之一（错误）" class="headerlink" title="TCC 模型之一（错误）"></a>TCC 模型之一（错误）</h4><p><img data-src="../../../asset/2026/01/tcc-transaction-13.png"></p><h4 id="TCC-模型之二（错误）"><a href="#TCC-模型之二（错误）" class="headerlink" title="TCC 模型之二（错误）"></a>TCC 模型之二（错误）</h4><p><img data-src="../../../asset/2026/01/tcc-transaction-14.png"></p><h4 id="TCC-模型之三（错误）"><a href="#TCC-模型之三（错误）" class="headerlink" title="TCC 模型之三（错误）"></a>TCC 模型之三（错误）</h4><p><img data-src="../../../asset/2026/01/tcc-transaction-15.png"></p><h4 id="TCC-模型之四（正确）"><a href="#TCC-模型之四（正确）" class="headerlink" title="TCC 模型之四（正确）"></a>TCC 模型之四（正确）</h4><p><img data-src="../../../asset/2026/01/tcc-transaction-16.png"></p><h4 id="TCC-模型之五（正确）"><a href="#TCC-模型之五（正确）" class="headerlink" title="TCC 模型之五（正确）"></a>TCC 模型之五（正确）</h4><p><img data-src="../../../asset/2026/01/tcc-transaction-17.png"></p><h4 id="TCC-模型总结说明"><a href="#TCC-模型总结说明" class="headerlink" title="TCC 模型总结说明"></a>TCC 模型总结说明</h4><p><img data-src="../../../asset/2026/01/tcc-transaction-18.png"></p><h3 id="账户系统的-TCC-事务隔离级别"><a href="#账户系统的-TCC-事务隔离级别" class="headerlink" title="账户系统的 TCC 事务隔离级别"></a>账户系统的 TCC 事务隔离级别</h3><h4 id="事务隔离级别的基础概念"><a href="#事务隔离级别的基础概念" class="headerlink" title="事务隔离级别的基础概念"></a>事务隔离级别的基础概念</h4><p>事务表示多个数据操作组成一个完整的事务单元，在这个事务内的所有数据操作要么同时成功，要么同时失败。<strong>数据库系统必须具有隔离并发运行各个事务的能力，使它们不会相互影响，避免各种并发问题。一个事务与其他事务隔离的程度称为 <code>隔离级别</code>。</strong>SQL 标准中规定了多种事务隔离级别，不同隔离级别对应不同的干扰程度，隔离级别越高，数据一致性就越好，但数据库的并发性能越差。</p><div class="admonition note"><p class="admonition-title">提示</p><p>事务隔离级别是数据库用来规定并发事务之间相互可见性和相互影响程度的一套规则，它通过在性能与一致性之间做取舍，明确一个事务在执行过程中能否看到其他未提交或已提交事务的数据变化，从而避免或容忍脏读、不可重复读和幻读等数据库事务并发问题。</p></div><p>为了解决事务并发问题（脏读、不可重复读、幻读），主流的关系型数据库都会提供以下四种事务隔离级别。</p><ul><li>(1) <strong>读未提交（Read Uncommitted）</strong><ul><li>在该隔离级别，<strong>所有事务都可以看到其他未提交事务所做的改变</strong>。</li><li>该隔离级别是最低的隔离级别，虽然拥有超高的并发处理能力及很低的系统开销，但很少用于实际应用。</li><li>该隔离级别只能解决第一类更新丢失问题，不能解决脏读、不可重复读、幻读的问题。</li></ul></li><li>(2) <strong>读已提交（Read Committed）</strong><ul><li>这是大多数数据库系统的默认隔离级别（但不是 MySQL 默认的），例如 Oracle 数据库。</li><li>该隔离级别满足了隔离的简单定义：<strong>一个事务只能看见已提交事务所做的改变</strong>。</li><li>该隔离级别可以解决脏读问题，但会出现不可重复读、幻读问题。</li></ul></li><li>(3) <strong>可重复读（Repeatable Read）</strong><ul><li>这是 MySQL 的默认事务隔离级别，<strong>它可以确保在整个事务过程中，对同一条数据的读取结果是相同的，不管其他事务是否在对共享数据进行更新，也不管其他事务更新提交与否</strong>。</li><li>该隔离级别可以解决脏读、不可重复读的问题，但会出现幻读问题。</li></ul></li><li>(4) <strong>串行化（Serializable）</strong><ul><li>这是最高的事务隔离级别，<strong>它通过强制事务排序，使之不可能相互冲突，从而解决脏读、不可重复读、幻读、第一类更新丢失、第二类更新丢失问题</strong>。</li><li>该隔离级别可以解决所有的事务并发问题，但可能导致大量的超时现象和锁竞争，通常数据库不会用这个隔离级别，可用其他的方案来解决这些问题，例如乐观锁和悲观锁。</li></ul></li></ul><hr><p>上述四种事务隔离级别会产生的并发问题如下（<code>YES</code> 表示存在对应的问题，<code>NO</code> 表示不存在对应的问题）：</p><p><img data-src="../../../asset/2026/01/db-isolate-level.png"></p><p>各种关系型数据库对事务隔离级别的支持程度如下（<code>YES</code> 表示支持，<code>NO</code> 表示不支持）：</p><table><thead><tr><th></th><th>Oracle</th><th>MySQL</th></tr></thead><tbody><tr><td>Read Uncommitted</td><td>NO</td><td>YES</td></tr><tr><td>Read Committed</td><td>YES（默认）</td><td>YES</td></tr><tr><td>Repeatable Read</td><td>NO</td><td>YES（默认）</td></tr><tr><td>Serializable</td><td>YES</td><td>YES</td></tr></tbody></table><div class="admonition note"><p class="admonition-title">提示</p><ul><li>在 Spring 框架中，事务隔离级别可以通过 <code>@Transactional</code> 注解中的 <code>isolation</code> 属性定义。</li><li>MySQL 的默认隔离级别是可重复读（Repeatable Read），而 Oracle 的默认隔离级别是读已提交（Read Committed）。</li></ul></div><h4 id="TCC-事务隔离级别的推演"><a href="#TCC-事务隔离级别的推演" class="headerlink" title="TCC 事务隔离级别的推演"></a>TCC 事务隔离级别的推演</h4><p><img data-src="../../../asset/2026/01/tcc-transaction-19.png"></p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="/posts/726e9aff.html">分布式事务解决方案介绍</a></li><li><a href="/posts/ebe034ff.html">分布式数据库技术选型介绍</a></li></ul><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/1625c614.html" title="基于 Hmily 实战 TCC 分布式事务之一">https://www.techgrow.cn/posts/1625c614.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="fa fa-tag"></i> 微服务</a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag"><i class="fa fa-tag"></i> 数据库</a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag"><i class="fa fa-tag"></i> 分布式</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/c86372a2.html" rel="prev" title="Hexo 博客导流微信公众号"><i class="fa fa-angle-left"></i> Hexo 博客导流微信公众号</a></div><div class="post-nav-item"> <a href="/posts/ed2e098d.html" rel="next" title="Java 多线程编程之三 volatile 与 JMM 内存模型">Java 多线程编程之三 volatile 与 JMM 内存模型<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2026</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">2.3m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">35:33</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"/lib/mathjax/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/js/third-party/math/mathjax.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/1625c614.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div><div id="moon-menu-item-code" class="moon-menu-item"><i class="fa-solid fa-code"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>