<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.13.0","exturl":false,"sidebar":{"position":"left","width":300,"display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍Spring Cloud Consul的基础使用，包括入门案例、服务发现、配置中心使用、重写核心类等内容。"><meta property="og:type" content="article"><meta property="og:title" content="Consul 入门教程 - 基础篇"><meta property="og:url" content="https://www.techgrow.cn/posts/29fe9682.html"><meta property="og:site_name" content="Clay 的技术博客"><meta property="og:description" content="本文主要介绍Spring Cloud Consul的基础使用，包括入门案例、服务发现、配置中心使用、重写核心类等内容。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/05/config-ui-services.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/05/config-ui-config.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/05/consul-discovery-setting.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/05/consul-discovery-result-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2020/05/consul-discovery-result-2.png"><meta property="article:published_time" content="2020-05-15T14:33:05.000Z"><meta property="article:modified_time" content="2020-05-15T14:33:05.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="微服务"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2020/05/config-ui-services.png"><link rel="canonical" href="https://www.techgrow.cn/posts/29fe9682.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/29fe9682.html","path":"posts/29fe9682.html","title":"Consul 入门教程 - 基础篇"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Consul 入门教程 - 基础篇 | Clay 的技术博客</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn:9360"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术博客" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax>!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><script data-ad-client="ca-pub-4014850419768221" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/app/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt></div><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术博客</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-openplatform"><a href="https://open.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-toolbox fa-fw"></i>开放平台</a></li><li class="menu-item menu-item-readingnotes"><a href="https://docs.techgrow.cn/notes/" rel="external nofollow" target="_blank"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn:9360/ui/login?lng=zh-cn" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Consul-%E4%BB%8B%E7%BB%8D"><span class="nav-text">Consul 介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Consul-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-text">Consul 是什么</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Consul-%E7%9A%84%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD"><span class="nav-text">Consul 的主要功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Consul-%E5%AE%89%E8%A3%85"><span class="nav-text">Consul 安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Consul-%E5%90%AF%E5%8A%A8"><span class="nav-text">Consul 启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Consul-%E5%AE%9E%E7%94%A8%E6%8E%A5%E5%8F%A3"><span class="nav-text">Consul 实用接口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Consul-%E7%AE%A1%E7%90%86%E5%91%BD%E4%BB%A4"><span class="nav-text">Consul 管理命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Consul-%E5%AF%B9%E5%A4%96%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3"><span class="nav-text">Consul 对外服务接口</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-Cloud-Consul-%E5%9F%BA%E7%A1%80"><span class="nav-text">Spring Cloud Consul 基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Cloud-Consul-%E4%BB%8B%E7%BB%8D"><span class="nav-text">Spring Cloud Consul 介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Cloud-Consul-%E5%85%A5%E9%97%A8%E6%A1%88%E4%BE%8B"><span class="nav-text">Spring Cloud Consul 入门案例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="nav-text">1. 版本说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%88%9B%E5%BB%BA-Maven-%E7%88%B6%E7%BA%A7-Pom-%E5%B7%A5%E7%A8%8B"><span class="nav-text">2. 创建 Maven 父级 Pom 工程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E5%88%9B%E5%BB%BA-Consul-Provider-%E5%B7%A5%E7%A8%8B"><span class="nav-text">3. 创建 Consul Provider 工程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E5%88%9B%E5%BB%BA-Consul-Consumer-%E5%B7%A5%E7%A8%8B"><span class="nav-text">4. 创建 Consul Consumer 工程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-%E5%88%9B%E5%BB%BA-Consul-Config-%E5%B7%A5%E7%A8%8B"><span class="nav-text">5. 创建 Consul Config 工程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="nav-text">6. 测试结果</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-Cloud-Consul-%E6%B7%B1%E5%85%A5"><span class="nav-text">Spring Cloud Consul 深入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Cloud-Consul-%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D"><span class="nav-text">Spring Cloud Consul 模块介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Cloud-Consul-Discovery"><span class="nav-text">Spring Cloud Consul Discovery</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="nav-text">基础配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E6%A1%88%E4%BE%8B"><span class="nav-text">服务发现案例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E5%88%9B%E5%BB%BA-Consul-Provider-Tag-One-%E5%B7%A5%E7%A8%8B"><span class="nav-text">1. 创建 Consul Provider Tag One 工程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E5%88%9B%E5%BB%BA-Consul-Provider-Tag-Two-%E5%B7%A5%E7%A8%8B"><span class="nav-text">2. 创建 Consul Provider Tag Two 工程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-%E5%88%9B%E5%BB%BA-Consul-Consumer-Ribbon-%E5%B7%A5%E7%A8%8B"><span class="nav-text">3. 创建 Consul Consumer Ribbon 工程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-%E5%88%9B%E5%BB%BA-Consul-Consumer-Discovery-Client-%E5%B7%A5%E7%A8%8B"><span class="nav-text">4. 创建 Consul Consumer Discovery Client 工程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="nav-text">5. 测试结果</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Cloud-Consul-Config"><span class="nav-text">Spring Cloud Consul Config</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E5%88%B7%E6%96%B0%E5%8E%9F%E7%90%86"><span class="nav-text">配置刷新原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE%EF%BC%88%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%EF%BC%89"><span class="nav-text">高级配置（作为配置中心）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Cloud-Consul-%E5%8A%9F%E8%83%BD%E9%87%8D%E5%86%99"><span class="nav-text">Spring Cloud Consul 功能重写</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%87%8D%E5%86%99-ConsulDiscoveryClient-%E6%94%AF%E6%8C%81-Tag"><span class="nav-text">重写 ConsulDiscoveryClient (支持 Tag)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%87%8D%E5%86%99-ConsulServerList"><span class="nav-text">重写 ConsulServerList</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="nav-text">原理分析</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%87%8D%E5%86%99%E7%A4%BA%E4%BE%8B"><span class="nav-text">重写示例</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-Cloud-Consul-%E7%9A%84%E5%9D%91"><span class="nav-text">Spring Cloud Consul 的坑</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E4%BF%A1%E6%81%AF%E4%B8%8D%E5%AE%8C%E6%95%B4"><span class="nav-text">异常信息不完整</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#consul-api-%E7%9A%84%E5%85%BC%E5%AE%B9%E9%97%AE%E9%A2%98"><span class="nav-text">consul-api 的兼容问题</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">388</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">41</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → &#x2F;sitemap.xml"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="external nofollow" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/29fe9682.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术博客"><meta itemprop="description" content="专注于 Java、前端、移动端、微服务、分布式系统、数据库、系统架构、人工智能、大数据、云计算、物联网、虚拟化学习的技术博客。"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Consul 入门教程 - 基础篇 | Clay 的技术博客"><meta itemprop="description" content="本文主要介绍Spring Cloud Consul的基础使用，包括入门案例、服务发现、配置中心使用、重写核心类等内容。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Consul 入门教程 - 基础篇</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-05-15 22:33:05" itemprop="dateCreated datePublished" datetime="2020-05-15T22:33:05+08:00">2020-05-15</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/29fe9682.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/29fe9682.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>11k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>10 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><div id="readmore-container"><h2 id="Consul-介绍"><a href="#Consul-介绍" class="headerlink" title="Consul 介绍"></a>Consul 介绍</h2><h3 id="Consul-是什么"><a href="#Consul-是什么" class="headerlink" title="Consul 是什么"></a>Consul 是什么</h3><p>作为集群系统的灵魂，服务治理框架一直都受架构师的青睐。随着微服务思想的普及，越来越多的服务治理框架如雨后春笋般冒了出来。除了 Eureka，HashiCorp 公司的 Consul 也让诸多架构师青睐有加。Consul 是一个分布式高可用的服务网格（service mesh）解决方案，提供包括服务发现、配置和分段功能在内的全功能控制平面。这些功能中的每一个都可以根据需要单独使用，也可以一起使用以构建完整的服务网格。简单来说，Consul 是一个分布式高可用的系统服务发现与配置工具，它跟 Eureka 的核心功能一样，但略有不同：</p><ul><li>Consul 使用 Go 语言编写，以 HTTP 方式对外提供服务</li><li> Consul 支持多数据中心，这是它的一大特色</li><li> Consul 提供了可视化的 Web 界面</li><li> Consul 的一致性协议是 CP（Raft）</li><li>Consul 除了服务发现之外，还有一些别的功能，例如配置功能</li></ul><span id="more"></span><h3 id="Consul-的主要功能"><a href="#Consul-的主要功能" class="headerlink" title="Consul 的主要功能"></a>Consul 的主要功能</h3><p>Consul 提供了以服务治理为核心的多种功能以满足分布式系统的需要，它可以作为服务治理组件和配置中心。当然，市场上还有很多其他类似功能的优秀框架，Consul 官方提供了<a target="_blank" rel="external nofollow" href="https://www.consul.io/intro/vs/index.html">对比信息</a>，以便架构师们在做技术选型时可以尽快找到更适合自己的方案。Consul 的主要功能如下，更多介绍可参考：<a target="_blank" rel="external nofollow" href="https://www.consul.io/">Consul 官网</a>、<a target="_blank" rel="external nofollow" href="https://github.com/hashicorp/consul">Consul 项目</a>、<a target="_blank" rel="external nofollow" href="https://www.springcloud.cc/spring-cloud-dalston.html#_spring_cloud_consul">Consul 中文教程</a>。</p><ul><li>服务发现：有了 Consul，服务可以通过 DNS 或者 HTTP 直接找到它所依赖的服务</li><li>健康检查：Consul 提供了健康检查的机制，从简单的服务端是否返回 200 的响应代码到较为复杂的内存使用率是否低于 90%</li><li>K/V 存储：应用程序可以根据需要使用 Consul 的 Key/Value 存储，Consul 提供了简单易用的 HTTP 接口来满足用户的动态配置、特征标记、协调、Leader 选举等需求</li><li>多数据中心：Consul 原生支持多数据中心，这意味着用户不用为了多数据中心自己做抽象</li></ul><h3 id="Consul-安装"><a href="#Consul-安装" class="headerlink" title="Consul 安装"></a>Consul 安装</h3><p>Consul 的安装比较简单，官方提供了二进制可执行文件，可以在<a target="_blank" rel="external nofollow" href="https://www.consul.io/downloads.html">官网</a>下载自己感兴趣的版本，安装步骤如下：</p><ul><li>将已下载的 <code>consul_l.2.0_linux_amd64.zip</code> 解压到 <code>/opt/consul/</code> 目录下</li><li>添加 consul 到 PATH（环境变量）</li><li>执行 <code>consul -v</code>，如果不报错，基本就算安装成功了</li></ul><h3 id="Consul-启动"><a href="#Consul-启动" class="headerlink" title="Consul 启动"></a>Consul 启动</h3><p>Consul 集群默认需要至少三台 Consul 启动，当有多个 Consul 节点启动了，那么它们会自动组成集群。如果只是想本地开发调试，可以使用开发者模式启动，数据默认保存在内存中。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用开发模式，启动consul</span></span><br><span class="line"><span class="keyword">$ consul</span> agent<span class="params"> -dev</span></span><br></pre></td></tr></tbody></table></figure><p>Consul 默认是没有 UI 界面的，如果需要展示 UI 界面，可以加上 <code>-ui</code> 参数进行启动，然后通过 <code>http://127.0.0.1:8500</code> 访问 UI 界面：</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$ consul</span> agent<span class="params"> -dev</span><span class="params"> -ui</span></span><br></pre></td></tr></tbody></table></figure><h3 id="Consul-实用接口"><a href="#Consul-实用接口" class="headerlink" title="Consul 实用接口"></a>Consul 实用接口</h3><p>Consul 对外提供了丰富的 API，有运维人员喜欢的命令行接口，也有开发人员喜欢的 HTTP 接口，常用的接口如下：</p><h4 id="Consul-管理命令"><a href="#Consul-管理命令" class="headerlink" title="Consul 管理命令"></a>Consul 管理命令</h4><ul><li>consul members：查看当前 Consul 集群里所有成员的信息以及它们的状态：存活、离线、启动失败</li><li> consul monitor：持续打印当前 Consul 的日志信息，这个命令很有用，因为 Consul 访问量比较大，所以生产环境一般不会保存日志，如果想查看实时日志，可以使用该命令</li><li> consul leave：退出集群，一般会使用这个命令而不是直接杀掉 Consul 的进程</li></ul><h4 id="Consul-对外服务接口"><a href="#Consul-对外服务接口" class="headerlink" title="Consul 对外服务接口"></a>Consul 对外服务接口</h4><ul><li>/v1/agent/members：列出集群内的所有成员及其信息</li><li> /v1/status/leader：显示当前集群 leader</li><li>/v1/catalog/services：显示当前注册的服务</li><li> /v1/kv/key：显示当前 Key 对应的 Value</li></ul><h2 id="Spring-Cloud-Consul-基础"><a href="#Spring-Cloud-Consul-基础" class="headerlink" title="Spring Cloud Consul 基础"></a>Spring Cloud Consul 基础</h2><h3 id="Spring-Cloud-Consul-介绍"><a href="#Spring-Cloud-Consul-介绍" class="headerlink" title="Spring Cloud Consul 介绍"></a>Spring Cloud Consul 介绍</h3><p>Spring Cloud Consul 通过自动配置、对 Spring Environment 绑定和其他惯用的 Spring 模块，为 Spring Boot 应用程序提供了 Consul 集成。只需要一些简单注解，就可以快速启用和配置 Consul，并用它来构建大型分布式系统。Spring Cloud Consul 作为 Spring Cloud 与 Consul 之间的桥梁，对二者都有良好的支持，其特性如下：</p><ul><li>服务注册发现，实例可以向 Consul 注册服务，客户端可以使用 Spring Bean 来发现服务提供方</li><li>支持 Ribbon 的客户端负载</li><li>支持 Zuul 服务网关</li><li>分布式配置中心，使用的是 Consul 的 K/V 存储</li><li>控制总线，使用的是 Consul Events</li></ul><h3 id="Spring-Cloud-Consul-入门案例"><a href="#Spring-Cloud-Consul-入门案例" class="headerlink" title="Spring Cloud Consul 入门案例"></a>Spring Cloud Consul 入门案例</h3><p>Spring Cloud Consul 提供了 bus、config、discovery 等模块，项目中可以根据具体的需要选择对应的模块。下面将演示如何使用 config、discovery 模块，<a href="/downloads/2020/05/consul-demo.zip">点击下载</a>完整的案例代码。</p><h4 id="1-版本说明"><a href="#1-版本说明" class="headerlink" title="1. 版本说明"></a>1. 版本说明</h4><p>在下面的的教程中，使用的 Spring Cloud 版本是 Finchley.RELEASE，对应的 Spring Boot 版本是 2.0.3。</p><h4 id="2-创建-Maven-父级-Pom-工程"><a href="#2-创建-Maven-父级-Pom-工程" class="headerlink" title="2. 创建 Maven 父级 Pom 工程"></a>2. 创建 Maven 父级 Pom 工程</h4><p>在父工程里面配置好工程需要的父级依赖，目的是为了更方便管理与简化配置，具体 Maven 配置如下：</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 利用传递依赖，公共部分 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 管理依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>Finchley.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--注意：这里需要添加以下配置，否则可能会有各种依赖问题 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/libs-milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h4 id="3-创建-Consul-Provider-工程"><a href="#3-创建-Consul-Provider-工程" class="headerlink" title="3. 创建 Consul Provider 工程"></a>3. 创建 Consul Provider 工程</h4><p>创建 Consul Provider 的 Maven 工程，配置工程里的 <code>pom.xml</code> 文件，引入 <code>spring-cloud-starter-consul-discovery</code>，将服务实例注册到 Consul：</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>创建 Consul Provider 的主启动类，这里可以缺省添加 <code>@EnableDiscoveryClient</code> 注解：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        SpringApplication.run(ProviderApplication.class, args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>创建 Consul Provider 的测试控制类，值得注意的是，在不引入 <code>spring-boot-starter-actuator</code> 依赖的情况下，必须手动创建 <code>/actuator/health</code> 接口，这是新版 Spring Cloud Consul 的默认注册健康检查接口，否则 Consul 会认为服务不可用：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${server.port}")</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/actuator/health")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">health</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SUCCESS"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/provider/sayHello")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String name)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"from port "</span> + port + <span class="string">": hello "</span> + name;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>添加 Consul Provider 需要的 <code>application.yml</code> 配置文件到工程中：</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consul-provider</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>    <span class="comment"># consul 地址</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span>         <span class="comment"># consul 端口</span></span><br></pre></td></tr></tbody></table></figure><h4 id="4-创建-Consul-Consumer-工程"><a href="#4-创建-Consul-Consumer-工程" class="headerlink" title="4. 创建 Consul Consumer 工程"></a>4. 创建 Consul Consumer 工程</h4><p>创建 Consul Consumer 的 Maven 工程，配置工程里的 <code>pom.xml</code> 文件，引入 <code>spring-cloud-starter-consul-discovery</code>，将服务实例注册到 Consul，同时引入 Feign：</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>创建 Consul Consumer 的主启动类，这里可以缺省添加 <code>@EnableDiscoveryClient</code> 注解：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        SpringApplication.run(ConsumerApplication.class, args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>创建 Consul Consumer 的服务接口类，用于调用 Provider 服务：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = "consul-provider")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = "/provider/sayHello", method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(<span class="meta">@RequestParam("name")</span> String name)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>创建 Consul Consumer 的测试控制类，在不引入 <code>spring-boot-starter-actuator</code> 依赖的情况下，必须手动创建 <code>/actuator/health</code> 接口，这是新版 Spring Cloud Consul 的默认注册健康检查接口，否则 Consul 会认为服务不可用：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HelloService helloService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/actuator/health")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">health</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SUCCESS"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/consumer/sayHello")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String name)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> helloService.sayHello(name);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>添加 Consul Consumer 需要的 <code>application.yml</code> 配置文件到工程中：</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9002</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consul-consumer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>    <span class="comment"># consul 地址</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span>         <span class="comment"># consul 端口</span></span><br></pre></td></tr></tbody></table></figure><h4 id="5-创建-Consul-Config-工程"><a href="#5-创建-Consul-Config-工程" class="headerlink" title="5. 创建 Consul Config 工程"></a>5. 创建 Consul Config 工程</h4><p>创建 Consul Config 的 Maven 工程，配置工程里的 <code>pom.xml</code> 文件，引入 <code>spring-cloud-starter-consul-config</code>；这里的 Consul Config 工程与上面的 Provider、Consumer 工程没有任何关系，作用是用来单独演示 Consul 的 Config 功能（配置中心）：</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>创建 Consul Config 的测试控制类：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/config")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${foo.bar.name}")</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/getName")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>添加 Consul Config 需要的 <code>application.yml</code> 配置文件到工程中：</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9003</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consul-config</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>    <span class="comment"># consul 地址</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span>         <span class="comment"># consul 端口</span></span><br></pre></td></tr></tbody></table></figure><h4 id="6-测试结果"><a href="#6-测试结果" class="headerlink" title="6. 测试结果"></a>6. 测试结果</h4><ol><li>启动本地的 consul 服务器</li><li>依次启动 consul-provider、consul-consumer 应用</li><li>访问 consul 的管理界面：<code>http://127.0.0.1:8500</code>，如果各个服务的 <code>Health Checks</code> 显示绿色的对勾，即表示服务注册成功，如下图所示：<br><img data-src="../../../asset/2020/05/config-ui-services.png" alt="config-ui-services"></li><li>访问 <code>http://127.0.0.1:9002/consumer/sayHello?name=Peter</code>，如果返回 <code>from port 9001: hello Peter</code>，说明 consul-provider、consul-consumer 应用一切运行成功</li><li>访问 <code>http://127.0.0.1:8500/ui/dc1/kv</code>，点击页面上的 <code>create</code> 按钮，在 <code>Key or folder</code> 栏输入 <code>config/consul-config/foo.bar.name</code>，<code>value</code> 栏输入 <code>book</code>，然后点击 <code>save</code> 按钮保存，如下图所示：<br><img data-src="../../../asset/2020/05/config-ui-config.png" alt="config-ui-config"></li><li>启动 consul-config 应用，访问 <code>http://127.0.0.1:9003/config/getName</code>，如果接口返回 <code>book</code>，说明成功访问到 Consul Config 的 Key/Value 存储</li></ol><h2 id="Spring-Cloud-Consul-深入"><a href="#Spring-Cloud-Consul-深入" class="headerlink" title="Spring Cloud Consul 深入"></a>Spring Cloud Consul 深入</h2><h3 id="Spring-Cloud-Consul-模块介绍"><a href="#Spring-Cloud-Consul-模块介绍" class="headerlink" title="Spring Cloud Consul 模块介绍"></a>Spring Cloud Consul 模块介绍</h3><p>Spring Cloud Consul 是在 ecwid 的 consul-api 的基础上又封装了一层功能，使其跟现有 Spring Cloud 组件融合，达到开箱即用的目的。围绕着 Consul 的核心功能，Spring Cloud Consul 也提供了相应的功能模块与之匹配，其中 Consul 的事件功能比较弱化，应用比较多的是服务治理和配置功能，各个模块的介绍如下：</p><ul><li>spring-cloud-consul-binder：对 Consul 的事件功能封装</li><li> spring-cloud-consul-config：对 Consul 的配置功能封装</li><li> spring-cloud-consul-core：基础配置和健康检查模块</li><li> spring-cloud-consul-discovery：对 Consul 服务治理功能封装</li></ul><h3 id="Spring-Cloud-Consul-Discovery"><a href="#Spring-Cloud-Consul-Discovery" class="headerlink" title="Spring Cloud Consul Discovery"></a>Spring Cloud Consul Discovery</h3><h4 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h4><p>服务启动时，会通过 <code>ConsulServiceRegistry.register（）</code> 向 Consul 注册自身的服务。服务注册时，会告诉 Consul 以下信息：</p><ul><li>ID：服务 ID，默认是服务名 + 端口号</li><li> Name：服务名，默认是应用名称</li><li> Tags：给服务打的标签，默认是 <code>[secure=false]</code></li><li>Address：服务地址，默认是本机 IP</li><li>Port：服务端口，默认是服务的 Web 端口</li><li> Check：健康检查信息，包括 Interval（健康检查间隔）和 HTTP（健康检查地址）</li></ul><p>一般情况下，不需要显式提供上述信息，Spring Cloud Consul 会有默认值，但是在一些特殊业务场景中，可能就需要定制上述服务了。Consul Discovery 的常见配置如下：</p><p><img data-src="../../../asset/2020/05/consul-discovery-setting.png" alt="consul-discovery-setting"></p><p>Tags 栏会有一个 <code>secure=false</code>，这个是 Spring Cloud Consul 默认加上的，它取自配置 <code>spring.cloud.consul.discovery.scheme</code>，默认值是 <code>http</code>。如果服务提供的是 <code>https</code> 的服务时，需要配置该值为 <code>https</code>，它的作用是告诉服务消费者调用服务方接口时需要哪种协议。配置示例如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义健康检测接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/health")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">health</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SUCCESS"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consul-provider</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>    <span class="comment"># consul 启动地址</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span>         <span class="comment"># consul 启动端口</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>       <span class="comment"># 优先使用 IP 注册</span></span><br><span class="line">        <span class="attr">ip-address:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>         <span class="comment"># 若部署在 Docker 中,指定宿主机 IP</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">9001</span>                    <span class="comment"># 若部署在 Docker 中,指定宿主机端口</span></span><br><span class="line">        <span class="attr">health-check-interval:</span> <span class="string">20s</span>    <span class="comment"># 健康检查间隔时间为 20s</span></span><br><span class="line">        <span class="attr">health-check-path:</span> <span class="string">/health</span>    <span class="comment"># 自定义健康检查路径</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">${LANG},test</span>            <span class="comment"># 指定服务的标签, 用逗号隔开</span></span><br></pre></td></tr></tbody></table></figure><h4 id="服务发现案例"><a href="#服务发现案例" class="headerlink" title="服务发现案例"></a>服务发现案例</h4><p>Spring Cloud Consul 提供了两种方式的服务发现功能：Ribbon 和 DiscoveryClient。如果客户端使用了 Feign 或者 <code>@LoadBalancerd</code> 注解，那么默认使用的是 <code>ConsulServerList</code> 提供的服务发现逻辑。如果客户端只想独立使用服务发现功能，那么可以直接使用 <code>DiscoveryClient</code>。上面提到了使用 Consul 的 Tags 功能将服务分组，下面就用上面说的两种方式分别调用服务提供者的接口，<a href="/downloads/2020/05/consul-discovery-demo.zip">点击下载</a>完整的案例代码，由于篇幅有限，以下只给出核心代码和配置。</p><h5 id="1-创建-Consul-Provider-Tag-One-工程"><a href="#1-创建-Consul-Provider-Tag-One-工程" class="headerlink" title="1. 创建 Consul Provider Tag One 工程"></a>1. 创建 Consul Provider Tag One 工程</h5><p>创建 Consul Provider Tag One 的主启动类：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderOneApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        SpringApplication.run(ProviderOneApplication.class, args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>创建 Consul Provider Tag One 的测试控制类：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderOneController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${server.port}")</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/actuator/health")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">health</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SUCCESS"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/provider/sayHello/{name}")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(<span class="meta">@PathVariable("name")</span> String name)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"from port "</span> + port + <span class="string">": hello "</span> + name;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>创建 Consul Provider Tag One 的 <code>application.yml</code> 配置文件，加入 <code>tags</code> 属性：</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consul-provider</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>    <span class="comment"># consul 启动地址</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span>         <span class="comment"># consul 启动端口</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">tag1</span></span><br></pre></td></tr></tbody></table></figure><h5 id="2-创建-Consul-Provider-Tag-Two-工程"><a href="#2-创建-Consul-Provider-Tag-Two-工程" class="headerlink" title="2. 创建 Consul Provider Tag Two 工程"></a>2. 创建 Consul Provider Tag Two 工程</h5><p>创建 Consul Provider Tag Two 的主启动类：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderTwoApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        SpringApplication.run(ProviderTwoApplication.class, args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>创建 Consul Provider Tag Two 的测试控制类：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderTwoController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${server.port}")</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/actuator/health")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">health</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SUCCESS"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/provider/sayHello/{name}")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(<span class="meta">@PathVariable("name")</span> String name)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"from port "</span> + port + <span class="string">": hello "</span> + name;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>创建 Consul Provider Tag Two 的 <code>application.yml</code> 配置文件，加入 <code>tags</code> 属性：</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9002</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consul-provider</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>    <span class="comment"># consul 启动地址</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span>         <span class="comment"># consul 启动端口</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">tag2</span></span><br></pre></td></tr></tbody></table></figure><h5 id="3-创建-Consul-Consumer-Ribbon-工程"><a href="#3-创建-Consul-Consumer-Ribbon-工程" class="headerlink" title="3. 创建 Consul Consumer Ribbon 工程"></a>3. 创建 Consul Consumer Ribbon 工程</h5><p>创建 Consul Consumer Ribbon 的主启动类：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerRibbonApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        SpringApplication.run(ConsumerRibbonApplication.class, args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>创建 Consul Consumer Ribbon 的服务接口类，用于调用 Provider 服务：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient("consul-provider")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProviderService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = "/provider/sayHello/{name}", method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(<span class="meta">@PathVariable("name")</span> String name)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>创建 Consul Consumer Ribbon 的基础配置类，声明 RestTemplate 的 Bean 对象：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonConfiguration</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>创建 Consul Consumer Ribbon 的测试控制类，建立两个 REST 接口，一个通过 Feign 的方式访问 Provider，另一个通过 RestTemplate 的方式访问 Provider：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerRibbonController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL = <span class="string">"http://consul-provider"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProviderService providerService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/actuator/health")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">health</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SUCCESS"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/consumer/sayHelloOne/{name}")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHelloOne</span><span class="params">(<span class="meta">@PathVariable("name")</span> String name)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> providerService.sayHello(name);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/consumer/sayHelloTwo/{name}")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHelloTwo</span><span class="params">(<span class="meta">@PathVariable("name")</span> String name)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(URL + <span class="string">"/provider/sayHello/"</span> + name, String.class);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>创建 Consul Consumer Ribbon 的 <code>application.yml</code> 配置文件：</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9003</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consul-consumer-ribbon</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>    <span class="comment"># consul 启动地址</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span>         <span class="comment"># consul 启动端口</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-list-query-tags:</span></span><br><span class="line">          <span class="attr">consul-provider:</span> <span class="string">tag1</span>       <span class="comment"># 在调用 consul-provider 服务时，使用 tag1 对应的服务实例</span></span><br></pre></td></tr></tbody></table></figure><h5 id="4-创建-Consul-Consumer-Discovery-Client-工程"><a href="#4-创建-Consul-Consumer-Discovery-Client-工程" class="headerlink" title="4. 创建 Consul Consumer Discovery Client 工程"></a>4. 创建 Consul Consumer Discovery Client 工程</h5><p>创建 Consul Consumer Discovery Client 的主启动类：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscoveryClientApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        SpringApplication.run(DiscoveryClientApplication.class, args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>创建 Consul Consumer Discovery Client 的测试控制类，使用 <code>DiscoveryClient</code> 注入的方式，手动去 Consul 中获取服务列表；这里需要说明的是，ConsulDiscoveryClient 中不支持根据自定义 Tags 获取服务提供者：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/actuator/health")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">health</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SUCCESS"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/getServer/{serviceId}")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ServiceInstance&gt; <span class="title">getServer</span><span class="params">(<span class="meta">@PathVariable("serviceId")</span> String serviceId)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> discoveryClient.getInstances(serviceId);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>创建 Consul Consumer Discovery Client 的 <code>application.yml</code> 配置文件：</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9004</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consul-consumer-discovery-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>    <span class="comment"># consul 启动地址</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span>         <span class="comment"># consul 启动端口</span></span><br></pre></td></tr></tbody></table></figure><h5 id="5-测试结果"><a href="#5-测试结果" class="headerlink" title="5. 测试结果"></a>5. 测试结果</h5><ol><li>启动本地的 Consul 服务器，打开 Consul 的管理界面，查看服务的注册情况，如下图所示：<br><img data-src="../../../asset/2020/05/consul-discovery-result-1.png" alt="consul-discovery-result-1"></li><li>依次启动 consul-provider-tag-one、consul-provider-tag-two、consul-consumer-discovery-client、consul-consumer-ribbon 应用</li><li>请求 consul-consumer-ribbon 应用的 Feign 接口，访问 <code>http://127.0.0.1:9003/consumer/sayHelloOne/Jim</code>，查看返回的内容是否为 <code>from port 9001: hello Jim</code></li><li>请求 consul-consumer-ribbon 应用的 RestTemplate 接口，访问 <code>http://127.0.0.1:9003/consumer/sayHelloTwo/Peter</code>，查看返回的内容是否为 <code>from port 9001: hello Peter</code></li><li>请求 consul-consumer-discovery-client 应用的接口，访问 <code>http://127.0.0.1:9004/getServer/consul-provider</code>，查看返回的服务提供者信息是否只有 <code>consul-provider</code> 提供者，如下图所示：<br><img data-src="../../../asset/2020/05/consul-discovery-result-2.png" alt="consul-discovery-result-2"></li></ol><h3 id="Spring-Cloud-Consul-Config"><a href="#Spring-Cloud-Consul-Config" class="headerlink" title="Spring Cloud Consul Config"></a>Spring Cloud Consul Config</h3><p><a href="/posts/29fe9682.html#5-chuang-jian-consul-config-gong-cheng">上面的示例</a>演示了 Spring Cloud Consul Config 获取和刷新配置的简单用法。Spring Cloud Consul Config 与 Consul 是通过 HTTP 进行交互的，那配置刷新是如何做到的呢？另外，示例中只有一条配置，可是实际工作中的配置可能有成百上千条，难道配置信息需要一个个在 Consul 的管理页面中添加吗？</p><h4 id="配置刷新原理"><a href="#配置刷新原理" class="headerlink" title="配置刷新原理"></a>配置刷新原理</h4><p>Spring Cloud Consul 是通过 HTTP 的方式跟 Consul 交互，那配置是如何实时生效的呢？答案其实很简单，那就是配置并没有实时生效。<code>org.springframework.cloud.consul.config.ConfigWatch</code> 中有一个定时方法 <code>watchConfigKeyValues()</code>，它默认每秒执行一次（可以通过 <code>spring.cloud.consul.config.watch.delay</code> 自定义执行的时间间隔)，去 Consul 中获取最新的配置信息，一旦配置发生改变，Spring 通过 <code>ApplicationEventPublisher</code> 重新刷新配置。Consul Config 组件就是通过这种方式，达到配置 “实时生效” 的目的。那客户端如何得知配置被更新过了呢，答案在 Consul 返回的数据里。Consul 会给每一项配置加一个 <code>consulIndex</code> 属性，类似于版本号，如果配置更新，它就会自增。Spring Cloud Consul Config 就是通过缓存 <code>consulIndex</code> 来判断配置是否发生改变。</p><h4 id="高级配置（作为配置中心）"><a href="#高级配置（作为配置中心）" class="headerlink" title="高级配置（作为配置中心）"></a>高级配置（作为配置中心）</h4><p>Consul 只支持用 K/V 的方式进行配置，那怎么让 Consul 支持同时配置多条的方式呢？难道要给 Consul 增加一个导入功能吗？其实 K/V 不仅可以代表一条配置，还可以代表一个应用的配置，将应用名作为 Key，Value 中用来存放它所有的配置，这样就可以达到同时配置多条的结果。Spring Cloud Consul Config 就是这样，通过将 yml 或者 properties 放在 Value 中来实现配置的批量操作。下面的示例将演示使用 Consul 的配置功能，将整个应用的配置以 yml 的方式存储在 Consul 中，以此实现类似 Spring Cloud Config 的配置中心功能，<a href="/downloads/2020/05/consul-config-customize.zip">点击下载</a>完整的案例代码。</p><p>创建 Consul Config Customize 工程，配置工程里的 <code>pom.xml</code> 文件：</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>创建 Consul Config Customize 的主启动类：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        SpringApplication.run(ConfigApplication.class, args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>创建 Consul Config Customize 的测试控制类：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/config")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${foo.bar.name}")</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/getName")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>创建 Consul Config Customize 的 <code>application.yml</code> 配置文件：</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consul-config-customize</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></tbody></table></figure><p>创建 Consul Config Customize 的 <code>bootstrap.yml</code> 配置文件，增加自定义的配置属性：</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>           <span class="comment"># Consul 启动地址</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8500</span>                <span class="comment"># Consul 启动端口</span></span><br><span class="line">        <span class="attr">format:</span> <span class="string">yaml</span>              <span class="comment"># Consul 中 Value 配置格式为 yaml</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">configuration</span>     <span class="comment"># Consul 中配置文件目录为 configuration, 默认为 config</span></span><br><span class="line">        <span class="attr">default-context:</span> <span class="string">app</span>      <span class="comment"># 去该目录下查找缺省配置, 默认为 application</span></span><br><span class="line">        <span class="attr">profile-separator:</span> <span class="string">':'</span>    <span class="comment"># profiles配置分隔符, 默认为‘,’</span></span><br><span class="line">        <span class="attr">data-key:</span> <span class="string">data</span>            <span class="comment"># 如果指定配置格式为 yaml 或者 properties, 则需要该值作为key, 默认为 data</span></span><br></pre></td></tr></tbody></table></figure><p>测试结果：</p><ol><li>启动本地的 Consul 服务器</li><li>访问 <code>http://127.0.0.1:8500/ui/dc1/kv</code> 页面，添加 key 为：<code>configuration/consul-config-customize:dev/data</code>，value 为：</li></ol><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9002</span></span><br><span class="line"><span class="attr">foo:</span></span><br><span class="line">  <span class="attr">bar:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">book-dev</span></span><br></pre></td></tr></tbody></table></figure><ol start="3"><li>访问 <code>http://127.0.0.1:8500/ui/dc1/kv</code> 页面，添加 key 为：<code>configuration/consul-config-customize:test/data</code>，value 为：</li></ol><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9003</span></span><br><span class="line"><span class="attr">foo:</span></span><br><span class="line">  <span class="attr">bar:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">book-test</span></span><br></pre></td></tr></tbody></table></figure><ol start="4"><li>启动 consul-config-customize 应用，查看启动的端口号；访问 <code>http://127.0.0.1:9002/config/getName</code>，查看接口返回的内容</li><li>更改 <code>application.yml</code> 中的配置为 <code>spring.profiles.active=test</code></li><li>重新启动 consul-config-customize 应用，查看启动的端口号；访问 <code>http://127.0.0.1:9003/config/getName</code>，查看接口返回的内容</li></ol><h3 id="Spring-Cloud-Consul-功能重写"><a href="#Spring-Cloud-Consul-功能重写" class="headerlink" title="Spring Cloud Consul 功能重写"></a>Spring Cloud Consul 功能重写</h3><p>Spring Cloud Consul 提供了很多方便实用的功能，但是面对五花八门的需求，还是希望可以重写它的原有逻辑。</p><h4 id="重写-ConsulDiscoveryClient-支持-Tag"><a href="#重写-ConsulDiscoveryClient-支持-Tag" class="headerlink" title="重写 ConsulDiscoveryClient (支持 Tag)"></a>重写 ConsulDiscoveryClient (支持 Tag)</h4><p>ConsulDiscoveryClient 并不支持根据自定义 Tag 获取服务，一般来说，ConsulServerList 和 ConsulDiscoveryClient 虽然面对的需求不同，但是实现的功能都是一样的，那就是根据条件查找服务。可能 Spring 认为 ConsulDiscoveryClient 是为一些框架型的功能准备的，用户完全可以拿到服务列表后自行筛选所需的数据。下面的示例将重写 ConsulDiscoveryClient 的功能，让其支持根据自定义 Tag 获取服务。首先创建三个工程，分别是：consul-provider-tag-one、consul-provider-tag-two、consul-consumer-override，其中前两个工程与上面的<a href="/posts/29fe9682.html#fu-wu-fa-xian-an-li">服务发现案例</a>里的配置和代码完全一致，这里不再累述，<a href="/downloads/2020/05/consul-override-demo.zip">点击下载</a>完整的案例代码。</p><p>Consul Consumer Override 工程里的 MyConsulDiscoveryClient 类：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConsulDiscoveryClient</span> <span class="keyword">implements</span> <span class="title">DiscoveryClient</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConsulClient client;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConsulDiscoveryProperties properties;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyConsulDiscoveryClient</span><span class="params">(ConsulClient client, ConsulDiscoveryProperties properties)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.client = client;</span><br><span class="line">        <span class="keyword">this</span>.properties = properties;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">description</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Spring Cloud Consul Discovery Client"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ServiceInstance&gt; <span class="title">getInstances</span><span class="params">(<span class="keyword">final</span> String serviceId)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> getInstances(serviceId, QueryParams.DEFAULT);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ServiceInstance&gt; <span class="title">getInstances</span><span class="params">(<span class="keyword">final</span> String serviceId, <span class="keyword">final</span> QueryParams queryParams)</span> </span>{</span><br><span class="line">        List&lt;ServiceInstance&gt; instances = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        addInstancesToList(instances, serviceId, queryParams);</span><br><span class="line">        <span class="keyword">return</span> instances;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addInstancesToList</span><span class="params">(List&lt;ServiceInstance&gt; instances, String serviceId, QueryParams queryParams)</span> </span>{</span><br><span class="line">        String aclToken = properties.getAclToken();</span><br><span class="line">        Response&lt;List&lt;HealthService&gt;&gt; services;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(aclToken)) {</span><br><span class="line">            <span class="comment">// 这里由获取默认tag改为获取指定tag</span></span><br><span class="line">            services = client.getHealthServices(serviceId, getTag(serviceId), <span class="keyword">this</span>.properties.isQueryPassing(), queryParams, aclToken);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 这里由获取默认tag改为获取指定tag</span></span><br><span class="line">            services = client.getHealthServices(serviceId, getTag(serviceId), <span class="keyword">this</span>.properties.isQueryPassing(), queryParams);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">for</span> (HealthService service : services.getValue()) {</span><br><span class="line">            String host = ConsulServerUtils.findHost(service);</span><br><span class="line">            Map&lt;String, String&gt; metadata = ConsulServerUtils.getMetadata(service);</span><br><span class="line">            <span class="keyword">boolean</span> secure = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (metadata.containsKey(<span class="string">"secure"</span>)) {</span><br><span class="line">                secure = Boolean.parseBoolean(metadata.get(<span class="string">"secure"</span>));</span><br><span class="line">            }</span><br><span class="line">            instances.add(<span class="keyword">new</span> DefaultServiceInstance(serviceId, host, service.getService().getPort(), secure, metadata));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ServiceInstance&gt; <span class="title">getAllInstances</span><span class="params">()</span> </span>{</span><br><span class="line">        List&lt;ServiceInstance&gt; instances = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        Response&lt;Map&lt;String, List&lt;String&gt;&gt;&gt; services = client.getCatalogServices(QueryParams.DEFAULT);</span><br><span class="line">        <span class="keyword">for</span> (String serviceId : services.getValue().keySet()) {</span><br><span class="line">            addInstancesToList(instances, serviceId, QueryParams.DEFAULT);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> instances;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getServices</span><span class="params">()</span> </span>{</span><br><span class="line">        String aclToken = properties.getAclToken();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(aclToken)) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;&gt;(client.getCatalogServices(QueryParams.DEFAULT, aclToken).getValue().keySet());</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;&gt;(client.getCatalogServices(QueryParams.DEFAULT).getValue().keySet());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取tag的方法，该方法在 ConsulServerList 中已存在</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getTag</span><span class="params">(String serviceId)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.properties.getQueryTagForService(serviceId);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Consul Consumer Override 工程里的配置类：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonConfiguration</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Order(Ordered.HIGHEST_PRECEDENCE)</span> <span class="comment">// 保证优先被Spring加载</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyConsulDiscoveryClient <span class="title">discoveryClient</span><span class="params">(ConsulClient client, ConsulDiscoveryProperties properties)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyConsulDiscoveryClient(client, properties);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Consul Consumer Override 工程里的测试控制类：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/actuator/health")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">health</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SUCCESS"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/getServer/{serviceId}")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ServiceInstance&gt; <span class="title">getServer</span><span class="params">(<span class="meta">@PathVariable("serviceId")</span> String serviceId)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> discoveryClient.getInstances(serviceId);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Consul Consumer Override 工程里的 <code>application.yml</code> 配置文件：</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9004</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consul-consumer-discovery-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>    <span class="comment"># consul 启动地址</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span>         <span class="comment"># consul 启动端口</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-list-query-tags:</span></span><br><span class="line">          <span class="attr">consul-provider:</span> <span class="string">tag1</span>     <span class="comment"># 在调用 consul-provider 服务时，使用 tag1 对应的服务实例</span></span><br></pre></td></tr></tbody></table></figure><p>测试结果：</p><ol><li>启动本地的 Consul 服务器</li><li>依次启动 consul-provider-tag-one、consul-provider-tag-two、consul-consumer-override 应用</li><li>访问 <code>http://127.0.0.1:9004/getServer/consul-provider</code>，查看接口返回的信息，看看是否只返回了 tag1 对应的服务实例</li></ol><h4 id="重写-ConsulServerList"><a href="#重写-ConsulServerList" class="headerlink" title="重写 ConsulServerList"></a>重写 ConsulServerList</h4><h5 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h5><p>单纯的自定义实现 ServerList 的接口并不能达到重写 ConsulServerList 的目的，是因为 ConsulServerList 的 <code>serviceId</code> 属性为 <code>null</code> 时会导致启动报错。这个 <code>serviceId</code> 属性表示服务提供者的名称，但是却作为 ConsulServerList 的成员变量。由此可以联想到，Spring Cloud Consul 为每个服务提供者都创建了一个 ConsulServerList 实例，这是为了支持 Ribbon 的服务配置个性化。Ribbon 支持对某一个服务单独配置负载，比如负载算法，是否重试等，当然也包括服务发现逻辑，为每一个服务实例化一个服务发现逻辑，可以最大化地将自由交给实现方。特别注意，ConsulServerList 并不是在 Spring 启动的时候初始化，而是在服务调用时通过 Ribbon 进行初始化，具体的初始化流程如下：</p><ul><li>Feign 通过 <code>serviceId</code> 去 Ribbon 中获取服务端配置</li><li> Ribbon 根据 <code>serviceId</code> 去缓存中找是否存在这个名称的 AnnotationConfigApplicationContext 实例，如果有就立即返回；如果没有就创建一个，而创建 AnnotationConfigApplicationContext 的过程，就是 ConsulServerList 初始化的过程</li><li> AnnotationConfigApplicationContext 跟 ConsulServerList 是通过 <code>@RibbonClient</code> 注解关联在一起的，具体可以参考 RibbonClientConfigurationRegistrar 源码</li></ul><p>所以重写 ConsulServerList 的过程比较麻烦，要么重新写一套类似的 spring-cloud-consul-discovery 源码，要么就从源头的 RibbonClientConfiguration 开始直到 ConsulServerList 均改成自己的实现。</p><h5 id="重写示例"><a href="#重写示例" class="headerlink" title="重写示例"></a>重写示例</h5><p>下面的示例将使用第二种方式重写 ConsulServerList，首先创建三个工程，分别是：consul-provider-tag-one、consul-provider-tag-two、consul-consumer-override，其中前两个工程与上面的<a href="/posts/29fe9682.html#fu-wu-fa-xian-an-li">服务发现案例</a>里的配置和代码完全一致，这里不再累述，<a href="/downloads/2020/05/consul-override-demo-2.zip">点击下载</a>完整的案例代码。值得一提的是，在 Consul Consumer Override 工程里新增 MyConsulServerList、MyConsulRibbonClientConfiguration、MyRibbonConsulAutoConfiguration 类，需要保证 MyConsulRibbonClientConfiguration 类不能与被 <code>@ConponentScan</code> 修饰的主类放在同一个包或其子包下，否则会导致 IClientConfig 的 Bean 无法注入。</p><p>Consul Consumer Override 工程里的 MyConsulServerList 类：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConsulServerList</span> <span class="keyword">extends</span> <span class="title">AbstractServerList</span>&lt;<span class="title">ConsulServer</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String serviceId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConsulClient client;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConsulDiscoveryProperties properties;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(MyConsulServerList.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyConsulServerList</span><span class="params">(ConsulClient client, ConsulDiscoveryProperties properties)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.client = client;</span><br><span class="line">        <span class="keyword">this</span>.properties = properties;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 打印一句提示</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;ConsulServer&gt; <span class="title">getServers</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.client == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"===== 自定义服务发现 ====="</span>);</span><br><span class="line"></span><br><span class="line">        String tag = getTag(); <span class="comment">// null is ok</span></span><br><span class="line">        Response&lt;List&lt;HealthService&gt;&gt; response = <span class="keyword">this</span>.client.getHealthServices(</span><br><span class="line">                <span class="keyword">this</span>.serviceId, tag, <span class="keyword">this</span>.properties.isQueryPassing(),</span><br><span class="line">                createQueryParamsForClientRequest(), <span class="keyword">this</span>.properties.getAclToken());</span><br><span class="line">        <span class="keyword">if</span> (response.getValue() == <span class="keyword">null</span> || response.getValue().isEmpty()) {</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> transformResponse(response.getValue());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略其他代码 ....</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Consul Consumer Override 工程里的 MyConsulRibbonClientConfiguration 类：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConsulRibbonClientConfiguration</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ConsulClient client;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String serviceId = <span class="string">"client"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String VALUE_NOT_SET = <span class="string">"__not__set__"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_NAMESPACE = <span class="string">"ribbon"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyConsulRibbonClientConfiguration</span><span class="params">()</span> </span>{</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyConsulRibbonClientConfiguration</span><span class="params">(String serviceId)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.serviceId = serviceId;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将ServerList生效的实现改为MyServerList</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> config</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> properties</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> ServerList&lt;?&gt; ribbonServerList(IClientConfig config, ConsulDiscoveryProperties properties) {</span><br><span class="line">        MyConsulServerList serverList = <span class="keyword">new</span> MyConsulServerList(client, properties);</span><br><span class="line">        serverList.initWithNiwsConfig(config);</span><br><span class="line">        <span class="keyword">return</span> serverList;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略其他代码 ....</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Consul Consumer Override 工程里的 MyRibbonConsulAutoConfiguration 类：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 该类主要是将原有入口取代, 因此它的生效逻辑刚好跟 RibbonConsulAutoConfiguration 相反</span></span><br><span class="line"><span class="comment"> * 当 spring.cloud.consul.ribbon.enabled 为 false 时, 这里重写的逻辑生效</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnConsulEnabled</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(SpringClientFactory.class)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(RibbonAutoConfiguration.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnExpression("${spring.cloud.consul.ribbon.enabled:true}==false")</span></span><br><span class="line"><span class="meta">@RibbonClients(defaultConfiguration = MyConsulRibbonClientConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRibbonConsulAutoConfiguration</span> </span>{</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>在 Consul Consumer Override 工程里里创建 <code>/src/main/resources/META-INF/spring.factories</code> 配置文件，添加上面的自动配置类：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">  com.springcloud.override.consul.MyRibbonConsulAutoConfiguration</span><br></pre></td></tr></tbody></table></figure><p>Consul Consumer Override 工程里的启动主类：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerOverrideApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        SpringApplication.run(ConsumerOverrideApplication.class, args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Consul Consumer Override 工程里的服务接口类，用于调用 Provider 服务：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient("consul-provider")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProviderService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = "/provider/sayHello/{name}", method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(<span class="meta">@PathVariable("name")</span> String name)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Consul Consumer Override 工程里的测试控制类：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProviderService providerService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/actuator/health")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">health</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SUCCESS"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/sayHello/{name}")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getServer</span><span class="params">(<span class="meta">@PathVariable("name")</span> String name)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> providerService.sayHello(name);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Consul Consumer Override 工程里的 <code>application.yml</code></p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9004</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consul-consumer-discovery-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>    <span class="comment"># consul 启动地址</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span>         <span class="comment"># consul 启动端口</span></span><br><span class="line">      <span class="attr">ribbon:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span>   <span class="comment"># 此处配置很重要,为 true 时走原有逻辑, 为 false 时走重写逻辑</span></span><br></pre></td></tr></tbody></table></figure><p>测试结果：</p><ol><li>启动本地的 Consul 服务器</li><li>依次启动 consul-provider-tag-one、consul-provider-tag-two、consul-consumer-override 应用</li><li>访问 <code>http://127.0.0.1:9004/sayHello/Peter</code>，查看接口是否正常返回内容，控制台输出的日志信息如下：</li></ol><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c.netflix.loadbalancer.BaseLoadBalancer  : Client: consul-provider instantiated a LoadBalancer: DynamicServerListLoadBalancer:{NFLoadBalancer:name=consul ...</span><br><span class="line">c.n.l.DynamicServerListLoadBalancer      : Using serverListUpdater PollingServerListUpdater</span><br><span class="line">c.s.override.consul.MyConsulServerList   : ===== 自定义服务发现 =====</span><br><span class="line">c.netflix.config.ChainedDynamicProperty  : Flipping property: consul-provider.ribbon.ActiveConnectionsLimit to use NEXT property: niws.loadbalancer.availabilityFilteringRule.activeConnectionsLimit = 2147483647</span><br></pre></td></tr></tbody></table></figure><ol start="4"><li>多次访问 <code>http://127.0.0.1:9004/sayHello/Peter</code>，通过接口返回的服务方端口号，看看客户端是不是默认以轮询的方式调用服务方的接口</li></ol><h2 id="Spring-Cloud-Consul-的坑"><a href="#Spring-Cloud-Consul-的坑" class="headerlink" title="Spring Cloud Consul 的坑"></a>Spring Cloud Consul 的坑</h2><h3 id="异常信息不完整"><a href="#异常信息不完整" class="headerlink" title="异常信息不完整"></a>异常信息不完整</h3><p>开发者偶尔会遇到 Spring Cloud Consul 打印的异常堆栈中，message 为 null 的情况，导致排查问题异常困难，这是因为 Spring Cloud Consul 对 consul-api 自定义的 OperationException 异常没有做特殊处理导致的。当 Consul 的 HTTP 响应代码为非 200 时，consul-api 会抛出 OperationException；而 Spring Cloud Consul 在调用 consul-api 接口时，有些代码会简单地使用 Exception 捕获异常，然后打印 Log 日志，导致 OperationException 的属性丢失。例如在 ConsulCatalogWatch、ConsulHealthIndicator 中均使用这种处理方式。</p><h3 id="consul-api-的兼容问题"><a href="#consul-api-的兼容问题" class="headerlink" title="consul-api 的兼容问题"></a>consul-api 的兼容问题</h3><p>Consul 在 1.0.0 版本后，将一些接口（/agent/check/pass，/agent/service/deregister）由 GET 方法改成 PUT，这个 bug 在 consul-api 的 1.3.0 版本才得到解决，对应到 Spring Cloud Consul 已经是 2.0.0.M1 版本了。</p></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script>var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if(!isMobile)try{var plugin=new ReadmorePlugin;plugin.init({id:"readmore-container",blogId:"96641-5333172926158-056",name:"全栈技术驿站",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",lockToc:"yes",type:"hexo",random:"0.9",interval:"30",expires:"365",height:"auto"})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>坚持原创技术分享，您的支持将鼓励我继续创作！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/29fe9682.html" title="Consul 入门教程 - 基础篇">https://www.techgrow.cn/posts/29fe9682.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎加入微信群</span><br> <img src="/img/wx-group-qr-technology.png"></div></div></div><div class="post-tags"><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="fa fa-tag"></i> 微服务</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/1f8b78c4.html" rel="prev" title="Linux 安装 Robo 3T（Robomongo）"><i class="fa fa-chevron-left"></i> Linux 安装 Robo 3T（Robomongo）</a></div><div class="post-nav-item"> <a href="/posts/ec48bc77.html" rel="next" title="Gateway 入门教程 - 基础篇">Gateway 入门教程 - 基础篇<i class="fa fa-chevron-right"></i></a></div></div><div style="text-align:center"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4014850419768221" data-ad-slot="7586134725" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright &copy; 2018 – <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">762k</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 &asymp;</span> <span title="站点阅读时长">11:32</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="beian"> <span><img src="/img/gonganbeian.png" alt></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备19024664号</a></span></div></div></footer><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-tu9j5pBilBQrWSDePOOajCUdz6hWsid/lBNzK4KgEPM="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"/lib/mermaid/dist/mermaid.min.js","integrity":"sha256-ZfzwelSToHk5YAcr9wbXAmWgyn9Jyq08fSLrLhZE89w="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://unpkg.com/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '32px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://unpkg.com/qiniu-js@3.3.1/dist/qiniu.min.js"></script><script>
    var qiniu_domain = "https://qiniu.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/app/api/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn:9360","cssUrl":"https://unpkg.com/@waline/client@2.5.1/dist/waline.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://unpkg.com/@waline/client@2.5.1/dist/waline.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://unpkg.com/@waline/emojis@1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://qiniu.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/app/api/qiniu/token/upload","el":"#waline","comment":true,"path":"/posts/29fe9682.html"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@2.5.1/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>