<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍 Java 的 ThreadLocal 使用教程。"><meta property="og:type" content="article"><meta property="og:title" content="Java 多线程编程之九 ThreadLocal 使用"><meta property="og:url" content="https://www.techgrow.cn/posts/d016a303.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍 Java 的 ThreadLocal 使用教程。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/08/threadlocal-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/08/threadlocal-4.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/08/threadlocal-1.png"><meta property="article:published_time" content="2023-04-02T14:34:42.000Z"><meta property="article:modified_time" content="2024-08-12T14:34:42.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="Java"><meta property="article:tag" content="并发编程"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2024/08/threadlocal-3.png"><link rel="canonical" href="https://www.techgrow.cn/posts/d016a303.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/d016a303.html","path":"posts/d016a303.html","title":"Java 多线程编程之九 ThreadLocal 使用"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Java 多线程编程之九 ThreadLocal 使用 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/app/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ThreadLocal-%E7%9A%84%E4%BB%8B%E7%BB%8D"><span class="nav-text">ThreadLocal 的介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ThreadLocal-%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-text">ThreadLocal 的作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ThreadLocal-%E7%9A%84%E7%BC%BA%E7%82%B9"><span class="nav-text">ThreadLocal 的缺点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ThreadLocal-%E7%9A%84%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">ThreadLocal 的适用场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ThreadLocal-%E7%9A%84%E6%A0%B8%E5%BF%83-API"><span class="nav-text">ThreadLocal 的核心 API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ThreadLocal-%E7%9A%84%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="nav-text">ThreadLocal 的使用案例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ThreadLocal-%E7%9A%84%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98"><span class="nav-text">ThreadLocal 的使用问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E9%97%AE%E9%A2%98"><span class="nav-text">内存泄漏问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%A4%8D%E7%94%A8%E9%97%AE%E9%A2%98"><span class="nav-text">线程池的线程复用问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%BF%E9%87%8C%E5%B7%B4%E5%B7%B4%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C"><span class="nav-text">阿里巴巴开发手册</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E9%94%99%E8%AF%AF%E4%BD%BF%E7%94%A8"><span class="nav-text">线程池的错误使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8"><span class="nav-text">线程池的正确使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%88%B6%E5%AD%90%E7%BA%BF%E7%A8%8B%E6%97%A0%E6%B3%95%E5%85%B1%E4%BA%AB%E4%BC%A0%E9%80%92%E9%97%AE%E9%A2%98"><span class="nav-text">父子线程无法共享传递问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ThreadLocal-%E7%9A%84%E7%9B%B8%E5%85%B3%E7%B1%BB"><span class="nav-text">ThreadLocal 的相关类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%88%B6%E5%AD%90%E7%BA%BF%E7%A8%8B%E5%85%B1%E4%BA%AB%E4%BC%A0%E9%80%92%E9%97%AE%E9%A2%98"><span class="nav-text">父子线程共享传递问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%88%B6%E5%AD%90%E7%BA%BF%E7%A8%8B%E5%85%B1%E4%BA%AB%E4%BC%A0%E9%80%92%E8%A7%A3%E5%86%B3"><span class="nav-text">父子线程共享传递解决</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#InheritableThreadLocal-%E4%BD%BF%E7%94%A8"><span class="nav-text">InheritableThreadLocal 使用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#TransmittableThreadLocal-%E4%BD%BF%E7%94%A8"><span class="nav-text">TransmittableThreadLocal 使用</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ThreadLocal-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90"><span class="nav-text">ThreadLocal 底层原理浅析</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">610</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">53</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/d016a303.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Java 多线程编程之九 ThreadLocal 使用 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍 Java 的 ThreadLocal 使用教程。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Java 多线程编程之九 ThreadLocal 使用</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-04-02 22:34:42" itemprop="dateCreated datePublished" datetime="2023-04-02T22:34:42+08:00">2023-04-02</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2024-08-12 22:34:42" itemprop="dateModified" datetime="2024-08-12T22:34:42+08:00">2024-08-12</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/d016a303.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/d016a303.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>4.8k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>4 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/5bbede3c.html">Java 多线程编程之一 Java 内存模型浅析</a></li><li><a href="/posts/f7ed7888.html">Java 多线程编程之二 synchronize 锁对象竞争</a></li><li><a href="/posts/ed2e098d.html">Java 多线程编程之三 volatile 与 JMM 内存模型</a></li><li><a href="/posts/3b82844a.html">Java 多线程编程之四 CAS、ABA 问题、锁</a></li><li><a href="/posts/d9aa9f1f.html">Java 多线程编程之五 AQS 底层源码深度剖析</a></li><li><a href="/posts/1f270e10.html">Java 多线程编程之六集合类的线程安全问题</a></li><li><a href="/posts/f7fd0987.html">Java 多线程编程之七队列、线程池、线程通信</a></li><li><a href="/posts/4a0f41c0.html">Java 多线程编程之八 Fork/Join 框架使用</a></li><li><a href="/posts/d016a303.html">Java 多线程编程之九 ThreadLocal 使用</a></li></ul><h2 id="ThreadLocal-的介绍"><a href="#ThreadLocal-的介绍" class="headerlink" title="ThreadLocal 的介绍"></a>ThreadLocal 的介绍</h2><ul><li>(1) 在 Java 中，ThreadLocal 是为每个线程独立存储变量的机制。它使得每个线程都能拥有一个独立于其他线程的变量副本，这样可以避免线程间的变量共享，从而保证线程安全。ThreadLocal 实例通常是类中的私有静态字段（属性），使用它的目的是希望将状态（例如，用户 ID 或者事务 ID）与线程关联起来。</li><li>(2) ThreadLocal 实现了每一个线程都有自己专属的本地变量副本，主要解决了让每个线程都可以绑定自己的变量值。通过调用 ThreadLocal 的 <code>get()</code> 和 <code>set()</code> 方法，获取默认值或将其值更改为当前线程所存的副本的值，从而避免了线程安全问题。如果不使用 ThreadLocal 或者其他手段（比如加锁）来控制共享变量的并发修改，那么就会出现线程安全问题，其根本原因在于 <a href="../../../asset/2024/08/threadlocal-2.png">Java 内存模型（JMM）</a> 的结构。</li></ul><span id="more"></span><div class="admonition note"><p class="admonition-title">总结</p><ul><li>每个线程都有自己的变量副本，且该变量副本只允许当前线程自己使用。</li><li>既然其他线程不可以使用，那就不存在多线程间数据共享的问题（线程安全问题）。</li><li>ThreadLocal 要求统一设置变量的初始化值，但是每个线程对这个值的修改都是互相独立的，互不影响。</li></ul></div><h3 id="ThreadLocal-的作用"><a href="#ThreadLocal-的作用" class="headerlink" title="ThreadLocal 的作用"></a>ThreadLocal 的作用</h3><ul><li>线程隔离：<ul><li>ThreadLocal 为每个线程提供了独立的变量副本，每个线程都可以独立地读取和修改自己的变量副本，互不影响。这样可以实现线程间的数据隔离，避免了多线程之间共享变量带来的并发访问问题。</li></ul></li><li>线程上下文传递：<ul><li>在多线程应用程序中，有时需要在线程之间传递一些上下文信息，例如用户身份认证信息、数据库连接等。使用 ThreadLocal 可以方便地在不同的线程中共享这些上下文信息，而不需要显式地将它们作为参数传递给每个方法或对象。</li></ul></li><li>线程安全性：<ul><li>由于每个线程都拥有自己的变量副本，因此不需要使用同步机制来保护线程局部变量。这可以减少对锁的需求，提高程序的并发性能。</li></ul></li><li>性能提升：<ul><li>相比于使用全局变量或共享变量，使用 ThreadLocal 可以避免线程间的竞争和同步开销。每个线程独立地操作自己的变量副本，不会出现线程冲突，从而提高了程序的并发性能。</li></ul></li></ul><h3 id="ThreadLocal-的缺点"><a href="#ThreadLocal-的缺点" class="headerlink" title="ThreadLocal 的缺点"></a>ThreadLocal 的缺点</h3><ul><li>内存泄漏：<ul><li>由于 ThreadLocal 内部使用了 ThreadLocalMap 来存储数据，而 ThreadLocalMap 的键是 ThreadLocal 的弱引用，值是强引用。当线程长时间运行且没有及时清除 ThreadLocal 变量时，可能导致内存泄漏。虽然 ThreadLocal 的键可以被垃圾回收，但值仍然会被线程引用，无法被回收。</li></ul></li><li>线程复用问题：<ul><li>在线程池中，线程是被复用的。如果在某个线程上设置了 ThreadLocal 变量，但没有及时清除，当这个线程被再次使用时，可能会继承之前任务的状态，导致不可预测的行为。因此，需要在适当的时候手动调用 <code>remove()</code> 方法清理数据，这增加了使用的复杂度。</li></ul></li></ul><h3 id="ThreadLocal-的适用场景"><a href="#ThreadLocal-的适用场景" class="headerlink" title="ThreadLocal 的适用场景"></a>ThreadLocal 的适用场景</h3><ul><li>数据库连接管理：<ul><li>在多线程环境下，为每个线程提供一个独立的数据库连接实例，避免多个线程共享同一个连接，从而防止并发问题和数据一致性问题。</li></ul></li><li>会话管理：<ul><li>在 Web 应用中，为每个线程提供独立的会话信息存储，可以避免线程间共享会话信息。</li></ul></li><li>用户信息存储：<ul><li>在认证系统中，为每个线程提供独立的用户身份信息存储，确保用户请求的独立性和安全性。</li></ul></li><li>事务管理<ul><li>在事务处理中，可以使用 ThreadLocal 来保存事务相关的信息，确保每个线程的事务处理独立。</li></ul></li><li>日志追踪：<ul><li>在分布式系统中，通过 ThreadLocal 保存每个请求的唯一标识符（如 Trace ID），可以实现日志的全链路追踪，便于问题定位。</li></ul></li></ul><h2 id="ThreadLocal-的核心-API"><a href="#ThreadLocal-的核心-API" class="headerlink" title="ThreadLocal 的核心 API"></a>ThreadLocal 的核心 API</h2><p><img data-src="../../../asset/2024/08/threadlocal-3.png"></p><h2 id="ThreadLocal-的使用案例"><a href="#ThreadLocal-的使用案例" class="headerlink" title="ThreadLocal 的使用案例"></a>ThreadLocal 的使用案例</h2><p>本案例将模拟实现以下业务场景：</p><ul><li>门店里有 3 个销售员卖车，求 3 个销售员的总销售额。</li><li>门店里有 3 个销售员卖车，求 3 个销售员的个人销售额。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalDemo</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>{</span><br><span class="line">        <span class="comment">// 销售员的数量</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> employee = <span class="number">3</span>;</span><br><span class="line">        CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(employee);</span><br><span class="line"></span><br><span class="line">        Car car = <span class="keyword">new</span> Car();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模拟本门店有3个销售(3个线程)</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= employee; i++) {</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="comment">// 随机卖出多少辆车</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= <span class="keyword">new</span> Random().nextInt(<span class="number">3</span>) + <span class="number">1</span>; j++) {</span><br><span class="line">                        car.updateSaleTotal();</span><br><span class="line">                        car.updateSalePersonal();</span><br><span class="line">                    }</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">" 号销售员的销售额："</span> + car.salePersonal.get());</span><br><span class="line">                } <span class="keyword">finally</span> {</span><br><span class="line">                    car.salePersonal.remove();</span><br><span class="line">                    countDownLatch.countDown();</span><br><span class="line">                }</span><br><span class="line">            }, String.valueOf(i)).start();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        countDownLatch.await();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取总销售额</span></span><br><span class="line">        System.out.println(<span class="string">"本门店总销售额："</span> + car.getSaleTotal());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>{</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 本门店总销售额</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Getter</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> saleTotal;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 存放每个销售员（线程）的销售额</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> ThreadLocal&lt;Integer&gt; salePersonal = ThreadLocal.withInitial(() -&gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 更新个人销售额</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateSalePersonal</span><span class="params">()</span> </span>{</span><br><span class="line">            <span class="keyword">int</span> newTotal = salePersonal.get() + <span class="number">1</span>;</span><br><span class="line">            salePersonal.set(newTotal);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 更新总销售额</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">updateSaleTotal</span><span class="params">()</span> </span>{</span><br><span class="line">            saleTotal++;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>程序运行的输出结果：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1 号销售员的销售额：1</span><br><span class="line">2 号销售员的销售额：3</span><br><span class="line">3 号销售员的销售额：2</span><br><span class="line">本门店总销售额：6</span><br></pre></td></tr></tbody></table></figure><h2 id="ThreadLocal-的使用问题"><a href="#ThreadLocal-的使用问题" class="headerlink" title="ThreadLocal 的使用问题"></a>ThreadLocal 的使用问题</h2><h3 id="内存泄漏问题"><a href="#内存泄漏问题" class="headerlink" title="内存泄漏问题"></a>内存泄漏问题</h3><ul><li><code>ThreadLocal</code> 会发生内存泄漏的主要原因在于 <code>ThreadLocal</code> 的实现机制。每个线程都是一个 <code>Thread</code> 对象，而这个对象内部包含了一个 <code>ThreadLocalMap</code>，用于存储 <code>ThreadLocal</code> 变量。这些变量实际上是存储在 <code>ThreadLocalMap</code> 中的键值对，其中键是 <code>ThreadLocal</code> 的弱引用，而值是线程局部变量的值。</li><li>当一个 <code>ThreadLocal</code> 变量不再使用，并且没有强引用指向它时，垃圾回收器会回收这个 <code>ThreadLocal</code> 对象。然而，由于 <code>ThreadLocalMap</code> 的键是弱引用，但值却是强引用，因此即使 <code>ThreadLocal</code> 本身会被回收，值依然会被保留在 <code>ThreadLocalMap</code> 中，导致值无法被垃圾回收，从而引发内存泄漏。</li><li>内存泄漏最典型的场景是长生命周期的线程（如线程池中的线程）持有 <code>ThreadLocal</code> 变量，而 <code>ThreadLocal</code> 变量的生命周期较短。当 <code>ThreadLocal</code> 被回收后，它对应的值仍然保存在 <code>ThreadLocalMap</code> 中，从而导致值无法被垃圾回收。</li></ul><h3 id="线程池的线程复用问题"><a href="#线程池的线程复用问题" class="headerlink" title="线程池的线程复用问题"></a>线程池的线程复用问题</h3><p>在线程池中，线程是会被复用的。如果在某个线程上设置了 ThreadLocal 变量，但没有及时清除，当这个线程被再次使用时，可能会继承之前任务的状态（变量值），导致不可预测的行为（比如内存泄漏、业务逻辑出错）。因此，当使用完 <code>ThreadLocal</code> 变量后，需要在适当的时候手动调用其 <code>remove()</code> 方法来清除当前线程的 <code>ThreadLocal</code> 变量。</p><h4 id="阿里巴巴开发手册"><a href="#阿里巴巴开发手册" class="headerlink" title="阿里巴巴开发手册"></a>阿里巴巴开发手册</h4><p><img data-src="../../../asset/2024/08/threadlocal-4.png"></p><h4 id="线程池的错误使用"><a href="#线程池的错误使用" class="headerlink" title="线程池的错误使用"></a>线程池的错误使用</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalAndThreadPoolDemo</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        MyData myData = <span class="keyword">new</span> MyData();</span><br><span class="line">        ExecutorService threadPool = Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 模拟10个客户（线程）进入银行大厅（线程池）办理业务，银行大厅有3个业务办理窗口（工作线程）</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) {</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> index = i;</span><br><span class="line">                threadPool.submit(() -&gt; {</span><br><span class="line">                    Integer beforeValue = myData.threadLocal.get();</span><br><span class="line">                    myData.add();</span><br><span class="line">                    Integer afterValue = myData.threadLocal.get();</span><br><span class="line">                    System.out.println(</span><br><span class="line">                        Thread.currentThread().getName() + <span class="string">"\t工作窗口\t"</span> + <span class="string">"受理第: "</span> + index + <span class="string">" 个顾客，"</span> +</span><br><span class="line">                            <span class="string">"beforeValue: "</span> +</span><br><span class="line">                            beforeValue + <span class="string">"\t"</span> + <span class="string">"afterValue: "</span> + afterValue);</span><br><span class="line">                });</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            <span class="comment">// 关闭线程池</span></span><br><span class="line">            threadPool.shutdown();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyData</span> </span>{</span><br><span class="line"></span><br><span class="line">        ThreadLocal&lt;Integer&gt; threadLocal = ThreadLocal.withInitial(() -&gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span> </span>{</span><br><span class="line">            threadLocal.set(threadLocal.get() + <span class="number">1</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>程序运行的输出结果：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pool-1-thread-3	工作窗口	受理第: 3 个顾客，beforeValue: 0	afterValue: 1</span><br><span class="line">pool-1-thread-1	工作窗口	受理第: 1 个顾客，beforeValue: 0	afterValue: 1</span><br><span class="line">pool-1-thread-2	工作窗口	受理第: 2 个顾客，beforeValue: 0	afterValue: 1</span><br><span class="line">pool-1-thread-3	工作窗口	受理第: 4 个顾客，beforeValue: 1	afterValue: 2</span><br><span class="line">pool-1-thread-1	工作窗口	受理第: 5 个顾客，beforeValue: 1	afterValue: 2</span><br><span class="line">pool-1-thread-3	工作窗口	受理第: 7 个顾客，beforeValue: 2	afterValue: 3</span><br><span class="line">pool-1-thread-2	工作窗口	受理第: 6 个顾客，beforeValue: 1	afterValue: 2</span><br><span class="line">pool-1-thread-3	工作窗口	受理第: 9 个顾客，beforeValue: 3	afterValue: 4</span><br><span class="line">pool-1-thread-1	工作窗口	受理第: 8 个顾客，beforeValue: 2	afterValue: 3</span><br><span class="line">pool-1-thread-2	工作窗口	受理第: 10 个顾客，beforeValue: 2	afterValue: 3</span><br></pre></td></tr></tbody></table></figure><p>从上面的输出结果可以看到，每个工作窗口从第二次为客户办理业务时，都会读取到上一个客户的信息（<code>beforeValue</code>），这就可能会影响后续的业务逻辑和造成内存泄漏等问题。</p><h4 id="线程池的正确使用"><a href="#线程池的正确使用" class="headerlink" title="线程池的正确使用"></a>线程池的正确使用</h4><p>在同时使用 ThreadLocal 与线程池时，每个线程执行完任务后，都必须在 <code>try-finally</code> 代码块内调用 ThreadLocal 的 <code>remove()</code> 方法，以此清理自定义的 ThreadLocal 变量，否则可能会影响后续的业务逻辑和造成内存泄漏等问题。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.java.interview.thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ThreadLocal 与线程池的使用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalAndThreadPoolDemo</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        MyData myData = <span class="keyword">new</span> MyData();</span><br><span class="line">        ExecutorService threadPool = Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 模拟10个客户（线程）进入银行大厅（线程池）办理业务，银行大厅有3个业务办理窗口（工作线程）</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) {</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> index = i;</span><br><span class="line">                threadPool.submit(() -&gt; {</span><br><span class="line">                    <span class="keyword">try</span> {</span><br><span class="line">                        Integer beforeValue = myData.threadLocal.get();</span><br><span class="line">                        myData.add();</span><br><span class="line">                        Integer afterValue = myData.threadLocal.get();</span><br><span class="line">                        System.out.println(</span><br><span class="line">                            Thread.currentThread().getName() + <span class="string">"\t工作窗口\t"</span> + <span class="string">"受理第: "</span> + index + <span class="string">" 个顾客，"</span> +</span><br><span class="line">                                <span class="string">"beforeValue: "</span> +</span><br><span class="line">                                beforeValue + <span class="string">"\t"</span> + <span class="string">"afterValue: "</span> + afterValue);</span><br><span class="line">                    } <span class="keyword">finally</span> {</span><br><span class="line">                        <span class="comment">// 清理自定义的 ThreadLocal 变量</span></span><br><span class="line">                        myData.threadLocal.remove();</span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            <span class="comment">// 关闭线程池</span></span><br><span class="line">            threadPool.shutdown();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyData</span> </span>{</span><br><span class="line"></span><br><span class="line">        ThreadLocal&lt;Integer&gt; threadLocal = ThreadLocal.withInitial(() -&gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span> </span>{</span><br><span class="line">            threadLocal.set(threadLocal.get() + <span class="number">1</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>程序运行的输出结果：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pool-1-thread-2	工作窗口	受理第: 2 个顾客，beforeValue: 0	afterValue: 1</span><br><span class="line">pool-1-thread-1	工作窗口	受理第: 1 个顾客，beforeValue: 0	afterValue: 1</span><br><span class="line">pool-1-thread-3	工作窗口	受理第: 3 个顾客，beforeValue: 0	afterValue: 1</span><br><span class="line">pool-1-thread-1	工作窗口	受理第: 4 个顾客，beforeValue: 0	afterValue: 1</span><br><span class="line">pool-1-thread-2	工作窗口	受理第: 5 个顾客，beforeValue: 0	afterValue: 1</span><br><span class="line">pool-1-thread-1	工作窗口	受理第: 6 个顾客，beforeValue: 0	afterValue: 1</span><br><span class="line">pool-1-thread-2	工作窗口	受理第: 7 个顾客，beforeValue: 0	afterValue: 1</span><br><span class="line">pool-1-thread-1	工作窗口	受理第: 8 个顾客，beforeValue: 0	afterValue: 1</span><br><span class="line">pool-1-thread-3	工作窗口	受理第: 9 个顾客，beforeValue: 0	afterValue: 1</span><br><span class="line">pool-1-thread-2	工作窗口	受理第: 10 个顾客，beforeValue: 0	afterValue: 1</span><br></pre></td></tr></tbody></table></figure><h3 id="父子线程无法共享传递问题"><a href="#父子线程无法共享传递问题" class="headerlink" title="父子线程无法共享传递问题"></a>父子线程无法共享传递问题</h3><h4 id="ThreadLocal-的相关类"><a href="#ThreadLocal-的相关类" class="headerlink" title="ThreadLocal 的相关类"></a>ThreadLocal 的相关类</h4><ul><li><p><code>ThreadLocal</code></p><ul><li>由 JDK 提供，不支持父子线程共享传递 ThreadLocal 变量。</li><li>也就是说，当在父线程中设置了一个 <code>ThreadLocal</code> 变量，然后启动一个子线程时，子线程会有自己独立的 <code>ThreadLocalMap</code>，这意味着父线程中的 <code>ThreadLocal</code> 变量对子线程不可见。</li></ul></li><li><p><code>InheritableThreadLocal</code></p><ul><li>由 JDK 提供，属于 ThreadLocal 的扩展版本，允许子线程继承父线程的 ThreadLocal 变量。</li><li>在子线程继承后，子线程和父线程的 ThreadLocal 变量是互相独立的。换言之，如果在子线程启动之后，父线程修改了 ThreadLocal 变量的值，子线程中的变量值不会同步更新，反之亦然。当遇到线程池的线程复用时，会存在 ThreadLocal 变量无法传递的问题。</li></ul></li><li><p><code>TransmittableThreadLocal</code></p><ul><li>阿里巴巴开源的 ThreadLocal 扩展版本，解决了 InheritableThreadLocal 在使用线程池时（线程复用）变量不传递的问题，特别适用于分布式系统中的跨线程数据传递。</li><li>在使用 TransmittableThreadLocal 之前，需要引入以下 <a target="_blank" rel="external nofollow" href="https://mvnrepository.com/artifact/com.alibaba/transmittable-thread-local">Maven 依赖</a> 后才能够使用，可以解决线程池中上下文传递问题，推荐使用。</li></ul></li></ul><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>transmittable-thread-local<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.14.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h4 id="父子线程共享传递问题"><a href="#父子线程共享传递问题" class="headerlink" title="父子线程共享传递问题"></a>父子线程共享传递问题</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalDemo</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        <span class="comment">// ThreadLocal 可以在当前线程中共享数据，set() 和 get() 需要在同一个线程中执行才行，其他线程访问不到</span></span><br><span class="line">        ThreadLocal&lt;String&gt; threadLocal = ThreadLocal.withInitial(() -&gt; <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        threadLocal.set(Thread.currentThread().getName() + <span class="string">"-Java"</span>);</span><br><span class="line">        log.info(<span class="string">"major: {}"</span>, threadLocal.get());</span><br><span class="line">        System.out.println();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 新建线程 thread1，设置值为 Vue，然后取出学科名看看</span></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; {</span><br><span class="line">            log.info(<span class="string">"major: {}"</span>, threadLocal.get());</span><br><span class="line">            threadLocal.set(Thread.currentThread().getName() + <span class="string">"-Vue"</span>);</span><br><span class="line">            log.info(<span class="string">"major: {}"</span>, threadLocal.get());</span><br><span class="line">        }, <span class="string">"thread-1"</span>).start();</span><br><span class="line">        System.out.println();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//暂停当前线程</span></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 新建线程 thread2，设置值为 Flink，然后取出学科名看看</span></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; {</span><br><span class="line">            log.info(<span class="string">"major: {}"</span>, threadLocal.get());</span><br><span class="line">            threadLocal.set(Thread.currentThread().getName() + <span class="string">"-Flink"</span>);</span><br><span class="line">            log.info(<span class="string">"major: {}"</span>, threadLocal.get());</span><br><span class="line">        }, <span class="string">"thread-2"</span>).start();</span><br><span class="line">        System.out.println();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 基于线程池异步执行任务</span></span><br><span class="line">        CompletableFuture.supplyAsync(() -&gt; {</span><br><span class="line">            log.info(<span class="string">"major: {}"</span>, threadLocal.get());</span><br><span class="line">            threadLocal.set(Thread.currentThread().getName() + <span class="string">"-MySQL"</span>);</span><br><span class="line">            log.info(<span class="string">"major: {}"</span>, threadLocal.get());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        });</span><br><span class="line">        System.out.println();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//暂停当前线程</span></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>程序执行的输出结果：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">46</span>:<span class="number">10.890</span> [main] INFO com.java.interview.thread.ThreadLocalDemo - major: main-Java</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">46</span>:<span class="number">10.898</span> [thread-<span class="number">1</span>] INFO com.java.interview.thread.ThreadLocalDemo - major: <span class="keyword">null</span></span><br><span class="line"><span class="number">15</span>:<span class="number">46</span>:<span class="number">10.900</span> [thread-<span class="number">1</span>] INFO com.java.interview.thread.ThreadLocalDemo - major: thread-<span class="number">1</span>-Vue</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">46</span>:<span class="number">11.900</span> [thread-<span class="number">2</span>] INFO com.java.interview.thread.ThreadLocalDemo - major: <span class="keyword">null</span></span><br><span class="line"><span class="number">15</span>:<span class="number">46</span>:<span class="number">11.901</span> [thread-<span class="number">2</span>] INFO com.java.interview.thread.ThreadLocalDemo - major: thread-<span class="number">2</span>-Flink</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">46</span>:<span class="number">11.911</span> [ForkJoinPool.commonPool-worker-<span class="number">115</span>] INFO com.java.interview.thread.ThreadLocalDemo - major: <span class="keyword">null</span></span><br><span class="line"><span class="number">15</span>:<span class="number">46</span>:<span class="number">11.912</span> [ForkJoinPool.commonPool-worker-<span class="number">115</span>] INFO com.java.interview.thread.ThreadLocalDemo - major: ForkJoinPool.commonPool-worker-<span class="number">115</span>-MySQL</span><br></pre></td></tr></tbody></table></figure><p>从上面的输出结果可以看到，子线程无法访问父线程的 ThreadLocal 变量，也就是说 ThreadLocal 变量默认不支持在父子线程中传递。</p><h4 id="父子线程共享传递解决"><a href="#父子线程共享传递解决" class="headerlink" title="父子线程共享传递解决"></a>父子线程共享传递解决</h4><h5 id="InheritableThreadLocal-使用"><a href="#InheritableThreadLocal-使用" class="headerlink" title="InheritableThreadLocal 使用"></a>InheritableThreadLocal 使用</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalDemo</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        <span class="comment">// 使用 InheritableThreadLocal</span></span><br><span class="line">        InheritableThreadLocal&lt;String&gt; inheritableThreadLocal = <span class="keyword">new</span> InheritableThreadLocal();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里是 main 线程，调用 InheritableThreadLocal.set() 方法放入值</span></span><br><span class="line">        inheritableThreadLocal.set(Thread.currentThread().getName() + <span class="string">"-Java"</span>);</span><br><span class="line">        log.info(<span class="string">"major: {}"</span>, inheritableThreadLocal.get());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 新建线程 thread1，在子线程 thread1 中去 main 线程的 ThreadLocal 中获取值</span></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; {</span><br><span class="line">            log.info(<span class="string">"major: {}"</span>, inheritableThreadLocal.get());</span><br><span class="line">        }, <span class="string">"thread1"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 新建线程 thread2，在子线程 thread2 中去 main 线程的 ThreadLocal 中获取值</span></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; {</span><br><span class="line">            log.info(<span class="string">"major: {}"</span>, inheritableThreadLocal.get());</span><br><span class="line">        }, <span class="string">"thread2"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 新建线程 thread3，在子线程 thread3 中去 main 线程的 ThreadLocal 中获取值</span></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; {</span><br><span class="line">            log.info(<span class="string">"major: {}"</span>, inheritableThreadLocal.get());</span><br><span class="line">        }, <span class="string">"thread3"</span>).start();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>程序执行的输出结果：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">15:59:36.338 [main] INFO com.java.interview.thread.ThreadLocalDemo - major: main-Java</span><br><span class="line">15:59:36.345 [thread1] INFO com.java.interview.thread.ThreadLocalDemo - major: main-Java</span><br><span class="line">15:59:36.346 [thread2] INFO com.java.interview.thread.ThreadLocalDemo - major: main-Java</span><br><span class="line">15:59:36.347 [thread3] INFO com.java.interview.thread.ThreadLocalDemo - major: main-Java</span><br></pre></td></tr></tbody></table></figure><p>从上面的输出结果可以看到，使用 InheritableThreadLocal 后，子线程可以继承父线程的 ThreadLocal 变量。</p><div class="admonition warning"><p class="admonition-title">特别注意</p><p>当 InheritableThreadLocal 遇到线程池，会存在问题。在使用线程池时，InheritableThreadLocal 虽然可以让子线程继承父线程的 ThreadLocal 变量，但是一旦发生线程复用，修改父线程的 ThreadLocal 变量不会影响到子线程，反之亦然。</p></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalDemo</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        <span class="comment">// 使用 InheritableThreadLocal</span></span><br><span class="line">        InheritableThreadLocal&lt;String&gt; inheritableThreadLocal = <span class="keyword">new</span> InheritableThreadLocal();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里是 main 线程，调用 InheritableThreadLocal.set() 方法放入值</span></span><br><span class="line">        inheritableThreadLocal.set(Thread.currentThread().getName() + <span class="string">"-Java"</span>);</span><br><span class="line">        log.info(<span class="string">"major: {}"</span>, inheritableThreadLocal.get());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里创建大小为 1 的线程池，池中只有 1 个线程才能方便看到效果（为了触发线程复用）</span></span><br><span class="line">        ExecutorService threadPool = Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">        threadPool.execute(() -&gt; {</span><br><span class="line">            log.info(<span class="string">"ThreadPool 第 1 次获取值，major: {}"</span>, inheritableThreadLocal.get());</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 暂停 main 线程</span></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        System.out.println();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里往 main 线程中重新放入了 Vue</span></span><br><span class="line">        inheritableThreadLocal.set(Thread.currentThread().getName() + <span class="string">"-Vue，已经修改了O(∩_∩)O"</span>);</span><br><span class="line">        log.info(<span class="string">"major: {}"</span>, inheritableThreadLocal.get());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里在线程池中通过 InheritableThreadLocal.get() 方法拿值，看看能否拿到刚才重新放入的值</span></span><br><span class="line">        threadPool.execute(() -&gt; {</span><br><span class="line">            log.info(<span class="string">"ThreadPool 第 2 次获取值，major: {}"</span>, inheritableThreadLocal.get());</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 暂停 main 线程</span></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭线程池</span></span><br><span class="line">        threadPool.shutdown();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>程序执行的输出结果：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">19</span>:<span class="number">13.993</span> [main] INFO com.java.interview.thread.ThreadLocalDemo - major: main-Java</span><br><span class="line"><span class="number">16</span>:<span class="number">19</span>:<span class="number">14.001</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.java.interview.thread.ThreadLocalDemo - ThreadPool 第 <span class="number">1</span> 次获取值，major: main-Java</span><br><span class="line"></span><br><span class="line"><span class="number">16</span>:<span class="number">19</span>:<span class="number">15.002</span> [main] INFO com.java.interview.thread.ThreadLocalDemo - major: main-Vue，已经修改了O(∩_∩)O</span><br><span class="line"><span class="number">16</span>:<span class="number">19</span>:<span class="number">15.003</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.java.interview.thread.ThreadLocalDemo - ThreadPool 第 <span class="number">2</span> 次获取值，major: main-Java</span><br></pre></td></tr></tbody></table></figure><p>从上面的输出结果可以看到，在使用线程池时，InheritableThreadLocal 虽然可以让子线程继承父线程的 ThreadLocal 变量，但是一旦发生线程复用，子线程将无法实时感知到父线程的 ThreadLocal 变量的变化。简而言之，当 InheritableThreadLocal 遇到线程池，如果执行任务的线程是新创建的，那么子线程可以实时访问到父线程的 ThreadLocal 变量；如果执行任务的线程是复用的，那么子线程无法实时感知到父线程的 ThreadLocal 变量的变化。为了解决这个问题，需要使用 TransmittableThreadLocal 类，它是阿里巴巴开源的一个用于解决线程池中上下文传递问题的工具类。</p><h5 id="TransmittableThreadLocal-使用"><a href="#TransmittableThreadLocal-使用" class="headerlink" title="TransmittableThreadLocal 使用"></a>TransmittableThreadLocal 使用</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalDemo</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        <span class="comment">// 使用 TransmittableThreadLocal</span></span><br><span class="line">        TransmittableThreadLocal&lt;String&gt; transmittableThreadLocal = <span class="keyword">new</span> TransmittableThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里是 mian 线程，调用 TransmittableThreadLocal.set() 放入值</span></span><br><span class="line">        transmittableThreadLocal.set(Thread.currentThread().getName() + <span class="string">"-Java"</span>);</span><br><span class="line">        log.info(<span class="string">"major: {}"</span>, transmittableThreadLocal.get());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里创建大小为 1 的线程池，池中只有 1 个线程才能方便看到效果（为了触发线程复用）</span></span><br><span class="line">        ExecutorService threadPool = Executors.newSingleThreadExecutor();</span><br><span class="line">        <span class="comment">// 这里需要调用 TtlExecutors.getTtlExecutorService() 方法将原线程池包装一下</span></span><br><span class="line">        threadPool = TtlExecutors.getTtlExecutorService(threadPool);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里在线程池中通过 TransmittableThreadLocal.get() 方法拿值</span></span><br><span class="line">        threadPool.execute(() -&gt; {</span><br><span class="line">            log.info(<span class="string">"ThreadPool 第 1 次获取值，major: {}"</span>, transmittableThreadLocal.get());</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 暂停 main 线程</span></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        System.out.println();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里往 main 线程中重新放入了 Vue</span></span><br><span class="line">        transmittableThreadLocal.set(Thread.currentThread().getName() + <span class="string">"-Vue，已经修改了O(∩_∩)O"</span>);</span><br><span class="line">        log.info(<span class="string">"major: {}"</span>, transmittableThreadLocal.get());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里在线程池中通过 TransmittableThreadLocal.get() 方法拿值，看看能否拿到刚才重新放入的值</span></span><br><span class="line">        threadPool.execute(() -&gt; {</span><br><span class="line">            log.info(<span class="string">"ThreadPool 第 2 次获取值，major: {}"</span>, transmittableThreadLocal.get());</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 暂停 main 线程</span></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭线程池</span></span><br><span class="line">        threadPool.shutdown();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>程序执行的输出结果：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">16:42:35.703 [main] INFO com.java.interview.thread.ThreadLocalDemo - major: main-Java</span><br><span class="line">16:42:35.726 [pool-1-thread-1] INFO com.java.interview.thread.ThreadLocalDemo - ThreadPool 第 1 次获取值，major: main-Java</span><br><span class="line"></span><br><span class="line">16:42:36.726 [main] INFO com.java.interview.thread.ThreadLocalDemo - major: main-Vue，已经修改了O(∩_∩)O</span><br><span class="line">16:42:36.728 [pool-1-thread-1] INFO com.java.interview.thread.ThreadLocalDemo - ThreadPool 第 2 次获取值，major: main-Vue，已经修改了O(∩_∩)O</span><br></pre></td></tr></tbody></table></figure><p>从上面的输出结果可以看到，在使用线程池时，TransmittableThreadLocal 可以让子线程访问到父线程的 ThreadLocal 变量，即使是在线程池中发生线程复用，子线程也可以实时感知到父线程的 ThreadLocal 变量的变化。</p><h2 id="ThreadLocal-底层原理浅析"><a href="#ThreadLocal-底层原理浅析" class="headerlink" title="ThreadLocal 底层原理浅析"></a>ThreadLocal 底层原理浅析</h2><ul><li><p>(1) ThreadLocal 是 Java 中用于实现线程本地存储的一种机制，它使得每个线程都能拥有一个独立于其他线程的变量副本。这样可以避免线程间的变量共享，从而保证线程安全。</p></li><li><p>(2) ThreadLocal 底层是通过 ThreadLocalMap 来实现的。每个线程对象（Thread）都有一个名为 <code>threadLocals</code> 的成员变量，这个变量的类型是 <code>ThreadLocal.ThreadLocalMap</code>；而 ThreadLocalMap 是一个定制的 HashMap，它的值是线程要存储的变量，键是弱引用（WeakReference）的 ThreadLocal 对象，这样可以防止内存泄漏，当 ThreadLocal 对象没有强引用时，GC 可以回收这些对象。</p></li><li><p>(3) 如果在线程池中使用 ThreadLocal，那么可能会造成内存泄漏。因为当 ThreadLocal 对象使用完之后，应该要把设置的键值对，也就是 Entry 对象进行回收；但线程池中的线程是不会被回收的（线程复用），而且线程对象（Thread）是通过强引用指向 ThreadLocalMap 的，ThreadLocalMap 也是通过强引用指向 Entry 对象 的，Entry 对象也是通过强引用指向值对象的；所以线程不被回收，Entry 对象也就不会被回收，那么 Entry 对象的值也不会回收，从而导致内存泄漏。解决办法是，在使用完 ThreadLocal 对象之后，手动调用 ThreadLocal 的 <code>remove()</code> 方法，手动清理 Entry 对象。</p></li><li><p>(4) ThreadLocal 经典的使用场景就是连接管理，比如数据库连接管理。每个线程持有一个数据库连接，该数据库连接对象可以在不同的方法之间进行传递，但线程之间不共享同一个数据库连接。</p></li></ul><p><img data-src="../../../asset/2024/08/threadlocal-1.png"></p><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/d016a303.html" title="Java 多线程编程之九 ThreadLocal 使用">https://www.techgrow.cn/posts/d016a303.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/Java/" rel="tag"><i class="fa fa-tag"></i> Java</a><a href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" rel="tag"><i class="fa fa-tag"></i> 并发编程</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/972c1f90.html" rel="prev" title="XXL-JOB 入门教程之二"><i class="fa fa-angle-left"></i> XXL-JOB 入门教程之二</a></div><div class="post-nav-item"> <a href="/posts/dfc4cb86.html" rel="next" title="H2 数据库基础教程之一">H2 数据库基础教程之一<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">1.5m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">22:18</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤 ICP 备 19024664 号</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035 号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"/lib/mermaid/dist/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/app/api/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/app/api/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/d016a303.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>