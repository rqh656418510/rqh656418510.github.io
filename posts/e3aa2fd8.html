<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍如何在 Linux 生产环境中，基于 KRaft 模式部署 Kafka 集群，适用于使用多台物理机器搭建集群。"><meta property="og:type" content="article"><meta property="og:title" content="Linux 生产环境搭建 Kafka-KRaft 集群"><meta property="og:url" content="https://www.techgrow.cn/posts/e3aa2fd8.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍如何在 Linux 生产环境中，基于 KRaft 模式部署 Kafka 集群，适用于使用多台物理机器搭建集群。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/12/kafka-kraft-1.png"><meta property="article:published_time" content="2024-11-03T13:30:00.000Z"><meta property="article:modified_time" content="2024-12-07T13:30:00.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="Linux运维"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2024/12/kafka-kraft-1.png"><link rel="canonical" href="https://www.techgrow.cn/posts/e3aa2fd8.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/e3aa2fd8.html","path":"posts/e3aa2fd8.html","title":"Linux 生产环境搭建 Kafka-KRaft 集群"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Linux 生产环境搭建 Kafka-KRaft 集群 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BA%B2"><span class="nav-text">大纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kafka-KRaft-%E6%A8%A1%E5%BC%8F%E4%BB%8B%E7%BB%8D"><span class="nav-text">Kafka-KRaft 模式介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#KRaft-%E6%A8%A1%E5%BC%8F%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="nav-text">KRaft 模式的概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#KRaft-%E6%A8%A1%E5%BC%8F%E7%9A%84%E4%BC%98%E5%8A%BF"><span class="nav-text">KRaft 模式的优势</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kafka-KRaft-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="nav-text">Kafka-KRaft 集群部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-text">准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E8%A7%84%E5%88%92"><span class="nav-text">集群部署规划</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E4%B8%BB%E6%9C%BA%E5%90%8D%E6%98%A0%E5%B0%84"><span class="nav-text">添加主机名映射</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="nav-text">集群搭建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E5%90%AF%E5%8A%A8"><span class="nav-text">集群启动</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AD%98%E5%82%A8%E7%9B%AE%E5%BD%95"><span class="nav-text">初始化存储目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E5%90%84%E4%B8%AA%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9"><span class="nav-text">启动各个集群节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%90%AF%E5%8A%A8%E6%97%A5%E5%BF%97%E4%BF%A1%E6%81%AF"><span class="nav-text">查看启动日志信息</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86"><span class="nav-text">集群管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E7%8A%B6%E6%80%81"><span class="nav-text">查看状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E5%85%B3%E9%97%AD"><span class="nav-text">集群关闭</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E9%87%8D%E5%BB%BA"><span class="nav-text">集群重建</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%B5%8B%E8%AF%95"><span class="nav-text">集群测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kafka-KRaft-%E9%9B%86%E7%BE%A4%E8%B0%83%E4%BC%98"><span class="nav-text">Kafka-KRaft 集群调优</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E6%95%B4-Kafka-%E7%9A%84%E5%A0%86%E5%86%85%E5%AD%98%E5%A4%A7%E5%B0%8F"><span class="nav-text">调整 Kafka 的堆内存大小</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">684</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">53</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/e3aa2fd8.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Linux 生产环境搭建 Kafka-KRaft 集群 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍如何在 Linux 生产环境中，基于 KRaft 模式部署 Kafka 集群，适用于使用多台物理机器搭建集群。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Linux 生产环境搭建 Kafka-KRaft 集群</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-11-03 21:30:00" itemprop="dateCreated datePublished" datetime="2024-11-03T21:30:00+08:00">2024-11-03</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2024-12-07 21:30:00" itemprop="dateModified" datetime="2024-12-07T21:30:00+08:00">2024-12-07</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/e3aa2fd8.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/e3aa2fd8.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>2.9k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>3 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul><li><a href="/posts/d2c9b56d.html">Docker 搭建 Kafka 集群</a></li><li><a href="/posts/124a5015.html">Linux 单机搭建 Kafka 集群</a></li><li><a href="/posts/6dceb9c9.html">Linux 生产环境搭建 Kafka 集群</a></li><li><a href="/posts/e3aa2fd8.html">Linux 生产环境搭建 Kafka-KRaft 集群</a></li></ul><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文将使用多台物理机器（至少三台），基于 KRaft 模式搭建 Kafka 集群，适用于在 CentOS/Debian/Ubuntu 等发行版。</p><span id="more"></span><h2 id="Kafka-KRaft-模式介绍"><a href="#Kafka-KRaft-模式介绍" class="headerlink" title="Kafka-KRaft 模式介绍"></a>Kafka-KRaft 模式介绍</h2><h3 id="KRaft-模式的概述"><a href="#KRaft-模式的概述" class="headerlink" title="KRaft 模式的概述"></a>KRaft 模式的概述</h3><p><img data-src="../../../asset/2024/12/kafka-kraft-1.png"></p><ul><li>左图为 Kafka 的 ZooKeeer 模式架构，元数据存储在 Zookeeper 中，运行时会动态选举一个 Broker 节点作为 Controller（唯一），由 Controller 进行 Kafka 集群管理。</li><li>左图为 Kafka 的 KRaft 模式架构，不再依赖 Zookeeper 集群，而是使用多个 Controller 节点来代替 Zookeeper，元数据保存在 Controller 中，由 Controller 直接管理 Kafka 集群。</li></ul><table><thead><tr><th>特性</th><th> ZooKeeper 模式</th><th> KRaft 模式</th></tr></thead><tbody><tr><td> Leader 选举依赖性</td><td>需要 ZooKeeper 提供元数据存储和通知机制</td><td>不依赖 ZooKeeper，完全有 Kafka 自己自行实现</td></tr><tr><td>元数据管理</td><td>由 ZooKeeper 管理</td><td>由 Kafka 自己的 Raft 集群管理</td></tr><tr><td>一致性保障</td><td> ZooKeeper 提供一致性</td><td> Raft 协议保障一致性</td></tr><tr><td>引入版本</td><td> Kafka 早期版本（默认是 ZooKeeper 模式）</td><td>Kafka <code>2.8.0+</code>（KRaft 模式）</td></tr></tbody></table><div class="admonition note"><p class="admonition-title">版本说明</p><p>从 Kafka <code>2.8.0</code> 版本开始，Kafka 自身实现了 Raft 分布式一致性机制，这意味着 Kafka 集群可以脱离 ZooKeeper 独立运行。</p></div><h3 id="KRaft-模式的优势"><a href="#KRaft-模式的优势" class="headerlink" title="KRaft 模式的优势"></a>KRaft 模式的优势</h3><ul><li>Kafka 不再依赖外部服务，而是能够独立运行。</li><li>Controller 管理集群时，不再需要从 Zookeeper 中先读取数据，提高了集群性能。</li><li>由于不依赖 Zookeeper，因此 Kafka 集群扩展时不再受到 Zookeeper 读写能力的限制。</li><li>Controller 节点不再是通过动态选举来决定，而是由配置文件指定，这样开发者可以有针对性地加强。</li><li>Controller 节点支持通过配置来指定，而不是像以前一样对随机 Controller 节点的高负载束手无策。</li></ul><h2 id="Kafka-KRaft-集群部署"><a href="#Kafka-KRaft-集群部署" class="headerlink" title="Kafka-KRaft 集群部署"></a>Kafka-KRaft 集群部署</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><h4 id="集群部署规划"><a href="#集群部署规划" class="headerlink" title="集群部署规划"></a>集群部署规划</h4><table><thead><tr><th>节点</th><th>节点 ID</th><th> 主机名</th><th>角色</th><th> IP 地址</th><th> Broker 端口</th><th> Controller 端口</th><th>版本</th></tr></thead><tbody><tr><td> Kafka 集群节点一</td><td> 1</td><td><code>kafka01</code></td><td><code>broker</code>、<code>controller</code></td><td><code>192.168.2.127</code></td><td><code>9092</code></td><td><code>9093</code></td><td><code>3.8.1</code></td></tr><tr><td>Kafka 集群节点二</td><td> 2</td><td><code>kafka02</code></td><td><code>broker</code>、<code>controller</code></td><td><code>192.168.2.150</code></td><td><code>9092</code></td><td><code>9093</code></td><td><code>3.8.1</code></td></tr><tr><td>Kafka 集群节点三</td><td> 3</td><td><code>kafka03</code></td><td><code>broker</code>、<code>controller</code></td><td><code>192.168.2.203</code></td><td><code>9092</code></td><td><code>9093</code></td><td><code>3.8.1</code></td></tr></tbody></table><div class="admonition note"><p class="admonition-title">提示</p><ul><li>对于 Kafka-KRaft 集群，可以在配置文件中通过 <code>process.roles</code> 配置项来指定某个节点单独作为 Broker 或者单独作为 Controller，还可以指定某个节点同时作为 Broker 和 Controller。</li><li><strong>特别注意，为了保证 Kafka-KRaft 集群的高可用性，要求至少要有 3 个 Controller。</strong></li></ul></div><h4 id="添加主机名映射"><a href="#添加主机名映射" class="headerlink" title="添加主机名映射"></a>添加主机名映射</h4><p>在所有 Kafka-KRaft 集群节点中，分别通过修改 <code>/etc/hosts</code> 配置文件来添加主机名和 IP 地址的映射关系，用于将主机名解析到指定的 IP 地址。</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑系统配置文件，添加以下配置内容</span></span><br><span class="line"><span class="comment"># vi /etc/hosts</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.2.127   kafka01</span><br><span class="line">192.168.2.150   kafka02</span><br><span class="line">192.168.2.203   kafka03</span><br></pre></td></tr></tbody></table></figure><h3 id="集群搭建"><a href="#集群搭建" class="headerlink" title="集群搭建"></a>集群搭建</h3><div class="admonition note"><p class="admonition-title">Kafka 下载地址</p><ul><li>(1) Kafka 的安装包可以从 <a target="_blank" rel="external nofollow" href="https://kafka.apache.org/downloads.html">官网</a> 下载。</li><li>(2) 以下载得到的压缩文件 <code>kafka_2.13-3.8.1.tgz</code> 为例，<code>2.11</code> 是 Scala 的版本号，<code>3.2.1</code> 是 Kafka 的版本号。</li><li>(3) 值得一提的是，Kafka 的 Broker 组件是使用 Scala 开发的，而 Producer 组件和 Consumer 组件是使用 Java 开发的。</li></ul></div><ul><li>Kafka 安装</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建安装目录</span></span><br><span class="line"><span class="comment"># mkdir -p /usr/local/kafka-cluster</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入安装目录</span></span><br><span class="line"><span class="comment"># cd /usr/local/kafka-cluster</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载文件</span></span><br><span class="line"><span class="comment"># wget https://downloads.apache.org/kafka/3.8.1/kafka_2.13-3.8.1.tgz</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压文件</span></span><br><span class="line"><span class="comment"># tar -xvf kafka_2.13-3.8.1.tgz</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重命名目录（作为节点一的安装目录）</span></span><br><span class="line"><span class="comment"># mv kafka_2.13-3.8.1 kafka-node01</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除文件</span></span><br><span class="line"><span class="comment"># rm -rf kafka_2.13-3.8.1.tgz</span></span><br></pre></td></tr></tbody></table></figure><ul><li>Kafka 基础配置</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">``` sh</span><br><span class="line"><span class="comment"># 进入节点一的安装目录</span></span><br><span class="line"><span class="comment"># cd /usr/local/kafka-cluster/kafka-node01</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建数据存储目录</span></span><br><span class="line"><span class="comment"># mkdir data</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑 KRaft 的配置文件（更改或添加以下内容即可）</span></span><br><span class="line"><span class="comment"># vi config/kraft/server.properties</span></span><br></pre></td></tr></tbody></table></figure><p>最关键的配置项是 <code>process.roles</code>、<code>node.id</code>、<code>controller.quorum.voters</code>、<code>advertised.listeners</code>、<code>log.dirs</code>。在生产阶段，其他配置项可以根据业务需求适当调整具体的参数值。</p><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定节点的角色,可以单独指定为 broker 或者 controller,还可以两者同时指定</span></span><br><span class="line"><span class="meta">process.roles</span>=<span class="string">broker,controller</span></span><br><span class="line"><span class="comment"># Kafka 节点的 ID,必须在集群中唯一</span></span><br><span class="line"><span class="meta">node.id</span>=<span class="string">1</span></span><br><span class="line"><span class="comment"># 定义控制器选举的投票者,格式为 node.id@host:port</span></span><br><span class="line"><span class="meta">controller.quorum.voters</span>=<span class="string">1@kafka01:9093,2@kafka02:9093,3@kafka03:9093</span></span><br><span class="line"><span class="comment"># 配置 Kafka 使用的监听地址和端口</span></span><br><span class="line"><span class="attr">listeners</span>=<span class="string">PLAINTEXT://:9092,CONTROLLER://:9093</span></span><br><span class="line"><span class="comment"># 定义 Broker 之间通信使用的监听器名称</span></span><br><span class="line"><span class="meta">inter.broker.listener.name</span>=<span class="string">PLAINTEXT</span></span><br><span class="line"><span class="comment"># 定义 Broker 对外暴露的监听地址,供客户端连接</span></span><br><span class="line"><span class="meta">advertised.listeners</span>=<span class="string">PLAINTEXT://kafka01:9092</span></span><br><span class="line"><span class="comment"># 定义 Controller 之间通信使用的监听器名称</span></span><br><span class="line"><span class="meta">controller.listener.names</span>=<span class="string">CONTROLLER</span></span><br><span class="line"><span class="comment"># 定义监听器与安全协议的映射关系</span></span><br><span class="line"><span class="meta">listener.security.protocol.map</span>=<span class="string">CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,SSL:SSL,SASL_PLAINTEXT:SASL_PLAINTEXT,SASL_SSL:SASL_SSL</span></span><br><span class="line"><span class="comment"># 指定 Kafka 使用的日志（数据）存储目录</span></span><br><span class="line"><span class="meta">log.dirs</span>=<span class="string">/usr/local/kafka-cluster/kafka-node01/data</span></span><br><span class="line"><span class="comment"># 处理网络请求的线程数量</span></span><br><span class="line"><span class="meta">num.network.threads</span>=<span class="string">3</span></span><br><span class="line"><span class="comment"># 用来处理磁盘 IO 的线程数量</span></span><br><span class="line"><span class="meta">num.io.threads</span>=<span class="string">8</span></span><br><span class="line"><span class="comment"># 发送套接字的缓冲区大小</span></span><br><span class="line"><span class="meta">socket.send.buffer.bytes</span>=<span class="string">102400</span></span><br><span class="line"><span class="comment"># 接收套接字的缓冲区大小</span></span><br><span class="line"><span class="meta">socket.receive.buffer.bytes</span>=<span class="string">102400</span></span><br><span class="line"><span class="comment"># 请求套接字的缓冲区大小</span></span><br><span class="line"><span class="meta">socket.request.max.bytes</span>=<span class="string">104857600</span></span><br><span class="line"><span class="comment"># 每个 Topic 在创建时的分区数量,默认是 1 个分区</span></span><br><span class="line"><span class="meta">num.partitions</span>=<span class="string">3</span></span><br><span class="line"><span class="comment"># 用来恢复和清理 Data 下数据的线程数量</span></span><br><span class="line"><span class="meta">num.recovery.threads.per.data.dir</span>=<span class="string">1</span></span><br><span class="line"><span class="comment"># 是否启用自动创建主题的功能,默认是启用,禁用后可以避免因拼写错误或误用主题名而自动创建不必要的主题</span></span><br><span class="line"><span class="meta">auto.create.topics.enable</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"># 每个 Topic 在创建时的分区副本数量,默认是 1 个副本</span></span><br><span class="line"><span class="meta">default.replication.factor</span>=<span class="string">3</span></span><br><span class="line"><span class="comment"># 设置内置主题 __consumer_offsets 的副本数量,默认是 1 个副本,用于存储消费者组的偏移量</span></span><br><span class="line"><span class="meta">offsets.topic.replication.factor</span>=<span class="string">3</span></span><br><span class="line"><span class="comment"># 设置事务状态日志主题 __transaction_state 的副本数量,默认是 1 个副本</span></span><br><span class="line"><span class="meta">transaction.state.log.replication.factor</span>=<span class="string">3</span></span><br><span class="line"><span class="comment"># 设置事务状态日志主题的最小同步副本数（ISR）,确保至少有多个副本成功同步数据才能提交事务</span></span><br><span class="line"><span class="meta">transaction.state.log.min.isr</span>=<span class="string">2</span></span><br><span class="line"><span class="comment"># 每个 Segment 文件保留的最长时间,超时将被删除,默认保留 7 天</span></span><br><span class="line"><span class="meta">log.retention.hours</span>=<span class="string">168</span></span><br><span class="line"><span class="comment"># 每个 Segment 文件的大小,默认最大 1G</span></span><br><span class="line"><span class="meta">log.segment.bytes</span>=<span class="string">1073741824</span></span><br><span class="line"><span class="comment"># 检查过期数据的时间,默认 5 分钟检查一次数据是否过期</span></span><br><span class="line"><span class="meta">log.retention.check.interval.ms</span>=<span class="string">300000</span></span><br></pre></td></tr></tbody></table></figure><div class="admonition warning"><p class="admonition-title">特别注意</p><ul><li>(1) 这里需要更改是 Kafka-KRaft 的配置文件 <code>config/kraft/server.properties</code>，而不是 Kafka 的默认配置文件 <code>config/server.properties</code>。</li><li>(2) 上述部分配置默认是不存在于 Kafka-KRaft 的配置文件 <code>config/kraft/server.properties</code> 中的，因此需要手动添加缺少的配置项，比如 <code>default.replication.factor</code>。</li></ul></div><ul><li>Kafka 创建多个节点</li></ul><p>通过 <code>scp</code> 命令拷贝两份上面已经配置好的 Kafka 节点一安装目录到其他 Kafka 集群节点上，以此作为集群另外两个节点的安装文件。</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拷贝安装目录到节点二</span></span><br><span class="line"><span class="comment"># scp -r /usr/local/kafka-cluster/kafka-node01 root@kafka02:/usr/local/kafka-cluster/kafka-node02</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝安装目录到节点三</span></span><br><span class="line"><span class="comment"># scp -r /usr/local/kafka-cluster/kafka-node01 root@kafka03:/usr/local/kafka-cluster/kafka-node03</span></span><br></pre></td></tr></tbody></table></figure><p>安装目录拷贝完成后，还需要更改另外两个集群节点里的 Kafka-KRaft 配置文件 <code>config/kraft/server.properties</code> 中的 <code>node.id</code>、<code>advertised.listeners</code>、<code>log.dirs</code> 参数。节点二和节点三的核心配置如下：</p><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 节点二的核心配置</span></span><br><span class="line"><span class="meta">node.id</span>=<span class="string">2</span></span><br><span class="line"><span class="meta">process.roles</span>=<span class="string">broker,controller</span></span><br><span class="line"><span class="meta">controller.quorum.voters</span>=<span class="string">1@kafka01:9093,2@kafka02:9093,3@kafka03:9093</span></span><br><span class="line"><span class="attr">listeners</span>=<span class="string">PLAINTEXT://:9092,CONTROLLER://:9093</span></span><br><span class="line"><span class="meta">inter.broker.listener.name</span>=<span class="string">PLAINTEXT</span></span><br><span class="line"><span class="meta">advertised.listeners</span>=<span class="string">PLAINTEXT://kafka02:9092</span></span><br><span class="line"><span class="meta">controller.listener.names</span>=<span class="string">CONTROLLER</span></span><br><span class="line"><span class="meta">listener.security.protocol.map</span>=<span class="string">CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,SSL:SSL,SASL_PLAINTEXT:SASL_PLAINTEXT,SASL_SSL:SASL_SSL</span></span><br><span class="line"><span class="meta">log.dirs</span>=<span class="string">/usr/local/kafka-cluster/kafka-node02/data</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 节点三的核心配置</span></span><br><span class="line"><span class="meta">node.id</span>=<span class="string">3</span></span><br><span class="line"><span class="meta">process.roles</span>=<span class="string">broker,controller</span></span><br><span class="line"><span class="meta">controller.quorum.voters</span>=<span class="string">1@kafka01:9093,2@kafka02:9093,3@kafka03:9093</span></span><br><span class="line"><span class="attr">listeners</span>=<span class="string">PLAINTEXT://:9092,CONTROLLER://:9093</span></span><br><span class="line"><span class="meta">inter.broker.listener.name</span>=<span class="string">PLAINTEXT</span></span><br><span class="line"><span class="meta">advertised.listeners</span>=<span class="string">PLAINTEXT://kafka03:9092</span></span><br><span class="line"><span class="meta">controller.listener.names</span>=<span class="string">CONTROLLER</span></span><br><span class="line"><span class="meta">listener.security.protocol.map</span>=<span class="string">CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,SSL:SSL,SASL_PLAINTEXT:SASL_PLAINTEXT,SASL_SSL:SASL_SSL</span></span><br><span class="line"><span class="meta">log.dirs</span>=<span class="string">/usr/local/kafka-cluster/kafka-node03/data</span></span><br></pre></td></tr></tbody></table></figure><h3 id="集群启动"><a href="#集群启动" class="headerlink" title="集群启动"></a>集群启动</h3><h4 id="初始化存储目录"><a href="#初始化存储目录" class="headerlink" title="初始化存储目录"></a>初始化存储目录</h4><ul><li>首先，在任意一个集群节点（比如节点一）中生成一个唯一的集群 ID</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 节点一生成一个唯一的集群 ID</span></span><br><span class="line"><span class="comment"># /usr/local/kafka-cluster/kafka-node01/bin/kafka-storage.sh random-uuid</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rNh-6V2lSvy4kC0LmYOl6w</span><br></pre></td></tr></tbody></table></figure><ul><li>然后，在所有 Kafka-KRaft 集群节点中，分别用上面生成的集群 ID 来初始化 Kafka 的存储目录</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化节点一的存储目录</span></span><br><span class="line"><span class="comment"># /usr/local/kafka-cluster/kafka-node01/bin/kafka-storage.sh format -t rNh-6V2lSvy4kC0LmYOl6w -c /usr/local/kafka-cluster/kafka-node01/config/kraft/server.properties</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化节点二的存储目录</span></span><br><span class="line"><span class="comment"># /usr/local/kafka-cluster/kafka-node02/bin/kafka-storage.sh format -t rNh-6V2lSvy4kC0LmYOl6w -c /usr/local/kafka-cluster/kafka-node02/config/kraft/server.properties</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化节点三的存储目录</span></span><br><span class="line"><span class="comment"># /usr/local/kafka-cluster/kafka-node03/bin/kafka-storage.sh format -t rNh-6V2lSvy4kC0LmYOl6w -c /usr/local/kafka-cluster/kafka-node03/config/kraft/server.properties</span></span><br></pre></td></tr></tbody></table></figure><h4 id="启动各个集群节点"><a href="#启动各个集群节点" class="headerlink" title="启动各个集群节点"></a>启动各个集群节点</h4><p>在所有 Kafka-KRaft 集群节点中，分别在后台启动 Kafka 节点</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动节点一</span></span><br><span class="line"><span class="comment"># /usr/local/kafka-cluster/kafka-node01/bin/kafka-server-start.sh -daemon /usr/local/kafka-cluster/kafka-node01/config/kraft/server.properties</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动节点二</span></span><br><span class="line"><span class="comment"># /usr/local/kafka-cluster/kafka-node02/bin/kafka-server-start.sh -daemon /usr/local/kafka-cluster/kafka-node02/config/kraft/server.properties</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动节点三</span></span><br><span class="line"><span class="comment"># /usr/local/kafka-cluster/kafka-node03/bin/kafka-server-start.sh -daemon /usr/local/kafka-cluster/kafka-node03/config/kraft/server.properties</span></span><br></pre></td></tr></tbody></table></figure><h4 id="查看启动日志信息"><a href="#查看启动日志信息" class="headerlink" title="查看启动日志信息"></a>查看启动日志信息</h4><p>在所有 Kafka-KRaft 集群节点中，分别查看 Broker 和 Controller 的启动日志信息，观察 Kafka 节点是否正常启动</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看节点一的 Brokder 日志</span></span><br><span class="line"><span class="comment"># vim /usr/local/kafka-cluster/kafka-node01/logs/server.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看节点一的 Controller 日志</span></span><br><span class="line"><span class="comment"># vim /usr/local/kafka-cluster/kafka-node01/logs/controller.log</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看节点二的 Brokder 日志</span></span><br><span class="line"><span class="comment"># vim /usr/local/kafka-cluster/kafka-node02/logs/server.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看节点二的 Controller 日志</span></span><br><span class="line"><span class="comment"># vim /usr/local/kafka-cluster/kafka-node02/logs/controller.log</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看节点三的 Brokder 日志</span></span><br><span class="line"><span class="comment"># vim /usr/local/kafka-cluster/kafka-node03/logs/server.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看节点三的 Controller 日志</span></span><br><span class="line"><span class="comment"># vim /usr/local/kafka-cluster/kafka-node03/logs/controller.log</span></span><br></pre></td></tr></tbody></table></figure><div class="admonition note"><p class="admonition-title">前台启动 Kafka 集群节点</p><p>若希望更直观地观察 Kafka-KRaft 集群节点的启动日志信息，可以去掉上述节点启动命令中的 <code>-daemon</code> 参数，这样就可以使用前台方式启动 Kafka-KRaft 集群节点。</p></div><h3 id="集群管理"><a href="#集群管理" class="headerlink" title="集群管理"></a>集群管理</h3><h4 id="查看状态"><a href="#查看状态" class="headerlink" title="查看状态"></a>查看状态</h4><p>在所有 Kafka-KRaft 集群节点中，分别使用以下命令查看集群节点的运行状态。如果发现集群节点启动失败，则可以根据 Kafka 的日志文件来定位问题。</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看端口占用情况</span></span><br><span class="line"><span class="comment"># netstat -nplt | grep -E ':9092|:9093'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Kafka 进程</span></span><br><span class="line"><span class="comment"># ps -aux | grep kafka</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有 Java 进程</span></span><br><span class="line"><span class="comment"># jps -l</span></span><br></pre></td></tr></tbody></table></figure><h4 id="集群关闭"><a href="#集群关闭" class="headerlink" title="集群关闭"></a>集群关闭</h4><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭节点一</span></span><br><span class="line"><span class="comment"># /usr/local/kafka-cluster/kafka-node01/bin/kafka-server-stop.sh stop</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭节点二</span></span><br><span class="line"><span class="comment"># /usr/local/kafka-cluster/kafka-node02/bin/kafka-server-stop.sh stop</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭节点三</span></span><br><span class="line"><span class="comment"># /usr/local/kafka-cluster/kafka-node03/bin/kafka-server-stop.sh stop</span></span><br></pre></td></tr></tbody></table></figure><h4 id="集群重建"><a href="#集群重建" class="headerlink" title="集群重建"></a>集群重建</h4><p>若希望重建 Kafka-KRaft 集群，可以按照以下步骤进行操作（<strong>清空数据目录的操作不可恢复，生产环境下慎用</strong>）。</p><ul><li>(1) 关闭所有 Kafka-KRaft 集群节点</li><li> (2) 在所有 Kafka-KRaft 集群节点中，分别清空 <code>data</code> 数据目录和 <code>logs</code> 日志目录里的文件</li><li> (3) 在所有 Kafka-KRaft 集群节点中，分别重新执行 <code>kafka-storage.sh format</code> 命令来初始化 Kafka 的存储目录</li><li> (4) 重新启动所有 Kafka-KRaft 集群节点</li></ul><h3 id="集群测试"><a href="#集群测试" class="headerlink" title="集群测试"></a>集群测试</h3><ul><li>进入任意节点（比如节点一）的安装目录下的 <code>bin</code> 目录</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入安装目录</span></span><br><span class="line"><span class="comment"># cd /usr/local/kafka-cluster/kafka-node01/bin</span></span><br></pre></td></tr></tbody></table></figure><ul><li>创建主题</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建主题</span></span><br><span class="line"><span class="comment"># ./kafka-topics.sh --bootstrap-server kafka02:9092 --create --partitions 1 --replication-factor 3 --topic test</span></span><br></pre></td></tr></tbody></table></figure><ul><li>查看主题列表</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看主题列表</span></span><br><span class="line"><span class="comment"># ./kafka-topics.sh --bootstrap-server kafka02:9092 --list</span></span><br></pre></td></tr></tbody></table></figure><ul><li>查看主题详细信息</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看主题详细信息</span></span><br><span class="line"><span class="comment"># ./kafka-topics.sh --bootstrap-server kafka02:9092 --topic test --describe</span></span><br></pre></td></tr></tbody></table></figure><ul><li>启动控制台消费者</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动消费者</span></span><br><span class="line"><span class="comment"># ./kafka-console-consumer.sh --bootstrap-server kafka02:9092 --topic test --from-beginning</span></span><br></pre></td></tr></tbody></table></figure><ul><li>启动控制台生产者</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动生产者</span></span><br><span class="line"><span class="comment"># ./kafka-console-producer.sh --broker-list kafka02:9092 --topic test</span></span><br></pre></td></tr></tbody></table></figure><ul><li>在生产者的控制台手动输入 <code>hello kafka</code>，消费者就可以消费到生产者的消息，并在控制台输出 <code>hello kafka</code>，这表示消费者成功消费了生产者发送的消息！</li></ul><h2 id="Kafka-KRaft-集群调优"><a href="#Kafka-KRaft-集群调优" class="headerlink" title="Kafka-KRaft 集群调优"></a>Kafka-KRaft 集群调优</h2><h3 id="调整-Kafka-的堆内存大小"><a href="#调整-Kafka-的堆内存大小" class="headerlink" title="调整 Kafka 的堆内存大小"></a>调整 Kafka 的堆内存大小</h3><p>若希望调整 Kafka 的堆内存大小，可以找到各个 Kafka-KRaft 集群节点的服务启动脚本文件 <code>bin/kafka-server-start.sh</code>，然后在脚本文件中修改如下参数值：</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [ <span class="string">"x<span class="variable">$KAFKA_HEAP_OPTS</span>"</span> = <span class="string">"x"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">export</span> KAFKA_HEAP_OPTS=<span class="string">"-Xmx2G -Xms2G"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></tbody></table></figure><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/e3aa2fd8.html" title="Linux 生产环境搭建 Kafka-KRaft 集群">https://www.techgrow.cn/posts/e3aa2fd8.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/Linux%E8%BF%90%E7%BB%B4/" rel="tag"><i class="fa fa-tag"></i> Linux运维</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/8c3cfc46.html" rel="prev" title="C++ 巩固基础之一"><i class="fa fa-angle-left"></i> C++ 巩固基础之一</a></div><div class="post-nav-item"> <a href="/posts/6507d7ec.html" rel="next" title="SpringBoot 整合 Dubbo 3 案例">SpringBoot 整合 Dubbo 3 案例<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">1.7m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">26:10</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"/lib/mermaid/dist/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/e3aa2fd8.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>