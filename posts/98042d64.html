<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="/lib/pace-js/themes/blue/pace-theme-minimal.css"><script src="/lib/pace-js/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.techgrow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍如何在 Spring 中解决循环依赖的问题，并深度剖析 Spring 的底层源码。"><meta property="og:type" content="article"><meta property="og:title" content="Spring 之循环依赖底层源码剖析"><meta property="og:url" content="https://www.techgrow.cn/posts/98042d64.html"><meta property="og:site_name" content="Clay 的技术空间"><meta property="og:description" content="本文主要介绍如何在 Spring 中解决循环依赖的问题，并深度剖析 Spring 的底层源码。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-2.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-1.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-4.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-5.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-6.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-3.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-7.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-8.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-9.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-10.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-11.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-12.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-13.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-14.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-15.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-16.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-17.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-18.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-19.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-20.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-21.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-22.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-23.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-24.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-25.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-26.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-27.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-28.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-29.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-30.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-31.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-32.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-33.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-34.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-35.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-36.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-37.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-38.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-39.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-40.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-41.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-42.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-43.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-44.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-45.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-46.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-47.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-48.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-49.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-50.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-51.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-52.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-53.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-54.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-55.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-56.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-57.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-58.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-59.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-60.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-61.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-62.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-63.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-64.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-65.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-66.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-67.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-68.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-69.png"><meta property="og:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-70.png"><meta property="article:published_time" content="2019-05-23T15:20:42.000Z"><meta property="article:modified_time" content="2019-05-23T15:20:42.000Z"><meta property="article:author" content="Clay"><meta property="article:tag" content="Java"><meta property="article:tag" content="源码剖析"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.techgrow.cn/asset/2024/04/spring-loop-dependency-2.png"><link rel="canonical" href="https://www.techgrow.cn/posts/98042d64.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.techgrow.cn/posts/98042d64.html","path":"posts/98042d64.html","title":"Spring 之循环依赖底层源码剖析"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Spring 之循环依赖底层源码剖析 | Clay 的技术空间</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-135294383-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135294383-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script class="next-config" data-name="baidu_analytics" type="application/json">"84c09b30349a65573c5c642ff336969b"</script><script src="/js/third-party/analytics/baidu-analytics.js"></script><link rel="dns-prefetch" href="https://waline.techgrow.cn"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.admonition{margin:1.5625em 0;padding:.6rem;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:#fafafa}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}</style><link rel="alternate" href="/atom.xml" title="Clay 的技术空间" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion"><script src="/lib/jquery/dist/jquery.min.js"></script><script data-pjax="">!function(){var t=window.location.host;if(-1==t.indexOf("127.0.0.1")&&-1==t.indexOf("localhost")){var o=document.createElement("script"),e=window.location.protocol.split(":")[0];o.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(o,n)}}()</script><link rel="stylesheet" href="/lib/aplayer/dist/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="/lib/aplayer/dist/APlayer.min.js"></script><script src="/lib/aplayer/dist/color-thief.js"></script><script src="/lib/aplayer-init.js"></script><script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script><script>function getTitle(){var t=jQuery("meta[property='og:title']");return t?t.attr("content"):""}function getDesc(){var t=jQuery("meta[property='og:description']");return t?t.attr("content"):""}function randomString(t){for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=e.length,i="",r=0;r<t;++r)i+=e.charAt(Math.floor(Math.random()*n));return i}function initWx(t){wx.config({debug:!1,appId:t.appId,nonceStr:t.nonceStr,signature:t.signature,timestamp:t.timestamp,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:t.title,link:t.link,imgUrl:t.imgUrl,success:function(){}}),wx.onMenuShareAppMessage({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,type:"link",dataUrl:"",success:function(){}}),wx.onMenuShareQQ({title:t.title,desc:t.desc,link:t.link,imgUrl:t.imgUrl,success:function(){},cancel:function(){}})}),wx.error(function(t){})}jQuery(function(){var e=getDesc(),n=getTitle(),i=randomString(16),r=(new Date).getTime(),a=window.location.href,t="https://open.techgrow.cn/api/wechat/js/signature?url="+a+"&noncestr="+i+"&timestamp="+r;jQuery.getJSON(t,function(t){initWx({desc:e,title:n,link:a,nonceStr:i,timestamp:r,signature:t.data,appId:"wx1fcf69355af43d41",imgUrl:"https://www.techgrow.cn/img/wx_share.jpg"})})})</script><div style="display:none"><img src="https://www.techgrow.cn/img/wx_share.jpg" alt=""></div><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Clay 的技术空间</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">用进废退 | 艺不压身</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-readingnotes"><a href="https://www.techgrow.cn/reading/" rel="section"><i class="fa fa-book-open-reader fa-fw"></i>读书笔记</a></li><li class="menu-item menu-item-commentmanage"><a href="https://waline.techgrow.cn/" rel="external nofollow" target="_blank"><i class="fa fa-comment fa-fw"></i>评论管理</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="nav-text">版本说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="nav-text">循环依赖的概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%98%E6%96%B9%E8%A7%A3%E9%87%8A%E8%AF%B4%E6%98%8E"><span class="nav-text">官方解释说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96"><span class="nav-text">什么是循环依赖</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E9%AA%8C%E8%AF%81%E4%B8%80"><span class="nav-text">循环依赖验证一</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E7%9A%84%E6%BC%94%E7%A4%BA%E4%BB%A3%E7%A0%81"><span class="nav-text">循环依赖的演示代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-text">循环依赖的解决方案</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E9%AA%8C%E8%AF%81%E4%BA%8C"><span class="nav-text">循环依赖验证二</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E7%9A%84%E6%BC%94%E7%A4%BA%E4%BB%A3%E7%A0%81-1"><span class="nav-text">循环依赖的演示代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1"><span class="nav-text">循环依赖的解决方案</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E7%9A%84%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90"><span class="nav-text">循环依赖的底层源码剖析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BA%90%E7%A0%81-Debug-%E7%9A%84%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="nav-text">源码 Debug 的前置知识</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E4%BE%8B%E5%8C%96%E4%B8%8E%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">实例化与初始化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98%E4%B8%8E%E5%9B%9B%E5%A4%A7%E6%96%B9%E6%B3%95"><span class="nav-text">三级缓存与四大方法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98"><span class="nav-text">三级缓存</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9B%9B%E5%A4%A7%E6%96%B9%E6%B3%95"><span class="nav-text">四大方法</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%9C%A8%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98%E4%B8%AD%E7%9A%84%E8%BF%81%E7%A7%BB"><span class="nav-text">对象在三级缓存中的迁移</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BA%90%E7%A0%81-Debug-%E7%9A%84%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90"><span class="nav-text">源码 Debug 的详细分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Debug-%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="nav-text">Debug 的代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Debug-%E7%9A%84%E6%AD%A5%E9%AA%A4"><span class="nav-text">Debug 的步骤</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5"><span class="nav-text">第一阶段</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5"><span class="nav-text">第二阶段</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5"><span class="nav-text">第三阶段</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E9%98%B6%E6%AE%B5"><span class="nav-text">第四阶段</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AC%AC%E4%BA%94%E9%98%B6%E6%AE%B5"><span class="nav-text">第五阶段</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%80%BB%E7%BB%93"><span class="nav-text">循环依赖问题解决总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E4%B8%80"><span class="nav-text">解决方案一</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E4%BA%8C"><span class="nav-text">解决方案二</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E4%B8%89"><span class="nav-text">解决方案三</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Clay" src="/img/head.jpg"></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <span class="site-state-item-count">736</span> <span class="site-state-item-name">文章</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">53</span> <span class="site-state-item-name">标签</span></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/rqh656418510" title="GitHub → https://github.com/rqh656418510" rel="external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:rong656418510@gmail.com" title="E-Mail → mailto:rong656418510@gmail.com" rel="external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → /atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span><span class="links-of-author-item"><a href="/sitemap.xml" title="SiteMap → /sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i> SiteMap</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.techgrow.cn/posts/98042d64.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/head.jpg"><meta itemprop="name" content="Clay"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Clay 的技术空间"><meta itemprop="description" content="专注于 Java 后端、分布式、微服务、云原生、数据库、系统架构、大数据、云计算、虚拟化、人工智能学习的技术博客。"></span><span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Spring 之循环依赖底层源码剖析 | Clay 的技术空间"><meta itemprop="description" content="本文主要介绍如何在 Spring 中解决循环依赖的问题，并深度剖析 Spring 的底层源码。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Spring 之循环依赖底层源码剖析</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-05-23 23:20:42" itemprop="dateCreated datePublished" datetime="2019-05-23T23:20:42+08:00">2019-05-23</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">评论数：</span><a title="waline" href="/posts/98042d64.html#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/98042d64.html" itemprop="commentCount"></span></a></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>9.6k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 ≈</span> <span>9 分钟</span></span></div></div></header><div class="post-body post-container" itemprop="articleBody" id="readmore-container"><h2 id="版本说明"><a href="#版本说明" class="headerlink" title="版本说明"></a>版本说明</h2><p>本文使用的 Spring 版本为 <code>5.2.8.RELEASE</code>，在阅读 Spring 底层源码时，不同版本之间可能会有细微的差别。</p><h2 id="循环依赖的概述"><a href="#循环依赖的概述" class="headerlink" title="循环依赖的概述"></a>循环依赖的概述</h2><div class="admonition note"><p class="admonition-title">Spring 官方文档</p><ul><li><a target="_blank" rel="external nofollow" href="https://docs.spring.io/spring-framework/reference/core/beans/dependencies/factory-collaborators.html#beans-dependency-resolution">Spring Docs - Circular Dependencies</a></li></ul></div><span id="more"></span><h3 id="官方解释说明"><a href="#官方解释说明" class="headerlink" title="官方解释说明"></a>官方解释说明</h3><p><img data-src="../../../asset/2024/04/spring-loop-dependency-2.png"></p><blockquote><p>翻译：如果主要使用构造方法注入，则可能会创建一个无法解决的循环依赖场景。例如：类 A 通过构造方法注入需要类 B 的实例，类 B 通过构造方法注入要求类 A 的实例。如果为类 A 和类 B 配置 Bean 以相互注入，那么 Spring IOC 容器会在运行时检测到这个循环引用，并抛出 <code>BeanCurrentlyInCreationException</code> 异常。一种可能的解决方案是编辑一些类的源代码，由 Setter 方法而不是构造方法进行注入。或者，避免构造方法注入，只使用 Setter 方法注入。换句话说，尽管不建议这样做，但您可以使用 Setter 方法注入来配置循环依赖关系。与典型的情况（没有循环依赖关系）不同，Bean A 和 Bean B 之间的循环依赖关系迫使其中一个 Bean 在完全初始化之前注入另一个 Bean（典型的先有鸡后有蛋的场景）。</p></blockquote><blockquote><p>结论一：在 Spring 中，如果 Bean 不是单例或者使用了构造方法注入，一旦发生了循环依赖，Spring 无法自行解决循环依赖问题。<br>结论二：对于 A、B、C 循环依赖的问题，只要 Bean A 的注入方式是 Setter 方法注入或者属性注入，且 Bean 是单例，那么就不会发生循环依赖问题。</p></blockquote><h3 id="什么是循环依赖"><a href="#什么是循环依赖" class="headerlink" title="什么是循环依赖"></a>什么是循环依赖</h3><p>Spring 中的循环依赖指的是当两个或多个 Bean 之间存在相互依赖关系时，可能导致的循环引用问题。具体来说，当 Bean A 依赖于 Bean B，而 Bean B 又依赖于 Bean C，而 Bean C 又依赖于 Bean A，这样就会发生循环依赖。这种情况下，Spring 容器在初始化 Bean 的过程中可能会陷入死循环，导致应用程序无法启动或者抛出异常。这是因为 Spring 在创建 Bean 的过程中是通过构造方法注入或者 Setter 方法注入依赖的，如果存在循环依赖，那么容器就无法决定先创建哪个 Bean，从而无法满足依赖关系。</p><p><img data-src="../../../asset/2024/04/spring-loop-dependency-1.png"></p><div class="admonition note"><p class="admonition-title">面试技巧</p><p>通常来说，如果面试问到 Spring 容器的内部是如何解决循环依赖的，那么一定是指在默认的单例 Bean 中，属性互相引用的场景。</p></div><h2 id="循环依赖验证一"><a href="#循环依赖验证一" class="headerlink" title="循环依赖验证一"></a>循环依赖验证一</h2><h3 id="循环依赖的演示代码"><a href="#循环依赖的演示代码" class="headerlink" title="循环依赖的演示代码"></a>循环依赖的演示代码</h3><blockquote><p>这里将演示，在 Spring 中，使用构造方法注入会很容易产生循环依赖的问题。</p></blockquote><ul><li>定义 Bean A</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceA</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServiceB serviceB;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceA</span><span class="params">(ServiceB serviceB)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.serviceB = serviceB;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>定义 Bean B</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceB</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServiceA serviceA;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceB</span><span class="params">(ServiceA serviceA)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.serviceA = serviceA;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>定义测试类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 这里基于 SpringBootTest 进行单元测试</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest(classes = {MainTestApplication.class})</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainTestApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ServiceA serviceA;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ServiceB serviceB;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>{</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>代码执行输出的结果，会抛出 <code>BeanCurrentlyInCreationException</code> 异常</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Caused by: org.springframework.beans.factory.BeanCurrentlyInCreationException: Error creating bean with name 'serviceA': Requested bean is currently in creation: Is there an unresolvable circular reference?</span><br><span class="line">	at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.beforeSingletonCreation(DefaultSingletonBeanRegistry.java:347)</span><br><span class="line">	at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:219)</span><br><span class="line">	at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:322)</span><br><span class="line">	at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:202)</span><br></pre></td></tr></tbody></table></figure><ul><li>构造方法注入很容易产生循环依赖的问题，想让构造方法注入支持循环依赖，那是不可能的。如果构造方法注入支持循环依赖，那么程序员就可以无限套娃，代码如下</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientConstructor</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        <span class="comment">// 无限套娃</span></span><br><span class="line">        <span class="keyword">new</span> ServiceA(<span class="keyword">new</span> ServiceB(<span class="keyword">new</span> ServiceA(<span class="keyword">new</span> ServiceB())));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>简而言之，多个类在各自实例化时都需要对方实例，这就类似于线程死锁，如果不采取一种办法解决，那么它们将永远互相等待下去</li></ul><h3 id="循环依赖的解决方案"><a href="#循环依赖的解决方案" class="headerlink" title="循环依赖的解决方案"></a>循环依赖的解决方案</h3><blockquote><p>在 Spring 中，可以使用 Setter 方法注入且单例（Singleton）来解决循环依赖的问题。</p></blockquote><ul><li>定义 Bean A</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceA</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ServiceB serviceB;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceA</span><span class="params">()</span> </span>{</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setServiceB</span><span class="params">(ServiceB serviceB)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.serviceB = serviceB;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>定义 Bean B</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceB</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ServiceA serviceA;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceB</span><span class="params">()</span> </span>{</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setServiceA</span><span class="params">(ServiceA serviceA)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.serviceA = serviceA;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="循环依赖验证二"><a href="#循环依赖验证二" class="headerlink" title="循环依赖验证二"></a>循环依赖验证二</h2><p>这里将演示，在 Spring 中，使用 Setter 方法注入且单例（Singleton）的场景是支持循环依赖的，而使用 Setter 方法注入且原型（Prototype）的场景是不支持循环依赖的。</p><h3 id="循环依赖的演示代码-1"><a href="#循环依赖的演示代码-1" class="headerlink" title="循环依赖的演示代码"></a>循环依赖的演示代码</h3><ul><li>定义 A 类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> B b;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> B <span class="title">getB</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.b;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setB</span><span class="params">(B b)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.b = b;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">()</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"A created success"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>定义 B 类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> A a;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> A <span class="title">getA</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.a;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setA</span><span class="params">(A a)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.a = a;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">B</span><span class="params">()</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"B created sucdess"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>定义测试类</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringContainerTest</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"application-context.xml"</span>);</span><br><span class="line">        A a = context.getBean(A.class);</span><br><span class="line">        B b = context.getBean(B.class);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>定义 Spring 的 XML 配置文件，<code>scope</code> 的默认值就是 <code>singleton</code>，可以省略不写，表示每次从 IOC 容器中获取的 Bean 实例都是单例</li></ul><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"a"</span> <span class="attr">class</span>=<span class="string">"com.java.interview.spring.dependency2.A"</span> <span class="attr">scope</span>=<span class="string">"singleton"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"b"</span> <span class="attr">ref</span>=<span class="string">"b"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"b"</span> <span class="attr">class</span>=<span class="string">"com.java.interview.spring.dependency2.B"</span> <span class="attr">scope</span>=<span class="string">"singleton"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"a"</span> <span class="attr">ref</span>=<span class="string">"a"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><ul><li>代码执行输出的结果如下，使用 Setter 方法注入且单例（Singleton）的场景是支持循环依赖的，程序运行不会报错</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A created success</span><br><span class="line">B created sucdess</span><br></pre></td></tr></tbody></table></figure><ul><li>将上述 Spring 的 XML 配置文件中的 <code>scope</code> 修改为 <code>prototype</code>，表示每次从 IOC 容器中获取 Bean 实例时，都会产生一个新的 Bean 实例</li></ul><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"a"</span> <span class="attr">class</span>=<span class="string">"com.java.interview.spring.dependency2.A"</span> <span class="attr">scope</span>=<span class="string">"prototype"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"b"</span> <span class="attr">ref</span>=<span class="string">"b"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"b"</span> <span class="attr">class</span>=<span class="string">"com.java.interview.spring.dependency2.B"</span> <span class="attr">scope</span>=<span class="string">"prototype"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"a"</span> <span class="attr">ref</span>=<span class="string">"a"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><ul><li>代码执行就会报下面的错误，根本原因是使用 Setter 方法注入且原型（Prototype）的场景是不支持循环依赖的</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread "main" org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'a' defined in class path resource [application-context.xml]: Cannot resolve reference to bean 'b' while setting bean property 'b'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'b' defined in class path resource [application-context.xml]: Cannot resolve reference to bean 'a' while setting bean property 'a'; nested exception is org.springframework.beans.factory.BeanCurrentlyInCreationException: Error creating bean with name 'a': Requested bean is currently in creation: Is there an unresolvable circular reference?</span><br><span class="line">	at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveReference(BeanDefinitionValueResolver.java:342)</span><br><span class="line">	at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveValueIfNecessary(BeanDefinitionValueResolver.java:113)</span><br></pre></td></tr></tbody></table></figure><h3 id="循环依赖的解决方案-1"><a href="#循环依赖的解决方案-1" class="headerlink" title="循环依赖的解决方案"></a>循环依赖的解决方案</h3><blockquote><p>Spring 内部是通过三级缓存来解决循环依赖，底层源码如下：</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-3.png"></p><ul><li><p>第一级缓存</p><ul><li><code>Map&lt;String, Object&gt; singletonObjects = new ConcurrentHashMap&lt;&gt;(256);</code></li><li>可称之为成品单例池，存放已经经历了完整生命周期的 Bean 对象，常说的 Spring 容器就是指它，平时获取单例 Bean 就是在这里面获取的</li></ul></li><li><p>第二级缓存</p><ul><li><code>Map&lt;String, Object&gt; earlySingletonObjects = new HashMap&lt;&gt;(16);</code></li><li>存放早期暴露出来的 Bean 对象，Bean 的生命周期未结束（属性还未填充完整，可以认为是半成品的 Bean 对象）</li></ul></li><li><p>第三级缓存</p><ul><li><code>Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = new HashMap&lt;&gt;(16);</code></li><li>存放可以生成 Bean 的工厂，用于处理 AOP 代理或 FactoryBean 生成的代理对象</li></ul></li></ul><div class="admonition warning"><p class="admonition-title">特别注意</p><p>在 Spring 中，只有单例的 Bean 会通过三级缓存提前暴露来解决循环依赖的问题，而非单例的 Bean，每次从容器中获取都是一个全新的 Bean，即都会重新创建 Bean，所以非单例的 Bean 是没有缓存的，Spring 不会将其放到三级缓存中，这也导致了使用 Setter 方法注入且原型（Prototype）的场景不支持循环依赖。</p></div><h2 id="循环依赖的底层源码剖析"><a href="#循环依赖的底层源码剖析" class="headerlink" title="循环依赖的底层源码剖析"></a>循环依赖的底层源码剖析</h2><h3 id="源码-Debug-的前置知识"><a href="#源码-Debug-的前置知识" class="headerlink" title="源码 Debug 的前置知识"></a>源码 Debug 的前置知识</h3><h4 id="实例化与初始化"><a href="#实例化与初始化" class="headerlink" title="实例化与初始化"></a>实例化与初始化</h4><ul><li>实例化：在堆内存中申请一块内存空间，用于创建（存放）对象</li></ul><p><img data-src="../../../asset/2024/04/spring-loop-dependency-4.png"></p><ul><li>初始化：完成对象属性的填充</li></ul><p><img data-src="../../../asset/2024/04/spring-loop-dependency-5.png"></p><h4 id="三级缓存与四大方法"><a href="#三级缓存与四大方法" class="headerlink" title="三级缓存与四大方法"></a>三级缓存与四大方法</h4><p><img data-src="../../../asset/2024/04/spring-loop-dependency-6.png"></p><h5 id="三级缓存"><a href="#三级缓存" class="headerlink" title="三级缓存"></a>三级缓存</h5><blockquote><p>Spring 内部是通过三级缓存来解决循环依赖，底层源码如下：</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-3.png"></p><ul><li><p>第一级缓存</p><ul><li><code>Map&lt;String, Object&gt; singletonObjects = new ConcurrentHashMap&lt;&gt;(256);</code></li><li>存放的是已经初始化好了的 Bean 实例，Bean 名称与 Bean 实例相对应，即所谓的单例池。</li><li>表示 Bean 已经经历了完整的生命周期。</li></ul></li><li><p>第二级缓存</p><ul><li><code>Map&lt;String, Object&gt; earlySingletonObjects = new HashMap&lt;&gt;(16);</code></li><li>存放的是实例化了，但是未初始化的 Bean 实例，Bean 名称与 Bean 实例相对应。</li><li>表示 Bean 的生命周期还没走完（属性还未填充完整，可以认为是半成品的 Bean 对象）就将这个 Bean 放入该缓存中，也就是将已实例化但未初始化的 Bean 放入该缓存中。</li></ul></li><li><p>第三级缓存</p><ul><li><code>Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = new HashMap&lt;&gt;(16);</code></li><li>存放的是生成 Bean 的 Bean 工厂实例，Bean 名称与 Bean 工厂实例对应，用于处理 AOP 代理或 FactoryBean 生成的代理对象。</li><li>假如 A 类实现了 FactoryBean 接口，那么依赖注入的不是 A 类，而是 A 类生成的 Bean 实例。</li></ul></li></ul><h5 id="四大方法"><a href="#四大方法" class="headerlink" title="四大方法"></a>四大方法</h5><ul><li><code>getSingleton()</code>：从容器里面获得单例的 Bean，如果不存在，则会创建 Bean。</li><li><code>doCreateBean()</code>：执行创建 Bean 的操作（在 Spring 中以 <code>do</code> 开头的方法都是干实事的方法）。</li><li><code>populateBean()</code>：创建完 Bean 之后，对 Bean 的属性进行填充。</li><li><code>addSingleton()</code>：Bean 初始化完成之后，将其添加到单例池中，下次执行 <code>getSingleton()</code> 方法时就能获取到单例的 Bean。</li></ul><h4 id="对象在三级缓存中的迁移"><a href="#对象在三级缓存中的迁移" class="headerlink" title="对象在三级缓存中的迁移"></a>对象在三级缓存中的迁移</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> B b;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> A a;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><p>(1) 首先实例化 A，然后对 A 进行初始化。</p></li><li><p>(2) A 在初始化的过程中需要 B，于是 A 将自己放到第三级缓存里面，然后去实例化 B。</p></li><li><p>(3) B 实例化的时候发现需要 A，于是 B 先查第一级缓存，发现缓存里没有；再查第二级缓存，缓存里还是没有；再查第三级缓存，终于找到了 A；然后将第三级缓存里面的 A 放到第二级缓存里面，并删除第三级缓存里面的 A。</p></li><li><p>(4) B 顺利完成初始化后，将自己放到第一级缓存里面（此时 B 里面的 A 依然是处于初始化中状态），然后回来接着初始化 A。</p></li><li><p>(5) 由于 B 已经初始化完成，A 可以直接从第一级缓存里面获取到 B，然后完成 A 的初始化，并将 A 放到第一级缓存里面，并删除第二级缓存里面的 A。</p></li></ul><h3 id="源码-Debug-的详细分析"><a href="#源码-Debug-的详细分析" class="headerlink" title="源码 Debug 的详细分析"></a>源码 Debug 的详细分析</h3><h4 id="Debug-的代码"><a href="#Debug-的代码" class="headerlink" title="Debug 的代码"></a>Debug 的代码</h4><p>这里将基于上面 <a href="/posts/98042d64.html#%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E9%AA%8C%E8%AF%81%E4%BA%8C">循环依赖验证二</a> 的源码进行 Debug 分析。</p><h4 id="Debug-的步骤"><a href="#Debug-的步骤" class="headerlink" title="Debug 的步骤"></a>Debug 的步骤</h4><div class="admonition note"><p class="admonition-title">如何阅读框架的源码？</p><p>阅读框架源码的方法是：打断点 + 看输出的日志。</p></div><h5 id="第一阶段"><a href="#第一阶段" class="headerlink" title="第一阶段"></a>第一阶段</h5><blockquote><p>在 <code>ApplicationContext context = new ClassPathXmlApplicationContext("application-context.xml")</code> 代码处打上断点，逐步执行 Step Over，发现执行 <code>new ClassPathXmlApplicationContext()</code> 操作时，Bean A 和 Bean B 都已经被创建好了，因此需要进入该操作的内部。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-7.png"></p><blockquote><p>执行 Step Into，进入 <code>new ClassPathXmlApplicationContext()</code> 操作的内部，首先进入了静态代码块，这里没有要看的代码，执行 Step Out 跳出该代码块。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-8.png"></p><blockquote><p>再次执行 Step Into，进入 ClassPathXmlApplicationContext 类的构造方法，该构造方法使用 <code>this</code> 调用了另一个重载构造方法。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-9.png"></p><blockquote><p>继续执行 Step Into，进入 ClassPathXmlApplicationContext 的重载构造方法后，单步执行 Step Over，发现执行完 <code>refresh()</code> 方法后会输出日志，于是将断点打在 <code>refresh()</code> 那一行代码。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-10.png"></p><blockquote><p>继续执行 Step Into，进入 <code>refresh()</code> 方法，发现执行完 <code>finishBeanFactoryInitialization()</code> 方法后会输出日志，于是将断点打在 <code>finishBeanFactoryInitialization()</code> 那一行代码，从注释也可以看出该方法完成了非懒加载单例 Bean 的实例化。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-11.png"></p><blockquote><p>继续执行 Step Into，进入 <code>finishBeanFactoryInitialization()</code> 方法，发现执行完 <code>beanFactory.preInstantiateSingletons()</code> 方法后会输出日志，于是将断点打在 <code>beanFactory.preInstantiateSingletons()</code> 那一行代码，，从注释也可以看出该方法完成了非懒加载单例 Bean 的实例化。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-12.png"></p><h5 id="第二阶段"><a href="#第二阶段" class="headerlink" title="第二阶段"></a>第二阶段</h5><blockquote><p>执行 Step Into，进入 <code>beanFactory.preInstantiateSingletons()</code> 方法，发现执行完 <code>getBean()</code> 方法后会输出日志，于是将断点打在 <code>getBean()</code> 那一行代码。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-13.png"></p><blockquote><p>执行 Step Into，进入 <code>getBean()</code> 方法，发现调用了 <code>doGetBean()</code> 方法，也就是前面说过的：在 Spring 里面，以 <code>do</code> 开头的方法都是干实事的方法。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-14.png"></p><blockquote><p>执行 Step Into，进入 <code>doGetBean()</code> 方法，这里的 <code>transformedBeanName()</code> 方法会将用户定义的别名转换为 Bean 的真实名称。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-15.png"></p><blockquote><p>执行 Step Over，继续执行后面的 <code>getSingleton()</code> 方法</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-16.png"></p><blockquote><p>执行 Step Into，进入 <code>getSingleton()</code> 方法，发现调用了其重载的方法。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-17.png"></p><blockquote><p>执行 Step Into，进入重载的 <code>getSingleton()</code> 方法，传入的 <code>allowEarlyReference</code> 参数，表示是否可以从第二级缓存中获取 Bean。发现该方法会尝试从第一级缓存 <code>singletonObjects</code> 中获取 Bean A，由于 Bean A 现在还没有开始创建，因此从第一级缓存中获取不到，而且 <code>isSingletonCurrentlyInCreation()</code> 方法会返回 <code>false</code>，导致最后返回的 Bean A 为 <code>null</code>。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-18.png"></p><blockquote><p>返回到 <code>doGetBean()</code> 方法中，执行完 <code>getSingleton()</code> 方法会返回 <code>null</code>。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-19.png"></p><blockquote><p>执行 Step Over，继续执行后面的代码，可以看到 RootBeanDefinition 实例。在 XML 配置文件中定义的 Bean，对于 Spring 来说就是一个个的 RootBeanDefinition 实例。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-20.png"></p><blockquote><p>执行 Step Over，继续执行后面的代码，可以看到有一个 <code>dependsOn</code> 变量，它对应于 Bean 的 <code>depends-on</code> 属性，因为在 XML 配置文件中没有配置过该属性，因此为 <code>null</code>。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-21.png"></p><blockquote><p>执行 Step Over，继续执行后面的代码，终于看到开始准备创建 Bean A 了。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-22.png"></p><h5 id="第三阶段"><a href="#第三阶段" class="headerlink" title="第三阶段"></a>第三阶段</h5><blockquote><p>执行 Step Into，进入 <code>getSingleton()</code> 方法中，在 IDEA 2020 里面需要使用鼠标左键点击 <code>getSingleton()</code> 方法进入。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-23.png"></p><blockquote><p>在 <code>getSingleton()</code> 方法中，首先从第一级缓存 <code>singletonObjects</code> 获取 Bean A，缓存里面没有，那么就需要创建 Bean A，此时日志会输出 <code>Creating shared instance of singleton bean 'a'</code>。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-24.png"></p><blockquote><p>当执行完 <code>singletonObject = singletonFactory.getObject()</code> 时，日常会输出 <code>A created success</code>，这说明执行 <code>singletonFactory.getObject()</code> 方法时将会实例化 Bean A，并且根据变量名可得知是单例工厂创建的，这个单例工厂就是传入的 Lambda 表达式。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-25.png"></p><blockquote><p>执行 Step Into，进入 <code>createBean()</code> 方法，<code>mbdToUse</code> 将用于创建 Bean A。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-26.png"></p><blockquote><p>执行 Step Over，继续执行后面的代码，终于要执行 <code>doCreateBean()</code> 方法实例化 Bean A 了。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-27.png"></p><blockquote><p>执行 Step Into，进入 <code>doCreateBean()</code> 方法，在 <code>factoryBeanInstanceCache</code> 中并不存在 Bean A 对应的 Wrapper 缓存，因此要先创建 Bean A 对应的 <code>instanceWrapper</code>。形象的理解：Bean A 的实例化需要经过 <code>instanceWrapper</code> 之手，Bean A 实例被 <code>instanceWrapper</code> 包裹在其中。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-28.png"></p><blockquote><p>执行 Step Into，进入 <code>createBeanInstance()</code> 方法，里面的核心逻辑是使用反射创建 Bean A。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-29.png"></p><blockquote><p>执行 Step Over，继续执行后面的代码，有一个 <code>resolved</code> 变量，写着注释：<code>Shortcut when re-creating the same bean…</code>，如果值为 <code>true</code>，表示使用快捷方式重新创建同一个 Bean。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-30.png"></p><blockquote><p>执行 Step Over，继续执行后面的 <code>instantiateBean()</code> 方法。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-31.png"></p><blockquote><p>执行 Step Into，进入 <code>instantiateBean()</code> 方法，会执行 <code>getInstantiationStrategy().instantiate()</code> 方法完成 Bean A 的实例化。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-32.png"></p><blockquote><p>执行 Step Into，进入 <code>getInstantiationStrategy().instantiate()</code> 方法，首先通过执行 <code>bd.resolvedConstructorOrFactoryMethod</code> 来获取已经解析好的构造器 ，由于是第一次创建，所以获取不到构造器，因此 <code>constructorToUse == null</code>；然后获取 Bean A 的类型，如果发现是接口，则直接抛出异常；最后通过执行 <code>clazz.getDeclaredConstructor()</code> 方法来获取 Bean A 的构造器，并赋值给 <code>constructorToUse</code> 变量。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-33.png"></p><blockquote><p>执行 Step Over，继续执行后面的代码，可以看到上面获取构造器 <code>constructorToUse</code> 的目的是为了实例化 Bean A。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-34.png"></p><blockquote><p>执行 Step Into，进入 <code>BeanUtils.instantiateClass()</code> 方法，日志会输出 <code>A created success</code></p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-35.png"></p><blockquote><p>执行 Step Over，会返回到 <code>getInstantiationStrategy().instantiate()</code> 方法中，开始创建 Bean A 实例，不过还没有进行初始化，可以看到属性 <code>b = null</code>。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-36.png"></p><blockquote><p>执行 Step Over，会返回到 <code>instantiateBean()</code> 方法中，得到刚刚创建的 Bean A 实例，但其属性 <code>b</code> 并未被初始化。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-37.png"></p><blockquote><p>执行 Step Over，将已实例化的 Bean A 封装进 BeanWrapper 中，并返回 BeanWrapper 实例。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-38.png"></p><blockquote><p>执行 Step Over，会返回到 <code>createBeanInstance()</code> 方法中，得到刚刚创建的 BeanWrapper 实例，该 BeanWrapper 封装了创建好的 Bean A 实例。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-39.png"></p><blockquote><p>执行 Step Over，会返回到 <code>doCreateBean()</code> 方法中，获得 BeanWrapper 实例，并通过 BeanWrapper 实例获取创建好的 Bean A 实例。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-40.png"></p><blockquote><p>执行 Step Over，继续执行后面的代码，获取 Bean A 的全类名。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-41.png"></p><blockquote><p>执行 Step Over，继续执行后面的代码，执行 BeanPostProcessor。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-42.png"></p><blockquote><p>执行 Step Over，继续执行后面的代码，如果该 Bean 是单例，并且允许循环依赖，且当前 Bean 正在创建过程中，那么就允许提前暴露该 Bean，也就是将该 Bean 放到第三级缓存 <code>singletonFactories</code> 中。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-43.png"></p><blockquote><p>执行 Step Into，进入 <code>addSingletonFactory()</code> 方法。首先去第一级缓存 <code>singletonObjects</code> 中找一下有没有 Bean A，如果找不到，则将 Bean A 添加到第三级缓存 <code>singletonFactories</code> 中，并将 Bean A 从第二级缓存 <code>earlySingletonObjects</code> 中移除。最后将 <code>beanName</code> 添加至 <code>registeredSingletons</code> 中，表示该单例 Bean 已经被注册过。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-44.png"></p><h5 id="第四阶段"><a href="#第四阶段" class="headerlink" title="第四阶段"></a>第四阶段</h5><blockquote><p>执行 Steop Over，会返回到 <code>doCreateBean()</code> 方法中，需要执行 <code>populateBean()</code> 方法对 Bean A 中的属性进行填充。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-45.png"></p><blockquote><p>执行 Step Into，进入 <code>populateBean()</code> 方法，首先会获取 Bean A 的属性列表。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-46.png"></p><blockquote><p>执行 Steop Over，执行后面的 <code>applyPropertyValues()</code> 方法，完成 Bean A 属性的填充。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-47.png"></p><blockquote><p>执行 Step Into，进入 <code>applyPropertyValues()</code> 方法，获取到 Bean A 的属性列表，发现里面有个属性为 <code>b</code>。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-48.png"></p><blockquote><p>执行 Step Over，继续执行后面的代码，遍历每一个属性，并对每一个属性进行注入，<code>valueResolver.resolveValueIfNecessary()</code> 方法的作用是：给定一个 PropertyValue，返回一个值，如有必要，解析工厂中对其他 Bean 的任何引用。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-49.png"></p><blockquote><p>执行 Step Into，进入 <code>valueResolver.resolveValueIfNecessary()</code> 方法，会执行 <code>resolveReference()</code> 方法来解决依赖注入的问题。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-50.png"></p><blockquote><p>执行 Step Into，进入 <code>resolveReference()</code> 方法，首先获得属性 <code>b</code> 的名称，再通过 <code>this.beanFactory.getBean()</code> 方法获取 Bean B 的实例。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-51.png"></p><blockquote><p>执行 Step Into，进入 <code>this.beanFactory.getBean()</code> 方法，这里会调用熟悉的 <code>doGetBean()</code> 方法。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-52.png"></p><blockquote><p>执行 Step Into，进入 <code>doGetBean()</code> 方法，由于 Bean B 还没有实例化，因此 <code>getSingleton()</code> 方法返回 <code>null</code>。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-53.png"></p><blockquote><p>执行 Step Over，继续执行后面的代码，又回到这个熟悉的地方，尝试获取 Bean B 实例，获取不到就创建。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-54.png"></p><blockquote><p>执行 Step Into，进入 <code>getSingleton()</code> 方法，首先尝试从一级缓存 <code>singletonObjects</code> 中获取 Bean B 实例，缓存里面没有，因此获取不到。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-55.png"></p><blockquote><p>执行 Step Over，继续执行后面的 <code>singletonFactory.getObject()</code> 方法创建 Bean B 实例。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-56.png"></p><blockquote><p>执行 Step Over，继续执行 <code>createBean()</code> 方法创建 Bean B 实例。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-57.png"></p><blockquote><p>执行 Step Into，进入 <code>createBean()</code> 方法，首先会获取 Bean B 的类型。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-58.png"></p><blockquote><p>执行 Step Over，继续执行后面的 <code>doCreateBean()</code> 方法。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-59.png"></p><blockquote><p>执行 Step Into，进入 <code>doCreateBean()</code> 方法，会通过 <code>createBeanInstance()</code> 方法创建 Bean B 对应的 BeanWrapper 实例。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-60.png"></p><blockquote><p>执行 Step Into，进入 <code>createBeanInstance()</code> 方法，会执行 <code>instantiateBean()</code> 方法创建 Bean B 对应的 BeanWrapper 实例。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-61.png"></p><blockquote><p>执行 Step Into，进入 <code>instantiateBean()</code> 方法，会执行 <code>getInstantiationStrategy().instantiate()</code> 方法创建 Bean B 实例。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-62.png"></p><blockquote><p>执行 Step Into，进入 <code>getInstantiationStrategy().instantiate()</code> 方法，会先获取 Bean B 的构造器，然后再执行 <code>BeanUtils.instantiateClass()</code> 方法创建 Bean B 实例。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-63.png"></p><blockquote><p>执行 Step Into，进入 <code>BeanUtils.instantiateClass(constructorToUse)</code> 方法，通过调用 B 类的构造器创建 Bean B 实例，此时日志会输出：<code>B created success</code>。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-64.png"></p><blockquote><p>执行 Step Over，会返回到 <code>instantiateBean()</code> 方法中，将创建好的 Bean B 实例封装进 BeanWrapper 实例。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-65.png"></p><blockquote><p>执行 Step Over，会返回到 <code>doCreateBean()</code> 方法中，<code>createBeanInstance()</code> 方法返回了封装着 Bean B 实例的 BeanWrapper。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-66.png"></p><blockquote><p>执行 Step Over，继续执行后面的代码，执行 BeanPostProcessor 的处理过程。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-67.png"></p><blockquote><p>执行 Step Over，继续执行后面的代码，由于 Bean B 满足单例并且正在被创建，因此 Bean B 可以被提前暴露出去（在属性还未初始化的时候可以提前暴露出去），于是执行 <code>addSingletonFactory()</code> 方法将其添加到第三级缓存 <code>singletonFactory</code> 中。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-68.png"></p><blockquote><p>执行 Step Into，进入 <code>addSingletonFactory()</code> 方法，可以看到会将 Bean B 实例添加到第三级缓存 <code>singletonFactory</code> 中，并从二级缓存 <code>earlySingletonObjects</code> 中移除 Bean B，同时注册其 <code>beanName</code>。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-69.png"></p><blockquote><p>执行 Step Over，返回到 <code>doCreateBean()</code> 方法中，执行 <code>populateBean()</code> 方法填充 Bean B 的属性。</p></blockquote><p><img data-src="../../../asset/2024/04/spring-loop-dependency-70.png"></p><h5 id="第五阶段"><a href="#第五阶段" class="headerlink" title="第五阶段"></a>第五阶段</h5><h2 id="循环依赖问题解决总结"><a href="#循环依赖问题解决总结" class="headerlink" title="循环依赖问题解决总结"></a>循环依赖问题解决总结</h2><p>在 Spring 中，可以通过使用 Setter 方法注入、属性注入、<code>@Lazy</code> 注解或者重构代码来解决循环依赖问题。</p><h3 id="解决方案一"><a href="#解决方案一" class="headerlink" title="解决方案一"></a>解决方案一</h3><p>尽量不要使用构造方法注入，而是使用 Setter 方法注入或者属性注入，这样 Spring 就可以使用三级缓存机制来解决循环依赖问题。因为在 Spring 中，如果使用构造方法注入，一旦发生了循环依赖，Spring 无法自行解决这个问题。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> B b;</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> A a;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>或者</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> B b;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setB</span><span class="params">(B b)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.b = b;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> A a;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setA</span><span class="params">(A a)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.a = a;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="解决方案二"><a href="#解决方案二" class="headerlink" title="解决方案二"></a>解决方案二</h3><p>使用 <code>@Lazy</code> 注解解决循环依赖问题。<code>@Lazy</code> 注解是 Spring Framework 提供的一个注解，用于延迟 Bean 的初始化，可以用在类或方法上。通常情况下，Spring 容器会在启动时创建并初始化所有单例 Bean，但使用 <code>@Lazy</code> 注解可以改变这一行为，使 Bean 在第一次被访问时才进行初始化。对于某些特定的循环依赖场景，<code>@Lazy</code> 可以推迟依赖的注入，从而打破循环依赖链。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> B b;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">(<span class="meta">@Lazy</span> B b)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.b = b;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> A a;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">B</span><span class="params">(<span class="meta">@Lazy</span> A a)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.a = a;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="解决方案三"><a href="#解决方案三" class="headerlink" title="解决方案三"></a>解决方案三</h3><p>重构代码，避免相互依赖。通常情况下，可以通过引入第三个类或接口来拆分依赖链，从而避免了循环依赖。比如在下面的例子中，A 和 B 都依赖于 CommonService，而不直接依赖对方，从而避免了循环依赖。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CommonService commonService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">(CommonService commonService)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.commonService = commonService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CommonService commonService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">B</span><span class="params">(CommonService commonService)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.commonService = commonService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonService</span> </span>{</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><div id="readmore-expansion" class="pjax"></div><link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css"><script data-pjax="" src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script><script data-pjax="">var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),allowMobile=!1;if(!isMobile||isMobile&&allowMobile)try{var plugin=new ReadmorePlugin;plugin.init({type:"hexo",id:"readmore-container",name:"全栈技术驿站",blogId:"96641-5333172926158-056",qrcode:"https://www.techgrow.cn/img/wx_mp_qr.png",keyword:"Tech",random:"1",height:"auto",expires:"365",lockToc:"yes",interval:"30",baseUrl:"",execute:"yes",tocSelector:""})}catch(e){console.warn("readmore plugin occurred error: "+e.name+" | "+e.message)}</script></div><footer class="post-footer"><div class="reward-container"><div>支持一根棒棒糖！</div> <button> 赞赏</button><div class="post-reward"><div> <img src="/img/pay_wx.png" alt="Clay 微信"> <span>微信</span></div><div> <img src="/img/pay_zfb.png" alt="Clay 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Clay</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.techgrow.cn/posts/98042d64.html" title="Spring 之循环依赖底层源码剖析">https://www.techgrow.cn/posts/98042d64.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="contactme"><div class="social-list"><div class="social-item"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">欢迎添加博主微信，请备注 "博客"，届时会邀请您加入百人微信群</span><br> <img src="/img/wx_account_qr.png"></div></div></div><div class="post-tags"><a href="/tags/Java/" rel="tag"><i class="fa fa-tag"></i> Java</a><a href="/tags/%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" rel="tag"><i class="fa fa-tag"></i> 源码剖析</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/71a2ce7f.html" rel="prev" title="MyBatis 入门教程之五"><i class="fa fa-angle-left"></i> MyBatis 入门教程之五</a></div><div class="post-nav-item"> <a href="/posts/16617d7.html" rel="next" title="MySQL 基于 GTID 实现主从同步">MySQL 基于 GTID 实现主从同步<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> Copyright © 2018 – <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Clay</span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>站点总字数：</span> <span title="站点总字数">2m</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>站点阅读时长 ≈</span> <span title="站点阅读时长">30:49</span></span></div><div id="site-runtime"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span><span id="runtime"></span></div><script language="javascript">function isPC(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=0;n<t.length;n++)if(0<e.indexOf(t[n]))return!1;return!0}function siteTime(e,t){window.setTimeout("siteTime(openOnPC, start)",1e3);var n=36e5,o=24*n;t=new Date("2018-12-27 08:00:00");var i=new Date,r=(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i-t),a=Math.floor(r/31536e6),s=Math.floor(r/o-365*a),d=Math.floor((r-(365*a+s)*o)/n),l=Math.floor((r-(365*a+s)*o-d*n)/6e4),u=Math.floor((r-(365*a+s)*o-d*n-6e4*l)/1e3);document.getElementById("runtime").innerHTML="Powered by Hexo & Docker | "+a+" 年 "+s+" 日 "+d+" 小时 "+l+" 分钟 "+u+" 秒 "}var showOnMobile=!1,openOnPC=isPC(),start=new Date;siteTime(openOnPC,start),openOnPC||showOnMobile||(document.getElementById("site-runtime").style.display="none")</script><div class="beian"> <span><img src="/img/gonganbeian.png" alt=""></span> <span><a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank">粤ICP备 19024664号-1</a></span> <span>|&nbsp;</span> <span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302004035" rel="external nofollow" target="_blank">粤公网安备 44011302004035号</a></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div> <a href="https://github.com/rqh656418510" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script size="200" alpha="0.5" zindex="-1" src="/lib/ribbon.js/dist/ribbon.min.js"></script><script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="/lib/lozad/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"/lib/pdfobject/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script src="/js/third-party/pace.js"></script><script data-pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://www.techgrow.cn/lib/darkmode/darkmode@1.5.7.min.js"></script><script>
var options = {
  bottom: '64px',
  right: '30px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#282828',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script><script src="https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js"></script><script>
    var qiniu_domain = "https://oss.techgrow.cn";
    var qiniu_token_url = "https://open.techgrow.cn/api/oss/qiniu/token/upload";
    var qiniu_debug = "true" === "false";

    // date format
    Date.prototype.format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
      };
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      }
      for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
          fmt = fmt.replace(
            RegExp.$1,
            (RegExp.$1.length == 1)
              ? (o[k])
              : (("00" + o[k]).substr(("" + o[k]).length))
          );
        }
      }
      return fmt;
    }

    // generate uuid
    function uuid() {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4";
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
      s[8] = s[13] = s[18] = s[23] = "-";
      var uuid = s.join("");
      return uuid;
    }

    // sync get request
    function syncGet(url) {
      var xhr = null;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhr.open('GET', url, false);
      xhr.send();
      return xhr;
    }

    // get upload file path
    function getUploadFilePath() {
      var now = new Date();
      var name = uuid().replace(/-/g, "");
      var nowStr = now.format("/yyyy/MM/dd/");
      return "uploads" + nowStr + name;
    }

    // get qiniu upload token
    function getUploadToken() {
      try {
        var xhr = syncGet(qiniu_token_url);
        var responseStatus = xhr.status;
        var responseJson = JSON.parse(xhr.responseText);
        if (responseStatus === 200) {
          return responseJson.data;
        } else if (responseStatus === 403) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，非法请求来源！");
        } else if (responseStatus === 429) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，上传过于频繁！");
        } else if (responseStatus === 500) {
          alert(responseJson.msg || "图片上传失败，无法获取UploadToken，系统内部出错！");
        } else {
          alert("图片上传失败，无法获取UploadToken，未知Http响应状态码！");
        }
      } catch (err) {
        if (qiniu_debug) {
          console.error(err);
        }
        alert("图片上传失败，无法获取UploadToken，未知错误！");
      }
      return null;
    }

    // qiniu upload image
    async function qiniuUploadImage(file) {
      var image_path = null;
      await uploadImage(file).then(function onFulfilled(res) {
        image_path = res;
      }).catch(function onRejected(err) {
        if (qiniu_debug) {
          console.error(err);
        }
      });
      return image_path;
    }

    // upload image
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        var config = null;
        var putExtra = null;
        var token = getUploadToken();
        var key = getUploadFilePath();
        // upload init
        var observable = qiniu.upload(file, key, token, putExtra, config);
        // upload start
        observable.subscribe({
          next(res) {
            // upload progress
          },
          error(err) {
            // upload falied
            reject("falied to upload image for qiniu: " + err.name);
          },
          complete(res) {
            // upload successed
            resolve(qiniu_domain + "/" + key);
          }
        });
      });
    }
  </script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.techgrow.cn","cssUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css","commentCount":true,"pageview":false,"copyright":false,"allowUploadImage":true,"libUrl":"https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.js","locale":{"placeholder":"支持匿名评论啦，若希望及时收到博主的反馈，建议登录评论或者在上方的邮箱输入框留下邮箱地址哦 (๑•̀ㅂ•́)و✧"},"dark":"body.darkmode--activated","emoji":["https://www.techgrow.cn/lib/@waline/emojis/1.0.1/weibo"],"meta":["nick","mail","link"],"login":"enable","pageSize":10,"qiniuDebug":false,"qiniuDomain":"https://oss.techgrow.cn","qiniuTokenUrl":"https://open.techgrow.cn/api/oss/qiniu/token/upload","qiniuLibUrl":"https://www.techgrow.cn/lib/qiniu/qiniu@3.3.1.min.js","el":"#waline","comment":true,"path":"/posts/98042d64.html"}</script><link rel="stylesheet" href="https://www.techgrow.cn/lib/@waline/client/client@2.5.1.min.css"><script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.imageUploader = false;
  }
  else if (CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.imageUploader = qiniuUploadImage;
  } else {
   CONFIG.waline.imageUploader = true;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script><div class="comments" id="waline-comments" style="display:none"></div><script>function isMobile(){var i=navigator.userAgent.toLowerCase(),e="ipad"==i.match(/ipad/i),a="iphone os"==i.match(/iphone os/i),o="midp"==i.match(/midp/i),n="rv:1.2.3.4"==i.match(/rv:1.2.3.4/i),r="ucweb"==i.match(/ucweb/i),c="android"==i.match(/android/i),l="windows ce"==i.match(/windows ce/i),d="windows mobile"==i.match(/windows mobile/i);return!!(e||a||o||n||r||c||l||d)}var openOnMobile=isMobile(),showOnMobile=!1,aplayerEnable=!0;jQuery(document).ready(function(){aplayerEnable&&(openOnMobile&&!showOnMobile||jQuery("#aplayer").css("display","block"))}),jQuery(window).on("load",function(){aplayerEnable&&jQuery(".aplayer\\-icon.aplayer\\-icon\\-lrc").trigger("click")})</script></body></html>